{
  "serviceType": "DEX",
  "flowwiseWorkflow": {
    "name": "DEX Garden Chat Lifecycle",
    "version": "1.0.0",
    "description": "Complete FlowWise workflow for DEX garden chat interactions with ledger, cashier, LLM, payment, and notification control",
    "steps": [
      {
        "id": "user_input",
        "name": "1Ô∏è‚É£ User Input",
        "type": "input",
        "component": "user",
        "description": "Receive and validate user chat input for DEX trade",
        "actions": [
          {
            "type": "validate",
            "field": "input",
            "required": true
          },
          {
            "type": "validate",
            "field": "email",
            "required": true,
            "format": "email"
          }
        ],
        "websocketEvents": [
          {
            "type": "user_input",
            "component": "user",
            "message": "User query received",
            "data": {
              "input": "{{input}}",
              "email": "{{email}}"
            }
          }
        ],
        "outputs": {
          "input": "{{input}}",
          "email": "{{email}}",
          "user": "{{user}}"
        }
      },
      {
        "id": "llm_resolution",
        "name": "2Ô∏è‚É£ LLM Resolution",
        "type": "process",
        "component": "llm",
        "description": "Extract DEX trade query, query service registry, get token pools, format response",
        "actions": [
          {
            "type": "llm_extract_query",
            "provider": "openai",
            "input": "{{input}}"
          },
          {
            "type": "query_dex_pools",
            "tokenSymbol": "{{queryResult.query.filters.tokenSymbol}}",
            "baseToken": "{{queryResult.query.filters.baseToken}}",
            "action": "{{queryResult.query.filters.action}}"
          },
          {
            "type": "llm_format_response",
            "provider": "openai",
            "listings": "{{listings}}",
            "userQuery": "{{input}}"
          }
        ],
        "websocketEvents": [
          {
            "type": "llm_start",
            "component": "llm",
            "message": "Starting LLM query extraction...",
            "data": {}
          },
          {
            "type": "llm_response",
            "component": "llm",
            "message": "{{llmResponse.message}}",
            "data": {
              "response": "{{llmResponse}}"
            }
          },
          {
            "type": "igas",
            "component": "igas",
            "message": "iGas Cost: {{llmResponse.iGasCost}}",
            "data": {
              "igas": "{{llmResponse.iGasCost}}"
            }
          }
        ],
        "outputs": {
          "llmResponse": "{{llmResponse}}",
          "selectedListing": "{{llmResponse.selectedListing}}",
          "iGasCost": "{{llmResponse.iGasCost}}",
          "action": "{{action}}",
          "tokenAmount": "{{tokenAmount}}"
        },
        "errorHandling": {
          "onError": "error_handler",
          "errorEvents": [
            {
              "type": "error",
              "component": "llm",
              "message": "{{error.message}}"
            }
          ]
        }
      },
      {
        "id": "user_confirm_trade",
        "name": "ü§î User Decision: Confirm DEX Trade",
        "type": "decision",
        "component": "user",
        "description": "Ask user to confirm the DEX trade",
        "requiresUserDecision": true,
        "decisionPrompt": "Would you like to {{action}} {{tokenAmount}} {{tokenSymbol}} at {{price}} {{baseToken}}/{{tokenSymbol}}?",
        "decisionOptions": [
          {
            "value": "YES",
            "label": "Yes, proceed",
            "action": "continue"
          },
          {
            "value": "NO",
            "label": "No, cancel",
            "action": "cancel"
          }
        ],
        "websocketEvents": [
          {
            "type": "user_decision_required",
            "component": "user",
            "message": "Please confirm your DEX trade",
            "data": {
              "decisionId": "confirm_dex_trade",
              "prompt": "Would you like to {{action}} {{tokenAmount}} {{tokenSymbol}} at {{price}} {{baseToken}}/{{tokenSymbol}}?",
              "options": [
                {"value": "YES", "label": "Yes, proceed"},
                {"value": "NO", "label": "No, cancel"}
              ],
              "timeout": 30000
            }
          }
        ],
        "outputs": {
          "userDecision": "{{userDecision}}"
        },
        "timeout": 30000,
        "onTimeout": "error_handler"
      },
      {
        "id": "execute_dex_trade",
        "name": "3Ô∏è‚É£ Execute DEX Trade",
        "type": "process",
        "component": "dex",
        "description": "Execute DEX trade and check balance",
        "conditions": [
          {
            "if": "{{userDecision}} === 'YES'",
            "then": "continue"
          }
        ],
        "actions": [
          {
            "type": "check_balance",
            "email": "{{user.email}}",
            "required": "{{totalCost}}",
            "action": "{{action}}"
          },
          {
            "type": "execute_dex_trade",
            "poolId": "{{selectedListing.poolId}}",
            "action": "{{action}}",
            "tokenAmount": "{{tokenAmount}}",
            "userEmail": "{{user.email}}"
          }
        ],
        "websocketEvents": [
          {
            "type": "dex_trade_start",
            "component": "dex",
            "message": "Executing DEX trade: {{action}} {{tokenAmount}} {{tokenSymbol}}",
            "data": {
              "action": "{{action}}",
              "tokenAmount": "{{tokenAmount}}",
              "tokenSymbol": "{{tokenSymbol}}"
            }
          }
        ],
        "outputs": {
          "trade": "{{trade}}",
          "updatedBalance": "{{user.balance}}"
        },
        "errorHandling": {
          "onError": "error_handler",
          "errorEvents": [
            {
              "type": "insufficient_balance",
              "component": "wallet",
              "message": "Insufficient balance for DEX trade"
            }
          ]
        }
      },
      {
        "id": "ledger_create_entry",
        "name": "4Ô∏è‚É£ Ledger: Create DEX Entry",
        "type": "process",
        "component": "ledger",
        "description": "Create ledger entry for DEX trade",
        "actions": [
          {
            "type": "create_snapshot",
            "payer": "{{user.email}}",
            "amount": "{{trade.baseAmount}}",
            "providerId": "{{selectedListing.providerId}}"
          },
          {
            "type": "add_ledger_entry",
            "snapshot": "{{snapshot}}",
            "serviceType": "dex",
            "iGasCost": "{{iGasCost}}",
            "payerId": "{{user.email}}",
            "merchantName": "{{selectedListing.providerName}}",
            "providerUuid": "{{providerUuid}}",
            "bookingDetails": {
              "tokenSymbol": "{{tokenSymbol}}",
              "baseToken": "{{baseToken}}",
              "action": "{{action}}",
              "tokenAmount": "{{tokenAmount}}",
              "baseAmount": "{{trade.baseAmount}}",
              "price": "{{trade.price}}",
              "iTax": "{{trade.iTax}}"
            }
          }
        ],
        "websocketEvents": [
          {
            "type": "ledger_entry_created",
            "component": "ledger",
            "message": "Ledger entry created for DEX trade: {{ledgerEntry.entryId}}",
            "data": {
              "entry": "{{ledgerEntry}}"
            }
          },
          {
            "type": "ledger_entry_added",
            "component": "ledger",
            "message": "Ledger entry created: {{ledgerEntry.entryId}}",
            "data": {
              "entry": "{{ledgerEntry}}"
            }
          }
        ],
        "outputs": {
          "ledgerEntry": "{{ledgerEntry}}",
          "snapshot": "{{snapshot}}"
        }
      },
      {
        "id": "complete_trade",
        "name": "5Ô∏è‚É£ Complete Trade",
        "type": "process",
        "component": "dex",
        "description": "Complete DEX trade and deliver notifications",
        "actions": [
          {
            "type": "complete_booking",
            "ledgerEntry": "{{ledgerEntry}}"
          },
          {
            "type": "persist_snapshot",
            "snapshot": "{{snapshot}}"
          },
          {
            "type": "stream_to_indexers",
            "snapshot": "{{snapshot}}"
          },
          {
            "type": "deliver_webhook",
            "providerId": "{{selectedListing.providerId}}",
            "snapshot": "{{snapshot}}",
            "ledgerEntry": "{{ledgerEntry}}"
          }
        ],
        "websocketEvents": [
          {
            "type": "dex_trade_complete",
            "component": "dex",
            "message": "DEX Trade Complete: {{action}} {{tokenAmount}} {{tokenSymbol}}",
            "data": {
              "trade": "{{trade}}",
              "userBalance": "{{user.balance}}"
            }
          }
        ],
        "outputs": {
          "completed": true
        }
      },
      {
        "id": "summary",
        "name": "6Ô∏è‚É£ Summary",
        "type": "output",
        "component": "transaction",
        "description": "Generate DEX trade summary",
        "websocketEvents": [
          {
            "type": "summary",
            "component": "transaction",
            "message": "DEX trade completed successfully",
            "data": {
              "action": "{{action}}",
              "tokenAmount": "{{tokenAmount}}",
              "tokenSymbol": "{{tokenSymbol}}",
              "baseAmount": "{{trade.baseAmount}}",
              "baseToken": "{{baseToken}}",
              "price": "{{trade.price}}",
              "iTax": "{{trade.iTax}}",
              "userBalance": "{{user.balance}}"
            }
          }
        ],
        "outputs": {
          "summary": "{{summary}}"
        }
      },
      {
        "id": "error_handler",
        "name": "Error Handler",
        "type": "error",
        "component": "system",
        "description": "Handle errors and broadcast error events",
        "websocketEvents": [
          {
            "type": "error",
            "component": "{{error.component}}",
            "message": "{{error.message}}",
            "data": {
              "error": "{{error}}"
            }
          }
        ]
      }
    ],
    "transitions": [
      {
        "from": "user_input",
        "to": "llm_resolution",
        "condition": "always"
      },
      {
        "from": "llm_resolution",
        "to": "user_confirm_trade",
        "condition": "{{llmResponse.selectedListing}}"
      },
      {
        "from": "llm_resolution",
        "to": "error_handler",
        "condition": "!{{llmResponse.selectedListing}}"
      },
      {
        "from": "user_confirm_trade",
        "to": "execute_dex_trade",
        "condition": "{{userDecision}} === 'YES'"
      },
      {
        "from": "user_confirm_trade",
        "to": "error_handler",
        "condition": "{{userDecision}} === 'NO'"
      },
      {
        "from": "execute_dex_trade",
        "to": "ledger_create_entry",
        "condition": "{{trade}}"
      },
      {
        "from": "execute_dex_trade",
        "to": "error_handler",
        "condition": "!{{trade}}"
      },
      {
        "from": "ledger_create_entry",
        "to": "complete_trade",
        "condition": "always"
      },
      {
        "from": "complete_trade",
        "to": "summary",
        "condition": "always"
      }
    ],
    "initialStep": "user_input",
    "finalSteps": ["summary", "error_handler"]
  }
}

