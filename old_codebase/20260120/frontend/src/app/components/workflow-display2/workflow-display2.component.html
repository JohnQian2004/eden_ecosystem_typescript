<div class="card">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">üé¨ AMC Cinema Workflow Control (Testbed)</h5>
    <small class="text-white-50">üîÑ Atomic Server Execution | ü§ñ LLM Self-Play + üí∞ Server Autopay</small>
  </div>
  <div class="card-body">

    <div *ngIf="isLoading" class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading AMC workflow...</span>
      </div>
      <p class="mt-2">Loading AMC Cinema workflow...</p>
    </div>

    <div *ngIf="!isLoading && currentWorkflow">
      <!-- Workflow Control -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <h5 class="mb-1">{{ currentWorkflow.name || 'No Workflow' }}</h5>
            <p class="text-muted mb-0">{{ currentWorkflow.description || '' }}</p>
          </div>
          <button
            type="button"
            class="btn btn-success"
            (click)="startWorkflow()"
            [disabled]="activeExecution !== null">
            <i class="fas fa-play"></i> Start AMC Workflow
          </button>
        </div>
      </div>

      <!-- Active Decision Prompt -->
      <div *ngIf="showDecisionPrompt && pendingDecision" class="alert alert-info mb-4" role="alert">
        <h6 class="alert-heading">ü§î {{ pendingDecision.prompt }}</h6>
        <hr>
        <!-- Video Player for Movie Viewing Decision -->
        <!-- Use *ngIf with videoUrl to force video element recreation when URL changes (fixes Windows player issue) -->
        <div *ngIf="pendingDecision?.videoUrl" class="mb-3" style="display: block !important; visibility: visible !important; min-height: 250px;">
          <div class="card" style="display: block !important; visibility: visible !important;">
            <div class="card-body" style="display: block !important; visibility: visible !important;">
              <h6 class="card-title" *ngIf="pendingDecision.movieTitle">üé¨ {{ pendingDecision.movieTitle }}</h6>
              <!-- Wrapping video in *ngIf with unique condition forces recreation when videoUrl changes (Windows player fix) -->
              <div *ngIf="pendingDecision.videoUrl; let videoUrl">
                <video 
                  #videoPlayer
                  controls 
                  autoplay
                  class="w-100" 
                  style="max-height: 400px; min-height: 200px; width: 100%; display: block !important; visibility: visible !important; border-radius: 4px; background-color: #000;"
                  [src]="getVideoUrl(videoUrl)"
                  [attr.data-video-url]="videoUrl"
                  preload="auto"
                  (loadstart)="onVideoLoadStart($event, videoUrl)"
                  (error)="onVideoError($event, videoUrl)"
                  (loadeddata)="onVideoLoadedData($event, videoUrl)">
                  Your browser does not support the video tag.
                </video>
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex gap-2" *ngIf="pendingDecision.options && pendingDecision.options.length > 0">
          <button
            *ngFor="let option of pendingDecision.options; let i = index"
            class="btn btn-primary"
            (click)="submitDecision(option.value)"
            [attr.data-option-index]="i"
            [attr.data-option-value]="option.value"
            [attr.data-option-label]="option.label"
            style="min-width: 120px;">
            {{ option.label || option.value || 'Option ' + (i + 1) }}
          </button>
        </div>
      </div>

      <!-- Movie Selection Prompt -->
      <!-- CRITICAL: Hide selection prompt when workflow is at view_movie step -->
      <div *ngIf="showSelectionPrompt && pendingSelection && pendingSelection.options && pendingSelection.options.length > 0 && activeExecution?.currentStep !== 'view_movie' && currentStep?.id !== 'view_movie'" class="alert alert-success mb-4" role="alert">
        <h6 class="alert-heading">‚úàÔ∏è {{ pendingSelection.prompt }}</h6>
        <hr>
        <div class="row g-3">
          <div *ngFor="let option of pendingSelection.options; let i = index"
               class="col-md-6">
            <div class="card h-100 border-primary">
              <div class="card-body">
                <h6 class="card-title">{{ getDisplayTitle(option) }}</h6>
                <div class="card-text">
                  <!-- Dynamically display all data fields -->
                  <div *ngFor="let field of getDisplayFields(option)">
                    <strong>{{ getFieldLabel(field.key) }}:</strong>
                    <span [innerHTML]="formatFieldValue(field.value)"></span><br *ngIf="!field.last">
                  </div>
                </div>
                <button
                  class="btn btn-primary w-100"
                  (click)="submitMovieSelection(option)">
                  {{ getSelectButtonText(option) }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Current Step Details -->
      <div>
          <div *ngIf="currentStep" class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0">
                {{ getStepIcon(currentStep.type) }} {{ currentStep.name }}
                <span [ngClass]="getStepTypeClass(currentStep.type)" class="ms-2">{{ currentStep.type }}</span>
              </h6>
            </div>
            <div class="card-body">
              <p class="lead">{{ currentStep.description }}</p>

              <!-- Decision Step Interactive UI -->
              <div *ngIf="currentStep.type === 'decision' && currentStep.requiresUserDecision && pendingDecision" class="alert alert-warning">
                <h6>üéØ Interactive Decision Required</h6>
                <div class="mb-3">
                  <label class="form-label fw-bold">{{ currentStep.decisionPrompt }}</label>
                  <div class="row g-2">
                    <div class="col-6" *ngFor="let option of currentStep.decisionOptions">
                      <button
                        class="btn btn-outline-primary w-100"
                        (click)="submitDecision(option.value)">
                        <strong>{{ option.label }}</strong><br>
                        <small class="text-muted">{{ option.action }}</small>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="small text-muted">
                  <i class="fas fa-clock"></i> Auto-timeout in {{ currentStep.timeout || 30000 }}ms
                  <span *ngIf="currentStep.onTimeout"> ‚Üí {{ currentStep.onTimeout }}</span>
                </div>
              </div>

              <!-- Process Step UI -->
              <div *ngIf="currentStep.type === 'process'" class="alert alert-info">
                <h6>‚öôÔ∏è Processing...</h6>
                <div class="d-flex align-items-center">
                  <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Processing...</span>
                  </div>
                  <span>{{ currentStep.description }}</span>
                </div>

                <!-- Show actions being executed -->
                <div *ngIf="currentStep.actions && currentStep.actions.length > 0" class="mt-3">
                  <div class="alert alert-info">
                    <h6>üîÑ Atomic Step Execution</h6>
                    <p class="mb-1">This step is being executed atomically on the server.</p>
                    <p class="mb-0 small">All actions, events, and outputs are processed together to ensure proper synchronization.</p>
                  </div>

                  <h6>Actions in Step:</h6>
                  <ul class="list-group list-group-flush">
                    <li *ngFor="let action of currentStep.actions" class="list-group-item px-0">
                      <div class="d-flex align-items-center">
                        <span class="badge me-2" [ngClass]="getActionBadgeClass(action.type)">
                          {{ getActionBadgeIcon(action.type) }}
                        </span>
                        <span><strong>{{ action.type }}</strong></span>
                        <small class="text-muted ms-auto">{{ getActionStatusText(action.type) }}</small>
                      </div>
                      <small class="text-muted ms-4" *ngIf="action['field']">{{ action['field'] }}</small>
                    </li>
                  </ul>
                  <div class="alert alert-light mt-2 small">
                    <strong>üîÑ Atomic Execution:</strong> All actions processed together on server |
                    <strong>ü§ñ LLM Self-Play</strong> + <strong>üí∞ Server Autopay</strong>
                  </div>
                </div>
              </div>

              <!-- Input Step UI -->
              <div *ngIf="currentStep.type === 'input'" class="alert alert-primary">
                <h6>üìù {{ currentStep.component === 'eden_chat' ? 'Eden Chat Input Required' : 'Input Required' }}</h6>
                <p>{{ currentStep.description }}</p>

                <!-- Eden Chat specific UI -->
                <div *ngIf="currentStep.component === 'eden_chat'" class="mt-3">
                  <div class="card bg-light">
                    <div class="card-body">
                      <h6 class="card-title">üí¨ Eden Chat Interface</h6>
                      <p class="card-text small text-muted">
                        Please use the chat input below to describe your movie preferences.
                        The Eden Chat system will process your request and guide you through the movie booking process.
                      </p>
                      <div class="alert alert-info small">
                        <strong>Expected Input:</strong> Movie preferences, show times, ticket requests, etc.
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Show validation rules -->
                <div *ngIf="currentStep.actions" class="mt-3">
                  <h6>Validation Rules:</h6>
                  <ul class="list-group list-group-flush">
                    <li *ngFor="let action of currentStep.actions" class="list-group-item px-0">
                      <strong>{{ action['field'] }}</strong>
                      <span *ngIf="action['required']" class="badge bg-danger ms-2">Required</span>
                      <span *ngIf="action['format']" class="badge bg-info ms-2">{{ action['format'] }}</span>
                      <span *ngIf="action['serviceType']" class="badge bg-success ms-2">{{ action['serviceType'] }}</span>
                    </li>
                  </ul>
                </div>
              </div>

              <!-- Movie Theater Step UI -->
              <div *ngIf="currentStep.type === 'process' && currentStep.component === 'movie_theater'" class="movie-theater-wrapper">
                <div *ngIf="!selectedListing?.movieTitle" class="alert alert-info">
                  <p>Waiting for movie selection...</p>
                  <p class="small text-muted">The movie will start automatically once selected.</p>
                </div>
                <app-movie-theater
                  *ngIf="selectedListing?.movieTitle"
                  [movieTitle]="selectedListing.movieTitle"
                  [duration]="selectedListing.duration || 10"
                  [selectedListing]="selectedListing"
                  (movieProgress)="onMovieProgress($event)"
                  (movieFinished)="onMovieFinished($event)">
                </app-movie-theater>
              </div>

              <!-- Output Step UI -->
              <div *ngIf="currentStep.type === 'output'" class="alert alert-success">
                <h6>‚úÖ Output Generated</h6>
                <p>{{ currentStep.description }}</p>

                <!-- Show websocket events -->
                <div *ngIf="currentStep.websocketEvents && currentStep.websocketEvents.length > 0" class="mt-3">
                  <h6>Events Broadcast:</h6>
                  <ul class="list-group list-group-flush">
                    <li *ngFor="let event of currentStep.websocketEvents" class="list-group-item px-0">
                      <div class="d-flex align-items-center">
                        <span class="badge bg-secondary me-2">{{ event.type }}</span>
                        <span>{{ event.message }}</span>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>

              <!-- Error Step UI -->
              <div *ngIf="currentStep.type === 'error'" class="alert alert-danger">
                <h6>‚ùå Error Occurred</h6>
                <p>{{ currentStep.description }}</p>

                <div *ngIf="currentStep.errorHandling" class="mt-3">
                  <h6>Error Handling:</h6>
                  <p><strong>Next Step:</strong> {{ currentStep.errorHandling.onError }}</p>
                </div>
              </div>

            </div>
          </div>

        <!-- Workflow Not Started -->
        <div *ngIf="!activeExecution" class="text-center py-5">
          <div class="mb-4">
            <i class="fas fa-play-circle fs-1 text-muted"></i>
          </div>
          <h5 class="text-muted">AMC Cinema Workflow Ready</h5>
          <p class="text-muted">Click "Start AMC Workflow" to begin the interactive workflow demonstration</p>
          <button
            type="button"
            class="btn btn-primary btn-lg"
            (click)="startWorkflow()">
            <i class="fas fa-play"></i> Start AMC Cinema Workflow
          </button>
        </div>

        <!-- Workflow Completed -->
        <div *ngIf="activeExecution && currentWorkflow && currentWorkflow.finalSteps.includes(activeExecution.currentStep)" class="text-center py-5">
          <div class="mb-4">
            <i class="fas fa-check-circle fs-1 text-success"></i>
          </div>
          <h5 class="text-success">AMC Cinema Workflow Completed!</h5>
          <p class="text-muted">The workflow has reached a final step.</p>
          <button
            type="button"
            class="btn btn-outline-primary"
            (click)="startWorkflow()">
            <i class="fas fa-redo"></i> Run Again
          </button>
        </div>
      </div>
    </div>

    <!-- DEX Workflow (Future) -->
    <div *ngIf="!isLoading && !currentWorkflow" class="text-center py-5">
      <p class="text-muted">No workflow loaded. Select a service type on Main Street to start a workflow.</p>
    </div>
  </div>
</div>

