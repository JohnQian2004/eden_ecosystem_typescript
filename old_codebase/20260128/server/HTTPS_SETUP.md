# HTTPS Setup Guide for Eden Ecosystem

This guide explains how to set up HTTPS/WSS for the Eden Ecosystem server and Angular frontend using a mini PKI system.

## Overview

The Eden Ecosystem supports HTTPS/WSS using self-signed certificates generated by a mini PKI system. This provides:
- Encrypted communication between server and clients
- Secure WebSocket (WSS) connections
- Certificate-based authentication (optional)

## Prerequisites

- OpenSSL installed on your system
- Node.js and npm installed
- Access to the server directory

## Step 1: Generate Certificates

Run the certificate generation script to create CA, server, and client certificates:

```bash
cd server
node scripts/generate-pki-certs.js
```

This will create the following files in `server/certs/`:
- `ca-key.pem` - CA private key
- `ca-cert.pem` - CA certificate (root certificate)
- `server-key.pem` - Server private key
- `server-cert.pem` - Server certificate (signed by CA)
- `client-key.pem` - Client private key
- `client-cert.pem` - Client certificate (signed by CA)

## Step 2: Trust the CA Certificate

To avoid browser security warnings, you need to trust the CA certificate:

### Windows
1. Double-click `server/certs/ca-cert.pem`
2. Click "Install Certificate"
3. Select "Current User" or "Local Machine"
4. Select "Place all certificates in the following store"
5. Click "Browse" and select "Trusted Root Certification Authorities"
6. Click "Next" and "Finish"

### macOS
```bash
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain server/certs/ca-cert.pem
```

### Linux (Ubuntu/Debian)
```bash
sudo cp server/certs/ca-cert.pem /usr/local/share/ca-certificates/eden-ca.crt
sudo update-ca-certificates
```

### Chrome/Edge (Alternative)
1. Open Chrome/Edge settings
2. Go to Privacy and Security > Security > Manage certificates
3. Click "Authorities" tab
4. Click "Import" and select `server/certs/ca-cert.pem`
5. Check "Trust this certificate for identifying websites"
6. Click "OK"

## Step 3: Start Server with HTTPS

Start the server with the `--enable-https true` flag:

```bash
cd server
ts-node eden-sim-redis.ts --enable-https true
```

Or if using npm scripts:
```bash
npm run dev -- --enable-https true
```

The server will:
- Load SSL certificates from `server/certs/`
- Start HTTPS server on port 3000 (or PORT environment variable)
- Enable WSS (WebSocket Secure) on `/ws` endpoint
- Display: `ðŸš€ Eden Ecosystem Server running on https://localhost:3000`

## Step 4: Access Angular Frontend

### Option A: Server-Served Angular (Recommended)

If Angular is built and served by the Node.js server:
1. Build Angular: `cd frontend && ng build`
2. Start server with HTTPS: `cd server && ts-node eden-sim-redis.ts --enable-https true`
3. Access: `https://localhost:3000`

The frontend will automatically:
- Use HTTPS for API calls
- Use WSS for WebSocket connections
- Detect the protocol from `window.location.protocol`

### Option B: Angular Dev Server (ng serve)

If using `ng serve` for development:
1. Start server with HTTPS: `cd server && ts-node eden-sim-redis.ts --enable-https true`
2. Start Angular dev server: `cd frontend && ng serve`
3. Access: `http://localhost:4200`

The Angular dev server will:
- Connect to `https://localhost:3000` for API calls
- Use WSS for WebSocket: `wss://localhost:3000/ws`
- Automatically detect protocol from API base URL

## Configuration

### Environment Variables

- `PORT` - Server port (default: 3000)
- `HTTP_PORT` - Alternative port setting (default: 3000)

### CLI Flags

- `--enable-https true` - Enable HTTPS/WSS mode
- `--enable-https false` - Disable HTTPS (use HTTP/WS)

### Certificate Paths

Certificates are expected in:
- `server/certs/server-key.pem`
- `server/certs/server-cert.pem`
- `server/certs/ca-cert.pem` (optional, for client verification)

## Troubleshooting

### Certificate Errors

**Error: "HTTPS enabled but certificates not found"**
- Solution: Run `node scripts/generate-pki-certs.js` to generate certificates

**Browser Warning: "Your connection is not private"**
- Solution: Trust the CA certificate (see Step 2)

**Error: "NET::ERR_CERT_AUTHORITY_INVALID"**
- Solution: Import `ca-cert.pem` into your browser's trusted root certificates

### WebSocket Connection Issues

**WebSocket fails to connect**
- Check that server is running with `--enable-https true`
- Verify WebSocket URL is `wss://localhost:3000/ws` (not `ws://`)
- Check browser console for connection errors

**Mixed Content Warnings**
- Ensure all API calls use HTTPS (not HTTP)
- Check that `getApiBaseUrl()` returns HTTPS URL

### Port Conflicts

**Port 3000 already in use**
- Set `PORT` environment variable: `PORT=3001 ts-node eden-sim-redis.ts --enable-https true`
- Or use `--port` flag if supported

## Security Notes

1. **Self-Signed Certificates**: These certificates are self-signed and should only be used for development/testing
2. **Production**: For production, use certificates from a trusted CA (Let's Encrypt, etc.)
3. **Client Certificates**: Client certificate authentication is optional and can be enabled by setting `requestCert: true` in server options
4. **Certificate Expiry**: Certificates are valid for 1 year (server/client) or 10 years (CA)

## Regenerating Certificates

To regenerate certificates:
1. Delete old certificates: `rm -rf server/certs/*.pem`
2. Run generation script: `node scripts/generate-pki-certs.js`
3. Re-trust the new CA certificate (see Step 2)

## Testing

Test HTTPS connection:
```bash
curl -k https://localhost:3000/api/health
```

Test WSS connection (using wscat):
```bash
npm install -g wscat
wscat -c wss://localhost:3000/ws
```

## Additional Resources

- [OpenSSL Documentation](https://www.openssl.org/docs/)
- [Node.js HTTPS Documentation](https://nodejs.org/api/https.html)
- [WebSocket Secure (WSS) Specification](https://tools.ietf.org/html/rfc6455)

