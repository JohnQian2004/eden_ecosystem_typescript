{
  "version": 3,
  "sources": ["../eden-sim-redis.ts"],
  "sourcesContent": ["#!/usr/bin/env ts-node\r\n\r\n/**\r\n * Eden Core Simulator v1.5\r\n * -----------------------\r\n * Single-file reference implementation with embedded Redis server\r\n *\r\n * Features:\r\n * - Embedded in-memory Redis server (no external dependencies)\r\n * - Redis state store\r\n * - Redis Streams for indexer fan-out\r\n */\r\n\r\nimport * as http from \"http\";\r\nimport * as https from \"https\";\r\nimport * as crypto from \"crypto\";\r\nimport * as process from \"process\";\r\nimport * as fs from \"fs\";\r\nimport * as path from \"path\";\r\nimport * as url from \"url\";\r\nimport { EventEmitter } from \"events\";\r\nimport { WebSocketServer, WebSocket } from \"ws\";\r\nimport { EdenPKI, type EdenCertificate, type EdenIdentity, type RevocationEvent, type Capability } from \"./EdenPKI\";\r\nimport Stripe from \"stripe\";\r\nimport { InMemoryRedisServer } from \"./src/redis\";\r\nimport { \r\n  MOCKED_LLM, \r\n  SKIP_REDIS, \r\n  ENABLE_OPENAI, \r\n  DEPLOYED_AS_ROOT, \r\n  NUM_GARDENS, \r\n  NUM_TOKEN_GARDENS,\r\n  HTTP_PORT,\r\n  FRONTEND_PATH,\r\n  STRIPE_SECRET_KEY,\r\n  STRIPE_PUBLISHABLE_KEY,\r\n  STRIPE_WEBHOOK_SECRET,\r\n  EDEN_ENABLE_MOCK_PROVIDER_WEBHOOKS,\r\n  ENABLE_HTTPS,\r\n  SERVER_KEY_PATH,\r\n  SERVER_CERT_PATH,\r\n  CA_CERT_PATH\r\n} from \"./src/config\";\r\nimport type { GardenConfig, TokenGardenConfig, LLMQueryResult } from \"./src/types\";\r\nimport {\r\n  GARDENS,\r\n  TOKEN_GARDENS,\r\n  initializeGardens,\r\n  initializeUsers,\r\n  ROOT_CA,\r\n  ROOT_CA_IDENTITY,\r\n  setROOTCA,\r\n  CERTIFICATE_REGISTRY,\r\n  REVOCATION_REGISTRY,\r\n  HOLY_GHOST_GARDEN,\r\n  LEDGER,\r\n  USERS as USERS_STATE,\r\n  TOTAL_IGAS,\r\n  setTOTAL_IGAS,\r\n  addTOTAL_IGAS,\r\n  getTOTAL_IGAS\r\n} from \"./src/state\";\r\nimport { ROOT_CA_UUID, REVOCATION_STREAM, WALLET_BALANCE_PREFIX, WALLET_HOLD_PREFIX, WALLET_AUDIT_PREFIX } from \"./src/constants\";\r\nimport {\r\n  initializeWallet,\r\n  syncWalletBalanceFromUser,\r\n  getWalletBalance,\r\n  creditWallet,\r\n  debitWallet,\r\n  processWalletIntent\r\n} from \"./src/wallet\";\r\nimport {\r\n  initializeServiceProvider,\r\n  validateGardenId,\r\n  registerServiceProviderWithROOTCA,\r\n  queryROOTCAServiceRegistry,\r\n  queryServiceProviders,\r\n  queryProviderAPI,\r\n  queryAMCAPI,\r\n  queryMovieComAPI,\r\n  queryCinemarkAPI,\r\n  queryDEXPoolAPI,\r\n  querySnakeAPI,\r\n  issueServiceProviderCertificate,\r\n  createServiceProvidersForGarden\r\n} from \"./src/serviceProvider\";\r\nimport { initializeServiceRegistry2, getServiceRegistry2 } from \"./src/serviceRegistry2\";\r\nimport { loadProviderPluginPersistence, saveProviderPluginPersistence, setMySQLProviderPluginConfig } from \"./src/plugins/providerPluginRegistry\";\r\nimport { testMySQLQuery } from \"./src/plugins/mysql\";\r\nimport {\r\n  initializeGarden,\r\n  issueGardenCertificate,\r\n  registerNewMovieGarden\r\n} from \"./src/garden\";\r\nimport {\r\n  initializeDEX,\r\n  initializeDEXPools,\r\n  executeDEXTrade,\r\n  calculateIGas\r\n} from \"./src/dex\";\r\nimport {\r\n  initializeLedger,\r\n  addLedgerEntry,\r\n  pushLedgerEntryToSettlementStream,\r\n  processPayment,\r\n  completeBooking,\r\n  getLedgerEntries,\r\n  getTransactionByPayer,\r\n  getTransactionBySnapshot,\r\n  getLatestSnapshot,\r\n  deliverWebhook,\r\n  getCashierStatus\r\n} from \"./src/ledger\";\r\nimport { callLLM, extractGetDataParamsWithOpenAI, parameterizeSQLWithOpenAI, type GetDataParamsResult, type SQLParameterizationResult } from \"./src/llm\";\r\nimport {\r\n  initializeFlowWise,\r\n  loadWorkflow,\r\n  executeWorkflow,\r\n  submitUserDecision,\r\n  WorkflowContext,\r\n  FlowWiseWorkflow,\r\n  evaluateCondition,\r\n  replaceTemplateVariables\r\n} from \"./src/flowwise\";\r\nimport {\r\n  initializeFlowWiseService,\r\n  startWorkflowFromUserInput,\r\n  submitUserDecision as submitUserDecisionToFlowWise,\r\n  executeNextStep,\r\n  getWorkflowState\r\n} from \"./src/components/flowwiseService\";\r\nimport { initializePriceBroadcaster } from \"./src/dex/priceBroadcaster\";\r\nimport {\r\n  initializePriesthoodCertification,\r\n  applyForPriesthood,\r\n  approvePriesthood,\r\n  rejectPriesthood,\r\n  revokePriesthood,\r\n  getCertificationStatus,\r\n  hasPriesthoodCertification,\r\n  getAllCertifications,\r\n  getCertificationsByStatus,\r\n  getCertificationStats,\r\n  type PriesthoodCertification\r\n} from \"./src/priesthoodCertification\";\r\nimport {\r\n  initializeMessaging,\r\n  createConversation,\r\n  getConversation,\r\n  getConversations,\r\n  sendMessage,\r\n  getConversationMessages,\r\n  forgiveMessage,\r\n  redactMessage,\r\n  updateConversationState,\r\n  escalateConversation\r\n} from \"./src/messaging/conversationService\";\r\nimport {\r\n  initializeIdentity,\r\n  createEdenUser,\r\n  getEdenUser,\r\n  getEdenUserByGoogleId,\r\n  getEdenUserByUsername,\r\n  getEdenUserByEmail,\r\n  isUsernameAvailable,\r\n  validateUsername,\r\n  joinGarden,\r\n  getGardenUser,\r\n  updateGardenNickname,\r\n  resolveDisplayName\r\n} from \"./src/identity\";\r\nimport {\r\n  initializeLLM,\r\n  extractQueryWithOpenAI,\r\n  // COMMENTED OUT: formatResponseWithOpenAI is now cloned directly in this file - do not import\r\n  // formatResponseWithOpenAI,\r\n  formatResponseWithDeepSeek,\r\n  // COMMENTED OUT: resolveLLM is disabled - use formatResponseWithOpenAI/formatResponseWithDeepSeek directly instead\r\n  // resolveLLM,\r\n  callLLM,\r\n  LLM_QUERY_EXTRACTION_PROMPT,\r\n  LLM_RESPONSE_FORMATTING_PROMPT\r\n} from \"./src/llm\";\r\n// NOTE: extractQueryWithDeepSeek is defined locally in this file (legacy), not imported\r\nimport { initializeLogger, getLogger } from \"./src/logger\";\r\nimport type { WalletIntent, WalletResult } from \"./src/types\";\r\nimport { getServiceTypeFields, extractBookingDetails, getServiceTypeMessage, formatRecommendation } from \"./src/serviceTypeFields\";\r\n\r\n// Initialize Stripe\r\nconst stripe = new Stripe(STRIPE_SECRET_KEY, {\r\n  apiVersion: \"2023-10-16\", // Use compatible API version\r\n});\r\n\r\n// HTTP/HTTPS Server for serving Angular and API\r\nlet httpServer: http.Server | https.Server;\r\n\r\nif (ENABLE_HTTPS) {\r\n  // Check if certificates exist\r\n  if (!fs.existsSync(SERVER_KEY_PATH) || !fs.existsSync(SERVER_CERT_PATH)) {\r\n    console.error(\"\u274C HTTPS enabled but certificates not found!\");\r\n    console.error(`   Server key: ${SERVER_KEY_PATH}`);\r\n    console.error(`   Server cert: ${SERVER_CERT_PATH}`);\r\n    console.error(\"\\n\uD83D\uDCDD Please run: node server/scripts/generate-pki-certs.js\");\r\n    process.exit(1);\r\n  }\r\n\r\n  // Load SSL certificates\r\n  const serverKey = fs.readFileSync(SERVER_KEY_PATH, \"utf8\");\r\n  const serverCert = fs.readFileSync(SERVER_CERT_PATH, \"utf8\");\r\n  const caCert = fs.existsSync(CA_CERT_PATH) ? fs.readFileSync(CA_CERT_PATH, \"utf8\") : undefined;\r\n\r\n  const httpsOptions: https.ServerOptions = {\r\n    key: serverKey,\r\n    cert: serverCert,\r\n    ca: caCert ? [caCert] : undefined,\r\n    requestCert: false, // Don't require client certificates for now\r\n    rejectUnauthorized: false, // Allow self-signed certificates\r\n  };\r\n\r\n  httpServer = https.createServer(httpsOptions);\r\n  console.log(\"\uD83D\uDD10 HTTPS enabled - using SSL/TLS certificates\");\r\n} else {\r\n  httpServer = http.createServer();\r\n  console.log(\"\uD83C\uDF10 HTTP mode (HTTPS disabled)\");\r\n}\r\n\r\n// WebSocket Server for Frontend (upgrade from HTTP server)\r\nconst wss = new WebSocketServer({ \r\n  server: httpServer,\r\n  path: \"/ws\" // Optional: specific WebSocket path\r\n});\r\nconst wsClients = new Set<WebSocket>();\r\n\r\nwss.on(\"connection\", (ws: WebSocket, req) => {\r\n  console.log(`\uD83D\uDD0C WebSocket client connected from ${req.socket.remoteAddress} (${wsClients.size + 1} total)`);\r\n  wsClients.add(ws);\r\n  \r\n  ws.on(\"close\", () => {\r\n    wsClients.delete(ws);\r\n    console.log(`\uD83D\uDD0C WebSocket client disconnected (${wsClients.size} remaining)`);\r\n  });\r\n  \r\n  ws.on(\"error\", (error: Error) => {\r\n    console.error(\"\u274C WebSocket error:\", error.message);\r\n  });\r\n  \r\n  // Send welcome message\r\n  ws.send(JSON.stringify({\r\n    type: \"connection\",\r\n    component: \"websocket\",\r\n    message: \"Connected to Eden Simulator\",\r\n    timestamp: Date.now(),\r\n  }));\r\n});\r\n\r\nwss.on(\"error\", (error: Error) => {\r\n  console.error(\"\u274C WebSocketServer error:\", error.message);\r\n});\r\n\r\n// Broadcast events to all connected clients\r\nexport function broadcastEvent(event: any) {\r\n  const message = JSON.stringify(event);\r\n  const connectedClients = Array.from(wsClients).filter(client => client.readyState === WebSocket.OPEN);\r\n  \r\n  // Enhanced debug logging for all broadcast events\r\n  const eventType = event.type || 'unknown';\r\n  const component = event.component || 'unknown';\r\n  const timestamp = event.timestamp || Date.now();\r\n  \r\n  // Log all events with key details\r\n  console.log(`\uD83D\uDCE1 [Broadcast] ========================================`);\r\n  console.log(`\uD83D\uDCE1 [Broadcast] Event Type: \"${eventType}\"`);\r\n  console.log(`\uD83D\uDCE1 [Broadcast] Component: \"${component}\"`);\r\n  console.log(`\uD83D\uDCE1 [Broadcast] Message: ${event.message || 'N/A'}`);\r\n  console.log(`\uD83D\uDCE1 [Broadcast] Timestamp: ${new Date(timestamp).toISOString()}`);\r\n  \r\n  // Special logging for critical events\r\n  if (eventType === 'ledger_entry_added' || eventType === 'ledger_entry_created' || \r\n      eventType === 'cashier_payment_processed' || eventType === 'cashier_start') {\r\n    console.log(`\uD83D\uDCE1 [Broadcast] \u2B50 CRITICAL EVENT - LEDGER/CASHIER`);\r\n    console.log(`\uD83D\uDCE1 [Broadcast] Event data:`, JSON.stringify(event.data || {}, null, 2));\r\n  }\r\n  \r\n  // Log workflow-related events\r\n  if (eventType.includes('workflow') || eventType.includes('step') || \r\n      eventType === 'user_decision_required' || eventType === 'user_selection_required') {\r\n    console.log(`\uD83D\uDCE1 [Broadcast] \uD83D\uDD04 WORKFLOW EVENT`);\r\n    if (event.data?.stepId) {\r\n      console.log(`\uD83D\uDCE1 [Broadcast] Step ID: ${event.data.stepId}`);\r\n      console.log(`\uD83D\uDCE1 [Broadcast] Step Name: ${event.data.stepName || 'N/A'}`);\r\n    }\r\n    if (event.data?.selectedListing) {\r\n      console.log(`\uD83D\uDCE1 [Broadcast] Selected Listing:`, JSON.stringify(event.data.selectedListing, null, 2));\r\n    }\r\n  }\r\n  \r\n  // Log movie-related events\r\n  if (eventType.includes('movie') || component === 'movie_theater') {\r\n    console.log(`\uD83D\uDCE1 [Broadcast] \uD83C\uDFAC MOVIE EVENT`);\r\n    if (event.data?.movieTitle) {\r\n      console.log(`\uD83D\uDCE1 [Broadcast] Movie Title: ${event.data.movieTitle}`);\r\n    }\r\n    if (event.data?.movieProgress !== undefined) {\r\n      console.log(`\uD83D\uDCE1 [Broadcast] Movie Progress: ${event.data.movieProgress}%`);\r\n    }\r\n  }\r\n  \r\n  if (connectedClients.length === 0) {\r\n    console.log(`\uD83D\uDCE1 [Broadcast] \u26A0\uFE0F  No WebSocket clients connected, event NOT sent`);\r\n    console.log(`\uD83D\uDCE1 [Broadcast] ========================================`);\r\n    return;\r\n  }\r\n  \r\n  console.log(`\uD83D\uDCE1 [Broadcast] Sending to ${connectedClients.length} WebSocket client(s)`);\r\n  console.log(`\uD83D\uDCE1 [Broadcast] Message size: ${message.length} bytes`);\r\n  \r\n  let successCount = 0;\r\n  let failCount = 0;\r\n  \r\n  connectedClients.forEach((client, index) => {\r\n    try {\r\n      client.send(message);\r\n      successCount++;\r\n      // Log successful send for critical events\r\n      if (eventType === 'ledger_entry_added' || eventType === 'cashier_payment_processed' || \r\n          eventType.includes('workflow') || eventType.includes('step')) {\r\n        console.log(`\uD83D\uDCE1 [Broadcast] \u2705 Client ${index + 1}/${connectedClients.length}: Sent \"${eventType}\"`);\r\n      }\r\n    } catch (err: any) {\r\n      failCount++;\r\n      console.error(`\uD83D\uDCE1 [Broadcast] \u274C Client ${index + 1}/${connectedClients.length}: Failed to send \"${eventType}\": ${err.message}`);\r\n    }\r\n  });\r\n  \r\n  console.log(`\uD83D\uDCE1 [Broadcast] Result: ${successCount} sent, ${failCount} failed`);\r\n  console.log(`\uD83D\uDCE1 [Broadcast] ========================================`);\r\n}\r\n\r\n// BigInt JSON replacer function for serialization\r\nfunction bigIntReplacer(key: string, value: any): any {\r\n  if (typeof value === 'bigint') {\r\n    // Convert BigInt to Number if within safe integer range, otherwise to String\r\n    if (value <= Number.MAX_SAFE_INTEGER && value >= Number.MIN_SAFE_INTEGER) {\r\n      return Number(value);\r\n    } else {\r\n      return value.toString();\r\n    }\r\n  }\r\n  return value;\r\n}\r\n\r\n// HTTP Server Routes\r\nhttpServer.on(\"request\", async (req, res) => {\r\n  const requestId = `${Date.now()}-${Math.random().toString(36).substring(7)}`;\r\n  // Basic request logging enabled for debugging\r\n  console.log(`\uD83D\uDCE5 [${requestId}] ${req.method} ${req.url}`);\r\n  \r\n  const parsedUrl = url.parse(req.url || \"/\", true);\r\n  const pathname = parsedUrl.pathname || \"/\";\r\n\r\n  // WebSocket upgrade requests are handled automatically by WebSocketServer\r\n  // No need to intercept them here\r\n  if (req.headers.upgrade === \"websocket\") {\r\n    console.log(`   \u26A1 WebSocket upgrade request, skipping HTTP handler`);\r\n    return;\r\n  }\r\n\r\n  // CORS headers\r\n  res.setHeader(\"Access-Control-Allow-Origin\", \"*\");\r\n  res.setHeader(\"Access-Control-Allow-Methods\", \"GET, POST, OPTIONS, HEAD\");\r\n  res.setHeader(\"Access-Control-Allow-Headers\", \"Content-Type, Range\");\r\n  res.setHeader(\"Access-Control-Expose-Headers\", \"Content-Range, Accept-Ranges, Content-Length\");\r\n\r\n  if (req.method === \"OPTIONS\") {\r\n    console.log(`   \u2705 [${requestId}] OPTIONS request, sending CORS preflight`);\r\n    res.writeHead(200);\r\n    res.end();\r\n    return;\r\n  }\r\n\r\n  // API Routes\r\n  // GET /api/workflow/list - List all available workflows (MUST BE BEFORE /api/workflow/:serviceType)\r\n  if (pathname === \"/api/workflow/list\" && req.method === \"GET\") {\r\n    console.log(`   \uD83D\uDCCB [${requestId}] GET /api/workflow/list - Listing available workflows`);\r\n    \r\n    try {\r\n      const dataPath = path.join(__dirname, \"data\");\r\n      const workflows: Array<{serviceType: string, filename: string, exists: boolean, stepCount?: number}> = [];\r\n      \r\n      // Dynamically scan the data directory for all .json files (removes hardcoded dependencies)\r\n      if (fs.existsSync(dataPath)) {\r\n        const files = fs.readdirSync(dataPath);\r\n        const jsonFiles = files.filter(file => file.endsWith('.json') && !file.startsWith('.'));\r\n        \r\n        // Create a set of found service types\r\n        const foundServiceTypes = new Set<string>();\r\n        \r\n        for (const file of jsonFiles) {\r\n          // Extract service type from filename (remove .json extension)\r\n          const serviceType = file.replace('.json', '');\r\n          \r\n          // Skip non-workflow files (if any)\r\n          if (serviceType && !foundServiceTypes.has(serviceType)) {\r\n            foundServiceTypes.add(serviceType);\r\n            \r\n            const filePath = path.join(dataPath, file);\r\n            const exists = fs.existsSync(filePath);\r\n            let stepCount: number | undefined = undefined;\r\n            \r\n            // If workflow exists, load it and count steps\r\n            if (exists) {\r\n              try {\r\n                const fileContent = fs.readFileSync(filePath, \"utf-8\");\r\n                const data = JSON.parse(fileContent);\r\n                if (data.flowwiseWorkflow && data.flowwiseWorkflow.steps && Array.isArray(data.flowwiseWorkflow.steps)) {\r\n                  stepCount = data.flowwiseWorkflow.steps.length;\r\n                  console.log(`   \uD83D\uDCCB [${requestId}] Workflow ${serviceType}: ${file} - ${stepCount} steps`);\r\n                } else {\r\n                  console.log(`   \u26A0\uFE0F [${requestId}] Workflow ${serviceType}: ${file} - exists but no steps found`);\r\n                }\r\n              } catch (parseError: any) {\r\n                console.error(`   \u26A0\uFE0F [${requestId}] Error parsing workflow ${serviceType}: ${parseError.message}`);\r\n              }\r\n            }\r\n            \r\n            workflows.push({ \r\n              serviceType, \r\n              filename: file, \r\n              exists, \r\n              stepCount \r\n            });\r\n          }\r\n        }\r\n        \r\n        // Also include known service types that might not have files yet (for completeness)\r\n        // This ensures the frontend always has a complete list to display\r\n        const knownServiceTypes = [\r\n          'movie', 'amc', 'autobodyshop', 'autorepairshop', 'bank', 'church', 'court',\r\n          'dex', 'dogpark', 'gasstation', 'grocerystore', 'gym', 'hospital', 'hotel',\r\n          'jail', 'laborcamp', 'library', 'pharmacy', 'policestation', 'postoffice',\r\n          'priest', 'restaurant', 'school', 'university', 'airline', 'autoparts', 'snake'\r\n        ];\r\n        \r\n        // Add missing service types (that don't have files yet) to the list\r\n        for (const knownType of knownServiceTypes) {\r\n          if (!foundServiceTypes.has(knownType)) {\r\n            const filename = `${knownType}.json`;\r\n            workflows.push({\r\n              serviceType: knownType,\r\n              filename: filename,\r\n              exists: false,\r\n              stepCount: undefined\r\n            });\r\n          }\r\n        }\r\n        \r\n        // Sort workflows by serviceType for consistent ordering\r\n        workflows.sort((a, b) => a.serviceType.localeCompare(b.serviceType));\r\n        \r\n        console.log(`   \uD83D\uDCCB [${requestId}] Found ${workflows.filter(w => w.exists).length} existing workflows out of ${workflows.length} total`);\r\n      } else {\r\n        console.warn(`   \u26A0\uFE0F [${requestId}] Data directory does not exist: ${dataPath}`);\r\n      }\r\n      \r\n      res.writeHead(200, {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Access-Control-Allow-Origin\": \"*\"\r\n      });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        workflows\r\n      }));\r\n    } catch (error: any) {\r\n      console.error(`   \u274C [${requestId}] Error listing workflows:`, error.message);\r\n      res.writeHead(500, {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Access-Control-Allow-Origin\": \"*\"\r\n      });\r\n      res.end(JSON.stringify({\r\n        success: false,\r\n        error: error.message\r\n      }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // GET /api/workflow/:serviceType - Get workflow definition (MUST BE AFTER /api/workflow/list)\r\n  if (pathname.startsWith(\"/api/workflow/\") && req.method === \"GET\" && pathname !== \"/api/workflow/decision\" && pathname !== \"/api/workflow/list\") {\r\n    const serviceType = pathname.split(\"/\").pop();\r\n    console.log(`   \uD83D\uDCCB [${requestId}] GET /api/workflow/${serviceType} - Loading workflow definition`);\r\n    console.log(`   \uD83D\uDD0D [${requestId}] Service type from URL: \"${serviceType}\"`);\r\n    console.log(`   \uD83D\uDD0D [${requestId}] Full pathname: \"${pathname}\"`);\r\n\r\n    if (!serviceType) {\r\n      res.writeHead(400, {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Access-Control-Allow-Origin\": \"*\"\r\n      });\r\n      res.end(JSON.stringify({\r\n        success: false,\r\n        error: \"Service type is required\"\r\n      }));\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const workflow: FlowWiseWorkflow | null = loadWorkflow(serviceType);\r\n      console.log(`   \uD83D\uDD04 [${requestId}] Workflow loaded: ${workflow ? 'SUCCESS' : 'FAILED'} - ${workflow?.name || 'N/A'}`);\r\n      if (workflow) {\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Workflow name: \"${workflow.name}\"`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Workflow serviceType check: First step serviceType = \"${(workflow.steps[0]?.actions?.find((a: any) => a.serviceType) as any)?.serviceType || 'N/A'}\"`);\r\n      }\r\n\r\n      if (workflow) {\r\n        const responseData = {\r\n          success: true,\r\n          flowwiseWorkflow: workflow\r\n        };\r\n        console.log(`   \u2705 [${requestId}] Sending workflow response with ${workflow.steps.length} steps`);\r\n        console.log(`   \uD83D\uDCE4 [${requestId}] Response: 200 OK (workflow definition)`);\r\n        res.writeHead(200, {\r\n          \"Content-Type\": \"application/json\",\r\n          \"Access-Control-Allow-Origin\": \"*\"\r\n        });\r\n        res.end(JSON.stringify(responseData));\r\n      } else {\r\n        console.log(`   \u274C [${requestId}] Workflow not found for service type: ${serviceType}`);\r\n        res.writeHead(404, {\r\n          \"Content-Type\": \"application/json\",\r\n          \"Access-Control-Allow-Origin\": \"*\"\r\n        });\r\n        res.end(JSON.stringify({\r\n          success: false,\r\n          error: `Workflow not found for service type: ${serviceType}`\r\n        }));\r\n      }\r\n    } catch (error: any) {\r\n      console.error(`   \u274C [${requestId}] Error loading workflow:`, error.message);\r\n      console.error(`   \u274C [${requestId}] Stack trace:`, error.stack);\r\n      res.writeHead(500, {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Access-Control-Allow-Origin\": \"*\"\r\n      });\r\n      res.end(JSON.stringify({\r\n        success: false,\r\n        error: error.message\r\n      }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // GET /api/workflow/pending-decision/:email - Check if user has pending workflow decision\r\n  if (pathname.startsWith(\"/api/workflow/pending-decision/\") && req.method === \"GET\") {\r\n    const email = decodeURIComponent(pathname.split(\"/\").pop() || \"\");\r\n    console.log(`   \uD83E\uDD14 [${requestId}] GET /api/workflow/pending-decision/${email} - Checking for pending decisions`);\r\n    \r\n    try {\r\n      if (!(global as any).workflowExecutions) {\r\n        (global as any).workflowExecutions = new Map();\r\n      }\r\n      const workflowExecutions = (global as any).workflowExecutions as Map<string, any>;\r\n      \r\n      // Find active executions waiting for user decision\r\n      const pendingExecutions: any[] = [];\r\n      for (const [executionId, execution] of workflowExecutions.entries()) {\r\n        if (execution.context?.user?.email === email || execution.userEmail === email) {\r\n          const currentStep = execution.workflow?.steps?.find((s: any) => s.id === execution.currentStep);\r\n          if (currentStep?.type === \"decision\" && currentStep?.requiresUserDecision) {\r\n            pendingExecutions.push({\r\n              executionId: execution.executionId,\r\n              stepId: execution.currentStep,\r\n              stepName: currentStep.name,\r\n              prompt: currentStep.decisionPrompt,\r\n              options: currentStep.decisionOptions || []\r\n            });\r\n          }\r\n        }\r\n      }\r\n      \r\n      res.writeHead(200, {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Access-Control-Allow-Origin\": \"*\"\r\n      });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        hasPendingDecision: pendingExecutions.length > 0,\r\n        pendingExecutions: pendingExecutions\r\n      }));\r\n    } catch (error: any) {\r\n      console.error(`   \u274C [${requestId}] Error checking pending decisions:`, error.message);\r\n      res.writeHead(500, {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Access-Control-Allow-Origin\": \"*\"\r\n      });\r\n      res.end(JSON.stringify({\r\n        success: false,\r\n        error: error.message\r\n      }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // GET /api/igas/total - Get total iGas\r\n  if (pathname === \"/api/igas/total\" && req.method === \"GET\") {\r\n    console.log(`   \u26FD [${requestId}] GET /api/igas/total - Fetching total iGas`);\r\n    // AccountantService is the source of truth for iGas totals (same pipeline as Total Fees).\r\n    // TOTAL_IGAS can be stale/0 if not actively accumulated; use accountant state instead.\r\n    let totalIGas = 0;\r\n    try {\r\n      const { getAccountantState } = await import(\"./src/accountant\");\r\n      totalIGas = getAccountantState().totalIGas || 0;\r\n    } catch (err: any) {\r\n      console.warn(`\u26A0\uFE0F  [${requestId}] Failed to load Accountant totalIGas, falling back to TOTAL_IGAS: ${err.message}`);\r\n      totalIGas = getTOTAL_IGAS() || 0;\r\n    }\r\n    res.writeHead(200, {\r\n      \"Content-Type\": \"application/json\",\r\n      \"Access-Control-Allow-Origin\": \"*\"\r\n    });\r\n    res.end(JSON.stringify({\r\n      success: true,\r\n      totalIGas,\r\n      timestamp: Date.now()\r\n    }));\r\n    return;\r\n  }\r\n\r\n  // GET /api/liquidity-accountant/summary - Get Liquidity Accountant Service summary\r\n  if (pathname === \"/api/liquidity-accountant/summary\" && req.method === \"GET\") {\r\n    console.log(`   \uD83D\uDCA7 [${requestId}] GET /api/liquidity-accountant/summary - Fetching liquidity summary`);\r\n    try {\r\n      const { getLiquiditySummary } = await import(\"./src/liquidityAccountant\");\r\n      const summary = getLiquiditySummary();\r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: true, summary }));\r\n    } catch (err: any) {\r\n      console.error(`   \u274C Error fetching liquidity summary:`, err);\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: err.message }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // GET /api/liquidity-accountant/pool/:poolId - Get liquidity record for a specific pool\r\n  if (pathname.startsWith(\"/api/liquidity-accountant/pool/\") && req.method === \"GET\") {\r\n    const poolId = pathname.split(\"/\").pop();\r\n    console.log(`   \uD83D\uDCA7 [${requestId}] GET /api/liquidity-accountant/pool/${poolId} - Fetching liquidity record`);\r\n    try {\r\n      const { getLiquidityRecord } = await import(\"./src/liquidityAccountant\");\r\n      const record = getLiquidityRecord(poolId || \"\");\r\n      if (record) {\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, record }));\r\n      } else {\r\n        res.writeHead(404, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: \"Liquidity record not found\" }));\r\n      }\r\n    } catch (err: any) {\r\n      console.error(`   \u274C Error fetching liquidity record:`, err);\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: err.message }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // GET /api/liquidity-accountant/garden/:gardenId - Get liquidity records for a specific garden\r\n  if (pathname.startsWith(\"/api/liquidity-accountant/garden/\") && req.method === \"GET\") {\r\n    const gardenId = pathname.split(\"/\").pop();\r\n    console.log(`   \uD83D\uDCA7 [${requestId}] GET /api/liquidity-accountant/garden/${gardenId} - Fetching liquidity records`);\r\n    try {\r\n      const { getLiquidityRecordsByGarden } = await import(\"./src/liquidityAccountant\");\r\n      const records = getLiquidityRecordsByGarden(gardenId || \"\");\r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: true, records }));\r\n    } catch (err: any) {\r\n      console.error(`   \u274C Error fetching garden liquidity records:`, err);\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: err.message }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // GET /api/accountant/summary - Get Accountant Service financial summary\r\n  if (pathname === \"/api/accountant/summary\" && req.method === \"GET\") {\r\n    console.log(`   \uD83D\uDCCA [${requestId}] GET /api/accountant/summary - Fetching financial summary`);\r\n    try {\r\n      const { getFinancialSummary } = await import(\"./src/accountant\");\r\n      const summary = getFinancialSummary();\r\n      res.writeHead(200, {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Access-Control-Allow-Origin\": \"*\"\r\n      });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        ...summary,\r\n        timestamp: Date.now()\r\n      }));\r\n    } catch (error: any) {\r\n      console.error(`   \u274C [${requestId}] Error fetching accountant summary:`, error.message);\r\n      res.writeHead(500, {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Access-Control-Allow-Origin\": \"*\"\r\n      });\r\n      res.end(JSON.stringify({\r\n        success: false,\r\n        error: error.message\r\n      }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // POST /api/workflow/action - Execute a workflow action\r\n  if (pathname === \"/api/workflow/action\" && req.method === \"POST\") {\r\n    console.log(`   \u2699\uFE0F [${requestId}] POST /api/workflow/action - Workflow action execution`);\r\n    let body = \"\";\r\n\r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n\r\n    req.on(\"end\", async () => {\r\n      const sendResponse = (statusCode: number, data: any) => {\r\n        if (!res.headersSent) {\r\n          console.log(`   \uD83D\uDCE4 [${requestId}] Response: ${statusCode} ${statusCode === 200 ? 'OK' : 'ERROR'} (${JSON.stringify(data).length} bytes)`);\r\n          res.writeHead(statusCode, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify(data));\r\n        }\r\n      };\r\n\r\n      try {\r\n        const parsedBody = JSON.parse(body);\r\n        const { executionId, action, context } = parsedBody;\r\n\r\n        if (!executionId || !action) {\r\n          sendResponse(400, { success: false, error: \"executionId and action are required\" });\r\n          return;\r\n        }\r\n\r\n        console.log(`   \uD83D\uDD04 [${requestId}] Executing action ${action.type} in execution ${executionId}`);\r\n\r\n        // Handle different action types\r\n        let result: any = {\r\n          actionExecuted: action.type,\r\n          timestamp: Date.now()\r\n        };\r\n\r\n        try {\r\n          switch (action.type) {\r\n            case 'check_balance':\r\n              // Check if user has sufficient balance\r\n              const userEmail = action.email || context?.user?.email;\r\n              const requiredAmount = action.required || context?.totalCost || action.amount;\r\n\r\n              if (!userEmail || !requiredAmount) {\r\n                throw new Error('Missing user email or amount for balance check');\r\n              }\r\n\r\n              const balance = getWalletBalance(userEmail);\r\n              const hasBalance = balance >= requiredAmount;\r\n\r\n              result = {\r\n                ...result,\r\n                balanceChecked: true,\r\n                userEmail,\r\n                requiredAmount,\r\n                currentBalance: balance,\r\n                sufficientFunds: hasBalance\r\n              };\r\n              break;\r\n\r\n            case 'process_payment':\r\n              // Process the actual payment\r\n              const paymentUser = action.user || context?.user;\r\n              const paymentAmount = action.amount || context?.totalCost || context?.moviePrice;\r\n              const ledgerEntry = action.ledgerEntry || context?.ledgerEntry;\r\n\r\n              if (!paymentUser?.email || !paymentAmount || !ledgerEntry) {\r\n                throw new Error('Missing payment details');\r\n              }\r\n\r\n              // Debit the user wallet\r\n              const debitResult = debitWallet(paymentUser.email, paymentAmount);\r\n              if (!debitResult.success) {\r\n                throw new Error(`Payment failed: ${debitResult.error}`);\r\n              }\r\n\r\n              // Process the payment through cashier\r\n              const paymentResult = processPayment(ledgerEntry, paymentUser);\r\n\r\n              result = {\r\n                ...result,\r\n                paymentProcessed: true,\r\n                paymentSuccess: true,\r\n                amount: paymentAmount,\r\n                newBalance: debitResult.newBalance,\r\n                ledgerEntry: paymentResult\r\n              };\r\n              break;\r\n\r\n            case 'complete_booking':\r\n              // Complete the booking\r\n              const bookingEntry = action.ledgerEntry || context?.ledgerEntry;\r\n              if (!bookingEntry) {\r\n                throw new Error('Missing ledger entry for booking completion');\r\n              }\r\n\r\n              const bookingResult = completeBooking(bookingEntry);\r\n\r\n              result = {\r\n                ...result,\r\n                bookingCompleted: true,\r\n                bookingResult\r\n              };\r\n              break;\r\n\r\n            default:\r\n              // Default action acknowledgment\r\n              console.log(`   \u2699\uFE0F [${requestId}] Action ${action.type} acknowledged (no specific handler)`);\r\n          }\r\n\r\n          sendResponse(200, {\r\n            success: true,\r\n            message: `Action ${action.type} executed successfully`,\r\n            result\r\n          });\r\n\r\n        } catch (actionError: any) {\r\n          console.error(`   \u274C [${requestId}] Action execution error for ${action.type}:`, actionError.message);\r\n          sendResponse(500, {\r\n            success: false,\r\n            error: `Action ${action.type} failed: ${actionError.message}`,\r\n            result: {\r\n              actionExecuted: action.type,\r\n              success: false,\r\n              error: actionError.message,\r\n              timestamp: Date.now()\r\n            }\r\n          });\r\n        }\r\n\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Error executing workflow action:`, error.message);\r\n        sendResponse(500, { success: false, error: error.message });\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // POST /api/workflow/execute-step - Execute a specific workflow step atomically on server\r\n  if (pathname === \"/api/workflow/execute-step\" && req.method === \"POST\") {\r\n    console.log(`   \u25B6\uFE0F [${requestId}] POST /api/workflow/execute-step - Atomic step execution`);\r\n    let body = \"\";\r\n\r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n\r\n    req.on(\"end\", async () => {\r\n      const sendResponse = (statusCode: number, data: any) => {\r\n        if (!res.headersSent) {\r\n          console.log(`   \uD83D\uDCE4 [${requestId}] Response: ${statusCode} ${statusCode === 200 ? 'OK' : 'ERROR'} (${JSON.stringify(data).length} bytes)`);\r\n          res.writeHead(statusCode, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify(data));\r\n        }\r\n      };\r\n\r\n      try {\r\n        const parsedBody = JSON.parse(body);\r\n        const { executionId, stepId, context, serviceType } = parsedBody;\r\n\r\n        if (!executionId || !stepId || !serviceType) {\r\n          sendResponse(400, { success: false, error: \"executionId, stepId, and serviceType are required\" });\r\n          return;\r\n        }\r\n\r\n        console.log(`   \uD83D\uDD04 [${requestId}] Executing step ${stepId} atomically for ${serviceType} workflow`);\r\n\r\n        // Import template variable replacement function\r\n        const { replaceTemplateVariables } = await import(\"./src/flowwise\");\r\n\r\n        // Load the appropriate workflow definition dynamically\r\n        const workflow = loadWorkflow(serviceType);\r\n\r\n        if (!workflow) {\r\n          sendResponse(400, { success: false, error: \"Invalid workflow definition\" });\r\n          return;\r\n        }\r\n\r\n        // Find the step to execute\r\n        const step = workflow.steps.find((s: any) => s.id === stepId);\r\n        if (!step) {\r\n          sendResponse(404, { success: false, error: `Step not found: ${stepId}` });\r\n          return;\r\n        }\r\n\r\n        console.log(`   \u2699\uFE0F [${requestId}] ========================================`);\r\n        console.log(`   \u2699\uFE0F [${requestId}] \uD83D\uDE80 EXECUTE-STEP ENDPOINT: STEP EXECUTION START`);\r\n        console.log(`   \u2699\uFE0F [${requestId}] Step ID: ${stepId}`);\r\n        console.log(`   \u2699\uFE0F [${requestId}] Step Name: ${step.name}`);\r\n        console.log(`   \u2699\uFE0F [${requestId}] Step Type: ${step.type}`);\r\n        console.log(`   \u2699\uFE0F [${requestId}] Step Component: ${step.component}`);\r\n        console.log(`   \u2699\uFE0F [${requestId}] Actions Count: ${step.actions?.length || 0}`);\r\n        if (step.actions) {\r\n          console.log(`   \u2699\uFE0F [${requestId}] Action Types:`, step.actions.map((a: any) => a.type));\r\n        }\r\n        console.log(`   \u2699\uFE0F [${requestId}] ========================================`);\r\n\r\n        // Initialize updatedContext from the provided context (like old codebase)\r\n        // The request context should already have all data from previous steps\r\n        const updatedContext = { ...context };\r\n        \r\n        console.log(`   \uD83D\uDD0D [${requestId}] ========================================`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] CONTEXT INITIALIZATION FOR STEP: ${stepId}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] ========================================`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Request context keys:`, Object.keys(context || {}));\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Request context has listings: ${!!context?.listings} (${context?.listings?.length || 0})`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Request context listings type: ${typeof context?.listings}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Request context listings is array: ${Array.isArray(context?.listings)}`);\r\n        if (context?.listings && Array.isArray(context.listings) && context.listings.length > 0) {\r\n          console.log(`   \uD83D\uDD0D [${requestId}] First listing keys:`, Object.keys(context.listings[0]));\r\n          console.log(`   \uD83D\uDD0D [${requestId}] First listing:`, JSON.stringify(context.listings[0], null, 2).substring(0, 500));\r\n        }\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Request context has llmResponse: ${!!context?.llmResponse}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Request context llmResponse keys:`, context?.llmResponse ? Object.keys(context.llmResponse) : 'N/A');\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Request context llmResponse has listings: ${!!context?.llmResponse?.listings} (${context?.llmResponse?.listings?.length || 0})`);\r\n        if (context?.llmResponse?.listings && Array.isArray(context.llmResponse.listings) && context.llmResponse.listings.length > 0) {\r\n          console.log(`   \uD83D\uDD0D [${requestId}] llmResponse first listing keys:`, Object.keys(context.llmResponse.listings[0]));\r\n        }\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Final updatedContext has listings: ${!!updatedContext.listings} (${updatedContext.listings?.length || 0})`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] ========================================`);\r\n        \r\n        // CRITICAL: If listings are missing but llmResponse.listings exists, use that\r\n        // This handles cases where listings are in llmResponse but not in context.listings\r\n        if ((!updatedContext.listings || updatedContext.listings.length === 0) && updatedContext.llmResponse?.listings && Array.isArray(updatedContext.llmResponse.listings) && updatedContext.llmResponse.listings.length > 0) {\r\n          updatedContext.listings = updatedContext.llmResponse.listings;\r\n          console.log(`   \uD83D\uDD04 [${requestId}] \u2705 Using listings from llmResponse (${updatedContext.llmResponse.listings.length} listings)`);\r\n        } else if (!updatedContext.listings || updatedContext.listings.length === 0) {\r\n          console.warn(`   \u26A0\uFE0F [${requestId}] \u26A0\uFE0F NO LISTINGS FOUND in context or llmResponse!`);\r\n          console.warn(`   \u26A0\uFE0F [${requestId}] This will cause empty options array for user_select_listing step`);\r\n        }\r\n        \r\n        // CRITICAL: If executing error_handler step, ensure error object is in context\r\n        // The error might have been set in a previous step execution\r\n        if (stepId === 'error_handler') {\r\n          console.log(`   \uD83D\uDD0D [${requestId}] ========================================`);\r\n          console.log(`   \uD83D\uDD0D [${requestId}] ERROR_HANDLER STEP EXECUTING`);\r\n          console.log(`   \uD83D\uDD0D [${requestId}] Initial context has error:`, !!updatedContext.error);\r\n          console.log(`   \uD83D\uDD0D [${requestId}] Initial context error value:`, updatedContext.error);\r\n          \r\n          if (!updatedContext.error) {\r\n            console.log(`   \u26A0\uFE0F [${requestId}] error_handler step executing but error not in context, checking execution state`);\r\n            if (!(global as any).workflowExecutions) {\r\n              (global as any).workflowExecutions = new Map();\r\n            }\r\n            const workflowExecutions = (global as any).workflowExecutions as Map<string, any>;\r\n            const existingExecution = workflowExecutions.get(executionId);\r\n            \r\n            console.log(`   \uD83D\uDD0D [${requestId}] Existing execution found:`, !!existingExecution);\r\n            if (existingExecution) {\r\n              console.log(`   \uD83D\uDD0D [${requestId}] Existing execution context keys:`, Object.keys(existingExecution.context || {}));\r\n              console.log(`   \uD83D\uDD0D [${requestId}] Existing execution context has error:`, !!existingExecution.context?.error);\r\n              console.log(`   \uD83D\uDD0D [${requestId}] Existing execution context error:`, existingExecution.context?.error);\r\n            }\r\n            \r\n            if (existingExecution && existingExecution.context && existingExecution.context.error) {\r\n              console.log(`   \u2705 [${requestId}] Found error in existing execution context, copying to updatedContext`);\r\n              updatedContext.error = existingExecution.context.error;\r\n              console.log(`   \u2705 [${requestId}] Error copied:`, JSON.stringify(updatedContext.error, null, 2));\r\n            } else {\r\n              console.warn(`   \u26A0\uFE0F [${requestId}] No error found in execution context for error_handler step`);\r\n              console.warn(`   \u26A0\uFE0F [${requestId}] This means the error_handler step was called without a previous error`);\r\n              // Try to find error in the workflow steps that have errorHandling\r\n              const stepsWithErrorHandling = workflow.steps.filter((s: any) => s.errorHandling && s.errorHandling.onError === 'error_handler');\r\n              console.log(`   \uD83D\uDD0D [${requestId}] Steps with errorHandling pointing to error_handler:`, stepsWithErrorHandling.map((s: any) => s.id));\r\n              \r\n              // Set a default error object if none exists\r\n              updatedContext.error = {\r\n                component: 'unknown',\r\n                message: 'Unknown error occurred - error_handler step executed without error context',\r\n                stepId: 'unknown',\r\n                stepName: 'Unknown Step',\r\n                error: 'Unknown error occurred - error_handler step executed without error context'\r\n              };\r\n            }\r\n          } else {\r\n            console.log(`   \u2705 [${requestId}] Error object already in context:`, JSON.stringify(updatedContext.error, null, 2));\r\n          }\r\n          console.log(`   \uD83D\uDD0D [${requestId}] Final context error:`, JSON.stringify(updatedContext.error, null, 2));\r\n          console.log(`   \uD83D\uDD0D [${requestId}] ========================================`);\r\n        }\r\n        \r\n        // Set service-type-specific price in context if selectedListing exists\r\n        if (updatedContext.selectedListing && updatedContext.selectedListing.price) {\r\n          const currentServiceType = updatedContext.serviceType || serviceType || 'movie';\r\n          if (currentServiceType === 'hotel') {\r\n            updatedContext.hotelPrice = updatedContext.selectedListing.price;\r\n          } else if (currentServiceType === 'movie') {\r\n            updatedContext.moviePrice = updatedContext.selectedListing.price;\r\n          } else if (currentServiceType === 'airline') {\r\n            updatedContext.airlinePrice = updatedContext.selectedListing.price;\r\n          } else if (currentServiceType === 'restaurant') {\r\n            updatedContext.restaurantPrice = updatedContext.selectedListing.price;\r\n          } else if (currentServiceType === 'grocerystore') {\r\n            updatedContext.grocerystorePrice = updatedContext.selectedListing.price;\r\n          } else if (currentServiceType === 'pharmacy') {\r\n            updatedContext.pharmacyPrice = updatedContext.selectedListing.price;\r\n          } else if (currentServiceType === 'dogpark') {\r\n            updatedContext.dogparkPrice = updatedContext.selectedListing.price;\r\n          } else if (currentServiceType === 'gasstation') {\r\n            updatedContext.gasstationPrice = updatedContext.selectedListing.price;\r\n          } else if (currentServiceType === 'party') {\r\n            updatedContext.partyPrice = updatedContext.selectedListing.price;\r\n          } else if (currentServiceType === 'bank') {\r\n            updatedContext.bankPrice = updatedContext.selectedListing.price;\r\n          }\r\n          // Also set generic totalCost for backward compatibility\r\n          updatedContext.totalCost = updatedContext.selectedListing.price;\r\n        }\r\n        \r\n        // CRITICAL: Initialize cashier in context if not already set (needed for cashier_process_payment step)\r\n        if (!updatedContext.cashier && (step.component === 'cashier' || step.id === 'cashier_process_payment')) {\r\n          updatedContext.cashier = getCashierStatus();\r\n          console.log(`   \uD83D\uDCB0 [${requestId}] ========================================`);\r\n          console.log(`   \uD83D\uDCB0 [${requestId}] \uD83D\uDCB0 CASHIER INITIALIZED IN CONTEXT`);\r\n          console.log(`   \uD83D\uDCB0 [${requestId}] Step ID: ${step.id}`);\r\n          console.log(`   \uD83D\uDCB0 [${requestId}] Cashier:`, {\r\n            id: updatedContext.cashier.id,\r\n            name: updatedContext.cashier.name,\r\n            processedCount: updatedContext.cashier.processedCount,\r\n            totalProcessed: updatedContext.cashier.totalProcessed\r\n          });\r\n          console.log(`   \uD83D\uDCB0 [${requestId}] ========================================`);\r\n        }\r\n        \r\n        const executedActions: any[] = [];\r\n        const events: any[] = [];\r\n\r\n        // Handle decision steps specially - they require user interaction\r\n        if (step.type === \"decision\" && step.requiresUserDecision) {\r\n          console.log(`   \uD83E\uDD14 [${requestId}] ========================================`);\r\n          console.log(`   \uD83E\uDD14 [${requestId}] DECISION STEP DETECTED: ${step.id}`);\r\n          console.log(`   \uD83E\uDD14 [${requestId}] Step name: ${step.name}`);\r\n          console.log(`   \uD83E\uDD14 [${requestId}] Step type: ${step.type}`);\r\n          console.log(`   \uD83E\uDD14 [${requestId}] requiresUserDecision: ${step.requiresUserDecision}`);\r\n          console.log(`   \uD83E\uDD14 [${requestId}] Has websocketEvents: ${!!step.websocketEvents}`);\r\n          console.log(`   \uD83E\uDD14 [${requestId}] websocketEvents count: ${step.websocketEvents?.length || 0}`);\r\n          console.log(`   \uD83E\uDD14 [${requestId}] updatedContext keys:`, Object.keys(updatedContext));\r\n          console.log(`   \uD83E\uDD14 [${requestId}] ========================================`);\r\n\r\n          // For decision steps, we don't execute actions yet - we broadcast the decision request\r\n          // CRITICAL: Ensure listings are in updatedContext before processing events\r\n          // This is needed for user_select_listing step which uses \"{{listings}}\" template\r\n          if (step.id === \"user_select_listing\" && (!updatedContext.listings || updatedContext.listings.length === 0)) {\r\n            // Try to get listings from llmResponse if available\r\n            if (updatedContext.llmResponse?.listings && Array.isArray(updatedContext.llmResponse.listings) && updatedContext.llmResponse.listings.length > 0) {\r\n              updatedContext.listings = updatedContext.llmResponse.listings;\r\n              console.log(`   \uD83D\uDD04 [${requestId}] Populated updatedContext.listings from llmResponse (${updatedContext.llmResponse.listings.length} listings)`);\r\n            } else {\r\n              console.warn(`   \u26A0\uFE0F [${requestId}] No listings found in updatedContext or llmResponse for user_select_listing step`);\r\n              console.warn(`   \u26A0\uFE0F [${requestId}] updatedContext keys:`, Object.keys(updatedContext));\r\n              console.warn(`   \u26A0\uFE0F [${requestId}] updatedContext.llmResponse:`, updatedContext.llmResponse ? Object.keys(updatedContext.llmResponse) : 'N/A');\r\n            }\r\n          }\r\n          \r\n          // Process WebSocket events for decision request\r\n          if (step.websocketEvents) {\r\n            for (const event of step.websocketEvents) {\r\n              const processedEvent = replaceTemplateVariables(event, updatedContext);\r\n              events.push(processedEvent);\r\n\r\n              // Add workflow and step identification to the event data\r\n              processedEvent.data = {\r\n                ...processedEvent.data,\r\n                workflowId: executionId,\r\n                stepId: step.id\r\n              };\r\n\r\n              // Special handling for user_select_listing - build options from listings\r\n              console.log(`   \uD83D\uDD0D [${requestId}] ========================================`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}] BUILDING OPTIONS FOR user_select_listing`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}] ========================================`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}] Step ID: ${step.id}`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}] Step ID matches \"user_select_listing\": ${step.id === \"user_select_listing\"}`);\r\n              \r\n              // DEBUG: Full context dump\r\n              console.log(`   \uD83D\uDD0D [${requestId}] FULL updatedContext DUMP:`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - updatedContext keys:`, Object.keys(updatedContext));\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - updatedContext.listings:`, updatedContext.listings);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - updatedContext.listings exists: ${!!updatedContext.listings}`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - updatedContext.listings type: ${typeof updatedContext.listings}`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - updatedContext.listings is array: ${Array.isArray(updatedContext.listings)}`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - updatedContext.listings length: ${updatedContext.listings?.length || 0}`);\r\n              if (updatedContext.listings && Array.isArray(updatedContext.listings) && updatedContext.listings.length > 0) {\r\n                console.log(`   \uD83D\uDD0D [${requestId}]   - First listing:`, JSON.stringify(updatedContext.listings[0], null, 2));\r\n              }\r\n              \r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - updatedContext.llmResponse:`, updatedContext.llmResponse ? 'EXISTS' : 'MISSING');\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - updatedContext.llmResponse?.listings:`, updatedContext.llmResponse?.listings);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - updatedContext.llmResponse?.listings length: ${updatedContext.llmResponse?.listings?.length || 0}`);\r\n              if (updatedContext.llmResponse?.listings && Array.isArray(updatedContext.llmResponse.listings) && updatedContext.llmResponse.listings.length > 0) {\r\n                console.log(`   \uD83D\uDD0D [${requestId}]   - First llmResponse listing:`, JSON.stringify(updatedContext.llmResponse.listings[0], null, 2));\r\n              }\r\n              \r\n              // DEBUG: What did template replacement return?\r\n              console.log(`   \uD83D\uDD0D [${requestId}] TEMPLATE REPLACEMENT RESULT:`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - Original event.data.options:`, event.data?.options);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - processedEvent.data.options:`, processedEvent.data?.options);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - processedEvent.data.options type:`, typeof processedEvent.data?.options);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - processedEvent.data.options is array:`, Array.isArray(processedEvent.data?.options));\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - processedEvent.data.options length: ${Array.isArray(processedEvent.data?.options) ? processedEvent.data.options.length : 'N/A'}`);\r\n              if (processedEvent.data?.options && Array.isArray(processedEvent.data.options) && processedEvent.data.options.length > 0) {\r\n                console.log(`   \uD83D\uDD0D [${requestId}]   - First option from template:`, JSON.stringify(processedEvent.data.options[0], null, 2));\r\n              }\r\n              console.log(`   \uD83D\uDD0D [${requestId}] ========================================`);\r\n              \r\n              // ALWAYS build options for user_select_listing if listings exist, even if template replacement already set it\r\n              // Check multiple sources: updatedContext.listings, llmResponse.listings, and processedEvent.data.options\r\n              // CRITICAL: llmResponse.listings might have the listings even if context.listings is empty\r\n              const listingsFromContext = updatedContext.listings;\r\n              const listingsFromLlmResponse = updatedContext.llmResponse?.listings;\r\n              const listingsFromEvent = Array.isArray(processedEvent.data?.options) ? processedEvent.data.options : null;\r\n              \r\n              // CRITICAL: Check if selectedListing2 contains listings or if we need to reconstruct from selectedListing2\r\n              // Sometimes listings might be stored differently or we need to use selectedListing2 to build options\r\n              let listingsFromSelectedListing2: any[] | null = null;\r\n              if (updatedContext.selectedListing2 && Array.isArray(updatedContext.selectedListing2)) {\r\n                // If selectedListing2 is an array, use it as listings\r\n                listingsFromSelectedListing2 = updatedContext.selectedListing2;\r\n                console.log(`   \uD83D\uDD0D [${requestId}] selectedListing2 is an array with ${listingsFromSelectedListing2.length} items`);\r\n              } else if (updatedContext.llmResponse?.selectedListing2 && Array.isArray(updatedContext.llmResponse.selectedListing2)) {\r\n                listingsFromSelectedListing2 = updatedContext.llmResponse.selectedListing2;\r\n                console.log(`   \uD83D\uDD0D [${requestId}] llmResponse.selectedListing2 is an array with ${listingsFromSelectedListing2.length} items`);\r\n              } else if (updatedContext.selectedListing2 || updatedContext.llmResponse?.selectedListing2) {\r\n                // If selectedListing2 is a single listing, create array with it\r\n                const singleListing = updatedContext.selectedListing2 || updatedContext.llmResponse?.selectedListing2;\r\n                listingsFromSelectedListing2 = [singleListing];\r\n                console.log(`   \uD83D\uDD0D [${requestId}] selectedListing2 is a single listing, creating array with 1 item`);\r\n              }\r\n              \r\n              // CRITICAL: If processedEvent.data.options is null (from template replacement), try to get from context\r\n              // This happens when \"{{listings}}\" template variable is not found\r\n              // IMPORTANT: Check array length, not just truthiness (empty arrays are truthy!)\r\n              let listingsSource: any[] | null = null;\r\n              \r\n              // Priority order: selectedListing2 first (if it's an array or can be converted), then context listings, then llmResponse listings, then event options\r\n              if (listingsFromSelectedListing2 && listingsFromSelectedListing2.length > 0) {\r\n                listingsSource = listingsFromSelectedListing2;\r\n                console.log(`   \u2705 [${requestId}] Using listingsFromSelectedListing2 (${listingsSource.length} items)`);\r\n              } else if (listingsFromContext && listingsFromContext.length > 0) {\r\n                listingsSource = listingsFromContext;\r\n                console.log(`   \u2705 [${requestId}] Using listingsFromContext (${listingsSource.length} items)`);\r\n              } else if (listingsFromLlmResponse && listingsFromLlmResponse.length > 0) {\r\n                listingsSource = listingsFromLlmResponse;\r\n                console.log(`   \u2705 [${requestId}] Using listingsFromLlmResponse (${listingsSource.length} items)`);\r\n              } else if (listingsFromEvent && listingsFromEvent.length > 0) {\r\n                listingsSource = listingsFromEvent;\r\n                console.log(`   \u2705 [${requestId}] Using listingsFromEvent (${listingsSource.length} items)`);\r\n              }\r\n              \r\n              // If still no listings, check if processedEvent.data.options was set to null by replaceTemplateVariables\r\n              // This means the template \"{{listings}}\" was not found in context\r\n              if (!listingsSource && processedEvent.data?.options === null) {\r\n                console.log(`   \u26A0\uFE0F [${requestId}] Template replacement returned null for \"{{listings}}\", checking context directly`);\r\n                // Try to get listings from any available source (checking length)\r\n                if (listingsFromSelectedListing2 && listingsFromSelectedListing2.length > 0) {\r\n                  listingsSource = listingsFromSelectedListing2;\r\n                  console.log(`   \u2705 [${requestId}] Fallback: Using listingsFromSelectedListing2 (${listingsSource.length} items)`);\r\n                } else if (updatedContext.listings && updatedContext.listings.length > 0) {\r\n                  listingsSource = updatedContext.listings;\r\n                  console.log(`   \u2705 [${requestId}] Fallback: Using updatedContext.listings (${listingsSource.length} items)`);\r\n                } else if (updatedContext.llmResponse?.listings && updatedContext.llmResponse.listings.length > 0) {\r\n                  listingsSource = updatedContext.llmResponse.listings;\r\n                  console.log(`   \u2705 [${requestId}] Fallback: Using updatedContext.llmResponse.listings (${listingsSource.length} items)`);\r\n                }\r\n              }\r\n              \r\n              console.log(`   \uD83D\uDD0D [${requestId}] Listing sources check:`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - updatedContext.listings: ${listingsFromContext?.length || 0} (${listingsFromContext ? 'EXISTS' : 'MISSING'})`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - updatedContext.llmResponse?.listings: ${listingsFromLlmResponse?.length || 0} (${listingsFromLlmResponse ? 'EXISTS' : 'MISSING'})`);\r\n              // ========================================\r\n              // ========================================\r\n              // CRITICAL DEBUG: selectedListing2 IN user_select_listing\r\n              // ========================================\r\n              // ========================================\r\n              console.log(`\\n\\n\\n`);\r\n              console.log(`\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557`);\r\n              console.log(`\u2551         \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D selectedListing2 IN user_select_listing DEBUG \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D              \u2551`);\r\n              console.log(`\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255D`);\r\n              console.log(`[${requestId}] ========================================`);\r\n              console.log(`[${requestId}] selectedListing2 IN user_select_listing STEP:`);\r\n              console.log(`[${requestId}]   - updatedContext.selectedListing2:`, updatedContext.selectedListing2 ? (Array.isArray(updatedContext.selectedListing2) ? `ARRAY[${updatedContext.selectedListing2.length}]` : 'OBJECT') : 'MISSING');\r\n              if (updatedContext.selectedListing2) {\r\n                console.log(`[${requestId}]   - updatedContext.selectedListing2 (FULL):`, JSON.stringify(updatedContext.selectedListing2, null, 2));\r\n              }\r\n              console.log(`[${requestId}]   - updatedContext.llmResponse?.selectedListing2:`, updatedContext.llmResponse?.selectedListing2 ? (Array.isArray(updatedContext.llmResponse.selectedListing2) ? `ARRAY[${updatedContext.llmResponse.selectedListing2.length}]` : 'OBJECT') : 'MISSING');\r\n              if (updatedContext.llmResponse?.selectedListing2) {\r\n                console.log(`[${requestId}]   - updatedContext.llmResponse.selectedListing2 (FULL):`, JSON.stringify(updatedContext.llmResponse.selectedListing2, null, 2));\r\n              }\r\n              console.log(`[${requestId}] ========================================`);\r\n              console.log(`\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557`);\r\n              console.log(`\u2551         \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D END selectedListing2 IN user_select_listing DEBUG \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D        \u2551`);\r\n              console.log(`\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255D`);\r\n              console.log(`\\n\\n\\n`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - listingsFromSelectedListing2: ${listingsFromSelectedListing2?.length || 0} (${listingsFromSelectedListing2 ? 'EXISTS' : 'MISSING'})`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - processedEvent.data.options: ${listingsFromEvent?.length || 0} (${listingsFromEvent ? 'EXISTS' : 'MISSING'})`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - processedEvent.data.options value:`, processedEvent.data?.options);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - Final listingsSource: ${listingsSource?.length || 0} (${listingsSource ? 'EXISTS' : 'MISSING'})`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - updatedContext keys:`, Object.keys(updatedContext));\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - updatedContext.llmResponse keys:`, updatedContext.llmResponse ? Object.keys(updatedContext.llmResponse) : 'N/A');\r\n              \r\n              // ========================================\r\n              // ========================================\r\n              // CRITICAL DEBUG: Which source was selected?\r\n              // ========================================\r\n              // ========================================\r\n              console.log(`\\n\\n\\n`);\r\n              console.log(`\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557`);\r\n              if (listingsSource === listingsFromSelectedListing2) {\r\n                console.log(`\u2551     \u2705\u2705\u2705 USING selectedListing2 AS LISTINGS SOURCE! \u2705\u2705\u2705                    \u2551`);\r\n                console.log(`\u2551     listingsSource === listingsFromSelectedListing2                             \u2551`);\r\n                console.log(`\u2551     listingsFromSelectedListing2 length: ${listingsFromSelectedListing2?.length || 0} \u2551`);\r\n              } else if (listingsSource === listingsFromContext) {\r\n                console.log(`\u2551     \u26A0\uFE0F Using listingsFromContext (NOT selectedListing2)                          \u2551`);\r\n                console.log(`\u2551     listingsFromContext length: ${listingsFromContext?.length || 0}              \u2551`);\r\n              } else if (listingsSource === listingsFromLlmResponse) {\r\n                console.log(`\u2551     \u26A0\uFE0F Using listingsFromLlmResponse (NOT selectedListing2)                     \u2551`);\r\n                console.log(`\u2551     listingsFromLlmResponse length: ${listingsFromLlmResponse?.length || 0}        \u2551`);\r\n              } else if (listingsSource === listingsFromEvent) {\r\n                console.log(`\u2551     \u26A0\uFE0F Using listingsFromEvent (NOT selectedListing2)                         \u2551`);\r\n                console.log(`\u2551     listingsFromEvent length: ${listingsFromEvent?.length || 0}                  \u2551`);\r\n              } else {\r\n                console.log(`\u2551     \u274C NO LISTINGS SOURCE SELECTED! listingsSource is null/undefined            \u2551`);\r\n              }\r\n              console.log(`\u2551     Final listingsSource length: ${listingsSource?.length || 0}                  \u2551`);\r\n              console.log(`\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255D`);\r\n              console.log(`\\n\\n\\n`);\r\n              \r\n              if (step.id === \"user_select_listing\" && listingsSource && Array.isArray(listingsSource) && listingsSource.length > 0) {\r\n                const selectServiceType = updatedContext.serviceType || serviceType || 'movie';\r\n                const selectFields = getServiceTypeFields(selectServiceType);\r\n                \r\n                console.log(`   \uD83D\uDCCB [${requestId}] \u2705 Building ${selectServiceType} selection options from ${listingsSource.length} listings`);\r\n                let sourceName = 'unknown';\r\n                if (listingsSource === listingsFromContext) sourceName = 'updatedContext.listings';\r\n                else if (listingsSource === listingsFromLlmResponse) sourceName = 'updatedContext.llmResponse.listings';\r\n                else if (listingsSource === listingsFromSelectedListing2) sourceName = 'selectedListing2 (array or single)';\r\n                else if (listingsSource === listingsFromEvent) sourceName = 'processedEvent.data.options';\r\n                console.log(`   \uD83D\uDCCB [${requestId}] \u2705 Using listings from: ${sourceName}`);\r\n                processedEvent.data.options = listingsSource.map((listing: any) => {\r\n                  // Build label dynamically based on service type\r\n                  let label = '';\r\n                  if (selectServiceType === 'movie') {\r\n                    label = `${listing.movieTitle || listing.name} at ${listing.showtime} - $${listing.price}`;\r\n                  } else if (selectServiceType === 'airline') {\r\n                    label = `${listing.flightNumber || listing.name} to ${listing.destination} on ${listing.date} - $${listing.price}`;\r\n                  } else {\r\n                    // Generic fallback\r\n                    const primary = listing[selectFields.primary] || listing.name;\r\n                    const time = listing[selectFields.time] || '';\r\n                    label = `${primary}${time ? ` - ${time}` : ''} - $${listing.price || listing[selectFields.price]}`;\r\n                  }\r\n                  \r\n                  return {\r\n                    value: listing.id,\r\n                    label: label,\r\n                    data: {\r\n                      // Include all listing fields dynamically\r\n                      ...listing,\r\n                      // Ensure key fields are present\r\n                      id: listing.id,\r\n                      price: listing.price || listing[selectFields.price],\r\n                      providerId: listing.providerId,\r\n                      providerName: listing.providerName || listing.provider\r\n                    }\r\n                  };\r\n                });\r\n                console.log(`   \uD83D\uDCCB [${requestId}] \u2705 Built ${processedEvent.data.options.length} selection options`);\r\n                console.log(`   \uD83D\uDCCB [${requestId}] First option:`, JSON.stringify(processedEvent.data.options[0], null, 2));\r\n              } else {\r\n                console.log(`   \u26A0\uFE0F [${requestId}] \u26A0\uFE0F NOT building options because:`);\r\n                if (step.id !== \"user_select_listing\") {\r\n                  console.log(`   \u26A0\uFE0F [${requestId}]   - Step ID \"${step.id}\" does not match \"user_select_listing\"`);\r\n                }\r\n                const listingsSource = updatedContext.listings || (Array.isArray(processedEvent.data?.options) ? processedEvent.data.options : null);\r\n                if (!listingsSource || !Array.isArray(listingsSource) || listingsSource.length === 0) {\r\n                  console.log(`   \u26A0\uFE0F [${requestId}]   - No listings found in updatedContext.listings or processedEvent.data.options`);\r\n                  console.log(`   \u26A0\uFE0F [${requestId}]   - updatedContext.listings:`, updatedContext.listings);\r\n                  console.log(`   \u26A0\uFE0F [${requestId}]   - processedEvent.data.options:`, processedEvent.data?.options);\r\n                  console.log(`   \u26A0\uFE0F [${requestId}]   - Available context keys:`, Object.keys(updatedContext));\r\n                }\r\n              }\r\n              \r\n              // Final check: Ensure options is an array before broadcasting\r\n              if (processedEvent.data?.options && !Array.isArray(processedEvent.data.options)) {\r\n                console.warn(`   \u26A0\uFE0F [${requestId}] \u26A0\uFE0F processedEvent.data.options is not an array! Converting...`);\r\n                console.warn(`   \u26A0\uFE0F [${requestId}] Current value:`, processedEvent.data.options);\r\n                console.warn(`   \u26A0\uFE0F [${requestId}] Type:`, typeof processedEvent.data.options);\r\n                processedEvent.data.options = [];\r\n              }\r\n\r\n              console.log(`   \uD83D\uDCE1 [${requestId}] Broadcasting decision event: ${event.type}`);\r\n              console.log(`   \uD83D\uDCE1 [${requestId}] Event structure:`, JSON.stringify(processedEvent, null, 2));\r\n              console.log(`   \uD83D\uDCE1 [${requestId}] Event data.options:`, processedEvent.data?.options);\r\n              console.log(`   \uD83D\uDCE1 [${requestId}] Event data.options count:`, processedEvent.data?.options?.length || 0);\r\n              try {\r\n                broadcastEvent(processedEvent);\r\n                console.log(`   \u2705 [${requestId}] Successfully broadcasted event: ${event.type}`);\r\n              } catch (broadcastError) {\r\n                console.warn(`   \u26A0\uFE0F [${requestId}] Failed to broadcast event: ${event.type}`, broadcastError);\r\n              }\r\n            }\r\n          }\r\n\r\n          // For decision steps, return early without nextStepId - execution pauses for user input\r\n          console.log(`   \u23F8\uFE0F [${requestId}] ========================================`);\r\n          console.log(`   \u23F8\uFE0F [${requestId}] STEP PAUSED FOR USER INTERACTION`);\r\n          console.log(`   \u23F8\uFE0F [${requestId}] Step ID: ${stepId}`);\r\n          console.log(`   \u23F8\uFE0F [${requestId}] Decision type: ${step.id.includes('select') ? 'selection' : 'decision'}`);\r\n          console.log(`   \u23F8\uFE0F [${requestId}] Events count: ${events.length}`);\r\n          console.log(`   \u23F8\uFE0F [${requestId}] Events summary:`, events.map(e => ({ \r\n            type: e.type, \r\n            hasOptions: !!e.data?.options, \r\n            optionsCount: Array.isArray(e.data?.options) ? e.data.options.length : 0,\r\n            optionsType: typeof e.data?.options\r\n          })));\r\n          if (events.length > 0) {\r\n            console.log(`   \u23F8\uFE0F [${requestId}] First event full structure:`, JSON.stringify(events[0], null, 2));\r\n          }\r\n          console.log(`   \u23F8\uFE0F [${requestId}] ========================================`);\r\n\r\n          sendResponse(200, {\r\n            success: true,\r\n            message: `Step ${stepId} paused for user interaction`,\r\n            result: {\r\n              stepId,\r\n              pausedForDecision: true,\r\n              decisionType: step.id.includes('select') ? 'selection' : 'decision',\r\n              events,\r\n              updatedContext\r\n            }\r\n          });\r\n          return;\r\n        }\r\n\r\n        console.log(`   \uD83D\uDCCB [${requestId}] Initial context has listings:`, !!updatedContext.listings);\r\n\r\n        // Process LLM actions (mocked)\r\n        if (step.actions) {\r\n          for (const action of step.actions) {\r\n            const processedAction = replaceTemplateVariables(action, updatedContext);\r\n            console.log(`   \uD83E\uDD16 [${requestId}] Processing action: ${action.type}`);\r\n\r\n            try {\r\n              let actionResult: any = {};\r\n              \r\n              // Log action type for debugging\r\n              console.log(`   \uD83D\uDD0D [${requestId}] Processing action type: \"${action.type}\"`);\r\n              \r\n              // Handle async actions (like movie watching)\r\n              if (action.type === 'start_movie_watching') {\r\n                // Process this action asynchronously\r\n                await processMovieWatchingAction(processedAction, updatedContext, broadcastEvent);\r\n                actionResult = { movieStarted: true, movieWatched: true };\r\n                executedActions.push({ type: action.type, result: actionResult });\r\n                continue; // Skip to next action\r\n              }\r\n\r\n              // CLONED formatResponseWithOpenAI function - MUST be defined BEFORE switch statement\r\n              // This ensures we have the exact function with hardcoded DEX mock data\r\n              async function formatResponseWithOpenAI_CLONED(\r\n                listings: MovieListing[] | TokenListing[],\r\n                userQuery: string,\r\n                queryFilters?: { maxPrice?: number | string; genre?: string; time?: string; location?: string; tokenSymbol?: string; baseToken?: string; action?: 'BUY' | 'SELL' }\r\n              ): Promise<LLMResponse> {\r\n                console.log(`\uD83D\uDD0D [LLM] ========================================`);\r\n                console.log(`\uD83D\uDD0D [LLM] formatResponseWithOpenAI_CLONED FUNCTION ENTRY - CLONED DIRECTLY IN EDEN-SIM-REDIS`);\r\n                console.log(`\uD83D\uDD0D [LLM] This is the CLONED function - NOT imported`);\r\n                console.log(`\uD83D\uDD0D [LLM] listings count: ${listings.length}`);\r\n                console.log(`\uD83D\uDD0D [LLM] userQuery: ${userQuery ? userQuery.substring(0, 100) : '(empty)'}`);\r\n                console.log(`\uD83D\uDD0D [LLM] queryFilters:`, JSON.stringify(queryFilters));\r\n                console.log(`\uD83D\uDD0D [LLM] ========================================`);\r\n                \r\n                // \uD83D\uDEA8 CRITICAL: Validate userQuery is not empty\r\n                if (!userQuery || userQuery.trim().length === 0) {\r\n                  const serviceType = queryFilters?.serviceType || 'movie';\r\n                  // Generate a fallback query based on service type and filters\r\n                  const fallbackQuery = serviceType === 'dex' \r\n                    ? `Find ${queryFilters?.tokenSymbol || 'TOKEN'} token trading options`\r\n                    : serviceType === 'movie'\r\n                    ? `Find ${queryFilters?.genre || ''} ${queryFilters?.time || ''} movies`.trim()\r\n                    : `Find ${serviceType} service options`;\r\n                  userQuery = fallbackQuery;\r\n                  console.warn(`\u26A0\uFE0F [LLM] userQuery was empty, using fallback: \"${userQuery}\"`);\r\n                }\r\n                \r\n                const listingsJson = JSON.stringify(listings);\r\n                const filtersJson = queryFilters ? JSON.stringify(queryFilters) : \"{}\";\r\n                const userMessage = `User query: ${userQuery}\\n\\nQuery filters: ${filtersJson}\\n\\nAvailable listings:\\n${listingsJson}\\n\\nFilter listings based on the query filters and format the best option as a user-friendly message.`;\r\n                \r\n                const messages = [\r\n                  { role: \"system\", content: LLM_RESPONSE_FORMATTING_PROMPT },\r\n                  { role: \"user\", content: userMessage },\r\n                ];\r\n                \r\n                const OPENAI_API_KEY = process.env.OPENAI_API_KEY || \"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\";\r\n                \r\n                const payloadObj = {\r\n                  model: \"gpt-4o\",\r\n                  messages,\r\n                  response_format: { type: \"json_object\" },\r\n                  temperature: 0.7,\r\n                };\r\n                \r\n                let payload: string;\r\n                try {\r\n                  payload = JSON.stringify(payloadObj);\r\n                  // Validate payload is valid JSON\r\n                  JSON.parse(payload);\r\n                } catch (err: any) {\r\n                  console.error(`\u274C [LLM] Failed to stringify payload:`, err);\r\n                  return Promise.reject(new Error(`Failed to create valid JSON payload: ${err.message}`));\r\n                }\r\n                \r\n                const payloadBuffer = Buffer.from(payload, 'utf8');\r\n                const contentLength = payloadBuffer.length;\r\n\r\n                return new Promise<LLMResponse>((resolve, reject) => {\r\n                  const req = https.request(\r\n                    {\r\n                      hostname: \"api.openai.com\",\r\n                      port: 443,\r\n                      path: \"/v1/chat/completions\",\r\n                      method: \"POST\",\r\n                      headers: {\r\n                        \"Content-Type\": \"application/json\",\r\n                        \"Authorization\": `Bearer ${OPENAI_API_KEY}`,\r\n                        \"Content-Length\": contentLength,\r\n                      },\r\n                    },\r\n                    (res) => {\r\n                      let data = \"\";\r\n                      res.on(\"data\", (c) => (data += c));\r\n                      res.on(\"end\", () => {\r\n                        console.log(`\uD83D\uDD0D [LLM] OpenAI response received, data length: ${data.length}`);\r\n                        try {\r\n                          const parsed = JSON.parse(data);\r\n                          console.log(`\uD83D\uDD0D [LLM] OpenAI response parsed successfully`);\r\n                          if (parsed.error) {\r\n                            reject(new Error(`OpenAI API error: ${parsed.error.message || JSON.stringify(parsed.error)}`));\r\n                            return;\r\n                          }\r\n                          if (parsed.choices && parsed.choices[0] && parsed.choices[0].message) {\r\n                            let content: any;\r\n                            try {\r\n                              const contentStr = parsed.choices[0].message.content;\r\n                              console.log(`\uD83D\uDD27 [LLM] Raw content from OpenAI: ${contentStr?.substring(0, 200)}...`);\r\n                              content = JSON.parse(contentStr);\r\n                              console.log(`\uD83D\uDD27 [LLM] Parsed content keys: ${Object.keys(content || {}).join(', ')}`);\r\n                              console.log(`\uD83D\uDD27 [LLM] content.selectedListing exists: ${!!content.selectedListing}, type: ${typeof content.selectedListing}`);\r\n                              console.log(`\uD83D\uDD27 [LLM] content.selectedListing2 exists: ${!!content.selectedListing2}, type: ${typeof content.selectedListing2}`);\r\n                              \r\n                              // ========================================\r\n                              // ========================================\r\n                              // CRITICAL DEBUG: Check if LLM returned selectedListing2\r\n                              // ========================================\r\n                              // ========================================\r\n                              console.log(`\\n\\n\\n`);\r\n                              console.log(`\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557`);\r\n                              console.log(`\u2551        \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D LLM RESPONSE selectedListing2 CHECK \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D                        \u2551`);\r\n                              console.log(`\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255D`);\r\n                              if (content.selectedListing2) {\r\n                                console.log(`\u2705\u2705\u2705 [LLM] LLM RETURNED selectedListing2! \u2705\u2705\u2705`);\r\n                                console.log(`[LLM] selectedListing2 (FULL):`, JSON.stringify(content.selectedListing2, null, 2));\r\n                              } else {\r\n                                console.log(`\u26A0\uFE0F\u26A0\uFE0F\u26A0\uFE0F [LLM] LLM did NOT return selectedListing2! \u26A0\uFE0F\u26A0\uFE0F\u26A0\uFE0F`);\r\n                                console.log(`[LLM] Will set it to selectedListing later.`);\r\n                              }\r\n                              console.log(`\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557`);\r\n                              console.log(`\u2551        \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D END LLM RESPONSE selectedListing2 CHECK \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D                   \u2551`);\r\n                              console.log(`\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255D`);\r\n                              console.log(`\\n\\n\\n`);\r\n                              \r\n                              // CRITICAL: Block \"Demo Service\" fallback - force use of actual listings\r\n                              if (content.selectedListing) {\r\n                                const isGenericDemo = (content.selectedListing as any)?.name === \"Demo Service\" || \r\n                                                     ((content.selectedListing as any)?.providerId === \"provider-001\" && \r\n                                                      !(content.selectedListing as any)?.poolId && \r\n                                                      !(content.selectedListing as any)?.movieTitle);\r\n                                \r\n                                if (isGenericDemo) {\r\n                                  console.warn(`\u26A0\uFE0F [LLM] BLOCKED generic \"Demo Service\" response from LLM`);\r\n                                  if (listings.length > 0) {\r\n                                    content.selectedListing = listings[0];\r\n                                    console.log(`\u2705 [LLM] Replaced LLM's \"Demo Service\" with first actual listing`);\r\n                                  } else {\r\n                                    content.selectedListing = null;\r\n                                  }\r\n                                }\r\n                              }\r\n                            } catch (parseError: any) {\r\n                              console.error(`\u274C [LLM] Failed to parse OpenAI content as JSON: ${parseError.message}`);\r\n                              content = { message: parsed.choices[0].message.content || \"Service found\", selectedListing: null };\r\n                            }\r\n                            \r\n                            // Process the content\r\n                            let selectedListing: MovieListing | TokenListing | null = content.selectedListing || (listings.length > 0 ? listings[0] : null);\r\n                            if (selectedListing) {\r\n                              const isTokenListing = 'poolId' in selectedListing || 'tokenSymbol' in selectedListing;\r\n                              \r\n                              if (isTokenListing) {\r\n                                const tokenListing = selectedListing as any;\r\n                                if (!tokenListing.poolId || !tokenListing.providerId) {\r\n                                  const matchedListing = listings.find((l: any) => \r\n                                    ('poolId' in l && l.poolId === tokenListing.poolId) ||\r\n                                    ('tokenSymbol' in l && l.tokenSymbol === tokenListing.tokenSymbol && l.baseToken === tokenListing.baseToken)\r\n                                  ) as TokenListing | undefined;\r\n                                  if (matchedListing) {\r\n                                    selectedListing = { ...matchedListing, ...tokenListing };\r\n                                    console.log(`\u2705 [LLM] Matched DEX pool listing by poolId/tokenSymbol`);\r\n                                  } else if (listings.length > 0) {\r\n                                    const firstListing = listings[0] as TokenListing;\r\n                                    selectedListing = { ...firstListing, ...tokenListing };\r\n                                    console.warn(`\u26A0\uFE0F [LLM] No DEX pool match found, using first listing`);\r\n                                  }\r\n                                }\r\n                              } else {\r\n                                if (!selectedListing.providerId) {\r\n                                  const matchedListing = listings.find((l: any) => \r\n                                    l.movieTitle === selectedListing.movieTitle && \r\n                                    l.providerName === selectedListing.providerName\r\n                                  );\r\n                                  if (matchedListing) {\r\n                                    selectedListing = { ...selectedListing, providerId: matchedListing.providerId };\r\n                                  } else if (listings.length > 0) {\r\n                                    selectedListing = { ...selectedListing, providerId: listings[0].providerId };\r\n                                  }\r\n                                }\r\n                              }\r\n                            }\r\n                            \r\n                            // CRITICAL: Use selectedListing2 from LLM response if available\r\n                            let selectedListing2: TokenListing | MovieListing | null = null;\r\n                            if (content.selectedListing2) {\r\n                              // LLM returned selectedListing2 - use it\r\n                              selectedListing2 = content.selectedListing2 as TokenListing | MovieListing;\r\n                              console.log(`\u2705 [LLM] Using selectedListing2 from LLM response`);\r\n                              \r\n                              // Validate and match selectedListing2 similar to selectedListing\r\n                              if (selectedListing2) {\r\n                                const isTokenListing2 = 'poolId' in selectedListing2 || 'tokenSymbol' in selectedListing2;\r\n                                \r\n                                if (isTokenListing2) {\r\n                                  const tokenListing2 = selectedListing2 as any;\r\n                                  if (!tokenListing2.poolId || !tokenListing2.providerId) {\r\n                                    const matchedListing2 = listings.find((l: any) => \r\n                                      ('poolId' in l && l.poolId === tokenListing2.poolId) ||\r\n                                      ('tokenSymbol' in l && l.tokenSymbol === tokenListing2.tokenSymbol && l.baseToken === tokenListing2.baseToken)\r\n                                    ) as TokenListing | undefined;\r\n                                    if (matchedListing2) {\r\n                                      selectedListing2 = { ...matchedListing2, ...tokenListing2 };\r\n                                      console.log(`\u2705 [LLM] Matched selectedListing2 DEX pool listing by poolId/tokenSymbol`);\r\n                                    }\r\n                                  }\r\n                                } else {\r\n                                  if (!selectedListing2.providerId) {\r\n                                    const matchedListing2 = listings.find((l: any) => \r\n                                      l.movieTitle === selectedListing2.movieTitle && \r\n                                      l.providerName === selectedListing2.providerName\r\n                                    );\r\n                                    if (matchedListing2) {\r\n                                      selectedListing2 = { ...selectedListing2, providerId: matchedListing2.providerId };\r\n                                    }\r\n                                  }\r\n                                }\r\n                              }\r\n                            } else {\r\n                              // LLM did not return selectedListing2 - use selectedListing as fallback\r\n                              console.warn(`\u26A0\uFE0F [LLM] LLM did not return selectedListing2, using selectedListing as selectedListing2`);\r\n                              \r\n                              // DEX query detection and hardcoded mock\r\n                              const isDEXQuery = listings.length > 0 && ('poolId' in listings[0] || 'tokenSymbol' in listings[0]);\r\n                              const filters = queryFilters || {};\r\n                              const isDEXFromFilters = filters?.tokenSymbol || filters?.baseToken;\r\n                              \r\n                              if (isDEXQuery || isDEXFromFilters) {\r\n                                console.log(`\uD83D\uDD27 [LLM] DEX QUERY DETECTED - USING FIRST LISTING`);\r\n                                if (listings.length > 0 && 'poolId' in listings[0]) {\r\n                                  selectedListing = listings[0] as TokenListing;\r\n                                  selectedListing2 = listings[0] as TokenListing;\r\n                                  console.log(`\uD83D\uDD27 [LLM] Using first actual DEX pool listing`);\r\n                                } else {\r\n                                  const mockDEXPool: TokenListing = {\r\n                                    poolId: 'pool-solana-tokena',\r\n                                    providerId: 'dex-pool-tokena',\r\n                                    providerName: 'DEX Pool Provider',\r\n                                    tokenSymbol: filters?.tokenSymbol || 'TOKENA',\r\n                                    tokenName: 'Token A',\r\n                                    baseToken: filters?.baseToken || 'SOL',\r\n                                    price: 1.5,\r\n                                    liquidity: 10000,\r\n                                    volume24h: 5000,\r\n                                    indexerId: 'T1'\r\n                                  };\r\n                                  selectedListing = mockDEXPool;\r\n                                  selectedListing2 = mockDEXPool;\r\n                                  console.log(`\uD83D\uDD27 [LLM] No listings available, using hardcoded mock DEX pool`);\r\n                                }\r\n                              } else {\r\n                                selectedListing2 = selectedListing;\r\n                              }\r\n                            }\r\n                            \r\n                            const result = {\r\n                              message: content.message || \"Service found\",\r\n                              listings: content.listings || listings,\r\n                              selectedListing: selectedListing,\r\n                              selectedListing2: selectedListing2,\r\n                              iGasCost: 0,\r\n                            };\r\n                            \r\n                            // Final validation\r\n                            if (!result.selectedListing && listings.length > 0) {\r\n                              result.selectedListing = listings[0];\r\n                              result.selectedListing2 = listings[0];\r\n                              console.warn(`\u26A0\uFE0F [LLM] FINAL SAFETY: Setting selectedListing to first listing`);\r\n                            }\r\n                            \r\n                            // CRITICAL: Ensure selectedListing2 is always set\r\n                            if (!result.selectedListing2 && result.selectedListing) {\r\n                              result.selectedListing2 = result.selectedListing;\r\n                              console.log(`\u2705 [LLM] Set selectedListing2 to selectedListing as final fallback`);\r\n                            }\r\n                            \r\n                            // ========================================\r\n                            // ========================================\r\n                            // CRITICAL DEBUG: selectedListing2 IN RESULT\r\n                            // ========================================\r\n                            // ========================================\r\n                            console.log(`\\n\\n\\n`);\r\n                            console.log(`\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557`);\r\n                            console.log(`\u2551              \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D FINAL RESULT selectedListing2 DEBUG \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D                 \u2551`);\r\n                            console.log(`\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255D`);\r\n                            console.log(`[LLM] ========================================`);\r\n                            console.log(`[LLM] FINAL RESULT selectedListing2:`);\r\n                            console.log(`[LLM]   - result.selectedListing2 exists: ${!!result.selectedListing2}`);\r\n                            console.log(`[LLM]   - result.selectedListing2 (FULL):`, JSON.stringify(result.selectedListing2, null, 2));\r\n                            console.log(`[LLM] ========================================`);\r\n                            console.log(`\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557`);\r\n                            console.log(`\u2551              \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D END FINAL RESULT selectedListing2 DEBUG \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D             \u2551`);\r\n                            console.log(`\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255D`);\r\n                            console.log(`\\n\\n\\n`);\r\n                            \r\n                            resolve(result);\r\n                          } else {\r\n                            reject(new Error(\"Invalid OpenAI response format\"));\r\n                          }\r\n                        } catch (err: any) {\r\n                          reject(new Error(`Failed to parse OpenAI response: ${err.message}`));\r\n                        }\r\n                      });\r\n                    }\r\n                  );\r\n                  \r\n                  req.on(\"error\", (err) => {\r\n                    reject(new Error(`OpenAI request failed: ${err.message}`));\r\n                  });\r\n                  req.write(payloadBuffer);\r\n                  req.end();\r\n                });\r\n              }\r\n\r\n              switch (action.type) {\r\n                case 'validate':\r\n                  actionResult = {\r\n                    validationPassed: true,\r\n                    errors: [],\r\n                    input: updatedContext.input,\r\n                    email: updatedContext.email\r\n                  };\r\n                  break;\r\n\r\n                case 'eden_chat_init': {\r\n                  // Eden Chat init is a lightweight context seeding step used by many workflows (movie/airline/etc).\r\n                  // It must never fail; its purpose is to ensure edenChatSession + user/serviceType are present.\r\n                  const resolvedServiceType =\r\n                    processedAction.serviceType ||\r\n                    updatedContext.serviceType ||\r\n                    updatedContext.queryResult?.serviceType ||\r\n                    serviceType ||\r\n                    'movie';\r\n\r\n                  const resolvedEmail =\r\n                    updatedContext.email ||\r\n                    updatedContext.user?.email ||\r\n                    processedAction.email ||\r\n                    processedAction.userEmail ||\r\n                    'unknown@example.com';\r\n\r\n                  if (!updatedContext.user) {\r\n                    updatedContext.user = { email: resolvedEmail, id: resolvedEmail };\r\n                  } else if (!updatedContext.user.email) {\r\n                    updatedContext.user.email = resolvedEmail;\r\n                  }\r\n\r\n                  // Preserve existing session if provided by frontend; otherwise create one.\r\n                  const existingSession = (updatedContext as any).edenChatSession;\r\n                  const edenChatSession = existingSession && typeof existingSession === 'object'\r\n                    ? {\r\n                        sessionId: existingSession.sessionId || `session_${Date.now()}`,\r\n                        serviceType: existingSession.serviceType || resolvedServiceType,\r\n                        startTime: existingSession.startTime || Date.now(),\r\n                      }\r\n                    : {\r\n                        sessionId: `session_${Date.now()}`,\r\n                        serviceType: resolvedServiceType,\r\n                        startTime: Date.now(),\r\n                      };\r\n\r\n                  updatedContext.serviceType = resolvedServiceType;\r\n                  (updatedContext as any).edenChatSession = edenChatSession;\r\n\r\n                  actionResult = {\r\n                    edenChatSession,\r\n                    chatInitialized: true,\r\n                    serviceType: resolvedServiceType,\r\n                  };\r\n                  break;\r\n                }\r\n\r\n                case 'create_snapshot':\r\n                  console.log(`\uD83D\uDCF8 [${requestId}] Creating transaction snapshot`);\r\n                  try {\r\n                    const currentServiceType = updatedContext.serviceType || serviceType || 'movie';\r\n                    const listingPrice = updatedContext.selectedListing?.price || 0;\r\n                    // Prefer explicit amount from action; for DEX, fall back to trade.baseAmount when present.\r\n                    const dexTradeBaseAmount = (updatedContext as any)?.trade?.baseAmount;\r\n                    const rawActionAmount = processedAction.amount;\r\n                    const parsedActionAmount = typeof rawActionAmount === 'string' ? parseFloat(rawActionAmount) : rawActionAmount;\r\n                    const snapshotAmount = (parsedActionAmount ?? (currentServiceType === 'dex' ? dexTradeBaseAmount : undefined)) || \r\n                                          updatedContext.moviePrice || \r\n                                          updatedContext.hotelPrice || \r\n                                          updatedContext.restaurantPrice ||\r\n                                          updatedContext.grocerystorePrice ||\r\n                                          updatedContext.pharmacyPrice ||\r\n                                          updatedContext.dogparkPrice ||\r\n                                          updatedContext.gasstationPrice ||\r\n                                          updatedContext.partyPrice ||\r\n                                          updatedContext.bankPrice ||\r\n                                          updatedContext.totalCost ||\r\n                                          listingPrice || \r\n                                          0;\r\n                    \r\n                    // CRITICAL: Always use user email from context as payer\r\n                    // Priority: updatedContext.user?.email > processedAction.payer > fallback\r\n                    const userEmail = updatedContext.user?.email || processedAction.payer || 'unknown@example.com';\r\n                    if (!updatedContext.user?.email && processedAction.payer) {\r\n                      console.log(`\uD83D\uDCE7 [${requestId}] Using processedAction.payer (${processedAction.payer}) as user email is not in context`);\r\n                    }\r\n                    \r\n                    const snapshot = {\r\n                      txId: `tx_${Date.now()}`,\r\n                      blockTime: Date.now(),\r\n                      payer: userEmail, // Always use user email from context\r\n                      amount: snapshotAmount,\r\n                      feeSplit: {\r\n                        indexer: 0,\r\n                        cashier: 0.1,\r\n                        provider: snapshotAmount * 0.05,\r\n                        eden: snapshotAmount * 0.02\r\n                      }\r\n                    };\r\n                    \r\n                    console.log(`\uD83D\uDCE7 [${requestId}] Snapshot created with payer email: ${userEmail}`);\r\n                    actionResult = { snapshot };\r\n                    // CRITICAL: Store snapshot in context for next actions and websocket events\r\n                    updatedContext.snapshot = snapshot;\r\n                    // Also ensure iGasCost is in context (ALWAYS normalize to number)\r\n                    const rawIGas = (updatedContext as any).iGasCost;\r\n                    const normalizedIGas =\r\n                      rawIGas === undefined || rawIGas === null\r\n                        ? 0.00445\r\n                        : (typeof rawIGas === 'string' ? parseFloat(rawIGas) : Number(rawIGas));\r\n                    (updatedContext as any).iGasCost = !isNaN(normalizedIGas) ? normalizedIGas : 0.00445;\r\n\r\n                    // Emit an iGas event for UI \"Current iGas\" display (workflows don't use the old resolveLLM path)\r\n                    try {\r\n                      let totalIGasForUI: number | undefined = undefined;\r\n                      try {\r\n                        const { getAccountantState } = await import(\"./src/accountant\");\r\n                        totalIGasForUI = getAccountantState()?.totalIGas;\r\n                      } catch (e: any) {\r\n                        // ignore and just send current iGas\r\n                      }\r\n\r\n                      const currentIGasForUI =\r\n                        typeof (updatedContext as any).iGasCost === 'number'\r\n                          ? (updatedContext as any).iGasCost\r\n                          : parseFloat(String((updatedContext as any).iGasCost || 0));\r\n\r\n                      broadcastEvent({\r\n                        type: \"igas\",\r\n                        component: \"igas\",\r\n                        message: `iGas Cost: ${(currentIGasForUI || 0).toFixed(6)}`,\r\n                        timestamp: Date.now(),\r\n                        data: {\r\n                          igas: currentIGasForUI || 0,\r\n                          ...(totalIGasForUI !== undefined ? { totalIGas: totalIGasForUI } : {})\r\n                        }\r\n                      });\r\n                    } catch (e: any) {\r\n                      console.warn(`\u26A0\uFE0F  [${requestId}] Failed to broadcast igas event: ${e.message}`);\r\n                    }\r\n                    // Set service-type-specific price in context for template variables\r\n                    if (currentServiceType === 'movie') {\r\n                      updatedContext.moviePrice = listingPrice || snapshotAmount;\r\n                    } else if (currentServiceType === 'hotel') {\r\n                      updatedContext.hotelPrice = listingPrice || snapshotAmount;\r\n                    } else if (currentServiceType === 'airline') {\r\n                      updatedContext.airlinePrice = listingPrice || snapshotAmount;\r\n                    } else if (currentServiceType === 'restaurant') {\r\n                      updatedContext.restaurantPrice = listingPrice || snapshotAmount;\r\n                    } else if (currentServiceType === 'grocerystore') {\r\n                      updatedContext.grocerystorePrice = listingPrice || snapshotAmount;\r\n                    } else if (currentServiceType === 'pharmacy') {\r\n                      updatedContext.pharmacyPrice = listingPrice || snapshotAmount;\r\n                    } else if (currentServiceType === 'dogpark') {\r\n                      updatedContext.dogparkPrice = listingPrice || snapshotAmount;\r\n                    } else if (currentServiceType === 'gasstation') {\r\n                      updatedContext.gasstationPrice = listingPrice || snapshotAmount;\r\n                    } else if (currentServiceType === 'party') {\r\n                      updatedContext.partyPrice = listingPrice || snapshotAmount;\r\n                    } else if (currentServiceType === 'bank') {\r\n                      updatedContext.bankPrice = listingPrice || snapshotAmount;\r\n                    }\r\n                    // Also set generic totalCost for backward compatibility\r\n                    updatedContext.totalCost = listingPrice || snapshotAmount;\r\n                    \r\n                    console.log(`\uD83D\uDCF8 [${requestId}] Snapshot created:`, {\r\n                      txId: snapshot.txId,\r\n                      payer: snapshot.payer,\r\n                      amount: snapshot.amount,\r\n                      serviceType: currentServiceType\r\n                    });\r\n                    console.log(`\uD83D\uDCF8 [${requestId}] Context now has: snapshot=${!!updatedContext.snapshot}, iGasCost=${updatedContext.iGasCost}, price=${listingPrice || snapshotAmount}`);\r\n                  } catch (snapshotError) {\r\n                    console.error(`\u274C [${requestId}] Error creating snapshot:`, snapshotError);\r\n                    actionResult = { error: snapshotError.message };\r\n                  }\r\n                  break;\r\n\r\n                case 'persist_snapshot': {\r\n                  console.log(`\uD83D\uDCBE [${requestId}] Persisting transaction snapshot`);\r\n                  const snapshotToPersist =\r\n                    processedAction.snapshot ||\r\n                    updatedContext.snapshot ||\r\n                    actionResult?.snapshot;\r\n\r\n                  if (!snapshotToPersist) {\r\n                    throw new Error(`persist_snapshot requires snapshot in action or context`);\r\n                  }\r\n\r\n                  await persistSnapshot(snapshotToPersist);\r\n\r\n                  actionResult = { snapshotPersisted: true, snapshot: snapshotToPersist };\r\n                  // Keep snapshot on context for later steps + templates\r\n                  updatedContext.snapshot = snapshotToPersist;\r\n                  updatedContext.snapshotPersisted = true;\r\n                  console.log(`\u2705 [${requestId}] Snapshot persisted: ${snapshotToPersist.txId || snapshotToPersist.id || 'unknown'}`);\r\n                  break;\r\n                }\r\n\r\n                case 'stream_to_indexers': {\r\n                  console.log(`\uD83D\uDCE1 [${requestId}] Streaming snapshot to indexers`);\r\n                  const snapshotToStream =\r\n                    processedAction.snapshot ||\r\n                    updatedContext.snapshot ||\r\n                    actionResult?.snapshot;\r\n\r\n                  if (!snapshotToStream) {\r\n                    throw new Error(`stream_to_indexers requires snapshot in action or context`);\r\n                  }\r\n\r\n                  await streamToIndexers(snapshotToStream);\r\n\r\n                  actionResult = { streamed: true, snapshot: snapshotToStream };\r\n                  updatedContext.snapshot = snapshotToStream;\r\n                  updatedContext.streamedToIndexers = true;\r\n                  console.log(`\u2705 [${requestId}] Streamed snapshot: ${snapshotToStream.txId || snapshotToStream.id || 'unknown'}`);\r\n                  break;\r\n                }\r\n\r\n                case 'deliver_webhook': {\r\n                  // NOTE: DEX workflows should NOT deliver webhooks (user requested).\r\n                  // We still support this action for other service types, but it is a no-op for DEX.\r\n                  const currentServiceType = (updatedContext.serviceType || serviceType || '').toString().toLowerCase();\r\n                  if (currentServiceType === 'dex') {\r\n                    console.log(`\uD83D\uDEAB [${requestId}] deliver_webhook skipped for DEX workflow`);\r\n                    actionResult = { webhookDelivered: false, skipped: true, reason: 'DEX workflow does not use webhooks' };\r\n                    break;\r\n                  }\r\n\r\n                  const providerId = processedAction.providerId || updatedContext.selectedListing?.providerId;\r\n                  const snapshot = processedAction.snapshot || updatedContext.snapshot;\r\n                  const ledgerEntry = processedAction.ledgerEntry || updatedContext.ledgerEntry;\r\n\r\n                  if (!providerId || !snapshot || !ledgerEntry) {\r\n                    throw new Error(`deliver_webhook requires providerId, snapshot, and ledgerEntry`);\r\n                  }\r\n\r\n                  await deliverWebhook(providerId, snapshot, ledgerEntry);\r\n                  actionResult = { webhookDelivered: true, providerId };\r\n                  break;\r\n                }\r\n\r\n                case 'validate_certificate':\r\n                  console.log(`\uD83D\uDD10 [${requestId}] Validating certificate for provider:`, processedAction.providerUuid || updatedContext.selectedListing?.providerId);\r\n                  // For now, always pass certificate validation in mock mode\r\n                  actionResult = {\r\n                    certificateValid: true,\r\n                    providerUuid: processedAction.providerUuid || updatedContext.selectedListing?.providerId,\r\n                    validationTimestamp: Date.now()\r\n                  };\r\n                  console.log(`\uD83D\uDD10 [${requestId}] Certificate validation passed`);\r\n                  break;\r\n\r\n                case 'llm_extract_query':\r\n                  // Extract query using LLM (FULLY AUTOMATED)\r\n                  const userInputForExtraction = processedAction.input || updatedContext.input || updatedContext.userInput || '';\r\n                  console.log(`   \uD83D\uDD0D [${requestId}] llm_extract_query: Extracting query from input: \"${userInputForExtraction.substring(0, 100)}...\"`);\r\n                  \r\n                  let queryResult: LLMQueryResult;\r\n                  const forcedServiceType = processedAction.serviceType || updatedContext.serviceType || serviceType || 'movie';\r\n                  \r\n                  if (MOCKED_LLM) {\r\n                    // Mock extraction for testing\r\n                    const extractServiceType = processedAction.serviceType || updatedContext.serviceType || serviceType || 'movie';\r\n                    console.log(`   \uD83D\uDD0D [${requestId}] llm_extract_query: Using MOCKED_LLM with serviceType: ${extractServiceType}`);\r\n                    queryResult = {\r\n                      serviceType: extractServiceType,\r\n                      query: {\r\n                        filters: extractServiceType === 'movie' ? {\r\n                          genre: 'sci-fi',\r\n                          time: 'evening'\r\n                        } : extractServiceType === 'airline' ? {\r\n                          destination: 'any',\r\n                          date: 'any'\r\n                        } : extractServiceType === 'dex' ? {\r\n                          tokenSymbol: 'TOKENA',\r\n                          baseToken: 'SOL',\r\n                          action: 'BUY',\r\n                          tokenAmount: 1\r\n                        } : {}\r\n                      }\r\n                    };\r\n                  } else {\r\n                    // Use actual LLM extraction\r\n                    const extractFn = ENABLE_OPENAI ? extractQueryWithOpenAI : extractQueryWithDeepSeek;\r\n                    console.log(`   \uD83D\uDD0D [${requestId}] llm_extract_query: Using ${ENABLE_OPENAI ? 'OpenAI' : 'DeepSeek'} for extraction`);\r\n                    queryResult = await extractFn(userInputForExtraction);\r\n                    console.log(`   \u2705 [${requestId}] llm_extract_query: Extracted query result:`, JSON.stringify(queryResult, null, 2));\r\n                  }\r\n                  \r\n                  // IMPORTANT:\r\n                  // Our query extractor prompt currently focuses on movie/dex.\r\n                  // For non-movie/non-dex workflows (pharmacy/airline/etc), do NOT let extraction overwrite the workflow's serviceType.\r\n                  if (forcedServiceType && forcedServiceType !== 'movie' && forcedServiceType !== 'dex') {\r\n                    (queryResult as any).serviceType = forcedServiceType;\r\n                    (queryResult as any).query = (queryResult as any).query || { serviceType: forcedServiceType, filters: {} };\r\n                    (queryResult as any).query.serviceType = forcedServiceType;\r\n                    (queryResult as any).query.filters = (queryResult as any).query.filters || {};\r\n                    updatedContext.serviceType = forcedServiceType;\r\n                  } else {\r\n                    // movie/dex: keep extractor classification, but normalize shape\r\n                    (queryResult as any).serviceType = (queryResult as any).serviceType || forcedServiceType;\r\n                    (queryResult as any).query = (queryResult as any).query || { serviceType: (queryResult as any).serviceType, filters: {} };\r\n                    (queryResult as any).query.serviceType = (queryResult as any).query.serviceType || (queryResult as any).serviceType;\r\n                    (queryResult as any).query.filters = (queryResult as any).query.filters || {};\r\n                    updatedContext.serviceType = (queryResult as any).serviceType;\r\n                  }\r\n                  \r\n                  // Set queryResult in context (after normalization)\r\n                  updatedContext.queryResult = queryResult;\r\n                  \r\n                  // CRITICAL: Extract action, tokenAmount, and baseAmount from queryResult.query.filters for DEX trades\r\n                  // These need to be top-level context variables for the workflow outputs\r\n                  if (queryResult.serviceType === 'dex' && queryResult.query.filters) {\r\n                    const filters = queryResult.query.filters;\r\n                    updatedContext.action = filters.action || 'BUY';\r\n                    updatedContext.tokenAmount = filters.tokenAmount;\r\n                    updatedContext.baseAmount = filters.baseAmount; // Support baseAmount (e.g., \"Trade 2 SOL with TOKEN\")\r\n                    updatedContext.tokenSymbol = filters.tokenSymbol;\r\n                    updatedContext.baseToken = filters.baseToken;\r\n                    \r\n                    console.log(`   \uD83D\uDD0D [${requestId}] llm_extract_query: Extracted DEX trade parameters:`);\r\n                    console.log(`      action: ${updatedContext.action}`);\r\n                    console.log(`      tokenAmount: ${updatedContext.tokenAmount || 'not specified'}`);\r\n                    console.log(`      baseAmount: ${updatedContext.baseAmount || 'not specified'}`);\r\n                    console.log(`      tokenSymbol: ${updatedContext.tokenSymbol}`);\r\n                    console.log(`      baseToken: ${updatedContext.baseToken}`);\r\n                  }\r\n                  \r\n                  actionResult = {\r\n                    queryResult: queryResult\r\n                  };\r\n                  break;\r\n\r\n\r\n                case 'query_dex_pools': {\r\n                  // Query DEX pools (FULLY AUTOMATED)\r\n                  // Pattern: Query service registry for DEX providers, then query their pools\r\n                  // This matches the pattern used in resolveLLM() in eden-sim-redis.ts\r\n                  if (!updatedContext.queryResult) {\r\n                    throw new Error(\"Query result required for DEX pool query\");\r\n                  }\r\n                  \r\n                  console.log(`\uD83D\uDD0D [${requestId}] Querying DEX pools...`);\r\n                  console.log(`\uD83D\uDD0D [${requestId}] Query filters:`, updatedContext.queryResult.query.filters);\r\n                  \r\n                  // Step 1: Query service registry for DEX providers\r\n                  const dexProviders = queryROOTCAServiceRegistry({\r\n                    serviceType: \"dex\",\r\n                    filters: {}\r\n                  });\r\n                  \r\n                  console.log(`\uD83D\uDD0D [${requestId}] Found ${dexProviders.length} DEX provider(s) in service registry`);\r\n                  \r\n                  if (dexProviders.length === 0) {\r\n                    console.warn(`\u26A0\uFE0F [${requestId}] No DEX providers found in service registry`);\r\n                    updatedContext.listings = [];\r\n                    actionResult = { listings: [] };\r\n                    break;\r\n                  }\r\n                  \r\n                  // Step 2: Query all DEX providers' pools using queryServiceProviders\r\n                  // This internally calls queryProviderAPI -> queryDEXPoolAPI for each provider\r\n                  const filters = {\r\n                    tokenSymbol: updatedContext.queryResult.query.filters?.tokenSymbol,\r\n                    baseToken: updatedContext.queryResult.query.filters?.baseToken,\r\n                    action: updatedContext.queryResult.query.filters?.action\r\n                  };\r\n                  \r\n                  console.log(`\uD83D\uDD0D [${requestId}] Querying ${dexProviders.length} DEX provider(s) with filters:`, filters);\r\n                  \r\n                  const dexListings = await queryServiceProviders(\r\n                    dexProviders,\r\n                    filters\r\n                  ) as TokenListing[];\r\n                  \r\n                  console.log(`\u2705 [${requestId}] Found ${dexListings.length} DEX pool listing(s) from ${dexProviders.length} provider(s)`);\r\n                  \r\n                  updatedContext.listings = dexListings;\r\n                  actionResult = { listings: dexListings };\r\n                  break;\r\n                }\r\n\r\n                case 'query_service_registry': {\r\n                  // Get serviceType from action, context, or workflow\r\n                  const queryServiceType = processedAction.serviceType || updatedContext.serviceType || updatedContext.queryResult?.serviceType || serviceType || 'movie';\r\n                  console.log(`   \uD83D\uDD0D [${requestId}] query_service_registry: Querying for serviceType: ${queryServiceType}`);\r\n                  \r\n                  // Query actual service registry\r\n                  const serviceRegistry2 = getServiceRegistry2();\r\n                  const providers = serviceRegistry2.queryProviders(queryServiceType, processedAction.filters || updatedContext.queryResult?.query?.filters || {});\r\n                  \r\n                  console.log(`   \uD83D\uDCCB [${requestId}] Found ${providers.length} providers for serviceType: ${queryServiceType}`);\r\n                  \r\n                  // CRITICAL: Query actual provider APIs (including MySQL plugin providers)\r\n                  // This will use queryServiceProviders -> queryProviderAPI -> MySQL plugin if apiEndpoint is \"eden:plugin:mysql\"\r\n                  const filters = processedAction.filters || updatedContext.queryResult?.query?.filters || {};\r\n                  \r\n                  // If there's a raw user query, pass it through for ROOT CA LLM extraction\r\n                  if (updatedContext.input || updatedContext.userInput) {\r\n                    (filters as any).rawQuery = updatedContext.input || updatedContext.userInput;\r\n                  }\r\n                  \r\n                  let listings: any[] = [];\r\n                  if (providers.length > 0) {\r\n                    console.log(`   \uD83D\uDD0D [${requestId}] Querying ${providers.length} provider(s) with filters:`, filters);\r\n                    try {\r\n                      listings = await queryServiceProviders(providers, filters) as any[];\r\n                      console.log(`   \u2705 [${requestId}] Retrieved ${listings.length} listing(s) from provider APIs (including plugin providers)`);\r\n                    } catch (queryErr: any) {\r\n                      console.error(`   \u274C [${requestId}] Failed to query providers:`, queryErr.message);\r\n                      listings = []; // Fallback to empty array\r\n                    }\r\n                  } else {\r\n                    console.log(`   \u26A0\uFE0F  [${requestId}] No providers found for serviceType: ${queryServiceType}, generating fallback mock listings`);\r\n                    // Fallback to mock listings if no providers exist\r\n                    const queryFields = getServiceTypeFields(queryServiceType);\r\n                    const mockListings = Array.from({ length: 3 }, (_, index) => {\r\n                      const provider = { id: `mock-${index}`, name: `Mock Provider ${index + 1}`, serviceType: queryServiceType, location: 'Unknown' };\r\n                    const baseListing: any = {\r\n                      id: provider.id,\r\n                      name: provider.name,\r\n                      serviceType: queryServiceType,\r\n                      location: provider.location,\r\n                      providerId: provider.id,\r\n                      providerName: provider.name,\r\n                      price: 15.99 + (index * 2.5), // Vary prices\r\n                      rating: 4.5 + (Math.random() * 0.5), // Random rating between 4.5-5.0\r\n                    };\r\n                    \r\n                  // Add service-type-specific fields\r\n                  if (queryServiceType === 'movie') {\r\n                    baseListing.movieTitle = ['The Dark Knight', 'Inception', 'Avatar', 'Interstellar', 'The Matrix'][index % 5];\r\n                    baseListing.showtime = ['7:00 PM', '8:30 PM', '6:15 PM', '9:00 PM', '5:30 PM'][index % 5];\r\n                    baseListing.genre = ['Action', 'Sci-Fi', 'Adventure', 'Thriller', 'Drama'][index % 5];\r\n                    baseListing.duration = '152 min';\r\n                    baseListing.format = ['IMAX', '3D', '4DX', 'Standard', 'Premium'][index % 5];\r\n                  } else if (queryServiceType === 'airline') {\r\n                    baseListing.flightNumber = ['AA123', 'UA456', 'DL789', 'SW012', 'JB345'][index % 5];\r\n                    baseListing.destination = ['Los Angeles', 'New York', 'Chicago', 'Miami', 'Seattle'][index % 5];\r\n                    baseListing.date = ['2026-01-20', '2026-01-21', '2026-01-22', '2026-01-23', '2026-01-24'][index % 5];\r\n                    baseListing.departure = ['8:00 AM', '10:30 AM', '2:00 PM', '6:00 PM', '9:30 PM'][index % 5];\r\n                    baseListing.arrival = ['11:00 AM', '1:30 PM', '5:00 PM', '9:00 PM', '12:30 AM'][index % 5];\r\n                  } else if (queryServiceType === 'autoparts') {\r\n                    baseListing.partName = ['Brake Pads', 'Oil Filter', 'Air Filter', 'Spark Plugs', 'Battery'][index % 5];\r\n                    baseListing.partNumber = [`BP-${1000 + index}`, `OF-${2000 + index}`, `AF-${3000 + index}`, `SP-${4000 + index}`, `BAT-${5000 + index}`][index % 5];\r\n                    baseListing.category = ['Brakes', 'Filters', 'Filters', 'Ignition', 'Electrical'][index % 5];\r\n                    baseListing.warehouse = ['Warehouse A', 'Warehouse B', 'Warehouse C', 'Warehouse D', 'Warehouse E'][index % 5];\r\n                    baseListing.availability = ['In Stock', 'In Stock', 'Low Stock', 'In Stock', 'In Stock'][index % 5];\r\n                  } else if (queryServiceType === 'hotel') {\r\n                    baseListing.hotelName = ['Grand Plaza Hotel', 'Oceanview Resort', 'City Center Inn', 'Mountain Lodge', 'Beachside Suites'][index % 5];\r\n                    baseListing.checkIn = ['2026-01-20', '2026-01-21', '2026-01-22', '2026-01-23', '2026-01-24'][index % 5];\r\n                    baseListing.checkOut = ['2026-01-22', '2026-01-23', '2026-01-24', '2026-01-25', '2026-01-26'][index % 5];\r\n                    baseListing.roomType = ['Standard', 'Deluxe', 'Suite', 'Executive', 'Presidential'][index % 5];\r\n                    baseListing.location = ['Downtown', 'Beachfront', 'City Center', 'Airport', 'Resort Area'][index % 5];\r\n                  } else if (queryServiceType === 'restaurant') {\r\n                    baseListing.restaurantName = ['The Gourmet Bistro', 'Seaside Grill', 'Mountain View Restaurant', 'Downtown Diner', 'Garden Cafe'][index % 5];\r\n                    baseListing.reservationTime = ['7:00 PM', '8:00 PM', '6:30 PM', '7:30 PM', '8:30 PM'][index % 5];\r\n                    baseListing.cuisine = ['Italian', 'French', 'Asian Fusion', 'American', 'Mediterranean'][index % 5];\r\n                    baseListing.partySize = [2, 4, 2, 6, 4][index % 5];\r\n                    baseListing.location = ['Downtown', 'Waterfront', 'Uptown', 'Historic District', 'Shopping District'][index % 5];\r\n                  } else if (queryServiceType === 'grocerystore') {\r\n                    baseListing.grocerystoreName = ['Fresh Market', 'Super Grocer', 'Neighborhood Market', 'City Grocery', 'Green Valley Store'][index % 5];\r\n                    baseListing.storeType = ['Supermarket', 'Grocery Store', 'Convenience Store', 'Organic Market', 'Discount Store'][index % 5];\r\n                    baseListing.department = ['Produce', 'Dairy', 'Meat', 'Bakery', 'Frozen'][index % 5];\r\n                    baseListing.location = ['Downtown', 'Suburban', 'City Center', 'Shopping Plaza', 'Neighborhood'][index % 5];\r\n                    baseListing.hours = ['8 AM - 9 PM', '7 AM - 10 PM', '6 AM - 11 PM', '24 Hours', '9 AM - 8 PM'][index % 5];\r\n                  } else if (queryServiceType === 'pharmacy') {\r\n                    baseListing.pharmacyName = ['Health Pharmacy', 'Community Drug Store', 'Wellness Pharmacy', 'Family Pharmacy', 'Care Pharmacy'][index % 5];\r\n                    baseListing.pharmacyType = ['Retail Pharmacy', 'Chain Pharmacy', 'Independent Pharmacy', 'Hospital Pharmacy', 'Compounding Pharmacy'][index % 5];\r\n                    baseListing.services = ['Prescriptions', 'Over-the-counter', 'Health Consultations', 'Vaccinations', 'Medical Supplies'][index % 5];\r\n                    baseListing.location = ['Downtown', 'Medical District', 'Shopping Center', 'Hospital Area', 'Residential'][index % 5];\r\n                    baseListing.hours = ['9 AM - 6 PM', '8 AM - 8 PM', '24 Hours', '9 AM - 9 PM', '7 AM - 7 PM'][index % 5];\r\n                  } else if (queryServiceType === 'dogpark') {\r\n                    baseListing.dogparkName = ['Happy Tails Park', 'Paws & Play Park', 'Canine Commons', 'Dogwood Park', 'Bark & Run Park'][index % 5];\r\n                    baseListing.parkType = ['Off-Leash Park', 'Fenced Park', 'Community Park', 'Private Park', 'Dog Run'][index % 5];\r\n                    baseListing.amenities = ['Water Fountains', 'Agility Equipment', 'Separate Small Dog Area', 'Waste Stations', 'Shaded Areas'][index % 5];\r\n                    baseListing.location = ['Downtown', 'Residential', 'Suburban', 'Park District', 'Neighborhood'][index % 5];\r\n                    baseListing.hours = ['6 AM - 10 PM', 'Dawn to Dusk', '24 Hours', '7 AM - 9 PM', '5 AM - 11 PM'][index % 5];\r\n                  } else if (queryServiceType === 'gasstation') {\r\n                    baseListing.gasstationName = ['Quick Fill Station', 'Express Gas', 'Fuel Stop', 'Corner Gas', 'Highway Fuel'][index % 5];\r\n                    baseListing.stationType = ['Full Service', 'Self Service', 'Convenience Store', 'Truck Stop', 'Premium Station'][index % 5];\r\n                    baseListing.fuelTypes = ['Regular', 'Premium', 'Diesel', 'E85', 'Electric Charging'][index % 5];\r\n                    baseListing.location = ['Highway', 'Downtown', 'Suburban', 'Shopping Center', 'Residential'][index % 5];\r\n                    baseListing.hours = ['24 Hours', '6 AM - 11 PM', '5 AM - Midnight', '24 Hours', '7 AM - 10 PM'][index % 5];\r\n                  } else if (queryServiceType === 'party') {\r\n                    baseListing.partyName = ['New Year\\'s Eve Gala', 'Summer Music Festival', 'Rooftop Celebration', 'Dance Party Night', 'VIP Exclusive Event'][index % 5];\r\n                    baseListing.partyType = ['Concert', 'Festival', 'Nightclub', 'Private Event', 'Corporate Party'][index % 5];\r\n                    baseListing.eventDate = ['2026-12-31', '2026-07-15', '2026-06-20', '2026-08-10', '2026-09-05'][index % 5];\r\n                    baseListing.eventTime = ['9:00 PM', '6:00 PM', '8:00 PM', '10:00 PM', '7:00 PM'][index % 5];\r\n                    baseListing.location = ['Convention Center', 'Outdoor Venue', 'Rooftop', 'Nightclub', 'Hotel Ballroom'][index % 5];\r\n                    baseListing.capacity = [500, 1000, 200, 300, 150][index % 5];\r\n                  } else if (queryServiceType === 'bank') {\r\n                    baseListing.bankName = ['First National Bank', 'Community Credit Union', 'Metro Savings Bank', 'Trust Financial', 'Heritage Bank'][index % 5];\r\n                    baseListing.bankType = ['Commercial Bank', 'Credit Union', 'Savings Bank', 'Investment Bank', 'Community Bank'][index % 5];\r\n                    baseListing.services = ['Checking Account', 'Savings Account', 'Loans', 'Investment Services', 'Business Banking'][index % 5];\r\n                    baseListing.location = ['Downtown', 'Financial District', 'Shopping Center', 'Suburban', 'City Center'][index % 5];\r\n                    baseListing.hours = ['9 AM - 5 PM', '8 AM - 6 PM', '10 AM - 4 PM', '9 AM - 4 PM', '8 AM - 5 PM'][index % 5];\r\n                    baseListing.atmAvailable = [true, true, false, true, true][index % 5];\r\n                      } else {\r\n                        // Generic fallback for other service types\r\n                        baseListing.name = `Mock ${queryServiceType} Service ${index + 1}`;\r\n                        baseListing.date = new Date().toISOString().split('T')[0];\r\n                      }\r\n                      \r\n                      return baseListing;\r\n                    });\r\n                    listings = mockListings;\r\n                  }\r\n                  \r\n                  actionResult = {\r\n                    listings: listings,\r\n                    providers: providers.map(p => ({\r\n                      id: p.id,\r\n                      name: p.name,\r\n                      serviceType: p.serviceType,\r\n                      location: p.location\r\n                    }))\r\n                  };\r\n                  \r\n                  // Store serviceType in context for later use\r\n                  updatedContext.serviceType = queryServiceType;\r\n                  updatedContext.listings = listings;\r\n                  \r\n                  // CRITICAL: Also set in actionResult to ensure it's preserved when merged\r\n                  actionResult = { listings: listings };\r\n                  \r\n                  console.log(`   \uD83D\uDCCB [${requestId}] Set ${listings.length} ${queryServiceType} listings in context and actionResult`);\r\n                  break;\r\n                }\r\n\r\n                case 'add_ledger_entry': {\r\n                  console.log(`\uD83D\uDD0D [${requestId}] Executing add_ledger_entry action - START`);\r\n                  try {\r\n                    // Use snapshot from context (created by create_snapshot action)\r\n                    const snapshot = processedAction.snapshot || updatedContext.snapshot;\r\n                    if (!snapshot) {\r\n                      throw new Error('No snapshot available for ledger entry creation');\r\n                    }\r\n\r\n                    // Get serviceType from action, context, or workflow\r\n                    const ledgerServiceType = processedAction.serviceType || updatedContext.serviceType || serviceType || 'movie';\r\n                    const ledgerFields = getServiceTypeFields(ledgerServiceType);\r\n                    \r\n                    // Build booking details dynamically based on service type\r\n                    const bookingDetails = extractBookingDetails(ledgerServiceType, updatedContext.selectedListing || {});\r\n                    \r\n                    // Get default provider info based on service type (dynamic)\r\n                    const { getDefaultProviderName, getDefaultProviderId } = await import(\"./src/serviceTypeFields\");\r\n                    const defaultProviderName = getDefaultProviderName(ledgerServiceType);\r\n                    const defaultProviderId = getDefaultProviderId(ledgerServiceType);\r\n                    \r\n                    console.log(`\uD83D\uDCDD [${requestId}] Adding ledger entry for ${ledgerServiceType} booking:`, {\r\n                      amount: snapshot.amount,\r\n                      payer: snapshot.payer,\r\n                      merchant: processedAction.merchantName || updatedContext.selectedListing?.providerName || defaultProviderName,\r\n                      bookingDetails: bookingDetails,\r\n                      selectedListing: updatedContext.selectedListing\r\n                    });\r\n                    console.log(`\uD83D\uDCDD [${requestId}] Extracted booking details for ${ledgerServiceType}:`, JSON.stringify(bookingDetails, null, 2));\r\n\r\n                    console.log(`\uD83D\uDCDD [${requestId}] Calling addLedgerEntry with:`, {\r\n                      snapshotTxId: snapshot.txId,\r\n                      serviceType: ledgerServiceType,\r\n                      payerId: processedAction.payerId || updatedContext.user?.email,\r\n                      merchantName: processedAction.merchantName || updatedContext.selectedListing?.providerName || defaultProviderName\r\n                    });\r\n\r\n                    // DEX FIX: Resolve providerUuid from registry when workflow passes providerId (not UUID)\r\n                    // This prevents \"Demo Service/provider-001\" and enables certificate/settlement logic.\r\n                    if (ledgerServiceType.toLowerCase() === 'dex') {\r\n                      const providerIdFromContext =\r\n                        processedAction.providerId ||\r\n                        updatedContext.selectedListing?.providerId ||\r\n                        (updatedContext as any)?.trade?.tokenSymbol\r\n                          ? `dex-pool-${String((updatedContext as any)?.trade?.tokenSymbol || updatedContext.tokenSymbol || '').toLowerCase()}`\r\n                          : undefined;\r\n\r\n                      const providerIdNormalized = providerIdFromContext ? String(providerIdFromContext) : undefined;\r\n                      const providerFromRegistry = providerIdNormalized\r\n                        ? ROOT_CA_SERVICE_REGISTRY.find(p => p.id === providerIdNormalized)\r\n                        : undefined;\r\n\r\n                      if (!updatedContext.providerUuid && providerFromRegistry?.uuid) {\r\n                        updatedContext.providerUuid = providerFromRegistry.uuid;\r\n                        console.log(`\u2705 [${requestId}] DEX: Resolved providerUuid from registry: ${updatedContext.providerUuid} (providerId=${providerIdNormalized})`);\r\n                      }\r\n\r\n                      // If selectedListing is a generic demo, replace it with a synthesized DEX listing\r\n                      const isGenericDemo =\r\n                        (updatedContext.selectedListing as any)?.name === 'Demo Service' ||\r\n                        (updatedContext.selectedListing as any)?.providerId === 'provider-001';\r\n                      if (isGenericDemo) {\r\n                        const tokenSymbol = (updatedContext as any)?.trade?.tokenSymbol || updatedContext.tokenSymbol || 'TOKENA';\r\n                        const poolId = (updatedContext as any)?.trade?.poolId || `pool-solana-${String(tokenSymbol).toLowerCase()}`;\r\n                        const providerId = providerIdNormalized || `dex-pool-${String(tokenSymbol).toLowerCase()}`;\r\n                        updatedContext.selectedListing = {\r\n                          poolId,\r\n                          providerId,\r\n                          providerName: providerFromRegistry?.name || 'DEX Pool Provider',\r\n                          tokenSymbol,\r\n                          tokenName: `Token ${String(tokenSymbol).replace(/^TOKEN/i, '')}`,\r\n                          baseToken: (updatedContext as any)?.trade?.baseToken || updatedContext.baseToken || 'SOL',\r\n                          price: (updatedContext as any)?.trade?.price || 0,\r\n                          liquidity: 0,\r\n                          volume24h: 0,\r\n                          indexerId: providerFromRegistry?.gardenId || 'T1',\r\n                        } as any;\r\n                        console.warn(`\u26A0\uFE0F [${requestId}] DEX: Replaced generic Demo Service selectedListing with synthesized DEX listing`);\r\n                      }\r\n                    }\r\n\r\n                    const ledgerEntry = await addLedgerEntry(\r\n                      snapshot,\r\n                      ledgerServiceType,\r\n                      processedAction.iGasCost || updatedContext.iGasCost || 0.00445,\r\n                      processedAction.payerId || updatedContext.user?.email || 'unknown@example.com',\r\n                      processedAction.merchantName || updatedContext.selectedListing?.providerName || defaultProviderName,\r\n                      processedAction.providerUuid || updatedContext.providerUuid || updatedContext.selectedListing?.providerId || defaultProviderId,\r\n                      bookingDetails\r\n                    );\r\n\r\n                    console.log(`\uD83D\uDCDD [${requestId}] addLedgerEntry returned:`, {\r\n                      entryId: ledgerEntry.entryId,\r\n                      txId: ledgerEntry.txId,\r\n                      payer: ledgerEntry.payer,\r\n                      merchant: ledgerEntry.merchant,\r\n                      amount: ledgerEntry.amount\r\n                    });\r\n                    console.log(`\uD83D\uDCDD [${requestId}] LEDGER array now has ${LEDGER.length} entries`);\r\n\r\n                    actionResult = { ledgerEntry };\r\n                    // CRITICAL: Store ledgerEntry in context for websocketEvents template replacement\r\n                    updatedContext.ledgerEntry = ledgerEntry;\r\n                    // Also store in actionResult so it's merged into context\r\n                    console.log(`\uD83D\uDCDD [${requestId}] Stored ledgerEntry in context:`, {\r\n                      entryId: ledgerEntry.entryId,\r\n                      txId: ledgerEntry.txId,\r\n                      merchant: ledgerEntry.merchant,\r\n                      amount: ledgerEntry.amount\r\n                    });\r\n                    \r\n                    // CRITICAL: Ensure ledger entry is broadcast to Angular\r\n                    // addLedgerEntry already broadcasts, but we also broadcast here to ensure it's sent\r\n                    console.log(`\uD83D\uDCE1 [${requestId}] Broadcasting ledger_entry_added from workflow action handler`);\r\n                    broadcastEvent({\r\n                      type: \"ledger_entry_added\",\r\n                      component: \"ledger\",\r\n                      message: `Ledger entry created: ${ledgerEntry.entryId}`,\r\n                      timestamp: Date.now(),\r\n                      data: { entry: ledgerEntry }\r\n                    });\r\n                  } catch (ledgerError) {\r\n                    console.error(`\u274C [${requestId}] Error adding ledger entry:`, ledgerError);\r\n                    actionResult = { error: ledgerError.message };\r\n                  }\r\n                  break;\r\n                }\r\n\r\n                case 'check_balance':\r\n                  const userEmail = processedAction.email || updatedContext.user?.email;\r\n                  const requiredAmount = processedAction.required || updatedContext.totalCost || processedAction.amount;\r\n\r\n                  if (!userEmail || !requiredAmount) {\r\n                    throw new Error('Missing user email or amount for balance check');\r\n                  }\r\n\r\n                  const balance = getWalletBalance(userEmail);\r\n                  const hasBalance = balance >= requiredAmount;\r\n\r\n                  actionResult = {\r\n                    balanceChecked: true,\r\n                    userEmail,\r\n                    requiredAmount,\r\n                    currentBalance: balance,\r\n                    sufficientFunds: hasBalance\r\n                  };\r\n                  break;\r\n\r\n                case 'process_payment':\r\n                  const paymentUser = processedAction.user || updatedContext.user;\r\n                  const currentServiceType = (updatedContext.serviceType || serviceType || '').toString().toLowerCase();\r\n                  const paymentAmountRaw = processedAction.amount || updatedContext.totalCost || updatedContext.moviePrice;\r\n                  const paymentAmount = typeof paymentAmountRaw === 'string' ? parseFloat(paymentAmountRaw) : paymentAmountRaw;\r\n\r\n                  if (!paymentUser?.email || !paymentAmount) {\r\n                    throw new Error('Missing payment details');\r\n                  }\r\n\r\n                  // Process the payment through cashier (CRITICAL: await the async function)\r\n                  const ledgerEntryForPayment = processedAction.ledgerEntry || updatedContext.ledgerEntry;\r\n                  // CRITICAL: Get the actual cashier reference, not a copy (getCashierStatus returns a copy)\r\n                  // We need to import CASHIER directly or get a reference to the actual object\r\n                  const cashierForPayment = processedAction.cashier || getCashierStatus();\r\n                  // Note: processPayment will update cashier stats, but getCashierStatus() returns a copy\r\n                  // The actual CASHIER object in ledger.ts will be updated by processPayment\r\n                  \r\n                  if (!ledgerEntryForPayment) {\r\n                    throw new Error('Missing ledger entry for payment processing');\r\n                  }\r\n\r\n                  // CRITICAL: Find the actual entry in LEDGER array to ensure we update the correct reference\r\n                  const ledgerEntryInArray = LEDGER.find(e => e.entryId === ledgerEntryForPayment.entryId);\r\n                  if (!ledgerEntryInArray) {\r\n                    throw new Error(`Ledger entry ${ledgerEntryForPayment.entryId} not found in LEDGER array`);\r\n                  }\r\n\r\n                  // CRITICAL: Ensure the entry has an amount (use paymentAmount if entry.amount is missing)\r\n                  if (!ledgerEntryInArray.amount || ledgerEntryInArray.amount === 0) {\r\n                    console.warn(`\u26A0\uFE0F [${requestId}] Ledger entry ${ledgerEntryInArray.entryId} has no amount, using paymentAmount: ${paymentAmount}`);\r\n                    ledgerEntryInArray.amount = paymentAmount;\r\n                    // Persist the amount update\r\n                    if (redis) {\r\n                      redis.saveLedgerEntries(LEDGER);\r\n                      console.log(`\uD83D\uDCBE [${requestId}] Persisted ledger entry with updated amount: ${ledgerEntryInArray.entryId}`);\r\n                    }\r\n                  }\r\n\r\n                  // DEX FIX: DEX trade execution already moved funds; do NOT debit again here.\r\n                  // We still update cashier + ledger status so the UI shows cashier/accountant involvement.\r\n                  if (currentServiceType === 'dex') {\r\n                    console.log(`\uD83D\uDCB0 [${requestId}] DEX: Skipping wallet debit in process_payment (trade already executed). Updating cashier + ledger status...`);\r\n                    try {\r\n                      // Update cashier stats\r\n                      cashierForPayment.processedCount = (cashierForPayment.processedCount || 0) + 1;\r\n                      cashierForPayment.totalProcessed = (cashierForPayment.totalProcessed || 0) + (ledgerEntryInArray.amount || 0);\r\n                    } catch {}\r\n                    ledgerEntryInArray.status = 'processed';\r\n                    if (redis) {\r\n                      redis.saveLedgerEntries(LEDGER);\r\n                      console.log(`\uD83D\uDCBE [${requestId}] \u2705 Persisted ledger entry with processed status (DEX): ${ledgerEntryInArray.entryId}`);\r\n                    }\r\n                    // Update balances in context from wallet service (source of truth)\r\n                    const { getWalletBalance: getWalletBalanceAsync } = await import(\"./src/wallet\");\r\n                    const balance = await getWalletBalanceAsync(paymentUser.email);\r\n                    if (updatedContext.user) updatedContext.user.balance = balance;\r\n                    updatedContext.paymentSuccess = true;\r\n                    updatedContext.cashier = cashierForPayment;\r\n                    updatedContext.updatedBalance = balance;\r\n                    updatedContext.ledgerEntry = ledgerEntryInArray;\r\n                    actionResult = {\r\n                      paymentProcessed: true,\r\n                      paymentSuccess: true,\r\n                      amount: ledgerEntryInArray.amount,\r\n                      skippedDebit: true,\r\n                      updatedBalance: balance,\r\n                      ledgerEntry: ledgerEntryInArray,\r\n                      cashier: cashierForPayment\r\n                    };\r\n                    break;\r\n                  }\r\n\r\n                  // Process payment (this will update status to 'processed' and persist)\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] ========================================`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] \uD83D\uDCB0 CASHIER PAYMENT PROCESSING START`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] Entry ID: ${ledgerEntryInArray.entryId}`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] Amount: ${ledgerEntryInArray.amount}`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] User: ${paymentUser.email}`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] Cashier Before: processedCount=${cashierForPayment.processedCount}, totalProcessed=${cashierForPayment.totalProcessed}`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] ========================================`);\r\n                  \r\n                  const paymentResult = await processPayment(cashierForPayment, ledgerEntryInArray, paymentUser);\r\n                  \r\n                  // Check cashier stats after payment\r\n                  const cashierAfter = getCashierStatus();\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] ========================================`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] \uD83D\uDCB0 CASHIER PAYMENT PROCESSING RESULT`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] Payment Result: ${paymentResult}`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] Entry Status: ${ledgerEntryInArray.status}`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] Cashier After: processedCount=${cashierAfter.processedCount}, totalProcessed=${cashierAfter.totalProcessed}`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] ========================================`);\r\n\r\n                  if (!paymentResult) {\r\n                    // Payment failed - status should be 'failed' now\r\n                    if (redis) {\r\n                      redis.saveLedgerEntries(LEDGER);\r\n                      console.log(`\uD83D\uDCBE [${requestId}] Persisted ledger entry with failed status after payment failure: ${ledgerEntryInArray.entryId}`);\r\n                    }\r\n                    throw new Error('Payment processing failed');\r\n                  }\r\n\r\n                  // CRITICAL: Ensure status is 'processed' and persist (processPayment should have done this, but double-check)\r\n                  if (ledgerEntryInArray.status !== 'processed') {\r\n                    console.warn(`\u26A0\uFE0F [${requestId}] Ledger entry status is ${ledgerEntryInArray.status}, expected 'processed'. Updating...`);\r\n                    ledgerEntryInArray.status = 'processed';\r\n                  }\r\n                  \r\n                  // Persist the status update (processPayment should have done this, but ensure it's persisted)\r\n                  if (redis) {\r\n                    redis.saveLedgerEntries(LEDGER);\r\n                    console.log(`\uD83D\uDCBE [${requestId}] \u2705 Persisted ledger entry with processed status after payment: ${ledgerEntryInArray.entryId}`);\r\n                  } else {\r\n                    console.error(`\u274C [${requestId}] Redis not available! Cannot persist processed status for entry: ${ledgerEntryInArray.entryId}`);\r\n                  }\r\n                  \r\n                  // Update the context with the entry from LEDGER array\r\n                  updatedContext.ledgerEntry = ledgerEntryInArray;\r\n\r\n                  actionResult = {\r\n                    paymentProcessed: true,\r\n                    paymentSuccess: true,\r\n                    amount: paymentAmount,\r\n                    newBalance: paymentUser.balance,\r\n                    ledgerEntry: ledgerEntryForPayment\r\n                  };\r\n                  updatedContext.paymentSuccess = true;\r\n                  break;\r\n\r\n                case 'start_movie_watching':\r\n                  // This case is handled above before the switch statement\r\n                  // If we reach here, it means the async handler didn't catch it\r\n                  console.warn(`\u26A0\uFE0F [${requestId}] start_movie_watching reached switch case - should be handled asynchronously`);\r\n                  actionResult = { movieStarted: false, error: 'Should be handled asynchronously' };\r\n                  break;\r\n\r\n                case 'start_hotel_booking':\r\n                  console.log(`\uD83C\uDFE8 [${requestId}] Starting hotel booking`);\r\n                  const hotelName = processedAction.hotelName || updatedContext.selectedListing?.hotelName || 'Unknown Hotel';\r\n                  const duration = processedAction.duration || 1;\r\n                  const confirmationMessage = processedAction.confirmationMessage || `Your booking for ${hotelName} is confirmed!`;\r\n                  \r\n                  // Simulate hotel booking process\r\n                  actionResult = {\r\n                    hotelBooked: true,\r\n                    hotelName: hotelName,\r\n                    duration: duration,\r\n                    confirmationMessage: confirmationMessage,\r\n                    bookingId: `hotel_${Date.now()}`\r\n                  };\r\n                  \r\n                  // CRITICAL: Set hotelBooked in context for transition conditions\r\n                  updatedContext.hotelBooked = true;\r\n                  updatedContext.confirmationMessage = confirmationMessage;\r\n                  \r\n                  console.log(`\uD83C\uDFE8 [${requestId}] Hotel booking completed: ${hotelName} for ${duration} night(s)`);\r\n                  break;\r\n\r\n                case 'complete_booking':\r\n                  const bookingEntry = processedAction.ledgerEntry || updatedContext.ledgerEntry;\r\n                  if (!bookingEntry) {\r\n                    throw new Error('Missing ledger entry for booking completion');\r\n                  }\r\n\r\n                  const bookingResult = completeBooking(bookingEntry);\r\n                  actionResult = {\r\n                    bookingCompleted: true,\r\n                    bookingResult\r\n                  };\r\n                  break;\r\n\r\n                // ROOT CA Ledger Settlement Actions\r\n                case 'root_ca_consume_ledger':\r\n                  console.log(`\u2696\uFE0F  [${requestId}] ROOT CA: Consuming ledger entry from settlement stream`);\r\n                  const ledgerEntryForSettlement = processedAction.ledgerEntry || updatedContext.ledgerEntry;\r\n                  if (!ledgerEntryForSettlement) {\r\n                    throw new Error('Missing ledger entry for ROOT CA settlement');\r\n                  }\r\n\r\n                  // Verify entry is in settlement stream (already pushed by add_ledger_entry)\r\n                  // The actual consumption happens via rootCASettlementConsumer, but we verify it's there\r\n                  const entryInStream = ledgerEntryForSettlement.entryId;\r\n                  console.log(`\u2696\uFE0F  [${requestId}] ROOT CA: Verifying entry ${entryInStream} is in settlement stream`);\r\n                  \r\n                  actionResult = {\r\n                    entryConsumed: true,\r\n                    entryId: entryInStream,\r\n                    stream: LEDGER_SETTLEMENT_STREAM\r\n                  };\r\n                  break;\r\n\r\n                case 'root_ca_validate_entry':\r\n                  console.log(`\u2696\uFE0F  [${requestId}] ROOT CA: Validating ledger entry`);\r\n                  const entryToValidate = processedAction.ledgerEntry || updatedContext.ledgerEntry;\r\n                  const providerUuidToValidate = processedAction.certificate || updatedContext.providerUuid;\r\n                  \r\n                  if (!entryToValidate) {\r\n                    throw new Error('Missing ledger entry for validation');\r\n                  }\r\n\r\n                  // Validate entry structure\r\n                  const hasRequiredFields = entryToValidate.entryId && entryToValidate.txId && entryToValidate.amount;\r\n                  if (!hasRequiredFields) {\r\n                    throw new Error('Ledger entry missing required fields');\r\n                  }\r\n\r\n                  // Validate certificate if provided\r\n                  let certificateValid = true;\r\n                  if (providerUuidToValidate && providerUuidToValidate !== 'MISSING-UUID') {\r\n                    const cert = getCertificate(providerUuidToValidate);\r\n                    certificateValid = cert ? validateCertificate(providerUuidToValidate) : false;\r\n                    if (!certificateValid) {\r\n                      console.warn(`\u26A0\uFE0F  [${requestId}] ROOT CA: Invalid certificate for provider ${providerUuidToValidate}`);\r\n                    }\r\n                  }\r\n\r\n                  actionResult = {\r\n                    entryValidated: true,\r\n                    validationStatus: certificateValid ? 'valid' : 'invalid_certificate',\r\n                    entryId: entryToValidate.entryId,\r\n                    certificateValid\r\n                  };\r\n                  break;\r\n\r\n                case 'root_ca_settle_entry':\r\n                  console.log(`\u2696\uFE0F  [${requestId}] ROOT CA: Settling ledger entry`);\r\n                  const entryToSettle = processedAction.ledgerEntry || updatedContext.ledgerEntry;\r\n                  \r\n                  if (!entryToSettle) {\r\n                    throw new Error('Missing ledger entry for settlement');\r\n                  }\r\n\r\n                  // Find entry in LEDGER array\r\n                  const ledgerEntryToSettle = LEDGER.find(e => e.entryId === entryToSettle.entryId);\r\n                  if (!ledgerEntryToSettle) {\r\n                    throw new Error(`Ledger entry ${entryToSettle.entryId} not found`);\r\n                  }\r\n\r\n                  // Settlement is done by rootCASettlementConsumer asynchronously\r\n                  // Wait for settlement to complete (poll up to 5 seconds)\r\n                  let settled = false;\r\n                  const maxWaitTime = 5000; // 5 seconds\r\n                  const pollInterval = 100; // Check every 100ms\r\n                  const startTime = Date.now();\r\n                  \r\n                  while (!settled && (Date.now() - startTime) < maxWaitTime) {\r\n                    if (ledgerEntryToSettle.status === 'completed') {\r\n                      settled = true;\r\n                      console.log(`\u2705 [${requestId}] ROOT CA: Entry ${entryToSettle.entryId} settled (waited ${Date.now() - startTime}ms)`);\r\n                    } else {\r\n                      // Wait a bit before checking again\r\n                      await new Promise(resolve => setTimeout(resolve, pollInterval));\r\n                    }\r\n                  }\r\n                  \r\n                  if (!settled) {\r\n                    // If not settled yet, trigger settlement manually\r\n                    console.log(`\u2696\uFE0F  [${requestId}] ROOT CA: Entry not settled yet, triggering manual settlement`);\r\n                    try {\r\n                      // Create settlement message format\r\n                      const snapshot = updatedContext.snapshot;\r\n                      const settlementMsg: Record<string, string> = {\r\n                        entryId: entryToSettle.entryId,\r\n                        txId: entryToSettle.txId,\r\n                        timestamp: entryToSettle.timestamp.toString(),\r\n                        payer: entryToSettle.payer,\r\n                        payerId: entryToSettle.payerId,\r\n                        merchant: entryToSettle.merchant,\r\n                        providerUuid: entryToSettle.providerUuid,\r\n                        indexerId: snapshot?.gardenId || 'unknown',\r\n                        serviceType: entryToSettle.serviceType,\r\n                        amount: entryToSettle.amount.toString(),\r\n                        iGas: entryToSettle.iGasCost.toString(),\r\n                        iTax: (entryToSettle.bookingDetails?.iTax || 0).toString(),\r\n                        fees: JSON.stringify(entryToSettle.fees || {}),\r\n                        status: entryToSettle.status\r\n                      };\r\n                      \r\n                      // Process settlement synchronously\r\n                      await processSettlementEntry(settlementMsg);\r\n                      // Check status after settlement\r\n                      if (ledgerEntryToSettle.status === 'completed') {\r\n                        settled = true;\r\n                        console.log(`\u2705 [${requestId}] ROOT CA: Entry ${entryToSettle.entryId} settled manually`);\r\n                        // CRITICAL: Persist the updated status immediately after settlement\r\n                        if (redis) {\r\n                          redis.saveLedgerEntries(LEDGER);\r\n                          console.log(`\uD83D\uDCBE [${requestId}] ROOT CA: Persisted ledger entry with completed status: ${entryToSettle.entryId}`);\r\n                        }\r\n                      } else {\r\n                        console.warn(`\u26A0\uFE0F  [${requestId}] ROOT CA: Entry ${entryToSettle.entryId} status is ${ledgerEntryToSettle.status}, expected 'completed'`);\r\n                      }\r\n                    } catch (settleError: any) {\r\n                      console.error(`\u274C [${requestId}] ROOT CA: Failed to settle entry:`, settleError.message);\r\n                      throw new Error(`Settlement failed: ${settleError.message}`);\r\n                    }\r\n                  }\r\n\r\n                  actionResult = {\r\n                    settlementStatus: 'settled',\r\n                    entryId: entryToSettle.entryId,\r\n                    status: ledgerEntryToSettle.status\r\n                  };\r\n                  updatedContext.settlementStatus = 'settled';\r\n                  break;\r\n\r\n                case 'root_ca_update_balances':\r\n                  console.log(`\u2696\uFE0F  [${requestId}] ROOT CA: Updating authoritative balances`);\r\n                  const entryForBalances = processedAction.ledgerEntry || updatedContext.ledgerEntry;\r\n                  const feeSplit = processedAction.feeSplit || updatedContext.snapshot?.feeSplit;\r\n                  \r\n                  if (!entryForBalances) {\r\n                    throw new Error('Missing ledger entry for balance update');\r\n                  }\r\n\r\n                  // Balance updates are done by processSettlementEntry, but we verify them here\r\n                  const entryInLedger = LEDGER.find(e => e.entryId === entryForBalances.entryId);\r\n                  if (!entryInLedger) {\r\n                    throw new Error(`Ledger entry ${entryForBalances.entryId} not found`);\r\n                  }\r\n\r\n                  // Verify balances were updated (check ROOT_BALANCES)\r\n                  const rootCABalance = ROOT_BALANCES.rootCA;\r\n                  console.log(`\u2696\uFE0F  [${requestId}] ROOT CA: Current ROOT CA balance: ${rootCABalance.toFixed(6)}`);\r\n\r\n                  actionResult = {\r\n                    balancesUpdated: true,\r\n                    entryId: entryForBalances.entryId,\r\n                    rootCABalance,\r\n                    feeSplit\r\n                  };\r\n                  updatedContext.balancesUpdated = true;\r\n                  break;\r\n\r\n                case 'root_ca_finalize_fees':\r\n                  console.log(`\u2696\uFE0F  [${requestId}] ROOT CA: Finalizing fee distributions`);\r\n                  const entryForFees = processedAction.ledgerEntry || updatedContext.ledgerEntry;\r\n                  const feesToFinalize = processedAction.fees || updatedContext.snapshot?.feeSplit;\r\n                  \r\n                  if (!entryForFees) {\r\n                    throw new Error('Missing ledger entry for fee finalization');\r\n                  }\r\n\r\n                  // Fees are finalized by processSettlementEntry, but we verify here\r\n                  const entryForFeeCheck = LEDGER.find(e => e.entryId === entryForFees.entryId);\r\n                  if (!entryForFeeCheck) {\r\n                    throw new Error(`Ledger entry ${entryForFees.entryId} not found`);\r\n                  }\r\n                  \r\n                  // CRITICAL: Ensure status is 'completed' after settlement\r\n                  if (entryForFeeCheck.status !== 'completed') {\r\n                    console.warn(`\u26A0\uFE0F  [${requestId}] ROOT CA: Entry ${entryForFees.entryId} status is ${entryForFeeCheck.status}, updating to 'completed'`);\r\n                    entryForFeeCheck.status = 'completed';\r\n                    // Persist the status update\r\n                    if (redis) {\r\n                      redis.saveLedgerEntries(LEDGER);\r\n                      console.log(`\uD83D\uDCBE [${requestId}] ROOT CA: Persisted ledger entry with completed status after fee finalization`);\r\n                    }\r\n                  }\r\n\r\n                  actionResult = {\r\n                    feesFinalized: true,\r\n                    entryId: entryForFees.entryId,\r\n                    fees: feesToFinalize,\r\n                    status: 'completed'\r\n                  };\r\n                  updatedContext.feesFinalized = true;\r\n                  updatedContext.settlementStatus = 'settled';\r\n                  break;\r\n\r\n                // ROOT CA Cashier Oversight Actions\r\n                case 'root_ca_validate_payment':\r\n                  console.log(`\u2696\uFE0F  [${requestId}] ROOT CA: Validating cashier payment`);\r\n                  const paymentEntry = processedAction.ledgerEntry || updatedContext.ledgerEntry;\r\n                  const paymentResultForValidation = processedAction.paymentResult || updatedContext.paymentSuccess;\r\n                  const cashierInfo = processedAction.cashier || updatedContext.cashier;\r\n                  \r\n                  if (!paymentEntry) {\r\n                    throw new Error('Missing ledger entry for payment validation');\r\n                  }\r\n\r\n                  // Validate payment was successful\r\n                  if (!paymentResultForValidation) {\r\n                    throw new Error('Payment was not successful');\r\n                  }\r\n\r\n                  // Validate cashier processed the payment\r\n                  if (!cashierInfo) {\r\n                    throw new Error('Cashier information missing');\r\n                  }\r\n\r\n                  actionResult = {\r\n                    paymentValidated: true,\r\n                    entryId: paymentEntry.entryId,\r\n                    paymentStatus: paymentResultForValidation,\r\n                    cashier: cashierInfo.name\r\n                  };\r\n                  break;\r\n\r\n                case 'root_ca_verify_balance_update':\r\n                  console.log(`\u2696\uFE0F  [${requestId}] ROOT CA: Verifying balance update`);\r\n                  const userEmailForVerify = processedAction.userEmail || updatedContext.user?.email;\r\n                  const expectedBalance = processedAction.expectedBalance || updatedContext.updatedBalance;\r\n                  const entryForVerify = processedAction.ledgerEntry || updatedContext.ledgerEntry;\r\n                  \r\n                  if (!userEmailForVerify || expectedBalance === undefined) {\r\n                    throw new Error('Missing user email or expected balance for verification');\r\n                  }\r\n\r\n                  // Get actual balance from wallet service\r\n                  const actualBalance = getWalletBalance(userEmailForVerify);\r\n                  \r\n                  // Verify balance matches expected\r\n                  const balanceMatches = Math.abs(actualBalance - expectedBalance) < 0.000001; // Allow small floating point differences\r\n                  if (!balanceMatches) {\r\n                    console.warn(`\u26A0\uFE0F  [${requestId}] ROOT CA: Balance mismatch - Expected: ${expectedBalance}, Actual: ${actualBalance}`);\r\n                  }\r\n\r\n                  actionResult = {\r\n                    balanceVerified: balanceMatches,\r\n                    userEmail: userEmailForVerify,\r\n                    expectedBalance,\r\n                    actualBalance,\r\n                    entryId: entryForVerify?.entryId\r\n                  };\r\n                  updatedContext.balanceVerified = balanceMatches;\r\n                  break;\r\n\r\n                case 'root_ca_authorize_payment':\r\n                  console.log(`\u2696\uFE0F  [${requestId}] ROOT CA: Authorizing payment`);\r\n                  const entryToAuthorize = processedAction.ledgerEntry || updatedContext.ledgerEntry;\r\n                  const paymentStatus = processedAction.paymentStatus || updatedContext.paymentSuccess;\r\n                  \r\n                  if (!entryToAuthorize) {\r\n                    throw new Error('Missing ledger entry for payment authorization');\r\n                  }\r\n\r\n                  if (!paymentStatus) {\r\n                    throw new Error('Payment was not successful, cannot authorize');\r\n                  }\r\n\r\n                  // ROOT CA authorizes the payment\r\n                  actionResult = {\r\n                    paymentAuthorized: true,\r\n                    entryId: entryToAuthorize.entryId,\r\n                    authorizationTimestamp: Date.now()\r\n                  };\r\n                  updatedContext.paymentAuthorized = true;\r\n                  updatedContext.cashierOversightComplete = true;\r\n                  break;\r\n\r\n                case 'execute_dex_trade':\r\n                  // Execute DEX trade (FULLY AUTOMATED)\r\n                  // Use handler to execute trade and update wallet\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] Executing DEX trade...`);\r\n                  \r\n                  // CRITICAL: Get selectedListing from multiple possible sources\r\n                  const selectedListingForTrade = updatedContext.selectedListing || \r\n                                                   updatedContext.llmResponse?.selectedListing || \r\n                                                   updatedContext.llmResponse?.selectedListing2 ||\r\n                                                   updatedContext.selectedListing2;\r\n                  \r\n                  console.log(`\uD83D\uDCB0 [${requestId}] selectedListing sources:`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}]   - updatedContext.selectedListing: ${!!updatedContext.selectedListing}`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}]   - updatedContext.llmResponse?.selectedListing: ${!!updatedContext.llmResponse?.selectedListing}`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}]   - updatedContext.llmResponse?.selectedListing2: ${!!updatedContext.llmResponse?.selectedListing2}`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}]   - updatedContext.selectedListing2: ${!!updatedContext.selectedListing2}`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}]   - selectedListingForTrade: ${!!selectedListingForTrade}`);\r\n                  if (selectedListingForTrade) {\r\n                    console.log(`\uD83D\uDCB0 [${requestId}]   - selectedListingForTrade.poolId: ${(selectedListingForTrade as any)?.poolId}`);\r\n                    console.log(`\uD83D\uDCB0 [${requestId}]   - selectedListingForTrade keys: ${Object.keys(selectedListingForTrade).join(', ')}`);\r\n                  }\r\n                  \r\n                  // Get poolId from multiple sources\r\n                  let poolIdForTrade = processedAction.poolId || \r\n                                        (selectedListingForTrade as any)?.poolId ||\r\n                                        updatedContext.selectedListing?.poolId ||\r\n                                        updatedContext.llmResponse?.selectedListing?.poolId ||\r\n                                        updatedContext.llmResponse?.selectedListing2?.poolId;\r\n                  \r\n                  // FALLBACK: If poolId is still missing, try to get it from listings or initialize pools\r\n                  if (!poolIdForTrade) {\r\n                    console.warn(`\u26A0\uFE0F [${requestId}] poolId not found in selectedListing, trying fallback...`);\r\n                    \r\n                    // Try to get poolId from listings array\r\n                    const listings = updatedContext.listings || [];\r\n                    const dexListing = listings.find((l: any) => l.poolId || (l.tokenSymbol && l.baseToken));\r\n                    if (dexListing && dexListing.poolId) {\r\n                      poolIdForTrade = dexListing.poolId;\r\n                      console.log(`\u2705 [${requestId}] Found poolId from listings: ${poolIdForTrade}`);\r\n                    } else if (dexListing && dexListing.tokenSymbol) {\r\n                      // Construct poolId from tokenSymbol\r\n                      poolIdForTrade = `pool-solana-${dexListing.tokenSymbol.toLowerCase()}`;\r\n                      console.log(`\u2705 [${requestId}] Constructed poolId from tokenSymbol: ${poolIdForTrade}`);\r\n                    } else {\r\n                      // Last resort: Use tokenSymbol from context to construct poolId\r\n                      const tokenSymbol = updatedContext.tokenSymbol || updatedContext.queryResult?.query?.filters?.tokenSymbol;\r\n                      if (tokenSymbol) {\r\n                        poolIdForTrade = `pool-solana-${tokenSymbol.toLowerCase()}`;\r\n                        console.log(`\u2705 [${requestId}] Constructed poolId from context tokenSymbol: ${poolIdForTrade}`);\r\n                      } else {\r\n                        // Final fallback: Use first available pool from DEX_POOLS\r\n                        const { DEX_POOLS } = await import(\"./src/state\");\r\n                        if (DEX_POOLS && DEX_POOLS.size > 0) {\r\n                          const firstPool = Array.from(DEX_POOLS.values())[0];\r\n                          poolIdForTrade = firstPool.poolId;\r\n                          console.log(`\u2705 [${requestId}] Using first available pool from DEX_POOLS: ${poolIdForTrade}`);\r\n                        } else {\r\n                          console.error(`\u274C [${requestId}] No DEX pools available! DEX_POOLS.size: ${DEX_POOLS?.size || 0}`);\r\n                          // Try to initialize pools\r\n                          console.log(`\uD83D\uDD27 [${requestId}] Attempting to initialize DEX pools...`);\r\n                          initializeDEXPools();\r\n                          if (DEX_POOLS && DEX_POOLS.size > 0) {\r\n                            const firstPool = Array.from(DEX_POOLS.values())[0];\r\n                            poolIdForTrade = firstPool.poolId;\r\n                            console.log(`\u2705 [${requestId}] Initialized pools and using first pool: ${poolIdForTrade}`);\r\n                          }\r\n                        }\r\n                      }\r\n                    }\r\n                  }\r\n                  \r\n                  console.log(`\uD83D\uDCB0 [${requestId}] poolId: ${poolIdForTrade}`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] action: ${processedAction.action || updatedContext.action}`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] tokenAmount: ${processedAction.tokenAmount || updatedContext.tokenAmount}`);\r\n                  console.log(`\uD83D\uDCB0 [${requestId}] userEmail: ${processedAction.userEmail || updatedContext.user?.email}`);\r\n                  \r\n                  const { createActionHandlers } = await import(\"./src/flowwiseHandlers\");\r\n                  const handlers = createActionHandlers();\r\n                  const dexHandler = handlers.get(\"execute_dex_trade\");\r\n                  \r\n                  if (!dexHandler) {\r\n                    throw new Error(\"execute_dex_trade handler not found\");\r\n                  }\r\n                  \r\n                  // Prepare action for handler\r\n                  const dexAction = {\r\n                    poolId: poolIdForTrade,\r\n                    action: processedAction.action || updatedContext.action,\r\n                    tokenAmount: processedAction.tokenAmount || updatedContext.tokenAmount,\r\n                    userEmail: processedAction.userEmail || updatedContext.user?.email\r\n                  };\r\n                  \r\n                  if (!dexAction.poolId || !dexAction.action || !dexAction.tokenAmount || !dexAction.userEmail) {\r\n                    console.error(`\u274C [${requestId}] Missing DEX trade parameters:`);\r\n                    console.error(`\u274C [${requestId}]   - poolId: ${dexAction.poolId || 'MISSING'}`);\r\n                    console.error(`\u274C [${requestId}]   - action: ${dexAction.action || 'MISSING'}`);\r\n                    console.error(`\u274C [${requestId}]   - tokenAmount: ${dexAction.tokenAmount || 'MISSING'}`);\r\n                    console.error(`\u274C [${requestId}]   - userEmail: ${dexAction.userEmail || 'MISSING'}`);\r\n                    console.error(`\u274C [${requestId}] Context keys:`, Object.keys(updatedContext));\r\n                    console.error(`\u274C [${requestId}] selectedListing:`, selectedListingForTrade ? JSON.stringify(selectedListingForTrade, null, 2) : 'NOT FOUND');\r\n                    throw new Error(`Missing required DEX trade parameters: poolId=${!!dexAction.poolId}, action=${!!dexAction.action}, tokenAmount=${!!dexAction.tokenAmount}, userEmail=${!!dexAction.userEmail}`);\r\n                  }\r\n                  \r\n                  const dexResult = await dexHandler(dexAction, updatedContext);\r\n                  \r\n                  // Merge result into context\r\n                  if (dexResult.trade) {\r\n                    updatedContext.trade = dexResult.trade;\r\n                    // Update totalCost with actual trade amount\r\n                    updatedContext.totalCost = dexResult.trade.baseAmount + (updatedContext.iGasCost || 0);\r\n                    console.log(`\uD83D\uDCB0 [${requestId}] DEX trade executed: ${dexResult.trade.action} ${dexResult.trade.tokenAmount} ${dexResult.trade.tokenSymbol} for ${dexResult.trade.baseAmount} ${dexResult.trade.baseToken}`);\r\n                  }\r\n                  if (dexResult.updatedBalance !== undefined) {\r\n                    if (updatedContext.user) {\r\n                      updatedContext.user.balance = dexResult.updatedBalance;\r\n                    }\r\n                    updatedContext.updatedBalance = dexResult.updatedBalance;\r\n                    console.log(`\uD83D\uDCB0 [${requestId}] Updated balance: ${dexResult.updatedBalance}`);\r\n                  }\r\n                  if (dexResult.traderRebate !== undefined) {\r\n                    updatedContext.traderRebate = dexResult.traderRebate;\r\n                    console.log(`\uD83D\uDCB0 [${requestId}] Trader rebate: ${dexResult.traderRebate}`);\r\n                  }\r\n                  \r\n                  actionResult = {\r\n                    trade: dexResult.trade,\r\n                    updatedBalance: dexResult.updatedBalance,\r\n                    traderRebate: dexResult.traderRebate\r\n                  };\r\n                  break;\r\n\r\n                default:\r\n                  // DEFAULT CASE: Handle llm_format_response and any other unmatched actions\r\n                  console.log(`\uD83D\uDD0D [${requestId}] ========================================`);\r\n                  console.log(`\uD83D\uDD0D [${requestId}] DEFAULT CASE HIT - action.type: \"${action.type}\"`);\r\n                  console.log(`\uD83D\uDD0D [${requestId}] ========================================`);\r\n                  \r\n                  if (action.type === 'llm_format_response') {\r\n                    // CRITICAL: Use CLONED formatResponseWithOpenAI function directly (not imported)\r\n                    // This ensures selectedListing and selectedListing2 are properly set\r\n                    const availableListings = updatedContext.listings || [];\r\n                    const formatServiceType = updatedContext.serviceType || updatedContext.queryResult?.serviceType || serviceType || 'movie';\r\n                    \r\n                    console.log(`\uD83D\uDD0D [${requestId}] ========================================`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}] llm_format_response ACTION CALLED (EDEN-SIM-REDIS) - DEFAULT CASE`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}] listings count: ${availableListings.length}`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}] userInput: ${updatedContext.userInput?.substring(0, 100) || 'N/A'}`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}] serviceType: ${formatServiceType}`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}] ENABLE_OPENAI: ${ENABLE_OPENAI}`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}] Context keys:`, Object.keys(updatedContext));\r\n                    console.log(`\uD83D\uDD0D [${requestId}] Context.queryResult:`, updatedContext.queryResult ? {\r\n                      serviceType: updatedContext.queryResult.serviceType,\r\n                      hasQuery: !!updatedContext.queryResult.query,\r\n                      hasFilters: !!updatedContext.queryResult.query?.filters,\r\n                      filters: updatedContext.queryResult.query?.filters\r\n                    } : 'null/undefined');\r\n                    console.log(`\uD83D\uDD0D [${requestId}] Available listings:`, availableListings.length > 0 ? availableListings.map((l: any) => ({\r\n                      id: l.id,\r\n                      providerId: l.providerId,\r\n                      providerName: l.providerName,\r\n                      poolId: l.poolId,\r\n                      tokenSymbol: l.tokenSymbol,\r\n                      baseToken: l.baseToken,\r\n                      price: l.price\r\n                    })) : '[]');\r\n                    console.log(`\uD83D\uDD0D [${requestId}] ========================================`);\r\n                    \r\n                    // Check if we can use existing selectedListing2 from previous llmResponse\r\n                    if (availableListings.length === 0) {\r\n                      console.warn(`\u26A0\uFE0F [${requestId}] No listings available for LLM formatting`);\r\n                      console.warn(`\u26A0\uFE0F [${requestId}] Context state:`, {\r\n                        hasListings: !!updatedContext.listings,\r\n                        listingsLength: updatedContext.listings?.length || 0,\r\n                        hasQueryResult: !!updatedContext.queryResult,\r\n                        serviceType: formatServiceType,\r\n                        hasExistingLlmResponse: !!updatedContext.llmResponse,\r\n                        hasExistingSelectedListing: !!updatedContext.llmResponse?.selectedListing,\r\n                        hasExistingSelectedListing2: !!updatedContext.llmResponse?.selectedListing2\r\n                      });\r\n                      \r\n                      // Try to use existing selectedListing2 from previous llmResponse\r\n                      if (updatedContext.llmResponse?.selectedListing2) {\r\n                        console.log(`\u2705 [${requestId}] Using existing selectedListing2 from previous llmResponse`);\r\n                        updatedContext.selectedListing = updatedContext.llmResponse.selectedListing2;\r\n                        updatedContext.selectedListing2 = updatedContext.llmResponse.selectedListing2; // CRITICAL: Store in context\r\n                        updatedContext.llmResponse.selectedListing = updatedContext.llmResponse.selectedListing2;\r\n                        \r\n                        actionResult = {\r\n                          llmResponse: updatedContext.llmResponse,\r\n                          listings: [],\r\n                          iGasCost: updatedContext.llmResponse.iGasCost || 0,\r\n                          currentIGas: updatedContext.llmResponse.iGasCost || 0\r\n                        };\r\n                        \r\n                        console.log(`\u2705 [${requestId}] Reused selectedListing2:`, {\r\n                          hasSelectedListing: !!actionResult.llmResponse.selectedListing,\r\n                          hasSelectedListing2: !!actionResult.llmResponse.selectedListing2,\r\n                          hasContextSelectedListing2: !!updatedContext.selectedListing2,\r\n                          poolId: (actionResult.llmResponse.selectedListing as any)?.poolId,\r\n                          tokenSymbol: (actionResult.llmResponse.selectedListing as any)?.tokenSymbol\r\n                        });\r\n                        break;\r\n                      } else if (updatedContext.llmResponse?.selectedListing) {\r\n                        console.log(`\u2705 [${requestId}] Using existing selectedListing from previous llmResponse`);\r\n                        updatedContext.selectedListing = updatedContext.llmResponse.selectedListing;\r\n                        updatedContext.selectedListing2 = updatedContext.llmResponse.selectedListing; // CRITICAL: Also set as selectedListing2\r\n                        updatedContext.llmResponse.selectedListing2 = updatedContext.llmResponse.selectedListing; // Also set in llmResponse\r\n                        \r\n                        actionResult = {\r\n                          llmResponse: updatedContext.llmResponse,\r\n                          listings: [],\r\n                          iGasCost: updatedContext.llmResponse.iGasCost || 0,\r\n                          currentIGas: updatedContext.llmResponse.iGasCost || 0\r\n                        };\r\n                        \r\n                        console.log(`\u2705 [${requestId}] Reused selectedListing:`, {\r\n                          hasSelectedListing: !!actionResult.llmResponse.selectedListing,\r\n                          hasSelectedListing2: !!actionResult.llmResponse.selectedListing2,\r\n                          hasContextSelectedListing2: !!updatedContext.selectedListing2,\r\n                          poolId: (actionResult.llmResponse.selectedListing as any)?.poolId,\r\n                          tokenSymbol: (actionResult.llmResponse.selectedListing as any)?.tokenSymbol\r\n                        });\r\n                        break;\r\n                      } else if (updatedContext.selectedListing) {\r\n                        console.log(`\u2705 [${requestId}] Using existing selectedListing from context`);\r\n                        // Create a minimal llmResponse from existing selectedListing\r\n                        const existingLlmResponse: LLMResponse = {\r\n                          message: \"Using previously selected listing\",\r\n                          listings: [],\r\n                          selectedListing: updatedContext.selectedListing,\r\n                          selectedListing2: updatedContext.selectedListing,\r\n                          iGasCost: updatedContext.iGasCost || 0\r\n                        };\r\n                        updatedContext.llmResponse = existingLlmResponse;\r\n                        updatedContext.selectedListing2 = updatedContext.selectedListing; // CRITICAL: Store in context\r\n                        \r\n                        actionResult = {\r\n                          llmResponse: existingLlmResponse,\r\n                          listings: [],\r\n                          iGasCost: existingLlmResponse.iGasCost,\r\n                          currentIGas: existingLlmResponse.iGasCost\r\n                        };\r\n                        \r\n                        console.log(`\u2705 [${requestId}] Created llmResponse from existing selectedListing:`, {\r\n                          hasSelectedListing: !!actionResult.llmResponse.selectedListing,\r\n                          hasSelectedListing2: !!actionResult.llmResponse.selectedListing2,\r\n                          hasContextSelectedListing2: !!updatedContext.selectedListing2,\r\n                          poolId: (actionResult.llmResponse.selectedListing as any)?.poolId,\r\n                          tokenSymbol: (actionResult.llmResponse.selectedListing as any)?.tokenSymbol\r\n                        });\r\n                        break;\r\n                      }\r\n                      \r\n                      // If we get here, we have no listings and no existing selectedListing\r\n                      // Create a helpful \"no results\" response instead of throwing an error\r\n                      console.warn(`\u26A0\uFE0F [${requestId}] No listings available and no existing selectedListing/selectedListing2 to use - creating \"no results\" response`);\r\n                      const userInput = updatedContext.userInput || \"your request\";\r\n                      const serviceType = formatServiceType || updatedContext.serviceType || updatedContext.queryResult?.query?.serviceType || \"service\";\r\n                      \r\n                      const noResultsResponse: LLMResponse = {\r\n                        message: `I couldn't find any ${serviceType} options matching \"${userInput}\". Please try a different search term or check back later.`,\r\n                        listings: [],\r\n                        selectedListing: null,\r\n                        selectedListing2: null,\r\n                        iGasCost: 0 // No LLM cost for no-results response\r\n                      };\r\n                      \r\n                      updatedContext.llmResponse = noResultsResponse;\r\n                      updatedContext.iGasCost = 0;\r\n                      \r\n                      actionResult = {\r\n                        llmResponse: noResultsResponse,\r\n                        listings: [],\r\n                        iGasCost: 0,\r\n                        currentIGas: 0\r\n                      };\r\n                      \r\n                      console.log(`\u2705 [${requestId}] Created \"no results\" response for empty listings`);\r\n                      break; // Exit the block instead of throwing\r\n                    }\r\n                    \r\n                    // Use CLONED formatResponseWithOpenAI function directly (not imported)\r\n                    const formatFn = ENABLE_OPENAI ? formatResponseWithOpenAI_CLONED : formatResponseWithDeepSeek;\r\n                    console.log(`\uD83D\uDD0D [${requestId}] About to call formatFn: ${ENABLE_OPENAI ? 'formatResponseWithOpenAI_CLONED' : 'formatResponseWithDeepSeek'}`);\r\n                    \r\n                    // CRITICAL: Log detailed information about listings being passed to LLM\r\n                    console.log(`\uD83D\uDD0D [${requestId}] ========================================`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}] LISTINGS BEING PASSED TO LLM:`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - listingsCount: ${availableListings.length}`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - serviceType: ${updatedContext.serviceType || 'N/A'}`);\r\n                    if (availableListings.length > 0) {\r\n                      const firstListing = availableListings[0] as any;\r\n                      console.log(`\uD83D\uDD0D [${requestId}]   - First listing keys:`, Object.keys(firstListing));\r\n                      console.log(`\uD83D\uDD0D [${requestId}]   - First listing (full):`, JSON.stringify(firstListing, null, 2));\r\n                      console.log(`\uD83D\uDD0D [${requestId}]   - Is DEX pool:`, !!(firstListing?.poolId || firstListing?.tokenSymbol));\r\n                      console.log(`\uD83D\uDD0D [${requestId}]   - Has poolId: ${!!firstListing?.poolId}, has tokenSymbol: ${!!firstListing?.tokenSymbol}, has baseToken: ${!!firstListing?.baseToken}`);\r\n                    } else {\r\n                      console.warn(`\u26A0\uFE0F [${requestId}]   - WARNING: No listings available to pass to LLM!`);\r\n                    }\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - userInput: ${updatedContext.userInput?.substring(0, 100) || 'N/A'}`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - filters:`, JSON.stringify(updatedContext.queryResult?.query?.filters || {}));\r\n                    console.log(`\uD83D\uDD0D [${requestId}] ========================================`);\r\n                    \r\n                    console.log(`\uD83D\uDD0D [${requestId}] Calling formatFn with:`, {\r\n                      listingsCount: availableListings.length,\r\n                      userInput: updatedContext.userInput?.substring(0, 50) || 'N/A',\r\n                      filters: updatedContext.queryResult?.query?.filters\r\n                    });\r\n                    \r\n                    // Ensure userInput is not empty - use fallback if needed\r\n                    const userInputForFormatting = updatedContext.userInput?.trim() || \r\n                      updatedContext.input?.trim() || \r\n                      `Find ${processedAction.serviceType || updatedContext.serviceType || updatedContext.queryResult?.serviceType || serviceType || 'movie'} service options`;\r\n                    \r\n                    if (!updatedContext.userInput?.trim() && !updatedContext.input?.trim()) {\r\n                      console.warn(`\u26A0\uFE0F [${requestId}] userInput is empty, using fallback: \"${userInputForFormatting}\"`);\r\n                    }\r\n                    \r\n                    const llmResponse = await formatFn(\r\n                      availableListings,\r\n                      userInputForFormatting,\r\n                      {\r\n                        ...(updatedContext.queryResult?.query?.filters || {}),\r\n                        serviceType: processedAction.serviceType || updatedContext.serviceType || updatedContext.queryResult?.serviceType || serviceType || 'movie'\r\n                      }\r\n                    );\r\n                    \r\n                    console.log(`\uD83D\uDD0D [${requestId}] ========================================`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}] formatFn returned, llmResponse received`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}] llmResponse keys:`, Object.keys(llmResponse));\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - hasSelectedListing: ${!!llmResponse.selectedListing}`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - hasSelectedListing2: ${!!llmResponse.selectedListing2}`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - selectedListingType: ${typeof llmResponse.selectedListing}`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - selectedListing2Type: ${typeof llmResponse.selectedListing2}`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - selectedListingValue:`, llmResponse.selectedListing ? JSON.stringify(llmResponse.selectedListing).substring(0, 200) : 'NULL/UNDEFINED');\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - selectedListing2Value:`, llmResponse.selectedListing2 ? JSON.stringify(llmResponse.selectedListing2).substring(0, 200) : 'NULL/UNDEFINED');\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - selectedListingKeys:`, llmResponse.selectedListing ? Object.keys(llmResponse.selectedListing).join(', ') : 'N/A');\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - selectedListing2Keys:`, llmResponse.selectedListing2 ? Object.keys(llmResponse.selectedListing2).join(', ') : 'N/A');\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - listingsCount: ${llmResponse.listings?.length || 0}`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - message: ${llmResponse.message?.substring(0, 100) || 'N/A'}`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}]   - iGasCost: ${llmResponse.iGasCost}`);\r\n                    \r\n                    // DEBUG: Console out FULL LLM response\r\n                    console.log(`\uD83D\uDD0D [${requestId}] ========================================`);\r\n                    console.log(`\uD83D\uDD0D [${requestId}] FULL LLM RESPONSE OBJECT:`);\r\n                    console.log(JSON.stringify(llmResponse, null, 2));\r\n                    console.log(`\uD83D\uDD0D [${requestId}] ========================================`);\r\n                    \r\n                    // ========================================\r\n                    // ========================================\r\n                    // CRITICAL DEBUG: selectedListing2 INSPECTION\r\n                    // ========================================\r\n                    // ========================================\r\n                    console.log(`\\n\\n\\n`);\r\n                    console.log(`\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557`);\r\n                    console.log(`\u2551                    \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D selectedListing2 DEBUG \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D                        \u2551`);\r\n                    console.log(`\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255D`);\r\n                    console.log(`[${requestId}] ========================================`);\r\n                    console.log(`[${requestId}] SELECTEDLISTING2 DETAILED INSPECTION:`);\r\n                    console.log(`[${requestId}]   - llmResponse.selectedListing2 exists: ${!!llmResponse.selectedListing2}`);\r\n                    console.log(`[${requestId}]   - llmResponse.selectedListing2 type: ${typeof llmResponse.selectedListing2}`);\r\n                    console.log(`[${requestId}]   - llmResponse.selectedListing2 is array: ${Array.isArray(llmResponse.selectedListing2)}`);\r\n                    if (llmResponse.selectedListing2) {\r\n                      console.log(`[${requestId}]   - llmResponse.selectedListing2 (FULL):`, JSON.stringify(llmResponse.selectedListing2, null, 2));\r\n                      if (Array.isArray(llmResponse.selectedListing2)) {\r\n                        console.log(`[${requestId}]   - selectedListing2 array length: ${llmResponse.selectedListing2.length}`);\r\n                        if (llmResponse.selectedListing2.length > 0) {\r\n                          console.log(`[${requestId}]   - First item in selectedListing2 array:`, JSON.stringify(llmResponse.selectedListing2[0], null, 2));\r\n                        }\r\n                      } else {\r\n                        console.log(`[${requestId}]   - selectedListing2 keys:`, Object.keys(llmResponse.selectedListing2));\r\n                      }\r\n                    } else {\r\n                      console.log(`[${requestId}]   - \u26A0\uFE0F\u26A0\uFE0F\u26A0\uFE0F WARNING: llmResponse.selectedListing2 is NULL/UNDEFINED! \u26A0\uFE0F\u26A0\uFE0F\u26A0\uFE0F`);\r\n                    }\r\n                    console.log(`[${requestId}] ========================================`);\r\n                    console.log(`\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557`);\r\n                    console.log(`\u2551                    \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D END selectedListing2 DEBUG \uD83D\uDD0D\uD83D\uDD0D\uD83D\uDD0D                    \u2551`);\r\n                    console.log(`\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255D`);\r\n                    console.log(`\\n\\n\\n`);\r\n                    \r\n                    // Store llmResponse in context (preserve original object)\r\n                    updatedContext.llmResponse = llmResponse;\r\n                    updatedContext.iGasCost = llmResponse.iGasCost;\r\n                    \r\n                    // Use llmResponse.selectedListing if available\r\n                    if (llmResponse.selectedListing) {\r\n                      updatedContext.selectedListing = llmResponse.selectedListing;\r\n                      // CRITICAL: Also store selectedListing2 directly in context\r\n                      if (llmResponse.selectedListing2) {\r\n                        updatedContext.selectedListing2 = llmResponse.selectedListing2;\r\n                        console.log(`\u2705 [${requestId}] Using selectedListing and selectedListing2 from llmResponse`);\r\n                      } else {\r\n                        // If selectedListing2 is not set, use selectedListing as selectedListing2\r\n                        updatedContext.selectedListing2 = llmResponse.selectedListing;\r\n                        llmResponse.selectedListing2 = llmResponse.selectedListing;\r\n                        console.log(`\u2705 [${requestId}] Using selectedListing from llmResponse, also set as selectedListing2`);\r\n                      }\r\n                    } else if (availableListings.length > 0) {\r\n                      // Fallback: use first listing\r\n                      console.warn(`\u26A0\uFE0F [${requestId}] llmResponse.selectedListing is null/undefined, falling back to first listing`);\r\n                      const fallbackListing = availableListings[0];\r\n                      updatedContext.selectedListing = fallbackListing;\r\n                      updatedContext.selectedListing2 = fallbackListing; // Also set selectedListing2\r\n                      llmResponse.selectedListing = fallbackListing;\r\n                      llmResponse.selectedListing2 = fallbackListing;\r\n                      console.log(`\u2705 [${requestId}] Set fallback selectedListing and selectedListing2:`, {\r\n                        id: fallbackListing.id,\r\n                        providerId: fallbackListing.providerId,\r\n                        poolId: (fallbackListing as any)?.poolId,\r\n                        tokenSymbol: (fallbackListing as any)?.tokenSymbol\r\n                      });\r\n                    } else {\r\n                      throw new Error(\"No listings available and LLM didn't return selectedListing\");\r\n                    }\r\n                    \r\n                    // CRITICAL: Use listings from llmResponse if available, otherwise use availableListings\r\n                    // This ensures we preserve any filtering/formatting done by LLM\r\n                    const finalListings = (llmResponse.listings && Array.isArray(llmResponse.listings) && llmResponse.listings.length > 0) \r\n                      ? llmResponse.listings \r\n                      : availableListings;\r\n                    \r\n                    // Update updatedContext.listings to ensure it's available for next steps\r\n                    updatedContext.listings = finalListings;\r\n                    \r\n                    actionResult = {\r\n                      llmResponse: llmResponse,\r\n                      listings: finalListings, // Use final listings (from LLM or original)\r\n                      iGasCost: llmResponse.iGasCost,\r\n                      currentIGas: llmResponse.iGasCost,\r\n                      // CRITICAL: Also include selectedListing directly in actionResult so it's merged into context\r\n                      selectedListing: updatedContext.selectedListing,\r\n                      selectedListing2: updatedContext.selectedListing2\r\n                    };\r\n                    \r\n                    console.log(`\u2705 [${requestId}] Set listings in actionResult: ${finalListings.length} listings`);\r\n                    console.log(`\u2705 [${requestId}] Updated updatedContext.listings: ${updatedContext.listings?.length || 0} listings`);\r\n                    \r\n                    console.log(`\u2705 [${requestId}] ========================================`);\r\n                    console.log(`\u2705 [${requestId}] FINAL VERIFICATION:`);\r\n                    console.log(`\u2705 [${requestId}]   - actionResult.llmResponse.selectedListing: ${actionResult.llmResponse.selectedListing ? 'SET' : 'NOT SET'}`);\r\n                    console.log(`\u2705 [${requestId}]   - actionResult.llmResponse.selectedListing2: ${actionResult.llmResponse.selectedListing2 ? 'SET' : 'NOT SET'}`);\r\n                    console.log(`\u2705 [${requestId}]   - updatedContext.selectedListing: ${updatedContext.selectedListing ? 'SET' : 'NOT SET'}`);\r\n                    console.log(`\u2705 [${requestId}]   - updatedContext.selectedListing2: ${updatedContext.selectedListing2 ? 'SET' : 'NOT SET'}`);\r\n                    console.log(`\u2705 [${requestId}] ========================================`);\r\n                  } else {\r\n                    // Other unmatched actions\r\n                    console.warn(`\u26A0\uFE0F [${requestId}] Unmatched action type in default case: \"${action.type}\"`);\r\n                    console.warn(`\u26A0\uFE0F [${requestId}] This action type is not handled by any case in the switch statement`);\r\n                    console.warn(`\u26A0\uFE0F [${requestId}] Available action types should include: llm_format_response, query_dex_pools, etc.`);\r\n                    \r\n                    // For unmatched actions, throw an error so it can be caught and handled by error_handler\r\n                    throw new Error(`Unknown action type: ${action.type}. This action is not implemented in the workflow execution handler.`);\r\n                  }\r\n              }\r\n\r\n              // Merge action result into context\r\n              Object.assign(updatedContext, actionResult);\r\n              \r\n              // CRITICAL: Ensure listings are preserved after action execution\r\n              // If actionResult has listings, use them; otherwise keep existing listings\r\n              if (actionResult.listings && Array.isArray(actionResult.listings) && actionResult.listings.length > 0) {\r\n                updatedContext.listings = actionResult.listings;\r\n                console.log(`   \u2705 [${requestId}] Preserved ${actionResult.listings.length} listings from actionResult`);\r\n              } else if (actionResult.llmResponse?.listings && Array.isArray(actionResult.llmResponse.listings) && actionResult.llmResponse.listings.length > 0) {\r\n                updatedContext.listings = actionResult.llmResponse.listings;\r\n                console.log(`   \u2705 [${requestId}] Preserved ${actionResult.llmResponse.listings.length} listings from actionResult.llmResponse`);\r\n              }\r\n              \r\n              console.log(`   \uD83D\uDCCB [${requestId}] After ${action.type}: listings=${updatedContext.listings?.length || 0}, llmResponse=${!!updatedContext.llmResponse}, selectedListing=${!!updatedContext.selectedListing}`);\r\n\r\n              executedActions.push({\r\n                type: action.type,\r\n                success: true,\r\n                result: actionResult\r\n              });\r\n\r\n            } catch (actionError: any) {\r\n              console.error(`   \u274C [${requestId}] Action failed: ${action.type}`, actionError.message);\r\n              executedActions.push({\r\n                type: action.type,\r\n                success: false,\r\n                error: actionError.message\r\n              });\r\n              throw actionError; // Fail the entire step if any action fails\r\n            }\r\n          }\r\n        }\r\n\r\n        // Process WebSocket events\r\n        if (step.websocketEvents) {\r\n          for (const event of step.websocketEvents) {\r\n            const processedEvent = replaceTemplateVariables(event, updatedContext);\r\n            // Attach execution context so UIs can correctly scope events (chat history, multi-execution)\r\n            processedEvent.data = processedEvent.data || {};\r\n            processedEvent.data.executionId = executionId;\r\n            processedEvent.data.serviceType = serviceType;\r\n            processedEvent.data.stepId = stepId;\r\n            // Ensure timestamp is always a valid number\r\n            if (!processedEvent.timestamp || isNaN(processedEvent.timestamp)) {\r\n              processedEvent.timestamp = Date.now();\r\n            }\r\n            events.push(processedEvent);\r\n\r\n            // Debug logging for iGas events\r\n            if (processedEvent.type === 'igas') {\r\n              console.log(`   \u26FD [${requestId}] iGas event data:`, processedEvent.data);\r\n              console.log(`   \u26FD [${requestId}] iGas value type:`, typeof processedEvent.data?.igas);\r\n              console.log(`   \u26FD [${requestId}] Full processed iGas event:`, JSON.stringify(processedEvent, null, 2));\r\n            }\r\n\r\n            // Broadcast the event via WebSocket\r\n            try {\r\n              broadcastEvent(processedEvent);\r\n              console.log(`   \uD83D\uDCE1 [${requestId}] Broadcast event: ${event.type}`);\r\n            } catch (broadcastError) {\r\n              console.warn(`   \u26A0\uFE0F [${requestId}] Failed to broadcast event: ${event.type}`, broadcastError);\r\n            }\r\n          }\r\n        }\r\n\r\n        // Apply step outputs\r\n        if (step.outputs) {\r\n          const processedOutputs = replaceTemplateVariables(step.outputs, updatedContext);\r\n          Object.assign(updatedContext, processedOutputs);\r\n        }\r\n\r\n        // Determine next step based on transitions\r\n        let nextStepId: string | null = null;\r\n        const transitions = workflow.transitions.filter((t: any) => t.from === stepId);\r\n\r\n        console.log(`   \uD83D\uDD0D [${requestId}] ========================================`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] EVALUATING TRANSITIONS FROM STEP: ${stepId}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] ========================================`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Context keys:`, Object.keys(updatedContext));\r\n        console.log(`   \uD83D\uDD0D [${requestId}] updatedContext.listings: ${updatedContext.listings?.length || 0} (${updatedContext.listings ? 'EXISTS' : 'MISSING'})`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] updatedContext.llmResponse: ${!!updatedContext.llmResponse}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] updatedContext.llmResponse.listings: ${updatedContext.llmResponse?.listings?.length || 0} (${updatedContext.llmResponse?.listings ? 'EXISTS' : 'MISSING'})`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] llmResponse.selectedListing:`, updatedContext.llmResponse?.selectedListing);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] llmResponse.selectedListing2:`, updatedContext.llmResponse?.selectedListing2);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Found ${transitions.length} transitions from ${stepId}`);\r\n\r\n        for (const transition of transitions) {\r\n          // Evaluate condition\r\n          let conditionMet = false;\r\n          if (transition.condition === \"always\") {\r\n            conditionMet = true;\r\n          } else if (transition.condition) {\r\n            // Replace template variables in condition\r\n            const processedCondition = replaceTemplateVariables(transition.condition, updatedContext);\r\n            \r\n            console.log(`   \uD83D\uDD0D [${requestId}] Evaluating transition: ${stepId} -> ${transition.to}`);\r\n            console.log(`   \uD83D\uDD0D [${requestId}]   - Original condition: ${transition.condition}`);\r\n            console.log(`   \uD83D\uDD0D [${requestId}]   - Processed condition: ${processedCondition}`);\r\n            if (transition.condition.includes('listings')) {\r\n              console.log(`   \uD83D\uDD0D [${requestId}]   - Condition references listings, checking context:`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]     - updatedContext.listings: ${updatedContext.listings?.length || 0}`);\r\n              console.log(`   \uD83D\uDD0D [${requestId}]     - updatedContext.llmResponse?.listings: ${updatedContext.llmResponse?.listings?.length || 0}`);\r\n            }\r\n\r\n            // Check if the processed condition is different from the original\r\n            // If it still contains {{ }}, the variable doesn't exist\r\n            if (processedCondition === transition.condition && processedCondition.includes('{{')) {\r\n              // Template variable doesn't exist in context\r\n              conditionMet = false;\r\n            } else {\r\n              // Template was replaced, check if result is truthy\r\n              // For conditions like \"{{llmResponse.selectedListing}}\", check if the result exists\r\n              conditionMet = !!processedCondition;\r\n            }\r\n          }\r\n\r\n          console.log(`   \uD83D\uDD00 [${requestId}] Transition condition \"${transition.condition}\" -> \"${transition.condition === \"always\" ? \"always\" : replaceTemplateVariables(transition.condition, updatedContext)}\" = ${conditionMet ? \"TRUE\" : \"FALSE\"} -> ${transition.to}`);\r\n\r\n          if (conditionMet) {\r\n            nextStepId = transition.to;\r\n            break;\r\n          }\r\n        }\r\n\r\n        console.log(`   \u2705 [${requestId}] ========================================`);\r\n        console.log(`   \u2705 [${requestId}] \u2705 STEP EXECUTION COMPLETE`);\r\n        console.log(`   \u2705 [${requestId}] Step ID: ${stepId}`);\r\n        console.log(`   \u2705 [${requestId}] Step Name: ${step.name}`);\r\n        console.log(`   \u2705 [${requestId}] Actions Executed: ${executedActions.length}`);\r\n        console.log(`   \u2705 [${requestId}] Next Step ID: ${nextStepId || 'NONE'}`);\r\n        if (nextStepId) {\r\n          const nextStep = workflow.steps.find((s: any) => s.id === nextStepId);\r\n          console.log(`   \u2705 [${requestId}] Next Step Name: ${nextStep?.name || 'N/A'}`);\r\n          console.log(`   \u2705 [${requestId}] Next Step Component: ${nextStep?.component || 'N/A'}`);\r\n        }\r\n        console.log(`   \u2705 [${requestId}] Should Auto-Continue: ${nextStepId && step.type !== 'decision' ? true : false}`);\r\n        console.log(`   \u2705 [${requestId}] ========================================`);\r\n\r\n        // Store context for potential continuation\r\n        // CRITICAL: Preserve full execution object structure (workflow, context, currentStep, etc.)\r\n        // Don't overwrite with just context - merge context into existing execution\r\n        if (!(global as any).workflowExecutions) {\r\n          (global as any).workflowExecutions = new Map();\r\n        }\r\n        // Get workflowExecutions from global (ensure it's accessible in this scope)\r\n        const workflowExecutionsForUpdate = (global as any).workflowExecutions as Map<string, any>;\r\n        const existingExecution = workflowExecutionsForUpdate.get(executionId);\r\n        \r\n        if (existingExecution && existingExecution.workflow) {\r\n          // Preserve full execution structure - just update context\r\n          existingExecution.context = updatedContext;\r\n          existingExecution.currentStep = nextStepId || existingExecution.currentStep;\r\n          workflowExecutionsForUpdate.set(executionId, existingExecution);\r\n        } else {\r\n          // Fallback: if no existing execution, create minimal structure\r\n          // This shouldn't happen if FlowWiseService is used, but handle gracefully\r\n          console.warn(`\u26A0\uFE0F [${requestId}] No existing execution found for ${executionId}, creating minimal structure`);\r\n          workflowExecutionsForUpdate.set(executionId, {\r\n            executionId,\r\n            workflow,\r\n            context: updatedContext,\r\n            currentStep: nextStepId || stepId,\r\n            history: []\r\n          });\r\n        }\r\n\r\n        // CRITICAL: Final check - ensure listings are in updatedContext before returning\r\n        // This is especially important for decision steps where listings come from previous step\r\n        if ((!updatedContext.listings || updatedContext.listings.length === 0) && updatedContext.llmResponse?.listings && Array.isArray(updatedContext.llmResponse.listings) && updatedContext.llmResponse.listings.length > 0) {\r\n          updatedContext.listings = updatedContext.llmResponse.listings;\r\n          console.log(`   \uD83D\uDD04 [${requestId}] Final check: Populated updatedContext.listings from llmResponse (${updatedContext.llmResponse.listings.length} listings) before returning response`);\r\n        }\r\n        \r\n        console.log(`   \uD83D\uDCE4 [${requestId}] ========================================`);\r\n        console.log(`   \uD83D\uDCE4 [${requestId}] RETURNING RESPONSE FOR STEP: ${stepId}`);\r\n        console.log(`   \uD83D\uDCE4 [${requestId}] ========================================`);\r\n        console.log(`   \uD83D\uDCE4 [${requestId}] updatedContext.listings: ${updatedContext.listings?.length || 0} (${updatedContext.listings ? 'EXISTS' : 'MISSING'})`);\r\n        console.log(`   \uD83D\uDCE4 [${requestId}] updatedContext.llmResponse?.listings: ${updatedContext.llmResponse?.listings?.length || 0} (${updatedContext.llmResponse?.listings ? 'EXISTS' : 'MISSING'})`);\r\n        console.log(`   \uD83D\uDCE4 [${requestId}] updatedContext keys:`, Object.keys(updatedContext));\r\n        if (updatedContext.listings && Array.isArray(updatedContext.listings) && updatedContext.listings.length > 0) {\r\n          console.log(`   \uD83D\uDCE4 [${requestId}] First listing in response:`, JSON.stringify(updatedContext.listings[0], null, 2).substring(0, 500));\r\n        }\r\n        console.log(`   \uD83D\uDCE4 [${requestId}] nextStepId: ${nextStepId}`);\r\n        console.log(`   \uD83D\uDCE4 [${requestId}] events count: ${events.length}`);\r\n        if (events.length > 0 && events[0].data?.options) {\r\n          console.log(`   \uD83D\uDCE4 [${requestId}] First event options count: ${Array.isArray(events[0].data.options) ? events[0].data.options.length : 'N/A'}`);\r\n        }\r\n        console.log(`   \uD83D\uDCE4 [${requestId}] ========================================`);\r\n        \r\n        sendResponse(200, {\r\n          success: true,\r\n          message: `Step ${stepId} executed atomically`,\r\n          result: {\r\n            stepId,\r\n            executedActions,\r\n            events,\r\n            updatedContext,\r\n            nextStepId,\r\n            shouldAutoContinue: nextStepId && step.type !== 'decision' ? true : false\r\n          }\r\n        });\r\n\r\n        // CRITICAL: Auto-continue workflow for non-decision steps with \"always\" transitions\r\n        // This ensures the workflow automatically progresses from ledger_create_entry to cashier_process_payment\r\n        // The cashier step MUST execute to complete the ledger entry (status: pending -> processed)\r\n        // This runs after executeStepAtomically is defined (see below after the function definition)\r\n        const shouldAutoContinue = nextStepId && step.type !== 'decision';\r\n        const autoContinueStepId = shouldAutoContinue ? nextStepId : null;\r\n        const autoContinueStep = shouldAutoContinue ? workflow.steps.find((s: any) => s.id === nextStepId) : null;\r\n        const hasAlwaysTransition = shouldAutoContinue && autoContinueStep ? \r\n          workflow.transitions.filter((t: any) => t.from === stepId && t.to === nextStepId)\r\n            .some((t: any) => t.condition === 'always' || !t.condition) : false;\r\n\r\n        // CRITICAL: Auto-continue workflow for non-decision steps with \"always\" transitions\r\n        // This ensures the workflow automatically progresses from ledger_create_entry to cashier_process_payment\r\n        // The cashier step MUST execute to complete the ledger entry (status: pending -> processed)\r\n        // Store auto-continuation info for later execution (after executeStepAtomically is defined)\r\n        console.log(`   \uD83D\uDD0D [${requestId}] ========================================`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] \uD83D\uDD0D CHECKING AUTO-CONTINUATION CONDITIONS`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] hasAlwaysTransition: ${hasAlwaysTransition}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] autoContinueStep: ${autoContinueStep ? autoContinueStep.name : 'null'}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] autoContinueStepId: ${autoContinueStepId}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] stepId: ${stepId}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] nextStepId: ${nextStepId}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] ========================================`);\r\n        \r\n        const autoContinueInfo = hasAlwaysTransition && autoContinueStep && autoContinueStep.type !== 'decision' && autoContinueStepId ? {\r\n          stepId: autoContinueStepId,\r\n          step: autoContinueStep,\r\n          context: updatedContext,\r\n          workflow: workflow,\r\n          executionId: executionId\r\n        } : null;\r\n\r\n        console.log(`   \uD83D\uDD0D [${requestId}] autoContinueInfo: ${autoContinueInfo ? 'SET' : 'NULL'}`);\r\n        if (autoContinueInfo) {\r\n          console.log(`   \uD83D\uDD0D [${requestId}] autoContinueInfo.stepId: ${autoContinueInfo.stepId}`);\r\n          console.log(`   \uD83D\uDD0D [${requestId}] autoContinueInfo.step.name: ${autoContinueInfo.step.name}`);\r\n        }\r\n\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Error executing step atomically:`, error.message);\r\n        \r\n        // Check if step has errorHandling configuration\r\n        if (step.errorHandling && step.errorHandling.onError) {\r\n          console.log(`   \u26A0\uFE0F [${requestId}] Step has errorHandling, transitioning to: ${step.errorHandling.onError}`);\r\n          \r\n          // Set error object in context with component and message\r\n          updatedContext.error = {\r\n            component: step.component || 'unknown',\r\n            message: error.message,\r\n            stepId: stepId,\r\n            stepName: step.name,\r\n            error: error.message,\r\n            stack: error.stack\r\n          };\r\n          \r\n          console.log(`   \u274C [${requestId}] ========================================`);\r\n          console.log(`   \u274C [${requestId}] ERROR OCCURRED IN STEP: ${stepId} (${step.name})`);\r\n          console.log(`   \u274C [${requestId}] Component: ${step.component || 'unknown'}`);\r\n          console.log(`   \u274C [${requestId}] Error Message: ${error.message}`);\r\n          console.log(`   \u274C [${requestId}] Error Stack: ${error.stack?.substring(0, 200) || 'N/A'}`);\r\n          console.log(`   \u274C [${requestId}] Error object set in context:`, JSON.stringify(updatedContext.error, null, 2));\r\n          console.log(`   \u274C [${requestId}] Context keys after setting error:`, Object.keys(updatedContext));\r\n          console.log(`   \u274C [${requestId}] Transitioning to error handler: ${step.errorHandling.onError}`);\r\n          console.log(`   \u274C [${requestId}] ========================================`);\r\n          \r\n          // Process errorEvents if defined\r\n          if (step.errorHandling.errorEvents) {\r\n            for (const event of step.errorHandling.errorEvents) {\r\n              const processedEvent = replaceTemplateVariables(event, updatedContext);\r\n              // Ensure timestamp is always a valid number\r\n              if (!processedEvent.timestamp || isNaN(processedEvent.timestamp)) {\r\n                processedEvent.timestamp = Date.now();\r\n              }\r\n              events.push(processedEvent);\r\n              \r\n              // Broadcast the error event via WebSocket\r\n              try {\r\n                broadcastEvent(processedEvent);\r\n                console.log(`   \uD83D\uDCE1 [${requestId}] Broadcast error event: ${event.type}`);\r\n              } catch (broadcastError) {\r\n                console.warn(`   \u26A0\uFE0F [${requestId}] Failed to broadcast error event: ${event.type}`, broadcastError);\r\n              }\r\n            }\r\n          }\r\n          \r\n          // Find the error_handler step\r\n          const errorHandlerStep = workflow.steps.find((s: any) => s.id === step.errorHandling.onError);\r\n          if (errorHandlerStep) {\r\n            console.log(`   \uD83D\uDD04 [${requestId}] Transitioning to error handler step: ${errorHandlerStep.id} (${errorHandlerStep.name})`);\r\n            \r\n            // Process WebSocket events for error handler step\r\n            if (errorHandlerStep.websocketEvents) {\r\n              for (const event of errorHandlerStep.websocketEvents) {\r\n                const processedEvent = replaceTemplateVariables(event, updatedContext);\r\n                // Ensure timestamp is always a valid number\r\n                if (!processedEvent.timestamp || isNaN(processedEvent.timestamp)) {\r\n                  processedEvent.timestamp = Date.now();\r\n                }\r\n                events.push(processedEvent);\r\n                \r\n                // Broadcast the event via WebSocket\r\n                try {\r\n                  broadcastEvent(processedEvent);\r\n                  console.log(`   \uD83D\uDCE1 [${requestId}] Broadcast event: ${event.type}`);\r\n                } catch (broadcastError) {\r\n                  console.warn(`   \u26A0\uFE0F [${requestId}] Failed to broadcast event: ${event.type}`, broadcastError);\r\n                }\r\n              }\r\n            }\r\n            \r\n            // Store context for error handler step\r\n            if (!(global as any).workflowExecutions) {\r\n              (global as any).workflowExecutions = new Map();\r\n            }\r\n            const workflowExecutions = (global as any).workflowExecutions as Map<string, any>;\r\n            const existingExecution = workflowExecutions.get(executionId);\r\n            \r\n            if (existingExecution && existingExecution.workflow) {\r\n              existingExecution.context = updatedContext;\r\n              existingExecution.currentStep = step.errorHandling.onError;\r\n              workflowExecutions.set(executionId, existingExecution);\r\n            } else {\r\n              workflowExecutions.set(executionId, {\r\n                executionId,\r\n                workflow,\r\n                context: updatedContext,\r\n                currentStep: step.errorHandling.onError,\r\n                history: []\r\n              });\r\n            }\r\n            \r\n            sendResponse(200, {\r\n              success: true,\r\n              message: `Step ${stepId} failed, transitioned to error handler`,\r\n              result: {\r\n                stepId: step.errorHandling.onError,\r\n                errorStepId: stepId,\r\n                error: error.message,\r\n                events,\r\n                updatedContext,\r\n                nextStepId: null,\r\n                shouldAutoContinue: false\r\n              }\r\n            });\r\n            return;\r\n          } else {\r\n            console.error(`   \u274C [${requestId}] Error handler step not found: ${step.errorHandling.onError}`);\r\n          }\r\n        }\r\n        \r\n        // If no error handling, send error response\r\n        sendResponse(500, { success: false, error: error.message });\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n\r\n  // POST /api/workflow/generate - Generate workflow using LLM\r\n  if (pathname === \"/api/workflow/generate\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDD27 [${requestId}] POST /api/workflow/generate - Generating workflow`);\r\n    let body = \"\";\r\n    \r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    \r\n    req.on(\"end\", async () => {\r\n      const sendResponse = (statusCode: number, data: any) => {\r\n        if (!res.headersSent) {\r\n          res.writeHead(statusCode, {\r\n            \"Content-Type\": \"application/json\",\r\n            \"Access-Control-Allow-Origin\": \"*\"\r\n          });\r\n          res.end(JSON.stringify(data));\r\n        }\r\n      };\r\n      \r\n      try {\r\n        const parsedBody = JSON.parse(body);\r\n        const { serviceType } = parsedBody;\r\n        \r\n        if (!serviceType) {\r\n          sendResponse(400, { success: false, error: \"serviceType is required\" });\r\n          return;\r\n        }\r\n        \r\n        // Load template (try movie.json first, fallback to amc_cinema.json)\r\n        let templatePath = path.join(__dirname, \"data\", \"movie.json\");\r\n        if (!fs.existsSync(templatePath)) {\r\n          templatePath = path.join(__dirname, \"data\", \"amc_cinema.json\");\r\n          if (!fs.existsSync(templatePath)) {\r\n            sendResponse(404, { success: false, error: \"Template workflow not found\" });\r\n            return;\r\n          }\r\n        }\r\n        \r\n        const templateContent = fs.readFileSync(templatePath, \"utf-8\");\r\n        const template = JSON.parse(templateContent);\r\n        \r\n        // Generate workflow using LLM\r\n        console.log(`   \uD83E\uDD16 [${requestId}] Generating workflow for service type: ${serviceType}`);\r\n        \r\n        // Check if OpenAI API key is configured before attempting generation\r\n        const OPENAI_API_KEY = process.env.OPENAI_API_KEY;\r\n        if (!OPENAI_API_KEY && ENABLE_OPENAI) {\r\n          console.error(`   \u274C [${requestId}] OpenAI API key not configured`);\r\n          sendResponse(400, {\r\n            success: false,\r\n            error: \"OpenAI API key not configured. Please set OPENAI_API_KEY environment variable or disable OpenAI in config.\"\r\n          });\r\n          return;\r\n        }\r\n        \r\n        const generatedWorkflow = await generateWorkflowFromTemplate(template, serviceType);\r\n        \r\n        // Save to file\r\n        const outputPath = path.join(__dirname, \"data\", `${serviceType}.json`);\r\n        const outputContent = JSON.stringify(generatedWorkflow, null, 2);\r\n        fs.writeFileSync(outputPath, outputContent, \"utf-8\");\r\n        \r\n        console.log(`   \u2705 [${requestId}] Workflow generated and saved: ${outputPath}`);\r\n        \r\n        sendResponse(200, {\r\n          success: true,\r\n          workflow: generatedWorkflow.flowwiseWorkflow,\r\n          filename: `${serviceType}.json`\r\n        });\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Error generating workflow:`, error.message);\r\n        sendResponse(500, { success: false, error: error.message });\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  if (pathname === \"/api/workflow/decision\" && req.method === \"POST\") {\r\n    console.log(`   \uD83E\uDD14 [${requestId}] POST /api/workflow/decision - User decision submission (NEW ARCHITECTURE: Using FlowWiseService)`);\r\n    let body = \"\";\r\n    \r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    \r\n    req.on(\"end\", async () => {\r\n      const sendResponse = (statusCode: number, data: any) => {\r\n        if (!res.headersSent) {\r\n          console.log(`   \uD83D\uDCE4 [${requestId}] Response: ${statusCode} ${statusCode === 200 ? 'OK' : 'ERROR'} (${JSON.stringify(data).length} bytes)`);\r\n          res.writeHead(statusCode, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify(data));\r\n        }\r\n      };\r\n      \r\n      try {\r\n        const parsedBody = JSON.parse(body);\r\n        const { workflowId, decision, selectionData, stepId } = parsedBody;\r\n\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Request body parsed:`, {\r\n          hasWorkflowId: !!workflowId,\r\n          workflowId: workflowId,\r\n          hasDecision: !!decision,\r\n          decision: decision,\r\n          hasSelectionData: !!selectionData,\r\n          hasStepId: !!stepId,\r\n          stepId: stepId,\r\n          bodyKeys: Object.keys(parsedBody)\r\n        });\r\n\r\n        if (!workflowId) {\r\n          console.error(`   \u274C [${requestId}] Missing required field: workflowId`);\r\n          console.error(`   \u274C [${requestId}] Parsed body:`, JSON.stringify(parsedBody, null, 2));\r\n          sendResponse(400, { \r\n            success: false, \r\n            error: `Missing required field: workflowId`,\r\n            received: {\r\n              workflowId: workflowId || null,\r\n              decision: decision || null,\r\n              selectionData: selectionData || null,\r\n              stepId: stepId || null\r\n            }\r\n          });\r\n          return;\r\n        }\r\n\r\n        // CRITICAL: Check current workflow step before extracting decision from selectionData\r\n        // For view_movie step, we MUST have an explicit decision (DONE_WATCHING), not a selection\r\n        let currentStep: string | undefined;\r\n        try {\r\n          if (!(global as any).workflowExecutions) {\r\n            (global as any).workflowExecutions = new Map();\r\n          }\r\n          const workflowExecutions = (global as any).workflowExecutions as Map<string, any>;\r\n          const execution = workflowExecutions.get(workflowId);\r\n          currentStep = execution?.currentStep;\r\n        } catch (e) {\r\n          // Execution might not exist yet, that's okay\r\n        }\r\n        \r\n        // CRITICAL: Handle selection-only requests (user_select_listing step)\r\n        // When selectionData is provided but decision is not, extract decision from selectionData\r\n        // EXCEPT for view_movie step, which requires an explicit decision\r\n        let finalDecision = decision;\r\n        if (!finalDecision && selectionData) {\r\n          // If we're at view_movie step, reject selectionData - require explicit decision\r\n          if (currentStep === 'view_movie') {\r\n            console.error(`   \uD83C\uDFAC [${requestId}] ========================================`);\r\n            console.error(`   \uD83C\uDFAC [${requestId}] ERROR: view_movie step received selectionData instead of explicit decision!`);\r\n            console.error(`   \uD83C\uDFAC [${requestId}] view_movie requires an explicit decision: \"DONE_WATCHING\"`);\r\n            console.error(`   \uD83C\uDFAC [${requestId}] SelectionData provided:`, selectionData);\r\n            console.error(`   \uD83C\uDFAC [${requestId}] This is likely a stale selection from a previous step`);\r\n            console.error(`   \uD83C\uDFAC [${requestId}] ========================================`);\r\n            sendResponse(400, { \r\n              success: false, \r\n              error: `Invalid request for view_movie step: received selectionData but expected explicit decision \"DONE_WATCHING\". This is likely a stale selection from a previous step.`,\r\n              code: 'INVALID_SELECTION_FOR_VIEW_MOVIE',\r\n              currentStep: 'view_movie',\r\n              requiredDecision: 'DONE_WATCHING'\r\n            });\r\n            return;\r\n          }\r\n          \r\n          // Extract decision from selectionData - use id, providerId, or movieId as the decision value\r\n          finalDecision = selectionData.id || \r\n                         selectionData.providerId || \r\n                         selectionData.movieId || \r\n                         selectionData.poolId ||\r\n                         JSON.stringify(selectionData); // Fallback to full object as string\r\n          console.log(`   \uD83D\uDD04 [${requestId}] No decision provided, extracted from selectionData: ${finalDecision}`);\r\n        }\r\n\r\n        // If still no decision, require it (for confirmation steps like user_confirm_listing)\r\n        if (!finalDecision) {\r\n          console.error(`   \u274C [${requestId}] Missing required field: decision (and no selectionData to extract from)`);\r\n          console.error(`   \u274C [${requestId}] Parsed body:`, JSON.stringify(parsedBody, null, 2));\r\n          sendResponse(400, { \r\n            success: false, \r\n            error: `Missing required field: decision (or selectionData to extract decision from)`,\r\n            received: {\r\n              workflowId: workflowId || null,\r\n              decision: decision || null,\r\n              selectionData: selectionData || null,\r\n              stepId: stepId || null\r\n            }\r\n          });\r\n          return;\r\n        }\r\n\r\n        console.log(`   \u2705 [${requestId}] ========================================`);\r\n        console.log(`   \u2705 [${requestId}] \uD83C\uDFAF USER DECISION ENDPOINT HIT! \uD83C\uDFAF`);\r\n        console.log(`   \u2705 [${requestId}] User ${selectionData ? 'selection' : 'decision'} submitted: ${finalDecision} for workflow ${workflowId}`);\r\n        console.log(`   \u2705 [${requestId}] Original decision value: ${decision || 'none'}`);\r\n        console.log(`   \u2705 [${requestId}] Final decision value: ${finalDecision}`);\r\n        console.log(`   \u2705 [${requestId}] SelectionData provided: ${selectionData ? 'yes' : 'no'}`);\r\n        if (selectionData) {\r\n          console.log(`   \u2705 [${requestId}] SelectionData type: ${typeof selectionData}`);\r\n          console.log(`   \u2705 [${requestId}] SelectionData keys: ${typeof selectionData === 'object' ? Object.keys(selectionData).join(', ') : 'N/A'}`);\r\n        }\r\n        console.log(`   \u2705 [${requestId}] StepId: ${stepId || 'not provided'}`);\r\n        console.log(`   \u2705 [${requestId}] ========================================`);\r\n\r\n        // NEW ARCHITECTURE: Use FlowWiseService to handle user decisions\r\n        // FlowWiseService will automatically execute all system steps (ledger, cashier, etc.)\r\n        const executionId = workflowId; // workflowId is actually executionId in new architecture\r\n        \r\n        console.log(`   \uD83D\uDD10 [${requestId}] ========================================`);\r\n        console.log(`   \uD83D\uDD10 [${requestId}] Using FlowWiseService to process user decision`);\r\n        console.log(`   \uD83D\uDD10 [${requestId}] ExecutionId: ${executionId}, Decision: ${finalDecision}, SelectionData: ${selectionData ? 'provided' : 'none'}`);\r\n        console.log(`   \uD83D\uDD10 [${requestId}] About to call submitUserDecisionToFlowWise...`);\r\n        console.log(`   \uD83D\uDD10 [${requestId}] ========================================`);\r\n\r\n        // Submit user decision to FlowWiseService\r\n        // FlowWiseService will automatically execute the next step (including ROOT CA steps)\r\n        // Use finalDecision (which may have been extracted from selectionData)\r\n        try {\r\n          const result = await submitUserDecisionToFlowWise(executionId, finalDecision, selectionData);\r\n          \r\n          // FlowWiseService handles all broadcasting internally\r\n          // The result contains the instruction for the next step\r\n          console.log(`   \u2705 [${requestId}] FlowWiseService processed decision successfully`);\r\n          console.log(`   \u2705 [${requestId}] Next instruction type: ${result.instruction.type}`);\r\n          \r\n          // Send success response with instruction\r\n          sendResponse(200, {\r\n            success: true,\r\n            message: `${selectionData ? 'Selection' : 'Decision'} submitted successfully`,\r\n            decision: finalDecision,\r\n            selectionData,\r\n            instruction: result.instruction\r\n          });\r\n        } catch (error: any) {\r\n          console.error(`   \u274C [${requestId}] Error processing decision with FlowWiseService:`, error.message);\r\n          console.error(`   \u274C [${requestId}] Error stack:`, error.stack);\r\n          console.error(`   \u274C [${requestId}] Full error:`, error);\r\n          \r\n          // If it's a validation error for view_movie step, return 400 Bad Request\r\n          if (error.message && error.message.includes('Invalid decision for view_movie step')) {\r\n            sendResponse(400, { \r\n              success: false, \r\n              error: error.message,\r\n              message: 'Invalid decision submitted. The workflow is waiting for \"DONE_WATCHING\" decision, but received a movie selection instead. Please click \"Done Watching\" button.',\r\n              code: 'INVALID_DECISION_FOR_VIEW_MOVIE'\r\n            });\r\n          } else {\r\n            sendResponse(500, { success: false, error: error.message, stack: error.stack });\r\n          }\r\n        }\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Error parsing request:`, error.message);\r\n        sendResponse(500, { success: false, error: error.message });\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // OLD CODE REMOVED - All workflow execution now handled by FlowWiseService\r\n  // The following large code block was removed:\r\n  // - continueWorkflowExecution function\r\n  // - executeStepAtomically function\r\n  // - All old workflow execution logic\r\n  // This code is now handled by FlowWiseService in server/src/components/flowwiseService.ts\r\n\r\n  // -----------------------------\r\n  // Chat History (Garden-scoped)\r\n  // -----------------------------\r\n  // Intentionally isolated from FlowWise execution state so it cannot break decision steps.\r\n  const sendChatHistoryResponse = (statusCode: number, data: any) => {\r\n    if (!res.headersSent) {\r\n      res.writeHead(statusCode, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify(data));\r\n    }\r\n  };\r\n  if ((pathname === \"/api/chat-history/history\" || pathname === \"/api/chat-history/history/\") && req.method === \"GET\") {\r\n    try {\r\n      const queryParams = new URL(req.url || \"\", `http://${req.headers.host}`).searchParams;\r\n      const conversationId = String(queryParams.get(\"conversationId\") || \"\").trim();\r\n      const limitRaw = parseInt(String(queryParams.get(\"limit\") || \"50\"));\r\n      const limit = Number.isFinite(limitRaw) ? limitRaw : 50;\r\n      const beforeRaw = queryParams.get(\"before\") ? parseInt(String(queryParams.get(\"before\"))) : undefined;\r\n      const before = typeof beforeRaw === \"number\" && Number.isFinite(beforeRaw) ? beforeRaw : undefined;\r\n\r\n      // IMPORTANT: no-history is a normal case. Always return a JSON response quickly.\r\n      // If the conversationId is missing/invalid, treat it as an empty history instead of throwing/500'ing.\r\n      if (!conversationId || !conversationId.startsWith(\"conv:\")) {\r\n        sendChatHistoryResponse(200, { success: true, conversationId, messages: [] });\r\n        return;\r\n      }\r\n      \r\n      // Use dynamic import for faster startup, but cache the module\r\n      const { getConversationMessages } = require(\"./src/chatHistory\");\r\n      const startTime = Date.now();\r\n      const messages = getConversationMessages(conversationId, limit, before);\r\n      const loadTime = Date.now() - startTime;\r\n      \r\n      if (loadTime > 100) {\r\n        console.log(`\u26A0\uFE0F [Chat History] Slow load: ${loadTime}ms for ${conversationId} (${messages.length} messages)`);\r\n      }\r\n      \r\n      sendChatHistoryResponse(200, { success: true, conversationId, messages });\r\n    } catch (e: any) {\r\n      sendChatHistoryResponse(500, { success: false, error: e?.message || \"Failed to load chat history\" });\r\n    }\r\n    return;\r\n  }\r\n\r\n  if ((pathname === \"/api/chat-history/append\" || pathname === \"/api/chat-history/append/\") && req.method === \"POST\") {\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => (body += chunk.toString()));\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const parsed = body ? JSON.parse(body) : {};\r\n        const { appendChatMessage } = require(\"./src/chatHistory\");\r\n        const saved = appendChatMessage({\r\n          conversationId: parsed.conversationId,\r\n          id: parsed.id,\r\n          role: parsed.role,\r\n          content: parsed.content,\r\n          timestamp: parsed.timestamp,\r\n          userEmail: parsed.userEmail,\r\n          mode: parsed.mode,\r\n          scope: parsed.scope,\r\n          gardenId: parsed.gardenId,\r\n          serviceType: parsed.serviceType,\r\n          linkedTransactionId: parsed.linkedTransactionId,\r\n          status: parsed.status\r\n        });\r\n\r\n        // Live stream to UI\r\n        broadcastEvent({\r\n          type: \"chat_history_message\",\r\n          component: \"chatHistory\",\r\n          message: \"Chat message appended\",\r\n          timestamp: Date.now(),\r\n          data: { message: saved }\r\n        });\r\n\r\n        sendChatHistoryResponse(200, { success: true, message: saved });\r\n      } catch (e: any) {\r\n        sendChatHistoryResponse(400, { success: false, error: e?.message || \"Failed to append\" });\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  if ((pathname === \"/api/chat-history/delete\" || pathname === \"/api/chat-history/delete/\") && req.method === \"DELETE\") {\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => (body += chunk.toString()));\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const parsed = body ? JSON.parse(body) : {};\r\n        const conversationId = String(parsed.conversationId || \"\").trim();\r\n        \r\n        if (!conversationId || !conversationId.startsWith(\"conv:\")) {\r\n          sendChatHistoryResponse(400, { success: false, error: \"Valid conversationId required\" });\r\n          return;\r\n        }\r\n        \r\n        const { deleteConversation } = require(\"./src/chatHistory\");\r\n        const deleted = deleteConversation(conversationId);\r\n        \r\n        if (deleted) {\r\n          // Broadcast deletion event\r\n          broadcastEvent({\r\n            type: \"chat_history_deleted\",\r\n            component: \"chatHistory\",\r\n            message: \"Chat history deleted\",\r\n            timestamp: Date.now(),\r\n            data: { conversationId }\r\n          });\r\n          \r\n          sendChatHistoryResponse(200, { success: true, conversationId, deleted: true });\r\n        } else {\r\n          sendChatHistoryResponse(404, { success: false, error: \"Conversation not found\" });\r\n        }\r\n      } catch (e: any) {\r\n        sendChatHistoryResponse(500, { success: false, error: e?.message || \"Failed to delete chat history\" });\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // ============================================\r\n  // Identity API Endpoints\r\n  // ============================================\r\n\r\n  // POST /api/identity/register - Register new Eden user with username\r\n  if (pathname === \"/api/identity/register\" && req.method === \"POST\") {\r\n    console.log(`   \uD83C\uDFAD [${requestId}] POST /api/identity/register - Username registration`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const parsed = JSON.parse(body);\r\n        const { googleUserId, email, globalUsername, globalNickname } = parsed;\r\n        \r\n        if (!googleUserId || !email || !globalUsername) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Missing required fields\" }));\r\n          return;\r\n        }\r\n\r\n        const user = createEdenUser(googleUserId, email, globalUsername, globalNickname);\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, user }));\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Registration error:`, error);\r\n        res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: error.message || \"Registration failed\" }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // GET /api/identity/username/check - Check username availability\r\n  if (pathname === \"/api/identity/username/check\" && req.method === \"GET\") {\r\n    const parsed = url.parse(req.url || \"/\", true);\r\n    const username = parsed.query.username as string;\r\n    \r\n    if (!username) {\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ available: false, error: \"Username parameter required\" }));\r\n      return;\r\n    }\r\n\r\n    const available = isUsernameAvailable(username);\r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({ available }));\r\n    return;\r\n  }\r\n\r\n  // GET /api/identity/user/:userId - Get Eden user\r\n  if (pathname?.startsWith(\"/api/identity/user/\") && req.method === \"GET\") {\r\n    const userId = pathname.split(\"/\").pop();\r\n    if (!userId) {\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: \"User ID required\" }));\r\n      return;\r\n    }\r\n\r\n    const user = getEdenUser(userId);\r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({ success: !!user, user: user || null }));\r\n    return;\r\n  }\r\n\r\n  // GET /api/identity/user-by-google/:googleUserId - Get Eden user by Google ID\r\n  if (pathname?.startsWith(\"/api/identity/user-by-google/\") && req.method === \"GET\") {\r\n    const googleUserId = pathname.split(\"/\").pop();\r\n    if (!googleUserId) {\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: \"Google User ID required\" }));\r\n      return;\r\n    }\r\n\r\n    const user = getEdenUserByGoogleId(googleUserId);\r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({ success: !!user, user: user || null }));\r\n    return;\r\n  }\r\n\r\n  // GET /api/identity/user-by-email/:email - Get Eden user by email\r\n  if (pathname?.startsWith(\"/api/identity/user-by-email/\") && req.method === \"GET\") {\r\n    const email = decodeURIComponent(pathname.split(\"/\").pop() || \"\");\r\n    if (!email) {\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: \"Email required\" }));\r\n      return;\r\n    }\r\n\r\n    const user = getEdenUserByEmail(email);\r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({ success: !!user, user: user || null }));\r\n    return;\r\n  }\r\n\r\n  // GET /api/identity/garden-user - Get Garden user\r\n  if (pathname === \"/api/identity/garden-user\" && req.method === \"GET\") {\r\n    const parsed = url.parse(req.url || \"/\", true);\r\n    const userId = parsed.query.userId as string;\r\n    const gardenId = parsed.query.gardenId as string;\r\n    \r\n    if (!userId || !gardenId) {\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: \"userId and gardenId required\" }));\r\n      return;\r\n    }\r\n\r\n    const gardenUser = getGardenUser(userId, gardenId);\r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({ success: true, gardenUser: gardenUser || null }));\r\n    return;\r\n  }\r\n\r\n  // POST /api/identity/garden/join - Join a Garden\r\n  if (pathname === \"/api/identity/garden/join\" && req.method === \"POST\") {\r\n    console.log(`   \uD83C\uDFAD [${requestId}] POST /api/identity/garden/join - Garden join`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const parsed = JSON.parse(body);\r\n        const { userId, gardenId, gardenUsername, gardenNickname } = parsed;\r\n        \r\n        if (!userId || !gardenId) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"userId and gardenId required\" }));\r\n          return;\r\n        }\r\n\r\n        const gardenUser = joinGarden(userId, gardenId, gardenUsername, gardenNickname);\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, gardenUser }));\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Garden join error:`, error);\r\n        res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: error.message || \"Garden join failed\" }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // PUT /api/identity/garden-user/nickname - Update garden nickname\r\n  if (pathname === \"/api/identity/garden-user/nickname\" && req.method === \"PUT\") {\r\n    console.log(`   \uD83C\uDFAD [${requestId}] PUT /api/identity/garden-user/nickname - Update nickname`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const parsed = JSON.parse(body);\r\n        const { userId, gardenId, nickname } = parsed;\r\n        \r\n        if (!userId || !gardenId || !nickname) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"userId, gardenId, and nickname required\" }));\r\n          return;\r\n        }\r\n\r\n        const gardenUser = updateGardenNickname(userId, gardenId, nickname);\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, gardenUser }));\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Nickname update error:`, error);\r\n        res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: error.message || \"Nickname update failed\" }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // ========================================\r\n  // Universal Messaging System API Endpoints\r\n  // ========================================\r\n\r\n  // POST /api/messaging/conversations - Create a new conversation\r\n  if (pathname === \"/api/messaging/conversations\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDCAC [${requestId}] POST /api/messaging/conversations - Create conversation`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const parsed = JSON.parse(body);\r\n        const { scope, participants, policy, initialMessage, creatorId, creatorType } = parsed;\r\n        \r\n        if (!scope || !participants || !creatorId || !creatorType) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"scope, participants, creatorId, and creatorType required\" }));\r\n          return;\r\n        }\r\n\r\n        const conversation = createConversation(\r\n          { scope, participants, policy, initialMessage },\r\n          creatorId,\r\n          creatorType\r\n        );\r\n\r\n        // Broadcast conversation created event\r\n        broadcastEvent({\r\n          type: \"conversation_created\",\r\n          component: \"messaging\",\r\n          message: `Conversation created: ${conversation.conversationId}`,\r\n          data: { conversation },\r\n          timestamp: Date.now()\r\n        });\r\n\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, conversation }));\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Create conversation error:`, error);\r\n        res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: error.message || \"Failed to create conversation\" }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // GET /api/messaging/conversations - List conversations with filters\r\n  if (pathname === \"/api/messaging/conversations\" && req.method === \"GET\") {\r\n    console.log(`   \uD83D\uDCAC [${requestId}] GET /api/messaging/conversations - List conversations`);\r\n    const parsed = url.parse(req.url || \"/\", true);\r\n    const filters: any = {};\r\n    if (parsed.query.scopeType) filters.scopeType = parsed.query.scopeType;\r\n    if (parsed.query.referenceId) filters.referenceId = parsed.query.referenceId;\r\n    if (parsed.query.participantId) filters.participantId = parsed.query.participantId;\r\n    if (parsed.query.state) filters.state = parsed.query.state;\r\n    if (parsed.query.gardenId) filters.gardenId = parsed.query.gardenId;\r\n\r\n    try {\r\n      const conversations = getConversations(filters);\r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: true, conversations }));\r\n    } catch (error: any) {\r\n      console.error(`   \u274C [${requestId}] List conversations error:`, error);\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: error.message || \"Failed to list conversations\" }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // GET /api/messaging/conversations/:conversationId - Get conversation by ID\r\n  if (pathname?.startsWith(\"/api/messaging/conversations/\") && req.method === \"GET\") {\r\n    const conversationId = pathname.split(\"/\").pop() || \"\";\r\n    console.log(`   \uD83D\uDCAC [${requestId}] GET /api/messaging/conversations/${conversationId}`);\r\n    \r\n    if (!conversationId) {\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: \"conversationId required\" }));\r\n      return;\r\n    }\r\n\r\n    const conversation = getConversation(conversationId);\r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({ success: !!conversation, conversation: conversation || null }));\r\n    return;\r\n  }\r\n\r\n  // POST /api/messaging/conversations/:conversationId/messages - Send a message\r\n  if (pathname?.startsWith(\"/api/messaging/conversations/\") && pathname.endsWith(\"/messages\") && req.method === \"POST\") {\r\n    const pathParts = pathname.split(\"/\");\r\n    const conversationId = pathParts[pathParts.length - 2] || \"\"; // Get second-to-last part (before \"messages\")\r\n    console.log(`   \uD83D\uDCAC [${requestId}] POST /api/messaging/conversations/${conversationId}/messages`);\r\n    console.log(`   \uD83D\uDCAC [${requestId}] Full pathname: ${pathname}, Extracted conversationId: ${conversationId}`);\r\n    \r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const parsed = JSON.parse(body);\r\n        const { messageType, payload, replyTo, senderId, senderType, senderRole } = parsed;\r\n        \r\n        if (!messageType || !payload || !senderId || !senderType) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"messageType, payload, senderId, and senderType required\" }));\r\n          return;\r\n        }\r\n\r\n        console.log(`   \uD83D\uDCAC [${requestId}] Sending message: conversationId=${conversationId}, senderId=${senderId}, senderType=${senderType}`);\r\n        \r\n        const message = sendMessage(\r\n          { conversationId, messageType, payload, replyTo },\r\n          senderId,\r\n          senderType,\r\n          senderRole\r\n        );\r\n\r\n        console.log(`   \u2705 [${requestId}] Message created: ${message.messageId}`);\r\n        console.log(`   \u2705 [${requestId}] Verifying message storage...`);\r\n        \r\n        // Verify message was stored (getConversationMessages is already imported at top)\r\n        try {\r\n          const verifyMessages = getConversationMessages(conversationId, senderId, senderType, senderRole);\r\n          console.log(`   \u2705 [${requestId}] Verification: Found ${verifyMessages.length} messages in conversation (including the one just sent)`);\r\n        } catch (verifyError: any) {\r\n          console.error(`   \u26A0\uFE0F [${requestId}] Verification failed:`, verifyError.message);\r\n        }\r\n\r\n        // Broadcast message sent event\r\n        broadcastEvent({\r\n          type: \"message_sent\",\r\n          component: \"messaging\",\r\n          message: `Message sent: ${message.messageId}`,\r\n          data: { message, conversationId },\r\n          timestamp: Date.now()\r\n        });\r\n\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, message }));\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Send message error:`, error);\r\n        res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: error.message || \"Failed to send message\" }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // GET /api/messaging/conversations/:conversationId/messages - Get messages for a conversation\r\n  if (pathname?.startsWith(\"/api/messaging/conversations/\") && pathname.endsWith(\"/messages\") && req.method === \"GET\") {\r\n    const pathParts = pathname.split(\"/\");\r\n    const conversationId = pathParts[pathParts.length - 2] || \"\"; // Get second-to-last part (before \"messages\")\r\n    console.log(`   \uD83D\uDCAC [${requestId}] GET /api/messaging/conversations/${conversationId}/messages`);\r\n    console.log(`   \uD83D\uDCAC [${requestId}] Full pathname: ${pathname}, Extracted conversationId: ${conversationId}`);\r\n    \r\n    const parsed = url.parse(req.url || \"/\", true);\r\n    const entityId = parsed.query.entityId as string;\r\n    const entityType = parsed.query.entityType as string;\r\n    const entityRole = parsed.query.entityRole as string | undefined;\r\n\r\n    console.log(`   \uD83D\uDCAC [${requestId}] Query params: entityId=${entityId}, entityType=${entityType}, entityRole=${entityRole}`);\r\n\r\n    if (!entityId || !entityType) {\r\n      console.error(`   \u274C [${requestId}] Missing required params: entityId=${entityId}, entityType=${entityType}`);\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: \"entityId and entityType required\" }));\r\n      return;\r\n    }\r\n\r\n    if (!conversationId) {\r\n      console.error(`   \u274C [${requestId}] Missing conversationId from path: ${pathname}`);\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: \"Conversation ID required\" }));\r\n      return;\r\n    }\r\n\r\n    try {\r\n      console.log(`   \uD83D\uDCAC [${requestId}] Getting messages for conversation ${conversationId}, entity: ${entityId} (${entityType})`);\r\n      const messages = getConversationMessages(conversationId, entityId, entityType as any, entityRole);\r\n      console.log(`   \u2705 [${requestId}] Retrieved ${messages.length} messages`);\r\n      const response = { success: true, messages };\r\n      console.log(`   \u2705 [${requestId}] Sending response with ${messages.length} messages`);\r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify(response));\r\n      console.log(`   \u2705 [${requestId}] Response sent successfully`);\r\n    } catch (error: any) {\r\n      console.error(`   \u274C [${requestId}] Get messages error:`, error);\r\n      console.error(`   \u274C [${requestId}] Error details:`, {\r\n        conversationId,\r\n        entityId,\r\n        entityType,\r\n        errorMessage: error.message,\r\n        errorStack: error.stack\r\n      });\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: error.message || \"Failed to get messages\" }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // POST /api/messaging/messages/:messageId/forgive - Forgive a message\r\n  if (pathname?.startsWith(\"/api/messaging/messages/\") && pathname.endsWith(\"/forgive\") && req.method === \"POST\") {\r\n    const messageId = pathname.split(\"/\")[4] || \"\";\r\n    console.log(`   \uD83D\uDCAC [${requestId}] POST /api/messaging/messages/${messageId}/forgive`);\r\n    \r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const parsed = JSON.parse(body);\r\n        const { reason, forgiverId, forgiverType, forgiverRole } = parsed;\r\n        \r\n        if (!forgiverId || !forgiverType) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"forgiverId and forgiverType required\" }));\r\n          return;\r\n        }\r\n\r\n        const message = forgiveMessage({ messageId, reason }, forgiverId, forgiverType as any, forgiverRole);\r\n\r\n        // Broadcast message forgiven event\r\n        broadcastEvent({\r\n          type: \"message_forgiven\",\r\n          component: \"messaging\",\r\n          message: `Message forgiven: ${messageId}`,\r\n          data: { message },\r\n          timestamp: Date.now()\r\n        });\r\n\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, message }));\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Forgive message error:`, error);\r\n        res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: error.message || \"Failed to forgive message\" }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // POST /api/messaging/conversations/:conversationId/state - Update conversation state\r\n  if (pathname?.startsWith(\"/api/messaging/conversations/\") && pathname.endsWith(\"/state\") && req.method === \"POST\") {\r\n    const conversationId = pathname.split(\"/\")[4] || \"\";\r\n    console.log(`   \uD83D\uDCAC [${requestId}] POST /api/messaging/conversations/${conversationId}/state`);\r\n    \r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const parsed = JSON.parse(body);\r\n        const { state, reason, updaterId, updaterType, updaterRole } = parsed;\r\n        \r\n        if (!state || !updaterId || !updaterType) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"state, updaterId, and updaterType required\" }));\r\n          return;\r\n        }\r\n\r\n        const conversation = updateConversationState(\r\n          { conversationId, state, reason },\r\n          updaterId,\r\n          updaterType as any,\r\n          updaterRole\r\n        );\r\n\r\n        // Broadcast conversation state changed event\r\n        broadcastEvent({\r\n          type: \"conversation_state_changed\",\r\n          component: \"messaging\",\r\n          message: `Conversation ${conversationId} state changed to ${state}`,\r\n          data: { conversation },\r\n          timestamp: Date.now()\r\n        });\r\n\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, conversation }));\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Update conversation state error:`, error);\r\n        res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: error.message || \"Failed to update conversation state\" }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // POST /api/messaging/conversations/:conversationId/escalate - Escalate conversation\r\n  if (pathname?.startsWith(\"/api/messaging/conversations/\") && pathname.endsWith(\"/escalate\") && req.method === \"POST\") {\r\n    const conversationId = pathname.split(\"/\")[4] || \"\";\r\n    console.log(`   \uD83D\uDCAC [${requestId}] POST /api/messaging/conversations/${conversationId}/escalate`);\r\n    \r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const parsed = JSON.parse(body);\r\n        const { additionalParticipants, reason, escalatorId, escalatorType, escalatorRole } = parsed;\r\n        \r\n        if (!additionalParticipants || !reason || !escalatorId || !escalatorType) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"additionalParticipants, reason, escalatorId, and escalatorType required\" }));\r\n          return;\r\n        }\r\n\r\n        const conversation = escalateConversation(\r\n          { conversationId, additionalParticipants, reason },\r\n          escalatorId,\r\n          escalatorType as any,\r\n          escalatorRole\r\n        );\r\n\r\n        // Broadcast conversation escalated event\r\n        broadcastEvent({\r\n          type: \"conversation_escalated\",\r\n          component: \"messaging\",\r\n          message: `Conversation ${conversationId} escalated`,\r\n          data: { conversation },\r\n          timestamp: Date.now()\r\n        });\r\n\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, conversation }));\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Escalate conversation error:`, error);\r\n        res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: error.message || \"Failed to escalate conversation\" }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // \uD83D\uDEA8 REGULAR CHAT ENDPOINT: Only handles informational queries (RAG + general knowledge)\r\n  // Eden workflow queries should use /api/eden-chat instead\r\n  if (pathname === \"/api/chat\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDCE8 [${requestId}] POST /api/chat - Processing chat request`);\r\n    let body = \"\";\r\n    let bodyReceived = false;\r\n    \r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    \r\n    req.on(\"end\", async () => {\r\n      if (bodyReceived) {\r\n        console.warn(`   \u26A0\uFE0F  [${requestId}] Request body already processed, ignoring duplicate end event`);\r\n        return;\r\n      }\r\n      bodyReceived = true;\r\n      // Ensure response is sent even if there's an unhandled error\r\n      const sendResponse = (statusCode: number, data: any) => {\r\n        if (!res.headersSent) {\r\n          res.writeHead(statusCode, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify(data));\r\n        } else {\r\n          console.warn(`\u26A0\uFE0F  Response already sent, cannot send:`, data);\r\n        }\r\n      };\r\n\r\n      let email = 'unknown';\r\n      \r\n      try {\r\n        // Parse and validate request body\r\n        if (!body || body.trim().length === 0) {\r\n          sendResponse(400, { success: false, error: \"Request body is required\" });\r\n          return;\r\n        }\r\n        \r\n        let parsedBody;\r\n        try {\r\n          parsedBody = JSON.parse(body);\r\n        } catch (parseError: any) {\r\n          sendResponse(400, { success: false, error: \"Invalid JSON in request body\" });\r\n          return;\r\n        }\r\n        \r\n        const { input, email: requestEmail } = parsedBody;\r\n        email = requestEmail || 'unknown';\r\n        \r\n        // Validate input\r\n        if (!input || typeof input !== 'string' || input.trim().length === 0) {\r\n          sendResponse(400, { success: false, error: \"Valid input message required\" });\r\n          return;\r\n        }\r\n        \r\n        if (!email || typeof email !== 'string' || !email.includes('@')) {\r\n          sendResponse(400, { success: false, error: \"Valid email address required\" });\r\n          return;\r\n        }\r\n        \r\n        console.log(`\uD83D\uDCE8 [Chat] ========================================`);\r\n        console.log(`\uD83D\uDCE8 [Chat] Processing chat request from ${email}`);\r\n        console.log(`\uD83D\uDCE8 [Chat] User Input: \"${input.trim()}\"`);\r\n        console.log(`\uD83D\uDCE8 [Chat] ========================================`);\r\n        \r\n        // Find or create user\r\n        let user = USERS_STATE.find(u => u.email === email);\r\n        if (!user) {\r\n          const nextId = `u${USERS_STATE.length + 1}`;\r\n          user = {\r\n            id: nextId,\r\n            email: email,\r\n            balance: 0,\r\n          };\r\n          USERS_STATE.push(user);\r\n          console.log(`\uD83D\uDC64 Created new user: ${email} with ID: ${nextId}`);\r\n        }\r\n        \r\n        // Sync user balance with wallet (wallet is source of truth)\r\n        const currentWalletBalance = await getWalletBalance(email);\r\n        user.balance = currentWalletBalance;\r\n        \r\n        // \uD83D\uDEA8 REGULAR CHAT ENDPOINT: Only handles informational queries (RAG + general knowledge)\r\n        // This endpoint is for REGULAR TEXT CHAT only - no workflows\r\n        const isGodChat = (body as any).isGodChat === true;\r\n        console.log(`\uD83D\uDCAC [Chat] Processing REGULAR TEXT CHAT (informational query only)${isGodChat ? ' - GOD CHAT MODE' : ''}`);\r\n        \r\n        // Build conversation ID for chat history (matches frontend pattern: conv:service:chat:user or conv:service:god)\r\n        const { buildConversationId } = await import(\"./src/chatHistory\");\r\n        const conversationId = isGodChat \r\n          ? buildConversationId('service', 'god')\r\n          : buildConversationId('service', 'chat', 'user');\r\n        \r\n        // Append user message to chat history\r\n        const { appendChatMessage } = await import(\"./src/chatHistory\");\r\n        appendChatMessage({\r\n          conversationId: conversationId,\r\n          role: 'USER',\r\n          content: input.trim(),\r\n          userEmail: email,\r\n          serviceType: 'chat'\r\n        });\r\n        \r\n        // Step 1: Check if it's a RAG query (Eden-related informational query)\r\n        const hasQuestionPattern = /how (to|does|do|can|will|works?)|what (is|are|does|do|can|will)|who (is|are|does|do|can|will)|explain|tell me about|help|guide/i.test(input.trim());\r\n        const queryLower = input.trim().toLowerCase();\r\n        const isEdenRelated = /\\b(eden|garden|workflow|service|messaging|token|movie|ticket|pharmacy|flight|hotel|restaurant|autopart|dex|pool|trade|swap|buy|sell|book|find|order|god|root\\s*ca|roca|judgment|settlement)\\b/i.test(queryLower) ||\r\n          /\\b(book|buy|sell|find|order|trade|swap)\\s+(a|an|the|some|my|your)?\\s*(movie|ticket|token|pharmacy|flight|hotel|restaurant|autopart)\\b/i.test(queryLower);\r\n        const isRAGQuery = hasQuestionPattern && isEdenRelated;\r\n        \r\n        if (isRAGQuery) {\r\n          console.log(`\uD83D\uDCDA [Chat] Detected RAG query (Eden-related informational) - using RAG knowledge base`);\r\n          try {\r\n            const { formatResponseWithOpenAI } = await import(\"./src/llm\");\r\n            const llmResponse = await formatResponseWithOpenAI([], input.trim(), { serviceType: 'informational' });\r\n            \r\n            // Append assistant response to chat history\r\n            appendChatMessage({\r\n              conversationId: conversationId,\r\n              role: 'ASSISTANT',\r\n              content: llmResponse.message,\r\n              userEmail: email,\r\n              serviceType: 'chat'\r\n            });\r\n            \r\n            // Broadcast LLM response\r\n            broadcastEvent({\r\n              type: \"llm_response\",\r\n              component: \"llm\",\r\n              message: llmResponse.message,\r\n              timestamp: Date.now(),\r\n              data: {\r\n                query: input.trim(),\r\n                response: llmResponse,\r\n                isRAG: true\r\n              }\r\n            });\r\n            \r\n            sendResponse(200, {\r\n              success: true,\r\n              message: llmResponse.message,\r\n              isRAG: true\r\n            });\r\n            console.log(`\u2705 [Chat] RAG query answered for ${email}`);\r\n            return;\r\n          } catch (error: any) {\r\n            console.error(`\u274C [Chat] Error processing RAG query:`, error);\r\n            sendResponse(500, {\r\n              success: false,\r\n              error: error.message || 'Failed to process RAG query'\r\n            });\r\n            return;\r\n          }\r\n        }\r\n        \r\n        // Step 2: Not RAG \u2192 Give to LLM to handle (general knowledge or other informational queries)\r\n        console.log(`\uD83D\uDCAC [Chat] Processing as LLM query (general knowledge or informational) - letting LLM handle it`);\r\n        \r\n        // Detect if this is a message to GOD (pattern-based detection as fallback)\r\n        const inputLower = input.trim().toLowerCase();\r\n        const isMessageToGod = isGodChat || \r\n          /message\\s+to\\s+god|send\\s+to\\s+god|tell\\s+god|god\\s+please|bless\\s+me|prayer|pray\\s+to|message\\s+god|god\\s+help|god\\s+i\\s+need/i.test(inputLower) ||\r\n          (inputLower.includes('god') && (inputLower.includes('bless') || inputLower.includes('help') || inputLower.includes('thank')));\r\n        \r\n        // Handle with LLM - LLM will determine if it's general knowledge or needs rejection\r\n        // For GOD chat, use a special prompt that allows personal/spiritual responses\r\n        const { formatResponseWithOpenAI, formatResponseWithDeepSeek } = await import(\"./src/llm\");\r\n        const formatFn = ENABLE_OPENAI ? formatResponseWithOpenAI : formatResponseWithDeepSeek;\r\n        \r\n        try {\r\n          // For GOD chat, prepend a special context to allow personal/spiritual responses\r\n          const processedInput = isMessageToGod \r\n            ? `[GOD CHAT MODE] You are GOD in the Eden ecosystem. The user is directly addressing you. Respond as GOD would - with wisdom, compassion, and understanding. This is a personal message, not a system query. User message: ${input.trim()}`\r\n            : input.trim();\r\n          \r\n          const llmResponse = await formatFn(\r\n            [], // No listings for informational queries\r\n            processedInput,\r\n            { serviceType: isMessageToGod ? \"god_chat\" : \"informational\" }\r\n          );\r\n          \r\n          // Check if LLM detected this should go to GOD's inbox (or pattern-based detection)\r\n          if (llmResponse.shouldRouteToGodInbox || isMessageToGod) {\r\n            console.log(`\u26A1 [Chat] Routing message to GOD's inbox for ${email}`);\r\n            \r\n            try {\r\n              // Create GOVERNANCE conversation with ROOT_AUTHORITY (GOD)\r\n              const { createConversation, sendMessage, getConversations } = await import(\"./src/messaging/conversationService\");\r\n              \r\n              // Find existing GOD inbox conversation for this user\r\n              const existingConversations = getConversations({\r\n                scopeType: 'GOVERNANCE',\r\n                participantId: email\r\n              });\r\n              \r\n              // Look for conversation with ROOT_AUTHORITY as participant\r\n              let godConversation = existingConversations.find(conv => \r\n                conv.participants.includes('ROOT_AUTHORITY') && \r\n                conv.state === 'OPEN'\r\n              );\r\n              \r\n              if (!godConversation) {\r\n                // Create new GOVERNANCE conversation with ROOT_AUTHORITY\r\n                // Ensure both user and ROOT_AUTHORITY have read/write permissions\r\n                godConversation = createConversation(\r\n                  {\r\n                    scope: {\r\n                      type: 'GOVERNANCE',\r\n                      referenceId: `god_inbox_${Date.now()}`,\r\n                    },\r\n                    participants: [email, 'ROOT_AUTHORITY'],\r\n                    policy: {\r\n                      readPermissions: [\r\n                        { entityType: 'USER', entityId: email },\r\n                        { entityType: 'ROOT_AUTHORITY' }\r\n                      ],\r\n                      writePermissions: [\r\n                        { entityType: 'USER', entityId: email },\r\n                        { entityType: 'ROOT_AUTHORITY' }\r\n                      ],\r\n                      invitePermissions: [\r\n                        { entityType: 'USER', entityId: email },\r\n                        { entityType: 'ROOT_AUTHORITY' }\r\n                      ],\r\n                      escalatePermissions: [\r\n                        { entityType: 'PRIEST' },\r\n                        { entityType: 'ROOT_AUTHORITY' }\r\n                      ],\r\n                      closePermissions: [\r\n                        { entityType: 'USER', entityId: email },\r\n                        { entityType: 'PRIEST' },\r\n                        { entityType: 'ROOT_AUTHORITY' }\r\n                      ]\r\n                    },\r\n                    initialMessage: {\r\n                      messageType: 'TEXT',\r\n                      payload: { text: input.trim() },\r\n                      senderId: email,\r\n                      senderType: 'USER'\r\n                    }\r\n                  },\r\n                  email,\r\n                  'USER'\r\n                );\r\n                console.log(`\u2705 [Chat] Created GOD inbox conversation: ${godConversation.conversationId}`);\r\n              } else {\r\n                // Send message to existing conversation\r\n                sendMessage(\r\n                  {\r\n                    conversationId: godConversation.conversationId,\r\n                    messageType: 'TEXT',\r\n                    payload: { text: input.trim() },\r\n                    replyTo: undefined\r\n                  },\r\n                  email,\r\n                  'USER',\r\n                  undefined // senderRole\r\n                );\r\n                console.log(`\u2705 [Chat] Sent message to existing GOD inbox conversation: ${godConversation.conversationId}`);\r\n              }\r\n              \r\n              // Update response message to confirm routing\r\n              llmResponse.message = `\u2705 Your message has been sent to GOD's inbox. GOD will review it and respond when appropriate.\\n\\nYour message: \"${input.trim()}\"`;\r\n            } catch (godInboxError: any) {\r\n              console.error(`\u274C [Chat] Error routing to GOD inbox:`, godInboxError);\r\n              // Continue with normal response even if inbox routing fails\r\n            }\r\n          }\r\n          \r\n          // Append assistant response to chat history\r\n          appendChatMessage({\r\n            conversationId: conversationId,\r\n            role: 'ASSISTANT',\r\n            content: llmResponse.message,\r\n            userEmail: email,\r\n            serviceType: 'chat'\r\n          });\r\n          \r\n          // Broadcast LLM response\r\n          broadcastEvent({\r\n            type: \"llm_response\",\r\n            component: \"llm\",\r\n            message: llmResponse.message,\r\n            timestamp: Date.now(),\r\n            data: {\r\n              query: input.trim(),\r\n              response: llmResponse,\r\n              isLLM: true,\r\n              routedToGodInbox: llmResponse.shouldRouteToGodInbox || isGodChat\r\n            }\r\n          });\r\n          \r\n          // Send response\r\n          sendResponse(200, {\r\n            success: true,\r\n            message: llmResponse.message,\r\n            isLLM: true,\r\n            routedToGodInbox: llmResponse.shouldRouteToGodInbox || isGodChat\r\n          });\r\n          console.log(`\u2705 [Chat] LLM query handled for ${email}`);\r\n          console.log(`\uD83D\uDCAC [Chat] Response: \"${llmResponse.message.substring(0, 100)}${llmResponse.message.length > 100 ? '...' : ''}\"`);\r\n        } catch (error: any) {\r\n          console.error(`\u274C [Chat] Error processing chat query:`, error);\r\n          sendResponse(500, { \r\n            success: false, \r\n            error: error.message || \"Failed to process chat query\"\r\n          });\r\n        }\r\n      } catch (outerError: any) {\r\n        // Catch any errors from the outer try block (request parsing, validation, etc.)\r\n        console.error(`\u274C Outer error processing request:`, outerError);\r\n        if (!res.headersSent) {\r\n          sendResponse(500, { \r\n            success: false, \r\n            error: outerError.message || \"Internal server error\",\r\n            timestamp: Date.now()\r\n          });\r\n        }\r\n      }\r\n    });\r\n    \r\n    // Handle request errors\r\n    req.on(\"error\", (error: Error) => {\r\n      console.error(`\u274C Request error:`, error);\r\n      if (!res.headersSent) {\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: \"Request processing error\" }));\r\n      }\r\n    });\r\n    \r\n    // Handle request timeout\r\n    req.setTimeout(60000, () => {\r\n      console.error(`\u274C Request timeout`);\r\n      if (!res.headersSent) {\r\n        res.writeHead(408, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: \"Request timeout\" }));\r\n      }\r\n      req.destroy();\r\n    });\r\n    return;\r\n  }\r\n\r\n  // \uD83D\uDEA8 EDEN CHAT ENDPOINT: Handles Eden workflow/service queries only\r\n  if (pathname === \"/api/eden-chat\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDD04 [${requestId}] POST /api/eden-chat - Processing Eden workflow chat request`);\r\n    let body = \"\";\r\n    let bodyReceived = false;\r\n    \r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    \r\n    req.on(\"end\", async () => {\r\n      if (bodyReceived) {\r\n        console.warn(`   \u26A0\uFE0F  [${requestId}] Request body already processed, ignoring duplicate end event`);\r\n        return;\r\n      }\r\n      bodyReceived = true;\r\n      // Ensure response is sent even if there's an unhandled error\r\n      const sendResponse = (statusCode: number, data: any) => {\r\n        if (!res.headersSent) {\r\n          res.writeHead(statusCode, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify(data));\r\n        } else {\r\n          console.warn(`\u26A0\uFE0F  Response already sent, cannot send:`, data);\r\n        }\r\n      };\r\n\r\n      let email = 'unknown';\r\n      \r\n      try {\r\n        // Parse and validate request body\r\n        if (!body || body.trim().length === 0) {\r\n          sendResponse(400, { success: false, error: \"Request body is required\" });\r\n          return;\r\n        }\r\n        \r\n        let parsedBody;\r\n        try {\r\n          parsedBody = JSON.parse(body);\r\n        } catch (parseError: any) {\r\n          sendResponse(400, { success: false, error: \"Invalid JSON in request body\" });\r\n          return;\r\n        }\r\n        \r\n        const { input, email: requestEmail } = parsedBody;\r\n        email = requestEmail || 'unknown';\r\n        \r\n        // Validate input\r\n        if (!input || typeof input !== 'string' || input.trim().length === 0) {\r\n          sendResponse(400, { success: false, error: \"Valid input message required\" });\r\n          return;\r\n        }\r\n        \r\n        if (!email || typeof email !== 'string' || !email.includes('@')) {\r\n          sendResponse(400, { success: false, error: \"Valid email address required\" });\r\n          return;\r\n        }\r\n        \r\n        // CRITICAL: Check for pending workflow decisions BEFORE processing as new chat input\r\n        // Use LLM to determine if user input is a decision response for a pending workflow\r\n        if (!(global as any).workflowExecutions) {\r\n          (global as any).workflowExecutions = new Map();\r\n        }\r\n        const workflowExecutions = (global as any).workflowExecutions as Map<string, any>;\r\n        \r\n        // Find active executions waiting for user decision\r\n        // Match by user email in context (execution.context.user.email)\r\n        for (const [executionId, execution] of workflowExecutions.entries()) {\r\n          const executionUserEmail = execution.context?.user?.email;\r\n          if (executionUserEmail === email) {\r\n            const currentStep = execution.workflow?.steps?.find((s: any) => s.id === execution.currentStep);\r\n            if (currentStep?.type === \"decision\" && currentStep?.requiresUserDecision) {\r\n              console.log(`   \uD83E\uDD14 [${requestId}] Found pending decision for execution ${executionId}, using LLM to determine if input is a decision response...`);\r\n              \r\n              // Use LLM to determine if user input is a decision response\r\n              try {\r\n                // CRITICAL: Replace template variables in decision prompt and options using execution context\r\n                const { replaceTemplateVariables } = await import(\"./src/flowwise\");\r\n                const context = execution.context || {};\r\n                \r\n                // Process decision prompt with template variables\r\n                let decisionPrompt = currentStep.decisionPrompt || \"Please make a decision\";\r\n                if (currentStep.decisionPrompt) {\r\n                  decisionPrompt = replaceTemplateVariables(currentStep.decisionPrompt, context);\r\n                  console.log(`   \uD83D\uDD0D [${requestId}] Processed decision prompt: \"${decisionPrompt}\"`);\r\n                }\r\n                \r\n                // Process decision options with template variables\r\n                let decisionOptions: Array<{ value: string; label: string }> = [];\r\n                if (currentStep.decisionOptions && Array.isArray(currentStep.decisionOptions) && currentStep.decisionOptions.length > 0) {\r\n                  decisionOptions = currentStep.decisionOptions.map((opt: any) => ({\r\n                    value: opt.value,\r\n                    label: replaceTemplateVariables(opt.label || \"\", context)\r\n                  }));\r\n                  console.log(`   \uD83D\uDD0D [${requestId}] Processed ${decisionOptions.length} decision options`);\r\n                }\r\n                \r\n                const { determineDecisionResponse } = await import(\"./src/llm\");\r\n                const decisionResult = await determineDecisionResponse(\r\n                  input,\r\n                  decisionPrompt,\r\n                  decisionOptions\r\n                );\r\n                \r\n                if (decisionResult.isDecisionResponse) {\r\n                  console.log(`   \u2705 [${requestId}] LLM determined input \"${input}\" is a decision response: ${decisionResult.decisionValue}`);\r\n                  \r\n                  // Route to workflow decision handler\r\n                  const { submitUserDecisionToFlowWise } = await import(\"./src/components/flowwiseService\");\r\n                  const result = await submitUserDecisionToFlowWise(executionId, decisionResult.decisionValue);\r\n                  \r\n                  sendResponse(200, {\r\n                    success: true,\r\n                    message: \"Decision processed successfully\",\r\n                    decision: decisionResult.decisionValue,\r\n                    instruction: result.instruction\r\n                  });\r\n                  return;\r\n                } else {\r\n                  console.log(`   \u2139\uFE0F  [${requestId}] LLM determined input \"${input}\" is NOT a decision response, continuing with normal chat processing`);\r\n                }\r\n              } catch (error: any) {\r\n                console.error(`   \u274C [${requestId}] Error using LLM to determine decision:`, error.message);\r\n                console.error(`   \u274C [${requestId}] Error stack:`, error.stack);\r\n                // Fall through to normal chat processing if LLM check fails\r\n              }\r\n            }\r\n          }\r\n        }\r\n        \r\n        console.log(`\uD83D\uDD04 [Eden Chat] ========================================`);\r\n        console.log(`\uD83D\uDD04 [Eden Chat] Processing Eden workflow chat request from ${email}`);\r\n        console.log(`\uD83D\uDD04 [Eden Chat] User Input: \"${input.trim()}\"`);\r\n        console.log(`\uD83D\uDD04 [Eden Chat] ========================================`);\r\n        \r\n        // Find or create user\r\n        let user = USERS_STATE.find(u => u.email === email);\r\n        if (!user) {\r\n          const nextId = `u${USERS_STATE.length + 1}`;\r\n          user = {\r\n            id: nextId,\r\n            email: email,\r\n            balance: 0,\r\n          };\r\n          USERS_STATE.push(user);\r\n          console.log(`\uD83D\uDC64 Created new user: ${email} with ID: ${nextId}`);\r\n        }\r\n        \r\n        // Sync user balance with wallet (wallet is source of truth)\r\n        const currentWalletBalance = await getWalletBalance(email);\r\n        user.balance = currentWalletBalance;\r\n        \r\n        // EDEN CHAT (Workflow/Service Query) - proceed with workflow\r\n        console.log(`\uD83D\uDD04 [Eden Chat] Processing EDEN CHAT (workflow/service query) - starting workflow`);\r\n        \r\n        // NEW ARCHITECTURE: Use FlowWiseService (ROOT CA service) to orchestrate workflow\r\n        // NEW ARCHITECTURE: Use LLM service mapper to determine service/garden from user input\r\n        // This eliminates the need for pre-canned prompts and manual serviceType detection\r\n        // The LLM will analyze user input and select the best matching services from the registry\r\n        try {\r\n          const { startWorkflowFromUserInput } = await import(\"./src/components/flowwiseService\");\r\n          const workflowResult = await startWorkflowFromUserInput(\r\n            input.trim(),\r\n            user\r\n            // serviceType is now optional - LLM service mapper will determine it from user input\r\n          );\r\n          \r\n          // Broadcast workflow started event with LLM service selection\r\n          broadcastEvent({\r\n            type: \"workflow_started\",\r\n            component: \"workflow\",\r\n            message: `Workflow started: ${workflowResult.executionId}`,\r\n            timestamp: Date.now(),\r\n            data: {\r\n              executionId: workflowResult.executionId,\r\n              currentStep: workflowResult.currentStep,\r\n              instruction: workflowResult.instruction,\r\n              workflowProcessingGas: workflowResult.workflowProcessingGas,\r\n              serviceSelection: workflowResult.serviceSelection // Include LLM-selected services\r\n            }\r\n          });\r\n          \r\n          // Success response with workflow execution ID\r\n          if (!res.headersSent) {\r\n            sendResponse(200, { \r\n              success: true, \r\n              message: \"Eden chat processed successfully\",\r\n              executionId: workflowResult.executionId,\r\n              instruction: workflowResult.instruction\r\n            });\r\n            console.log(`\u2705 Eden chat request processed successfully for ${email}, workflow: ${workflowResult.executionId}`);\r\n          } else {\r\n            console.warn(`\u26A0\uFE0F  Response already sent, skipping success response`);\r\n          }\r\n        } catch (error: any) {\r\n          // Log error for debugging\r\n          console.error(`\u274C Error processing Eden chat input:`, error);\r\n          console.error(`   Error stack:`, error.stack);\r\n          \r\n          // Send appropriate error response - ensure it's sent\r\n          if (!res.headersSent) {\r\n            const statusCode = error.message?.includes('Payment failed') ? 402 : \r\n                              error.message?.includes('No listing') ? 404 : \r\n                              error.message?.includes('timeout') ? 408 : 500;\r\n            sendResponse(statusCode, { \r\n              success: false, \r\n              error: error.message || \"Internal server error\",\r\n              timestamp: Date.now()\r\n            });\r\n          } else {\r\n            console.warn(`\u26A0\uFE0F  Response already sent, cannot send error response`);\r\n          }\r\n        } finally {\r\n          // Ensure response is always sent\r\n          if (!res.headersSent) {\r\n            console.error(`\u274C CRITICAL: No response sent for Eden chat request from ${email}!`);\r\n            sendResponse(500, { \r\n              success: false, \r\n              error: \"Unexpected server error - no response was sent\",\r\n              timestamp: Date.now()\r\n            });\r\n          } else {\r\n            console.log(`\u2705 Response sent for Eden chat request from ${email}`);\r\n          }\r\n        }\r\n      } catch (outerError: any) {\r\n        // Catch any errors from the outer try block (request parsing, validation, etc.)\r\n        console.error(`\u274C Outer error processing Eden chat request:`, outerError);\r\n        if (!res.headersSent) {\r\n          sendResponse(500, { \r\n            success: false, \r\n            error: outerError.message || \"Internal server error\",\r\n            timestamp: Date.now()\r\n          });\r\n        }\r\n      }\r\n    });\r\n    \r\n    // Handle request errors\r\n    req.on(\"error\", (error: Error) => {\r\n      console.error(`\u274C Eden chat request error:`, error);\r\n      if (!res.headersSent) {\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: \"Request processing error\" }));\r\n      }\r\n    });\r\n    \r\n    // Handle request timeout\r\n    req.setTimeout(60000, () => {\r\n      console.error(`\u274C Eden chat request timeout`);\r\n      if (!res.headersSent) {\r\n        res.writeHead(408, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: \"Request timeout\" }));\r\n      }\r\n      req.destroy();\r\n    });\r\n    return;\r\n  }\r\n\r\n  if (pathname === \"/api/test\" && req.method === \"GET\") {\r\n    console.log(`   \u2705 [${requestId}] GET /api/test - Test endpoint`);\r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({ success: true, message: \"Server is responding\", timestamp: Date.now() }));\r\n    return;\r\n  }\r\n\r\n  // ROOT CA Service Registry API Endpoints\r\n  if (pathname === \"/api/root-ca/service-registry\" && req.method === \"GET\") {\r\n    console.log(`   \u2705 [${requestId}] GET /api/root-ca/service-registry - Listing all service providers`);\r\n    \r\n    const url = new URL(req.url || '', `http://${req.headers.host}`);\r\n    const serviceType = url.searchParams.get('serviceType'); // Optional filter by service type (e.g., \"movie\", \"dex\", \"snake\")\r\n    const ownerEmail = url.searchParams.get('ownerEmail'); // Optional filter by owner email (for Priest mode)\r\n    const cleanupOrphans = (url.searchParams.get('cleanupOrphans') || '').toLowerCase() === 'true'; // destructive cleanup opt-in\r\n    const debugRegistryApi = String(process.env.EDEN_DEBUG_REGISTRY_API || '').toLowerCase() === 'true';\r\n    \r\n    // Use ServiceRegistry2 (new implementation)\r\n    const serviceRegistry2 = getServiceRegistry2();\r\n    let allProviders = serviceRegistry2.getAllProviders();\r\n    \r\n    if (debugRegistryApi) {\r\n      console.log(\r\n        `   \uD83D\uDCCA [Service Registry API] Total providers in ServiceRegistry2: ${allProviders.length} (by type: movie=${allProviders.filter(p => p.serviceType === 'movie').length}, dex=${allProviders.filter(p => p.serviceType === 'dex').length}, airline=${allProviders.filter(p => p.serviceType === 'airline').length}, infrastructure=${allProviders.filter(p => ['payment-rail', 'settlement', 'registry', 'webserver', 'websocket', 'wallet'].includes(p.serviceType)).length})`\r\n      );\r\n    }\r\n    \r\n    // Helper function to get ownerEmail for a provider based on its gardenId\r\n    const getOwnerEmailForProvider = (gardenId: string): string | undefined => {\r\n      if (gardenId === 'HG') {\r\n        return undefined; // Holy Ghost doesn't have an owner\r\n      }\r\n      // Find garden in GARDENS or TOKEN_GARDENS\r\n      const garden = GARDENS.find(g => g.id === gardenId) || TOKEN_GARDENS.find(g => g.id === gardenId);\r\n      if (!garden) {\r\n        console.warn(`   \u26A0\uFE0F  [Service Registry API] Provider has gardenId \"${gardenId}\" but garden not found - this provider may be orphaned`);\r\n        return undefined;\r\n      }\r\n      return garden?.ownerEmail || garden?.priestEmail || undefined;\r\n    };\r\n    \r\n    // Orphan cleanup is destructive + slow (disk reads). Only do the persistence-file cross-check when cleanup is explicitly requested.\r\n    const allGardenIds = [...GARDENS.map(g => g.id), ...TOKEN_GARDENS.map(g => g.id)];\r\n    let persistedGardenIds: string[] = [];\r\n    if (cleanupOrphans) {\r\n      const gardensPersistenceFile = path.join(__dirname, 'eden-gardens-persistence.json');\r\n      if (fs.existsSync(gardensPersistenceFile)) {\r\n        try {\r\n          const fileContent = fs.readFileSync(gardensPersistenceFile, 'utf-8');\r\n          const persisted = JSON.parse(fileContent);\r\n          const persistedGardens = persisted.gardens || persisted.indexers || [];\r\n          persistedGardenIds = persistedGardens.map((g: any) => g.id);\r\n        } catch (err: any) {\r\n          console.warn(`   \u26A0\uFE0F  [Service Registry API] Failed to load gardens from persistence file for orphaned check: ${err.message}`);\r\n        }\r\n      }\r\n    }\r\n\r\n    const validGardenIds = new Set([...allGardenIds, ...persistedGardenIds, 'HG']); // HG always valid\r\n    const orphanedProviders = allProviders.filter(p => p.gardenId && p.gardenId !== 'HG' && !validGardenIds.has(p.gardenId));\r\n    if (orphanedProviders.length > 0) {\r\n      console.warn(`   \u26A0\uFE0F  [Service Registry API] Found ${orphanedProviders.length} orphaned provider(s) with invalid gardenIds: ${orphanedProviders.map(p => `${p.id} (gardenId: ${p.gardenId})`).join(', ')}`);\r\n      \r\n      if (cleanupOrphans) {\r\n        // Remove orphaned providers from ServiceRegistry2 and ROOT_CA_SERVICE_REGISTRY (explicit opt-in)\r\n        const serviceRegistry2 = getServiceRegistry2();\r\n        for (const orphaned of orphanedProviders) {\r\n          try {\r\n            // Check if provider exists before trying to remove it\r\n            if (serviceRegistry2.hasProvider(orphaned.id)) {\r\n              serviceRegistry2.removeProvider(orphaned.id);\r\n              console.log(`   \uD83D\uDDD1\uFE0F  Removed orphaned provider ${orphaned.id} from ServiceRegistry2`);\r\n            } else {\r\n              console.log(`   \u2139\uFE0F  Orphaned provider ${orphaned.id} not found in ServiceRegistry2 (may have been already removed)`);\r\n            }\r\n          } catch (err: any) {\r\n            console.warn(`   \u26A0\uFE0F  Failed to remove orphaned provider ${orphaned.id}: ${err.message}`);\r\n          }\r\n          // Also remove from ROOT_CA_SERVICE_REGISTRY\r\n          const index = ROOT_CA_SERVICE_REGISTRY.findIndex(p => p.id === orphaned.id || p.uuid === orphaned.uuid);\r\n          if (index !== -1) {\r\n            ROOT_CA_SERVICE_REGISTRY.splice(index, 1);\r\n            console.log(`   \uD83D\uDDD1\uFE0F  Removed orphaned provider ${orphaned.id} from ROOT_CA_SERVICE_REGISTRY`);\r\n          }\r\n        }\r\n        // Filter out orphaned providers from the response\r\n        allProviders = allProviders.filter(p => !orphanedProviders.includes(p));\r\n        // Save cleaned registry\r\n        try {\r\n          serviceRegistry2.savePersistence();\r\n          console.log(`   \uD83D\uDCBE Service registry saved after removing ${orphanedProviders.length} orphaned provider(s)`);\r\n        } catch (saveErr: any) {\r\n          console.warn(`   \u26A0\uFE0F  Failed to save service registry after cleanup: ${saveErr.message}`);\r\n        }\r\n      } else {\r\n        console.warn(`   \u26A0\uFE0F  [Service Registry API] Not deleting orphaned providers on GET. Pass ?cleanupOrphans=true to apply cleanup.`);\r\n      }\r\n    }\r\n    \r\n    let providers = allProviders.map(p => {\r\n      const providerOwnerEmail = getOwnerEmailForProvider(p.gardenId);\r\n      return {\r\n        id: p.id,\r\n        name: p.name,\r\n        serviceType: p.serviceType, // Snake is a service type (serviceType: \"snake\")\r\n        location: p.location,\r\n        bond: p.bond,\r\n        reputation: p.reputation,\r\n        gardenId: p.gardenId, // Use gardenId directly - everything is in sync\r\n        status: p.status || 'active',\r\n        ownerEmail: providerOwnerEmail, // Add ownerEmail field\r\n        // Snake service fields (transparent in ServiceRegistry)\r\n        insuranceFee: p.insuranceFee,\r\n        iGasMultiplier: p.iGasMultiplier || 1.0,\r\n        iTaxMultiplier: p.iTaxMultiplier || 1.0,\r\n        maxInfluence: p.maxInfluence,\r\n        contextsAllowed: p.contextsAllowed,\r\n        contextsForbidden: p.contextsForbidden,\r\n        adCapabilities: p.adCapabilities\r\n      };\r\n    });\r\n    \r\n    // Filter by service type if provided (e.g., \"snake\" for Snake services)\r\n    if (serviceType) {\r\n      providers = providers.filter(p => p.serviceType === serviceType);\r\n    }\r\n    \r\n    // Filter by ownerEmail if provided (for Priest mode)\r\n    if (ownerEmail) {\r\n      const ownerEmailLower = ownerEmail.toLowerCase();\r\n      providers = providers.filter(p => {\r\n        if (!p.ownerEmail) return false; // Exclude providers without ownerEmail (e.g., HG infrastructure)\r\n        return p.ownerEmail.toLowerCase() === ownerEmailLower;\r\n      });\r\n      console.log(`   \uD83D\uDD0D [Service Registry API] Filtered by ownerEmail: ${ownerEmail} \u2192 ${providers.length} provider(s)`);\r\n    }\r\n    \r\n    if (debugRegistryApi) {\r\n      const movieProviders = providers.filter(p => p.serviceType === 'movie');\r\n      const nonHGProviders = movieProviders.filter(p => p.gardenId !== 'HG');\r\n      if (movieProviders.length > 0) {\r\n        console.log(`   \uD83D\uDD0D [Service Registry API] Movie providers: ${movieProviders.map(p => `${p.name} (${p.id}) \u2192 gardenId: ${p.gardenId}, ownerEmail: ${p.ownerEmail || 'N/A'}`).join(', ')}`);\r\n        console.log(`   \uD83D\uDD0D [Service Registry API] Non-HG movie providers: ${nonHGProviders.length} (${nonHGProviders.map(p => p.name).join(', ')})`);\r\n      }\r\n    }\r\n    \r\n    // Generate ETag for caching (hash of providers data)\r\n    const responseData = {\r\n      success: true,\r\n      providers,\r\n      count: providers.length,\r\n      timestamp: Date.now()\r\n    };\r\n    const responseJson = JSON.stringify(responseData);\r\n    const etag = `\"${crypto.createHash('md5').update(responseJson).digest('hex')}\"`;\r\n    \r\n    // Check If-None-Match header for 304 Not Modified\r\n    const ifNoneMatch = req.headers['if-none-match'];\r\n    if (ifNoneMatch === etag) {\r\n      res.writeHead(304, {\r\n        \"ETag\": etag,\r\n        \"Cache-Control\": \"public, max-age=1800, stale-while-revalidate=3600\" // Cache for 30 minutes, serve stale for 60 minutes\r\n      });\r\n      res.end();\r\n      return;\r\n    }\r\n    \r\n    // Set cache headers\r\n    res.writeHead(200, {\r\n      \"Content-Type\": \"application/json\",\r\n      \"ETag\": etag,\r\n      \"Cache-Control\": \"public, max-age=1800, stale-while-revalidate=3600\", // Cache for 30 minutes, serve stale for 60 minutes\r\n      \"Last-Modified\": new Date().toUTCString()\r\n    });\r\n    res.end(responseJson);\r\n    return;\r\n  }\r\n\r\n  if (pathname === \"/api/root-ca/service-registry/register\" && req.method === \"POST\") {\r\n    console.log(`   \u2705 [${requestId}] POST /api/root-ca/service-registry/register - Registering service provider`);\r\n    \r\n    let body = '';\r\n    req.on('data', chunk => { body += chunk.toString(); });\r\n    req.on('end', () => {\r\n      try {\r\n        const providerData = JSON.parse(body);\r\n        \r\n        // Validate required fields\r\n        if (!providerData.id || !providerData.name || !providerData.serviceType || !providerData.gardenId) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Missing required fields: id, name, serviceType, gardenId\" }));\r\n          return;\r\n        }\r\n        \r\n        // Create provider with defaults\r\n        const provider: ServiceProviderWithCert = {\r\n          id: providerData.id,\r\n          uuid: providerData.uuid || crypto.randomUUID(),\r\n          name: providerData.name,\r\n          serviceType: providerData.serviceType,\r\n          location: providerData.location || \"Unknown\",\r\n          bond: providerData.bond || 0,\r\n          reputation: providerData.reputation || 5.0,\r\n          gardenId: providerData.gardenId || \"HG\", // Use gardenId\r\n          apiEndpoint: providerData.apiEndpoint || \"\",\r\n          status: providerData.status || 'active',\r\n          // Snake service fields (if serviceType is \"snake\")\r\n          insuranceFee: providerData.insuranceFee !== undefined ? providerData.insuranceFee : (providerData.serviceType === 'snake' ? Math.max(providerData.bond || 0, 10000) : providerData.bond || 0),\r\n          iGasMultiplier: providerData.iGasMultiplier !== undefined ? providerData.iGasMultiplier : (providerData.serviceType === 'snake' ? 2.0 : 1.0),\r\n          iTaxMultiplier: providerData.iTaxMultiplier !== undefined ? providerData.iTaxMultiplier : (providerData.serviceType === 'snake' ? 2.0 : 1.0),\r\n          maxInfluence: providerData.maxInfluence !== undefined ? providerData.maxInfluence : (providerData.serviceType === 'snake' ? 0.15 : undefined),\r\n          contextsAllowed: providerData.contextsAllowed,\r\n          contextsForbidden: providerData.contextsForbidden,\r\n          adCapabilities: providerData.adCapabilities,\r\n        };\r\n        \r\n        // Register with ROOT CA\r\n        registerServiceProviderWithROOTCA(provider);\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          message: `Service provider ${provider.name} registered successfully`,\r\n          provider: {\r\n            id: provider.id,\r\n            uuid: provider.uuid,\r\n            name: provider.name\r\n          }\r\n        }));\r\n      } catch (err: any) {\r\n        res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  if (pathname === \"/api/root-balances\" && req.method === \"GET\") {\r\n    console.log(`   \u2705 [${requestId}] GET /api/root-balances - Sending ROOT CA balances`);\r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    \r\n    const balances = {\r\n      rootCA: ROOT_BALANCES.rootCA,\r\n      indexers: Object.fromEntries(ROOT_BALANCES.indexers),\r\n      providers: Object.fromEntries(ROOT_BALANCES.providers),\r\n      rootCALiquidity: rootCALiquidity,\r\n      timestamp: Date.now()\r\n    };\r\n    \r\n    res.end(JSON.stringify({\r\n      success: true,\r\n      balances,\r\n      timestamp: Date.now()\r\n    }));\r\n    return;\r\n  }\r\n\r\n  // GET /api/gardens - Get list of gardens (new endpoint, preferred)\r\n  // GET /api/indexers - Get list of gardens (backward compatibility, redirects to gardens logic)\r\n  if ((pathname === \"/api/gardens\" || pathname === \"/api/indexers\") && req.method === \"GET\") {\r\n    const endpointName = pathname === \"/api/gardens\" ? \"gardens\" : \"indexers\";\r\n    console.log(`   \u2705 [${requestId}] GET /api/${endpointName} - Sending garden list`);\r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    \r\n    // Ecosystem split:\r\n    // - saas: Holy Ghost + regular gardens (\uD83C\uDF4E APPLES ecosystem)\r\n    // - dex: token gardens only (DEX ecosystem)\r\n    // - all: Holy Ghost + regular + token (backward compatible)\r\n    const parsedForEcosystem = url.parse(req.url || \"/\", true);\r\n    const ecosystemRaw = (parsedForEcosystem.query.ecosystem as string | undefined) || \"saas\";\r\n    const ecosystem = ecosystemRaw.toLowerCase();\r\n    \r\n    // Load persisted indexers from file (single source of truth)\r\n    // REFACTOR: Load from separate gardens file first, fallback to old combined file\r\n    let persistedGardens: GardenConfig[] = [];\r\n    let persistedTokenGardens: TokenGardenConfig[] = [];\r\n    \r\n    try {\r\n      // Try loading from separate gardens file first\r\n      const gardensFile = path.join(__dirname, 'eden-gardens-persistence.json');\r\n      let gardensFromFile: any[] = [];\r\n      \r\n      if (fs.existsSync(gardensFile)) {\r\n        try {\r\n          const fileContent = fs.readFileSync(gardensFile, 'utf-8');\r\n          const persisted = JSON.parse(fileContent);\r\n          gardensFromFile = persisted.gardens || persisted.indexers || [];\r\n          console.log(`\uD83D\uDCCB [Indexer API] Loaded ${gardensFromFile.length} gardens from separate file: ${gardensFile}`);\r\n        } catch (err: any) {\r\n          console.warn(`\u26A0\uFE0F  [Indexer API] Failed to load from separate gardens file: ${err.message}`);\r\n        }\r\n      }\r\n      \r\n      // Fallback to old combined file for backward compatibility\r\n      if (gardensFromFile.length === 0) {\r\n      const persistenceFile = path.join(__dirname, 'eden-wallet-persistence.json');\r\n      if (fs.existsSync(persistenceFile)) {\r\n        const fileContent = fs.readFileSync(persistenceFile, 'utf-8');\r\n        const persisted = JSON.parse(fileContent);\r\n          // Backward compatibility: check both 'gardens' and 'indexers' fields\r\n          gardensFromFile = persisted.gardens || persisted.indexers || [];\r\n          console.log(`\uD83D\uDCCB [Indexer API] Loaded ${gardensFromFile.length} gardens from old combined file (backward compatibility)`);\r\n        }\r\n      }\r\n      \r\n      if (gardensFromFile && Array.isArray(gardensFromFile) && gardensFromFile.length > 0) {\r\n        if (gardensFromFile && Array.isArray(gardensFromFile)) {\r\n          // CRITICAL: All indexers (regular and token) are now in 'gardens' array\r\n          // Separate them into regular and token indexers\r\n          const regularIndexersFromArray = gardensFromFile.filter((idx: any) => \r\n            !(idx.tokenServiceType === 'dex' || (idx.serviceType === 'dex' && idx.id && idx.id.startsWith('T')))\r\n          );\r\n          const tokenIndexersFromArray = gardensFromFile.filter((idx: any) => \r\n            idx.tokenServiceType === 'dex' || (idx.serviceType === 'dex' && idx.id && idx.id.startsWith('T'))\r\n          );\r\n          \r\n          // In ROOT mode: ONLY return gardens created via Angular (format: garden-1, garden-2, etc.)\r\n          // Filter out all other gardens (A, B, C, etc.) - they're defaults from non-ROOT mode\r\n          if (DEPLOYED_AS_ROOT) {\r\n            persistedGardens = regularIndexersFromArray.filter((idx: any) => idx.id && (idx.id.startsWith('garden-') || idx.id.startsWith('indexer-')));\r\n            // In ROOT mode: all token indexers are created via Angular, so return all\r\n            persistedTokenGardens = tokenIndexersFromArray;\r\n          } else {\r\n            persistedGardens = regularIndexersFromArray;\r\n            // Non-ROOT mode: filter out defaults\r\n            if (NUM_TOKEN_GARDENS > 0) {\r\n              const defaultTokenIds = Array.from({ length: NUM_TOKEN_GARDENS }, (_, i) => `T${i + 1}`);\r\n              persistedTokenGardens = tokenIndexersFromArray.filter((idx: any) => !defaultTokenIds.includes(idx.id));\r\n            } else {\r\n              persistedTokenGardens = tokenIndexersFromArray;\r\n            }\r\n          }\r\n        }\r\n        \r\n        // Backward compatibility: Also check tokenIndexers field if it exists (old files)\r\n        // This is only needed when loading from the old combined file\r\n        if (gardensFromFile.length === 0) {\r\n          const persistenceFile = path.join(__dirname, 'eden-wallet-persistence.json');\r\n          if (fs.existsSync(persistenceFile)) {\r\n            try {\r\n              const fileContent = fs.readFileSync(persistenceFile, 'utf-8');\r\n              const persisted = JSON.parse(fileContent);\r\n        if (persisted.tokenIndexers && Array.isArray(persisted.tokenIndexers)) {\r\n          console.log(`\uD83D\uDCCB [Indexer API] Found tokenIndexers field (backward compatibility) - using it`);\r\n          if (DEPLOYED_AS_ROOT) {\r\n            persistedTokenGardens = persisted.tokenIndexers;\r\n          } else {\r\n            if (NUM_TOKEN_GARDENS > 0) {\r\n              const defaultTokenIds = Array.from({ length: NUM_TOKEN_GARDENS }, (_, i) => `T${i + 1}`);\r\n              persistedTokenGardens = persisted.tokenIndexers.filter((idx: any) => !defaultTokenIds.includes(idx.id));\r\n            } else {\r\n              persistedTokenGardens = persisted.tokenIndexers;\r\n                  }\r\n                }\r\n              }\r\n            } catch (err: any) {\r\n              // Ignore errors when checking for backward compatibility\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } catch (err: any) {\r\n      console.warn(`\u26A0\uFE0F  [Indexer API] Failed to load persisted indexers: ${err.message}`);\r\n    }\r\n    \r\n    // Combine all indexers: Holy Ghost (ROOT CA's indexer) + in-memory gardens + persisted gardens\r\n    // CRITICAL: Use in-memory arrays as source of truth (they include newly created gardens)\r\n    // Merge with persisted data to ensure we have all gardens (in-memory takes precedence)\r\n    const inMemoryRegularGardens = GARDENS.filter(g => g.active);\r\n    const inMemoryTokenGardens = TOKEN_GARDENS.filter(g => g.active);\r\n    \r\n    // Merge: in-memory gardens take precedence, but include persisted gardens not in memory\r\n    const allRegularGardens = new Map<string, GardenConfig>();\r\n    inMemoryRegularGardens.forEach(g => allRegularGardens.set(g.id, g));\r\n    persistedGardens.forEach(g => {\r\n      if (!allRegularGardens.has(g.id)) {\r\n        allRegularGardens.set(g.id, g);\r\n      }\r\n    });\r\n    \r\n    const allTokenGardens = new Map<string, TokenGardenConfig>();\r\n    inMemoryTokenGardens.forEach(g => allTokenGardens.set(g.id, g));\r\n    persistedTokenGardens.forEach(g => {\r\n      if (!allTokenGardens.has(g.id)) {\r\n        allTokenGardens.set(g.id, g);\r\n      }\r\n    });\r\n    \r\n    const allIndexers = [\r\n      // Holy Ghost (ROOT CA's infrastructure indexer) - listed first\r\n      ...(ecosystem === 'dex' ? [] : [{\r\n        id: HOLY_GHOST_GARDEN.id,\r\n        name: HOLY_GHOST_GARDEN.name,\r\n        stream: HOLY_GHOST_GARDEN.stream,\r\n        active: HOLY_GHOST_GARDEN.active,\r\n        uuid: HOLY_GHOST_GARDEN.uuid,\r\n        hasCertificate: !!HOLY_GHOST_GARDEN.certificate,\r\n        type: 'root' as const,\r\n        ownerEmail: undefined // ROOT CA doesn't have an owner\r\n      }]),\r\n      // Return in-memory gardens (source of truth) + persisted gardens not in memory\r\n      ...(ecosystem === 'dex' ? [] : Array.from(allRegularGardens.values()).map(i => ({\r\n        id: i.id,\r\n        name: i.name,\r\n        stream: i.stream,\r\n        active: i.active,\r\n        uuid: i.uuid,\r\n        hasCertificate: !!i.certificate,\r\n        type: 'regular' as const,\r\n        // IMPORTANT: include serviceType so frontend can load the correct workflow JSON\r\n        // (otherwise it falls back to type=regular => tries /api/workflow/regular which does not exist)\r\n        serviceType: (i as any).serviceType,\r\n        ownerEmail: i.ownerEmail || i.priestEmail || undefined\r\n      }))),\r\n      ...((ecosystem === 'saas') ? [] : Array.from(allTokenGardens.values()).map(i => ({\r\n        id: i.id,\r\n        name: i.name,\r\n        stream: i.stream,\r\n        active: i.active,\r\n        uuid: i.uuid,\r\n        hasCertificate: !!i.certificate,\r\n        type: 'token' as const,\r\n        // Include serviceType for completeness (some clients may rely on it)\r\n        serviceType: (i as any).serviceType || 'dex',\r\n        ownerEmail: i.ownerEmail || i.priestEmail || undefined\r\n      })))\r\n    ];\r\n    \r\n    console.log(`   \uD83D\uDCCB [Garden API] Returning ${allIndexers.length} garden(s): ${allIndexers.map(i => i.name).join(', ')}`);\r\n    \r\n    // Return only 'gardens' - standardized field name (no duplicate 'indexers' field)\r\n    res.end(JSON.stringify({\r\n      success: true,\r\n      gardens: allIndexers,\r\n      timestamp: Date.now()\r\n    }));\r\n    return;\r\n  }\r\n\r\n  // DEX ecosystem: list token gardens only (no Holy Ghost / no regular gardens)\r\n  if (pathname === \"/api/dex-gardens\" && req.method === \"GET\") {\r\n    const rewrittenUrl = (req.url || \"/api/dex-gardens\") + ((req.url || \"\").includes(\"?\") ? \"&\" : \"?\") + \"ecosystem=dex\";\r\n    // Reuse the /api/gardens handler by rewriting req.url for parsing in this scope\r\n    (req as any).url = rewrittenUrl;\r\n    // Fall through by calling the same logic via early return is not possible here;\r\n    // so implement a minimal response using in-memory token gardens (source of truth).\r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    const tokenGardens = TOKEN_GARDENS.filter(g => g.active).map(g => {\r\n      // Calculate total trades for this garden (sum of all pools in this garden)\r\n      let totalTrades = 0;\r\n      let totalVolume = 0;\r\n      for (const [poolId, pool] of DEX_POOLS.entries()) {\r\n        if (pool.gardenId === g.id) {\r\n          totalTrades += pool.totalTrades || 0;\r\n          totalVolume += pool.totalVolume || 0;\r\n        }\r\n      }\r\n      \r\n      return {\r\n        id: g.id,\r\n        name: g.name,\r\n        stream: g.stream,\r\n        active: g.active,\r\n        uuid: g.uuid,\r\n        hasCertificate: !!(g as any).certificate,\r\n        type: 'token' as const,\r\n        ownerEmail: (g as any).ownerEmail || (g as any).priestEmail || undefined,\r\n        initialLiquidity: (g as any).initialLiquidity || 0,\r\n        liquidityCertified: (g as any).liquidityCertified || false,\r\n        stripePaymentRailBound: (g as any).stripePaymentRailBound || false,\r\n        totalTrades: totalTrades,\r\n        totalVolume: totalVolume\r\n      };\r\n    });\r\n    res.end(JSON.stringify({ success: true, gardens: tokenGardens, timestamp: Date.now() }));\r\n    return;\r\n  }\r\n\r\n  // DEX ecosystem: token gardens by owner (priest)\r\n  if (pathname === \"/api/dex-gardens/by-owner\" && req.method === \"GET\") {\r\n    console.log(`   \u2705 [${requestId}] GET /api/dex-gardens/by-owner - Getting DEX gardens by owner email`);\r\n    try {\r\n      const u = new URL(req.url || '', `http://${req.headers.host}`);\r\n      const ownerEmail = u.searchParams.get('email');\r\n      if (!ownerEmail) {\r\n        res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: \"email query parameter required\" }));\r\n        return;\r\n      }\r\n      const ownerDexGardens = TOKEN_GARDENS\r\n        .filter(g => (g.ownerEmail || (g as any).priestEmail)?.toLowerCase() === ownerEmail.toLowerCase())\r\n        .map(g => {\r\n          // Calculate total trades for this garden (sum of all pools in this garden)\r\n          let totalTrades = 0;\r\n          let totalVolume = 0;\r\n          for (const [poolId, pool] of DEX_POOLS.entries()) {\r\n            if (pool.gardenId === g.id) {\r\n              totalTrades += pool.totalTrades || 0;\r\n              totalVolume += pool.totalVolume || 0;\r\n            }\r\n          }\r\n          \r\n          return {\r\n            id: g.id,\r\n            name: g.name,\r\n            stream: g.stream,\r\n            active: g.active,\r\n            uuid: g.uuid,\r\n            ownerEmail: g.ownerEmail || (g as any).priestEmail,\r\n            serviceType: (g as any).serviceType || 'dex',\r\n            hasCertificate: !!(g as any).certificate,\r\n            certificate: (g as any).certificate,\r\n            initialLiquidity: (g as any).initialLiquidity || 0,\r\n            liquidityCertified: (g as any).liquidityCertified || false,\r\n            stripePaymentRailBound: (g as any).stripePaymentRailBound || false,\r\n            totalTrades: totalTrades,\r\n            totalVolume: totalVolume\r\n          };\r\n        });\r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: true, gardens: ownerDexGardens, count: ownerDexGardens.length }));\r\n    } catch (err: any) {\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: err.message }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (pathname === \"/api/certificates\" && req.method === \"GET\") {\r\n    console.log(`   \u2705 [${requestId}] GET /api/certificates - Sending certificate list`);\r\n    const parsedUrl = url.parse(req.url || \"/\", true);\r\n    const uuid = parsedUrl.query.uuid as string | undefined;\r\n    \r\n    if (uuid) {\r\n      const cert = getCertificate(uuid);\r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        certificate: cert || null,\r\n        isValid: cert ? validateCertificate(uuid) : false,\r\n        timestamp: Date.now()\r\n      }));\r\n    } else {\r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        certificates: getAllCertificates(),\r\n        revoked: getRevokedCertificates(),\r\n        total: CERTIFICATE_REGISTRY.size,\r\n        timestamp: Date.now()\r\n      }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (pathname === \"/api/revoke\" && req.method === \"POST\") {\r\n    console.log(`   \u2705 [${requestId}] POST /api/revoke - Revoking certificate`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const { uuid, reason, revoked_type, severity } = JSON.parse(body);\r\n        if (!uuid || !reason) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"uuid and reason required\" }));\r\n          return;\r\n        }\r\n        \r\n        // Determine revoked_type if not provided\r\n        let revokedType: \"indexer\" | \"service\" | \"provider\" = revoked_type || \"provider\";\r\n        if (!revokedType) {\r\n          // Auto-detect based on UUID pattern\r\n          if (uuid.includes(\"indexer\") || uuid.includes(\"garden\")) {\r\n            revokedType = \"indexer\";\r\n          } else if (uuid.includes(\"service\")) {\r\n            revokedType = \"service\";\r\n          } else {\r\n            revokedType = \"provider\";\r\n          }\r\n        }\r\n        \r\n        const revokeSeverity = severity || \"hard\";\r\n        const revocation = revokeCertificate(\r\n          uuid, \r\n          reason, \r\n          revokedType,\r\n          revokeSeverity\r\n        );\r\n        \r\n        // If hard revocation of indexer, also revoke all providers in that garden\r\n        let revokedProvidersCount = 0;\r\n        if (revokeSeverity === 'hard' && revokedType === 'indexer') {\r\n          // Find the garden to get its ID\r\n          const garden = GARDENS.find(g => g.uuid === uuid) || TOKEN_GARDENS.find(g => g.uuid === uuid);\r\n          if (garden) {\r\n            // Revoke all providers in this garden\r\n            const providers = ROOT_CA_SERVICE_REGISTRY.filter(\r\n              p => p.gardenId === garden.id || (p as any).gardenId === garden.id\r\n            );\r\n            for (const provider of providers) {\r\n              try {\r\n                revokeCertificate(\r\n                  provider.uuid,\r\n                  `Garden revoked: ${reason}`,\r\n                  \"provider\",\r\n                  \"hard\"\r\n                );\r\n                revokedProvidersCount++;\r\n              } catch (err: any) {\r\n                console.warn(`\u26A0\uFE0F  Failed to revoke provider ${provider.id}: ${err.message}`);\r\n              }\r\n            }\r\n          }\r\n        }\r\n        \r\n        // Save persistence if hard revocation - remove revoked entities from JSON files\r\n        if (revokeSeverity === 'hard') {\r\n          try {\r\n            await ensureRedisConnection();\r\n            \r\n            // Save gardens to JSON file (remove revoked gardens)\r\n            const gardensFile = path.join(__dirname, 'eden-gardens-persistence.json');\r\n            if (fs.existsSync(gardensFile)) {\r\n              try {\r\n                const fileContent = fs.readFileSync(gardensFile, 'utf-8');\r\n                const persisted = JSON.parse(fileContent);\r\n                if (persisted.gardens && Array.isArray(persisted.gardens)) {\r\n                  // Remove revoked gardens from the file\r\n                  const activeGardens = persisted.gardens.filter((g: any) => {\r\n                    const isRevoked = REVOCATION_REGISTRY.has(g.uuid);\r\n                    return !isRevoked;\r\n                  });\r\n                  \r\n                  const gardensData = {\r\n                    gardens: activeGardens,\r\n                    lastSaved: new Date().toISOString()\r\n                  };\r\n                  fs.writeFileSync(gardensFile, JSON.stringify(gardensData, null, 2), 'utf-8');\r\n                  console.log(`   \uD83D\uDCBE Removed revoked gardens from ${gardensFile} (${activeGardens.length} gardens remaining)`);\r\n                }\r\n              } catch (fileErr: any) {\r\n                console.warn(`\u26A0\uFE0F  Failed to update gardens persistence file: ${fileErr.message}`);\r\n              }\r\n            }\r\n            \r\n            // Also save current in-memory gardens (which already have revoked ones removed)\r\n            const allGardens = [...GARDENS, ...TOKEN_GARDENS];\r\n            const gardensData = {\r\n              gardens: allGardens,\r\n              lastSaved: new Date().toISOString()\r\n            };\r\n            fs.writeFileSync(gardensFile, JSON.stringify(gardensData, null, 2), 'utf-8');\r\n            console.log(`   \uD83D\uDCBE Saved ${allGardens.length} active gardens to ${gardensFile}`);\r\n            \r\n            // Save service registry to JSON file (remove revoked providers)\r\n            const serviceRegistryFile = path.join(__dirname, 'eden-serviceRegistry-persistence.json');\r\n            if (fs.existsSync(serviceRegistryFile)) {\r\n              try {\r\n                const fileContent = fs.readFileSync(serviceRegistryFile, 'utf-8');\r\n                const persisted = JSON.parse(fileContent);\r\n                if (persisted.serviceRegistry && Array.isArray(persisted.serviceRegistry)) {\r\n                  // Remove revoked providers from the file\r\n                  const activeProviders = persisted.serviceRegistry.filter((p: any) => {\r\n                    const isRevoked = REVOCATION_REGISTRY.has(p.uuid);\r\n                    return !isRevoked;\r\n                  });\r\n                  \r\n                  const registryData = {\r\n                    serviceRegistry: activeProviders,\r\n                    lastSaved: new Date().toISOString()\r\n                  };\r\n                  fs.writeFileSync(serviceRegistryFile, JSON.stringify(registryData, null, 2), 'utf-8');\r\n                  console.log(`   \uD83D\uDCBE Removed revoked providers from ${serviceRegistryFile} (${activeProviders.length} providers remaining)`);\r\n                }\r\n              } catch (fileErr: any) {\r\n                console.warn(`\u26A0\uFE0F  Failed to update service registry persistence file: ${fileErr.message}`);\r\n              }\r\n            }\r\n            \r\n            // Also save current in-memory service registry (which already has revoked ones removed)\r\n            if (redis) {\r\n              redis.saveServiceRegistry();\r\n              console.log(`   \uD83D\uDCBE Saved service registry to persistence (${ROOT_CA_SERVICE_REGISTRY.length} providers remaining)`);\r\n            }\r\n          } catch (persistErr: any) {\r\n            console.warn(`\u26A0\uFE0F  Failed to save persistence after revocation: ${persistErr.message}`);\r\n          }\r\n        }\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          revocation,\r\n          revokedProvidersCount: revokedType === 'indexer' ? revokedProvidersCount : 0,\r\n          timestamp: Date.now()\r\n        }));\r\n      } catch (err: any) {\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // Get gardens by owner email (for Priest users)\r\n  if (pathname === \"/api/gardens/by-owner\" && req.method === \"GET\") {\r\n    console.log(`   \u2705 [${requestId}] GET /api/gardens/by-owner - Getting gardens by owner email`);\r\n    try {\r\n      const url = new URL(req.url || '', `http://${req.headers.host}`);\r\n      const ownerEmail = url.searchParams.get('email');\r\n      \r\n      if (!ownerEmail) {\r\n        res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: \"email query parameter required\" }));\r\n        return;\r\n      }\r\n      \r\n      // Get all gardens (regular and token) that belong to this owner\r\n      const ownerGardens = [\r\n        ...GARDENS.filter(g => (g.ownerEmail || g.priestEmail)?.toLowerCase() === ownerEmail.toLowerCase()),\r\n        ...TOKEN_GARDENS.filter(g => (g.ownerEmail || g.priestEmail)?.toLowerCase() === ownerEmail.toLowerCase())\r\n      ].map(g => ({\r\n        id: g.id,\r\n        name: g.name,\r\n        stream: g.stream,\r\n        active: g.active,\r\n        uuid: g.uuid,\r\n        ownerEmail: g.ownerEmail || g.priestEmail,\r\n        serviceType: (g as any).serviceType,\r\n        hasCertificate: !!g.certificate,\r\n        certificate: g.certificate\r\n      }));\r\n      \r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        gardens: ownerGardens,\r\n        count: ownerGardens.length\r\n      }));\r\n    } catch (err: any) {\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: err.message }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Hard shutdown garden (revoke certificate)\r\n  if (pathname === \"/api/garden/shutdown\" && req.method === \"POST\") {\r\n    console.log(`   \u2705 [${requestId}] POST /api/garden/shutdown - Hard shutdown garden`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const { gardenId, reason, requestedBy, revokeProviders = true } = JSON.parse(body);\r\n        \r\n        if (!gardenId || !reason || !requestedBy) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"gardenId, reason, and requestedBy are required\" }));\r\n          return;\r\n        }\r\n        \r\n        // Find garden by ID or UUID\r\n        const garden = GARDENS.find(g => g.id === gardenId || g.uuid === gardenId) ||\r\n                      TOKEN_GARDENS.find(g => g.id === gardenId || g.uuid === gardenId);\r\n        \r\n        if (!garden) {\r\n          res.writeHead(404, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: `Garden not found: ${gardenId}` }));\r\n          return;\r\n        }\r\n        \r\n        // Authorization check: Only owner or ROOT CA can shutdown\r\n        const ownerEmail = (garden.ownerEmail || garden.priestEmail)?.toLowerCase();\r\n        const requestedByLower = requestedBy.toLowerCase();\r\n        const isRootCA = requestedByLower === 'bill.draper.auto@gmail.com';\r\n        const isOwner = ownerEmail === requestedByLower;\r\n        \r\n        // Check priesthood certification for non-admin owners\r\n        if (isOwner && !isRootCA) {\r\n          const hasCert = hasPriesthoodCertification(requestedBy);\r\n          if (!hasCert) {\r\n            res.writeHead(403, { \"Content-Type\": \"application/json\" });\r\n            res.end(JSON.stringify({ \r\n              success: false, \r\n              error: \"Priesthood certification required to shutdown gardens. Please apply for priesthood certification first.\"\r\n            }));\r\n            return;\r\n          }\r\n        }\r\n        \r\n        if (!isRootCA && !isOwner) {\r\n          res.writeHead(403, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ \r\n            success: false, \r\n            error: `Unauthorized: Only garden owner (${ownerEmail}) or ROOT CA can shutdown this garden` \r\n          }));\r\n          return;\r\n        }\r\n        \r\n        // Revoke certificate (hard shutdown)\r\n        const revocation = revokeCertificate(\r\n          garden.uuid,\r\n          reason,\r\n          \"indexer\",\r\n          \"hard\",\r\n          { requestedBy, gardenId, revokeProviders }\r\n        );\r\n        \r\n        // Optionally revoke all providers in this garden\r\n        let revokedProvidersCount = 0;\r\n        const providersToRevoke: any[] = [];\r\n        if (revokeProviders) {\r\n          const providers = ROOT_CA_SERVICE_REGISTRY.filter(\r\n            p => p.gardenId === gardenId || (p as any).gardenId === garden.id\r\n          );\r\n          providersToRevoke.push(...providers);\r\n          for (const provider of providers) {\r\n            try {\r\n              revokeCertificate(\r\n                provider.uuid,\r\n                `Garden shutdown: ${reason}`,\r\n                \"provider\",\r\n                \"hard\",\r\n                { requestedBy, gardenId }\r\n              );\r\n              revokedProvidersCount++;\r\n            } catch (err: any) {\r\n              console.warn(`\u26A0\uFE0F  Failed to revoke provider ${provider.id}: ${err.message}`);\r\n            }\r\n          }\r\n        }\r\n        \r\n        // Remove revoked providers from ROOT_CA_SERVICE_REGISTRY\r\n        for (const provider of providersToRevoke) {\r\n          const providerIndex = ROOT_CA_SERVICE_REGISTRY.findIndex(p => p.uuid === provider.uuid);\r\n          if (providerIndex !== -1) {\r\n            ROOT_CA_SERVICE_REGISTRY.splice(providerIndex, 1);\r\n            console.log(`   \uD83D\uDDD1\uFE0F  Removed provider ${provider.id} (${provider.name}) from ROOT_CA_SERVICE_REGISTRY`);\r\n          }\r\n        }\r\n        \r\n        // Remove garden from GARDENS or TOKEN_GARDENS array\r\n        const gardenIndex = GARDENS.findIndex(g => g.id === gardenId || g.uuid === garden.uuid);\r\n        if (gardenIndex !== -1) {\r\n          GARDENS.splice(gardenIndex, 1);\r\n          console.log(`   \uD83D\uDDD1\uFE0F  Removed garden ${garden.id} (${garden.name}) from GARDENS array`);\r\n        } else {\r\n          const tokenGardenIndex = TOKEN_GARDENS.findIndex(g => g.id === gardenId || g.uuid === garden.uuid);\r\n          if (tokenGardenIndex !== -1) {\r\n            TOKEN_GARDENS.splice(tokenGardenIndex, 1);\r\n            console.log(`   \uD83D\uDDD1\uFE0F  Removed garden ${garden.id} (${garden.name}) from TOKEN_GARDENS array`);\r\n          }\r\n        }\r\n        \r\n        // Save persistence (gardens and service registry) - remove revoked entities from JSON files\r\n        try {\r\n          await ensureRedisConnection();\r\n          \r\n          // Save gardens to JSON file (remove revoked gardens)\r\n          const gardensFile = path.join(__dirname, 'eden-gardens-persistence.json');\r\n          if (fs.existsSync(gardensFile)) {\r\n            try {\r\n              const fileContent = fs.readFileSync(gardensFile, 'utf-8');\r\n              const persisted = JSON.parse(fileContent);\r\n              if (persisted.gardens && Array.isArray(persisted.gardens)) {\r\n                // Remove revoked gardens from the file\r\n                const activeGardens = persisted.gardens.filter((g: any) => {\r\n                  const isRevoked = REVOCATION_REGISTRY.has(g.uuid);\r\n                  return !isRevoked;\r\n                });\r\n                \r\n                const gardensData = {\r\n                  gardens: activeGardens,\r\n                  lastSaved: new Date().toISOString()\r\n                };\r\n                fs.writeFileSync(gardensFile, JSON.stringify(gardensData, null, 2), 'utf-8');\r\n                console.log(`   \uD83D\uDCBE Removed revoked gardens from ${gardensFile} (${activeGardens.length} gardens remaining)`);\r\n              }\r\n            } catch (fileErr: any) {\r\n              console.warn(`\u26A0\uFE0F  Failed to update gardens persistence file: ${fileErr.message}`);\r\n            }\r\n          }\r\n          \r\n          // Also save current in-memory gardens (which already have revoked ones removed)\r\n          const allGardens = [...GARDENS, ...TOKEN_GARDENS];\r\n          const gardensData = {\r\n            gardens: allGardens,\r\n            lastSaved: new Date().toISOString()\r\n          };\r\n          fs.writeFileSync(gardensFile, JSON.stringify(gardensData, null, 2), 'utf-8');\r\n          console.log(`   \uD83D\uDCBE Saved ${allGardens.length} active gardens to ${gardensFile}`);\r\n          \r\n          // Save service registry to JSON file (remove revoked providers)\r\n          const serviceRegistryFile = path.join(__dirname, 'eden-serviceRegistry-persistence.json');\r\n          if (fs.existsSync(serviceRegistryFile)) {\r\n            try {\r\n              const fileContent = fs.readFileSync(serviceRegistryFile, 'utf-8');\r\n              const persisted = JSON.parse(fileContent);\r\n              if (persisted.serviceRegistry && Array.isArray(persisted.serviceRegistry)) {\r\n                // Remove revoked providers from the file\r\n                const activeProviders = persisted.serviceRegistry.filter((p: any) => {\r\n                  const isRevoked = REVOCATION_REGISTRY.has(p.uuid);\r\n                  return !isRevoked;\r\n                });\r\n                \r\n                const registryData = {\r\n                  serviceRegistry: activeProviders,\r\n                  lastSaved: new Date().toISOString()\r\n                };\r\n                fs.writeFileSync(serviceRegistryFile, JSON.stringify(registryData, null, 2), 'utf-8');\r\n                console.log(`   \uD83D\uDCBE Removed revoked providers from ${serviceRegistryFile} (${activeProviders.length} providers remaining)`);\r\n              }\r\n            } catch (fileErr: any) {\r\n              console.warn(`\u26A0\uFE0F  Failed to update service registry persistence file: ${fileErr.message}`);\r\n            }\r\n          }\r\n          \r\n          // Also save current in-memory service registry (which already has revoked ones removed)\r\n          if (redis) {\r\n            redis.saveServiceRegistry();\r\n            console.log(`   \uD83D\uDCBE Saved service registry to persistence (${ROOT_CA_SERVICE_REGISTRY.length} providers remaining)`);\r\n          }\r\n        } catch (persistErr: any) {\r\n          console.warn(`\u26A0\uFE0F  Failed to save persistence after shutdown: ${persistErr.message}`);\r\n        }\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          revocation,\r\n          garden: {\r\n            id: garden.id,\r\n            name: garden.name,\r\n            uuid: garden.uuid,\r\n            active: false,\r\n            removed: true\r\n          },\r\n          revokedProvidersCount,\r\n          removedProvidersCount: providersToRevoke.length,\r\n          timestamp: Date.now()\r\n        }));\r\n      } catch (err: any) {\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  if (pathname === \"/api/reinstate\" && req.method === \"POST\") {\r\n    console.log(`   \u2705 [${requestId}] POST /api/reinstate - Reinstating certificate`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const { uuid } = JSON.parse(body);\r\n        if (!uuid) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"uuid required\" }));\r\n          return;\r\n        }\r\n        \r\n        // Remove from revocation registry (reinstatement)\r\n        const wasRevoked = REVOCATION_REGISTRY.has(uuid);\r\n        if (wasRevoked) {\r\n          REVOCATION_REGISTRY.delete(uuid);\r\n          \r\n          // Reactivate entity\r\n          const indexer = GARDENS.find(i => i.uuid === uuid);\r\n          if (indexer) {\r\n            indexer.active = true;\r\n            // Note: Certificate would need to be re-issued in a real system\r\n          }\r\n          \r\n          const provider = ROOT_CA_SERVICE_REGISTRY.find(p => p.uuid === uuid);\r\n          if (provider) {\r\n            provider.status = 'active'; // Reactivate provider in ROOT_CA_SERVICE_REGISTRY\r\n            // Note: Certificate would need to be re-issued in a real system\r\n            console.log(`   Service provider ${provider.name} (${provider.id}) reactivated in ROOT_CA_SERVICE_REGISTRY`);\r\n          }\r\n          \r\n          console.log(`\u2705 Certificate reinstated: ${uuid}`);\r\n          \r\n          broadcastEvent({\r\n            type: \"certificate_reinstated\",\r\n            component: \"root-ca\",\r\n            message: `Certificate reinstated: ${uuid}`,\r\n            timestamp: Date.now(),\r\n            data: { uuid }\r\n          });\r\n          \r\n          res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({\r\n            success: true,\r\n            message: \"Certificate reinstated\",\r\n            uuid,\r\n            timestamp: Date.now()\r\n          }));\r\n        } else {\r\n          res.writeHead(404, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Certificate not found in revocation registry\" }));\r\n        }\r\n      } catch (err: any) {\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  if (pathname === \"/api/status\" && req.method === \"GET\") {\r\n    console.log(`   \u2705 [${requestId}] GET /api/status - Sending status`);\r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({\r\n      status: \"online\",\r\n      websocketClients: wsClients.size,\r\n      timestamp: Date.now()\r\n    }));\r\n    return;\r\n  }\r\n\r\n  // ============================================\r\n  // JESUSCOIN (JSC) STRIPE INTEGRATION\r\n  // ============================================\r\n\r\n  // POST /api/jsc/buy - Create Stripe Checkout session\r\n  if (pathname === \"/api/jsc/buy\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDCB0 [${requestId}] POST /api/jsc/buy - Creating Stripe Checkout session`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const { email, amount } = JSON.parse(body);\r\n        \r\n        if (!email || typeof email !== 'string' || !email.includes('@')) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Valid email address required\" }));\r\n          return;\r\n        }\r\n        \r\n        if (!amount || typeof amount !== 'number' || amount <= 0) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Valid amount required (must be > 0)\" }));\r\n          return;\r\n        }\r\n        \r\n        // Create Stripe Checkout session\r\n        const session = await stripe.checkout.sessions.create({\r\n          payment_method_types: ['card'],\r\n          line_items: [\r\n            {\r\n              price_data: {\r\n                currency: 'usd',\r\n                product_data: {\r\n                  name: '\uD83C\uDF4E APPLES',\r\n                  description: `Purchase ${amount} \uD83C\uDF4E APPLES (1 \uD83C\uDF4E = 1 USD)`,\r\n                },\r\n                unit_amount: Math.round(amount * 100), // Convert to cents\r\n              },\r\n              quantity: 1,\r\n            },\r\n          ],\r\n          mode: 'payment',\r\n          success_url: `${req.headers.origin || 'http://localhost:4200'}/?jsc_success=true&session_id={CHECKOUT_SESSION_ID}`,\r\n          cancel_url: `${req.headers.origin || 'http://localhost:4200'}/?jsc_canceled=true`,\r\n          customer_email: email,\r\n          metadata: {\r\n            user_email: email,\r\n            jsc_amount: amount.toString(),\r\n          },\r\n        });\r\n        \r\n        console.log(`   \u2705 Stripe Checkout session created: ${session.id} for ${email} (${amount} \uD83C\uDF4E APPLES)`);\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          sessionId: session.id,\r\n          url: session.url,\r\n          publishableKey: STRIPE_PUBLISHABLE_KEY,\r\n        }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C Error creating Stripe Checkout session:`, err);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // POST /api/dex-liquidity/buy - Create Stripe Checkout session for DEX initial liquidity\r\n  if (pathname === \"/api/dex-liquidity/buy\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDCB0 [${requestId}] POST /api/dex-liquidity/buy - Creating Stripe Checkout session for DEX liquidity`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const { email, amount, gardenName, tokenSymbol, baseToken } = JSON.parse(body);\r\n        \r\n        if (!email || typeof email !== 'string' || !email.includes('@')) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Valid email address required\" }));\r\n          return;\r\n        }\r\n        \r\n        const MIN_LIQUIDITY_AMOUNT = 10000;\r\n        if (!amount || typeof amount !== 'number' || amount < MIN_LIQUIDITY_AMOUNT) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: `Initial liquidity must be at least ${MIN_LIQUIDITY_AMOUNT} \uD83C\uDF4E APPLES` }));\r\n          return;\r\n        }\r\n        \r\n        // Create Stripe Checkout session for DEX liquidity\r\n        const session = await stripe.checkout.sessions.create({\r\n          payment_method_types: ['card'],\r\n          line_items: [\r\n            {\r\n              price_data: {\r\n                currency: 'usd',\r\n                product_data: {\r\n                  name: 'DEX Initial Liquidity',\r\n                  description: `Load ${amount} \uD83C\uDF4E APPLES initial liquidity for ${gardenName || 'DEX Garden'} (${tokenSymbol || 'TOKEN'}/${baseToken || 'SOL'})`,\r\n                },\r\n                unit_amount: Math.round(amount * 100), // Convert to cents\r\n              },\r\n              quantity: 1,\r\n            },\r\n          ],\r\n          mode: 'payment',\r\n          success_url: `${req.headers.origin || 'http://localhost:4200'}/dex-garden-wizard?dex_liquidity_success=true&session_id={CHECKOUT_SESSION_ID}`,\r\n          cancel_url: `${req.headers.origin || 'http://localhost:4200'}/dex-garden-wizard?dex_liquidity_canceled=true`,\r\n          customer_email: email,\r\n          metadata: {\r\n            user_email: email,\r\n            liquidity_amount: amount.toString(),\r\n            purchase_type: 'dex_initial_liquidity',\r\n            purpose: 'dex_initial_liquidity',\r\n            garden_name: gardenName || 'DEX Garden',\r\n            token_symbol: tokenSymbol || 'TOKEN',\r\n            base_token: baseToken || 'SOL',\r\n          },\r\n        });\r\n        \r\n        console.log(`   \u2705 Stripe Checkout session created for DEX liquidity: ${session.id} for ${email} (${amount} \uD83C\uDF4E APPLES)`);\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ \r\n          success: true, \r\n          sessionId: session.id,\r\n          url: session.url \r\n        }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C Error creating Stripe Checkout session for DEX liquidity:`, err);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message || \"Failed to create Stripe checkout session\" }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // POST /api/garden/buy - Create Stripe Checkout session for garden purchase\r\n  if (pathname === \"/api/garden/buy\" && req.method === \"POST\") {\r\n    console.log(`   \uD83C\uDFAC [${requestId}] POST /api/garden/buy - Creating Stripe Checkout session for garden purchase`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const { email, amount, gardenType } = JSON.parse(body);\r\n        \r\n        if (!email || typeof email !== 'string' || !email.includes('@')) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Valid email address required\" }));\r\n          return;\r\n        }\r\n        \r\n        if (!amount || typeof amount !== 'number' || amount <= 0) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Valid amount required (must be > 0)\" }));\r\n          return;\r\n        }\r\n        \r\n        if (!gardenType || gardenType !== 'movie') {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Only 'movie' garden type is supported\" }));\r\n          return;\r\n        }\r\n        \r\n        // Create Stripe Checkout session for garden purchase\r\n        const session = await stripe.checkout.sessions.create({\r\n          payment_method_types: ['card'],\r\n          line_items: [\r\n            {\r\n              price_data: {\r\n                currency: 'usd',\r\n                product_data: {\r\n                  name: 'Movie Service Garden',\r\n                  description: `Install a new movie service garden (${amount} \uD83C\uDF4E APPLES)`,\r\n                },\r\n                unit_amount: Math.round(amount * 100), // Convert to cents\r\n              },\r\n              quantity: 1,\r\n            },\r\n          ],\r\n          mode: 'payment',\r\n          success_url: `${req.headers.origin || 'http://localhost:4200'}/?garden_success=true&session_id={CHECKOUT_SESSION_ID}`,\r\n          cancel_url: `${req.headers.origin || 'http://localhost:4200'}/?garden_canceled=true`,\r\n          customer_email: email,\r\n          metadata: {\r\n            user_email: email,\r\n            jsc_amount: amount.toString(),\r\n            garden_type: gardenType,\r\n            purchase_type: 'garden',\r\n          },\r\n        });\r\n        \r\n        console.log(`   \u2705 Stripe Checkout session created for garden purchase: ${session.id} for ${email} (${amount} \uD83C\uDF4E APPLES)`);\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          sessionId: session.id,\r\n          url: session.url,\r\n          publishableKey: STRIPE_PUBLISHABLE_KEY,\r\n        }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C Error creating Stripe Checkout session for garden:`, err);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // POST /api/garden/purchase - Purchase garden directly from wallet balance\r\n  if (pathname === \"/api/garden/purchase\" && req.method === \"POST\") {\r\n    console.log(`   \uD83C\uDFAC [${requestId}] POST /api/garden/purchase - Purchasing garden from wallet`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const { email, amount, gardenType } = JSON.parse(body);\r\n        \r\n        if (!email || typeof email !== 'string' || !email.includes('@')) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Valid email address required\" }));\r\n          return;\r\n        }\r\n        \r\n        if (!amount || typeof amount !== 'number' || amount <= 0) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Valid amount required (must be > 0)\" }));\r\n          return;\r\n        }\r\n        \r\n        if (!gardenType || gardenType !== 'movie') {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Only 'movie' garden type is supported\" }));\r\n          return;\r\n        }\r\n        \r\n        // Check wallet balance\r\n        const balance = await getWalletBalance(email);\r\n        if (balance < amount) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ \r\n            success: false, \r\n            error: `Insufficient balance. Required: ${amount} \uD83C\uDF4E APPLES, Available: ${balance} \uD83C\uDF4E APPLES` \r\n          }));\r\n          return;\r\n        }\r\n        \r\n        // Debit wallet balance\r\n        const txId = crypto.randomUUID();\r\n        const debitResult = await debitWallet(\r\n          email,\r\n          amount,\r\n          txId,\r\n          'garden_purchase',\r\n          { gardenType: gardenType }\r\n        );\r\n        \r\n        if (!debitResult.success) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: debitResult.error || \"Failed to debit wallet\" }));\r\n          return;\r\n        }\r\n        \r\n        // CRITICAL: In ROOT mode, indexers must be created via Angular wizard, not via this endpoint\r\n        if (DEPLOYED_AS_ROOT) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ \r\n            success: false, \r\n            error: \"Cannot create indexers via this endpoint in ROOT mode. Use the Angular wizard (/api/wizard/create-indexer) instead.\" \r\n          }));\r\n          return;\r\n        }\r\n        \r\n        // Register new movie indexer\r\n        console.log(`   \uD83C\uDFAC Registering new movie garden for ${email} (wallet purchase)...`);\r\n        const newGarden = await registerNewMovieGarden(\r\n          email,\r\n          `wallet:${txId}`, // Use wallet transaction ID instead of Stripe payment intent\r\n          undefined, // No Stripe customer ID\r\n          undefined, // No Stripe payment method ID\r\n          undefined  // No Stripe session ID\r\n        );\r\n        \r\n        const newBalance = await getWalletBalance(email);\r\n        \r\n        console.log(`   \u2705 Garden purchased from wallet: ${newGarden.name} (${newGarden.id})`);\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          gardenId: newGarden.id,\r\n          gardenName: newGarden.name,\r\n          gardenUuid: newGarden.uuid,\r\n          balance: newBalance,\r\n          amount: amount\r\n        }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C Error purchasing indexer from wallet:`, err);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // POST /api/stripe/webhook - Handle Stripe webhooks\r\n  if (pathname === \"/api/stripe/webhook\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDD14 [${requestId}] POST /api/stripe/webhook - Processing Stripe webhook`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    req.on(\"end\", async () => {\r\n      const sig = req.headers['stripe-signature'];\r\n      \r\n      // For local development: if webhook secret is placeholder, skip signature verification\r\n      const isTestMode = STRIPE_WEBHOOK_SECRET === \"whsec_your_webhook_secret_here\";\r\n      \r\n      let event: Stripe.Event;\r\n      \r\n      if (isTestMode) {\r\n        console.log(`   \u26A0\uFE0F  Test mode: Skipping webhook signature verification`);\r\n        // Parse JSON directly for test mode\r\n        try {\r\n          const jsonBody = JSON.parse(body);\r\n          event = jsonBody as Stripe.Event;\r\n          console.log(`   \u2705 Test mode: Parsed webhook event: ${event.type} (${event.id || 'no-id'})`);\r\n        } catch (err: any) {\r\n          console.error(`   \u274C Failed to parse webhook body:`, err.message);\r\n          console.log(`   \uD83D\uDCC4 Raw body:`, body.substring(0, 500));\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: `Failed to parse webhook body: ${err.message}` }));\r\n          return;\r\n        }\r\n      } else {\r\n        // Production mode: verify signature\r\n        if (!sig) {\r\n          console.error(`   \u274C Missing Stripe signature header`);\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Missing stripe-signature header\" }));\r\n          return;\r\n        }\r\n        \r\n        try {\r\n          // Verify webhook signature\r\n          event = stripe.webhooks.constructEvent(body, sig, STRIPE_WEBHOOK_SECRET);\r\n          console.log(`   \u2705 Stripe webhook verified: ${event.type} (${event.id})`);\r\n        } catch (err: any) {\r\n          console.error(`   \u274C Stripe webhook signature verification failed:`, err.message);\r\n          const sigStr = Array.isArray(sig) ? sig[0] : sig;\r\n          console.log(`   \uD83D\uDCC4 Body length: ${body.length}, Signature: ${sigStr ? sigStr.substring(0, 50) : 'N/A'}...`);\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: `Webhook signature verification failed: ${err.message}` }));\r\n          return;\r\n        }\r\n      }\r\n      \r\n      try {\r\n        // Handle checkout.session.completed event\r\n        if (event.type === 'checkout.session.completed') {\r\n          const session = event.data.object as Stripe.Checkout.Session;\r\n          \r\n          console.log(`   \uD83D\uDCCB Processing checkout.session.completed:`);\r\n          console.log(`      Session ID: ${session.id}`);\r\n          console.log(`      Payment Status: ${session.payment_status}`);\r\n          console.log(`      Customer Email: ${session.customer_email || session.metadata?.user_email || 'N/A'}`);\r\n          console.log(`      Metadata:`, JSON.stringify(session.metadata || {}, null, 2));\r\n          \r\n          if (session.payment_status === 'paid') {\r\n            const email = session.customer_email || session.metadata?.user_email;\r\n            const jscAmount = parseFloat(session.metadata?.jsc_amount || '0');\r\n            const liquidityAmount = parseFloat(session.metadata?.liquidity_amount || '0');\r\n            const paymentIntentId = session.payment_intent as string;\r\n            const customerId = session.customer as string;\r\n            const purchaseType = session.metadata?.purchase_type; // 'garden' or undefined (JSC purchase)\r\n            const gardenType = session.metadata?.garden_type; // 'movie' or undefined\r\n            const purpose = session.metadata?.purpose; // 'dex_initial_liquidity' or undefined\r\n            \r\n            if (!email) {\r\n              console.error(`   \u274C Missing email in Stripe session: ${session.id}`);\r\n              res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n              res.end(JSON.stringify({ success: false, error: \"Missing email in session\" }));\r\n              return;\r\n            }\r\n            \r\n            if (jscAmount <= 0) {\r\n              console.error(`   \u274C Invalid JSC amount in session metadata: ${session.metadata?.jsc_amount}`);\r\n              res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n              res.end(JSON.stringify({ success: false, error: \"Invalid \uD83C\uDF4E APPLES amount\" }));\r\n              return;\r\n            }\r\n            \r\n            // Retrieve payment intent to get payment method ID\r\n            let paymentMethodId: string | null = null;\r\n            if (paymentIntentId) {\r\n              try {\r\n                const paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentId);\r\n                paymentMethodId = typeof paymentIntent.payment_method === 'string' \r\n                  ? paymentIntent.payment_method \r\n                  : paymentIntent.payment_method?.id || null;\r\n                console.log(`   \uD83D\uDCB3 Retrieved payment intent: ${paymentIntentId}, Payment Method: ${paymentMethodId || 'N/A'}`);\r\n              } catch (err: any) {\r\n                console.warn(`   \u26A0\uFE0F  Could not retrieve payment intent ${paymentIntentId}:`, err.message);\r\n              }\r\n            }\r\n            \r\n            // Check if this is a garden purchase\r\n            if (purchaseType === 'garden' && gardenType === 'movie') {\r\n              // CRITICAL: In ROOT mode, gardens must be created via Angular wizard, not via Stripe webhook\r\n              if (DEPLOYED_AS_ROOT) {\r\n                console.warn(`   \u26A0\uFE0F  [Stripe Webhook] Cannot create garden via webhook in ROOT mode. Use Angular wizard instead.`);\r\n                return;\r\n              }\r\n              // Register new movie garden after payment\r\n              console.log(`   \uD83C\uDFAC Registering new movie garden for ${email}...`);\r\n              const newGarden = await registerNewMovieGarden(email, paymentIntentId, customerId, paymentMethodId, session.id);\r\n              \r\n              console.log(`   \u2705 Movie garden registered successfully: ${newGarden.id} (${newGarden.name})`);\r\n              console.log(`      Stripe Customer ID: ${customerId}`);\r\n              console.log(`      Payment Intent ID: ${paymentIntentId}`);\r\n              console.log(`      Session ID: ${session.id}`);\r\n            } else {\r\n              // Regular JSC purchase - mint JSC\r\n              console.log(`   \uD83E\uDE99 Minting ${jscAmount} \uD83C\uDF4E APPLES for ${email}...`);\r\n              await mintJSC(email, jscAmount, paymentIntentId, customerId, paymentMethodId, session.id);\r\n\r\n              console.log(`   \u2705 \uD83C\uDF4E APPLES minted successfully: ${jscAmount} \uD83C\uDF4E APPLES for ${email}`);\r\n              console.log(`      Stripe Customer ID: ${customerId}`);\r\n              console.log(`      Payment Intent ID: ${paymentIntentId}`);\r\n              console.log(`      Payment Method ID: ${paymentMethodId || 'N/A'}`);\r\n              console.log(`      Session ID: ${session.id}`);\r\n            }\r\n          } else {\r\n            console.log(`   \u26A0\uFE0F  Payment status is not 'paid': ${session.payment_status}`);\r\n          }\r\n        } else {\r\n          console.log(`   \u2139\uFE0F  Unhandled webhook event type: ${event.type}`);\r\n        }\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ received: true }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C Error processing webhook:`, err);\r\n        console.error(`   \uD83D\uDCC4 Stack:`, err.stack);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: `Webhook processing error: ${err.message}` }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // GET /api/jsc/check-session/:sessionId - Check Stripe session status and mint JSC if needed (fallback for local dev)\r\n  if (pathname.startsWith(\"/api/jsc/check-session/\") && req.method === \"GET\") {\r\n    const sessionId = pathname.split(\"/\").pop();\r\n    console.log(`   \uD83D\uDD0D [${requestId}] GET /api/jsc/check-session/${sessionId} - Checking Stripe session status`);\r\n    \r\n    if (!sessionId || !sessionId.startsWith(\"cs_\")) {\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: \"Invalid session ID\" }));\r\n      return;\r\n    }\r\n    \r\n    try {\r\n      // Retrieve session from Stripe\r\n      const session = await stripe.checkout.sessions.retrieve(sessionId);\r\n      \r\n      console.log(`   \uD83D\uDCCB Session status: ${session.payment_status} (${session.status})`);\r\n      \r\n      // Check if already minted by looking for ledger entry\r\n      const existingMint = LEDGER.find(entry => \r\n        entry.serviceType === 'mint' &&\r\n        entry.bookingDetails?.stripeSessionId === sessionId\r\n      );\r\n      \r\n      if (existingMint) {\r\n        console.log(`   \u2705 JSC already minted for this session (entry: ${existingMint.entryId})`);\r\n        const email = session.customer_email || session.metadata?.user_email;\r\n        const balance = email ? await getWalletBalance(email) : 0;\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ \r\n          success: true, \r\n          alreadyMinted: true,\r\n          sessionId: session.id,\r\n          paymentStatus: session.payment_status,\r\n          email: email || null,\r\n          balance: balance\r\n        }));\r\n        return;\r\n      }\r\n      \r\n      // If payment is successful but not processed yet, process it now\r\n      if (session.payment_status === 'paid' && session.status === 'complete') {\r\n        const email = session.customer_email || session.metadata?.user_email;\r\n        const jscAmount = parseFloat(session.metadata?.jsc_amount || '0');\r\n        const liquidityAmount = parseFloat(session.metadata?.liquidity_amount || '0');\r\n        const paymentIntentId = session.payment_intent as string;\r\n        const customerId = session.customer as string;\r\n        const purchaseType = session.metadata?.purchase_type;\r\n        const gardenType = session.metadata?.garden_type;\r\n        const purpose = session.metadata?.purpose; // 'dex_initial_liquidity' or undefined\r\n        \r\n        if (!email) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Missing email in session\" }));\r\n          return;\r\n        }\r\n        \r\n        // Handle DEX liquidity payment (different from JSC purchase)\r\n        if (purpose === 'dex_initial_liquidity') {\r\n          const MIN_LIQUIDITY_AMOUNT = 10000;\r\n          if (liquidityAmount < MIN_LIQUIDITY_AMOUNT) {\r\n            res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n            res.end(JSON.stringify({ success: false, error: `Invalid liquidity amount: ${liquidityAmount} (minimum: ${MIN_LIQUIDITY_AMOUNT} \uD83C\uDF4E APPLES)` }));\r\n            return;\r\n          }\r\n          \r\n          console.log(`   \u2705 DEX liquidity payment confirmed: ${liquidityAmount} \uD83C\uDF4E APPLES`);\r\n          console.log(`      Payment Intent ID: ${paymentIntentId}`);\r\n          console.log(`      Garden: ${session.metadata?.garden_name || 'N/A'}`);\r\n          console.log(`      Token Pair: ${session.metadata?.token_symbol || 'TOKEN'}/${session.metadata?.base_token || 'SOL'}`);\r\n          \r\n          // Return session info with payment intent ID for DEX garden creation\r\n          res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ \r\n            success: true, \r\n            session: session,\r\n            paymentIntentId: paymentIntentId,\r\n            liquidityAmount: liquidityAmount,\r\n            paymentStatus: session.payment_status\r\n          }));\r\n          return;\r\n        }\r\n        \r\n        if (jscAmount <= 0) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Invalid \uD83C\uDF4E APPLES amount in session metadata\" }));\r\n          return;\r\n        }\r\n        \r\n        // Retrieve payment intent to get payment method ID\r\n        let paymentMethodId: string | null = null;\r\n        if (paymentIntentId) {\r\n          try {\r\n            const paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentId);\r\n            paymentMethodId = typeof paymentIntent.payment_method === 'string' \r\n              ? paymentIntent.payment_method \r\n              : paymentIntent.payment_method?.id || null;\r\n          } catch (err: any) {\r\n            console.warn(`   \u26A0\uFE0F  Could not retrieve payment intent ${paymentIntentId}:`, err.message);\r\n          }\r\n        }\r\n        \r\n        // Check if this is a garden purchase\r\n        if (purchaseType === 'garden' && gardenType === 'movie') {\r\n          // Check if garden already registered\r\n          const existingGarden = LEDGER.find(entry => \r\n            entry.serviceType === 'garden_purchase' &&\r\n            entry.bookingDetails?.stripeSessionId === sessionId\r\n          );\r\n          \r\n          if (existingGarden) {\r\n            console.log(`   \u2705 Garden already registered for this session`);\r\n            const balance = await getWalletBalance(email);\r\n            res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n            res.end(JSON.stringify({ \r\n              success: true, \r\n              alreadyRegistered: true,\r\n              sessionId: session.id,\r\n              paymentStatus: session.payment_status,\r\n              email: email,\r\n              balance: balance,\r\n              gardenId: (existingGarden.bookingDetails as any)?.gardenId,\r\n              gardenName: (existingGarden.bookingDetails as any)?.gardenName\r\n            }));\r\n            return;\r\n          }\r\n          \r\n          // CRITICAL: In ROOT mode, indexers must be created via Angular wizard, not via this endpoint\r\n          if (DEPLOYED_AS_ROOT) {\r\n            res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n            res.end(JSON.stringify({ \r\n              success: false, \r\n              error: \"Cannot create indexers via this endpoint in ROOT mode. Use the Angular wizard (/api/wizard/create-indexer) instead.\" \r\n            }));\r\n            return;\r\n          }\r\n          \r\n          // Register new movie indexer\r\n          console.log(`   \uD83C\uDFAC Registering new movie garden for ${email} (fallback mechanism)...`);\r\n          const newGarden = await registerNewMovieGarden(email, paymentIntentId, customerId, paymentMethodId, session.id);\r\n          const balance = await getWalletBalance(email);\r\n          \r\n          res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ \r\n            success: true, \r\n            registered: true,\r\n            sessionId: session.id,\r\n            paymentStatus: session.payment_status,\r\n            email: email,\r\n            amount: jscAmount,\r\n            balance: balance,\r\n            gardenId: newGarden.id,\r\n            gardenName: newGarden.name\r\n          }));\r\n          return;\r\n        } else {\r\n          // Regular JSC purchase - mint JSC (fallback for local dev when webhook doesn't fire)\r\n          console.log(`   \uD83E\uDE99 Minting ${jscAmount} \uD83C\uDF4E APPLES for ${email} (fallback mechanism)...`);\r\n          await mintJSC(email, jscAmount, paymentIntentId, customerId, paymentMethodId, session.id);\r\n          \r\n          const balance = await getWalletBalance(email);\r\n          \r\n          res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ \r\n            success: true, \r\n            minted: true,\r\n            sessionId: session.id,\r\n            paymentStatus: session.payment_status,\r\n            email: email,\r\n            amount: jscAmount,\r\n            balance: balance\r\n          }));\r\n          return;\r\n        }\r\n      } else {\r\n        // Payment not completed yet\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ \r\n          success: true, \r\n          minted: false,\r\n          sessionId: session.id,\r\n          paymentStatus: session.payment_status,\r\n          status: session.status,\r\n          message: \"Payment not completed yet\"\r\n        }));\r\n        return;\r\n      }\r\n    } catch (err: any) {\r\n      console.error(`   \u274C Error checking Stripe session:`, err);\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: err.message }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // GET /api/jsc/balance/:email - Get user JSC balance (from Wallet Service - authoritative source)\r\n  if (pathname.startsWith(\"/api/jsc/balance/\") && req.method === \"GET\") {\r\n    const email = decodeURIComponent(pathname.split(\"/api/jsc/balance/\")[1]);\r\n    console.log(`   \uD83D\uDCB0 [${requestId}] GET /api/jsc/balance/${email} - Getting JSC balance from Wallet Service`);\r\n    \r\n    // Get balance from Wallet Service (authoritative source)\r\n    const balance = await getWalletBalance(email);\r\n    \r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({\r\n      success: true,\r\n      email,\r\n      balance,\r\n      currency: \"JSC\",\r\n      walletService: \"wallet-service-001\",\r\n      indexerId: \"HG\", // Holy Ghost indexer\r\n    }));\r\n    return;\r\n  }\r\n\r\n  // POST /api/wallet/reset - Reset wallet persistence file (clear all wallet balances)\r\n  if (pathname === \"/api/wallet/reset\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDD04 [${requestId}] POST /api/wallet/reset - Clearing generated indexers only`);\r\n    \r\n    try {\r\n      await ensureRedisConnection();\r\n      \r\n      // Clear generated indexers from in-memory arrays\r\n      // Keep only the default indexers (A, B, C, etc. and T1, T2, etc.)\r\n      // Remove dynamically created gardens (those with IDs starting with 'garden-' or 'indexer-')\r\n      const dynamicIndexers = GARDENS.filter(i => i.id.startsWith('garden-') || i.id.startsWith('indexer-'));\r\n      const dynamicTokenIndexers = TOKEN_GARDENS.filter(i => i.id.startsWith('garden-') || i.id.startsWith('indexer-'));\r\n      \r\n      const clearedIndexersCount = dynamicIndexers.length + dynamicTokenIndexers.length;\r\n      \r\n      // Remove dynamic gardens from arrays (filter out those starting with 'garden-' or 'indexer-')\r\n      const filteredIndexers = GARDENS.filter(i => !i.id.startsWith('garden-') && !i.id.startsWith('indexer-'));\r\n      const filteredTokenIndexers = TOKEN_GARDENS.filter(i => !i.id.startsWith('garden-') && !i.id.startsWith('indexer-'));\r\n      \r\n      // Clear arrays and repopulate with filtered indexers\r\n      GARDENS.length = 0;\r\n      GARDENS.push(...filteredIndexers);\r\n      \r\n      TOKEN_GARDENS.length = 0;\r\n      TOKEN_GARDENS.push(...filteredTokenIndexers);\r\n      \r\n      // Save cleared indexers state to persistence (empty array since all dynamic indexers are cleared)\r\n      // CRITICAL: In ROOT mode, skip this - indexers are saved via immediate save in /api/wizard/create-indexer\r\n      if (!DEPLOYED_AS_ROOT) {\r\n        redis.saveIndexers([]);\r\n      } else {\r\n        console.log(`\uD83D\uDCCB [Reset] ROOT mode: Skipping saveIndexers() - indexers are managed via persistence file`);\r\n      }\r\n      \r\n      // Helper function to get default indexerId for a provider (non-ROOT mode only)\r\n      function getDefaultGardenIdForProvider(providerId: string): string | undefined {\r\n        const defaults: Record<string, string> = {\r\n          'amc-001': 'garden-1',\r\n          'cinemark-001': 'garden-1',\r\n          'moviecom-001': 'garden-2',\r\n          'snake-premium-cinema-001': 'garden-1',\r\n          'snake-shopping-deals-001': 'garden-2'\r\n        };\r\n        return defaults[providerId];\r\n      }\r\n      \r\n      // Reset provider indexerId assignments in ROOT_CA_SERVICE_REGISTRY\r\n      // In ROOT mode: set to undefined (no indexer assigned)\r\n      // In non-ROOT mode: restore to default assignments (indexer-1, indexer-2, etc.)\r\n      let providersReset = 0;\r\n      for (const provider of ROOT_CA_SERVICE_REGISTRY) {\r\n        // Skip Holy Ghost infrastructure providers (they always belong to HG)\r\n        if (provider.gardenId === \"HG\") {\r\n          continue;\r\n        }\r\n        \r\n        // Reset gardenId based on deployment mode\r\n        if (DEPLOYED_AS_ROOT) {\r\n          // ROOT mode: In ROOT mode, gardens are created via Angular wizard\r\n          // We should NOT clear gardenId assignments here - they're managed by the wizard\r\n          // Skip resetting providers in ROOT mode\r\n          continue;\r\n        } else {\r\n          // Non-ROOT mode: restore default assignments\r\n          const defaultGardenId = getDefaultGardenIdForProvider(provider.id);\r\n          if (provider.gardenId !== defaultGardenId) {\r\n            provider.gardenId = defaultGardenId || \"HG\"; // Fallback to HG if undefined\r\n            providersReset++;\r\n          }\r\n        }\r\n      }\r\n      \r\n      // REFACTOR: Update separate files - keep wallet balances and ledger entries, clear gardens and serviceRegistry\r\n      const persistenceFile = path.join(__dirname, 'eden-wallet-persistence.json');\r\n      const gardensFile = path.join(__dirname, 'eden-gardens-persistence.json');\r\n      const serviceRegistryFile = path.join(__dirname, 'eden-serviceRegistry-persistence.json');\r\n      \r\n      // Preserve wallet balances from main file\r\n      let walletBalances: Record<string, string> = {};\r\n      if (fs.existsSync(persistenceFile)) {\r\n        try {\r\n          const fileContent = fs.readFileSync(persistenceFile, 'utf-8');\r\n          const currentPersistence = JSON.parse(fileContent);\r\n          walletBalances = currentPersistence.walletBalances || {};\r\n        } catch (err: any) {\r\n          console.warn(`   \u26A0\uFE0F  Could not load existing wallet persistence file:`, err.message);\r\n        }\r\n      }\r\n      \r\n      // Update main persistence file - keep wallet balances only\r\n      const updatedPersistence = {\r\n        walletBalances: walletBalances,\r\n        lastSaved: new Date().toISOString(),\r\n        resetAt: new Date().toISOString()\r\n      };\r\n      fs.writeFileSync(persistenceFile, JSON.stringify(updatedPersistence, null, 2), 'utf-8');\r\n      console.log(`   \uD83D\uDCBE [Reset] Updated wallet persistence file (preserved ${Object.keys(walletBalances).length} wallet balances)`);\r\n      \r\n      // Clear gardens file\r\n      const emptyGardensData = {\r\n        gardens: [],\r\n        lastSaved: new Date().toISOString(),\r\n        resetAt: new Date().toISOString()\r\n      };\r\n      fs.writeFileSync(gardensFile, JSON.stringify(emptyGardensData, null, 2), 'utf-8');\r\n      console.log(`   \uD83D\uDCBE [Reset] Cleared gardens file`);\r\n      \r\n      // Clear service registry file\r\n      const emptyServiceRegistryData = {\r\n        serviceRegistry: [],\r\n        lastSaved: new Date().toISOString(),\r\n        resetAt: new Date().toISOString()\r\n      };\r\n      fs.writeFileSync(serviceRegistryFile, JSON.stringify(emptyServiceRegistryData, null, 2), 'utf-8');\r\n      console.log(`   \uD83D\uDCBE [Reset] Cleared service registry file`);\r\n      \r\n      // Note: Ledger entries file is preserved (not cleared on wallet reset)\r\n      \r\n      // NOTE: We do NOT call redis.saveServiceRegistry() here because:\r\n      // 1. We've already written the ServiceRegistry (empty array) to the file above\r\n      // 2. Calling saveServiceRegistry() would cause a duplicate write\r\n      // 3. In ROOT mode, saveServiceRegistry() is a no-op anyway\r\n      \r\n      console.log(`   \u2705 Cleared ${clearedIndexersCount} generated indexers and reset ${providersReset} provider assignments. Wallet balances and ledger entries preserved.`);\r\n      \r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        message: `Reset successful. Cleared ${clearedIndexersCount} generated indexers and reset ${providersReset} provider assignments. Wallet balances and ledger entries preserved.`,\r\n        clearedIndexers: clearedIndexersCount,\r\n        resetProviders: providersReset,\r\n        remainingIndexers: GARDENS.length + TOKEN_GARDENS.length,\r\n        persistenceFile: persistenceFile\r\n      }));\r\n    } catch (err: any) {\r\n      console.error(`   \u274C Error resetting:`, err);\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: err.message }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // POST /api/wallet/persistence/system-prompt - Save system prompt to persistence file\r\n  if (pathname === \"/api/wallet/persistence/system-prompt\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDCBE [${requestId}] POST /api/wallet/persistence/system-prompt - Saving system prompt`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const systemPromptData = JSON.parse(body);\r\n        const persistenceFile = path.join(__dirname, 'eden-wallet-persistence.json');\r\n        \r\n        // Load existing persistence\r\n        let currentPersistence: any = {\r\n          walletBalances: {},\r\n          ledgerEntries: [],\r\n          gardens: [],\r\n          systemPrompts: []\r\n        };\r\n        \r\n        if (fs.existsSync(persistenceFile)) {\r\n          try {\r\n            const fileContent = fs.readFileSync(persistenceFile, 'utf-8');\r\n            currentPersistence = JSON.parse(fileContent);\r\n          } catch (err: any) {\r\n            console.warn(`   \u26A0\uFE0F  Could not load existing persistence file:`, err.message);\r\n          }\r\n        }\r\n        \r\n        // Initialize systemPrompts array if it doesn't exist\r\n        if (!currentPersistence.systemPrompts) {\r\n          currentPersistence.systemPrompts = [];\r\n        }\r\n        \r\n        // Check if system prompt for this service type already exists\r\n        const existingIndex = currentPersistence.systemPrompts.findIndex(\r\n          (sp: any) => sp.serviceType === systemPromptData.serviceType\r\n        );\r\n        \r\n        if (existingIndex >= 0) {\r\n          // Update existing system prompt\r\n          currentPersistence.systemPrompts[existingIndex] = systemPromptData;\r\n        } else {\r\n          // Add new system prompt\r\n          currentPersistence.systemPrompts.push(systemPromptData);\r\n        }\r\n        \r\n        // Update lastSaved timestamp\r\n        currentPersistence.lastSaved = new Date().toISOString();\r\n        \r\n        // Save to file\r\n        fs.writeFileSync(persistenceFile, JSON.stringify(currentPersistence, null, 2), 'utf-8');\r\n        \r\n        console.log(`   \u2705 System prompt saved for service type: ${systemPromptData.serviceType}`);\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          message: `System prompt saved for service type: ${systemPromptData.serviceType}`\r\n        }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C Failed to save system prompt:`, err);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // GET /api/jsc/transactions/:email - Get user transaction history\r\n  if (pathname.startsWith(\"/api/jsc/transactions/\") && req.method === \"GET\") {\r\n    const email = decodeURIComponent(pathname.split(\"/api/jsc/transactions/\")[1]);\r\n    console.log(`   \uD83D\uDCDC [${requestId}] GET /api/jsc/transactions/${email} - Getting transaction history`);\r\n    \r\n    const userTransactions = LEDGER.filter(entry => entry.payer === email);\r\n    \r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({\r\n      success: true,\r\n      email,\r\n      transactions: userTransactions,\r\n      count: userTransactions.length,\r\n    }));\r\n    return;\r\n  }\r\n\r\n  // GET /api/stripe/ledger/query - Query ledger by Stripe IDs (for webhook verification)\r\n  if (pathname === \"/api/stripe/ledger/query\" && req.method === \"GET\") {\r\n    const query = parsedUrl.query;\r\n    const paymentIntentId = query.payment_intent_id as string;\r\n    const customerId = query.customer_id as string;\r\n    const sessionId = query.session_id as string;\r\n    \r\n    console.log(`   \uD83D\uDD0D [${requestId}] GET /api/stripe/ledger/query - Querying ledger by Stripe IDs`);\r\n    \r\n    let matchingEntries = LEDGER.filter(entry => {\r\n      if (entry.serviceType !== 'mint') return false;\r\n      \r\n      const details = entry.bookingDetails as any;\r\n      if (!details) return false;\r\n      \r\n      let matches = true;\r\n      if (paymentIntentId && details.stripePaymentIntentId !== paymentIntentId) {\r\n        matches = false;\r\n      }\r\n      if (customerId && details.stripeCustomerId !== customerId) {\r\n        matches = false;\r\n      }\r\n      if (sessionId && details.stripeSessionId !== sessionId) {\r\n        matches = false;\r\n      }\r\n      \r\n      return matches;\r\n    });\r\n    \r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({\r\n      success: true,\r\n      query: { paymentIntentId, customerId, sessionId },\r\n      entries: matchingEntries,\r\n      count: matchingEntries.length,\r\n    }));\r\n    return;\r\n  }\r\n\r\n  // ============================================\r\n  // INDEXER RPC ENDPOINTS (Canonical Source)\r\n  // ============================================\r\n\r\n  // RPC: Get transactions by payer (Google email)\r\n  if (pathname === \"/rpc/getTransactionByPayer\" && req.method === \"GET\") {\r\n    console.log(`   \u2705 [${requestId}] GET /rpc/getTransactionByPayer`);\r\n    const queryParams = new URL(req.url || \"\", `http://${req.headers.host}`).searchParams;\r\n    const payer = queryParams.get(\"payer\");\r\n    \r\n    if (!payer) {\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ error: \"payer parameter required\" }));\r\n      return;\r\n    }\r\n    \r\n    const transactions = getTransactionByPayer(payer);\r\n    \r\n    console.log(`   \uD83D\uDCE1 [Service Provider] RPC Query: getTransactionByPayer(payer=${payer}) \u2192 Found ${transactions.length} transaction(s)`);\r\n    \r\n    // Broadcast RPC query event\r\n    broadcastEvent({\r\n      type: \"provider_rpc_query\",\r\n      component: \"service_provider\",\r\n      message: `Service Provider RPC Query: getTransactionByPayer`,\r\n      timestamp: Date.now(),\r\n      data: {\r\n        method: \"getTransactionByPayer\",\r\n        payer,\r\n        transactionCount: transactions.length,\r\n        requestId\r\n      }\r\n    });\r\n    \r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({\r\n      success: true,\r\n      payer,\r\n      transactions,\r\n      count: transactions.length,\r\n      timestamp: Date.now()\r\n    }));\r\n    return;\r\n  }\r\n\r\n  // RPC: Get transaction by snapshot ID\r\n  if (pathname === \"/rpc/getTransactionBySnapshot\" && req.method === \"GET\") {\r\n    console.log(`   \u2705 [${requestId}] GET /rpc/getTransactionBySnapshot`);\r\n    const queryParams = new URL(req.url || \"\", `http://${req.headers.host}`).searchParams;\r\n    const snapshotId = queryParams.get(\"snapshot_id\");\r\n    \r\n    if (!snapshotId) {\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ error: \"snapshot_id parameter required\" }));\r\n      return;\r\n    }\r\n    \r\n    const transaction = getTransactionBySnapshot(snapshotId);\r\n    if (!transaction) {\r\n      res.writeHead(404, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ error: \"Transaction not found\" }));\r\n      return;\r\n    }\r\n    \r\n    console.log(`   \uD83D\uDCE1 [Service Provider] RPC Query: getTransactionBySnapshot(snapshotId=${snapshotId.substring(0, 8)}...) \u2192 Found`);\r\n    \r\n    // Broadcast RPC query event\r\n    broadcastEvent({\r\n      type: \"provider_rpc_query\",\r\n      component: \"service_provider\",\r\n      message: `Service Provider RPC Query: getTransactionBySnapshot`,\r\n      timestamp: Date.now(),\r\n      data: {\r\n        method: \"getTransactionBySnapshot\",\r\n        snapshotId,\r\n        found: true,\r\n        requestId\r\n      }\r\n    });\r\n    \r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({\r\n      success: true,\r\n      transaction,\r\n      timestamp: Date.now()\r\n    }));\r\n    return;\r\n  }\r\n\r\n  // RPC: Get latest snapshot for provider\r\n  if (pathname === \"/rpc/getLatestSnapshot\" && req.method === \"GET\") {\r\n    console.log(`   \u2705 [${requestId}] GET /rpc/getLatestSnapshot`);\r\n    const queryParams = new URL(req.url || \"\", `http://${req.headers.host}`).searchParams;\r\n    const providerId = queryParams.get(\"provider_id\");\r\n    \r\n    if (!providerId) {\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ error: \"provider_id parameter required\" }));\r\n      return;\r\n    }\r\n    \r\n    const snapshot = getLatestSnapshot(providerId);\r\n    if (!snapshot) {\r\n      res.writeHead(404, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ error: \"No transactions found for provider\" }));\r\n      return;\r\n    }\r\n    \r\n    console.log(`   \uD83D\uDCE1 [Service Provider] RPC Query: getLatestSnapshot(providerId=${providerId}) \u2192 Found TX: ${snapshot.txId.substring(0, 8)}...`);\r\n    \r\n    // Broadcast RPC query event\r\n    broadcastEvent({\r\n      type: \"provider_rpc_query\",\r\n      component: \"service_provider\",\r\n      message: `Service Provider RPC Query: getLatestSnapshot`,\r\n      timestamp: Date.now(),\r\n      data: {\r\n        method: \"getLatestSnapshot\",\r\n        providerId,\r\n        found: true,\r\n        txId: snapshot.txId,\r\n        requestId\r\n      }\r\n    });\r\n    \r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({\r\n      success: true,\r\n      snapshot,\r\n      timestamp: Date.now()\r\n    }));\r\n    return;\r\n  }\r\n\r\n  // RPC: Poll transaction status\r\n  if (pathname === \"/rpc/tx/status\" && req.method === \"GET\") {\r\n    console.log(`   \u2705 [${requestId}] GET /rpc/tx/status`);\r\n    const queryParams = new URL(req.url || \"\", `http://${req.headers.host}`).searchParams;\r\n    const payer = queryParams.get(\"payer\");\r\n    const snapshotId = queryParams.get(\"snapshot_id\");\r\n    \r\n    if (!payer && !snapshotId) {\r\n      res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ error: \"payer or snapshot_id parameter required\" }));\r\n      return;\r\n    }\r\n    \r\n    let transaction: LedgerEntry | null = null;\r\n    if (snapshotId) {\r\n      transaction = getTransactionBySnapshot(snapshotId);\r\n    } else if (payer) {\r\n      const transactions = getTransactionByPayer(payer);\r\n      transaction = transactions.length > 0 ? transactions[transactions.length - 1] : null;\r\n    }\r\n    \r\n    if (!transaction) {\r\n      res.writeHead(404, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ \r\n        success: false,\r\n        status: \"not_found\",\r\n        message: \"Transaction not found\"\r\n      }));\r\n      return;\r\n    }\r\n    \r\n    console.log(`   \uD83D\uDD04 [Service Provider] RPC Poll: tx/status(${payer ? `payer=${payer}` : `snapshotId=${snapshotId?.substring(0, 8)}...`}) \u2192 Status: ${transaction.status}`);\r\n    \r\n    // Broadcast RPC poll event\r\n    broadcastEvent({\r\n      type: \"provider_rpc_poll\",\r\n      component: \"service_provider\",\r\n      message: `Service Provider Polling: tx/status`,\r\n      timestamp: Date.now(),\r\n      data: {\r\n        method: \"tx/status\",\r\n        payer: payer || null,\r\n        snapshotId: snapshotId || null,\r\n        status: transaction.status,\r\n        txId: transaction.txId,\r\n        requestId\r\n      }\r\n    });\r\n    \r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({\r\n      success: true,\r\n      status: transaction.status,\r\n      transaction: {\r\n        txId: transaction.txId,\r\n        entryId: transaction.entryId,\r\n        payer: transaction.payer,\r\n        merchant: transaction.merchant,\r\n        amount: transaction.amount,\r\n        status: transaction.status,\r\n        timestamp: transaction.timestamp,\r\n      },\r\n      timestamp: Date.now()\r\n    }));\r\n    return;\r\n  }\r\n\r\n  // ============================================\r\n  // WEBHOOK REGISTRATION (Optional Push)\r\n  // ============================================\r\n\r\n  // Register webhook for provider\r\n  if (pathname === \"/rpc/webhook/register\" && req.method === \"POST\") {\r\n    console.log(`   \u2705 [${requestId}] POST /rpc/webhook/register`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const { providerId, webhookUrl } = JSON.parse(body);\r\n        if (!providerId || !webhookUrl) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ error: \"providerId and webhookUrl required\" }));\r\n          return;\r\n        }\r\n        \r\n        // Validate URL\r\n        try {\r\n          new URL(webhookUrl);\r\n        } catch {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ error: \"Invalid webhook URL\" }));\r\n          return;\r\n        }\r\n        \r\n        PROVIDER_WEBHOOKS.set(providerId, {\r\n          providerId,\r\n          webhookUrl,\r\n          registeredAt: Date.now(),\r\n          failureCount: 0,\r\n        });\r\n        \r\n        console.log(`\uD83D\uDCE1 [Service Provider] Webhook Registered: ${providerId} \u2192 ${webhookUrl}`);\r\n        \r\n        // Broadcast webhook registration event\r\n        broadcastEvent({\r\n          type: \"provider_webhook_registered\",\r\n          component: \"service_provider\",\r\n          message: `Webhook Registered: ${providerId}`,\r\n          timestamp: Date.now(),\r\n          data: {\r\n            providerId,\r\n            webhookUrl,\r\n            requestId\r\n          }\r\n        });\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          message: \"Webhook registered\",\r\n          providerId,\r\n          webhookUrl,\r\n          timestamp: Date.now()\r\n        }));\r\n      } catch (err: any) {\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // Unregister webhook\r\n  if (pathname === \"/rpc/webhook/unregister\" && req.method === \"POST\") {\r\n    console.log(`   \u2705 [${requestId}] POST /rpc/webhook/unregister`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const { providerId } = JSON.parse(body);\r\n        if (!providerId) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ error: \"providerId required\" }));\r\n          return;\r\n        }\r\n        \r\n        const removed = PROVIDER_WEBHOOKS.delete(providerId);\r\n        \r\n        // Broadcast webhook unregistration event\r\n        if (removed) {\r\n          console.log(`\uD83D\uDD0C [Service Provider] Webhook Unregistered: ${providerId}`);\r\n          broadcastEvent({\r\n            type: \"provider_webhook_unregistered\",\r\n            component: \"service_provider\",\r\n            message: `Webhook Unregistered: ${providerId}`,\r\n            timestamp: Date.now(),\r\n            data: {\r\n              providerId,\r\n              requestId\r\n            }\r\n          });\r\n        }\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          message: removed ? \"Webhook unregistered\" : \"Webhook not found\",\r\n          providerId,\r\n          timestamp: Date.now()\r\n        }));\r\n      } catch (err: any) {\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // List webhooks (for debugging)\r\n  if (pathname === \"/rpc/webhook/list\" && req.method === \"GET\") {\r\n    console.log(`   \u2705 [${requestId}] GET /rpc/webhook/list`);\r\n    const webhooks = Array.from(PROVIDER_WEBHOOKS.values());\r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({\r\n      success: true,\r\n      webhooks,\r\n      count: webhooks.length,\r\n      timestamp: Date.now()\r\n    }));\r\n    return;\r\n  }\r\n\r\n  // ============================================\r\n  // MOCK WEBHOOK ENDPOINT (for testing)\r\n  // ============================================\r\n  // This endpoint simulates service provider webhook receivers\r\n  if (pathname.startsWith(\"/mock/webhook/\") && req.method === \"POST\") {\r\n    const providerId = pathname.split(\"/mock/webhook/\")[1];\r\n    console.log(`   \uD83D\uDCE5 [Mock Webhook] Received webhook for provider: ${providerId}`);\r\n    \r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    req.on(\"end\", () => {\r\n      try {\r\n        const payload = JSON.parse(body);\r\n        console.log(`   \u2705 [Mock Webhook] Successfully received webhook for ${providerId}:`, {\r\n          event: payload.event,\r\n          txId: payload.snapshot?.txId,\r\n          payer: payload.snapshot?.payer,\r\n          amount: payload.snapshot?.amount\r\n        });\r\n        \r\n        // Broadcast mock webhook receipt\r\n        broadcastEvent({\r\n          type: \"provider_webhook_received\",\r\n          component: \"service_provider\",\r\n          message: `Mock Webhook Received: ${providerId}`,\r\n          timestamp: Date.now(),\r\n          data: {\r\n            providerId,\r\n            event: payload.event,\r\n            txId: payload.snapshot?.txId,\r\n            payer: payload.snapshot?.payer,\r\n            amount: payload.snapshot?.amount\r\n          }\r\n        });\r\n        \r\n        // Return success response\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          message: \"Webhook received\",\r\n          providerId,\r\n          receivedAt: Date.now()\r\n        }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C [Mock Webhook] Error parsing webhook payload for ${providerId}:`, err.message);\r\n        res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ error: \"Invalid JSON payload\" }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n  \r\n  // GET /api/ledger - Get ledger entries with pagination\r\n  if (pathname === \"/api/ledger\" && req.method === \"GET\") {\r\n    console.log(`\uD83D\uDCE1 [API] \u2B50 GET /api/ledger endpoint called`);\r\n    const parsedUrl = url.parse(req.url || \"/\", true);\r\n    const payerEmail = parsedUrl.query.email as string | undefined;\r\n    \r\n    // Pagination parameters\r\n    const pageParam = parsedUrl.query.page as string | undefined;\r\n    const limitParam = parsedUrl.query.limit as string | undefined;\r\n    const page = pageParam ? parseInt(pageParam, 10) : 1;\r\n    const limit = limitParam ? parseInt(limitParam, 10) : 20;\r\n    \r\n    console.log(`\uD83D\uDCE1 [API] Query params:`, parsedUrl.query);\r\n    console.log(`\uD83D\uDCE1 [API] Pagination: page=${page}, limit=${limit}`);\r\n    console.log(`\uD83D\uDCE1 [API] Checking LEDGER array before getLedgerEntries call: ${LEDGER.length} entries`);\r\n    console.log(`\uD83D\uDCE1 [API] LEDGER array reference check:`, typeof LEDGER);\r\n\r\n    LEDGER.forEach((entry, index) => {\r\n      if (index < 5) { // Log first 5 entries\r\n        console.log(`\uD83D\uDCE1 [API] Entry ${index}:`, {\r\n          entryId: entry.entryId,\r\n          txId: entry.txId,\r\n          payer: entry.payer,\r\n          merchant: entry.merchant,\r\n          amount: entry.amount,\r\n          serviceType: entry.serviceType,\r\n          status: entry.status,\r\n          movieTitle: entry.bookingDetails?.movieTitle,\r\n          timestamp: entry.timestamp ? new Date(entry.timestamp).toISOString() : 'no timestamp'\r\n        });\r\n      }\r\n    });\r\n\r\n    // Get all entries (filtered by payerEmail if provided)\r\n    let allEntries = getLedgerEntries(payerEmail);\r\n    console.log(`\uD83D\uDCE1 [API] getLedgerEntries returned ${allEntries.length} entries${payerEmail ? ` for ${payerEmail}` : ' (all entries)'}`);\r\n    \r\n    // Sort by timestamp in descending order (newest first)\r\n    allEntries.sort((a, b) => {\r\n      const timestampA = a.timestamp || 0;\r\n      const timestampB = b.timestamp || 0;\r\n      return timestampB - timestampA; // Descending order (newest first)\r\n    });\r\n    \r\n    // Calculate pagination\r\n    const total = allEntries.length;\r\n    const totalPages = Math.ceil(total / limit);\r\n    const validPage = Math.max(1, Math.min(page, totalPages)); // Ensure page is within valid range\r\n    const startIndex = (validPage - 1) * limit;\r\n    const endIndex = startIndex + limit;\r\n    const paginatedEntries = allEntries.slice(startIndex, endIndex);\r\n    \r\n    console.log(`\uD83D\uDCE1 [API] Pagination: total=${total}, totalPages=${totalPages}, page=${validPage}, showing ${paginatedEntries.length} entries (${startIndex + 1}-${Math.min(endIndex, total)})`);\r\n    console.log(`\uD83D\uDCE1 [API] LEDGER array has ${LEDGER.length} entries in memory`);\r\n    if (LEDGER.length > 0) {\r\n      console.log(`\uD83D\uDCE1 [API] First entry:`, JSON.stringify(LEDGER[0], null, 2));\r\n    }\r\n    \r\n    const response = {\r\n      success: true,\r\n      entries: paginatedEntries,\r\n      pagination: {\r\n        page: validPage,\r\n        limit: limit,\r\n        total: total,\r\n        totalPages: totalPages,\r\n        hasNextPage: validPage < totalPages,\r\n        hasPreviousPage: validPage > 1\r\n      }\r\n    };\r\n    console.log(`\uD83D\uDCE1 [API] Sending response with pagination:`, {\r\n      entriesCount: paginatedEntries.length,\r\n      page: validPage,\r\n      totalPages: totalPages,\r\n      total: total\r\n    });\r\n    console.log(`\uD83D\uDCE4 [${requestId}] Response: 200 OK (${paginatedEntries.length} ledger entries, page ${validPage}/${totalPages})`);\r\n    res.writeHead(200, {\r\n      \"Content-Type\": \"application/json\",\r\n      \"Access-Control-Allow-Origin\": \"*\" // Ensure CORS is allowed\r\n    });\r\n    res.end(JSON.stringify(response));\r\n    return;\r\n  }\r\n\r\n  // GET /api/cashier - Get cashier status (also handle typo /api/cachier)\r\n  if ((pathname === \"/api/cashier\" || pathname === \"/api/cachier\") && req.method === \"GET\") {\r\n    console.log(`   \uD83D\uDCB0 [${requestId}] GET ${pathname} - Getting cashier status`);\r\n    try {\r\n      const cashierStatus = getCashierStatus();\r\n      console.log(`   \u2705 [${requestId}] Cashier status retrieved:`, cashierStatus.name);\r\n      res.writeHead(200, { \r\n        \"Content-Type\": \"application/json\",\r\n        \"Access-Control-Allow-Origin\": \"*\"\r\n      });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        cashier: cashierStatus\r\n      }));\r\n    } catch (error: any) {\r\n      console.error(`   \u274C [${requestId}] Error getting cashier status:`, error.message);\r\n      res.writeHead(500, { \r\n        \"Content-Type\": \"application/json\",\r\n        \"Access-Control-Allow-Origin\": \"*\"\r\n      });\r\n      res.end(JSON.stringify({\r\n        success: false,\r\n        error: error.message\r\n      }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // ============================================\r\n  // RAG KNOWLEDGE GENERATION (LLM-based)\r\n  // ============================================\r\n  if (pathname === \"/api/rag/generate\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDCDA [${requestId}] POST /api/rag/generate - Generating RAG knowledge from white paper`);\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const { generateAndSaveRAGKnowledge } = await import(\"./src/rag/ragGenerator\");\r\n        await generateAndSaveRAGKnowledge();\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ \r\n          success: true, \r\n          message: \"RAG knowledge base generated successfully from white paper\" \r\n        }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C [${requestId}] Failed to generate RAG knowledge:`, err);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ \r\n          success: false, \r\n          error: err.message || 'Failed to generate RAG knowledge base'\r\n        }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // ============================================\r\n  // SYSTEM PROMPT GENERATION SERVICE (Holy Ghost)\r\n  // ============================================\r\n  if (pathname === \"/api/system-prompt/generate\" && req.method === \"POST\") {\r\n    console.log(`   \uD83E\uDD16 [${requestId}] POST /api/system-prompt/generate - Generating system prompt`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const { description, serviceType } = JSON.parse(body);\r\n        if (!description || !serviceType) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"description and serviceType required\" }));\r\n          return;\r\n        }\r\n        \r\n        // Generate prompts using LLM\r\n        const prompts = await generateSystemPrompts(description, serviceType);\r\n        \r\n        // Store in Redis\r\n        const redisKey = `eden:system-prompts:${serviceType}`;\r\n        redis.set(redisKey, JSON.stringify(prompts));\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, prompts, redisKey }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C Failed to generate system prompt:`, err);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ \r\n          success: false, \r\n          error: err.message || 'Failed to generate system prompt'\r\n        }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  if (pathname.startsWith(\"/api/system-prompt/\") && req.method === \"GET\") {\r\n    const serviceType = pathname.split(\"/\").pop();\r\n    console.log(`   \uD83D\uDCCB [${requestId}] GET /api/system-prompt/${serviceType} - Retrieving system prompt`);\r\n    \r\n    try {\r\n      const redisKey = `eden:system-prompts:${serviceType}`;\r\n      const promptsJson = redis.get(redisKey);\r\n      \r\n      if (promptsJson) {\r\n        const prompts = JSON.parse(promptsJson);\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, prompts }));\r\n      } else {\r\n        res.writeHead(404, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: \"System prompt not found\" }));\r\n      }\r\n    } catch (err: any) {\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: err.message }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // ============================================\r\n  // NOTIFICATION CODE GENERATION SERVICE (Holy Ghost)\r\n  // ============================================\r\n  if (pathname === \"/api/notification-code/generate\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDD14 [${requestId}] POST /api/notification-code/generate - Generating notification code`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const { providerId, providerName, language, framework, indexerEndpoint, webhookUrl, serviceType, notificationMethods } = JSON.parse(body);\r\n        if (!providerId || !language || !framework) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"providerId, language, and framework required\" }));\r\n          return;\r\n        }\r\n        \r\n        // Generate code using LLM\r\n        const code = await generateNotificationCode({\r\n          providerId,\r\n          providerName: providerName || providerId,\r\n          language,\r\n          framework,\r\n          indexerEndpoint: indexerEndpoint || `http://localhost:${HTTP_PORT}`,\r\n          webhookUrl: webhookUrl || `http://localhost:${HTTP_PORT}/api/provider-plugin/webhook/${providerId}`,\r\n          serviceType: serviceType || \"movie\",\r\n          notificationMethods: notificationMethods || [\"webhook\", \"pull\", \"rpc\"]\r\n        });\r\n        \r\n        // Store in Redis\r\n        const redisKey = `eden:notification-code:${providerId}`;\r\n        redis.set(redisKey, JSON.stringify(code));\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, code, redisKey }));\r\n      } catch (err: any) {\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  if (pathname.startsWith(\"/api/notification-code/\") && req.method === \"GET\") {\r\n    const providerId = pathname.split(\"/\").pop();\r\n    console.log(`   \uD83D\uDCCB [${requestId}] GET /api/notification-code/${providerId} - Retrieving notification code`);\r\n    \r\n    try {\r\n      const redisKey = `eden:notification-code:${providerId}`;\r\n      const codeJson = redis.get(redisKey);\r\n      \r\n      if (codeJson) {\r\n        const code = JSON.parse(codeJson);\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, code }));\r\n      } else {\r\n        res.writeHead(404, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: \"Notification code not found\" }));\r\n      }\r\n    } catch (err: any) {\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: err.message }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // ============================================\r\n  // PROVIDER PLUGIN: MYSQL/MARIADB (Wizard + Deployable Providers)\r\n  // ============================================\r\n  if (pathname === \"/api/provider-plugin/mysql/test-query\" && req.method === \"POST\") {\r\n    console.log(`   \uD83E\uDDE9 [${requestId}] POST /api/provider-plugin/mysql/test-query`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const parsed = JSON.parse(body || \"{}\");\r\n        const connection = parsed.connection;\r\n        const sql = parsed.sql;\r\n        const params = Array.isArray(parsed.params) ? parsed.params : [];\r\n        const maxRows = parsed.maxRows;\r\n\r\n        // Debug: log received connection data (without password)\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Received connection:`, {\r\n          host: connection?.host,\r\n          port: connection?.port,\r\n          user: connection?.user,\r\n          database: connection?.database,\r\n          hasPassword: !!connection?.password\r\n        });\r\n\r\n        if (!connection?.host || !connection?.user || !connection?.password || !connection?.database) {\r\n          const missing = [];\r\n          if (!connection?.host) missing.push('host');\r\n          if (!connection?.user) missing.push('user');\r\n          if (!connection?.password) missing.push('password');\r\n          if (!connection?.database) missing.push('database');\r\n          console.log(`   \u274C [${requestId}] Missing fields: ${missing.join(', ')}`);\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: `connection.${missing.join('/')} required` }));\r\n          return;\r\n        }\r\n        if (!sql || typeof sql !== \"string\") {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"sql required\" }));\r\n          return;\r\n        }\r\n\r\n        // Log SQL query for debugging\r\n        console.log(`   \uD83D\uDCDD [${requestId}] SQL Query:`, sql);\r\n        console.log(`   \uD83D\uDCDD [${requestId}] SQL Params:`, params);\r\n        console.log(`   \uD83D\uDCDD [${requestId}] Max Rows:`, maxRows);\r\n\r\n        const result = await testMySQLQuery({\r\n          connection: {\r\n            host: String(connection.host),\r\n            port: connection.port ? Number(connection.port) : 3306,\r\n            user: String(connection.user),\r\n            password: String(connection.password),\r\n            database: String(connection.database),\r\n          },\r\n          sql,\r\n          params,\r\n          maxRows,\r\n        });\r\n\r\n        // Console out SQL query results\r\n        console.log(`   \uD83D\uDCCA [${requestId}] SQL Query Results:`);\r\n        console.log(`   \uD83D\uDCCA [${requestId}] - Row Count: ${result.rowCount}`);\r\n        console.log(`   \uD83D\uDCCA [${requestId}] - Columns: ${result.columns.join(', ')}`);\r\n        console.log(`   \uD83D\uDCCA [${requestId}] - Elapsed: ${result.elapsedMs}ms`);\r\n        if (result.rows.length > 0) {\r\n          console.log(`   \uD83D\uDCCA [${requestId}] - First Row:`, JSON.stringify(result.rows[0], bigIntReplacer, 2));\r\n          if (result.rows.length > 1) {\r\n            console.log(`   \uD83D\uDCCA [${requestId}] - All Rows (${result.rows.length}):`, JSON.stringify(result.rows, bigIntReplacer, 2));\r\n          }\r\n        } else {\r\n          console.log(`   \uD83D\uDCCA [${requestId}] - No rows returned`);\r\n        }\r\n\r\n        // Apply grouping for autoparts with images (same logic as test-getdata)\r\n        let groupedResults = result.rows;\r\n        const rows = result.rows || [];\r\n        const serviceType = parsed.serviceType || \"autoparts\";\r\n        \r\n        // Check if this is an autoparts query with images\r\n        const hasImageColumns = rows.length > 0 && (\r\n          'autopart_id' in rows[0] || \r\n          'image_id' in rows[0] || \r\n          'image_url' in rows[0] ||\r\n          'i.id' in rows[0] ||\r\n          Object.keys(rows[0]).some(k => k.startsWith('image_') || k.startsWith('i.') || k.toLowerCase().includes('image'))\r\n        );\r\n        const hasAutopartId = rows.length > 0 && (\r\n          'id' in rows[0] || \r\n          'a.id' in rows[0] ||\r\n          'autopart_id' in rows[0]\r\n        );\r\n        const hasAutopartsColumns = rows.length > 0 && (\r\n          'make' in rows[0] || \r\n          'model' in rows[0] || \r\n          'year' in rows[0] ||\r\n          'title' in rows[0] ||\r\n          'part_name' in rows[0] ||\r\n          'sale_price' in rows[0] ||\r\n          'stock_number' in rows[0]\r\n        );\r\n\r\n        const effectiveServiceType = (serviceType || \"\").toLowerCase().trim();\r\n        const shouldGroup = (effectiveServiceType === \"autoparts\" || hasAutopartsColumns) && hasImageColumns && hasAutopartId;\r\n\r\n        if (shouldGroup) {\r\n          console.log(`   \uD83D\uDD04 [${requestId}] Grouping autoparts with images (${rows.length} rows)`);\r\n          \r\n          const autopartsMap = new Map<number | string, any>();\r\n          \r\n          for (const row of rows) {\r\n            const autopartId = row.id || row['a.id'] || row.autopart_id;\r\n            if (!autopartId) continue;\r\n\r\n            if (!autopartsMap.has(autopartId)) {\r\n              const autopart: any = { imageModals: [] as any[] };\r\n              \r\n              for (const [k, v] of Object.entries(row || {})) {\r\n                if (k.startsWith('image_') || k.startsWith('i.') || (k.toLowerCase().includes('image') && k !== 'imageModals') || k === 'autopart_id') {\r\n                  continue;\r\n                }\r\n                if (k.startsWith('a.')) {\r\n                  autopart[k.substring(2)] = v;\r\n                } else {\r\n                  autopart[k] = v;\r\n                }\r\n              }\r\n\r\n              if (autopart.price === undefined || autopart.price === null) {\r\n                const maybePrice = autopart.Price ?? autopart.price_usd ?? autopart.amount ?? autopart.cost ?? autopart.sale_price;\r\n                autopart.price = typeof maybePrice === \"string\" ? parseFloat(maybePrice) : (typeof maybePrice === \"number\" ? maybePrice : 0);\r\n              }\r\n\r\n              if (!autopart.partName && autopart.part_name) autopart.partName = autopart.part_name;\r\n              if (!autopart.partName && autopart.title) autopart.partName = autopart.title;\r\n\r\n              autopartsMap.set(autopartId, autopart);\r\n            }\r\n\r\n            const autopart = autopartsMap.get(autopartId)!;\r\n            const imageData: any = {};\r\n            let hasImageData = false;\r\n\r\n            for (const [k, v] of Object.entries(row || {})) {\r\n              if (k.startsWith('image_')) {\r\n                const cleanKey = k.substring(6);\r\n                if (v !== null && v !== undefined) {\r\n                  imageData[cleanKey] = v;\r\n                  hasImageData = true;\r\n                }\r\n              } else if (k === 'autopart_id' && v !== null && v !== undefined) {\r\n                imageData[k] = v;\r\n              } else if (k.startsWith('i.')) {\r\n                const cleanKey = k.substring(2);\r\n                if (v !== null && v !== undefined) {\r\n                  imageData[cleanKey] = v;\r\n                  hasImageData = true;\r\n                }\r\n              }\r\n            }\r\n\r\n            if (hasImageData && Object.keys(imageData).length > 0) {\r\n              const imageId = imageData.id || imageData.image_id;\r\n              if (imageId && !autopart.imageModals.find((img: any) => (img.id || img.image_id) === imageId)) {\r\n                autopart.imageModals.push(imageData);\r\n              } else if (!imageId) {\r\n                const imageUrl = imageData.url || imageData.image_url;\r\n                if (imageUrl && !autopart.imageModals.find((img: any) => (img.url || img.image_url) === imageUrl)) {\r\n                  autopart.imageModals.push(imageData);\r\n                } else if (!imageUrl) {\r\n                  autopart.imageModals.push(imageData);\r\n                }\r\n              }\r\n            }\r\n          }\r\n\r\n          // No hardcoded filtering - return all fields from grouped autoparts\r\n          groupedResults = Array.from(autopartsMap.values());\r\n          console.log(`   \u2705 [${requestId}] Grouped ${rows.length} rows into ${groupedResults.length} autopart(s) with images`);\r\n          console.log(`   \uD83D\uDCCB [${requestId}] Returning all fields (no hardcoded filtering)`);\r\n        }\r\n\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ \r\n          success: true, \r\n          result: {\r\n            ...result,\r\n            rows: groupedResults,\r\n            rowCount: groupedResults.length\r\n          }, \r\n          timestamp: Date.now() \r\n        }, bigIntReplacer));\r\n      } catch (err: any) {\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message || String(err) }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // PROVIDER PLUGIN: getData Wrapper Test (pre-flight validation)\r\n  // This endpoint tests the full getData flow: natural language -> LLM params -> SQL parameterization -> SQL execution\r\n  if (pathname === \"/api/provider-plugin/mysql/test-getdata\" && req.method === \"POST\") {\r\n    console.log(`\\n\\n`);\r\n    console.log(`   ============================================================`);\r\n    console.log(`   \uD83E\uDDEA [${requestId}] POST /api/provider-plugin/mysql/test-getdata`);\r\n    console.log(`   \uD83E\uDDEA [${requestId}] getData wrapper pre-flight test STARTING`);\r\n    console.log(`   ============================================================`);\r\n    console.log(`\\n`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const parsed = JSON.parse(body || \"{}\");\r\n        const connection = parsed.connection;\r\n        const sql = String(parsed.sql || \"\").trim();\r\n        const userQuery = String(parsed.userQuery || \"\").trim();\r\n        const serviceType = String(parsed.serviceType || \"autoparts\").trim();\r\n        const returnFields = parsed.returnFields ? String(parsed.returnFields).trim() : \"\";\r\n\r\n        if (!connection || !connection.host || !connection.user || !connection.password || !connection.database) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"connection.host/user/password/database required\" }));\r\n          return;\r\n        }\r\n        if (!sql) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"sql required\" }));\r\n          return;\r\n        }\r\n        if (!userQuery) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"userQuery required\" }));\r\n          return;\r\n        }\r\n\r\n        console.log(`   \uD83E\uDDEA [${requestId}] getData Wrapper Test:`);\r\n        console.log(`   \uD83D\uDCDD [${requestId}] - User Query: \"${userQuery}\"`);\r\n        console.log(`   \uD83D\uDCDD [${requestId}] - Service Type: ${serviceType}`);\r\n        console.log(`   \uD83D\uDCDD [${requestId}] - Original SQL:`, sql);\r\n\r\n        // Step 1: Extract getData params from natural language query\r\n        console.log(`   \uD83D\uDC51 [${requestId}] Step 1: Extracting getData() params from user query...`);\r\n        const getDataParams = await extractGetDataParamsWithOpenAI(userQuery);\r\n        console.log(`   \u2705 [${requestId}] Step 1 Complete:`, {\r\n          serviceType: getDataParams.serviceType,\r\n          params: getDataParams.params,\r\n          maxCount: getDataParams.maxCount,\r\n          sortBy: getDataParams.sortBy,\r\n          order: getDataParams.order\r\n        });\r\n\r\n        // Step 2: Parameterize SQL query\r\n        console.log(`   \uD83D\uDC51 [${requestId}] Step 2: Parameterizing SQL query...`);\r\n        const sqlParamResult = await parameterizeSQLWithOpenAI(sql);\r\n        console.log(`   \u2705 [${requestId}] Step 2 Complete:`, {\r\n          parameterizedSql: sqlParamResult.parameterizedSql,\r\n          paramOrder: sqlParamResult.paramOrder,\r\n          extractedParams: sqlParamResult.params\r\n        });\r\n\r\n        // Step 3: Map getData params to SQL params based on paramOrder\r\n        console.log(`   \uD83D\uDD04 [${requestId}] Step 3: Mapping getData params to SQL params...`);\r\n        const sqlParams: any[] = [];\r\n        const paramOrder = sqlParamResult.paramOrder || [];\r\n        const getDataParamsArray = getDataParams.params || [];\r\n        const parameterizedSql = sqlParamResult.parameterizedSql;\r\n\r\n        // Check for LIMIT ? and OFFSET ? placeholders in parameterized SQL\r\n        const hasLimitPlaceholder = /LIMIT\\s+\\?/i.test(parameterizedSql);\r\n        const hasOffsetPlaceholder = /OFFSET\\s+\\?/i.test(parameterizedSql);\r\n        \r\n        // Count placeholders before LIMIT/OFFSET\r\n        let placeholdersBeforeLimit = 0;\r\n        if (hasLimitPlaceholder) {\r\n          const beforeLimit = parameterizedSql.substring(0, parameterizedSql.toUpperCase().indexOf('LIMIT'));\r\n          placeholdersBeforeLimit = (beforeLimit.match(/\\?/g) || []).length;\r\n        }\r\n\r\n        // Simple mapping: use getData params in order if paramOrder matches\r\n        // For now, use the extracted SQL params if available, otherwise use getData params\r\n        if (sqlParamResult.params.length > 0) {\r\n          // Use the params extracted from SQL parameterization (excluding LIMIT/OFFSET if they were in original)\r\n          const paramsToUse = sqlParamResult.params.slice(0, placeholdersBeforeLimit);\r\n          sqlParams.push(...paramsToUse);\r\n        } else if (getDataParamsArray.length > 0) {\r\n          // Fallback: use getData params\r\n          sqlParams.push(...getDataParamsArray.slice(0, Math.min(paramOrder.length, placeholdersBeforeLimit)));\r\n        }\r\n\r\n        // Add LIMIT and OFFSET values if placeholders exist\r\n        if (hasLimitPlaceholder && hasOffsetPlaceholder) {\r\n          sqlParams.push(getDataParams.maxCount || 30); // LIMIT\r\n          sqlParams.push(0); // OFFSET\r\n        } else if (hasLimitPlaceholder) {\r\n          sqlParams.push(getDataParams.maxCount || 30); // LIMIT only\r\n        }\r\n\r\n        console.log(`   \u2705 [${requestId}] Step 3 Complete: SQL params:`, sqlParams);\r\n\r\n        // Step 4: Execute parameterized SQL query\r\n        console.log(`   \uD83D\uDDC4\uFE0F  [${requestId}] Step 4: Executing parameterized SQL query...`);\r\n        const maxRows = Math.min(getDataParams.maxCount || 30, 50);\r\n        const sqlResult = await testMySQLQuery({\r\n          connection: {\r\n            host: String(connection.host),\r\n            port: connection.port ? Number(connection.port) : 3306,\r\n            user: String(connection.user),\r\n            password: String(connection.password),\r\n            database: String(connection.database),\r\n          },\r\n          sql: sqlParamResult.parameterizedSql,\r\n          params: sqlParams,\r\n          maxRows,\r\n        });\r\n\r\n        console.log(`   \u2705 [${requestId}] Step 4 Complete: ${sqlResult.rowCount} row(s) returned`);\r\n        \r\n        // Step 5: Group autoparts with images (if applicable)\r\n        console.log(`   \uD83D\uDD0D [${requestId}] ========== STEP 5: GROUPING CHECK START ==========`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Raw SQL result: ${sqlResult.rowCount} rows`);\r\n        // Log all autopart IDs from raw rows to see if they're different\r\n        if (sqlResult.rows && sqlResult.rows.length > 0) {\r\n          const autopartIds = sqlResult.rows.map((r: any) => r.id || r['a.id'] || r.autopart_id).filter((id: any) => id !== undefined);\r\n          console.log(`   \uD83D\uDD0D [${requestId}] Autopart IDs in raw rows: ${autopartIds.join(', ')}`);\r\n          console.log(`   \uD83D\uDD0D [${requestId}] Unique autopart IDs: ${[...new Set(autopartIds)].join(', ')} (${[...new Set(autopartIds)].length} unique)`);\r\n        }\r\n        let groupedResults = sqlResult.rows;\r\n        const rows = sqlResult.rows || [];\r\n        \r\n        console.log(`   \uD83D\uDD0D [${requestId}] Raw input values:`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}]   - getDataParams.serviceType: \"${getDataParams.serviceType}\"`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}]   - parsed serviceType: \"${serviceType}\"`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}]   - rows.length: ${rows.length}`);\r\n        \r\n        // Use serviceType from getDataParams (more reliable) or fallback to parsed serviceType\r\n        const effectiveServiceType = (getDataParams.serviceType || serviceType || \"\").toLowerCase().trim();\r\n        console.log(`   \uD83D\uDD0D [${requestId}]   - effectiveServiceType (after lower/trim): \"${effectiveServiceType}\"`);\r\n        \r\n        // Check if this is an autoparts query with images\r\n        // Look for autoparts-specific columns: image_id, autopart_id, or columns from autoparts table\r\n        const hasImageColumns = rows.length > 0 && (\r\n          'autopart_id' in rows[0] || \r\n          'image_id' in rows[0] || \r\n          'image_url' in rows[0] ||\r\n          'i.id' in rows[0] ||\r\n          Object.keys(rows[0]).some(k => k.startsWith('image_') || k.startsWith('i.') || k.toLowerCase().includes('image'))\r\n        );\r\n        const hasAutopartId = rows.length > 0 && (\r\n          'id' in rows[0] || \r\n          'a.id' in rows[0] ||\r\n          'autopart_id' in rows[0]\r\n        );\r\n        \r\n        // Also check if rows have autoparts-specific columns (make, model, year, title, etc.)\r\n        const hasAutopartsColumns = rows.length > 0 && (\r\n          'make' in rows[0] || \r\n          'model' in rows[0] || \r\n          'year' in rows[0] ||\r\n          'title' in rows[0] ||\r\n          'part_name' in rows[0] ||\r\n          'sale_price' in rows[0] ||\r\n          'stock_number' in rows[0]\r\n        );\r\n\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Step 5: Checking grouping conditions:`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}]   - effectiveServiceType: \"${effectiveServiceType}\"`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}]   - hasImageColumns: ${hasImageColumns}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}]   - hasAutopartId: ${hasAutopartId}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}]   - hasAutopartsColumns: ${hasAutopartsColumns}`);\r\n        if (rows.length > 0) {\r\n          console.log(`   \uD83D\uDD0D [${requestId}]   - First row keys:`, Object.keys(rows[0]).join(', '));\r\n          console.log(`   \uD83D\uDD0D [${requestId}]   - First row has 'image_id':`, 'image_id' in rows[0]);\r\n          console.log(`   \uD83D\uDD0D [${requestId}]   - First row has 'autopart_id':`, 'autopart_id' in rows[0]);\r\n          console.log(`   \uD83D\uDD0D [${requestId}]   - First row has 'id':`, 'id' in rows[0]);\r\n        }\r\n\r\n        // Group if: (serviceType is autoparts OR has autoparts columns) AND has images AND has autopart ID\r\n        // This makes grouping more robust - it will group even if serviceType doesn't match exactly\r\n        const serviceTypeMatch = effectiveServiceType === \"autoparts\";\r\n        const condition1 = serviceTypeMatch || hasAutopartsColumns;\r\n        const condition2 = hasImageColumns;\r\n        const condition3 = hasAutopartId;\r\n        const shouldGroup = condition1 && condition2 && condition3;\r\n        \r\n        console.log(`   \uD83D\uDD0D [${requestId}] ========== GROUPING CONDITION EVALUATION ==========`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Condition 1 (serviceType OR autoparts columns): ${condition1}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}]   - serviceType === \"autoparts\": ${serviceTypeMatch} (effectiveServiceType=\"${effectiveServiceType}\")`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}]   - hasAutopartsColumns: ${hasAutopartsColumns}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Condition 2 (hasImageColumns): ${condition2}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] Condition 3 (hasAutopartId): ${condition3}`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] FINAL DECISION: shouldGroup = ${shouldGroup} (${condition1} && ${condition2} && ${condition3})`);\r\n        console.log(`   \uD83D\uDD0D [${requestId}] ==================================================`);\r\n        \r\n        if (shouldGroup) {\r\n          console.log(`   \uD83D\uDD04 [${requestId}] ========== ENTERING GROUPING BLOCK ==========`);\r\n          console.log(`   \uD83D\uDD04 [${requestId}] Step 5: Grouping autoparts with images (${rows.length} rows)`);\r\n          \r\n          const autopartsMap = new Map<number | string, any>();\r\n          let rowIndex = 0;\r\n          \r\n          for (const row of rows) {\r\n            rowIndex++;\r\n            console.log(`   \uD83D\uDCE6 [${requestId}] Processing row ${rowIndex}/${rows.length}:`);\r\n            console.log(`   \uD83D\uDCE6 [${requestId}]   - Row keys: ${Object.keys(row).join(', ')}`);\r\n            console.log(`   \uD83D\uDCE6 [${requestId}]   - Row id: ${row.id}, row['a.id']: ${row['a.id']}, row.autopart_id: ${row.autopart_id}`);\r\n            \r\n            // Determine autopart ID (could be 'id', 'a.id', or 'autopart_id')\r\n            // Note: Since SQL uses a.*, the id column will be directly available as 'id', not 'a.id'\r\n            const autopartId = row.id || row['a.id'] || row.autopart_id;\r\n            console.log(`   \uD83D\uDCE6 [${requestId}]   - Autopart ID: ${autopartId} (from: ${row.id ? 'id' : row['a.id'] ? 'a.id' : 'autopart_id'})`);\r\n            \r\n            if (!autopartId) {\r\n              console.log(`   \u26A0\uFE0F  [${requestId}]   - Skipping row ${rowIndex}: No autopart ID found`);\r\n              console.log(`   \u26A0\uFE0F  [${requestId}]   - Full row data: ${JSON.stringify(row, null, 2)}`);\r\n              continue;\r\n            }\r\n\r\n            // Get or create autopart entry\r\n            const isNewAutopart = !autopartsMap.has(autopartId);\r\n            console.log(`   \uD83D\uDCE6 [${requestId}]   - Is new autopart: ${isNewAutopart}`);\r\n            \r\n            if (isNewAutopart) {\r\n              console.log(`   \uD83C\uDD95 [${requestId}]   - Creating new autopart entry for ID: ${autopartId}`);\r\n              const autopart: any = {\r\n                imageModals: [] as any[]\r\n              };\r\n\r\n              // Copy autopart columns (skip image columns)\r\n              let copiedColumns = 0;\r\n              let skippedColumns = 0;\r\n              for (const [k, v] of Object.entries(row || {})) {\r\n                // Skip image columns (they'll be in imageModals)\r\n                if (k.startsWith('image_') || k.startsWith('i.') || (k.toLowerCase().includes('image') && k !== 'imageModals') || k === 'autopart_id') {\r\n                  skippedColumns++;\r\n                  continue;\r\n                }\r\n                // Copy autopart columns\r\n                if (k.startsWith('a.')) {\r\n                  const cleanKey = k.substring(2); // Remove 'a.' prefix\r\n                  autopart[cleanKey] = v;\r\n                  copiedColumns++;\r\n                } else {\r\n                  autopart[k] = v;\r\n                  copiedColumns++;\r\n                }\r\n              }\r\n              console.log(`   \uD83D\uDCCB [${requestId}]   - Copied ${copiedColumns} autopart columns, skipped ${skippedColumns} image columns`);\r\n\r\n              // Ensure price exists\r\n              if (autopart.price === undefined || autopart.price === null) {\r\n                const maybePrice = autopart.Price ?? autopart.price_usd ?? autopart.amount ?? autopart.cost ?? autopart.sale_price;\r\n                autopart.price = typeof maybePrice === \"string\" ? parseFloat(maybePrice) : (typeof maybePrice === \"number\" ? maybePrice : 0);\r\n                console.log(`   \uD83D\uDCB0 [${requestId}]   - Set price: ${autopart.price} (from: ${maybePrice !== undefined ? 'sale_price/Price/etc' : 'default 0'})`);\r\n              }\r\n\r\n              // Autoparts workflow expects partName\r\n              if (!autopart.partName && autopart.part_name) {\r\n                autopart.partName = autopart.part_name;\r\n                console.log(`   \uD83D\uDCDD [${requestId}]   - Set partName from part_name: ${autopart.partName}`);\r\n              }\r\n              if (!autopart.partName && autopart.title) {\r\n                autopart.partName = autopart.title;\r\n                console.log(`   \uD83D\uDCDD [${requestId}]   - Set partName from title: ${autopart.partName}`);\r\n              }\r\n\r\n              autopartsMap.set(autopartId, autopart);\r\n              console.log(`   \u2705 [${requestId}]   - Autopart entry created with ${Object.keys(autopart).length} properties`);\r\n              console.log(`   \uD83D\uDCCB [${requestId}]   - Autopart fields: ${Object.keys(autopart).join(', ')}`);\r\n            } else {\r\n              console.log(`   \uD83D\uDD04 [${requestId}]   - Using existing autopart entry for ID: ${autopartId}`);\r\n            }\r\n\r\n            // Add image to imageModals if image data exists\r\n            const autopart = autopartsMap.get(autopartId)!;\r\n            const imageData: any = {};\r\n            let hasImageData = false;\r\n\r\n            console.log(`   \uD83D\uDDBC\uFE0F  [${requestId}]   - Extracting image data from row ${rowIndex}:`);\r\n            \r\n            // Extract image columns\r\n            for (const [k, v] of Object.entries(row || {})) {\r\n              // Handle aliased image columns (image_id, image_url, etc.)\r\n              if (k.startsWith('image_')) {\r\n                const cleanKey = k.substring(6); // Remove 'image_' prefix\r\n                if (v !== null && v !== undefined) {\r\n                  imageData[cleanKey] = v;\r\n                  hasImageData = true;\r\n                  console.log(`   \uD83D\uDDBC\uFE0F  [${requestId}]     - Found image column '${k}' -> '${cleanKey}': ${v}`);\r\n                }\r\n              } else if (k === 'autopart_id' && v !== null && v !== undefined) {\r\n                // Keep autopart_id for reference\r\n                imageData[k] = v;\r\n                console.log(`   \uD83D\uDDBC\uFE0F  [${requestId}]     - Found autopart_id: ${v}`);\r\n              } else if (k.startsWith('i.')) {\r\n                // Handle 'i.' prefixed columns (fallback)\r\n                const cleanKey = k.substring(2);\r\n                if (v !== null && v !== undefined) {\r\n                  imageData[cleanKey] = v;\r\n                  hasImageData = true;\r\n                  console.log(`   \uD83D\uDDBC\uFE0F  [${requestId}]     - Found image column '${k}' -> '${cleanKey}': ${v}`);\r\n                }\r\n              }\r\n            }\r\n\r\n            console.log(`   \uD83D\uDDBC\uFE0F  [${requestId}]   - Image data extracted: hasImageData=${hasImageData}, keys: ${Object.keys(imageData).join(', ')}`);\r\n\r\n            // Only add image if it has data (not null/undefined)\r\n            if (hasImageData && Object.keys(imageData).length > 0) {\r\n              // Avoid duplicates (check if image with same ID already exists)\r\n              const imageId = imageData.id || imageData.image_id;\r\n              const existingImageCount = autopart.imageModals.length;\r\n              \r\n              if (imageId) {\r\n                const isDuplicate = autopart.imageModals.find((img: any) => (img.id || img.image_id) === imageId);\r\n                if (!isDuplicate) {\r\n                  autopart.imageModals.push(imageData);\r\n                  console.log(`   \u2705 [${requestId}]   - Added image with ID ${imageId} (total images: ${autopart.imageModals.length})`);\r\n                } else {\r\n                  console.log(`   \u23ED\uFE0F  [${requestId}]   - Skipped duplicate image with ID ${imageId}`);\r\n                }\r\n              } else {\r\n                // If no ID, check by URL or other unique field to avoid duplicates\r\n                const imageUrl = imageData.url || imageData.image_url;\r\n                if (imageUrl) {\r\n                  const isDuplicate = autopart.imageModals.find((img: any) => (img.url || img.image_url) === imageUrl);\r\n                  if (!isDuplicate) {\r\n                    autopart.imageModals.push(imageData);\r\n                    console.log(`   \u2705 [${requestId}]   - Added image with URL ${imageUrl} (total images: ${autopart.imageModals.length})`);\r\n                  } else {\r\n                    console.log(`   \u23ED\uFE0F  [${requestId}]   - Skipped duplicate image with URL ${imageUrl}`);\r\n                  }\r\n                } else {\r\n                  // If no unique identifier, just add it\r\n                  autopart.imageModals.push(imageData);\r\n                  console.log(`   \u2705 [${requestId}]   - Added image without ID/URL (total images: ${autopart.imageModals.length})`);\r\n                }\r\n              }\r\n            } else {\r\n              console.log(`   \u26A0\uFE0F  [${requestId}]   - No image data to add (hasImageData=${hasImageData}, keys.length=${Object.keys(imageData).length})`);\r\n            }\r\n          }\r\n\r\n          // Filter to only include specified return fields + imageModals (if returnFields provided)\r\n          if (returnFields && returnFields.length > 0) {\r\n            const returnFieldsList = returnFields.split(',').map(f => f.trim()).filter(f => f.length > 0);\r\n            // Always include imageModals\r\n            const fieldsToInclude = [...returnFieldsList, 'imageModals'];\r\n            groupedResults = Array.from(autopartsMap.values()).map((ap: any) => {\r\n              const filtered: any = {};\r\n              for (const field of fieldsToInclude) {\r\n                if (field === 'imageModals') {\r\n                  filtered[field] = ap[field] || [];\r\n                } else if (ap[field] !== undefined) {\r\n                  filtered[field] = ap[field];\r\n                }\r\n              }\r\n              return filtered;\r\n            });\r\n            console.log(`   \u2705 [${requestId}] Step 5 Complete: Grouped ${rows.length} rows into ${groupedResults.length} autopart(s) with images`);\r\n            console.log(`   \uD83D\uDCCB [${requestId}] Filtered to return fields: ${returnFieldsList.join(', ')}, + imageModals`);\r\n            // Log all autopart IDs that were grouped\r\n            console.log(`   \uD83D\uDCCB [${requestId}] Autopart IDs in map: ${Array.from(autopartsMap.keys()).join(', ')}`);\r\n            // Log available fields before filtering for debugging\r\n            const firstAutopartBeforeFilter = Array.from(autopartsMap.values())[0];\r\n            if (firstAutopartBeforeFilter) {\r\n              console.log(`   \uD83D\uDCCB [${requestId}] Available fields in first autopart (before filtering): ${Object.keys(firstAutopartBeforeFilter).join(', ')}`);\r\n            }\r\n            for (let i = 0; i < groupedResults.length; i++) {\r\n              const ap = groupedResults[i];\r\n              const fieldValues = returnFieldsList.map(f => `${f}=${ap[f] !== undefined ? JSON.stringify(ap[f]) : 'N/A'}`).join(', ');\r\n              console.log(`   \uD83D\uDCCA [${requestId}]   - Autopart ${i + 1}: ${fieldValues}, images=${ap.imageModals?.length || 0}`);\r\n              console.log(`   \uD83D\uDCCA [${requestId}]   - Autopart ${i + 1} all fields after filtering: ${Object.keys(ap).join(', ')}`);\r\n            }\r\n          } else {\r\n            // No returnFields specified - return all fields (no filtering)\r\n            groupedResults = Array.from(autopartsMap.values());\r\n            console.log(`   \u2705 [${requestId}] Step 5 Complete: Grouped ${rows.length} rows into ${groupedResults.length} autopart(s) with images`);\r\n            console.log(`   \uD83D\uDCCB [${requestId}] Returning all fields (no returnFields specified, no filtering)`);\r\n          }\r\n          \r\n          // Update columns to reflect grouped structure (exclude image columns, include imageModals)\r\n          const groupedColumns = groupedResults.length > 0 ? Object.keys(groupedResults[0]).filter(k => k !== 'imageModals') : sqlResult.columns;\r\n          console.log(`   \uD83D\uDCCB [${requestId}] Grouped columns:`, groupedColumns.join(', '), '+ imageModals array');\r\n        } else {\r\n          console.log(`   \u23ED\uFE0F  [${requestId}] ========== SKIPPING GROUPING ==========`);\r\n          console.log(`   \u23ED\uFE0F  [${requestId}] Reason: Grouping condition not met`);\r\n          console.log(`   \u23ED\uFE0F  [${requestId}]   - effectiveServiceType: \"${effectiveServiceType}\"`);\r\n          console.log(`   \u23ED\uFE0F  [${requestId}]   - serviceType === \"autoparts\": ${serviceTypeMatch}`);\r\n          console.log(`   \u23ED\uFE0F  [${requestId}]   - hasAutopartsColumns: ${hasAutopartsColumns}`);\r\n          console.log(`   \u23ED\uFE0F  [${requestId}]   - hasImageColumns: ${hasImageColumns}`);\r\n          console.log(`   \u23ED\uFE0F  [${requestId}]   - hasAutopartId: ${hasAutopartId}`);\r\n          console.log(`   \u23ED\uFE0F  [${requestId}] ==========================================`);\r\n        }\r\n\r\n        console.log(`   \uD83D\uDCCA [${requestId}] getData Wrapper Test Results:`);\r\n        console.log(`   \uD83D\uDCCA [${requestId}] - Raw Row Count: ${sqlResult.rowCount}`);\r\n        console.log(`   \uD83D\uDCCA [${requestId}] - Grouped Result Count: ${groupedResults.length}`);\r\n        console.log(`   \uD83D\uDCCA [${requestId}] - Columns: ${sqlResult.columns.join(', ')}`);\r\n        console.log(`   \uD83D\uDCCA [${requestId}] - Elapsed: ${sqlResult.elapsedMs}ms`);\r\n        if (groupedResults.length > 0) {\r\n          console.log(`   \uD83D\uDCCA [${requestId}] - First Result:`, JSON.stringify(groupedResults[0], bigIntReplacer, 2));\r\n          if (groupedResults.length > 1) {\r\n            console.log(`   \uD83D\uDCCA [${requestId}] - All Results (${groupedResults.length}):`, JSON.stringify(groupedResults, bigIntReplacer, 2));\r\n          }\r\n        } else {\r\n          console.log(`   \uD83D\uDCCA [${requestId}] - No results returned`);\r\n        }\r\n\r\n        // Determine which columns to use for display\r\n        const wasGrouped = groupedResults.length !== sqlResult.rowCount || (groupedResults.length > 0 && groupedResults[0].imageModals !== undefined);\r\n        const displayColumns = wasGrouped && groupedResults.length > 0\r\n          ? Object.keys(groupedResults[0]).filter(k => k !== 'imageModals')\r\n          : sqlResult.columns;\r\n\r\n        console.log(`   \uD83D\uDCE4 [${requestId}] Final Response:`);\r\n        console.log(`   \uD83D\uDCE4 [${requestId}]   - Was grouped: ${wasGrouped}`);\r\n        console.log(`   \uD83D\uDCE4 [${requestId}]   - Returning ${groupedResults.length} result(s) (was ${sqlResult.rowCount} raw rows)`);\r\n        console.log(`   \uD83D\uDCE4 [${requestId}]   - Display columns: ${displayColumns.length} columns`);\r\n\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        const responseData = {\r\n          success: true,\r\n          result: {\r\n            getDataParams,\r\n            sqlParameterization: sqlParamResult,\r\n            sqlExecution: {\r\n              ...sqlResult,\r\n              rows: groupedResults, // Return grouped results instead of raw rows\r\n              rowCount: groupedResults.length, // Update row count to reflect grouped results\r\n              columns: displayColumns // Update columns to match grouped structure\r\n            },\r\n            summary: {\r\n              userQuery,\r\n              serviceType: getDataParams.serviceType,\r\n              sqlParamsUsed: sqlParams,\r\n              rawRowsReturned: sqlResult.rowCount,\r\n              groupedResultsReturned: groupedResults.length,\r\n              wasGrouped: wasGrouped,\r\n              elapsedMs: sqlResult.elapsedMs\r\n            }\r\n          },\r\n          timestamp: Date.now()\r\n        };\r\n        \r\n        console.log(`   \uD83D\uDCE4 [${requestId}] Response JSON size: ${JSON.stringify(responseData, bigIntReplacer).length} bytes`);\r\n        res.end(JSON.stringify(responseData, bigIntReplacer));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C [${requestId}] getData Wrapper Test failed:`, err.message);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message || String(err) }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // ROOT CA LLM Service: SQL Parameterization (GOD-controlled SQL security)\r\n  // This endpoint converts SQL queries with hardcoded values to parameterized queries\r\n  // to prevent SQL injection. GOD (ROOT CA) has control over all SQL security patterns.\r\n  if (pathname === \"/api/root-ca/llm/parameterize-sql\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDC51 [${requestId}] POST /api/root-ca/llm/parameterize-sql - ROOT CA LLM SQL parameterization`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const parsed = JSON.parse(body || \"{}\");\r\n        const sql = String(parsed.sql || \"\").trim();\r\n\r\n        if (!sql) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"sql is required\" }));\r\n          return;\r\n        }\r\n\r\n        const result = await parameterizeSQLWithOpenAI(sql);\r\n\r\n        broadcastEvent({\r\n          type: \"root_ca_llm_sql_parameterization_complete\",\r\n          component: \"root-ca-llm\",\r\n          message: `SQL parameterized: ${result.paramOrder.length} parameters extracted`,\r\n          timestamp: Date.now(),\r\n          data: { result }\r\n        });\r\n\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, result, timestamp: Date.now() }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C [${requestId}] Error parameterizing SQL: ${err.message}`);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message || String(err) }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // ROOT CA LLM Service: getData() Parameter Extraction (GOD-controlled data access)\r\n  // This endpoint translates natural language queries into structured getData() parameters\r\n  // for provider data layers. GOD (ROOT CA) has control over all data access patterns.\r\n  if (pathname === \"/api/root-ca/llm/get-data-params\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDC51 [${requestId}] POST /api/root-ca/llm/get-data-params - ROOT CA LLM getData() parameter extraction`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const parsed = JSON.parse(body || \"{}\");\r\n        const userInput = String(parsed.userInput || parsed.query || \"\").trim();\r\n        const serviceType = parsed.serviceType; // Optional: hint for service type\r\n\r\n        if (!userInput) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"userInput or query is required\" }));\r\n          return;\r\n        }\r\n\r\n        console.log(`   \uD83D\uDC51 [${requestId}] ROOT CA LLM: Translating user query to getData() params`);\r\n        console.log(`   \uD83D\uDCDD [${requestId}] User input: \"${userInput}\"`);\r\n\r\n        const result = await extractGetDataParamsWithOpenAI(userInput);\r\n\r\n        // If serviceType hint provided and LLM didn't detect it, use the hint\r\n        if (serviceType && result.serviceType !== serviceType) {\r\n          console.log(`   \uD83D\uDD04 [${requestId}] Overriding serviceType from \"${result.serviceType}\" to \"${serviceType}\" (hint provided)`);\r\n          result.serviceType = serviceType;\r\n        }\r\n\r\n        console.log(`   \u2705 [${requestId}] ROOT CA LLM extracted getData() params:`, {\r\n          serviceType: result.serviceType,\r\n          params: result.params,\r\n          maxCount: result.maxCount,\r\n          sortBy: result.sortBy,\r\n          order: result.order,\r\n          confidence: result.confidence\r\n        });\r\n\r\n        // Broadcast ROOT CA LLM event\r\n        broadcastEvent({\r\n          type: \"root_ca_llm_getdata_extracted\",\r\n          component: \"root-ca\",\r\n          message: `ROOT CA LLM extracted getData() parameters for ${result.serviceType}`,\r\n          timestamp: Date.now(),\r\n          data: {\r\n            userInput,\r\n            result,\r\n            provider: \"openai\"\r\n          }\r\n        });\r\n\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, result, timestamp: Date.now() }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C [${requestId}] ROOT CA LLM getData() extraction failed:`, err.message);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message || String(err) }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // Backend-hosted provider webhook receiver (deployable plugin endpoint)\r\n  if (pathname.startsWith(\"/api/provider-plugin/webhook/\") && req.method === \"POST\") {\r\n    const providerId = pathname.split(\"/api/provider-plugin/webhook/\")[1] || \"\";\r\n    console.log(`   \uD83E\uDDE9 [${requestId}] POST /api/provider-plugin/webhook/${providerId}`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", () => {\r\n      try {\r\n        let payload: any = null;\r\n        try { payload = body ? JSON.parse(body) : null; } catch { payload = body; }\r\n\r\n        broadcastEvent({\r\n          type: \"provider_plugin_webhook_received\",\r\n          component: \"provider-plugin\",\r\n          message: `Webhook received for ${providerId}`,\r\n          timestamp: Date.now(),\r\n          data: { providerId, payload, requestId }\r\n        });\r\n\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, providerId, received: true, timestamp: Date.now() }));\r\n      } catch (err: any) {\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message || String(err) }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // ============================================\r\n  // CERTIFICATION PROVISION WIZARD API\r\n  // ============================================\r\n  if (pathname === \"/api/wizard/service-types\" && req.method === \"GET\") {\r\n    console.log(`   \uD83E\uDDD9 [${requestId}] GET /api/wizard/service-types - Getting service types`);\r\n    \r\n    const serviceTypes = [\r\n      { type: \"movie\", icon: \"\uD83C\uDFAC\", name: \"Movie Tickets\", description: \"Movie ticket booking service\" },\r\n      { type: \"dex\", icon: \"\uD83D\uDCB0\", name: \"DEX Tokens\", description: \"Decentralized exchange token pools\" },\r\n      { type: \"airline\", icon: \"\u2708\uFE0F\", name: \"Airline Tickets\", description: \"Airline ticket booking service\" },\r\n      { type: \"autoparts\", icon: \"\uD83D\uDD27\", name: \"Auto Parts\", description: \"Automotive parts marketplace\" },\r\n      { type: \"hotel\", icon: \"\uD83C\uDFE8\", name: \"Hotel Booking\", description: \"Hotel reservation service\" },\r\n      { type: \"restaurant\", icon: \"\uD83C\uDF7D\uFE0F\", name: \"Restaurant Reservations\", description: \"Restaurant booking service\" },\r\n      { type: \"snake\", icon: \"\uD83D\uDC0D\", name: \"Snake (Advertiser)\", description: \"Advertising service provider\" }\r\n    ];\r\n    \r\n    res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n    res.end(JSON.stringify({ success: true, serviceTypes }));\r\n    return;\r\n  }\r\n\r\n  // ============================================\r\n  // DEX GARDENS SERVICE (separate ecosystem from \uD83C\uDF4E APPLES SaaS)\r\n  // ============================================\r\n  if (pathname === \"/api/dex-gardens/create\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDD37 [${requestId}] POST /api/dex-gardens/create - Creating DEX garden (no \uD83C\uDF4E APPLES ledger)`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const requestData = JSON.parse(body);\r\n        const gardenName = requestData.gardenName || requestData.indexerName;\r\n        const { serverIp, serverDomain, serverPort, networkType, email, tokenSymbol, baseToken, initialLiquidity, stripePaymentIntentId } = requestData;\r\n        const serviceType = \"dex\";\r\n        \r\n        // Get token pair from request or use defaults\r\n        const finalTokenSymbol = tokenSymbol || 'TOKEN';\r\n        const finalBaseToken = baseToken || 'SOL';\r\n        console.log(`   \uD83D\uDCB0 [DEX Garden] Token pair configuration: ${finalTokenSymbol}/${finalBaseToken}`);\r\n\r\n        if (!gardenName) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"gardenName required\" }));\r\n          return;\r\n        }\r\n\r\n        if (!email || typeof email !== 'string' || !email.includes('@')) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Valid email address required. Please sign in first.\" }));\r\n          return;\r\n        }\r\n        \r\n        // CRITICAL: Validate initial liquidity requirement for DEX gardens\r\n        const MIN_LIQUIDITY_AMOUNT = 10000; // Minimum 10,000 \uD83C\uDF4E APPLES to prevent spam\r\n        if (!initialLiquidity || initialLiquidity < MIN_LIQUIDITY_AMOUNT) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ \r\n            success: false, \r\n            error: `Initial liquidity must be at least ${MIN_LIQUIDITY_AMOUNT.toLocaleString()} \uD83C\uDF4E APPLES to prevent spam and ensure pool stability.` \r\n          }));\r\n          return;\r\n        }\r\n        \r\n        // Stripe payment is optional - if provided, verify it; otherwise use user's balance\r\n        let liquidityCertified = false;\r\n        let stripePaymentRailBound = false;\r\n        let finalStripePaymentIntentId = stripePaymentIntentId || '';\r\n        \r\n        if (stripePaymentIntentId && typeof stripePaymentIntentId === 'string') {\r\n          // Verify Stripe payment intent exists and is paid\r\n          try {\r\n            const paymentIntent = await stripe.paymentIntents.retrieve(stripePaymentIntentId);\r\n            if (paymentIntent.status !== 'succeeded') {\r\n              res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n              res.end(JSON.stringify({\r\n                success: false,\r\n                error: `Stripe payment not completed. Payment status: ${paymentIntent.status}. Please complete the payment first.`\r\n              }));\r\n              return;\r\n            }\r\n            \r\n            // Verify payment amount matches requested liquidity\r\n            const paidAmount = paymentIntent.amount / 100; // Convert from cents\r\n            if (paidAmount < initialLiquidity) {\r\n              res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n              res.end(JSON.stringify({ \r\n                success: false, \r\n                error: `Payment amount (${paidAmount} \uD83C\uDF4E APPLES) is less than requested liquidity (${initialLiquidity} \uD83C\uDF4E APPLES).` \r\n              }));\r\n              return;\r\n            }\r\n            \r\n            liquidityCertified = true;\r\n            stripePaymentRailBound = true;\r\n            console.log(`   \u2705 [DEX Garden] Stripe Payment Rail verified: ${paidAmount} \uD83C\uDF4E APPLES paid via ${stripePaymentIntentId}`);\r\n          } catch (stripeErr: any) {\r\n            console.warn(`   \u26A0\uFE0F [DEX Garden] Stripe payment verification failed: ${stripeErr.message}`);\r\n            // Continue without Stripe - use user's balance instead\r\n            finalStripePaymentIntentId = '';\r\n          }\r\n        }\r\n        \r\n        // If no Stripe payment, check if user has sufficient balance\r\n        if (!liquidityCertified) {\r\n          const userBalance = await getWalletBalance(email);\r\n          if (userBalance < initialLiquidity) {\r\n            res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n            res.end(JSON.stringify({\r\n              success: false,\r\n              error: `Insufficient balance. You have ${userBalance.toLocaleString()} \uD83C\uDF4E APPLES but need ${initialLiquidity.toLocaleString()} \uD83C\uDF4E APPLES for initial liquidity.`\r\n            }));\r\n            return;\r\n          }\r\n          console.log(`   \uD83D\uDCB0 [DEX Garden] Using user balance for initial liquidity: ${initialLiquidity} \uD83C\uDF4E APPLES (balance: ${userBalance.toLocaleString()} \uD83C\uDF4E APPLES)`);\r\n        }\r\n\r\n        // Keep priesthood rule consistent with SaaS gardens (can relax later)\r\n        if (email && email !== 'bill.draper.auto@gmail.com') {\r\n          const hasCert = hasPriesthoodCertification(email);\r\n          if (!hasCert) {\r\n            res.writeHead(403, { \"Content-Type\": \"application/json\" });\r\n            res.end(JSON.stringify({\r\n              success: false,\r\n              error: \"Priesthood certification required to create DEX gardens. Please apply for priesthood certification first.\"\r\n            }));\r\n            return;\r\n          }\r\n        }\r\n\r\n        // Determine next available port (starting from 3001) if not provided\r\n        let finalPort = serverPort;\r\n        if (!finalPort || finalPort < 3001) {\r\n          const basePort = 3001;\r\n          const existingIndexers = [...GARDENS, ...TOKEN_GARDENS];\r\n          const usedPorts = existingIndexers.map(i => (i as any).serverPort || null).filter(p => p !== null && p !== undefined);\r\n          let nextPort = basePort;\r\n          while (usedPorts.includes(nextPort)) nextPort++;\r\n          finalPort = nextPort;\r\n        }\r\n\r\n        // Generate new token garden ID (T{n})\r\n        const allExistingIndexers = [...GARDENS, ...TOKEN_GARDENS];\r\n        const tokenGardenIds = allExistingIndexers\r\n          .filter(i => i.id && i.id.startsWith('T'))\r\n          .map(ti => {\r\n            const match = ti.id.match(/^T(\\d+)$/);\r\n            return match ? parseInt(match[1], 10) : 0;\r\n          });\r\n        const maxTokenNumber = tokenGardenIds.length > 0 ? Math.max(...tokenGardenIds) : 0;\r\n        const gardenId = `T${maxTokenNumber + 1}`;\r\n\r\n        // Prevent duplicates\r\n        const existingTokenGarden = TOKEN_GARDENS.find(tg => tg.id === gardenId);\r\n        if (existingTokenGarden) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: `Token garden with ID \"${gardenId}\" already exists` }));\r\n          return;\r\n        }\r\n\r\n        const gardenConfig: any = {\r\n          id: gardenId,\r\n          name: gardenName,\r\n          stream: `eden:token-garden:${gardenId}`,\r\n          active: true,\r\n          uuid: `eden:garden:${crypto.randomUUID()}`,\r\n          ownerEmail: email,\r\n          priestEmail: email,\r\n          serverIp: serverIp || \"localhost\",\r\n          serverDomain: serverDomain || `dex-${gardenId.toLowerCase()}.eden.local`,\r\n          serverPort: finalPort,\r\n          networkType: networkType || \"http\",\r\n          serviceType,\r\n          tokenServiceType: 'dex',\r\n          // Stripe Payment Rail binding and liquidity certification\r\n          stripePaymentRailBound: stripePaymentRailBound,\r\n          liquidityCertified: liquidityCertified,\r\n          initialLiquidity: initialLiquidity,\r\n          stripePaymentIntentId: finalStripePaymentIntentId,\r\n          liquidityLoadedAt: Date.now()\r\n        };\r\n\r\n        console.log(`   \uD83D\uDCDC [DEX Gardens] Issuing certificate for ${gardenConfig.name} (${gardenConfig.id})...`);\r\n        issueGardenCertificate(gardenConfig);\r\n        if (!gardenConfig.certificate) {\r\n          res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: `Failed to issue certificate to DEX garden ${gardenConfig.id}` }));\r\n          return;\r\n        }\r\n\r\n        TOKEN_GARDENS.push(gardenConfig);\r\n        console.log(`   \u2705 Created DEX garden: ${gardenConfig.name} (${gardenConfig.id}). Total DEX gardens: ${TOKEN_GARDENS.length}`);\r\n\r\n        // Persist gardens immediately (eden-gardens-persistence.json is the source of truth for gardenId validation)\r\n        try {\r\n          const gardensFile = path.join(__dirname, 'eden-gardens-persistence.json');\r\n          let existingGardensFromFile: any[] = [];\r\n          if (fs.existsSync(gardensFile)) {\r\n            try {\r\n              const fileContent = fs.readFileSync(gardensFile, 'utf-8');\r\n              const persisted = JSON.parse(fileContent);\r\n              existingGardensFromFile = persisted.gardens || persisted.indexers || [];\r\n            } catch (err: any) {\r\n              console.warn(`\u26A0\uFE0F  [DEX Gardens] Failed to read existing gardens file for preservation: ${err.message}`);\r\n            }\r\n          }\r\n\r\n          // In-memory is source of truth; preserve file entries not currently in memory\r\n          const inMemoryAllGardens: any[] = [...GARDENS, ...TOKEN_GARDENS];\r\n          const inMemoryById = new Map<string, any>();\r\n          for (const g of inMemoryAllGardens) {\r\n            if (!g?.id) continue;\r\n            // Prefer versions with certificate if duplicates occur\r\n            const existing = inMemoryById.get(g.id);\r\n            if (!existing) {\r\n              inMemoryById.set(g.id, g);\r\n            } else {\r\n              const hasCert = !!(g as any).certificate;\r\n              const existingHasCert = !!(existing as any).certificate;\r\n              if (hasCert && !existingHasCert) {\r\n                inMemoryById.set(g.id, g);\r\n              }\r\n            }\r\n          }\r\n\r\n          const inMemoryIds = new Set(Array.from(inMemoryById.keys()));\r\n          const preservedGardens = existingGardensFromFile.filter((g: any) => g?.id && !inMemoryIds.has(g.id));\r\n          const allGardensToSave = [...Array.from(inMemoryById.values()), ...preservedGardens];\r\n\r\n          fs.writeFileSync(\r\n            gardensFile,\r\n            JSON.stringify({ gardens: allGardensToSave, lastSaved: new Date().toISOString() }, null, 2),\r\n            'utf-8'\r\n          );\r\n          console.log(`\uD83D\uDCBE [DEX Gardens] Saved ${allGardensToSave.length} total garden(s) to ${gardensFile} (includes DEX garden ${gardenConfig.id})`);\r\n        } catch (persistErr: any) {\r\n          console.warn(`\u26A0\uFE0F  [DEX Gardens] Failed to persist gardens file after DEX garden creation: ${persistErr.message}`);\r\n        }\r\n\r\n        // Register a matching DEX pool provider for this DEX garden and persist service registry.\r\n        // This prevents the service registry persistence file from containing only HG infrastructure.\r\n        try {\r\n          const tokenGardenIndex = TOKEN_GARDENS.findIndex(tg => tg.id === gardenConfig.id);\r\n          // Use token pair from request or defaults\r\n          const tokenSymbol = finalTokenSymbol;\r\n          const poolId = `pool-${finalBaseToken.toLowerCase()}-${tokenSymbol.toLowerCase()}-${tokenGardenIndex + 1}`;\r\n          const providerId = `dex-pool-${tokenSymbol.toLowerCase()}-${tokenGardenIndex + 1}`;\r\n          \r\n          // Create the pool if it doesn't exist\r\n          // Use initial liquidity from Stripe payment (minimum 10,000 \uD83C\uDF4E APPLES)\r\n          if (!DEX_POOLS.has(poolId)) {\r\n            // Calculate pool reserves from initial liquidity\r\n            // For simplicity: baseReserve = initialLiquidity, tokenReserve = initialLiquidity / price\r\n            const baseReserve = initialLiquidity || 10000; // Use paid liquidity amount\r\n            const poolPrice = 0.001; // Default price: 1 TOKEN = 0.001 SOL\r\n            const tokenReserve = baseReserve / poolPrice; // Calculate token reserve from base\r\n            \r\n            const pool: TokenPool = {\r\n              poolId: poolId,\r\n              tokenSymbol: tokenSymbol,\r\n              tokenName: `${tokenSymbol} ${tokenGardenIndex + 1}`,\r\n              baseToken: finalBaseToken,\r\n              poolLiquidity: baseReserve, // Use actual paid liquidity\r\n              tokenReserve: tokenReserve,\r\n              baseReserve: baseReserve, // Use actual paid liquidity\r\n              price: poolPrice,\r\n              bond: 5000,\r\n              gardenId: gardenConfig.id,\r\n              createdAt: Date.now(),\r\n              totalVolume: 0,\r\n              totalTrades: 0,\r\n              // Stripe Payment Rail metadata\r\n              stripePaymentRailBound: stripePaymentRailBound,\r\n              liquidityCertified: liquidityCertified,\r\n              initialLiquidity: initialLiquidity,\r\n              stripePaymentIntentId: finalStripePaymentIntentId\r\n            };\r\n            DEX_POOLS.set(poolId, pool);\r\n            console.log(`   \u2705 [DEX Gardens] Created DEX pool with ${liquidityCertified ? 'Stripe-certified' : 'balance-funded'} liquidity: ${tokenSymbol}/${finalBaseToken} (${poolId})`);\r\n            console.log(`      Initial liquidity: ${baseReserve} ${finalBaseToken}${finalStripePaymentIntentId ? ` (Stripe Payment Rail: ${finalStripePaymentIntentId})` : ' (from user balance)'}`);\r\n            console.log(`      Token reserve: ${tokenReserve} ${tokenSymbol}, Base reserve: ${baseReserve} ${finalBaseToken}`);\r\n            \r\n            // Register initial liquidity with liquidity accountant service\r\n            try {\r\n              const { registerInitialLiquidity } = await import(\"./src/liquidityAccountant\");\r\n              registerInitialLiquidity(\r\n                poolId,\r\n                tokenSymbol,\r\n                finalBaseToken,\r\n                gardenConfig.id,\r\n                baseReserve,\r\n                baseReserve,\r\n                tokenReserve,\r\n                finalStripePaymentIntentId || undefined\r\n              );\r\n              console.log(`   \uD83D\uDCA7 [LiquidityAccountant] Registered initial liquidity for ${tokenSymbol}/${finalBaseToken}`);\r\n            } catch (err: any) {\r\n              console.warn(`   \u26A0\uFE0F  [DEX Gardens] Failed to register liquidity with accountant: ${err.message}`);\r\n            }\r\n          }\r\n\r\n          const existing = ROOT_CA_SERVICE_REGISTRY.find(p => p.id === providerId && p.gardenId === gardenConfig.id);\r\n          let provider: any = null;\r\n          \r\n          if (!existing) {\r\n            provider = {\r\n              id: providerId,\r\n              uuid: crypto.randomUUID(),\r\n              name: `${tokenSymbol} Pool (${gardenConfig.name})`,\r\n              serviceType: \"dex\",\r\n              location: \"Eden DEX\",\r\n              bond: 5000,\r\n              reputation: 5.0,\r\n              gardenId: gardenConfig.id,\r\n              apiEndpoint: `https://dex.eden.com/pools/${poolId}`,\r\n              status: 'active',\r\n            };\r\n\r\n            registerServiceProviderWithROOTCA(provider);\r\n            try {\r\n              issueServiceProviderCertificate(provider);\r\n            } catch (certErr: any) {\r\n              console.warn(`\u26A0\uFE0F  [DEX Gardens] Failed to issue certificate to DEX pool provider ${providerId}: ${certErr.message}`);\r\n            }\r\n\r\n            console.log(`\u2705 [DEX Gardens] Registered DEX pool provider: ${provider.name} (${provider.id}) \u2192 gardenId ${provider.gardenId}`);\r\n          } else {\r\n            console.log(`\u2713 [DEX Gardens] DEX pool provider already exists: ${providerId} \u2192 gardenId ${gardenConfig.id}`);\r\n          }\r\n          \r\n          // Create ledger entry for initial liquidity provisioning (visible to priests)\r\n          try {\r\n            const finalProvider = existing || provider;\r\n            const providerUuid = finalProvider?.uuid || crypto.randomUUID();\r\n            \r\n            const snapshot: TransactionSnapshot = {\r\n              chainId: 'eden',\r\n              txId: `dex_liquidity_${poolId}_${Date.now()}`,\r\n              slot: Date.now(),\r\n              blockTime: Date.now(),\r\n              payer: email,\r\n              merchant: `${tokenSymbol} Pool (${gardenConfig.name})`,\r\n              amount: initialLiquidity,\r\n              feeSplit: {},\r\n            };\r\n            \r\n            const liquiditySource = finalStripePaymentIntentId \r\n              ? `Stripe Payment Rail (${finalStripePaymentIntentId})` \r\n              : 'User Wallet Balance';\r\n            \r\n            const ledgerEntry = addLedgerEntry(\r\n              snapshot,\r\n              'dex',\r\n              0, // No iGas cost for liquidity provisioning\r\n              email,\r\n              `${tokenSymbol} Pool (${gardenConfig.name})`,\r\n              providerUuid,\r\n              {\r\n                action: 'PROVISION_LIQUIDITY',\r\n                poolId: poolId,\r\n                gardenId: gardenConfig.id,\r\n                tokenSymbol: tokenSymbol,\r\n                baseToken: finalBaseToken,\r\n                initialLiquidity: initialLiquidity,\r\n                baseReserve: baseReserve,\r\n                tokenReserve: tokenReserve,\r\n                liquiditySource: liquiditySource,\r\n                stripePaymentIntentId: finalStripePaymentIntentId || undefined,\r\n                liquidityCertified: liquidityCertified,\r\n                stripePaymentRailBound: stripePaymentRailBound,\r\n                provisionedAt: Date.now()\r\n              }\r\n            );\r\n            \r\n            // Mark as completed immediately (liquidity is already provisioned)\r\n            ledgerEntry.status = 'completed';\r\n            \r\n            console.log(`   \uD83D\uDCDD [DEX Gardens] Created ledger entry for initial liquidity: ${initialLiquidity} \uD83C\uDF4E APPLES (${ledgerEntry.entryId})`);\r\n            console.log(`      Source: ${liquiditySource}`);\r\n            console.log(`      Pool: ${tokenSymbol}/${finalBaseToken} (${poolId})`);\r\n            console.log(`      Provider UUID: ${providerUuid}`);\r\n          } catch (ledgerErr: any) {\r\n            console.warn(`   \u26A0\uFE0F  [DEX Gardens] Failed to create ledger entry for initial liquidity: ${ledgerErr.message}`);\r\n            // Don't fail garden creation if ledger entry fails\r\n          }\r\n          \r\n          // Persist via ServiceRegistry2 (primary) and via redis helper (legacy/backward compatibility).\r\n          try {\r\n            const sr2 = getServiceRegistry2();\r\n            sr2.savePersistence();\r\n          } catch (srErr: any) {\r\n            console.warn(`\u26A0\uFE0F  [DEX Gardens] Failed to save ServiceRegistry2 persistence: ${srErr.message}`);\r\n          }\r\n          try {\r\n            if (redis) {\r\n              redis.saveServiceRegistry();\r\n            }\r\n          } catch (legacyErr: any) {\r\n            console.warn(`\u26A0\uFE0F  [DEX Gardens] Failed to save legacy service registry persistence: ${legacyErr.message}`);\r\n          }\r\n        } catch (providerErr: any) {\r\n          console.warn(`\u26A0\uFE0F  [DEX Gardens] Failed to register/persist DEX provider: ${providerErr.message}`);\r\n        }\r\n\r\n        // Ensure DEX pools/providers exist (safe to call repeatedly)\r\n        try {\r\n          initializeDEXPools();\r\n        } catch (err: any) {\r\n          console.warn(`\u26A0\uFE0F  [DEX Gardens] initializeDEXPools failed: ${err.message}`);\r\n        }\r\n\r\n        // Broadcast creation event for UI (use distinct event type)\r\n        broadcastEvent({\r\n          type: \"dex_garden_created\",\r\n          component: \"dex-gardens\",\r\n          message: `DEX Garden ${gardenConfig.name} created successfully`,\r\n          timestamp: Date.now(),\r\n          data: {\r\n            gardenId: gardenConfig.id,\r\n            gardenName: gardenConfig.name,\r\n            serviceType: \"dex\",\r\n            ownerEmail: gardenConfig.ownerEmail,\r\n            hasCertificate: !!gardenConfig.certificate\r\n          }\r\n        });\r\n\r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: true, garden: gardenConfig }));\r\n      } catch (err: any) {\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  if (pathname === \"/api/wizard/create-garden\" && req.method === \"POST\") {\r\n    console.log(`   \uD83E\uDDD9 [${requestId}] POST /api/wizard/create-garden - Creating garden via wizard`);\r\n    console.log(`   \uD83D\uDD0D [${requestId}] Current state: ${GARDENS.length} regular gardens, ${TOKEN_GARDENS.length} token gardens`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const requestData = JSON.parse(body);\r\n        // Accept both gardenName and indexerName for backward compatibility\r\n        const gardenName = requestData.gardenName || requestData.indexerName;\r\n        const { serviceType, serverIp, serverDomain, serverPort, networkType, isSnake, email, amount, selectedProviders, videoUrl } = requestData;\r\n\r\n        // DEX Gardens are a separate ecosystem (no \uD83C\uDF4E APPLES ledger). Route to DexGardensService.\r\n        if ((serviceType || '').toLowerCase() === 'dex') {\r\n          // Reuse request body, but force DEX endpoint behavior\r\n          // by internally delegating via a pseudo-request.\r\n          // Simplest: respond with guidance to use the DEX endpoint (Angular updated to do this).\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({\r\n            success: false,\r\n            error: \"DEX gardens are managed by DexGardensService. Use POST /api/dex-gardens/create (no \uD83C\uDF4E APPLES deployment fee).\"\r\n          }));\r\n          return;\r\n        }\r\n        \r\n        // Check priesthood certification for non-admin users\r\n        if (email && email !== 'bill.draper.auto@gmail.com') {\r\n          const hasCert = hasPriesthoodCertification(email);\r\n          if (!hasCert) {\r\n            res.writeHead(403, { \"Content-Type\": \"application/json\" });\r\n            res.end(JSON.stringify({ \r\n              success: false, \r\n              error: \"Priesthood certification required to create gardens. Please apply for priesthood certification first.\" \r\n            }));\r\n            return;\r\n          }\r\n        }\r\n        \r\n        // Log received data for debugging\r\n        console.log(`   \uD83D\uDCE5 [${requestId}] Received create-garden request:`, {\r\n          serviceType,\r\n          gardenName,\r\n          selectedProviders: selectedProviders || 'NOT PROVIDED',\r\n          selectedProvidersType: typeof selectedProviders,\r\n          selectedProvidersIsArray: Array.isArray(selectedProviders),\r\n          currentTokenIndexersCount: TOKEN_GARDENS.length,\r\n          currentTokenIndexerIds: TOKEN_GARDENS.map(ti => ti.id).join(', ')\r\n        });\r\n        \r\n        if (!serviceType || !gardenName) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"serviceType and gardenName required\" }));\r\n          return;\r\n        }\r\n        \r\n        // Validate email (Google user aware)\r\n        if (!email || typeof email !== 'string' || !email.includes('@')) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Valid email address required. Please sign in with Google first.\" }));\r\n          return;\r\n        }\r\n        \r\n        // Validate amount\r\n        if (!amount || typeof amount !== 'number' || amount <= 0) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"Valid deployment fee amount required\" }));\r\n          return;\r\n        }\r\n        \r\n        // Check wallet balance BEFORE creating garden\r\n        const balance = await getWalletBalance(email);\r\n        if (balance < amount) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ \r\n            success: false, \r\n            error: `Insufficient balance. Required: ${amount} \uD83C\uDF4E APPLES, Available: ${balance} \uD83C\uDF4E APPLES. Please purchase more \uD83C\uDF4E APPLES first.`,\r\n            balance: balance\r\n          }));\r\n          return;\r\n        }\r\n        \r\n        // Debit wallet balance BEFORE creating garden\r\n        const txId = crypto.randomUUID();\r\n        const debitResult = await debitWallet(\r\n          email,\r\n          amount,\r\n          txId,\r\n          'indexer_deployment',\r\n          { \r\n            serviceType: serviceType,\r\n            gardenName: gardenName,\r\n            createdBy: email\r\n          }\r\n        );\r\n        \r\n        if (!debitResult.success) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ \r\n            success: false, \r\n            error: debitResult.error || 'Failed to debit wallet',\r\n            balance: debitResult.balance\r\n          }));\r\n          return;\r\n        }\r\n        \r\n        // Create transaction snapshot for garden creation\r\n        const snapshot: TransactionSnapshot = {\r\n          chainId: 'eden:mainnet',\r\n          txId: txId,\r\n          slot: Date.now(),\r\n          blockTime: Date.now(),\r\n          payer: email,\r\n          merchant: 'ROOT CA',\r\n          amount: amount,\r\n          feeSplit: {}\r\n        };\r\n        \r\n        // Create ledger entry for garden creation\r\n        const ledgerEntry = addLedgerEntry(\r\n          snapshot,\r\n          'garden_deployment',\r\n          0, // iGasCost (no iGas for garden creation)\r\n          email, // payerId\r\n          'ROOT CA', // merchantName\r\n          ROOT_CA_UUID, // providerUuid\r\n          {\r\n            type: 'garden_deployment',\r\n            description: `Garden deployment: ${gardenName || 'Unknown'}`,\r\n            price: amount,\r\n            serviceType: serviceType,\r\n            gardenName: gardenName,\r\n            createdBy: email\r\n          }\r\n        );\r\n        \r\n        // Get user for cashier processing\r\n        let user = USERS_STATE.find(u => u.email === email);\r\n        if (!user) {\r\n          user = {\r\n            id: email,\r\n            email: email,\r\n            balance: debitResult.balance\r\n          };\r\n          USERS_STATE.push(user);\r\n        } else {\r\n          // Update user balance to match debited balance\r\n          user.balance = debitResult.balance;\r\n        }\r\n        \r\n        // Process payment through cashier (wallet already debited, so just update cashier stats)\r\n        const cashier = getCashierStatus();\r\n        cashier.processedCount++;\r\n        cashier.totalProcessed += amount;\r\n        ledgerEntry.status = 'processed';\r\n        \r\n        // Broadcast cashier payment processed event\r\n        broadcastEvent({\r\n          type: \"cashier_payment_processed\",\r\n          component: \"cashier\",\r\n          message: `${cashier.name} processed payment: ${amount} \uD83C\uDF4E APPLES`,\r\n          timestamp: Date.now(),\r\n          data: { entry: ledgerEntry, cashier, userBalance: debitResult.balance, walletService: \"wallet-service-001\" }\r\n        });\r\n        \r\n        // Complete the booking\r\n        completeBooking(ledgerEntry);\r\n        \r\n        // Note: pushLedgerEntryToSettlementStream is already called inside addLedgerEntry\r\n        // No need to call it again here\r\n        \r\n        // Broadcast ledger entry created event\r\n        broadcastEvent({\r\n          type: \"ledger_entry_created\",\r\n          component: \"ledger\",\r\n          message: `Ledger entry created for garden deployment: ${ledgerEntry.entryId}`,\r\n          timestamp: Date.now(),\r\n          data: { entry: ledgerEntry }\r\n        });\r\n        \r\n        // Also broadcast ledger_entry_added for backward compatibility\r\n        broadcastEvent({\r\n          type: \"ledger_entry_added\",\r\n          component: \"ledger\",\r\n          message: `Ledger entry created: ${ledgerEntry.entryId}`,\r\n          timestamp: Date.now(),\r\n          data: { entry: ledgerEntry }\r\n        });\r\n        \r\n        // Determine next available port (starting from 3001) if not provided\r\n        let finalPort = serverPort;\r\n        if (!finalPort || finalPort < 3001) {\r\n          const basePort = 3001;\r\n          const existingIndexers = [...GARDENS, ...TOKEN_GARDENS];\r\n          const usedPorts = existingIndexers.map(i => {\r\n            // Extract port from existing indexers if stored\r\n            return (i as any).serverPort || null;\r\n          }).filter(p => p !== null && p !== undefined);\r\n          \r\n          let nextPort = basePort;\r\n          while (usedPorts.includes(nextPort)) {\r\n            nextPort++;\r\n          }\r\n          finalPort = nextPort;\r\n        }\r\n        \r\n        // Create indexer configuration\r\n        // CRITICAL: Check BOTH in-memory arrays AND persistence file to avoid duplicates\r\n        // This follows the same pattern as movie garden creation\r\n        const persistenceFile = path.join(__dirname, 'eden-wallet-persistence.json');\r\n        let persistedGardens: any[] = [];\r\n        if (fs.existsSync(persistenceFile)) {\r\n          try {\r\n            const fileContent = fs.readFileSync(persistenceFile, 'utf-8');\r\n            const persisted = JSON.parse(fileContent);\r\n            persistedGardens = persisted.gardens || persisted.indexers || [];\r\n            // Deduplicate persisted gardens by ID\r\n            const persistedMap = new Map<string, any>();\r\n            for (const g of persistedGardens) {\r\n              if (!persistedMap.has(g.id)) {\r\n                persistedMap.set(g.id, g);\r\n              }\r\n            }\r\n            persistedGardens = Array.from(persistedMap.values());\r\n          } catch (err: any) {\r\n            console.warn(`   \u26A0\uFE0F  [${requestId}] Failed to read persistence file for ID generation: ${err.message}`);\r\n          }\r\n        }\r\n        \r\n        // Combine in-memory and persisted gardens for ID generation\r\n        const allExistingIndexers = [...GARDENS, ...TOKEN_GARDENS, ...persistedGardens];\r\n        // Deduplicate by ID to ensure we have unique list\r\n        const allIndexersMap = new Map<string, any>();\r\n        for (const idx of allExistingIndexers) {\r\n          if (!allIndexersMap.has(idx.id)) {\r\n            allIndexersMap.set(idx.id, idx);\r\n          }\r\n        }\r\n        const uniqueExistingIndexers = Array.from(allIndexersMap.values());\r\n        \r\n        let gardenId: string;\r\n        if (isSnake) {\r\n          const snakeIds = uniqueExistingIndexers.filter(i => (i as any).isSnake).map(i => {\r\n            const match = i.id.match(/^S(\\d+)$/);\r\n            return match ? parseInt(match[1], 10) : 0;\r\n          });\r\n          const maxSnakeNumber = snakeIds.length > 0 ? Math.max(...snakeIds) : 0;\r\n          gardenId = `S${maxSnakeNumber + 1}`;\r\n        } else if (serviceType === \"dex\") {\r\n          // CRITICAL: Check BOTH in-memory TOKEN_GARDENS AND persisted gardens\r\n          // Find the highest T number from all sources and add 1\r\n          const tokenGardenIds = uniqueExistingIndexers\r\n            .filter(i => i.id && i.id.startsWith('T'))\r\n            .map(ti => {\r\n            const match = ti.id.match(/^T(\\d+)$/);\r\n            return match ? parseInt(match[1], 10) : 0;\r\n          });\r\n          const maxTokenNumber = tokenGardenIds.length > 0 ? Math.max(...tokenGardenIds) : 0;\r\n          gardenId = `T${maxTokenNumber + 1}`;\r\n          console.log(`   \uD83D\uDD22 [${requestId}] Generated token garden ID: ${gardenId} (max existing: ${maxTokenNumber}, total unique token gardens found: ${tokenGardenIds.length})`);\r\n        } else {\r\n          // For regular gardens, use format: garden-1, garden-2, etc.\r\n          // Check BOTH in-memory GARDENS AND persisted gardens\r\n          const regularGardenIds = uniqueExistingIndexers\r\n            .filter(i => i.id && (i.id.startsWith('garden-') || i.id.startsWith('indexer-'))) // Support both for migration\r\n            .map(i => {\r\n              // Support both \"garden-N\" and \"indexer-N\" formats for migration\r\n              const gardenMatch = i.id.match(/^garden-(\\d+)$/);\r\n              const indexerMatch = i.id.match(/^indexer-(\\d+)$/);\r\n              if (gardenMatch) return parseInt(gardenMatch[1], 10);\r\n              if (indexerMatch) return parseInt(indexerMatch[1], 10);\r\n              return 0;\r\n            });\r\n          const maxRegularNumber = regularGardenIds.length > 0 ? Math.max(...regularGardenIds) : 0;\r\n          gardenId = `garden-${maxRegularNumber + 1}`;\r\n        }\r\n        \r\n        // Check if garden ID already exists (prevent duplicates by ID - names can be the same)\r\n        // Check in BOTH in-memory arrays AND persisted gardens\r\n        const existingGardenById = uniqueExistingIndexers.find(i => i.id === gardenId);\r\n        if (existingGardenById) {\r\n          console.error(`   \u274C [${requestId}] DUPLICATE DETECTED: Garden ID \"${gardenId}\" already exists!`);\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ \r\n            success: false, \r\n            error: `Garden with ID \"${gardenId}\" already exists (Name: ${existingGardenById.name})`,\r\n            existingGarden: existingGardenById\r\n          }));\r\n          return;\r\n        }\r\n        \r\n        const gardenConfig: GardenConfig = {\r\n          id: gardenId,\r\n          name: gardenName,\r\n          stream: isSnake ? `eden:snake:${gardenId}` : \r\n                 (serviceType === \"dex\" ? `eden:token-garden:${gardenId}` : `eden:garden:${gardenId}`),\r\n          active: true,\r\n          uuid: `eden:garden:${crypto.randomUUID()}`,\r\n          ownerEmail: email, // CRITICAL: Store Priest user email for garden ownership and lifecycle management\r\n          priestEmail: email, // Alias for backward compatibility\r\n        };\r\n        \r\n        // Add network configuration\r\n        (gardenConfig as any).serverIp = serverIp || \"localhost\";\r\n        (gardenConfig as any).serverDomain = serverDomain || `garden-${gardenId.toLowerCase().replace('garden-', '').replace('indexer-', '')}.eden.local`;\r\n        (gardenConfig as any).serverPort = finalPort;\r\n        (gardenConfig as any).networkType = networkType || \"http\";\r\n        (gardenConfig as any).serviceType = serviceType;\r\n        (gardenConfig as any).isSnake = isSnake || false;\r\n        // Store videoUrl for movie gardens\r\n        if (videoUrl && (serviceType === 'movie' || serviceType === 'amc')) {\r\n          (gardenConfig as any).videoUrl = videoUrl;\r\n          console.log(`   \uD83C\uDFAC [${requestId}] Video URL configured for movie garden: ${videoUrl}`);\r\n        }\r\n        \r\n        console.log(`   \uD83D\uDC64 [${requestId}] Garden ownership assigned to Priest user: ${email}`);\r\n        \r\n        // CRITICAL: Issue certificate BEFORE adding to array AND BEFORE saving\r\n        // This ensures the certificate is included in the gardenConfig object\r\n        console.log(`   \uD83D\uDCDC [Certificate] Issuing certificate for ${gardenConfig.name} (${gardenConfig.id})...`);\r\n        issueGardenCertificate(gardenConfig);\r\n        \r\n        // Verify certificate was issued\r\n        if (!gardenConfig.certificate) {\r\n          console.error(`   \u274C [Certificate] Certificate was NOT issued to ${gardenConfig.name} (${gardenConfig.id})!`);\r\n          res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ \r\n            success: false, \r\n            error: `Failed to issue certificate to garden ${gardenConfig.id}`\r\n          }));\r\n          return;\r\n        }\r\n        console.log(`   \u2705 [Certificate] Certificate issued successfully to ${gardenConfig.name} (${gardenConfig.id})`);\r\n        \r\n        // Add to appropriate array (after certificate is issued and verified)\r\n        // CRITICAL: Check for duplicates before adding\r\n        if (serviceType === \"dex\") {\r\n          // Check if this token garden already exists\r\n          const existingTokenGarden = TOKEN_GARDENS.find(ti => ti.id === gardenConfig.id);\r\n          if (existingTokenGarden) {\r\n            console.error(`   \u274C [DUPLICATE PREVENTION] Token garden ${gardenConfig.id} already exists in TOKEN_GARDENS! Skipping duplicate.`);\r\n            res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n            res.end(JSON.stringify({ \r\n              success: false, \r\n              error: `Token garden with ID \"${gardenConfig.id}\" already exists`,\r\n              existingGarden: existingTokenGarden\r\n            }));\r\n            return;\r\n          }\r\n          // CRITICAL: Include certificate in the object we push\r\n          const tokenGardenWithCert = { ...gardenConfig, tokenServiceType: 'dex', certificate: gardenConfig.certificate };\r\n          (TOKEN_GARDENS as any[]).push(tokenGardenWithCert);\r\n          console.log(`   \u2705 Created token garden: ${gardenConfig.name} (${gardenConfig.id}). Total token gardens in memory: ${TOKEN_GARDENS.length}`);\r\n          console.log(`   \uD83D\uDD0D [Token Garden Debug] TOKEN_GARDENS IDs: ${TOKEN_GARDENS.map(ti => ti.id).join(', ')}`);\r\n          console.log(`   \uD83D\uDD0D [Certificate Check] Token garden ${gardenConfig.id} has certificate: ${!!tokenGardenWithCert.certificate}`);\r\n        } else {\r\n          // Check if this regular garden already exists\r\n          const existingRegularGarden = GARDENS.find(i => i.id === gardenConfig.id);\r\n          if (existingRegularGarden) {\r\n            console.error(`   \u274C [DUPLICATE PREVENTION] Regular garden ${gardenConfig.id} already exists in GARDENS! Skipping duplicate.`);\r\n            res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n            res.end(JSON.stringify({ \r\n              success: false, \r\n              error: `Regular garden with ID \"${gardenConfig.id}\" already exists`,\r\n              existingGarden: existingRegularGarden\r\n            }));\r\n            return;\r\n          }\r\n          // CRITICAL: Include certificate in the object we push\r\n          GARDENS.push({ ...gardenConfig, certificate: gardenConfig.certificate });\r\n          console.log(`   \u2705 Created regular garden: ${gardenConfig.name} (${gardenConfig.id}). Total regular gardens: ${GARDENS.length}`);\r\n          console.log(`   \uD83D\uDD0D [Certificate Check] Regular garden ${gardenConfig.id} has certificate: ${!!gardenConfig.certificate}`);\r\n          console.log(`   \uD83D\uDD0D [Service Type] Regular garden ${gardenConfig.id} has serviceType: ${(gardenConfig as any).serviceType || 'undefined'}`);\r\n          if ((gardenConfig as any).serviceType === 'movie') {\r\n            console.log(`   \uD83C\uDFAC [Movie Garden] Movie garden created via Angular wizard: ${gardenConfig.name} (${gardenConfig.id})`);\r\n          }\r\n          \r\n          // Log garden creation\r\n          const gardenLogData = {\r\n            gardenId: gardenConfig.id,\r\n            gardenName: gardenConfig.name,\r\n            serviceType: (gardenConfig as any).serviceType,\r\n            hasCertificate: !!gardenConfig.certificate,\r\n            totalGardens: GARDENS.length\r\n          };\r\n          console.log(`\uD83D\uDCDD [Garden Lifecycle] \u2705 Garden added to memory:`, gardenLogData);\r\n          getLogger().log('garden-lifecycle', 'garden-added-to-memory', gardenLogData);\r\n          \r\n          // Broadcast garden creation event to frontend\r\n          broadcastEvent({\r\n            type: \"garden_created\",\r\n            component: \"root-ca\",\r\n            message: `Garden ${gardenConfig.name} created successfully`,\r\n            timestamp: Date.now(),\r\n            data: {\r\n              gardenId: gardenConfig.id,\r\n              gardenName: gardenConfig.name,\r\n              serviceType: (gardenConfig as any).serviceType,\r\n              hasCertificate: !!gardenConfig.certificate,\r\n              ownerEmail: gardenConfig.ownerEmail, // Include owner email for lifecycle management\r\n              totalGardens: GARDENS.length\r\n            }\r\n          });\r\n        }\r\n        \r\n        // Provider Plugin configs (MySQL/MariaDB) - attach to providerId(s) and persist\r\n        // Expected shape (wizard):\r\n        //   providerPlugins: { mysql: [ { providerId, serviceType, connection, sql, paramOrder?, fieldMap?, maxRows? } ] }\r\n        try {\r\n          const pluginRoot = (requestData as any).providerPlugins;\r\n          const mysqlConfigs = pluginRoot?.mysql;\r\n          const list = Array.isArray(mysqlConfigs) ? mysqlConfigs : (mysqlConfigs ? [mysqlConfigs] : []);\r\n          if (list.length > 0) {\r\n            for (const cfg of list) {\r\n              if (!cfg?.providerId || !cfg?.connection || !cfg?.sql || !cfg?.serviceType) continue;\r\n              setMySQLProviderPluginConfig({\r\n                providerId: String(cfg.providerId),\r\n                serviceType: String(cfg.serviceType),\r\n                connection: {\r\n                  host: String(cfg.connection.host),\r\n                  port: cfg.connection.port ? Number(cfg.connection.port) : 3306,\r\n                  user: String(cfg.connection.user),\r\n                  password: String(cfg.connection.password),\r\n                  database: String(cfg.connection.database),\r\n                },\r\n                sql: String(cfg.sql),\r\n                paramOrder: Array.isArray(cfg.paramOrder) ? cfg.paramOrder.map((x: any) => String(x)) : undefined,\r\n                fieldMap: cfg.fieldMap && typeof cfg.fieldMap === \"object\" ? cfg.fieldMap : undefined,\r\n                maxRows: cfg.maxRows ? Number(cfg.maxRows) : undefined,\r\n              });\r\n            }\r\n            saveProviderPluginPersistence();\r\n            console.log(`   \uD83E\uDDE9 [${requestId}] Saved MySQL provider plugin config(s): ${list.map((c: any) => c?.providerId).filter(Boolean).join(\", \")}`);\r\n            \r\n            // CRITICAL: Update providers to use the MySQL plugin endpoint\r\n            // This ensures queryProviderAPI will route to the plugin\r\n            const serviceRegistry2 = getServiceRegistry2();\r\n            for (const cfg of list) {\r\n              if (!cfg?.providerId) continue;\r\n              const provider = serviceRegistry2.getProvider(String(cfg.providerId));\r\n              if (provider) {\r\n                // Update provider to use MySQL plugin endpoint\r\n                if (provider.apiEndpoint !== \"eden:plugin:mysql\") {\r\n                  provider.apiEndpoint = \"eden:plugin:mysql\";\r\n                  serviceRegistry2.updateProvider(provider);\r\n                  console.log(`   \uD83D\uDD0C [${requestId}] Updated provider ${provider.id} (${provider.name}) to use MySQL plugin endpoint`);\r\n                }\r\n              } else {\r\n                console.warn(`   \u26A0\uFE0F  [${requestId}] Provider ${cfg.providerId} not found in registry - plugin config saved but provider not updated`);\r\n              }\r\n            }\r\n            // Save service registry after updating providers\r\n            try {\r\n              serviceRegistry2.savePersistence();\r\n              console.log(`   \uD83D\uDCBE [${requestId}] Service registry saved after plugin deployment`);\r\n            } catch (saveErr: any) {\r\n              console.error(`   \u274C [${requestId}] Failed to save service registry after plugin deployment:`, saveErr.message);\r\n            }\r\n          }\r\n        } catch (err: any) {\r\n          console.warn(`   \u26A0\uFE0F  [${requestId}] Failed to save provider plugin configs: ${err.message}`);\r\n        }\r\n\r\n        // Provider webhooks requested by wizard (optional)\r\n        // Shape: providerWebhooks: { [providerId]: webhookUrl }\r\n        try {\r\n          const providerWebhooks = (requestData as any).providerWebhooks;\r\n          if (providerWebhooks && typeof providerWebhooks === \"object\") {\r\n            for (const [providerId, webhookUrl] of Object.entries(providerWebhooks)) {\r\n              if (!providerId || !webhookUrl) continue;\r\n              try {\r\n                new URL(String(webhookUrl));\r\n              } catch {\r\n                console.warn(`   \u26A0\uFE0F  [${requestId}] Skipping invalid webhook URL for ${providerId}: ${webhookUrl}`);\r\n                continue;\r\n              }\r\n              PROVIDER_WEBHOOKS.set(String(providerId), {\r\n                providerId: String(providerId),\r\n                webhookUrl: String(webhookUrl),\r\n                registeredAt: Date.now(),\r\n                failureCount: 0,\r\n              });\r\n              console.log(`   \u2705 [${requestId}] Registered provider webhook: ${providerId} \u2192 ${webhookUrl}`);\r\n            }\r\n          }\r\n        } catch (err: any) {\r\n          console.warn(`   \u26A0\uFE0F  [${requestId}] Failed to register provider webhooks: ${err.message}`);\r\n        }\r\n\r\n        // Create service providers for gardens using generic provider creation\r\n        let providersCreated = 0;\r\n        let providerResults: Array<{ providerId: string; providerName: string; created: boolean; assigned: boolean }> = [];\r\n        \r\n        // Support both old format (selectedProviders array for movie) and new format (providers array)\r\n        let providersToCreate: Array<{\r\n          id?: string;\r\n          name: string;\r\n          location?: string;\r\n          bond?: number;\r\n          reputation?: number;\r\n          apiEndpoint?: string;\r\n          uuid?: string;\r\n          insuranceFee?: number;\r\n          iGasMultiplier?: number;\r\n          iTaxMultiplier?: number;\r\n          maxInfluence?: number;\r\n          contextsAllowed?: string[];\r\n          contextsForbidden?: string[];\r\n          adCapabilities?: string[];\r\n        }> = [];\r\n        \r\n        // Backward compatibility: Handle old selectedProviders format for movie\r\n        // CRITICAL: Only process selectedProviders if serviceType is EXACTLY \"movie\"\r\n        // This prevents movie providers from being created for airline or other service types\r\n        if (serviceType === \"movie\" && selectedProviders && Array.isArray(selectedProviders) && selectedProviders.length > 0) {\r\n          console.log(`   \uD83C\uDFAC Converting ${selectedProviders.length} selectedProviders to provider configs for movie garden...`);\r\n          console.log(`   \uD83D\uDD0D [DEBUG] serviceType=\"${serviceType}\", selectedProviders=[${selectedProviders.join(', ')}]`);\r\n          \r\n          // Predefined movie provider map (for backward compatibility)\r\n          const movieProviderMap: Record<string, { name: string; uuid: string; location: string; bond: number; reputation: number; apiEndpoint: string }> = {\r\n            'amc-001': {\r\n              name: 'AMC Theatres',\r\n              uuid: '550e8400-e29b-41d4-a716-446655440001',\r\n              location: 'Baltimore, Maryland',\r\n              bond: 1000,\r\n              reputation: 4.8,\r\n              apiEndpoint: 'https://api.amctheatres.com/v1/listings'\r\n            },\r\n            'cinemark-001': {\r\n              name: 'Cinemark',\r\n              uuid: '550e8400-e29b-41d4-a716-446655440003',\r\n              location: 'Baltimore, Maryland',\r\n              bond: 1200,\r\n              reputation: 4.7,\r\n              apiEndpoint: 'https://api.cinemark.com/movies'\r\n            },\r\n            'moviecom-001': {\r\n              name: 'MovieCom',\r\n              uuid: '550e8400-e29b-41d4-a716-446655440002',\r\n              location: 'Baltimore, Maryland',\r\n              bond: 800,\r\n              reputation: 4.5,\r\n              apiEndpoint: 'https://api.moviecom.com/showtimes'\r\n            }\r\n          };\r\n          \r\n          // Convert selectedProviders IDs to provider configs\r\n          for (const providerId of selectedProviders) {\r\n            const predefined = movieProviderMap[providerId];\r\n            if (predefined) {\r\n              providersToCreate.push({\r\n                id: providerId,\r\n                name: predefined.name,\r\n                location: predefined.location,\r\n                bond: predefined.bond,\r\n                reputation: predefined.reputation,\r\n                apiEndpoint: predefined.apiEndpoint,\r\n                uuid: predefined.uuid\r\n              });\r\n            } else {\r\n              console.warn(`   \u26A0\uFE0F  Provider ID ${providerId} not found in movie provider map. Skipping.`);\r\n            }\r\n          }\r\n        } else if (selectedProviders && Array.isArray(selectedProviders) && selectedProviders.length > 0 && serviceType !== \"movie\") {\r\n          // CRITICAL: If selectedProviders is provided for non-movie service types, log a warning and ignore it\r\n          console.warn(`   \u26A0\uFE0F  [CRITICAL] selectedProviders provided for non-movie service type \"${serviceType}\": [${selectedProviders.join(', ')}]`);\r\n          console.warn(`   \u26A0\uFE0F  [CRITICAL] Ignoring selectedProviders - they are only valid for movie service type`);\r\n          console.warn(`   \u26A0\uFE0F  [CRITICAL] Use 'providers' array instead for ${serviceType} service type`);\r\n        }\r\n        \r\n        // New format: Check for providers array in request\r\n        if (requestData.providers && Array.isArray(requestData.providers)) {\r\n          if (requestData.providers.length > 0) {\r\n            console.log(`   \uD83D\uDCCB Using new providers array format: ${requestData.providers.length} provider(s)`);\r\n            providersToCreate = requestData.providers;\r\n          } else {\r\n            console.log(`   \uD83D\uDCCB Empty providers array provided for ${serviceType} garden`);\r\n          }\r\n        }\r\n        \r\n        // Create providers if any are specified\r\n        if (providersToCreate.length > 0) {\r\n          console.log(`   \uD83D\uDD27 Creating ${providersToCreate.length} service provider(s) for ${serviceType} garden ${gardenConfig.id}...`);\r\n          console.log(`   \uD83D\uDD0D [DEBUG] providersToCreate:`, providersToCreate.map(p => ({ id: p.id, name: p.name })));\r\n          \r\n          // CRITICAL: Validate that all providers match the service type\r\n          // This prevents movie providers (amc-001, cinemark-001, moviecom-001) from being created for airline or other service types\r\n          const movieProviderIds = ['amc-001', 'cinemark-001', 'moviecom-001'];\r\n          const mismatchedProviders = providersToCreate.filter(p => {\r\n            return p.id && movieProviderIds.includes(p.id) && serviceType !== \"movie\";\r\n          });\r\n          \r\n          if (mismatchedProviders.length > 0) {\r\n            console.error(`   \u274C [CRITICAL] Provider type mismatch detected!`);\r\n            console.error(`   \u274C [CRITICAL] Service type: \"${serviceType}\", but movie providers found:`, mismatchedProviders.map(p => p.id).join(', '));\r\n            console.error(`   \u274C [CRITICAL] Removing mismatched providers to prevent incorrect provider creation`);\r\n            providersToCreate = providersToCreate.filter(p => {\r\n              return !(p.id && movieProviderIds.includes(p.id) && serviceType !== \"movie\");\r\n            });\r\n            console.log(`   \u2705 [CRITICAL] Filtered providers list (${providersToCreate.length} remaining):`, providersToCreate.map(p => ({ id: p.id, name: p.name })));\r\n            \r\n            // If all providers were filtered out, skip provider creation\r\n            if (providersToCreate.length === 0) {\r\n              console.warn(`   \u26A0\uFE0F  [CRITICAL] All providers were filtered out due to type mismatch. Skipping provider creation.`);\r\n              console.warn(`   \u26A0\uFE0F  [CRITICAL] Default provider will be created instead (if applicable).`);\r\n            }\r\n          }\r\n          \r\n          // Predefined provider map (only for movie, for backward compatibility)\r\n          const predefinedProviderMap = serviceType === \"movie\" ? {\r\n            'amc-001': {\r\n              name: 'AMC Theatres',\r\n              uuid: '550e8400-e29b-41d4-a716-446655440001',\r\n              location: 'Baltimore, Maryland',\r\n              bond: 1000,\r\n              reputation: 4.8,\r\n              apiEndpoint: 'https://api.amctheatres.com/v1/listings'\r\n            },\r\n            'cinemark-001': {\r\n              name: 'Cinemark',\r\n              uuid: '550e8400-e29b-41d4-a716-446655440003',\r\n              location: 'Baltimore, Maryland',\r\n              bond: 1200,\r\n              reputation: 4.7,\r\n              apiEndpoint: 'https://api.cinemark.com/movies'\r\n            },\r\n            'moviecom-001': {\r\n              name: 'MovieCom',\r\n              uuid: '550e8400-e29b-41d4-a716-446655440002',\r\n              location: 'Baltimore, Maryland',\r\n              bond: 800,\r\n              reputation: 4.5,\r\n              apiEndpoint: 'https://api.moviecom.com/showtimes'\r\n            }\r\n          } : undefined;\r\n          \r\n          try {\r\n            providerResults = createServiceProvidersForGarden(\r\n              serviceType,\r\n              gardenConfig.id,\r\n              providersToCreate,\r\n              predefinedProviderMap\r\n            );\r\n            \r\n            providersCreated = providerResults.filter(r => r.created || r.assigned).length;\r\n            console.log(`   \u2705 Successfully processed ${providersCreated} provider(s): ${providerResults.map(r => r.providerName).join(', ')}`);\r\n            \r\n            // CRITICAL: Ensure service registry is saved to persistence after provider creation\r\n            // (createServiceProvidersForGarden already saves, but double-check here)\r\n            try {\r\n              const serviceRegistry2 = getServiceRegistry2();\r\n              serviceRegistry2.savePersistence();\r\n              console.log(`   \uD83D\uDCBE Service registry saved to persistence after provider creation`);\r\n            } catch (saveErr: any) {\r\n              console.error(`   \u274C Failed to save service registry after provider creation:`, saveErr.message);\r\n            }\r\n          } catch (providerErr: any) {\r\n            console.error(`   \u274C Failed to create providers:`, providerErr.message);\r\n            // Don't fail the entire garden creation, just log the error\r\n            console.warn(`   \u26A0\uFE0F  Continuing with garden creation despite provider creation failure`);\r\n          }\r\n        } else {\r\n          console.log(`   \u2139\uFE0F  No providers specified for ${serviceType} garden. Skipping provider creation.`);\r\n          \r\n          // For non-movie, non-dex service types (like airline), create a default provider if none were specified\r\n          // This ensures the service type appears in the service registry\r\n          if (serviceType !== \"movie\" && serviceType !== \"dex\" && serviceType !== \"snake\") {\r\n            // Check if a provider already exists for this garden to prevent duplicates\r\n            const serviceRegistry2 = getServiceRegistry2();\r\n            const existingProvidersForGarden = serviceRegistry2.getAllProviders().filter(\r\n              p => p.gardenId === gardenConfig.id && p.serviceType === serviceType\r\n            );\r\n            \r\n            if (existingProvidersForGarden.length > 0) {\r\n              console.log(`   \u26A0\uFE0F  Garden ${gardenConfig.id} already has ${existingProvidersForGarden.length} provider(s) for ${serviceType}, skipping default provider creation`);\r\n            } else {\r\n              console.log(`   \uD83D\uDD27 Creating default provider for ${serviceType} garden ${gardenConfig.id}...`);\r\n              try {\r\n                const defaultProviderConfig = {\r\n                  name: `${gardenConfig.name} Provider`,\r\n                  location: 'Unknown',\r\n                  bond: 1000,\r\n                  reputation: 5.0,\r\n                  apiEndpoint: `https://api.${serviceType}.com/v1`\r\n                };\r\n                \r\n                providerResults = createServiceProvidersForGarden(\r\n                  serviceType,\r\n                  gardenConfig.id,\r\n                  [defaultProviderConfig],\r\n                  undefined\r\n                );\r\n                \r\n                providersCreated = providerResults.filter(r => r.created || r.assigned).length;\r\n                console.log(`   \u2705 Created default provider for ${serviceType} garden: ${providerResults.map(r => r.providerName).join(', ')}`);\r\n                \r\n                // CRITICAL: Ensure service registry is saved to persistence after default provider creation\r\n                try {\r\n                  serviceRegistry2.savePersistence();\r\n                  console.log(`   \uD83D\uDCBE Service registry saved to persistence after default provider creation`);\r\n                } catch (saveErr: any) {\r\n                  console.error(`   \u274C Failed to save service registry after default provider creation:`, saveErr.message);\r\n                }\r\n              } catch (defaultProviderErr: any) {\r\n                console.warn(`   \u26A0\uFE0F  Failed to create default provider for ${serviceType} garden:`, defaultProviderErr.message);\r\n              }\r\n            }\r\n          }\r\n        }\r\n        \r\n        // Create DEX service providers for token gardens\r\n        if (serviceType === \"dex\") {\r\n          console.log(`   \uD83D\uDCB0 Creating DEX pool service providers for token garden ${gardenConfig.id}...`);\r\n          \r\n          // Find the index of this token garden in TOKEN_GARDENS array\r\n          // CRITICAL: Token garden should already be in TOKEN_GARDENS array (added at line 2407)\r\n          const tokenGardenIndex = TOKEN_GARDENS.findIndex(ti => ti.id === gardenConfig.id);\r\n          if (tokenGardenIndex === -1) {\r\n            console.warn(`   \u26A0\uFE0F  Token garden ${gardenConfig.id} not found in TOKEN_GARDENS array`);\r\n            console.warn(`   \u26A0\uFE0F  Current TOKEN_GARDENS IDs: ${TOKEN_GARDENS.map(ti => ti.id).join(', ')}`);\r\n            console.warn(`   \u26A0\uFE0F  Skipping DEX pool and provider creation for ${gardenConfig.id}`);\r\n          } else {\r\n            // Create pool for this token garden (matching initializeDEXPools format)\r\n            // Use token pair from request or defaults\r\n            const tokenSymbol = finalTokenSymbol;\r\n            const tokenName = `${tokenSymbol} ${tokenGardenIndex + 1}`;\r\n            const poolId = `pool-${finalBaseToken.toLowerCase()}-${tokenSymbol.toLowerCase()}-${tokenGardenIndex + 1}`;\r\n            \r\n            // Check if pool already exists\r\n            if (DEX_POOLS.has(poolId)) {\r\n              console.log(`   \u26A0\uFE0F  Pool ${poolId} already exists, skipping pool creation...`);\r\n            } else {\r\n              // Create new pool for this token garden (matching initializeDEXPools structure)\r\n              const pool: TokenPool = {\r\n                poolId: poolId,\r\n                tokenSymbol: tokenSymbol,\r\n                tokenName: tokenName,\r\n                baseToken: finalBaseToken,\r\n                poolLiquidity: 100 - (tokenGardenIndex * 10), // Decreasing liquidity for variety: 100, 90, 80...\r\n                tokenReserve: 100000 - (tokenGardenIndex * 10000), // 100k, 90k, 80k...\r\n                baseReserve: 100 - (tokenGardenIndex * 10), // 100, 90, 80...\r\n                price: 0.001, // 1 Token = 0.001 SOL\r\n                bond: 5000,\r\n                gardenId: gardenConfig.id, // Assign to this token garden\r\n                createdAt: Date.now(),\r\n                totalVolume: 0,\r\n                totalTrades: 0,\r\n              };\r\n              \r\n              DEX_POOLS.set(poolId, pool);\r\n              console.log(`   \u2705 Created DEX pool: ${tokenSymbol} (${poolId}) \u2192 ${gardenConfig.id}`);\r\n            }\r\n            \r\n            // Create service provider for this pool\r\n            const providerId = `dex-pool-${tokenSymbol.toLowerCase()}`;\r\n            const serviceRegistry2 = getServiceRegistry2();\r\n            const existingProvider = serviceRegistry2.getProvider(providerId);\r\n            \r\n            if (existingProvider && existingProvider.gardenId === gardenConfig.id) {\r\n              console.log(`   \u26A0\uFE0F  Provider ${providerId} already exists for garden ${gardenConfig.id}, skipping...`);\r\n            } else {\r\n              const provider: ServiceProviderWithCert = {\r\n                id: providerId,\r\n                uuid: crypto.randomUUID(),\r\n                name: `${tokenSymbol} Pool (${gardenConfig.name})`,\r\n                serviceType: \"dex\",\r\n                location: \"Eden DEX\",\r\n                bond: 5000,\r\n                reputation: 5.0,\r\n                gardenId: gardenConfig.id, // Assign to this garden\r\n                apiEndpoint: `https://dex.eden.com/pools/${poolId}`,\r\n                status: 'active',\r\n              };\r\n              \r\n              // Add to ServiceRegistry2 (new implementation)\r\n              try {\r\n                serviceRegistry2.addProvider(provider);\r\n                // Also add to old ROOT_CA_SERVICE_REGISTRY for backward compatibility (will be removed later)\r\n                ROOT_CA_SERVICE_REGISTRY.push(provider);\r\n              } catch (err: any) {\r\n                console.error(`   \u274C Failed to add DEX provider to ServiceRegistry2: ${err.message}`);\r\n                throw err;\r\n              }\r\n              \r\n              // Issue certificate to provider\r\n              try {\r\n                issueServiceProviderCertificate(provider);\r\n                console.log(`   \uD83D\uDCDC Certificate issued to ${provider.name}`);\r\n              } catch (err: any) {\r\n                console.warn(`   \u26A0\uFE0F  Failed to issue certificate to ${provider.name}:`, err.message);\r\n              }\r\n              \r\n              providersCreated++;\r\n              console.log(`   \u2705 Registered DEX pool provider: ${provider.name} (${provider.id}) \u2192 ${gardenConfig.name}`);\r\n              \r\n              // Broadcast event for provider creation\r\n              broadcastEvent({\r\n                type: \"service_provider_created\",\r\n                component: \"root-ca\",\r\n                message: `DEX pool service provider ${provider.name} created and assigned to ${gardenConfig.name}`,\r\n                timestamp: Date.now(),\r\n                data: {\r\n                  providerId: provider.id,\r\n                  providerName: provider.name,\r\n                  gardenId: gardenConfig.id,\r\n                  gardenName: gardenConfig.name,\r\n                  poolId: poolId\r\n                }\r\n              });\r\n            }\r\n            \r\n            console.log(`   \u2705 Created DEX pool and service provider for token garden ${gardenConfig.id}`);\r\n          }\r\n        }\r\n        \r\n        // Persist indexers - save BOTH regular and token indexers together\r\n        // Filter out default indexers and save immediately\r\n        \r\n        // CRITICAL: First, check if any token indexers accidentally got into GARDENS\r\n        // If so, move them to TOKEN_GARDENS and log a warning\r\n        const tokenIndexersInRegularArray = GARDENS.filter(idx => \r\n          (idx as any).tokenServiceType === 'dex' || (idx.serviceType === 'dex' && idx.id && idx.id.startsWith('T'))\r\n        );\r\n        if (tokenIndexersInRegularArray.length > 0) {\r\n          console.warn(`\u26A0\uFE0F  [Indexer Persistence] Found ${tokenIndexersInRegularArray.length} token indexer(s) in GARDENS array! Moving them to TOKEN_GARDENS...`);\r\n          for (const tokenIdx of tokenIndexersInRegularArray) {\r\n            // Remove from GARDENS\r\n            const index = GARDENS.indexOf(tokenIdx);\r\n            if (index > -1) {\r\n              GARDENS.splice(index, 1);\r\n            }\r\n            // Add to TOKEN_GARDENS if not already there\r\n            if (!TOKEN_GARDENS.some(ti => ti.id === tokenIdx.id)) {\r\n              TOKEN_GARDENS.push(tokenIdx as any);\r\n            }\r\n          }\r\n        }\r\n        \r\n        // CRITICAL: First, deduplicate BOTH in-memory arrays to prevent saving duplicates\r\n        // This ensures we're working with clean data before saving\r\n        \r\n        // Deduplicate GARDENS array\r\n        const deduplicatedRegularIndexers = new Map<string, GardenConfig>();\r\n        for (const idx of GARDENS) {\r\n          const existing = deduplicatedRegularIndexers.get(idx.id);\r\n          if (!existing) {\r\n            deduplicatedRegularIndexers.set(idx.id, idx);\r\n          } else {\r\n            // Prefer the one with certificate\r\n            const hasCert = !!(idx as any).certificate;\r\n            const existingHasCert = !!(existing as any).certificate;\r\n            if (hasCert && !existingHasCert) {\r\n              deduplicatedRegularIndexers.set(idx.id, idx);\r\n              console.warn(`\u26A0\uFE0F  [Indexer Persistence] Found duplicate regular indexer ${idx.id} in GARDENS - keeping version with certificate`);\r\n            } else {\r\n              console.warn(`\u26A0\uFE0F  [Indexer Persistence] Found duplicate regular indexer ${idx.id} in GARDENS - keeping existing version`);\r\n            }\r\n          }\r\n        }\r\n        // Update GARDENS array to remove duplicates\r\n        const cleanRegularIndexers = Array.from(deduplicatedRegularIndexers.values());\r\n        console.log(`\uD83D\uDCCB [Indexer Persistence] After deduplication, GARDENS has ${cleanRegularIndexers.length} garden(s): ${cleanRegularIndexers.map(g => `${g.id}(${(g as any).serviceType || 'no-type'})`).join(', ')}`);\r\n        \r\n        // CRITICAL: Don't clear GARDENS array yet - we need it for the preservation logic\r\n        // We'll update it after we've built the final list to save\r\n        // GARDENS.length = 0;\r\n        // GARDENS.push(...cleanRegularIndexers);\r\n        \r\n        let regularIndexersToSave: GardenConfig[] = [];\r\n        let tokenIndexersToSave: GardenConfig[] = [];\r\n        \r\n        // Prepare regular indexers to save (from deduplicated array)\r\n        // CRITICAL: Exclude token indexers (they have tokenServiceType or serviceType === \"dex\" and ID starts with T)\r\n        if (NUM_GARDENS > 0) {\r\n          const defaultIds = Array.from({ length: NUM_GARDENS }, (_, i) => String.fromCharCode(65 + i));\r\n          regularIndexersToSave = cleanRegularIndexers.filter(idx => {\r\n            // Exclude token indexers (defensive check)\r\n            if ((idx as any).tokenServiceType === 'dex' || (idx.serviceType === 'dex' && idx.id && idx.id.startsWith('T'))) {\r\n              console.warn(`\u26A0\uFE0F  [Indexer Persistence] Token indexer ${idx.id} found in GARDENS during save - excluding from regular indexers`);\r\n              return false;\r\n            }\r\n            const isDefault = defaultIds.includes(idx.id);\r\n            if (isDefault) {\r\n              console.log(`\uD83D\uDCCB [Indexer Persistence] Excluding default garden ${idx.id} from save`);\r\n            }\r\n            return !isDefault;\r\n          });\r\n          console.log(`\uD83D\uDCCB [Indexer Persistence] After filtering defaults, ${regularIndexersToSave.length} regular garden(s) to save: ${regularIndexersToSave.map(g => `${g.id}(${(g as any).serviceType || 'no-type'})`).join(', ')}`);\r\n        } else {\r\n          // ROOT mode: ONLY save indexers created via Angular (format: garden-1, garden-2, etc. or indexer-1, indexer-2, etc.)\r\n          regularIndexersToSave = cleanRegularIndexers.filter(idx => {\r\n            // Exclude token indexers (defensive check)\r\n            if ((idx as any).tokenServiceType === 'dex' || (idx.serviceType === 'dex' && idx.id && idx.id.startsWith('T'))) {\r\n              console.warn(`\u26A0\uFE0F  [Indexer Persistence] Token indexer ${idx.id} found in GARDENS during save - excluding from regular indexers`);\r\n              return false;\r\n            }\r\n            // Only save indexers with format \"garden-N\" or \"indexer-N\" (created via Angular)\r\n            // Support both formats for backward compatibility\r\n            const matchesFormat = idx.id.startsWith('garden-') || idx.id.startsWith('indexer-');\r\n            if (!matchesFormat) {\r\n              console.log(`\uD83D\uDCCB [Indexer Persistence] Excluding garden ${idx.id} - doesn't match garden-N or indexer-N format`);\r\n            }\r\n            return matchesFormat;\r\n          });\r\n          console.log(`\uD83D\uDCCB [Indexer Persistence] After filtering format, ${regularIndexersToSave.length} regular garden(s) to save: ${regularIndexersToSave.map(g => `${g.id}(${(g as any).serviceType || 'no-type'})`).join(', ')}`);\r\n        }\r\n        \r\n        // CRITICAL: Deduplicate TOKEN_GARDENS array BEFORE collecting tokenIndexersToSave\r\n        // This prevents duplicates from being saved if TOKEN_GARDENS has duplicates\r\n        // CRITICAL: Always deduplicate in-memory arrays FIRST to prevent saving duplicates\r\n        const deduplicatedTokenIndexers = new Map<string, TokenGardenConfig>();\r\n        for (const ti of TOKEN_GARDENS) {\r\n          const existing = deduplicatedTokenIndexers.get(ti.id);\r\n          if (!existing) {\r\n            deduplicatedTokenIndexers.set(ti.id, ti);\r\n          } else {\r\n            // Prefer the one with certificate, or the newer one (by UUID timestamp if available)\r\n            const hasCert = !!(ti as any).certificate;\r\n            const existingHasCert = !!(existing as any).certificate;\r\n            if (hasCert && !existingHasCert) {\r\n              deduplicatedTokenIndexers.set(ti.id, ti);\r\n              console.warn(`\u26A0\uFE0F  [Indexer Persistence] Found duplicate token indexer ${ti.id} in TOKEN_GARDENS - keeping version with certificate`);\r\n            } else if (!hasCert && existingHasCert) {\r\n              // Keep existing version with certificate\r\n              console.warn(`\u26A0\uFE0F  [Indexer Persistence] Found duplicate token indexer ${ti.id} in TOKEN_GARDENS - keeping existing version with certificate`);\r\n            } else {\r\n              // Both have or don't have cert - prefer current one (assumed newer)\r\n              deduplicatedTokenIndexers.set(ti.id, ti);\r\n              console.warn(`\u26A0\uFE0F  [Indexer Persistence] Found duplicate token indexer ${ti.id} in TOKEN_GARDENS - keeping current version`);\r\n            }\r\n          }\r\n        }\r\n        const cleanTokenIndexers = Array.from(deduplicatedTokenIndexers.values());\r\n        \r\n        // CRITICAL: Always update TOKEN_GARDENS array to remove duplicates, even if count is same\r\n        // This ensures the in-memory array is clean before we save\r\n          TOKEN_GARDENS.length = 0;\r\n          TOKEN_GARDENS.push(...cleanTokenIndexers);\r\n        \r\n        if (cleanTokenIndexers.length !== TOKEN_GARDENS.length) {\r\n          // This should never happen now, but log if it does\r\n          console.error(`\u274C [Indexer Persistence] CRITICAL: TOKEN_GARDENS length mismatch after deduplication!`);\r\n        }\r\n        \r\n        // Prepare token indexers to save (from deduplicated array)\r\n        console.log(`\uD83D\uDD0D [Indexer Persistence] TOKEN_GARDENS array has ${cleanTokenIndexers.length} indexer(s) after deduplication: ${cleanTokenIndexers.map(ti => ti.id).join(', ')}`);\r\n        console.log(`\uD83D\uDD0D [Indexer Persistence] NUM_TOKEN_GARDENS = ${NUM_TOKEN_GARDENS}, DEPLOYED_AS_ROOT = ${DEPLOYED_AS_ROOT}`);\r\n        \r\n        if (NUM_TOKEN_GARDENS > 0) {\r\n          const defaultTokenIds = Array.from({ length: NUM_TOKEN_GARDENS }, (_, i) => `T${i + 1}`);\r\n          console.log(`\uD83D\uDD0D [Indexer Persistence] Filtering out default token IDs: ${defaultTokenIds.join(', ')}`);\r\n          tokenIndexersToSave = cleanTokenIndexers.filter(idx => !defaultTokenIds.includes(idx.id));\r\n        } else {\r\n          // ROOT mode: save all token indexers (no defaults)\r\n          // CRITICAL: In ROOT mode, we should only have token indexers created via Angular\r\n          tokenIndexersToSave = cleanTokenIndexers;\r\n          console.log(`\uD83D\uDD0D [Indexer Persistence] ROOT mode: saving all ${cleanTokenIndexers.length} token indexer(s) after deduplication`);\r\n        }\r\n        \r\n        console.log(`\uD83D\uDCCB [Indexer Persistence] Preparing to save: ${regularIndexersToSave.length} regular indexer(s), ${tokenIndexersToSave.length} token indexer(s)`);\r\n        if (tokenIndexersToSave.length > 0) {\r\n          console.log(`\uD83D\uDCCB [Indexer Persistence] Token indexers to save: ${tokenIndexersToSave.map(ti => `${ti.name} (${ti.id})`).join(', ')}`);\r\n        }\r\n        \r\n        // Remove duplicates by ID - always keep the latest version (prefer one with certificate)\r\n        const uniqueRegularIndexers = new Map<string, GardenConfig>();\r\n        for (const idx of regularIndexersToSave) {\r\n          const existing = uniqueRegularIndexers.get(idx.id);\r\n          if (!existing) {\r\n            uniqueRegularIndexers.set(idx.id, idx);\r\n          } else {\r\n            // Prefer the version with certificate, or the newer one\r\n            const hasCert = !!(idx as any).certificate;\r\n            const existingHasCert = !!(existing as any).certificate;\r\n            if (hasCert && !existingHasCert) {\r\n              uniqueRegularIndexers.set(idx.id, idx);\r\n            } else if (!hasCert && existingHasCert) {\r\n              // Keep existing version with certificate\r\n            } else {\r\n              uniqueRegularIndexers.set(idx.id, idx);\r\n            }\r\n          }\r\n        }\r\n        regularIndexersToSave = Array.from(uniqueRegularIndexers.values());\r\n        \r\n        // Remove duplicates for token indexers (by ID)\r\n        const uniqueTokenIndexers = new Map<string, GardenConfig>();\r\n        for (const idx of tokenIndexersToSave) {\r\n          const existing = uniqueTokenIndexers.get(idx.id);\r\n          if (!existing) {\r\n            uniqueTokenIndexers.set(idx.id, idx);\r\n          } else {\r\n            // If duplicate found, prefer the one with certificate\r\n            const hasCert = !!(idx as any).certificate;\r\n            const existingHasCert = !!(existing as any).certificate;\r\n            if (hasCert && !existingHasCert) {\r\n              uniqueTokenIndexers.set(idx.id, idx);\r\n            } else if (!hasCert && existingHasCert) {\r\n              // Keep existing version with certificate\r\n            } else {\r\n              // Both have or don't have cert - prefer current one (from TOKEN_GARDENS)\r\n              uniqueTokenIndexers.set(idx.id, idx);\r\n            }\r\n          }\r\n        }\r\n        tokenIndexersToSave = Array.from(uniqueTokenIndexers.values());\r\n        \r\n        // Force immediate save (bypass debounce)\r\n        try {\r\n          const persistenceFile = path.join(__dirname, 'eden-wallet-persistence.json');\r\n          let existing: any = {\r\n            walletBalances: {},\r\n            ledgerEntries: [],\r\n            gardens: [],\r\n            serviceRegistry: [],\r\n            lastSaved: new Date().toISOString()\r\n          };\r\n          \r\n          if (fs.existsSync(persistenceFile)) {\r\n            try {\r\n              const fileContent = fs.readFileSync(persistenceFile, 'utf-8');\r\n              existing = JSON.parse(fileContent);\r\n              // Backward compatibility: Migrate from old fields to 'gardens'\r\n              if (!existing.gardens || !Array.isArray(existing.gardens)) {\r\n                existing.gardens = [];\r\n              }\r\n              // Migrate from 'indexers' if it exists\r\n              if (existing.indexers && Array.isArray(existing.indexers)) {\r\n                console.log(`\uD83D\uDCCB [Indexer Persistence] Found 'indexers' field - migrating to 'gardens' array`);\r\n                const existingGardenIds = new Set(existing.gardens.map((idx: any) => idx.id));\r\n                for (const idx of existing.indexers) {\r\n                  if (!existingGardenIds.has(idx.id)) {\r\n                    existing.gardens.push(idx);\r\n                  }\r\n                }\r\n                delete existing.indexers; // Remove old field\r\n              }\r\n              // Migrate from 'tokenIndexers' if it exists\r\n              if (existing.tokenIndexers && Array.isArray(existing.tokenIndexers)) {\r\n                console.log(`\uD83D\uDCCB [Indexer Persistence] Found 'tokenIndexers' field - migrating to 'gardens' array`);\r\n                const existingGardenIds = new Set(existing.gardens.map((idx: any) => idx.id));\r\n                for (const tokenIdx of existing.tokenIndexers) {\r\n                  if (!existingGardenIds.has(tokenIdx.id)) {\r\n                    existing.gardens.push(tokenIdx);\r\n                  }\r\n                }\r\n                delete existing.tokenIndexers; // Remove old field\r\n              }\r\n            } catch (err: any) {\r\n              console.warn(`\u26A0\uFE0F  [Indexer Persistence] Failed to load existing file: ${err.message}`);\r\n            }\r\n          }\r\n          \r\n          // CRITICAL: In-memory arrays (GARDENS and TOKEN_GARDENS) are the SINGLE SOURCE OF TRUTH\r\n          // We MUST NOT read or merge gardens from the file - that would reintroduce duplicates\r\n          // We ONLY use the deduplicated in-memory arrays that were already cleaned above\r\n          \r\n          // Build final gardens array from ONLY the deduplicated in-memory arrays\r\n          const allIndexersToSave: any[] = [];\r\n          \r\n          // Add regular indexers (already deduplicated above)\r\n          for (const regIdx of regularIndexersToSave) {\r\n            // Verify certificate before saving\r\n            if (!regIdx.certificate) {\r\n              console.error(`\u274C [Indexer Persistence] Regular indexer ${regIdx.id} is missing certificate! Re-issuing...`);\r\n              try {\r\n                issueGardenCertificate(regIdx);\r\n                console.log(`\u2705 [Indexer Persistence] Certificate re-issued for ${regIdx.id}`);\r\n              } catch (err: any) {\r\n                console.error(`\u274C [Indexer Persistence] Failed to re-issue certificate for ${regIdx.id}:`, err.message);\r\n              }\r\n            }\r\n            allIndexersToSave.push(regIdx);\r\n          }\r\n          \r\n          // Add token indexers (already deduplicated above)\r\n          for (const tokenIdx of tokenIndexersToSave) {\r\n            // Verify certificate before saving\r\n            if (!tokenIdx.certificate) {\r\n              console.error(`\u274C [Indexer Persistence] Token indexer ${tokenIdx.id} is missing certificate! Re-issuing...`);\r\n              try {\r\n                issueGardenCertificate(tokenIdx);\r\n                console.log(`\u2705 [Indexer Persistence] Certificate re-issued for ${tokenIdx.id}`);\r\n              } catch (err: any) {\r\n                console.error(`\u274C [Indexer Persistence] Failed to re-issue certificate for ${tokenIdx.id}:`, err.message);\r\n              }\r\n            }\r\n            allIndexersToSave.push(tokenIdx);\r\n          }\r\n          \r\n          // CRITICAL: Final deduplication pass by ID as absolute safety net\r\n          // This should not be necessary since arrays are already deduplicated, but it's a safety check\r\n          const finalDeduplicatedMap = new Map<string, any>();\r\n          for (const idx of allIndexersToSave) {\r\n            const existing = finalDeduplicatedMap.get(idx.id);\r\n            if (!existing) {\r\n              finalDeduplicatedMap.set(idx.id, idx);\r\n            } else {\r\n              // Prefer the one with certificate\r\n              const hasCert = !!(idx as any).certificate;\r\n              const existingHasCert = !!(existing as any).certificate;\r\n              if (hasCert && !existingHasCert) {\r\n                finalDeduplicatedMap.set(idx.id, idx);\r\n                console.warn(`\u26A0\uFE0F  [Indexer Persistence] Final safety check: Found duplicate ${idx.id} - keeping version with certificate`);\r\n              } else {\r\n                console.warn(`\u26A0\uFE0F  [Indexer Persistence] Final safety check: Found duplicate ${idx.id} - keeping existing version`);\r\n              }\r\n            }\r\n          }\r\n          \r\n          const finalIndexersToSave = Array.from(finalDeduplicatedMap.values());\r\n          const duplicatesRemoved = allIndexersToSave.length - finalIndexersToSave.length;\r\n          if (duplicatesRemoved > 0) {\r\n            console.warn(`\u26A0\uFE0F  [Indexer Persistence] Removed ${duplicatesRemoved} duplicate indexer(s) in final safety check`);\r\n          }\r\n          \r\n          console.log(`\uD83D\uDCCB [Indexer Persistence] Saving ${regularIndexersToSave.length} regular indexer(s) and ${tokenIndexersToSave.length} token indexer(s) to 'gardens' array`);\r\n          console.log(`\uD83D\uDCCB [Indexer Persistence] Final deduplicated count: ${finalIndexersToSave.length} indexer(s)`);\r\n          console.log(`\uD83D\uDCCB [Indexer Persistence] Final indexer IDs: ${finalIndexersToSave.map(i => i.id).join(', ')}`);\r\n          \r\n          // CRITICAL: Final verification before saving\r\n          console.log(`\uD83D\uDD0D [Indexer Persistence] Final check before save:`);\r\n          console.log(`   - Regular indexers: ${regularIndexersToSave.length}`);\r\n          console.log(`   - Token indexers: ${tokenIndexersToSave.length}`);\r\n          console.log(`   - Total indexers to save: ${finalIndexersToSave.length}`);\r\n          \r\n          // Verify certificates are present before saving\r\n          const indexersWithoutCert = finalIndexersToSave.filter(idx => !idx.certificate);\r\n          if (indexersWithoutCert.length > 0) {\r\n            console.error(`\u274C [Indexer Persistence] ${indexersWithoutCert.length} indexer(s) missing certificates: ${indexersWithoutCert.map(i => i.id).join(', ')}`);\r\n            console.error(`\u274C [Indexer Persistence] Re-issuing certificates before save...`);\r\n            for (const idx of indexersWithoutCert) {\r\n              try {\r\n                issueGardenCertificate(idx);\r\n                console.log(`\u2705 [Indexer Persistence] Certificate issued to ${idx.id}`);\r\n              } catch (err: any) {\r\n                console.error(`\u274C [Indexer Persistence] Failed to issue certificate to ${idx.id}:`, err.message);\r\n              }\r\n            }\r\n            // Update finalIndexersToSave with re-issued certificates\r\n            for (const idx of finalIndexersToSave) {\r\n              const withoutCert = indexersWithoutCert.find(w => w.id === idx.id);\r\n              if (withoutCert && withoutCert.certificate) {\r\n                idx.certificate = withoutCert.certificate;\r\n              }\r\n            }\r\n          }\r\n          \r\n          // REFACTOR: Save gardens to separate file\r\n          const gardensFile = path.join(__dirname, 'eden-gardens-persistence.json');\r\n          \r\n          // CRITICAL: Load existing gardens from file to preserve any that aren't in memory\r\n          // This prevents losing gardens that exist in the file but aren't currently in memory\r\n          let existingGardensFromFile: any[] = [];\r\n          if (fs.existsSync(gardensFile)) {\r\n            try {\r\n              const fileContent = fs.readFileSync(gardensFile, 'utf-8');\r\n              const persisted = JSON.parse(fileContent);\r\n              existingGardensFromFile = persisted.gardens || [];\r\n              console.log(`\uD83D\uDCCB [Indexer Persistence] Loaded ${existingGardensFromFile.length} existing garden(s) from file to preserve`);\r\n              console.log(`\uD83D\uDCCB [Indexer Persistence] Gardens in file: ${existingGardensFromFile.map((g: any) => `${g.id}(${g.serviceType || 'no-type'})`).join(', ')}`);\r\n            } catch (err: any) {\r\n              console.warn(`\u26A0\uFE0F  [Indexer Persistence] Failed to load existing gardens from file: ${err.message}`);\r\n            }\r\n          }\r\n          \r\n          // Log what's in memory before merging\r\n          console.log(`\uD83D\uDCCB [Indexer Persistence] Gardens in memory (finalIndexersToSave): ${finalIndexersToSave.map((g: any) => `${g.id}(${g.serviceType || 'no-type'})`).join(', ')}`);\r\n          \r\n          // Merge existing gardens from file with in-memory gardens\r\n          // Prefer in-memory versions (they're the source of truth), but keep file gardens that aren't in memory\r\n          const existingGardenIds = new Set(finalIndexersToSave.map(g => g.id));\r\n          const preservedGardens = existingGardensFromFile.filter((g: any) => {\r\n            const shouldPreserve = !existingGardenIds.has(g.id);\r\n            if (!shouldPreserve) {\r\n              console.log(`\uD83D\uDCCB [Indexer Persistence] Garden ${g.id}(${g.serviceType || 'no-type'}) is in memory, using in-memory version`);\r\n            }\r\n            return shouldPreserve;\r\n          });\r\n          \r\n          if (preservedGardens.length > 0) {\r\n            console.log(`\uD83D\uDCCB [Indexer Persistence] \u2705 Preserving ${preservedGardens.length} garden(s) from file that aren't in memory: ${preservedGardens.map((g: any) => `${g.id}(${g.serviceType || 'no-type'})`).join(', ')}`);\r\n          } else if (existingGardensFromFile.length > 0) {\r\n            console.log(`\uD83D\uDCCB [Indexer Persistence] \u2139\uFE0F  All ${existingGardensFromFile.length} garden(s) from file are already in memory, no preservation needed`);\r\n          }\r\n          \r\n          // Combine in-memory gardens (source of truth) with preserved gardens from file\r\n          const allGardensToSave = [...finalIndexersToSave, ...preservedGardens];\r\n          \r\n          // Final safety check: log all gardens being saved\r\n          console.log(`\uD83D\uDCCB [Indexer Persistence] \uD83D\uDCBE Saving ${allGardensToSave.length} total garden(s): ${allGardensToSave.map((g: any) => `${g.id}(${g.serviceType || 'no-type'})`).join(', ')}`);\r\n          \r\n          const gardensData = {\r\n            gardens: allGardensToSave,\r\n            lastSaved: new Date().toISOString()\r\n          };\r\n          fs.writeFileSync(gardensFile, JSON.stringify(gardensData, null, 2), 'utf-8');\r\n          console.log(`\uD83D\uDCBE [Indexer Persistence] \u2705 IMMEDIATELY saved ${allGardensToSave.length} total garden(s) (${finalIndexersToSave.length} from memory + ${preservedGardens.length} preserved from file) to ${gardensFile}`);\r\n          if (regularIndexersToSave.length > 0) {\r\n            console.log(`\uD83D\uDCBE [Indexer Persistence] Saved regular gardens: ${regularIndexersToSave.map(i => `${i.name} (${i.id})`).join(', ')}`);\r\n          }\r\n          if (tokenIndexersToSave.length > 0) {\r\n            console.log(`\uD83D\uDCBE [Indexer Persistence] Saved token gardens: ${tokenIndexersToSave.map(i => `${i.name} (${i.id})${i.certificate ? ' \u2713cert' : ' \u274Cno cert'}`).join(', ')}`);\r\n          }\r\n          \r\n          // CRITICAL: Now update the in-memory GARDENS array to match what we saved\r\n          // This ensures consistency between memory and file, including preserved gardens\r\n          GARDENS.length = 0;\r\n          const savedRegularGardens = allGardensToSave.filter((g: any) => {\r\n            const isToken = (g.tokenServiceType === 'dex' || (g.serviceType === 'dex' && g.id && g.id.startsWith('T')));\r\n            return !isToken;\r\n          });\r\n          GARDENS.push(...savedRegularGardens);\r\n          console.log(`\uD83D\uDCCB [Indexer Persistence] Updated in-memory GARDENS array to ${GARDENS.length} garden(s) to match saved file: ${GARDENS.map(g => `${g.id}(${(g as any).serviceType || 'no-type'})`).join(', ')}`);\r\n          \r\n          // Save ServiceRegistry2 to persistence file\r\n          // CRITICAL: Use ServiceRegistry2 (new implementation) - it handles persistence correctly\r\n          const serviceRegistry2 = getServiceRegistry2();\r\n          const allProviders = serviceRegistry2.getAllProviders();\r\n          \r\n          // Console output: Show in-memory service registry\r\n          console.log(`\uD83D\uDCCB [ServiceRegistry2] Saving ALL ${allProviders.length} providers (NO FILTERING)`);\r\n          console.log(`\uD83D\uDCCB [ServiceRegistry2] All providers:`, allProviders.map(p => ({\r\n            id: p.id,\r\n            name: p.name,\r\n            serviceType: p.serviceType,\r\n            gardenId: p.gardenId || 'MISSING'\r\n          })));\r\n          console.log(`\uD83D\uDCCB [ServiceRegistry2] Movie providers:`, allProviders.filter(p => p.serviceType === 'movie').map(p => ({\r\n            id: p.id,\r\n            name: p.name,\r\n            gardenId: p.gardenId || 'MISSING'\r\n          })));\r\n          \r\n          // Log service registry save\r\n          const saveLogData = {\r\n            totalInMemory: allProviders.length,\r\n            totalSaved: allProviders.length,\r\n            movieProviders: allProviders.filter(p => p.serviceType === 'movie').length,\r\n            dexProviders: allProviders.filter(p => p.serviceType === 'dex').length,\r\n            movieProviderIds: allProviders.filter(p => p.serviceType === 'movie').map(p => `${p.id}(${p.gardenId})`),\r\n            allProviderIds: allProviders.map(p => `${p.id}(${p.gardenId})`)\r\n          };\r\n          console.log(`\uD83D\uDCDD [Garden Lifecycle] \uD83D\uDCBE ServiceRegistry2 save:`, JSON.stringify(saveLogData, null, 2));\r\n          getLogger().log('garden-lifecycle', 'service-registry-save', saveLogData);\r\n          \r\n          // Save using ServiceRegistry2's savePersistence method\r\n          serviceRegistry2.savePersistence();\r\n          console.log(`\uD83D\uDCBE [Indexer Persistence] \u2705 IMMEDIATELY saved ${allProviders.length} service provider(s) via ServiceRegistry2`);\r\n          \r\n          // CRITICAL: Final check - verify garden has providers after all creation logic\r\n          // If not, create a default provider (especially for airline and other service types)\r\n          if ((gardenConfig as any).serviceType && \r\n              (gardenConfig as any).serviceType !== \"movie\" && \r\n              (gardenConfig as any).serviceType !== \"dex\" && \r\n              (gardenConfig as any).serviceType !== \"snake\") {\r\n            const finalProvidersForGarden = serviceRegistry2.queryProviders((gardenConfig as any).serviceType, {});\r\n            const finalHasProviderForThisGarden = finalProvidersForGarden.some(p => p.gardenId === gardenConfig.id);\r\n            \r\n            if (!finalHasProviderForThisGarden) {\r\n              console.log(`   \uD83D\uDD27 [Final Check] Garden ${gardenConfig.id} still has no providers, creating default provider...`);\r\n              try {\r\n                const defaultProviderConfig = {\r\n                  name: `${gardenConfig.name} Provider`,\r\n                  location: 'Unknown',\r\n                  bond: 1000,\r\n                  reputation: 5.0,\r\n                  apiEndpoint: `https://api.${(gardenConfig as any).serviceType}.com/v1`\r\n                };\r\n                \r\n                const finalProviderResults = createServiceProvidersForGarden(\r\n                  (gardenConfig as any).serviceType,\r\n                  gardenConfig.id,\r\n                  [defaultProviderConfig],\r\n                  undefined\r\n                );\r\n                \r\n                const finalProvidersCreated = finalProviderResults.filter(r => r.created || r.assigned).length;\r\n                console.log(`   \u2705 [Final Check] Created default provider for ${(gardenConfig as any).serviceType} garden: ${finalProviderResults.map(r => r.providerName).join(', ')}`);\r\n                \r\n                // CRITICAL: Save service registry to persistence\r\n                serviceRegistry2.savePersistence();\r\n                console.log(`   \uD83D\uDCBE [Final Check] Service registry saved to persistence`);\r\n              } catch (finalErr: any) {\r\n                console.warn(`   \u26A0\uFE0F  [Final Check] Failed to create default provider:`, finalErr.message);\r\n              }\r\n            }\r\n          }\r\n        } catch (err: any) {\r\n          console.error(`\u274C [Indexer Persistence] Failed to save immediately: ${err.message}`);\r\n        }\r\n        \r\n        // NOTE: We do NOT call redis.saveIndexers here because:\r\n        // 1. We've already done an immediate save above (lines 2387-2518)\r\n        // 2. redis.saveIndexers only saves to 'indexers' field, not 'tokenIndexers'\r\n        // 3. redis.saveIndexers merges with existing data, which could reintroduce duplicates\r\n        // The immediate save above is the source of truth and handles both regular and token indexers correctly\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ \r\n          success: true, \r\n          garden: {\r\n            id: gardenConfig.id,\r\n            name: gardenConfig.name,\r\n            uuid: gardenConfig.uuid,\r\n            port: (gardenConfig as any).serverPort,\r\n            hasCertificate: !!gardenConfig.certificate,\r\n            ownerEmail: gardenConfig.ownerEmail // Include owner email for lifecycle management\r\n          },\r\n          balance: debitResult.balance, // Return updated balance\r\n          createdBy: email, // Return the Google user email (same as ownerEmail)\r\n          ownerEmail: gardenConfig.ownerEmail, // Explicit owner email field\r\n          providersCreated: providersCreated // Return number of providers created\r\n        }));\r\n      } catch (err: any) {\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // ============================================\r\n  // PRIESTHOOD CERTIFICATION API\r\n  // ============================================\r\n  \r\n  // POST /api/priesthood/apply - User applies for priesthood (with 10 JSC application fee)\r\n  if (pathname === \"/api/priesthood/apply\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDCDC [${requestId}] POST /api/priesthood/apply - Applying for priesthood`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const { email, reason } = JSON.parse(body);\r\n        if (!email) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"email required\" }));\r\n          return;\r\n        }\r\n        \r\n        // Charge 1 JSC application fee (Covenant Token / Witness Apple - non-refundable)\r\n        const APPLICATION_FEE = 1;\r\n        const userBalance = getWalletBalance(email);\r\n        if (userBalance < APPLICATION_FEE) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ \r\n            success: false, \r\n            error: `Insufficient balance. Application fee is ${APPLICATION_FEE} \uD83C\uDF4E APPLES. Your balance: ${userBalance} \uD83C\uDF4E APPLES` \r\n          }));\r\n          return;\r\n        }\r\n        \r\n        // Create transaction snapshot for application fee\r\n        const feeTxId = `priesthood_app_fee_${Date.now()}_${crypto.randomBytes(8).toString('hex')}`;\r\n        const snapshot: TransactionSnapshot = {\r\n          chainId: 'eden:mainnet',\r\n          txId: feeTxId,\r\n          slot: Date.now(),\r\n          blockTime: Date.now(),\r\n          payer: email,\r\n          merchant: 'Eden Treasury',\r\n          amount: APPLICATION_FEE,\r\n          feeSplit: {}\r\n        };\r\n        \r\n        // Create ledger entry (status will be 'pending')\r\n        const ledgerEntry = addLedgerEntry(\r\n          snapshot,\r\n          'priesthood',\r\n          0, // iGasCost\r\n          email, // payerId\r\n          'Eden Treasury', // merchantName\r\n          'eden:root:ca:priesthood', // providerUuid\r\n          {\r\n            type: 'application_fee',\r\n            description: 'Priesthood Application Fee (Non-refundable)',\r\n            price: APPLICATION_FEE\r\n          }\r\n        );\r\n        \r\n        // Get user for cashier processing\r\n        const user = USERS_STATE.find(u => u.email === email) || {\r\n          id: email,\r\n          email: email,\r\n          balance: getWalletBalance(email)\r\n        };\r\n        \r\n        // Process payment through cashier\r\n        const cashier = getCashierStatus();\r\n        const paymentSuccess = await processPayment(cashier, ledgerEntry, user);\r\n        \r\n        if (!paymentSuccess) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ \r\n            success: false, \r\n            error: `Payment processing failed. Please check your balance.` \r\n          }));\r\n          return;\r\n        }\r\n        \r\n        // Complete the booking\r\n        completeBooking(ledgerEntry);\r\n        \r\n        // Push to settlement stream\r\n        await pushLedgerEntryToSettlementStream(ledgerEntry);\r\n        \r\n        // Create application\r\n        const certification = applyForPriesthood(email, reason);\r\n        \r\n        // Mark application fee as paid using updateCertificationBilling\r\n        const { updateCertificationBilling, getCertificationStatus } = await import('./src/priesthoodCertification');\r\n        updateCertificationBilling(email, {\r\n          applicationFeePaid: true,\r\n          applicationFeeTxId: feeTxId\r\n        });\r\n        \r\n        // Get updated certification with billing info\r\n        const updatedCertification = getCertificationStatus(email);\r\n        \r\n        // Broadcast event\r\n        broadcastEvent({\r\n          type: \"priesthood_application_submitted\",\r\n          component: \"priesthood-certification\",\r\n          message: `New priesthood application from ${email} (Application fee: ${APPLICATION_FEE} \uD83C\uDF4E APPLES paid)`,\r\n          timestamp: Date.now(),\r\n          data: {\r\n            email,\r\n            status: updatedCertification?.status || certification.status,\r\n            appliedAt: updatedCertification?.appliedAt || certification.appliedAt,\r\n            applicationFeePaid: true,\r\n            applicationFeeTxId: feeTxId\r\n          }\r\n        });\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          certification: updatedCertification || certification,\r\n          applicationFeePaid: true,\r\n          applicationFee: APPLICATION_FEE\r\n        }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C [${requestId}] Error applying for priesthood:`, err.message);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n  \r\n  // GET /api/priesthood/status?email={email} - Get user's certification status\r\n  if (pathname === \"/api/priesthood/status\" && req.method === \"GET\") {\r\n    console.log(`   \uD83D\uDCDC [${requestId}] GET /api/priesthood/status - Getting certification status`);\r\n    try {\r\n      const parsedUrl = url.parse(req.url || \"/\", true);\r\n      const email = parsedUrl.query.email as string;\r\n      \r\n      if (!email) {\r\n        res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: \"email query parameter required\" }));\r\n        return;\r\n      }\r\n      \r\n      const certification = getCertificationStatus(email);\r\n      const hasCert = hasPriesthoodCertification(email);\r\n      \r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        certification,\r\n        hasCertification: hasCert\r\n      }));\r\n    } catch (err: any) {\r\n      console.error(`   \u274C [${requestId}] Error getting certification status:`, err.message);\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: err.message }));\r\n    }\r\n    return;\r\n  }\r\n  \r\n  // GET /api/priesthood/applications - GOD: Get all applications\r\n  if (pathname === \"/api/priesthood/applications\" && req.method === \"GET\") {\r\n    console.log(`   \uD83D\uDCDC [${requestId}] GET /api/priesthood/applications - Getting all applications (GOD mode)`);\r\n    try {\r\n      const parsedUrl = url.parse(req.url || \"/\", true);\r\n      const status = parsedUrl.query.status as string | undefined;\r\n      \r\n      let certifications: PriesthoodCertification[];\r\n      if (status) {\r\n        certifications = getCertificationsByStatus(status as any);\r\n      } else {\r\n        certifications = getAllCertifications();\r\n      }\r\n      \r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        certifications,\r\n        count: certifications.length\r\n      }));\r\n    } catch (err: any) {\r\n      console.error(`   \u274C [${requestId}] Error getting applications:`, err.message);\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: err.message }));\r\n    }\r\n    return;\r\n  }\r\n  \r\n  // POST /api/priesthood/approve - GOD: Approve application\r\n  if (pathname === \"/api/priesthood/approve\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDCDC [${requestId}] POST /api/priesthood/approve - Approving priesthood application`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const { email, approvedBy, reason } = JSON.parse(body);\r\n        if (!email || !approvedBy) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"email and approvedBy required\" }));\r\n          return;\r\n        }\r\n        \r\n        const certification = approvePriesthood(email, approvedBy, reason);\r\n        \r\n        // Broadcast event\r\n        broadcastEvent({\r\n          type: \"priesthood_application_approved\",\r\n          component: \"priesthood-certification\",\r\n          message: `Priesthood application approved for ${email}`,\r\n          timestamp: Date.now(),\r\n          data: {\r\n            email,\r\n            approvedBy,\r\n            approvedAt: certification.approvedAt\r\n          }\r\n        });\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          certification\r\n        }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C [${requestId}] Error approving application:`, err.message);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n  \r\n  // POST /api/priesthood/reject - GOD: Reject application\r\n  if (pathname === \"/api/priesthood/reject\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDCDC [${requestId}] POST /api/priesthood/reject - Rejecting priesthood application`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const { email, rejectedBy, reason } = JSON.parse(body);\r\n        if (!email || !rejectedBy) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"email and rejectedBy required\" }));\r\n          return;\r\n        }\r\n        \r\n        const certification = rejectPriesthood(email, rejectedBy, reason);\r\n        \r\n        // Broadcast event\r\n        broadcastEvent({\r\n          type: \"priesthood_application_rejected\",\r\n          component: \"priesthood-certification\",\r\n          message: `Priesthood application rejected for ${email}`,\r\n          timestamp: Date.now(),\r\n          data: {\r\n            email,\r\n            rejectedBy,\r\n            rejectedAt: certification.rejectedAt\r\n          }\r\n        });\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          certification\r\n        }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C [${requestId}] Error rejecting application:`, err.message);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n  \r\n  // POST /api/priesthood/revoke - GOD: Revoke certification\r\n  if (pathname === \"/api/priesthood/revoke\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDCDC [${requestId}] POST /api/priesthood/revoke - Revoking priesthood certification`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const { email, revokedBy, reason } = JSON.parse(body);\r\n        if (!email || !revokedBy) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"email and revokedBy required\" }));\r\n          return;\r\n        }\r\n        \r\n        const certification = revokePriesthood(email, revokedBy, reason);\r\n        \r\n        // Broadcast event\r\n        broadcastEvent({\r\n          type: \"priesthood_certification_revoked\",\r\n          component: \"priesthood-certification\",\r\n          message: `Priesthood certification revoked for ${email}`,\r\n          timestamp: Date.now(),\r\n          data: {\r\n            email,\r\n            revokedBy,\r\n            revokedAt: certification.revokedAt\r\n          }\r\n        });\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          certification\r\n        }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C [${requestId}] Error revoking certification:`, err.message);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n  \r\n  // POST /api/priesthood/pay-membership - Activate membership (FREE)\r\n  if (pathname === \"/api/priesthood/pay-membership\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDCDC [${requestId}] POST /api/priesthood/pay-membership - Activating membership (FREE)`);\r\n    let body = \"\";\r\n    req.on(\"data\", (chunk) => { body += chunk.toString(); });\r\n    req.on(\"end\", async () => {\r\n      try {\r\n        const { email } = JSON.parse(body);\r\n        if (!email) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"email required\" }));\r\n          return;\r\n        }\r\n        \r\n        const certification = getCertificationStatus(email);\r\n        if (!certification) {\r\n          res.writeHead(404, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: \"No priesthood certification found\" }));\r\n          return;\r\n        }\r\n        \r\n        if (certification.status !== 'approved' && certification.status !== 'suspended') {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({ success: false, error: `Cannot activate membership. Current status: ${certification.status}` }));\r\n          return;\r\n        }\r\n        \r\n        // Membership is now FREE - no payment required\r\n        // Authority is trust-based and rate-limited, not payment-based\r\n        const MEMBERSHIP_PERIOD_MS = 30 * 24 * 60 * 60 * 1000; // 30 days (for tracking period)\r\n        const now = Date.now();\r\n        \r\n        // Update membership period (free, but tracked for activity monitoring)\r\n        const activeUntil = (certification.membershipActiveUntil && certification.membershipActiveUntil > now) \r\n          ? certification.membershipActiveUntil + MEMBERSHIP_PERIOD_MS \r\n          : now + MEMBERSHIP_PERIOD_MS;\r\n        \r\n        const { updateCertificationBilling } = await import('./src/priesthoodCertification');\r\n        updateCertificationBilling(email, {\r\n          membershipActiveUntil: activeUntil,\r\n          lastActivityDate: now,\r\n          activityCount: (certification.activityCount || 0) + 1,\r\n          suspendedForNonPayment: false\r\n        });\r\n        \r\n        // If suspended, reactivate\r\n        if (certification.status === 'suspended' && certification.suspendedForNonPayment) {\r\n          const { getCertificationStatus: getCert } = await import('./src/priesthoodCertification');\r\n          const updated = getCert(email);\r\n          if (updated && updated.status === 'suspended') {\r\n            // Status will be updated by updateCertificationBilling if payment resumed\r\n          }\r\n        }\r\n        \r\n        // Reload certification\r\n        const updatedCertification = getCertificationStatus(email);\r\n        \r\n        // Broadcast event\r\n        broadcastEvent({\r\n          type: \"priesthood_membership_activated\",\r\n          component: \"priesthood-certification\",\r\n          message: `Membership activated for ${email} (FREE). Active until ${new Date(activeUntil).toISOString()}. Authority is trust-based and rate-limited.`,\r\n          timestamp: Date.now(),\r\n          data: {\r\n            email,\r\n            membershipFee: 0, // FREE\r\n            activeUntil,\r\n            trustScore: updatedCertification?.trustScore || 0\r\n          }\r\n        });\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          certification: updatedCertification,\r\n          membershipActivated: true,\r\n          membershipFee: 0, // FREE\r\n          activeUntil,\r\n          message: \"Membership is FREE. Authority is trust-based and rate-limited.\"\r\n        }));\r\n      } catch (err: any) {\r\n        console.error(`   \u274C [${requestId}] Error paying membership fee:`, err.message);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({ success: false, error: err.message }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n  \r\n  // GET /api/priesthood/stats - Get statistics for dashboard\r\n  // \uD83D\uDF02 Governance API Endpoints\r\n  if (pathname === \"/api/governance/evaluate\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDF02 [${requestId}] POST /api/governance/evaluate - Evaluating action against governance rules`);\r\n    let body = \"\";\r\n    let bodyReceived = false;\r\n    \r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    \r\n    req.on(\"end\", async () => {\r\n      if (bodyReceived) return;\r\n      bodyReceived = true;\r\n      \r\n      try {\r\n        const parsedBody = JSON.parse(body);\r\n        const { getGovernanceService } = await import(\"./src/governance/governanceService\");\r\n        const governanceService = getGovernanceService();\r\n        \r\n        const result = governanceService.evaluateAction(parsedBody);\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          result: result\r\n        }));\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Error evaluating governance action:`, error);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: false,\r\n          error: error.message || \"Failed to evaluate action\"\r\n        }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  if (pathname === \"/api/governance/rules\" && req.method === \"GET\") {\r\n    console.log(`   \uD83D\uDF02 [${requestId}] GET /api/governance/rules - Getting all governance rules`);\r\n    try {\r\n      const { getGovernanceService } = await import(\"./src/governance/governanceService\");\r\n      const governanceService = getGovernanceService();\r\n      const rules = governanceService.getAllRules();\r\n      \r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        rules: rules\r\n      }));\r\n    } catch (error: any) {\r\n      console.error(`   \u274C [${requestId}] Error getting governance rules:`, error);\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: false,\r\n        error: error.message || \"Failed to get rules\"\r\n      }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (pathname.startsWith(\"/api/governance/rules/\") && req.method === \"GET\") {\r\n    const ruleId = pathname.split(\"/\").pop();\r\n    console.log(`   \uD83D\uDF02 [${requestId}] GET /api/governance/rules/${ruleId} - Getting rule by ID`);\r\n    try {\r\n      const { getGovernanceService } = await import(\"./src/governance/governanceService\");\r\n      const governanceService = getGovernanceService();\r\n      const rule = governanceService.getRule(ruleId || \"\");\r\n      \r\n      if (!rule) {\r\n        res.writeHead(404, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: false,\r\n          error: \"Rule not found\"\r\n        }));\r\n        return;\r\n      }\r\n      \r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        rule: rule\r\n      }));\r\n    } catch (error: any) {\r\n      console.error(`   \u274C [${requestId}] Error getting governance rule:`, error);\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: false,\r\n        error: error.message || \"Failed to get rule\"\r\n      }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (pathname === \"/api/governance/rules\" && req.method === \"POST\") {\r\n    console.log(`   \uD83D\uDF02 [${requestId}] POST /api/governance/rules - Creating/updating governance rule`);\r\n    let body = \"\";\r\n    let bodyReceived = false;\r\n    \r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    \r\n    req.on(\"end\", async () => {\r\n      if (bodyReceived) return;\r\n      bodyReceived = true;\r\n      \r\n      try {\r\n        const parsedBody = JSON.parse(body);\r\n        const { rule, actorRole } = parsedBody;\r\n        \r\n        if (!rule || !actorRole) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({\r\n            success: false,\r\n            error: \"Rule and actorRole are required\"\r\n          }));\r\n          return;\r\n        }\r\n        \r\n        const { getGovernanceService } = await import(\"./src/governance/governanceService\");\r\n        const { ActorRole } = await import(\"./src/governance/types\");\r\n        const governanceService = getGovernanceService();\r\n        \r\n        governanceService.upsertRule(rule, actorRole as any);\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          message: \"Rule created/updated successfully\"\r\n        }));\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Error creating/updating governance rule:`, error);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: false,\r\n          error: error.message || \"Failed to create/update rule\"\r\n        }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  if (pathname.startsWith(\"/api/governance/rules/\") && req.method === \"DELETE\") {\r\n    const ruleId = pathname.split(\"/\").pop();\r\n    console.log(`   \uD83D\uDF02 [${requestId}] DELETE /api/governance/rules/${ruleId} - Deleting governance rule`);\r\n    let body = \"\";\r\n    let bodyReceived = false;\r\n    \r\n    req.on(\"data\", (chunk) => {\r\n      body += chunk.toString();\r\n    });\r\n    \r\n    req.on(\"end\", async () => {\r\n      if (bodyReceived) return;\r\n      bodyReceived = true;\r\n      \r\n      try {\r\n        const parsedBody = body ? JSON.parse(body) : {};\r\n        const { actorRole } = parsedBody;\r\n        \r\n        if (!actorRole) {\r\n          res.writeHead(400, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({\r\n            success: false,\r\n            error: \"actorRole is required\"\r\n          }));\r\n          return;\r\n        }\r\n        \r\n        const { getGovernanceService } = await import(\"./src/governance/governanceService\");\r\n        const governanceService = getGovernanceService();\r\n        const deleted = governanceService.deleteRule(ruleId || \"\", actorRole);\r\n        \r\n        if (!deleted) {\r\n          res.writeHead(404, { \"Content-Type\": \"application/json\" });\r\n          res.end(JSON.stringify({\r\n            success: false,\r\n            error: \"Rule not found\"\r\n          }));\r\n          return;\r\n        }\r\n        \r\n        res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: true,\r\n          message: \"Rule deleted successfully\"\r\n        }));\r\n      } catch (error: any) {\r\n        console.error(`   \u274C [${requestId}] Error deleting governance rule:`, error);\r\n        res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n        res.end(JSON.stringify({\r\n          success: false,\r\n          error: error.message || \"Failed to delete rule\"\r\n        }));\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // GET /api/governance/history - Get evaluation history (for automated monitoring)\r\n  if (pathname === \"/api/governance/history\" && req.method === \"GET\") {\r\n    console.log(`   \uD83D\uDF02 [${requestId}] GET /api/governance/history - Getting evaluation history`);\r\n    try {\r\n      const { getGovernanceService } = await import(\"./src/governance/governanceService\");\r\n      const governanceService = getGovernanceService();\r\n      const url = new URL(req.url || \"\", `http://${req.headers.host}`);\r\n      const limit = parseInt(url.searchParams.get(\"limit\") || \"100\", 10);\r\n      const history = governanceService.getEvaluationHistory(limit);\r\n      \r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        history: history\r\n      }));\r\n    } catch (error: any) {\r\n      console.error(`   \u274C [${requestId}] Error getting evaluation history:`, error);\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: false,\r\n        error: error.message || \"Failed to get evaluation history\"\r\n      }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // GET /api/governance/stats - Get evaluation statistics (self-scoring metrics)\r\n  if (pathname === \"/api/governance/stats\" && req.method === \"GET\") {\r\n    console.log(`   \uD83D\uDF02 [${requestId}] GET /api/governance/stats - Getting evaluation statistics`);\r\n    try {\r\n      const { getGovernanceService } = await import(\"./src/governance/governanceService\");\r\n      const governanceService = getGovernanceService();\r\n      const stats = governanceService.getEvaluationStats();\r\n      \r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        stats: stats\r\n      }));\r\n    } catch (error: any) {\r\n      console.error(`   \u274C [${requestId}] Error getting evaluation stats:`, error);\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: false,\r\n        error: error.message || \"Failed to get evaluation stats\"\r\n      }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (pathname === \"/api/priesthood/stats\" && req.method === \"GET\") {\r\n    console.log(`   \uD83D\uDCDC [${requestId}] GET /api/priesthood/stats - Getting certification statistics`);\r\n    try {\r\n      const stats = getCertificationStats();\r\n      \r\n      res.writeHead(200, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({\r\n        success: true,\r\n        stats\r\n      }));\r\n    } catch (err: any) {\r\n      console.error(`   \u274C [${requestId}] Error getting stats:`, err.message);\r\n      res.writeHead(500, { \"Content-Type\": \"application/json\" });\r\n      res.end(JSON.stringify({ success: false, error: err.message }));\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Serve video files from /api/movie/video/ endpoint (garden-specific video serving)\r\n  if (pathname.startsWith(\"/api/movie/video/\")) {\r\n    // Handle OPTIONS preflight for video requests\r\n    if (req.method === \"OPTIONS\") {\r\n      console.log(`   \u2705 [${requestId}] OPTIONS preflight for video endpoint`);\r\n      res.writeHead(200, {\r\n        \"Access-Control-Allow-Origin\": \"*\",\r\n        \"Access-Control-Allow-Methods\": \"GET, HEAD, OPTIONS\",\r\n        \"Access-Control-Allow-Headers\": \"Range, Content-Type\",\r\n        \"Access-Control-Max-Age\": \"86400\", // 24 hours\r\n      });\r\n      res.end();\r\n      return;\r\n    }\r\n    \r\n    const videoFile = pathname.substring(\"/api/movie/video/\".length); // Remove \"/api/movie/video/\" prefix\r\n    const videoPath = path.join(__dirname, \"data\", videoFile);\r\n    \r\n    // Security: Ensure the resolved path is within the data directory\r\n    const resolvedPath = path.resolve(videoPath);\r\n    const dataDir = path.resolve(path.join(__dirname, \"data\"));\r\n    if (!resolvedPath.startsWith(dataDir)) {\r\n      console.log(`   \uD83D\uDEAB [${requestId}] Forbidden video access attempt: ${pathname}`);\r\n      res.writeHead(403, { \"Content-Type\": \"text/plain\" });\r\n      res.end(\"Forbidden\");\r\n      return;\r\n    }\r\n    \r\n    fs.access(videoPath, fs.constants.F_OK, (err) => {\r\n      if (err) {\r\n        console.log(`   \u274C [${requestId}] Video file not found: ${videoPath}`);\r\n        res.writeHead(404, { \"Content-Type\": \"text/plain\" });\r\n        res.end(\"Video not found\");\r\n        return;\r\n      }\r\n      \r\n      // Check if it's actually a video file (not a placeholder text file)\r\n      const stat = fs.statSync(videoPath);\r\n      // Allow small files for development (they might be placeholders, but serve them anyway)\r\n      // In production, you should replace placeholders with actual video files\r\n      if (videoPath.endsWith('.txt')) {\r\n        console.log(`   \u26A0\uFE0F [${requestId}] Video file is a .txt file (placeholder): ${videoFile} (${stat.size} bytes)`);\r\n        res.writeHead(404, { \"Content-Type\": \"text/plain\" });\r\n        res.end(\"Video file is a placeholder - please provide a real video file\");\r\n        return;\r\n      }\r\n      \r\n      // Warn if file is very small (likely a placeholder) but still serve it for development\r\n      // This allows testing the video player UI even with placeholder files\r\n      if (stat.size < 1000) {\r\n        console.log(`   \u26A0\uFE0F [${requestId}] Warning: Video file is very small (${stat.size} bytes) - may be a placeholder`);\r\n        console.log(`   \u26A0\uFE0F [${requestId}] Serving anyway for development/testing purposes`);\r\n      }\r\n      \r\n      console.log(`   \uD83C\uDFAC [${requestId}] Serving video file via /api/movie/video/: ${videoFile} (${stat.size} bytes)`);\r\n      \r\n      // Set appropriate headers for video streaming\r\n      const range = req.headers.range;\r\n      if (range) {\r\n        // Handle range requests for video seeking\r\n        const parts = range.replace(/bytes=/, \"\").split(\"-\");\r\n        const start = parseInt(parts[0], 10);\r\n        const end = parts[1] ? parseInt(parts[1], 10) : stat.size - 1;\r\n        const chunksize = (end - start) + 1;\r\n        const file = fs.createReadStream(videoPath, { start, end });\r\n        const head = {\r\n          \"Content-Range\": `bytes ${start}-${end}/${stat.size}`,\r\n          \"Accept-Ranges\": \"bytes\",\r\n          \"Content-Length\": chunksize,\r\n          \"Content-Type\": \"video/mp4\",\r\n          \"Access-Control-Allow-Origin\": \"*\",\r\n          \"Access-Control-Allow-Methods\": \"GET, HEAD, OPTIONS\",\r\n          \"Access-Control-Allow-Headers\": \"Range\",\r\n        };\r\n        res.writeHead(206, head);\r\n        file.pipe(res);\r\n      } else {\r\n        res.writeHead(200, {\r\n          \"Content-Length\": stat.size,\r\n          \"Content-Type\": \"video/mp4\",\r\n          \"Access-Control-Allow-Origin\": \"*\",\r\n          \"Access-Control-Allow-Methods\": \"GET, HEAD, OPTIONS\",\r\n          \"Access-Control-Allow-Headers\": \"Range\",\r\n        });\r\n        fs.createReadStream(videoPath).pipe(res);\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // Serve video files from data directory (legacy /videos/ endpoint)\r\n  if (pathname.startsWith(\"/videos/\")) {\r\n    // Handle OPTIONS preflight for video requests\r\n    if (req.method === \"OPTIONS\") {\r\n      console.log(`   \u2705 [${requestId}] OPTIONS preflight for legacy video endpoint`);\r\n      res.writeHead(200, {\r\n        \"Access-Control-Allow-Origin\": \"*\",\r\n        \"Access-Control-Allow-Methods\": \"GET, HEAD, OPTIONS\",\r\n        \"Access-Control-Allow-Headers\": \"Range, Content-Type\",\r\n        \"Access-Control-Max-Age\": \"86400\", // 24 hours\r\n      });\r\n      res.end();\r\n      return;\r\n    }\r\n    \r\n    const videoFile = pathname.substring(8); // Remove \"/videos/\" prefix\r\n    const videoPath = path.join(__dirname, \"data\", videoFile);\r\n\r\n    // Security: prevent directory traversal\r\n    const resolvedPath = path.resolve(videoPath);\r\n    const resolvedDataDir = path.resolve(path.join(__dirname, \"data\"));\r\n    if (!resolvedPath.startsWith(resolvedDataDir)) {\r\n      console.log(`   \uD83D\uDEAB [${requestId}] Forbidden video access attempt: ${pathname}`);\r\n      res.writeHead(403);\r\n      res.end(\"Forbidden\");\r\n      return;\r\n    }\r\n\r\n    fs.access(videoPath, fs.constants.F_OK, (err) => {\r\n      if (err) {\r\n        console.log(`   \u274C [${requestId}] Video file not found: ${videoPath}`);\r\n        res.writeHead(404);\r\n        res.end(\"Video not found\");\r\n        return;\r\n      }\r\n\r\n      // Check if it's actually a video file (not a placeholder text file)\r\n      const stat = fs.statSync(videoPath);\r\n      if (stat.size < 1000 || videoPath.endsWith('.txt')) {\r\n        console.log(`   \u26A0\uFE0F [${requestId}] Video file appears to be a placeholder: ${videoFile} (${stat.size} bytes)`);\r\n        res.writeHead(404);\r\n        res.end(\"Video file is a placeholder - please provide a real video file\");\r\n        return;\r\n      }\r\n\r\n      console.log(`   \uD83C\uDFAC [${requestId}] Serving video file: ${videoFile} (${stat.size} bytes)`);\r\n\r\n      // Set appropriate headers for video streaming\r\n      const fileSize = stat.size;\r\n      const range = req.headers.range;\r\n\r\n      if (range) {\r\n        // Handle range requests for video seeking\r\n        const parts = range.replace(/bytes=/, \"\").split(\"-\");\r\n        const start = parseInt(parts[0], 10);\r\n        const end = parts[1] ? parseInt(parts[1], 10) : fileSize - 1;\r\n        const chunksize = (end - start) + 1;\r\n        const file = fs.createReadStream(videoPath, { start, end });\r\n\r\n        res.writeHead(206, {\r\n          \"Content-Range\": `bytes ${start}-${end}/${fileSize}`,\r\n          \"Accept-Ranges\": \"bytes\",\r\n          \"Content-Length\": chunksize,\r\n          \"Content-Type\": \"video/mp4\",\r\n          \"Access-Control-Allow-Origin\": \"*\",\r\n          \"Access-Control-Allow-Methods\": \"GET, HEAD, OPTIONS\",\r\n          \"Access-Control-Allow-Headers\": \"Range\",\r\n        });\r\n        file.pipe(res);\r\n      } else {\r\n        // Serve entire file\r\n        res.writeHead(200, {\r\n          \"Content-Length\": fileSize,\r\n          \"Content-Type\": \"video/mp4\",\r\n          \"Access-Control-Allow-Origin\": \"*\",\r\n          \"Access-Control-Allow-Methods\": \"GET, HEAD, OPTIONS\",\r\n          \"Access-Control-Allow-Headers\": \"Range\",\r\n        });\r\n        fs.createReadStream(videoPath).pipe(res);\r\n      }\r\n    });\r\n    return;\r\n  }\r\n\r\n  // Serve static files (Angular app)\r\n  let filePath = pathname === \"/\" ? \"/index.html\" : pathname;\r\n  const fullPath = path.join(FRONTEND_PATH, filePath);\r\n\r\n  // Security: prevent directory traversal\r\n  const resolvedPath = path.resolve(fullPath);\r\n  const resolvedFrontend = path.resolve(FRONTEND_PATH);\r\n  if (!resolvedPath.startsWith(resolvedFrontend)) {\r\n    console.log(`   \u26A0\uFE0F [${requestId}] Security: Path traversal attempt blocked`);\r\n    res.writeHead(403);\r\n    res.end(\"Forbidden\");\r\n    return;\r\n  }\r\n\r\n  // Debug logging for frontend path\r\n  if (pathname === \"/\" || pathname === \"/index.html\") {\r\n    console.log(`   \uD83D\uDCC1 [${requestId}] Frontend path: ${FRONTEND_PATH}`);\r\n    console.log(`   \uD83D\uDCC1 [${requestId}] Full path: ${fullPath}`);\r\n    console.log(`   \uD83D\uDCC1 [${requestId}] Resolved path: ${resolvedPath}`);\r\n    console.log(`   \uD83D\uDCC1 [${requestId}] Path exists: ${fs.existsSync(fullPath)}`);\r\n  }\r\n\r\n  fs.access(fullPath, fs.constants.F_OK, (err) => {\r\n    if (err) {\r\n      // If file not found, serve index.html for Angular routing\r\n      const indexPath = path.join(FRONTEND_PATH, \"index.html\");\r\n      console.log(`   \uD83D\uDCC1 [${requestId}] File not found: ${fullPath}, trying index.html: ${indexPath}`);\r\n      console.log(`   \uD83D\uDCC1 [${requestId}] Index.html exists: ${fs.existsSync(indexPath)}`);\r\n      fs.readFile(indexPath, (err, data) => {\r\n        if (err) {\r\n          console.error(`   \u274C [${requestId}] Failed to read index.html: ${err.message}`);\r\n          console.error(`   \u274C [${requestId}] FRONTEND_PATH: ${FRONTEND_PATH}`);\r\n          console.error(`   \u274C [${requestId}] indexPath: ${indexPath}`);\r\n          console.error(`   \u274C [${requestId}] Directory exists: ${fs.existsSync(FRONTEND_PATH)}`);\r\n          if (fs.existsSync(FRONTEND_PATH)) {\r\n            const files = fs.readdirSync(FRONTEND_PATH);\r\n            console.error(`   \u274C [${requestId}] Files in directory: ${files.join(', ')}`);\r\n          }\r\n          res.writeHead(404, { \"Content-Type\": \"text/html\" });\r\n          res.end(`\r\n            <!DOCTYPE html>\r\n            <html>\r\n            <head>\r\n              <title>Frontend Not Found</title>\r\n              <style>\r\n                body { font-family: Arial, sans-serif; padding: 40px; text-align: center; }\r\n                h1 { color: #d32f2f; }\r\n                code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; }\r\n              </style>\r\n            </head>\r\n            <body>\r\n              <h1>404 - Frontend Not Found</h1>\r\n              <p>The Angular frontend has not been built yet.</p>\r\n              <p>Please run: <code>cd frontend && ng build</code></p>\r\n              <p>Or use the Angular dev server: <code>cd frontend && ng serve</code></p>\r\n              <p><small>FRONTEND_PATH: ${FRONTEND_PATH}</small></p>\r\n            </body>\r\n            </html>\r\n          `);\r\n        } else {\r\n          res.writeHead(200, { \r\n            \"Content-Type\": \"text/html\",\r\n            \"Content-Security-Policy\": \"default-src 'self'; img-src 'self' data:; media-src 'self' http: https:; connect-src 'self' ws: wss: http: https: https://accounts.google.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://accounts.google.com; style-src 'self' 'unsafe-inline' https://accounts.google.com;\"\r\n          });\r\n          res.end(data);\r\n        }\r\n      });\r\n    } else {\r\n      fs.readFile(fullPath, (err, data) => {\r\n        if (err) {\r\n          res.writeHead(500);\r\n          res.end(\"Internal Server Error\");\r\n        } else {\r\n          const ext = path.extname(fullPath);\r\n          const contentType = getContentType(ext);\r\n          res.writeHead(200, { \"Content-Type\": contentType });\r\n          res.end(data);\r\n        }\r\n      });\r\n    }\r\n  });\r\n});\r\n\r\nfunction getContentType(ext: string): string {\r\n  const types: Record<string, string> = {\r\n    \".html\": \"text/html\",\r\n    \".js\": \"application/javascript\",\r\n    \".css\": \"text/css\",\r\n    \".json\": \"application/json\",\r\n    \".png\": \"image/png\",\r\n    \".jpg\": \"image/jpeg\",\r\n    \".gif\": \"image/gif\",\r\n    \".svg\": \"image/svg+xml\",\r\n    \".ico\": \"image/x-icon\"\r\n  };\r\n  return types[ext] || \"application/octet-stream\";\r\n}\r\n\r\n// Embedded In-Memory Redis Server\r\n\r\n// InMemoryRedisServer class has been moved to src/redis.ts\r\n\r\n// Create embedded Redis instance\r\nconst redis = new InMemoryRedisServer();\r\n\r\n// Redis Connection Helpers\r\n\r\nasync function connectRedis(): Promise<boolean> {\r\n  if (SKIP_REDIS) {\r\n    console.log(\"\u26A0\uFE0F  Redis: Skipped (--skip-redis flag)\");\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    await redis.connect();\r\n    \r\n    // Test connection with PING\r\n    const pong = await redis.ping();\r\n    if (pong === \"PONG\") {\r\n      console.log(\"\u2705 Redis: Embedded server ready\");\r\n      return true;\r\n    }\r\n    return false;\r\n  } catch (err: any) {\r\n    console.error(\"\u274C Redis: Connection failed:\", err.message);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function ensureRedisConnection(): Promise<void> {\r\n  if (!redis.isOpen) {\r\n    await redis.connect();\r\n  }\r\n}\r\n\r\n// Types\r\n\r\ntype User = {\r\n  id: string;\r\n  email: string;\r\n  balance: number;\r\n};\r\n\r\ntype TransactionSnapshot = {\r\n  chainId: string;\r\n  txId: string;\r\n  slot: number;\r\n  blockTime: number;\r\n  payer: string;\r\n  merchant: string;\r\n  amount: number;\r\n  feeSplit: Record<string, number>;\r\n};\r\n\r\ntype LedgerEntry = {\r\n  entryId: string;\r\n  txId: string;\r\n  timestamp: number;\r\n  payer: string; // Email address\r\n  payerId: string; // User ID for internal tracking\r\n  merchant: string;\r\n  providerUuid: string; // Service provider UUID for certificate issuance\r\n  serviceType: string; // 'movie', 'dex', 'mint', 'transaction', etc.\r\n  amount: number;\r\n  iGasCost: number;\r\n  fees: Record<string, number>;\r\n  status: 'pending' | 'processed' | 'completed' | 'failed';\r\n  cashierId: string;\r\n  bookingDetails?: Record<string, any>; // Generic booking details - service-type agnostic (allows any fields)\r\n};\r\n\r\ntype Cashier = {\r\n  id: string;\r\n  name: string;\r\n  processedCount: number;\r\n  totalProcessed: number;\r\n  status: 'active' | 'idle';\r\n};\r\n\r\ntype Review = {\r\n  userId: string;\r\n  movieId: string;\r\n  rating: number;\r\n};\r\n\r\ntype ServiceProvider = {\r\n  id: string;\r\n  uuid: string; // UUID for certificate issuance\r\n  name: string;\r\n  serviceType: string;\r\n  location: string;\r\n  bond: number;\r\n  reputation: number;\r\n  gardenId: string; // Standardized field name - used everywhere (persistence, memory, API)\r\n  apiEndpoint?: string; // Optional API endpoint for the provider\r\n  status?: 'active' | 'revoked' | 'suspended'; // Provider status\r\n  // Snake Service Fields (serviceType: \"snake\")\r\n  // Note: Snake is a SERVICE TYPE (like \"movie\", \"dex\"), not a provider type\r\n  // Each Snake service belongs to a garden (gardenId)\r\n  insuranceFee?: number; // Higher insurance fee for Snake services (default: same as bond)\r\n  iGasMultiplier?: number; // iGas multiplier (default: 1.0, Snake: 2.0)\r\n  iTaxMultiplier?: number; // iTax multiplier (default: 1.0, Snake: 2.0)\r\n  maxInfluence?: number; // Maximum influence score (0.0-1.0, default: 0.15 for Snake)\r\n  contextsAllowed?: string[]; // Contexts where Snake service can operate\r\n  contextsForbidden?: string[]; // Contexts where Snake service is banned\r\n  adCapabilities?: string[]; // Advertising capabilities (e.g., [\"product_promotion\", \"service_highlighting\"])\r\n};\r\n\r\ntype MovieListing = {\r\n  providerId: string;\r\n  providerName: string;\r\n  movieTitle: string;\r\n  movieId: string;\r\n  price: number;\r\n  showtime: string;\r\n  location: string;\r\n  reviewCount: number;\r\n  rating: number;\r\n  gardenId: string;\r\n};\r\n\r\ntype TokenPool = {\r\n  poolId: string;\r\n  tokenSymbol: string;\r\n  tokenName: string;\r\n  baseToken: string; // SOL, USDC, etc.\r\n  poolLiquidity: number; // Total liquidity in base token\r\n  tokenReserve: number; // Amount of tokens in pool\r\n  baseReserve: number; // Amount of base token in pool\r\n  price: number; // Current price (baseToken per token)\r\n  bond: number; // Creator bond\r\n  gardenId: string; // Garden providing this pool service\r\n  createdAt: number;\r\n  totalVolume: number;\r\n  totalTrades: number;\r\n};\r\n\r\ntype TokenListing = {\r\n  poolId: string;\r\n  providerId: string; // Indexer ID providing the pool\r\n  providerName: string;\r\n  tokenSymbol: string;\r\n  tokenName: string;\r\n  baseToken: string;\r\n  price: number; // Current price\r\n  liquidity: number;\r\n  volume24h: number;\r\n  indexerId: string;\r\n};\r\n\r\ntype DEXTrade = {\r\n  tradeId: string;\r\n  poolId: string;\r\n  tokenSymbol: string;\r\n  baseToken: string;\r\n  action: 'BUY' | 'SELL';\r\n  tokenAmount: number;\r\n  baseAmount: number;\r\n  price: number;\r\n  priceImpact: number; // 0.001% per trade\r\n  iTax: number; // 0.0005% commission\r\n  timestamp: number;\r\n  trader: string; // User email\r\n};\r\n\r\ntype ServiceRegistryQuery = {\r\n  serviceType?: string; // Optional: filter by service type\r\n  providerType?: 'REGULAR' | 'SNAKE'; // Optional: filter by provider type (for Snake providers)\r\n  filters?: {\r\n    location?: string;\r\n    maxPrice?: number | string; // Can be a number or 'best'/'lowest'\r\n    minReputation?: number;\r\n    genre?: string;\r\n    time?: string;\r\n    // DEX-specific filters\r\n    tokenSymbol?: string;\r\n    baseToken?: string;\r\n    action?: 'BUY' | 'SELL';\r\n    tokenAmount?: number;\r\n    maxPriceImpact?: number;\r\n  };\r\n};\r\n\r\ntype LLMQueryResult = {\r\n  query: ServiceRegistryQuery;\r\n  serviceType: string;\r\n  confidence: number;\r\n};\r\n\r\ntype LLMResponse = {\r\n  message: string;\r\n  listings: MovieListing[] | TokenListing[];\r\n  selectedListing: MovieListing | TokenListing | null;\r\n  iGasCost: number;\r\n  tradeDetails?: DEXTrade; // For DEX trades\r\n  shouldRouteToGodInbox?: boolean; // If true, route message to GOD's inbox\r\n};\r\n\r\n// Constants\r\n\r\nconst CHAIN_ID = \"eden-core\";\r\n\r\nconst ROOT_CA_FEE = 0.02;\r\nconst INDEXER_FEE = 0.005;\r\n\r\n// Stream names are now dynamically generated from GARDENS array\r\n\r\n// iGas Calculation Constants\r\nconst LLM_BASE_COST = 0.001; // Base cost per LLM call\r\nconst ROUTING_COST_PER_PROVIDER = 0.0001; // Cost per service provider queried\r\nconst REASONING_COST_MULTIPLIER = 1.5; // Multiplier for complex reasoning\r\n\r\n// DEX Trading Constants\r\nconst PRICE_IMPACT_PER_TRADE = 0.00001; // 0.001% = 0.00001\r\nconst ITAX_RATE = 0.000005; // 0.0005% = 0.000005\r\nconst ROOT_CA_LIQUIDITY_POOL = 1000; // Initial ROOT CA liquidity in SOL\r\nconst ITAX_DISTRIBUTION = {\r\n  rootCA: 0.4, // 40% to ROOT CA\r\n  indexer: 0.3, // 30% to indexer (token provider)\r\n  trader: 0.3, // 30% back to trader as rebate\r\n};\r\n\r\n// DEX Pools Registry\r\nconst DEX_POOLS: Map<string, TokenPool> = new Map();\r\n\r\n// ROOT CA Liquidity Pool (first liquidity source)\r\nlet rootCALiquidity: number = ROOT_CA_LIQUIDITY_POOL;\r\n\r\n// ROOT CA Balance Tracking (Settlement Authority)\r\n// ROOT CA is the ONLY source of truth for balances\r\ninterface ROOTBalance {\r\n  rootCA: number; // ROOT CA balance (iGas + iTax)\r\n  indexers: Map<string, number>; // Indexer balances (by indexer ID)\r\n  providers: Map<string, number>; // Service provider balances (by provider UUID)\r\n}\r\n\r\nconst ROOT_BALANCES: ROOTBalance = {\r\n  rootCA: 0,\r\n  indexers: new Map(),\r\n  providers: new Map(),\r\n};\r\n\r\n// Ledger Settlement Stream Name\r\nconst LEDGER_SETTLEMENT_STREAM = \"eden:ledger:pending\";\r\n\r\n// Users\r\n\r\nconst USERS: User[] = [\r\n  { id: \"u1\", email: \"bill.draper.auto@gmail.com\", balance: 0 },\r\n  { id: \"u2\", email: \"bob@gmail.com\", balance: 0 },\r\n];\r\n\r\n// Ledger Component - Tracks all Eden bookings\r\n// LEDGER is now imported from ./src/state - removed local declaration\r\n\r\n// Provider Webhook Registry (for optional push notifications)\r\ninterface ProviderWebhook {\r\n  providerId: string;\r\n  webhookUrl: string;\r\n  registeredAt: number;\r\n  lastDelivery?: number;\r\n  failureCount: number;\r\n}\r\n\r\nconst PROVIDER_WEBHOOKS: Map<string, ProviderWebhook> = new Map();\r\n\r\n// Dedicated Cashier for processing payments\r\n// (CASHIER moved to main() initialization)\r\n\r\n// ROOT CA Service Registry\r\n// ServiceRegistry is now managed by ROOT CA, not indexers\r\n// This enables quick post-LLM in-memory lookup\r\n// Indexers are dedicated intelligent entities (post-LLM regulated)\r\ninterface ServiceProviderWithCert extends ServiceProvider {\r\n  certificate?: EdenCertificate;\r\n}\r\n\r\n// ROOT CA Service Registry (centralized, in-memory)\r\nconst ROOT_CA_SERVICE_REGISTRY: ServiceProviderWithCert[] = [\r\n  // Holy Ghost Infrastructure Services (ROOT CA's indexer)\r\n  {\r\n    id: \"stripe-payment-rail-001\",\r\n    uuid: \"550e8400-e29b-41d4-a716-446655440100\",\r\n    name: \"Stripe Payment Rail\",\r\n    serviceType: \"payment-rail\",\r\n    location: \"Global\",\r\n    bond: 50000, // High bond for payment infrastructure\r\n    reputation: 5.0,\r\n    gardenId: \"HG\", // Holy Ghost garden\r\n    apiEndpoint: \"https://api.stripe.com/v1\",\r\n    status: 'active'\r\n  },\r\n  {\r\n    id: \"settlement-service-001\",\r\n    uuid: \"550e8400-e29b-41d4-a716-446655440101\",\r\n    name: \"Settlement Service\",\r\n    serviceType: \"settlement\",\r\n    location: \"ROOT CA\",\r\n    bond: 100000, // Very high bond for settlement authority\r\n    reputation: 5.0,\r\n    gardenId: \"HG\", // Holy Ghost garden\r\n    apiEndpoint: \"internal://settlement\",\r\n    status: 'active'\r\n  },\r\n  {\r\n    id: \"service-registry-001\",\r\n    uuid: \"550e8400-e29b-41d4-a716-446655440102\",\r\n    name: \"Service Registry\",\r\n    serviceType: \"registry\",\r\n    location: \"ROOT CA\",\r\n    bond: 50000, // High bond for registry authority\r\n    reputation: 5.0,\r\n    gardenId: \"HG\", // Holy Ghost garden\r\n    apiEndpoint: \"internal://service-registry\",\r\n    status: 'active'\r\n  },\r\n  {\r\n    id: \"webserver-service-001\",\r\n    uuid: \"550e8400-e29b-41d4-a716-446655440103\",\r\n    name: \"Web Server\",\r\n    serviceType: \"webserver\",\r\n    location: \"ROOT CA\",\r\n    bond: 10000,\r\n    reputation: 5.0,\r\n    gardenId: \"HG\", // Holy Ghost garden\r\n    apiEndpoint: `http://localhost:${HTTP_PORT}`,\r\n    status: 'active'\r\n  },\r\n  {\r\n    id: \"websocket-service-001\",\r\n    uuid: \"550e8400-e29b-41d4-a716-446655440104\",\r\n    name: \"WebSocket Service\",\r\n    serviceType: \"websocket\",\r\n    location: \"ROOT CA\",\r\n    bond: 10000,\r\n    reputation: 5.0,\r\n    gardenId: \"HG\", // Holy Ghost garden\r\n    apiEndpoint: `ws://localhost:${HTTP_PORT}`,\r\n    status: 'active'\r\n  },\r\n  {\r\n    id: \"wallet-service-001\",\r\n    uuid: \"550e8400-e29b-41d4-a716-446655440105\",\r\n    name: \"JesusCoin Wallet Service\",\r\n    serviceType: \"wallet\",\r\n    location: \"ROOT CA\",\r\n    bond: 200000, // Very high bond for wallet authority (single source of truth)\r\n    reputation: 5.0,\r\n    gardenId: \"HG\", // Holy Ghost garden\r\n    apiEndpoint: \"internal://wallet\",\r\n    status: 'active'\r\n  },\r\n  {\r\n    id: \"accountant-service-001\",\r\n    uuid: \"550e8400-e29b-41d4-a716-446655440106\",\r\n    name: \"Accountant Service\",\r\n    serviceType: \"accountant\",\r\n    location: \"ROOT CA\",\r\n    bond: 75000, // High bond for financial reporting integrity\r\n    reputation: 5.0,\r\n    gardenId: \"HG\", // Holy Ghost garden\r\n    apiEndpoint: \"internal://accountant\",\r\n    status: 'active'\r\n  },\r\n  {\r\n    id: \"token-liquidity-accountant-001\",\r\n    uuid: \"550e8400-e29b-41d4-a716-446655440108\",\r\n    name: \"Token Liquidity Accountant Service\",\r\n    serviceType: \"liquidity-accountant\",\r\n    location: \"ROOT CA\",\r\n    bond: 75000, // High bond for liquidity tracking authority\r\n    reputation: 5.0,\r\n    gardenId: \"HG\", // Holy Ghost garden\r\n    apiEndpoint: \"internal://liquidity-accountant\",\r\n    status: 'active',\r\n    description: \"Tracks initial and runtime liquidity for all DEX token pools (tokenA, tokenB, etc.) via Stripe Payment Rail\"\r\n  },\r\n  {\r\n    id: \"price-order-service-001\",\r\n    uuid: \"550e8400-e29b-41d4-a716-446655440107\",\r\n    name: \"Price Order Service\",\r\n    serviceType: \"price-order\",\r\n    location: \"ROOT CA\",\r\n    bond: 100000, // Very high bond for order matching and settlement authority\r\n    reputation: 5.0,\r\n    gardenId: \"HG\", // Holy Ghost garden\r\n    apiEndpoint: \"internal://price-order\",\r\n    status: 'active',\r\n    description: \"Real-time DEX order matching, two-phase settlement, and price broadcasting service\"\r\n  },\r\n  // Regular Service Providers\r\n  // In ROOT mode: All service providers (including amc-001) are created dynamically via the wizard\r\n  // They should NOT exist in hardcoded defaults\r\n  ...(DEPLOYED_AS_ROOT ? [] : [\r\n    {\r\n      id: \"amc-001\",\r\n      uuid: \"550e8400-e29b-41d4-a716-446655440001\", // UUID for certificate issuance\r\n      name: \"AMC Theatres\",\r\n      serviceType: \"movie\",\r\n      location: \"Baltimore, Maryland\",\r\n      bond: 1000,\r\n      reputation: 4.8,\r\n      gardenId: \"garden-1\", // Default to garden-1 (will be overridden by persistence file if different)\r\n      apiEndpoint: \"https://api.amctheatres.com/v1/listings\",\r\n    },\r\n    {\r\n      id: \"moviecom-001\",\r\n      uuid: \"550e8400-e29b-41d4-a716-446655440002\", // UUID for certificate issuance\r\n      name: \"MovieCom\",\r\n      serviceType: \"movie\",\r\n      location: \"Baltimore, Maryland\",\r\n      bond: 800,\r\n      reputation: 4.5,\r\n      gardenId: \"garden-2\",\r\n      apiEndpoint: \"https://api.moviecom.com/showtimes\",\r\n    },\r\n    {\r\n      id: \"cinemark-001\",\r\n      uuid: \"550e8400-e29b-41d4-a716-446655440003\", // UUID for certificate issuance\r\n      name: \"Cinemark\",\r\n      serviceType: \"movie\",\r\n      location: \"Baltimore, Maryland\",\r\n      bond: 1200,\r\n      reputation: 4.7,\r\n      gardenId: \"garden-1\",\r\n      apiEndpoint: \"https://api.cinemark.com/movies\",\r\n    },\r\n    // Snake Service Providers (serviceType: \"snake\", belongs to indexers)\r\n    {\r\n      id: \"snake-premium-cinema-001\",\r\n      uuid: \"550e8400-e29b-41d4-a716-446655440010\",\r\n      name: \"Premium Cinema Ads\",\r\n      serviceType: \"snake\", // Snake is a service type, not a provider type\r\n      location: \"Global\",\r\n      bond: 10000,\r\n      insuranceFee: 10000, // Higher insurance fee for Snake\r\n      reputation: 4.5,\r\n      gardenId: \"garden-1\",\r\n      apiEndpoint: \"https://ads.premiumcinema.com/api\",\r\n      iGasMultiplier: 2.0, // Double iGas\r\n      iTaxMultiplier: 2.0, // Double iTax\r\n      maxInfluence: 0.15, // 15% max influence\r\n      contextsAllowed: [\"movies\", \"entertainment\", \"shopping\"],\r\n      contextsForbidden: [\"health\", \"legal\", \"finance\", \"education\"],\r\n      adCapabilities: [\"product_promotion\", \"service_highlighting\"],\r\n      status: 'active'\r\n    },\r\n    {\r\n      id: \"snake-shopping-deals-001\",\r\n      uuid: \"550e8400-e29b-41d4-a716-446655440011\",\r\n      name: \"Shopping Deals Ads\",\r\n      serviceType: \"snake\", // Snake is a service type, not a provider type\r\n      location: \"Global\",\r\n      bond: 10000,\r\n      insuranceFee: 10000,\r\n      reputation: 4.3,\r\n      gardenId: \"garden-2\",\r\n      apiEndpoint: \"https://ads.shoppingdeals.com/api\",\r\n      iGasMultiplier: 2.0,\r\n      iTaxMultiplier: 2.0,\r\n      maxInfluence: 0.12, // 12% max influence\r\n      contextsAllowed: [\"shopping\", \"restaurants\"],\r\n      contextsForbidden: [\"health\", \"legal\", \"finance\", \"education\"],\r\n      adCapabilities: [\"product_promotion\"],\r\n      status: 'active'\r\n    },\r\n  ]),\r\n  // DEX Pool Service Providers will be dynamically created from token indexers during initialization\r\n];\r\n\r\n// Mock Service Provider APIs (simulate external API calls)\r\n// (Service provider API functions moved to src/serviceProvider.ts)\r\n\r\n// DEX Pool Functions\r\n// (initializeDEXPools moved to src/dex.ts)\r\nfunction _initializeDEXPools_DEPRECATED(): void {\r\n  // Initialize DEX pools, assigning them to token gardens\r\n  // Each token garden can provide multiple pools\r\n  for (let i = 0; i < TOKEN_GARDENS.length; i++) {\r\n    const tokenGarden = TOKEN_GARDENS[i];\r\n    if (!tokenGarden) continue;\r\n    \r\n    // Create pools for this token garden\r\n    // Token Garden T1 gets TOKENA, T2 gets TOKENB, etc.\r\n    const tokenSymbol = `TOKEN${String.fromCharCode(65 + i)}`; // TOKENA, TOKENB, TOKENC...\r\n    const tokenName = `Token ${String.fromCharCode(65 + i)}`;\r\n    const poolId = `pool-solana-${tokenSymbol.toLowerCase()}`;\r\n    \r\n    const pool: TokenPool = {\r\n      poolId: poolId,\r\n      tokenSymbol: tokenSymbol,\r\n      tokenName: tokenName,\r\n      baseToken: \"SOL\",\r\n      poolLiquidity: 100 - (i * 10), // Decreasing liquidity for variety: 100, 90, 80...\r\n      tokenReserve: 100000 - (i * 10000), // 100k, 90k, 80k...\r\n      baseReserve: 100 - (i * 10), // 100, 90, 80...\r\n      price: 0.001, // 1 Token = 0.001 SOL\r\n      bond: 5000,\r\n      gardenId: tokenGarden.id, // Assign to token garden\r\n      createdAt: Date.now(),\r\n      totalVolume: 0,\r\n      totalTrades: 0,\r\n    };\r\n    DEX_POOLS.set(poolId, pool);\r\n  }\r\n\r\n  console.log(`\uD83C\uDF0A Initialized ${DEX_POOLS.size} DEX pools`);\r\n  console.log(`\uD83D\uDCB0 ROOT CA Liquidity Pool: ${rootCALiquidity} SOL`);\r\n  console.log(`\uD83D\uDD37 Token Gardens: ${TOKEN_GARDENS.map(ti => ti.name).join(\", \")}`);\r\n  \r\n  // Display pool assignments\r\n  for (const [poolId, pool] of DEX_POOLS.entries()) {\r\n    console.log(`   ${pool.tokenSymbol} Pool \u2192 ${pool.gardenId} (${pool.poolLiquidity} SOL liquidity)`);\r\n  }\r\n}\r\n\r\n/**\r\n * Generate workflow JSON from template using LLM\r\n */\r\nasync function generateWorkflowFromTemplate(template: any, serviceType: string): Promise<any> {\r\n  const serviceTypeDescriptions: Record<string, string> = {\r\n    movie: \"Movie ticket booking service - Users can search for movies, select showtimes, and purchase tickets\",\r\n    dex: \"Decentralized exchange token pools - Users can buy and sell tokens through DEX pools\",\r\n    airline: \"Airline ticket booking service - Users can search for flights, select seats, and purchase tickets\",\r\n    autoparts: \"Automotive parts marketplace - Users can search for auto parts, compare prices, and purchase parts\",\r\n    hotel: \"Hotel reservation service - Users can search for hotels, view availability, and book rooms\",\r\n    restaurant: \"Restaurant booking service - Users can search for restaurants, view menus, and make reservations\",\r\n    grocerystore: \"Grocery store service - Users can search for grocery stores, browse products, and place orders\",\r\n    pharmacy: \"Pharmacy service - Users can search for pharmacies, find medications, and manage prescriptions\",\r\n    dogpark: \"Dog park service - Users can search for dog parks, view amenities, and check availability\",\r\n    gasstation: \"Gas station service - Users can search for gas stations, compare prices, and find fuel types\",\r\n    party: \"Party and event service - Users can search for parties and events, view details, and purchase tickets online\",\r\n    bank: \"Banking service - Users can search for banks, view services, and access banking facilities\",\r\n    snake: \"Snake (Advertiser) - Advertising service provider that displays ads to users\"\r\n  };\r\n  \r\n  const description = serviceTypeDescriptions[serviceType] || `Service type: ${serviceType}`;\r\n  \r\n  const prompt = `You are a workflow designer for the Eden ecosystem. Generate a FlowWise workflow JSON file based on the provided template.\r\n\r\nSERVICE TYPE: ${serviceType}\r\nDESCRIPTION: ${description}\r\n\r\nTEMPLATE WORKFLOW:\r\n${JSON.stringify(template, null, 2)}\r\n\r\nINSTRUCTIONS:\r\n1. Adapt the template workflow to the new service type (${serviceType})\r\n2. Update all serviceType references from \"movie\" to \"${serviceType}\"\r\n3. Update step names, descriptions, and actions to match the new service type\r\n4. Keep the same workflow structure (steps, transitions, actions)\r\n5. Update component names if needed (e.g., \"movie_theater\" \u2192 appropriate component for ${serviceType})\r\n6. Update field names in actions (e.g., \"movieTitle\" \u2192 appropriate field for ${serviceType})\r\n7. Ensure all transitions and step IDs are valid\r\n8. Keep ROOT CA ledger and payment steps unchanged\r\n9. IMPORTANT: Replace ALL instances of \"JSC\" or \"JesusCoin\" with \"\uD83C\uDF4E APPLES\" in ALL user-facing messages, including:\r\n   - Decision prompts (e.g., \"Would you like to proceed with ... for {{price}} \uD83C\uDF4E APPLES?\")\r\n   - Payment messages (e.g., \"{{cashier.name}} processed payment: {{ledgerEntry.amount}} \uD83C\uDF4E APPLES\")\r\n   - Purchase confirmations (e.g., \"Purchased ... for {{price}} \uD83C\uDF4E APPLES\")\r\n   - Review rebate messages (e.g., \"Review rebate credited: {{rebate}} \uD83C\uDF4E APPLES\")\r\n   - Any other user-visible text that mentions currency\r\n10. Return ONLY the complete JSON object with the same structure as the template\r\n\r\nCRITICAL: Return ONLY valid JSON. Do not include any markdown formatting, code blocks, or explanations. Just the JSON object.`;\r\n\r\n  // Get ENABLE_OPENAI from config (same as used elsewhere in the file)\r\n  const ENABLE_OPENAI_FOR_WORKFLOW = ENABLE_OPENAI ?? true; // Default to true if not set\r\n  \r\n  try {\r\n    const llmResponse = await callLLM(prompt, ENABLE_OPENAI_FOR_WORKFLOW);\r\n    \r\n    // Try to parse the response as JSON\r\n    let generatedWorkflow: any;\r\n    try {\r\n      // Remove markdown code blocks if present\r\n      const cleanedResponse = llmResponse.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\r\n      generatedWorkflow = JSON.parse(cleanedResponse);\r\n    } catch (parseError: any) {\r\n      // If parsing fails, try to extract JSON from the response\r\n      const jsonMatch = llmResponse.match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) {\r\n        generatedWorkflow = JSON.parse(jsonMatch[0]);\r\n      } else {\r\n        throw new Error(`Failed to parse LLM response as JSON: ${parseError.message}`);\r\n      }\r\n    }\r\n    \r\n    // Validate that the generated workflow has the required structure\r\n    if (!generatedWorkflow.flowwiseWorkflow) {\r\n      throw new Error(\"Generated workflow missing 'flowwiseWorkflow' property\");\r\n    }\r\n    \r\n    return generatedWorkflow;\r\n  } catch (error: any) {\r\n    console.error(`\u274C [Workflow Generation] Error:`, error.message);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// LLM System Prompts\r\n// (LLM prompts moved to src/llm.ts)\r\nconst _LLM_QUERY_EXTRACTION_PROMPT_DEPRECATED = `\r\nYou are Eden Core AI query processor.\r\nExtract service query from user input.\r\nReturn JSON only with: query (object with serviceType and filters), serviceType, confidence.\r\n\r\nService types: \"movie\" or \"dex\"\r\n\r\nFor movie queries:\r\nExample: {\"query\": {\"serviceType\": \"movie\", \"filters\": {\"location\": \"Baltimore\", \"maxPrice\": 10}}, \"serviceType\": \"movie\", \"confidence\": 0.95}\r\n\r\nFor DEX token trading queries (BUY/SELL tokens):\r\n- tokenSymbol: The token being bought/sold (e.g., \"TOKENA\", \"TOKENB\", \"Token A\")\r\n  * If user says \"BUY token A\" or \"token A\", tokenSymbol = \"TOKENA\"\r\n  * If user says \"SOLANA token A\", tokenSymbol = \"TOKENA\" (token A is what's being traded)\r\n- baseToken: The currency used to buy/sell (e.g., \"SOL\", \"USDC\", \"SOLANA\")\r\n  * If user says \"BUY with SOL\" or \"SOLANA token A\", baseToken = \"SOL\" (SOL is the payment currency)\r\n- Extract action: \"BUY\" or \"SELL\"\r\n- Extract tokenAmount if specified\r\n- Extract maxPrice if specified (e.g., \"1 Token/SOL\" means price <= 1)\r\n\r\nIMPORTANT: In phrases like \"BUY 2 SOLANA token A\":\r\n- tokenSymbol = \"TOKENA\" (the token being bought)\r\n- baseToken = \"SOL\" (SOLANA/SOL is the currency used to buy)\r\n\r\nExample: {\"query\": {\"serviceType\": \"dex\", \"filters\": {\"tokenSymbol\": \"TOKENA\", \"baseToken\": \"SOL\", \"action\": \"BUY\", \"tokenAmount\": 2, \"maxPrice\": 1}}, \"serviceType\": \"dex\", \"confidence\": 0.95}\r\n`;\r\n\r\nconst _LLM_RESPONSE_FORMATTING_PROMPT_DEPRECATED = `\r\nYou are Eden Core AI response formatter.\r\nFormat service provider listings into user-friendly chat response.\r\n\r\nYour responsibilities depend on serviceType:\r\n\r\nFOR MOVIE SERVICE:\r\n1. Filter listings based on user query filters (e.g., maxPrice, genre, time, location)\r\n2. If maxPrice is \"best\" or \"lowest\", select listings with the lowest price\r\n3. If maxPrice is a number, only include listings with price <= maxPrice\r\n4. Apply other filters (genre, time, location) as specified\r\n5. Format the filtered results into a user-friendly message\r\n6. Select the best option based on user criteria (best price, best rating, etc.)\r\n\r\nIMPORTANT: When returning selectedListing, you MUST include ALL fields from the original listing, especially providerId (e.g., \"amc-001\", \"moviecom-001\", \"cinemark-001\").\r\n\r\nFOR DEX TOKEN SERVICE:\r\n1. Filter token pools based on tokenSymbol, baseToken, and action (BUY/SELL)\r\n2. If maxPrice is specified (e.g., \"1 Token/SOL\"), only include pools with price <= maxPrice\r\n3. If action is \"BUY\", find pools where user can buy tokens with baseToken\r\n4. If action is \"SELL\", find pools where user can sell tokens for baseToken\r\n5. Select the best pool based on price and liquidity\r\n6. Format the results showing: token symbol, price, liquidity, pool provider\r\n\r\nIMPORTANT: When returning selectedListing for DEX, you MUST include ALL fields: poolId, providerId, tokenSymbol, baseToken, price, liquidity, indexerId.\r\n\r\nReturn JSON with: message (string), listings (array of filtered listings), selectedListing (best option with ALL original fields including providerId/poolId, or null).\r\n`;\r\n\r\n// ROOT CA Service Registry Functions\r\n// ROOT CA manages the service registry - indexers query ROOT CA\r\n// (Service provider functions moved to src/serviceProvider.ts)\r\n\r\n// DEX Trading Functions\r\n// (executeDEXTrade moved to src/dex.ts)\r\nfunction _executeDEXTrade_DEPRECATED(\r\n  poolId: string,\r\n  action: 'BUY' | 'SELL',\r\n  tokenAmount: number,\r\n  userEmail: string\r\n): DEXTrade {\r\n  const pool = DEX_POOLS.get(poolId);\r\n  if (!pool) {\r\n    throw new Error(`Pool ${poolId} not found`);\r\n  }\r\n\r\n  // Step 1: Use ROOT CA liquidity as first liquidity source\r\n  // For BUY: User pays baseToken, gets tokens\r\n  // For SELL: User pays tokens, gets baseToken\r\n  \r\n  let baseAmount: number;\r\n  let newPrice: number;\r\n  \r\n  if (action === 'BUY') {\r\n    // User wants to BUY tokens with baseToken (SOL)\r\n    // Calculate baseToken needed using constant product formula: x * y = k\r\n    // After trade: (baseReserve + baseAmount) * (tokenReserve - tokenAmount) = baseReserve * tokenReserve\r\n    // Solving: baseAmount = (baseReserve * tokenAmount) / (tokenReserve - tokenAmount)\r\n    baseAmount = (pool.baseReserve * tokenAmount) / (pool.tokenReserve - tokenAmount);\r\n    \r\n    // Apply price impact (0.001% = 0.00001)\r\n    const priceImpact = PRICE_IMPACT_PER_TRADE;\r\n    baseAmount = baseAmount * (1 + priceImpact);\r\n    \r\n    // Update pool reserves\r\n    pool.baseReserve += baseAmount;\r\n    pool.tokenReserve -= tokenAmount;\r\n    \r\n    // Calculate new price\r\n    newPrice = pool.baseReserve / pool.tokenReserve;\r\n    pool.price = newPrice;\r\n    \r\n    // Increase pool value by 0.001%\r\n    pool.poolLiquidity *= (1 + PRICE_IMPACT_PER_TRADE);\r\n  } else {\r\n    // SELL: User wants to SELL tokens for baseToken\r\n    // Calculate baseToken received: baseAmount = (baseReserve * tokenAmount) / (tokenReserve + tokenAmount)\r\n    baseAmount = (pool.baseReserve * tokenAmount) / (pool.tokenReserve + tokenAmount);\r\n    \r\n    // Apply price impact\r\n    const priceImpact = PRICE_IMPACT_PER_TRADE;\r\n    baseAmount = baseAmount * (1 - priceImpact);\r\n    \r\n    // Update pool reserves\r\n    pool.baseReserve -= baseAmount;\r\n    pool.tokenReserve += tokenAmount;\r\n    \r\n    // Calculate new price\r\n    newPrice = pool.baseReserve / pool.tokenReserve;\r\n    pool.price = newPrice;\r\n    \r\n    // Increase pool value by 0.001%\r\n    pool.poolLiquidity *= (1 + PRICE_IMPACT_PER_TRADE);\r\n  }\r\n  \r\n  // Step 2: Calculate iTax (0.0005% commission)\r\n  const tradeValue = baseAmount; // Trade value in baseToken\r\n  let iTax = tradeValue * ITAX_RATE;\r\n  \r\n  // Apply Snake provider multiplier if pool provider is Snake\r\n  // DEX pool providers are registered with id like \"dex-pool-{tokenSymbol}\"\r\n  const poolProviderId = `dex-pool-${pool.tokenSymbol.toLowerCase()}`;\r\n  const poolProvider = ROOT_CA_SERVICE_REGISTRY.find(p => p.id === poolProviderId);\r\n  if (poolProvider?.providerType === 'SNAKE') {\r\n    const snakeITaxMultiplier = poolProvider.iTaxMultiplier || 2.0;\r\n    iTax = iTax * snakeITaxMultiplier;\r\n    console.log(`\uD83D\uDC0D [Snake Provider] Applied iTax multiplier: ${snakeITaxMultiplier}x for pool ${poolId}`);\r\n  }\r\n  \r\n  // Step 3: Distribute iTax (WIN-WIN-WIN)\r\n  const iTaxRootCA = iTax * ITAX_DISTRIBUTION.rootCA; // 40% to ROOT CA\r\n  const iTaxIndexer = iTax * ITAX_DISTRIBUTION.indexer; // 30% to indexer\r\n  const iTaxTrader = iTax * ITAX_DISTRIBUTION.trader; // 30% back to trader as rebate\r\n  \r\n  // Update ROOT CA liquidity (add iTax)\r\n  rootCALiquidity += iTaxRootCA;\r\n  \r\n  // Update pool stats\r\n  pool.totalVolume += tradeValue;\r\n  pool.totalTrades += 1;\r\n  \r\n  // Create trade record\r\n  const trade: DEXTrade = {\r\n    tradeId: crypto.randomUUID(),\r\n    poolId: pool.poolId,\r\n    tokenSymbol: pool.tokenSymbol,\r\n    baseToken: pool.baseToken,\r\n    action,\r\n    tokenAmount,\r\n    baseAmount,\r\n    price: newPrice,\r\n    priceImpact: PRICE_IMPACT_PER_TRADE,\r\n    iTax,\r\n    timestamp: Date.now(),\r\n    trader: userEmail,\r\n  };\r\n  \r\n  console.log(`\uD83D\uDCB0 [DEX] Trade executed: ${action} ${tokenAmount} ${pool.tokenSymbol} for ${baseAmount.toFixed(6)} ${pool.baseToken}`);\r\n  console.log(`   Price: ${newPrice.toFixed(6)} ${pool.baseToken}/${pool.tokenSymbol}`);\r\n  console.log(`   iTax: ${iTax.toFixed(6)} ${pool.baseToken}`);\r\n  console.log(`   Distribution: ROOT CA ${iTaxRootCA.toFixed(6)}, Indexer ${iTaxIndexer.toFixed(6)}, Trader ${iTaxTrader.toFixed(6)}`);\r\n  \r\n  // Broadcast DEX trade event\r\n  broadcastEvent({\r\n    type: \"dex_trade_executed\",\r\n    component: \"dex\",\r\n    message: `DEX Trade: ${action} ${tokenAmount} ${pool.tokenSymbol}`,\r\n    timestamp: Date.now(),\r\n    data: {\r\n      trade,\r\n      iTaxDistribution: {\r\n        rootCA: iTaxRootCA,\r\n        indexer: iTaxIndexer,\r\n        trader: iTaxTrader,\r\n      },\r\n      poolState: {\r\n        price: pool.price,\r\n        liquidity: pool.poolLiquidity,\r\n        totalVolume: pool.totalVolume,\r\n        totalTrades: pool.totalTrades,\r\n      },\r\n      rootCALiquidity: rootCALiquidity,\r\n    }\r\n  });\r\n  \r\n  return trade;\r\n}\r\n\r\n// iGas Calculation\r\n// (calculateIGas moved to src/dex.ts)\r\nfunction _calculateIGas_DEPRECATED(llmCalls: number, providersQueried: number, complexity: number = 1): number {\r\n  const llmCost = LLM_BASE_COST * llmCalls * complexity;\r\n  const routingCost = ROUTING_COST_PER_PROVIDER * providersQueried;\r\n  const reasoningCost = llmCost * REASONING_COST_MULTIPLIER;\r\n  return llmCost + routingCost + reasoningCost;\r\n}\r\n\r\n// LLM Resolution\r\n\r\n// OpenAI API Configuration\r\nconst OPENAI_API_KEY = process.env.OPENAI_API_KEY || \"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\";\r\nconst OPENAI_API_URL = \"https://api.openai.com/v1/chat/completions\";\r\n\r\n// OpenAI LLM Query Extraction\r\n// (extractQueryWithOpenAI moved to src/llm.ts)\r\nasync function _extractQueryWithOpenAI_DEPRECATED(userInput: string): Promise<LLMQueryResult> {\r\n  const messages = [\r\n    { role: \"system\", content: LLM_QUERY_EXTRACTION_PROMPT },\r\n    { role: \"user\", content: userInput },\r\n  ];\r\n  \r\n  const payload = JSON.stringify({\r\n    model: \"gpt-4o-mini\",\r\n    messages,\r\n    response_format: { type: \"json_object\" },\r\n    temperature: 0.7,\r\n  });\r\n\r\n  // Broadcast LLM interaction start\r\n  broadcastEvent({\r\n    type: \"llm_query_extraction_start\",\r\n    component: \"llm\",\r\n    message: \"Starting LLM query extraction...\",\r\n    timestamp: Date.now(),\r\n    data: {\r\n      provider: \"openai\",\r\n      model: \"gpt-4o-mini\",\r\n      systemPrompt: LLM_QUERY_EXTRACTION_PROMPT,\r\n      userInput: userInput,\r\n      messages: messages\r\n    }\r\n  });\r\n\r\n  return new Promise<LLMQueryResult>((resolve, reject) => {\r\n    const req = https.request(\r\n      {\r\n        hostname: \"api.openai.com\",\r\n        port: 443,\r\n        path: \"/v1/chat/completions\",\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          \"Authorization\": `Bearer ${OPENAI_API_KEY}`,\r\n          \"Content-Length\": payload.length,\r\n        },\r\n      },\r\n      (res) => {\r\n        let data = \"\";\r\n        res.on(\"data\", (c) => (data += c));\r\n        res.on(\"end\", () => {\r\n          try {\r\n            const parsed = JSON.parse(data);\r\n            if (parsed.error) {\r\n              broadcastEvent({\r\n                type: \"llm_error\",\r\n                component: \"llm\",\r\n                message: \"OpenAI API error\",\r\n                timestamp: Date.now(),\r\n                data: {\r\n                  provider: \"openai\",\r\n                  error: parsed.error.message || JSON.stringify(parsed.error),\r\n                  rawResponse: data\r\n                }\r\n              });\r\n              reject(new Error(`OpenAI API error: ${parsed.error.message || JSON.stringify(parsed.error)}`));\r\n              return;\r\n            }\r\n            if (parsed.choices && parsed.choices[0] && parsed.choices[0].message) {\r\n              const content = JSON.parse(parsed.choices[0].message.content);\r\n              const result = {\r\n                query: content.query || { serviceType: \"movie\", filters: {} },\r\n                serviceType: content.serviceType || \"movie\",\r\n                confidence: content.confidence || 0.9,\r\n              };\r\n              \r\n              // Broadcast LLM response\r\n              broadcastEvent({\r\n                type: \"llm_query_extraction_response\",\r\n                component: \"llm\",\r\n                message: \"LLM query extraction completed\",\r\n                timestamp: Date.now(),\r\n                data: {\r\n                  provider: \"openai\",\r\n                  model: \"gpt-4o-mini\",\r\n                  response: parsed,\r\n                  extractedQuery: result\r\n                }\r\n              });\r\n              \r\n              resolve(result);\r\n            } else {\r\n              broadcastEvent({\r\n                type: \"llm_error\",\r\n                component: \"llm\",\r\n                message: \"Invalid OpenAI response format\",\r\n                timestamp: Date.now(),\r\n                data: {\r\n                  provider: \"openai\",\r\n                  error: \"Invalid response format\",\r\n                  rawResponse: data\r\n                }\r\n              });\r\n              reject(new Error(\"Invalid OpenAI response format\"));\r\n            }\r\n          } catch (err: any) {\r\n            broadcastEvent({\r\n              type: \"llm_error\",\r\n              component: \"llm\",\r\n              message: \"Failed to parse OpenAI response\",\r\n              timestamp: Date.now(),\r\n              data: {\r\n                provider: \"openai\",\r\n                error: err.message,\r\n                rawResponse: data\r\n              }\r\n            });\r\n            reject(new Error(`Failed to parse OpenAI response: ${err.message}`));\r\n          }\r\n        });\r\n      }\r\n    );\r\n    req.on(\"error\", (err) => {\r\n      reject(new Error(`OpenAI request failed: ${err.message}`));\r\n    });\r\n    req.write(payload);\r\n    req.end();\r\n  });\r\n}\r\n\r\n// REMOVED: Duplicate formatResponseWithOpenAI function - now using imported version from ./src/llm\r\n// The imported function has full debugging and selectedListing2 support\r\n\r\n// DeepSeek LLM Query Extraction (Legacy)\r\nasync function extractQueryWithDeepSeek(userInput: string): Promise<LLMQueryResult> {\r\n  const messages = [\r\n    { role: \"system\", content: LLM_QUERY_EXTRACTION_PROMPT },\r\n    { role: \"user\", content: userInput },\r\n  ];\r\n  \r\n  const payload = JSON.stringify({\r\n    model: \"deepseek-r1\",\r\n    messages,\r\n    stream: false,\r\n  });\r\n\r\n  // Broadcast LLM interaction start\r\n  broadcastEvent({\r\n    type: \"llm_query_extraction_start\",\r\n    component: \"llm\",\r\n    message: \"Starting LLM query extraction...\",\r\n    timestamp: Date.now(),\r\n    data: {\r\n      provider: \"deepseek\",\r\n      model: \"deepseek-r1\",\r\n      systemPrompt: LLM_QUERY_EXTRACTION_PROMPT,\r\n      userInput: userInput,\r\n      messages: messages\r\n    }\r\n  });\r\n\r\n  return new Promise<LLMQueryResult>((resolve, reject) => {\r\n    const req = http.request(\r\n      { hostname: \"localhost\", port: 11434, path: \"/api/chat\", method: \"POST\" },\r\n      (res) => {\r\n        let data = \"\";\r\n        res.on(\"data\", (c) => (data += c));\r\n        res.on(\"end\", () => {\r\n          try {\r\n            const parsed = JSON.parse(data);\r\n            const result = {\r\n              query: parsed.query || { serviceType: \"movie\", filters: {} },\r\n              serviceType: parsed.serviceType || \"movie\",\r\n              confidence: parsed.confidence || 0.9,\r\n            };\r\n            \r\n            // Broadcast LLM response\r\n            broadcastEvent({\r\n              type: \"llm_query_extraction_response\",\r\n              component: \"llm\",\r\n              message: \"LLM query extraction completed\",\r\n              timestamp: Date.now(),\r\n              data: {\r\n                provider: \"deepseek\",\r\n                model: \"deepseek-r1\",\r\n                response: parsed,\r\n                extractedQuery: result\r\n              }\r\n            });\r\n            \r\n            resolve(result);\r\n          } catch (err) {\r\n            broadcastEvent({\r\n              type: \"llm_error\",\r\n              component: \"llm\",\r\n              message: \"Failed to parse DeepSeek response\",\r\n              timestamp: Date.now(),\r\n              data: {\r\n                provider: \"deepseek\",\r\n                error: err instanceof Error ? err.message : \"Unknown error\",\r\n                rawResponse: data\r\n              }\r\n            });\r\n            reject(new Error(\"Failed to parse DeepSeek response\"));\r\n          }\r\n        });\r\n      }\r\n    );\r\n    req.on(\"error\", reject);\r\n    req.write(payload);\r\n    req.end();\r\n  });\r\n}\r\n\r\n// REMOVED: Duplicate formatResponseWithDeepSeek function - now using imported version from ./src/llm\r\n// The imported function has full debugging and selectedListing2 support\r\n// Entire duplicate function body removed (was ~170 lines)\r\n\r\n// Main LLM Resolution with ServiceRegistry architecture\r\n// \r\n// OPTIMIZATION NOTE (v2): Currently extracts query intent twice:\r\n//   1. Here in resolveLLM() - extracts serviceType, filters, etc.\r\n//   2. Later in processChatInput() for DEX trades - re-extracts to get action/tokenAmount\r\n// Future optimization: Cache intent hash (e.g., hash(userInput + timestamp)) and skip \r\n// re-extraction unless user confirms/modifies query. This would reduce LLM calls by ~50% \r\n// for DEX trades and improve latency.\r\n//\r\n// COMMENTED OUT: This function is a duplicate and bypasses the updated formatResponseWithOpenAI\r\n// that has hardcoded DEX mock data. Use formatResponseWithOpenAI/formatResponseWithDeepSeek directly instead.\r\n/*\r\nasync function resolveLLM(userInput: string): Promise<LLMResponse> {\r\n  if (MOCKED_LLM) {\r\n    // Mock response for testing\r\n    const mockListing: MovieListing = {\r\n      providerId: \"amc-001\",\r\n      providerName: \"AMC Theatres\",\r\n      movieTitle: \"Back to the Future\",\r\n      movieId: \"back-to-future-1\",\r\n      price: 2.0,\r\n      showtime: \"10:30 PM\",\r\n      location: \"Baltimore, Maryland\",\r\n      reviewCount: 100,\r\n      rating: 5.0,\r\n      gardenId: ROOT_CA_SERVICE_REGISTRY.find(p => p.id === \"amc-001\")?.gardenId || \"HG\"\r\n    };\r\n    return {\r\n      message: \"5 stars movie provider AMC in indexer A, Baltimore, Maryland offers 2 USDC for 'Back to the Future' at 10:30 PM and 100 viewers already reviewed the AMC viewing service\",\r\n      listings: [mockListing],\r\n      selectedListing: mockListing,\r\n      iGasCost: calculateIGas(2, 1, 1),\r\n    };\r\n  }\r\n\r\n  let llmCalls = 0;\r\n  let extractQueryFn: (input: string) => Promise<LLMQueryResult>;\r\n  let formatResponseFn: (listings: MovieListing[] | TokenListing[], query: string, filters?: { maxPrice?: number | string; genre?: string; time?: string; location?: string; tokenSymbol?: string; baseToken?: string; action?: 'BUY' | 'SELL' }) => Promise<LLMResponse>;\r\n\r\n  // Choose LLM provider\r\n  if (ENABLE_OPENAI) {\r\n    console.log(\"\uD83E\uDD16 Using OpenAI as primary LLM provider\");\r\n    extractQueryFn = extractQueryWithOpenAI;\r\n    formatResponseFn = formatResponseWithOpenAI;\r\n  } else {\r\n    console.log(\"\uD83E\uDD16 Using DeepSeek as LLM provider\");\r\n    extractQueryFn = extractQueryWithDeepSeek;\r\n    formatResponseFn = formatResponseWithDeepSeek;\r\n  }\r\n\r\n  try {\r\n    // Step 1: Extract query from user input using LLM\r\n    llmCalls++;\r\n    console.log(`\uD83E\uDD16 [LLM] Starting query extraction for: \"${userInput.substring(0, 50)}${userInput.length > 50 ? '...' : ''}\"`);\r\n    let queryResult = await extractQueryFn(userInput);\r\n    console.log(`\uD83D\uDCCB [LLM] Extracted query:`, queryResult);\r\n    \r\n    // VALIDATION: Check for misclassification (movie queries incorrectly classified as DEX)\r\n    const userInputLower = userInput.toLowerCase();\r\n    const movieKeywords = ['movie', 'ticket', 'tickets', 'cinema', 'theater', 'theatre', 'film', 'watch', 'showtime', 'show', 'amc', 'cinemark', 'moviecom'];\r\n    const dexKeywords = ['token', 'tokena', 'tokenb', 'tokenc', 'tokend', 'dex', 'pool', 'trade'];\r\n    \r\n    const hasMovieKeywords = movieKeywords.some(keyword => userInputLower.includes(keyword));\r\n    const hasDexKeywords = dexKeywords.some(keyword => userInputLower.includes(keyword));\r\n    \r\n    // If classified as DEX but has movie keywords and NO explicit token/DEX keywords, correct to movie\r\n    let wasCorrected = false;\r\n    if (queryResult.serviceType === \"dex\" && hasMovieKeywords && !hasDexKeywords) {\r\n      console.log(`\u26A0\uFE0F  [VALIDATION] Correcting misclassification: DEX \u2192 MOVIE`);\r\n      console.log(`   User input: \"${userInput}\"`);\r\n      console.log(`   Detected movie keywords but was classified as DEX`);\r\n      queryResult.serviceType = \"movie\";\r\n      queryResult.query.serviceType = \"movie\";\r\n      wasCorrected = true;\r\n      // Clear DEX-specific filters\r\n      if (queryResult.query.filters) {\r\n        delete queryResult.query.filters.tokenSymbol;\r\n        delete queryResult.query.filters.baseToken;\r\n        delete queryResult.query.filters.action;\r\n        delete queryResult.query.filters.tokenAmount;\r\n      }\r\n    }\r\n    \r\n    // Normalize DEX query extraction (fix common LLM mistakes)\r\n    if (queryResult.serviceType === \"dex\" && queryResult.query.filters) {\r\n      const filters = queryResult.query.filters;\r\n      const userInputLower = userInput.toLowerCase();\r\n      \r\n      // Common mistake: LLM extracts \"SOLANA\" as tokenSymbol when user says \"SOLANA token A\"\r\n      // Fix: If tokenSymbol looks like a base currency (SOL, SOLANA, USDC) and baseToken looks like a token (TOKENA, TOKENB),\r\n      //      swap them and normalize tokenSymbol to match pool format (TOKENA, TOKENB, etc.)\r\n      if (filters.tokenSymbol && filters.baseToken) {\r\n        const tokenSymbolUpper = filters.tokenSymbol.toUpperCase();\r\n        const baseTokenUpper = filters.baseToken.toUpperCase();\r\n        \r\n        // Check if tokenSymbol is actually a base currency\r\n        const baseCurrencies = ['SOL', 'SOLANA', 'USDC', 'USD', 'ETH', 'BTC'];\r\n        const tokenPatterns = ['TOKENA', 'TOKENB', 'TOKENC', 'TOKEND', 'TOKEN'];\r\n        \r\n        const tokenSymbolIsBaseCurrency = baseCurrencies.some(bc => tokenSymbolUpper.includes(bc));\r\n        const baseTokenIsToken = tokenPatterns.some(tp => baseTokenUpper.includes(tp));\r\n        \r\n        if (tokenSymbolIsBaseCurrency && baseTokenIsToken) {\r\n          console.log(`\u26A0\uFE0F  [LLM] Detected swapped extraction: tokenSymbol=\"${filters.tokenSymbol}\", baseToken=\"${filters.baseToken}\"`);\r\n          console.log(`   Correcting: tokenSymbol=\"${filters.baseToken}\", baseToken=\"${filters.tokenSymbol}\"`);\r\n          \r\n          // Swap them\r\n          const temp = filters.tokenSymbol;\r\n          filters.tokenSymbol = filters.baseToken;\r\n          filters.baseToken = temp;\r\n        }\r\n        \r\n        // Normalize tokenSymbol to match pool format (TOKENA, TOKENB, etc.)\r\n        if (filters.tokenSymbol) {\r\n          const tokenSymbolLower = filters.tokenSymbol.toLowerCase();\r\n          if (tokenSymbolLower.includes('token a') || tokenSymbolLower.includes('tokena')) {\r\n            filters.tokenSymbol = 'TOKENA';\r\n          } else if (tokenSymbolLower.includes('token b') || tokenSymbolLower.includes('tokenb')) {\r\n            filters.tokenSymbol = 'TOKENB';\r\n          } else if (tokenSymbolLower.includes('token c') || tokenSymbolLower.includes('tokenc')) {\r\n            filters.tokenSymbol = 'TOKENC';\r\n          } else if (tokenSymbolLower.includes('token d') || tokenSymbolLower.includes('tokend')) {\r\n            filters.tokenSymbol = 'TOKEND';\r\n          }\r\n        }\r\n        \r\n        // Normalize baseToken (SOLANA -> SOL)\r\n        if (filters.baseToken) {\r\n          const baseTokenLower = filters.baseToken.toLowerCase();\r\n          if (baseTokenLower.includes('solana') || baseTokenLower.includes('sol')) {\r\n            filters.baseToken = 'SOL';\r\n          }\r\n        }\r\n      }\r\n      \r\n      console.log(`\uD83D\uDCCB [LLM] Normalized query:`, queryResult);\r\n    }\r\n\r\n    // Step 2: Query ServiceRegistry\r\n    // Step 2: Query ROOT CA Service Registry (post-LLM in-memory lookup)\r\n    // Indexers query ROOT CA for services - ROOT CA is the single source of truth\r\n    broadcastEvent({\r\n      type: \"service_registry_query\",\r\n      component: \"root-ca\",\r\n      message: \"Querying ROOT CA Service Registry...\",\r\n      timestamp: Date.now()\r\n    });\r\n    \r\n    const providers = queryROOTCAServiceRegistry(queryResult.query);\r\n    console.log(`\uD83D\uDD0D [ROOT CA] Found ${providers.length} service providers`);\r\n    \r\n    // Also query Snake services if serviceType is \"movie\" (for advertising context)\r\n    // Snake is a service type (serviceType: \"snake\"), each Snake service belongs to an indexer\r\n    let snakeProviders: ServiceProvider[] = [];\r\n    if (queryResult.serviceType === \"movie\") {\r\n      snakeProviders = queryROOTCAServiceRegistry({\r\n        serviceType: \"snake\", // Query Snake services (serviceType: \"snake\")\r\n        filters: queryResult.query.filters\r\n      });\r\n      // Filter Snake services by allowed contexts\r\n      snakeProviders = snakeProviders.filter(sp => \r\n        sp.contextsAllowed?.includes(\"movies\") || sp.contextsAllowed?.includes(\"entertainment\")\r\n      );\r\n      console.log(`\uD83D\uDC0D [ROOT CA] Found ${snakeProviders.length} Snake services for movie context`);\r\n    }\r\n    \r\n    if (queryResult.serviceType === \"dex\") {\r\n      console.log(`   DEX Providers: ${providers.map(p => `${p.id} (garden: ${p.gardenId})`).join(\", \")}`);\r\n      console.log(`   Available DEX Pools: ${Array.from(DEX_POOLS.values()).map(p => `${p.tokenSymbol} (${p.gardenId})`).join(\", \")}`);\r\n    }\r\n    \r\n    const allProviders = [...providers, ...snakeProviders];\r\n    \r\n    broadcastEvent({\r\n      type: \"service_registry_result\",\r\n      component: \"root-ca\",\r\n      message: `Found ${allProviders.length} service providers (${providers.length} regular, ${snakeProviders.length} Snake)`,\r\n      timestamp: Date.now(),\r\n      data: { \r\n        providers: allProviders.map(p => ({ \r\n          id: p.id, \r\n          name: p.name,\r\n          serviceType: p.serviceType,\r\n          isSnake: p.serviceType === 'snake',\r\n          gardenId: p.gardenId // Each service belongs to a garden\r\n        })) \r\n      }\r\n    });\r\n\r\n    if (allProviders.length === 0) {\r\n      throw new Error(\"No service providers found matching query\");\r\n    }\r\n\r\n    // Step 3: Query service providers' external APIs for actual data (prices, showtimes)\r\n    allProviders.forEach(provider => {\r\n      const serviceTypeLabel = provider.serviceType === 'snake' ? '\uD83D\uDC0D Snake' : 'Regular';\r\n      broadcastEvent({\r\n        type: \"provider_api_query\",\r\n        component: provider.id,\r\n        message: `${serviceTypeLabel} Querying ${provider.name} API...`,\r\n        timestamp: Date.now()\r\n      });\r\n    });\r\n    \r\n    const listings = await queryServiceProviders(allProviders, {\r\n      genre: queryResult.query.filters?.genre,\r\n      time: queryResult.query.filters?.time,\r\n      tokenSymbol: queryResult.query.filters?.tokenSymbol,\r\n      baseToken: queryResult.query.filters?.baseToken,\r\n      action: queryResult.query.filters?.action,\r\n    });\r\n    \r\n    if (queryResult.serviceType === \"dex\") {\r\n      console.log(`\uD83C\uDF0A Found ${listings.length} DEX pool listings`);\r\n    } else {\r\n      console.log(`\uD83C\uDFAC Found ${listings.length} movie listings from provider APIs`);\r\n    }\r\n    \r\n    allProviders.forEach(provider => {\r\n      const providerListings = listings.filter((l: any) => l.providerId === provider.id);\r\n      const serviceTypeLabel = provider.serviceType === 'snake' ? '\uD83D\uDC0D Snake' : 'Regular';\r\n      broadcastEvent({\r\n        type: \"provider_api_result\",\r\n        component: provider.id,\r\n        message: `${serviceTypeLabel} ${provider.name} returned ${providerListings.length} listings`,\r\n        timestamp: Date.now(),\r\n        data: { \r\n          listings: providerListings,\r\n          serviceType: provider.serviceType,\r\n          isSnake: provider.serviceType === 'snake',\r\n          indexerId: provider.gardenId // Legacy field (will be renamed to gardenId in future)\r\n        }\r\n      });\r\n    });\r\n\r\n    if (listings.length === 0) {\r\n      const errorMsg = queryResult.serviceType === \"dex\" \r\n        ? \"No DEX pools found from service providers\"\r\n        : \"No movie listings found from service providers\";\r\n      throw new Error(errorMsg);\r\n    }\r\n\r\n    // VALIDATION: Filter listings to match serviceType (prevent DEX listings when serviceType is \"movie\")\r\n    let filteredListings = listings;\r\n    if (queryResult.serviceType === \"movie\") {\r\n      // Remove any DEX listings (TokenListings) - only keep MovieListings\r\n      filteredListings = listings.filter((listing: any) => {\r\n        const isTokenListing = 'poolId' in listing || 'tokenSymbol' in listing;\r\n        if (isTokenListing) {\r\n          console.log(`\u26A0\uFE0F  [VALIDATION] Filtering out DEX listing from movie query: ${listing.providerId || listing.poolId}`);\r\n        }\r\n        return !isTokenListing; // Keep only non-DEX listings\r\n      });\r\n      \r\n      if (filteredListings.length === 0 && listings.length > 0) {\r\n        throw new Error(\"No movie listings found - all results were DEX token listings. This indicates a classification error.\");\r\n      }\r\n      \r\n      console.log(`\u2705 [VALIDATION] Filtered to ${filteredListings.length} movie listings (removed ${listings.length - filteredListings.length} DEX listings)`);\r\n    } else if (queryResult.serviceType === \"dex\") {\r\n      // Remove any MovieListings - only keep TokenListings\r\n      filteredListings = listings.filter((listing: any) => {\r\n        const isTokenListing = 'poolId' in listing || 'tokenSymbol' in listing;\r\n        return isTokenListing; // Keep only DEX listings\r\n      });\r\n      \r\n      if (filteredListings.length === 0 && listings.length > 0) {\r\n        throw new Error(\"No DEX listings found - all results were movie listings. This indicates a classification error.\");\r\n      }\r\n    }\r\n\r\n    // Step 4: Format response using LLM (LLM will handle filtering based on query filters)\r\n    llmCalls++;\r\n    console.log(`\uD83E\uDD16 [LLM] Starting response formatting for ${filteredListings.length} listings (serviceType: ${queryResult.serviceType})`);\r\n    const formattedResponse = await formatResponseFn(filteredListings as MovieListing[], userInput, queryResult.query.filters);\r\n    console.log(`\u2705 [LLM] Response formatted: ${formattedResponse.message.substring(0, 100)}${formattedResponse.message.length > 100 ? '...' : ''}`);\r\n\r\n    // VALIDATION: Ensure selectedListing matches serviceType\r\n    if (formattedResponse.selectedListing) {\r\n      const isTokenListing = 'poolId' in formattedResponse.selectedListing || 'tokenSymbol' in formattedResponse.selectedListing;\r\n      if (queryResult.serviceType === \"movie\" && isTokenListing) {\r\n        const errorMsg = `\u274C [VALIDATION ERROR] LLM formatter returned DEX listing for movie query. User input: \"${userInput}\"`;\r\n        console.error(errorMsg);\r\n        throw new Error(\"LLM formatter error: Selected DEX token listing for movie query. Please try again.\");\r\n      }\r\n      if (queryResult.serviceType === \"dex\" && !isTokenListing) {\r\n        const errorMsg = `\u274C [VALIDATION ERROR] LLM formatter returned movie listing for DEX query. User input: \"${userInput}\"`;\r\n        console.error(errorMsg);\r\n        throw new Error(\"LLM formatter error: Selected movie listing for DEX query. Please try again.\");\r\n      }\r\n    }\r\n\r\n    // Step 5: Calculate iGas\r\n    let iGas = calculateIGas(llmCalls, allProviders.length, queryResult.confidence);\r\n    \r\n    // Apply Snake service multipliers if any provider is a Snake service\r\n    // Snake is a service type (serviceType: \"snake\"), each belongs to an indexer\r\n    const hasSnakeService = allProviders.some(p => p.serviceType === 'snake');\r\n    if (hasSnakeService) {\r\n      // Find the highest multiplier among Snake services (use max multiplier)\r\n      const maxIGasMultiplier = Math.max(...allProviders\r\n        .filter(p => p.serviceType === 'snake')\r\n        .map(p => p.iGasMultiplier || 1.0), 1.0);\r\n      iGas = iGas * maxIGasMultiplier;\r\n      console.log(`\uD83D\uDC0D [Snake Service] Applied iGas multiplier: ${maxIGasMultiplier}x`);\r\n    }\r\n    \r\n    formattedResponse.iGasCost = iGas;\r\n\r\n    console.log(`\u26FD iGas calculated: ${iGas.toFixed(6)}`);\r\n\r\n    return formattedResponse;\r\n  } catch (err: any) {\r\n    // Fallback to OpenAI if DeepSeek was used and failed\r\n    if (!ENABLE_OPENAI) {\r\n      console.warn(`\u26A0\uFE0F  DeepSeek failed: ${err.message}, trying OpenAI fallback`);\r\n      try {\r\n        extractQueryFn = extractQueryWithOpenAI;\r\n        formatResponseFn = formatResponseWithOpenAI;\r\n        ENABLE_OPENAI; // This won't work, need to retry with OpenAI\r\n        // Retry logic would go here\r\n        throw err; // For now, just throw\r\n      } catch (fallbackErr: any) {\r\n        throw new Error(`Both LLM providers failed. Original: ${err.message}`);\r\n      }\r\n    }\r\n    throw err;\r\n  }\r\n}\r\n*/\r\n\r\n// Ledger Component - Tracks all Eden bookings\r\n\r\n// ============================================================================\r\n// JesusCoin Wallet Service (Holy Ghost - Single Source of Truth)\r\n// ============================================================================\r\n// Wallet is Redis-backed, authoritative, event-sourced\r\n// EdenCore submits intents, Wallet decides and updates balances\r\n// Ledger records outcomes but does not define truth\r\n// (Wallet functions moved to src/wallet.ts)\r\n\r\n// Mint JesusCoin (JSC) - Via Stripe Payment Rail Service Provider (Holy Ghost indexer)\r\n// This is called when Stripe payment is confirmed via webhook\r\n// Stripe is registered as a payment-rail service provider under Holy Ghost\r\n// Stores Stripe customer ID, payment method ID, and payment intent ID in ledger for webhook querying\r\n// Register a new movie indexer after Stripe payment\r\n// CRITICAL: In ROOT mode, this function should NOT be called - all indexers are created via Angular wizard\r\n// (registerNewMovieGarden moved to src/garden.ts)\r\n\r\nasync function mintJSC(\r\n  email: string, \r\n  amount: number, \r\n  stripePaymentIntentId: string,\r\n  stripeCustomerId?: string | null,\r\n  stripePaymentMethodId?: string | null,\r\n  stripeSessionId?: string\r\n): Promise<void> {\r\n  // Find Stripe payment rail service provider\r\n  const stripeProvider = ROOT_CA_SERVICE_REGISTRY.find(p => p.id === \"stripe-payment-rail-001\");\r\n  const providerUuid = stripeProvider?.uuid || ROOT_CA_UUID;\r\n  \r\n  console.log(`\uD83D\uDCB0 [Stripe Payment Rail] Minting ${amount} \uD83C\uDF4E APPLES for ${email} (Stripe: ${stripePaymentIntentId})`);\r\n  \r\n  // Find or create user (for backward compatibility)\r\n  let user = USERS.find(u => u.email === email);\r\n  if (!user) {\r\n    user = {\r\n      id: `u${USERS.length + 1}`,\r\n      email: email,\r\n      balance: 0,\r\n    };\r\n    USERS.push(user);\r\n    console.log(`   \u2705 Created new user: ${email}`);\r\n  }\r\n  \r\n  // Mint JSC via Wallet Service (authoritative source)\r\n  const walletResult = await creditWallet(\r\n    email,\r\n    amount,\r\n    crypto.randomUUID(),\r\n    `Stripe payment confirmed: ${stripePaymentIntentId}`,\r\n    { stripePaymentIntentId, serviceProvider: \"stripe-payment-rail-001\" }\r\n  );\r\n  \r\n  if (!walletResult.success) {\r\n    throw new Error(`Failed to mint JSC: ${walletResult.error}`);\r\n  }\r\n  \r\n  // Update user balance for backward compatibility (wallet is source of truth)\r\n  user.balance = walletResult.balance;\r\n  \r\n  console.log(`\u2705 [Stripe Payment Rail] Wallet updated successfully`);\r\n  console.log(`   Email: ${email}`);\r\n  console.log(`   Amount credited: ${amount} \uD83C\uDF4E APPLES`);\r\n  console.log(`   Final wallet balance: ${walletResult.balance} \uD83C\uDF4E APPLES`);\r\n  console.log(`   User.balance synced: ${user.balance} \uD83C\uDF4E APPLES`);\r\n  \r\n  // Verify balance was actually updated in Redis\r\n  if (!SKIP_REDIS && redis.isOpen) {\r\n    try {\r\n      await ensureRedisConnection();\r\n      const verifyBalance = await redis.get(`${WALLET_BALANCE_PREFIX}${email}`);\r\n      console.log(`   \u2705 Verification: Redis wallet balance = ${verifyBalance || 'NOT FOUND'} JSC`);\r\n      if (verifyBalance && parseFloat(verifyBalance) !== walletResult.balance) {\r\n        console.error(`   \u274C MISMATCH: Redis balance (${verifyBalance}) != walletResult.balance (${walletResult.balance})`);\r\n      }\r\n    } catch (err: any) {\r\n      console.warn(`   \u26A0\uFE0F  Could not verify Redis balance:`, err.message);\r\n    }\r\n  }\r\n  \r\n  // Create MINT ledger entry\r\n  const snapshot: TransactionSnapshot = {\r\n    chainId: CHAIN_ID,\r\n    txId: crypto.randomUUID(),\r\n    slot: Date.now(),\r\n    blockTime: Date.now(),\r\n    payer: `stripe:${stripePaymentIntentId}`,\r\n    merchant: email,\r\n    amount: amount,\r\n    feeSplit: {},\r\n  };\r\n  \r\n  const entry: LedgerEntry = {\r\n    entryId: crypto.randomUUID(),\r\n    txId: snapshot.txId,\r\n    timestamp: snapshot.blockTime,\r\n    payer: `stripe:${stripePaymentIntentId}`,\r\n    payerId: stripePaymentIntentId,\r\n    merchant: email,\r\n    providerUuid: providerUuid, // Stripe Payment Rail Service Provider UUID\r\n    serviceType: 'mint',\r\n    amount: amount,\r\n    iGasCost: 0, // No iGas for minting (it's a deposit)\r\n    fees: {},\r\n    status: 'completed', // Mints are immediately completed\r\n    cashierId: 'stripe-payment-rail-001', // Stripe Payment Rail Service Provider\r\n    bookingDetails: {\r\n      asset: 'JSC',\r\n      stripePaymentIntentId: stripePaymentIntentId,\r\n      stripeCustomerId: stripeCustomerId || undefined,\r\n      stripePaymentMethodId: stripePaymentMethodId || undefined,\r\n      stripeSessionId: stripeSessionId || undefined,\r\n    },\r\n  };\r\n  \r\n  // Add to ledger\r\n  LEDGER.push(entry);\r\n  \r\n  // Persist ledger entry\r\n  redis.saveLedgerEntries(LEDGER);\r\n  \r\n  console.log(`   \u2705 \uD83C\uDF4E APPLES minted: ${amount} \uD83C\uDF4E APPLES added to ${email} balance (new balance: ${walletResult.balance} \uD83C\uDF4E APPLES)`);\r\n  \r\n  // Broadcast events\r\n  broadcastEvent({\r\n    type: \"jsc_minted\",\r\n    component: \"stripe-payment-rail-001\",\r\n    message: `\uD83C\uDF4E APPLES minted via Stripe Payment Rail: ${amount} \uD83C\uDF4E APPLES for ${email}`,\r\n    timestamp: Date.now(),\r\n    data: {\r\n      email,\r\n      amount,\r\n      balance: walletResult.balance,\r\n      stripePaymentIntentId,\r\n      stripeCustomerId: stripeCustomerId || null,\r\n      stripePaymentMethodId: stripePaymentMethodId || null,\r\n      stripeSessionId: stripeSessionId || null,\r\n      entryId: entry.entryId,\r\n      providerId: \"stripe-payment-rail-001\",\r\n      indexerId: \"HG\", // Holy Ghost indexer\r\n    }\r\n  });\r\n  \r\n  broadcastEvent({\r\n    type: \"ledger_entry_added\",\r\n    component: \"ledger\",\r\n    message: `MINT ledger entry created: ${entry.entryId}`,\r\n    timestamp: Date.now(),\r\n    data: { entry }\r\n  });\r\n}\r\n\r\n// (addLedgerEntry moved to src/ledger.ts)\r\nfunction _addLedgerEntry_DEPRECATED(\r\n  snapshot: TransactionSnapshot,\r\n  serviceType: string,\r\n  iGasCost: number,\r\n  payerId: string,\r\n  merchantName: string, // Provider name (e.g., \"AMC Theatres\")\r\n  providerUuid: string, // Service provider UUID for certificate issuance\r\n  bookingDetails?: Record<string, any> // Generic booking details - service-type agnostic\r\n): LedgerEntry {\r\n  // payerId should be the email address (same as payer)\r\n  if (!providerUuid) {\r\n    console.error(`\u274C Provider UUID is missing for merchant: ${merchantName}`);\r\n  }\r\n  \r\n  const entry: LedgerEntry = {\r\n    entryId: crypto.randomUUID(),\r\n    txId: snapshot.txId,\r\n    timestamp: snapshot.blockTime,\r\n    payer: snapshot.payer, // Email address\r\n    payerId: snapshot.payer, // Email address (same as payer)\r\n    merchant: merchantName, // Provider name (e.g., \"AMC Theatres\", \"MovieCom\", \"Cinemark\")\r\n    providerUuid: providerUuid || 'MISSING-UUID', // Service provider UUID for certificate issuance\r\n    serviceType: serviceType,\r\n    amount: snapshot.amount,\r\n    iGasCost: iGasCost,\r\n    fees: snapshot.feeSplit,\r\n    status: 'pending',\r\n    cashierId: getCashierStatus().id,\r\n    bookingDetails: bookingDetails,\r\n  };\r\n  \r\n  console.log(`\uD83D\uDCDD Ledger entry created with providerUuid: ${entry.providerUuid}`);\r\n\r\n  // Push ledger entry to local ledger (for immediate access)\r\n  LEDGER.push(entry);\r\n  \r\n  // Persist ledger entry\r\n  redis.saveLedgerEntries(LEDGER);\r\n  \r\n  // ARCHITECTURAL PATTERN: Ledger Push + Settlement Pull\r\n  // Indexers EXECUTE transactions but never SETTLE them\r\n  // Push ledger entry to ROOT CA Redis Stream for settlement\r\n  pushLedgerEntryToSettlementStream(entry).catch(err => {\r\n    console.error(`\u26A0\uFE0F  Failed to push ledger entry to settlement stream:`, err.message);\r\n    // Continue execution - settlement will retry\r\n  });\r\n  \r\n  broadcastEvent({\r\n    type: \"ledger_entry_added\",\r\n    component: \"ledger\",\r\n    message: `Ledger entry created: ${entry.entryId}`,\r\n    timestamp: Date.now(),\r\n    data: { entry }\r\n  });\r\n\r\n  return entry;\r\n}\r\n\r\n// Push ledger entry to ROOT CA settlement stream\r\n// This is the ONLY way indexers interact with settlement\r\n// Indexers EXECUTE but never SETTLE\r\nasync function pushLedgerEntryToSettlementStream(entry: LedgerEntry): Promise<void> {\r\n  if (SKIP_REDIS || !redis.isOpen) {\r\n    console.log(`\uD83D\uDCE4 [Settlement] Ledger entry ${entry.entryId} queued (Redis disabled)`);\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await ensureRedisConnection();\r\n    \r\n    // Calculate fees breakdown\r\n    const iGas = entry.iGasCost;\r\n    const iTax = entry.bookingDetails?.iTax || 0;\r\n    \r\n    // Calculate fee distribution (from snapshot.feeSplit or defaults)\r\n    const rootCAFee = entry.fees?.rootCA || (iGas * ROOT_CA_FEE);\r\n    const indexerFee = entry.fees?.indexer || (iGas * INDEXER_FEE);\r\n    \r\n    // Extract garden ID from provider (if available)\r\n    const provider = ROOT_CA_SERVICE_REGISTRY.find(p => p.uuid === entry.providerUuid);\r\n    const gardenId = provider?.gardenId || 'unknown';\r\n    \r\n    const settlementPayload = {\r\n      entryId: entry.entryId,\r\n      txId: entry.txId,\r\n      timestamp: entry.timestamp.toString(),\r\n      payer: entry.payer,\r\n      payerId: entry.payerId,\r\n      merchant: entry.merchant,\r\n      providerUuid: entry.providerUuid,\r\n      indexerId: gardenId, // Legacy field (will be renamed to gardenId in future)\r\n      serviceType: entry.serviceType,\r\n      amount: entry.amount.toString(),\r\n      iGas: iGas.toString(),\r\n      iTax: iTax.toString(),\r\n      fees: JSON.stringify({\r\n        rootCA: rootCAFee,\r\n        indexer: indexerFee,\r\n        ...entry.fees\r\n      }),\r\n      status: entry.status,\r\n      cashierId: entry.cashierId,\r\n      bookingDetails: entry.bookingDetails ? JSON.stringify(entry.bookingDetails) : '',\r\n    };\r\n    \r\n    await redis.xAdd(LEDGER_SETTLEMENT_STREAM, \"*\", settlementPayload);\r\n    \r\n    console.log(`\uD83D\uDCE4 [Settlement] Pushed ledger entry ${entry.entryId} to ROOT CA settlement stream`);\r\n    console.log(`   iGas: ${iGas}, iTax: ${iTax}, ROOT CA Fee: ${rootCAFee}, Indexer Fee: ${indexerFee}`);\r\n    \r\n    // Record fee payment in Accountant Service\r\n    try {\r\n      const { recordFeePayment } = await import(\"./src/accountant\");\r\n      recordFeePayment(\r\n        entry.serviceType,\r\n        iGas,\r\n        iTax,\r\n        rootCAFee,\r\n        indexerFee,\r\n        0 // providerFee (can be added later if needed)\r\n      );\r\n    } catch (err: any) {\r\n      console.warn(`\u26A0\uFE0F  [Settlement] Failed to record fee payment in Accountant: ${err.message}`);\r\n    }\r\n    \r\n    broadcastEvent({\r\n      type: \"ledger_entry_pushed\",\r\n      component: \"settlement\",\r\n      message: `Ledger entry pushed to settlement stream: ${entry.entryId}`,\r\n      timestamp: Date.now(),\r\n      data: { \r\n        entryId: entry.entryId, \r\n        iGas, \r\n        iTax, \r\n        fees: settlementPayload.fees,\r\n        rootCAFee,\r\n        indexerFee,\r\n        indexerId: gardenId // Legacy field (will be renamed to gardenId in future)\r\n      }\r\n    });\r\n  } catch (err: any) {\r\n    console.error(`\u274C Failed to push ledger entry to settlement stream:`, err.message);\r\n    throw err;\r\n  }\r\n}\r\n\r\nasync function processPayment(cashier: Cashier, entry: LedgerEntry, user: User): Promise<boolean> {\r\n  // NO AUTO-GRANT - User must have balance from Stripe or other credits\r\n  \r\n  // EdenCore submits intent to Wallet Service\r\n  // Wallet Service decides and updates balance (single source of truth)\r\n  const walletResult = await processWalletIntent({\r\n    intent: \"DEBIT\",\r\n    email: user.email,\r\n    amount: entry.amount,\r\n    txId: entry.txId,\r\n    entryId: entry.entryId,\r\n    reason: `Payment to ${entry.merchant} (${entry.serviceType})`,\r\n    metadata: {\r\n      merchant: entry.merchant,\r\n      serviceType: entry.serviceType,\r\n      cashierId: cashier.id,\r\n    }\r\n  });\r\n  \r\n  if (!walletResult.success) {\r\n    entry.status = 'failed';\r\n    const walletBalance = await getWalletBalance(user.email);\r\n    broadcastEvent({\r\n      type: \"cashier_payment_failed\",\r\n      component: \"cashier\",\r\n      message: `Payment failed: ${walletResult.error}`,\r\n      timestamp: Date.now(),\r\n      data: { \r\n        entry, \r\n        cashier, \r\n        error: walletResult.error,\r\n        walletBalance,\r\n        userBalance: user.balance,\r\n        requiredAmount: entry.amount\r\n      }\r\n    });\r\n    return false;\r\n  }\r\n\r\n  // Update user balance for backward compatibility (wallet is source of truth)\r\n  user.balance = walletResult.balance;\r\n  \r\n  // Update cashier stats\r\n  cashier.processedCount++;\r\n  cashier.totalProcessed += entry.amount;\r\n  entry.status = 'processed';\r\n\r\n  broadcastEvent({\r\n    type: \"cashier_payment_processed\",\r\n    component: \"cashier\",\r\n    message: `${cashier.name} processed payment: ${entry.amount} \uD83C\uDF4E APPLES`,\r\n    timestamp: Date.now(),\r\n    data: { entry, cashier, userBalance: walletResult.balance, walletService: \"wallet-service-001\" }\r\n  });\r\n\r\n  return true;\r\n}\r\n\r\nfunction completeBooking(entry: LedgerEntry) {\r\n  entry.status = 'completed';\r\n  \r\n  broadcastEvent({\r\n    type: \"ledger_booking_completed\",\r\n    component: \"ledger\",\r\n    message: `Booking completed: ${entry.entryId}`,\r\n    timestamp: Date.now(),\r\n    data: { entry }\r\n  });\r\n}\r\n\r\nfunction getLedgerEntries(payerEmail?: string): LedgerEntry[] {\r\n  if (payerEmail) {\r\n    return LEDGER.filter(entry => entry.payer === payerEmail);\r\n  }\r\n  return [...LEDGER];\r\n}\r\n\r\n// RPC Functions - Canonical source of truth\r\nfunction getTransactionByPayer(payerEmail: string): LedgerEntry[] {\r\n  return LEDGER.filter(entry => entry.payer === payerEmail && entry.status === 'completed');\r\n}\r\n\r\nfunction getTransactionBySnapshot(snapshotId: string): LedgerEntry | null {\r\n  return LEDGER.find(entry => entry.txId === snapshotId) || null;\r\n}\r\n\r\nfunction getLatestSnapshot(providerId: string): LedgerEntry | null {\r\n  const providerEntries = LEDGER.filter(entry => \r\n    entry.merchant === providerId || entry.providerUuid === providerId\r\n  );\r\n  if (providerEntries.length === 0) return null;\r\n  \r\n  // Return most recent completed transaction\r\n  return providerEntries\r\n    .filter(entry => entry.status === 'completed')\r\n    .sort((a, b) => b.timestamp - a.timestamp)[0] || null;\r\n}\r\n\r\n// Webhook Delivery (Best effort, async)\r\nasync function deliverWebhook(providerId: string, snapshot: TransactionSnapshot, ledgerEntry: LedgerEntry): Promise<void> {\r\n  const webhook = PROVIDER_WEBHOOKS.get(providerId);\r\n  if (!webhook) {\r\n    return; // No webhook registered\r\n  }\r\n  \r\n  console.log(`\uD83D\uDCE4 [Service Provider] Webhook Delivery Attempt: ${providerId} \u2192 ${webhook.webhookUrl} (TX: ${snapshot.txId.substring(0, 8)}...)`);\r\n  \r\n  // Broadcast webhook delivery attempt\r\n  broadcastEvent({\r\n    type: \"provider_webhook_attempt\",\r\n    component: \"service_provider\",\r\n    message: `Webhook Delivery Attempt: ${providerId}`,\r\n    timestamp: Date.now(),\r\n    data: {\r\n      providerId,\r\n      txId: snapshot.txId,\r\n      webhookUrl: webhook.webhookUrl\r\n    }\r\n  });\r\n  \r\n  const payload = JSON.stringify({\r\n    event: 'tx-finalized',\r\n    snapshot: {\r\n      chainId: snapshot.chainId,\r\n      txId: snapshot.txId,\r\n      slot: snapshot.slot,\r\n      blockTime: snapshot.blockTime,\r\n      payer: snapshot.payer,\r\n      merchant: snapshot.merchant,\r\n      amount: snapshot.amount,\r\n      feeSplit: snapshot.feeSplit,\r\n    },\r\n    ledger: {\r\n      entryId: ledgerEntry.entryId,\r\n      status: ledgerEntry.status,\r\n      serviceType: ledgerEntry.serviceType,\r\n      bookingDetails: ledgerEntry.bookingDetails,\r\n    },\r\n    timestamp: Date.now(),\r\n  });\r\n  \r\n  try {\r\n    const parsedUrl = new URL(webhook.webhookUrl);\r\n    const options = {\r\n      hostname: parsedUrl.hostname,\r\n      port: parsedUrl.port || (parsedUrl.protocol === 'https:' ? 443 : 80),\r\n      path: parsedUrl.pathname + parsedUrl.search,\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Content-Length': payload.length,\r\n        'X-Eden-Event': 'tx-finalized',\r\n        'X-Eden-Provider': providerId,\r\n      },\r\n      timeout: 5000, // 5 second timeout\r\n    };\r\n    \r\n    const httpModule = parsedUrl.protocol === 'https:' ? https : http;\r\n    \r\n    const req = httpModule.request(options, (res) => {\r\n      let data = '';\r\n      res.on('data', (chunk) => { data += chunk; });\r\n      res.on('end', () => {\r\n        if (res.statusCode && res.statusCode >= 200 && res.statusCode < 300) {\r\n          webhook.lastDelivery = Date.now();\r\n          webhook.failureCount = 0;\r\n          console.log(`\u2705 [Service Provider] Webhook Delivered: ${providerId} \u2192 HTTP ${res.statusCode} (TX: ${snapshot.txId.substring(0, 8)}...)`);\r\n          \r\n          // Broadcast successful webhook delivery\r\n          broadcastEvent({\r\n            type: \"provider_webhook_delivered\",\r\n            component: \"service_provider\",\r\n            message: `Webhook Delivered: ${providerId}`,\r\n            timestamp: Date.now(),\r\n            data: {\r\n              providerId,\r\n              txId: snapshot.txId,\r\n              statusCode: res.statusCode,\r\n              webhookUrl: webhook.webhookUrl\r\n            }\r\n          });\r\n        } else {\r\n          webhook.failureCount++;\r\n          console.warn(`\u274C [Service Provider] Webhook Delivery Failed: ${providerId} \u2192 HTTP ${res.statusCode} (TX: ${snapshot.txId.substring(0, 8)}..., Failures: ${webhook.failureCount})`);\r\n          \r\n          // Broadcast failed webhook delivery\r\n          broadcastEvent({\r\n            type: \"provider_webhook_failed\",\r\n            component: \"service_provider\",\r\n            message: `Webhook Delivery Failed: ${providerId}`,\r\n            timestamp: Date.now(),\r\n            data: {\r\n              providerId,\r\n              txId: snapshot.txId,\r\n              statusCode: res.statusCode,\r\n              failureCount: webhook.failureCount,\r\n              webhookUrl: webhook.webhookUrl\r\n            }\r\n          });\r\n        }\r\n      });\r\n    });\r\n    \r\n    req.on('error', (err) => {\r\n      webhook.failureCount++;\r\n      console.warn(`\u274C [Service Provider] Webhook Delivery Error: ${providerId} \u2192 ${err.message} (TX: ${snapshot.txId.substring(0, 8)}..., Failures: ${webhook.failureCount})`);\r\n      \r\n      // Broadcast webhook error\r\n      broadcastEvent({\r\n        type: \"provider_webhook_failed\",\r\n        component: \"service_provider\",\r\n        message: `Webhook Delivery Error: ${providerId}`,\r\n        timestamp: Date.now(),\r\n        data: {\r\n          providerId,\r\n          txId: snapshot.txId,\r\n          error: err.message,\r\n          failureCount: webhook.failureCount,\r\n          webhookUrl: webhook.webhookUrl\r\n        }\r\n      });\r\n    });\r\n    \r\n    req.on('timeout', () => {\r\n      req.destroy();\r\n      webhook.failureCount++;\r\n      console.warn(`\u23F1\uFE0F  [Service Provider] Webhook Delivery Timeout: ${providerId} (TX: ${snapshot.txId.substring(0, 8)}..., Failures: ${webhook.failureCount})`);\r\n      \r\n      // Broadcast webhook timeout\r\n      broadcastEvent({\r\n        type: \"provider_webhook_failed\",\r\n        component: \"service_provider\",\r\n        message: `Webhook Delivery Timeout: ${providerId}`,\r\n        timestamp: Date.now(),\r\n        data: {\r\n          providerId,\r\n          txId: snapshot.txId,\r\n          error: \"timeout\",\r\n          failureCount: webhook.failureCount,\r\n          webhookUrl: webhook.webhookUrl\r\n        }\r\n      });\r\n    });\r\n    \r\n    req.write(payload);\r\n    req.end();\r\n  } catch (err: any) {\r\n    webhook.failureCount++;\r\n    console.error(`\u274C [Service Provider] Webhook Delivery Exception: ${providerId} \u2192 ${err.message} (TX: ${snapshot.txId.substring(0, 8)}..., Failures: ${webhook.failureCount})`);\r\n    \r\n    // Broadcast webhook exception\r\n    broadcastEvent({\r\n      type: \"provider_webhook_failed\",\r\n      component: \"service_provider\",\r\n      message: `Webhook Delivery Exception: ${providerId}`,\r\n      timestamp: Date.now(),\r\n      data: {\r\n        providerId,\r\n        txId: snapshot.txId,\r\n        error: err.message,\r\n        failureCount: webhook.failureCount,\r\n        webhookUrl: webhook.webhookUrl\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\n// (getCashierStatus moved to src/ledger.ts)\r\n\r\n// ROOT CA Certificate Management Functions\r\n\r\nfunction initializeRootCA(): void {\r\n  if (!ROOT_CA) {\r\n    const rootCA = new EdenPKI(ROOT_CA_UUID);\r\n    const rootCAIdentity = rootCA.identity;\r\n    setROOTCA(rootCA, rootCAIdentity);\r\n    console.log(`\u2696\uFE0F  ROOT CA initialized: ${ROOT_CA_UUID}`);\r\n    console.log(`   Public Key: ${rootCAIdentity.publicKey.substring(0, 50)}...`);\r\n    \r\n    broadcastEvent({\r\n      type: \"root_ca_initialized\",\r\n      component: \"root-ca\",\r\n      message: \"ROOT CA initialized and ready\",\r\n      timestamp: Date.now(),\r\n      data: {\r\n        uuid: ROOT_CA_UUID,\r\n        publicKey: ROOT_CA_IDENTITY.publicKey\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\n// (issueGardenCertificate moved to src/garden.ts)\r\n\r\n// (issueServiceProviderCertificate moved to src/serviceProvider.ts)\r\n\r\nfunction revokeCertificate(\r\n  uuid: string, \r\n  reason: string, \r\n  revokedType: \"indexer\" | \"service\" | \"provider\" = \"provider\",\r\n  severity: \"soft\" | \"hard\" = \"hard\",\r\n  metadata?: Record<string, any>\r\n): RevocationEvent {\r\n  if (!ROOT_CA) {\r\n    throw new Error(\"ROOT CA not initialized\");\r\n  }\r\n  \r\n  // Get certificate hash if available\r\n  const cert = CERTIFICATE_REGISTRY.get(uuid);\r\n  const certHash = cert ? `sha256:${crypto.createHash('sha256').update(JSON.stringify(cert)).digest('hex')}` : undefined;\r\n  \r\n  // Create revocation event according to ENCERT v1 spec\r\n  const revocation = ROOT_CA.revokeIdentity(\r\n    uuid,\r\n    revokedType,\r\n    reason,\r\n    Date.now(), // effective_at (immediate)\r\n    certHash,\r\n    severity,\r\n    metadata\r\n  );\r\n  \r\n  // Store in local registry\r\n  REVOCATION_REGISTRY.set(uuid, revocation);\r\n  \r\n  // Publish to Redis Stream (ENCERT v1 spec)\r\n  publishRevocationToStream(revocation).catch(err => {\r\n    console.error(`\u274C Failed to publish revocation to stream:`, err);\r\n  });\r\n  \r\n  // Remove certificate from registry\r\n  CERTIFICATE_REGISTRY.delete(uuid);\r\n  \r\n  // Handle indexer/garden revocation\r\n  const indexer = GARDENS.find(i => i.uuid === uuid);\r\n  if (indexer) {\r\n    if (severity === 'hard' && revokedType === 'indexer') {\r\n      // Hard revocation: Remove from array\r\n      const index = GARDENS.findIndex(i => i.uuid === uuid);\r\n      if (index !== -1) {\r\n        GARDENS.splice(index, 1);\r\n        console.log(`   \uD83D\uDDD1\uFE0F  Removed garden ${indexer.id} (${indexer.name}) from GARDENS array`);\r\n      }\r\n    } else {\r\n      // Soft revocation: Just mark as inactive\r\n      indexer.active = false;\r\n      indexer.certificate = undefined;\r\n      console.log(`   Indexer ${indexer.name} marked as inactive`);\r\n    }\r\n  }\r\n  \r\n  // Also check TOKEN_GARDENS\r\n  const tokenIndexer = TOKEN_GARDENS.find(i => i.uuid === uuid);\r\n  if (tokenIndexer) {\r\n    if (severity === 'hard' && revokedType === 'indexer') {\r\n      // Hard revocation: Remove from array\r\n      const index = TOKEN_GARDENS.findIndex(i => i.uuid === uuid);\r\n      if (index !== -1) {\r\n        TOKEN_GARDENS.splice(index, 1);\r\n        console.log(`   \uD83D\uDDD1\uFE0F  Removed garden ${tokenIndexer.id} (${tokenIndexer.name}) from TOKEN_GARDENS array`);\r\n      }\r\n    } else {\r\n      // Soft revocation: Just mark as inactive\r\n      tokenIndexer.active = false;\r\n      tokenIndexer.certificate = undefined;\r\n      console.log(`   Token indexer ${tokenIndexer.name} marked as inactive`);\r\n    }\r\n  }\r\n  \r\n  // Handle provider revocation\r\n  const provider = ROOT_CA_SERVICE_REGISTRY.find(p => p.uuid === uuid);\r\n  if (provider) {\r\n    if (severity === 'hard' && revokedType === 'provider') {\r\n      // Hard revocation: Remove from array\r\n      const index = ROOT_CA_SERVICE_REGISTRY.findIndex(p => p.uuid === uuid);\r\n      if (index !== -1) {\r\n        ROOT_CA_SERVICE_REGISTRY.splice(index, 1);\r\n        console.log(`   \uD83D\uDDD1\uFE0F  Removed provider ${provider.id} (${provider.name}) from ROOT_CA_SERVICE_REGISTRY`);\r\n      }\r\n    } else {\r\n      // Soft revocation: Just mark as revoked\r\n      provider.certificate = undefined;\r\n      provider.status = 'revoked';\r\n      console.log(`   Service provider ${provider.name} (${provider.id}) marked as revoked`);\r\n      console.log(`   Provider will be filtered out from service queries`);\r\n    }\r\n  }\r\n  \r\n  console.log(`\uD83D\uDEAB Certificate revoked: ${uuid}`);\r\n  console.log(`   Type: ${revokedType}`);\r\n  console.log(`   Reason: ${reason}`);\r\n  console.log(`   Severity: ${severity}`);\r\n  \r\n  broadcastEvent({\r\n    type: \"certificate_revoked\",\r\n    component: \"root-ca\",\r\n    message: `Certificate revoked: ${uuid}`,\r\n    timestamp: Date.now(),\r\n    data: {\r\n      revoked_uuid: uuid,\r\n      revoked_type: revokedType,\r\n      reason: reason,\r\n      issuer_uuid: ROOT_CA_UUID,\r\n      severity: severity\r\n    }\r\n  });\r\n  \r\n  return revocation;\r\n}\r\n\r\n// Allow indexers to revoke certificates they issued\r\nfunction revokeCertificateByIndexer(\r\n  indexerId: string,\r\n  revokedUuid: string,\r\n  reason: string,\r\n  revokedType: \"indexer\" | \"service\" | \"provider\" = \"service\",\r\n  severity: \"soft\" | \"hard\" = \"hard\",\r\n  metadata?: Record<string, any>\r\n): RevocationEvent {\r\n  const indexer = GARDENS.find(i => i.id === indexerId || i.uuid === indexerId);\r\n  if (!indexer || !indexer.pki) {\r\n    throw new Error(`Indexer not found or PKI not initialized: ${indexerId}`);\r\n  }\r\n  \r\n  // Verify indexer has INDEXER capability\r\n  const indexerCert = CERTIFICATE_REGISTRY.get(indexer.uuid);\r\n  if (!indexerCert || !indexerCert.capabilities.includes(\"INDEXER\")) {\r\n    throw new Error(`Indexer ${indexerId} does not have INDEXER capability`);\r\n  }\r\n  \r\n  // Verify indexer has authority to revoke this entity\r\n  const testRevocation: RevocationEvent = {\r\n    revoked_uuid: revokedUuid,\r\n    revoked_type: revokedType,\r\n    issuer_uuid: indexer.uuid,\r\n    reason: reason,\r\n    issued_at: Date.now(),\r\n    effective_at: Date.now(),\r\n    signature: \"\", // Will be set below\r\n  };\r\n  \r\n  if (!verifyRevocationAuthority(testRevocation)) {\r\n    throw new Error(`Indexer ${indexerId} lacks authority to revoke ${revokedUuid}`);\r\n  }\r\n  \r\n  // Get certificate hash if available\r\n  const cert = CERTIFICATE_REGISTRY.get(revokedUuid);\r\n  const certHash = cert ? `sha256:${crypto.createHash('sha256').update(JSON.stringify(cert)).digest('hex')}` : undefined;\r\n  \r\n  // Create revocation event signed by indexer\r\n  const revocation = indexer.pki.revokeIdentity(\r\n    revokedUuid,\r\n    revokedType,\r\n    reason,\r\n    Date.now(), // effective_at (immediate)\r\n    certHash,\r\n    severity,\r\n    metadata\r\n  );\r\n  \r\n  // Store in local registry\r\n  REVOCATION_REGISTRY.set(revokedUuid, revocation);\r\n  \r\n  // Publish to Redis Stream (ENCERT v1 spec)\r\n  publishRevocationToStream(revocation).catch(err => {\r\n    console.error(`\u274C Failed to publish revocation to stream:`, err);\r\n  });\r\n  \r\n  // Remove certificate from registry\r\n  CERTIFICATE_REGISTRY.delete(revokedUuid);\r\n  \r\n  // Mark provider as revoked in ROOT_CA_SERVICE_REGISTRY\r\n  const provider = ROOT_CA_SERVICE_REGISTRY.find(p => p.uuid === revokedUuid);\r\n  if (provider) {\r\n    provider.certificate = undefined;\r\n    provider.status = 'revoked';\r\n    console.log(`   Service provider ${provider.name} (${provider.id}) marked as revoked in ROOT_CA_SERVICE_REGISTRY`);\r\n  }\r\n  \r\n  console.log(`\uD83D\uDEAB [${indexer.name}] Certificate revoked: ${revokedUuid}`);\r\n  console.log(`   Type: ${revokedType}`);\r\n  console.log(`   Reason: ${reason}`);\r\n  console.log(`   Severity: ${severity}`);\r\n  \r\n  broadcastEvent({\r\n    type: \"certificate_revoked\",\r\n    component: indexer.name.toLowerCase().replace(/\\s+/g, '-'),\r\n    message: `Certificate revoked by ${indexer.name}: ${revokedUuid}`,\r\n    timestamp: Date.now(),\r\n    data: {\r\n      revoked_uuid: revokedUuid,\r\n      revoked_type: revokedType,\r\n      reason: reason,\r\n      issuer_uuid: indexer.uuid,\r\n      severity: severity\r\n    }\r\n  });\r\n  \r\n  return revocation;\r\n}\r\n\r\n// Publish revocation event to Redis Stream (ENCERT v1 spec)\r\nasync function publishRevocationToStream(revocation: RevocationEvent): Promise<void> {\r\n  try {\r\n    const streamFields: Record<string, string> = {\r\n      revoked_uuid: revocation.revoked_uuid,\r\n      revoked_type: revocation.revoked_type,\r\n      issuer_uuid: revocation.issuer_uuid,\r\n      reason: revocation.reason,\r\n      issued_at: revocation.issued_at.toString(),\r\n      effective_at: revocation.effective_at.toString(),\r\n      signature: revocation.signature,\r\n    };\r\n    \r\n    if (revocation.cert_hash) {\r\n      streamFields.cert_hash = revocation.cert_hash;\r\n    }\r\n    \r\n    if (revocation.severity) {\r\n      streamFields.severity = revocation.severity;\r\n    }\r\n    \r\n    if (revocation.metadata) {\r\n      streamFields.metadata = JSON.stringify(revocation.metadata);\r\n    }\r\n    \r\n    // Add to Redis Stream\r\n    const streamId = await redis.xAdd(REVOCATION_STREAM, \"*\", streamFields);\r\n    console.log(`\uD83D\uDCE4 Published revocation to stream: ${streamId}`);\r\n    \r\n    broadcastEvent({\r\n      type: \"revocation_published\",\r\n      component: \"root-ca\",\r\n      message: `Revocation published to stream`,\r\n      timestamp: Date.now(),\r\n      data: { streamId, revocation }\r\n    });\r\n  } catch (err: any) {\r\n    console.error(`\u274C Failed to publish revocation to Redis stream:`, err);\r\n    throw err;\r\n  }\r\n}\r\n\r\nfunction validateCertificate(uuid: string): boolean {\r\n  const cert = CERTIFICATE_REGISTRY.get(uuid);\r\n  if (!cert) {\r\n    return false;\r\n  }\r\n  \r\n  // Check if revoked\r\n  if (REVOCATION_REGISTRY.has(uuid)) {\r\n    return false;\r\n  }\r\n  \r\n  // Validate certificate signature\r\n  if (!ROOT_CA_IDENTITY) {\r\n    return false;\r\n  }\r\n  \r\n  return EdenPKI.validateCertificate(cert, ROOT_CA_IDENTITY.publicKey);\r\n}\r\n\r\nfunction getCertificate(uuid: string): EdenCertificate | undefined {\r\n  return CERTIFICATE_REGISTRY.get(uuid);\r\n}\r\n\r\nfunction getAllCertificates(): EdenCertificate[] {\r\n  return Array.from(CERTIFICATE_REGISTRY.values());\r\n}\r\n\r\nfunction getRevokedCertificates(): RevocationEvent[] {\r\n  return Array.from(REVOCATION_REGISTRY.values());\r\n}\r\n\r\n// ENCERT v1 Redis Revocation Stream Functions\r\n\r\n// Initialize revocation stream consumer groups for each indexer\r\nasync function initializeRevocationConsumers(): Promise<void> {\r\n  try {\r\n    for (const indexer of GARDENS) {\r\n      if (indexer.active) {\r\n        const consumerGroup = `indexer-${indexer.id}`;\r\n        try {\r\n          // Create consumer group (MKSTREAM creates stream if it doesn't exist)\r\n          await redis.xGroupCreate(REVOCATION_STREAM, consumerGroup, \"0\", { MKSTREAM: true });\r\n          console.log(`\u2705 Created revocation consumer group: ${consumerGroup}`);\r\n        } catch (err: any) {\r\n          // Group might already exist, which is fine\r\n          if (!err.message?.includes(\"BUSYGROUP\")) {\r\n            console.warn(`\u26A0\uFE0F  Failed to create consumer group ${consumerGroup}:`, err.message);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  } catch (err: any) {\r\n    console.error(`\u274C Failed to initialize revocation consumers:`, err);\r\n  }\r\n}\r\n\r\n// Process revocation events from Redis Stream (ENCERT v1 spec)\r\nasync function processRevocationStream(indexerName: string, indexerId: string): Promise<void> {\r\n  const consumerGroup = `indexer-${indexerId}`;\r\n  const consumerName = `${indexerName}-consumer`;\r\n  \r\n  try {\r\n    while (true) {\r\n      try {\r\n        // Read from stream with consumer group\r\n        const messages = await redis.xReadGroup(\r\n          consumerGroup,\r\n          consumerName,\r\n          [\r\n            {\r\n              key: REVOCATION_STREAM,\r\n              id: \">\", // Read new messages\r\n            },\r\n          ],\r\n          {\r\n            COUNT: 10,\r\n            BLOCK: 1000, // Block for 1 second\r\n          }\r\n        );\r\n        \r\n        if (messages && messages.length > 0) {\r\n          for (const stream of messages) {\r\n            for (const message of stream.messages) {\r\n              await processRevocationMessage(message, indexerName);\r\n              \r\n              // Acknowledge message\r\n              await redis.xAck(REVOCATION_STREAM, consumerGroup, message.id);\r\n            }\r\n          }\r\n        }\r\n      } catch (err: any) {\r\n        if (err.message?.includes(\"NOGROUP\")) {\r\n          // Consumer group doesn't exist, try to create it\r\n          try {\r\n            await redis.xGroupCreate(REVOCATION_STREAM, consumerGroup, \"0\", { MKSTREAM: true });\r\n            console.log(`\u2705 Created consumer group ${consumerGroup} for ${indexerName}`);\r\n          } catch (createErr: any) {\r\n            console.error(`\u274C Failed to create consumer group:`, createErr);\r\n          }\r\n        } else {\r\n          console.error(`\u274C Error reading revocation stream:`, err);\r\n        }\r\n      }\r\n      \r\n      // Yield to event loop\r\n      await new Promise(resolve => setImmediate(resolve));\r\n    }\r\n  } catch (err: any) {\r\n    console.error(`\u274C Revocation stream processor error for ${indexerName}:`, err);\r\n  }\r\n}\r\n\r\n// Process a single revocation message\r\nasync function processRevocationMessage(message: any, indexerName: string): Promise<void> {\r\n  try {\r\n    const fields = message.message;\r\n    \r\n    // Parse revocation event from stream fields\r\n    const revocation: RevocationEvent = {\r\n      revoked_uuid: fields.revoked_uuid,\r\n      revoked_type: fields.revoked_type as \"indexer\" | \"service\" | \"provider\",\r\n      issuer_uuid: fields.issuer_uuid,\r\n      reason: fields.reason,\r\n      issued_at: parseInt(fields.issued_at),\r\n      effective_at: parseInt(fields.effective_at),\r\n      signature: fields.signature,\r\n      cert_hash: fields.cert_hash,\r\n      severity: fields.severity as \"soft\" | \"hard\" | undefined,\r\n      metadata: fields.metadata ? JSON.parse(fields.metadata) : undefined,\r\n    };\r\n    \r\n    // Verify issuer certificate exists\r\n    const issuerCert = CERTIFICATE_REGISTRY.get(revocation.issuer_uuid);\r\n    if (!issuerCert) {\r\n      console.warn(`\u26A0\uFE0F  Cannot verify revocation: issuer certificate not found for ${revocation.issuer_uuid}`);\r\n      return;\r\n    }\r\n    \r\n    // Verify issuer has authority (ROOT CA can revoke anything, Indexers can revoke services they certified)\r\n    const hasAuthority = verifyRevocationAuthority(revocation);\r\n    if (!hasAuthority) {\r\n      console.warn(`\u26A0\uFE0F  Revocation rejected: issuer ${revocation.issuer_uuid} lacks authority to revoke ${revocation.revoked_uuid}`);\r\n      return;\r\n    }\r\n    \r\n    // Get issuer's public key for signature verification\r\n    let issuerPublicKey: string;\r\n    if (revocation.issuer_uuid === ROOT_CA_UUID) {\r\n      if (!ROOT_CA_IDENTITY) {\r\n        console.warn(`\u26A0\uFE0F  ROOT CA identity not initialized`);\r\n        return;\r\n      }\r\n      issuerPublicKey = ROOT_CA_IDENTITY.publicKey;\r\n    } else {\r\n      // For indexers, get their public key from their PKI instance\r\n      const issuerIndexer = GARDENS.find(i => i.uuid === revocation.issuer_uuid);\r\n      if (issuerIndexer && issuerIndexer.pki) {\r\n        issuerPublicKey = issuerIndexer.pki.identity.publicKey;\r\n      } else {\r\n        console.warn(`\u26A0\uFE0F  Cannot verify indexer revocation: indexer PKI not found for ${revocation.issuer_uuid}`);\r\n        return;\r\n      }\r\n    }\r\n    \r\n    // Verify signature\r\n    const isValid = EdenPKI.validateRevocation(revocation, issuerPublicKey);\r\n    if (!isValid) {\r\n      console.warn(`\u26A0\uFE0F  Revocation signature invalid for ${revocation.revoked_uuid}`);\r\n      return;\r\n    }\r\n    \r\n      // Apply revocation idempotently\r\n      const now = Date.now();\r\n      if (now >= revocation.effective_at) {\r\n        REVOCATION_REGISTRY.set(revocation.revoked_uuid, revocation);\r\n        \r\n        // Handle indexer/garden revocation\r\n        const indexer = GARDENS.find(i => i.uuid === revocation.revoked_uuid);\r\n        if (indexer) {\r\n          indexer.active = false;\r\n          indexer.certificate = undefined;\r\n          // For hard shutdowns, remove from array\r\n          if (revocation.severity === 'hard' && revocation.revoked_type === 'indexer') {\r\n            const index = GARDENS.findIndex(i => i.uuid === revocation.revoked_uuid);\r\n            if (index !== -1) {\r\n              GARDENS.splice(index, 1);\r\n              console.log(`   \uD83D\uDDD1\uFE0F  Removed garden ${indexer.id} (${indexer.name}) from GARDENS array`);\r\n            }\r\n          }\r\n        }\r\n        \r\n        // Also check TOKEN_GARDENS\r\n        const tokenIndexer = TOKEN_GARDENS.find(i => i.uuid === revocation.revoked_uuid);\r\n        if (tokenIndexer) {\r\n          tokenIndexer.active = false;\r\n          tokenIndexer.certificate = undefined;\r\n          // For hard shutdowns, remove from array\r\n          if (revocation.severity === 'hard' && revocation.revoked_type === 'indexer') {\r\n            const index = TOKEN_GARDENS.findIndex(i => i.uuid === revocation.revoked_uuid);\r\n            if (index !== -1) {\r\n              TOKEN_GARDENS.splice(index, 1);\r\n              console.log(`   \uD83D\uDDD1\uFE0F  Removed garden ${tokenIndexer.id} (${tokenIndexer.name}) from TOKEN_GARDENS array`);\r\n            }\r\n          }\r\n        }\r\n        \r\n        // Handle provider revocation\r\n        const provider = ROOT_CA_SERVICE_REGISTRY.find(p => p.uuid === revocation.revoked_uuid);\r\n        if (provider) {\r\n          provider.certificate = undefined;\r\n          provider.status = 'revoked';\r\n          console.log(`   Service provider ${provider.name} (${provider.id}) marked as revoked in ROOT_CA_SERVICE_REGISTRY`);\r\n          // For hard shutdowns, remove from array\r\n          if (revocation.severity === 'hard' && revocation.revoked_type === 'provider') {\r\n            const index = ROOT_CA_SERVICE_REGISTRY.findIndex(p => p.uuid === revocation.revoked_uuid);\r\n            if (index !== -1) {\r\n              ROOT_CA_SERVICE_REGISTRY.splice(index, 1);\r\n              console.log(`   \uD83D\uDDD1\uFE0F  Removed provider ${provider.id} (${provider.name}) from ROOT_CA_SERVICE_REGISTRY`);\r\n            }\r\n          }\r\n        }\r\n        \r\n        console.log(`\uD83D\uDEAB [${indexerName}] Applied revocation: ${revocation.revoked_uuid}`);\r\n        console.log(`   Reason: ${revocation.reason}`);\r\n      \r\n      broadcastEvent({\r\n        type: \"revocation_applied\",\r\n        component: indexerName,\r\n        message: `Revocation applied: ${revocation.revoked_uuid}`,\r\n        timestamp: Date.now(),\r\n        data: { revocation }\r\n      });\r\n    } else {\r\n      console.log(`\u23F3 [${indexerName}] Revocation scheduled for future: ${revocation.revoked_uuid}`);\r\n    }\r\n  } catch (err: any) {\r\n    console.error(`\u274C Failed to process revocation message:`, err);\r\n  }\r\n}\r\n\r\n// Verify revocation authority according to ENCERT v1 spec\r\nfunction verifyRevocationAuthority(revocation: RevocationEvent): boolean {\r\n  // ROOT CA can revoke anything\r\n  if (revocation.issuer_uuid === ROOT_CA_UUID) {\r\n    return true;\r\n  }\r\n  \r\n  // Indexers can only revoke services they certified\r\n  const issuerIndexer = GARDENS.find(i => i.uuid === revocation.issuer_uuid);\r\n  if (issuerIndexer && revocation.revoked_type === \"service\") {\r\n    // Verify issuer has INDEXER capability\r\n    const issuerCert = CERTIFICATE_REGISTRY.get(revocation.issuer_uuid);\r\n    if (!issuerCert || !issuerCert.capabilities.includes(\"INDEXER\")) {\r\n      return false;\r\n    }\r\n    \r\n    // Check if issuer certified this service provider\r\n    // This is determined by checking if the service provider's gardenId matches the issuer's garden ID\r\n    const revokedProvider = ROOT_CA_SERVICE_REGISTRY.find(p => p.uuid === revocation.revoked_uuid);\r\n    if (revokedProvider) {\r\n      // Check if the provider's gardenId matches the issuer's garden ID\r\n      // This means the garden certified this provider\r\n      if (revokedProvider.gardenId === `garden-${issuerIndexer.id.toLowerCase()}` || \r\n          revokedProvider.gardenId === issuerIndexer.id) {\r\n        return true;\r\n      }\r\n      \r\n      // Also check certificate constraints to see if issuer certified this provider\r\n      const providerCert = CERTIFICATE_REGISTRY.get(revocation.revoked_uuid);\r\n      if (providerCert && providerCert.issuer === revocation.issuer_uuid) {\r\n        return true;\r\n      }\r\n    }\r\n  }\r\n  \r\n  return false;\r\n}\r\n\r\n// Snapshot Engine\r\n\r\nfunction createSnapshot(userEmail: string, amount: number, providerId: string): TransactionSnapshot {\r\n  const txId = crypto.randomUUID();\r\n  const rootFee = amount * ROOT_CA_FEE;\r\n  const indexerFee = amount * INDEXER_FEE;\r\n\r\n  return {\r\n    chainId: CHAIN_ID,\r\n    txId,\r\n    slot: Math.floor(Math.random() * 1_000_000),\r\n    blockTime: Date.now(),\r\n    payer: userEmail, // Use email address directly as payer\r\n    merchant: providerId,\r\n    amount: amount,\r\n    feeSplit: {\r\n      rootCA: rootFee,\r\n      indexerA: indexerFee,\r\n      indexerB: indexerFee,\r\n    },\r\n  };\r\n}\r\n\r\n// Redis Persistence\r\n\r\nasync function persistSnapshot(snapshot: TransactionSnapshot) {\r\n  if (SKIP_REDIS || !redis.isOpen) {\r\n    console.log(`\uD83D\uDCBE Snapshot (mock): ${snapshot.txId}`);\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await ensureRedisConnection();\r\n    await redis.hSet(`tx:${snapshot.txId}`, snapshot as any);\r\n    console.log(`\uD83D\uDCBE Snapshot persisted: ${snapshot.txId}`);\r\n  } catch (err: any) {\r\n    console.error(`\u26A0\uFE0F  Failed to persist snapshot ${snapshot.txId}:`, err.message);\r\n  }\r\n}\r\n\r\n// Redis Stream Fan-Out\r\n\r\nasync function streamToIndexers(snapshot: TransactionSnapshot) {\r\n  if (SKIP_REDIS || !redis.isOpen) {\r\n    const indexerNames = GARDENS.filter(i => i.active).map(i => i.name).join(\", \");\r\n    const tokenIndexerNames = TOKEN_GARDENS.filter(i => i.active).map(i => i.name).join(\", \");\r\n    const allNames = [indexerNames, tokenIndexerNames].filter(n => n).join(\", \");\r\n    console.log(`\uD83D\uDCE1 Stream (mock): ${snapshot.txId} \u2192 ${allNames}`);\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await ensureRedisConnection();\r\n    const payload = {\r\n      txId: snapshot.txId,\r\n      slot: snapshot.slot.toString(),\r\n      blockTime: snapshot.blockTime.toString(),\r\n      payer: snapshot.payer,\r\n      amount: snapshot.amount.toString(),\r\n    };\r\n\r\n    // Stream to all active regular indexers\r\n    const activeIndexers = GARDENS.filter(i => i.active);\r\n    for (const indexer of activeIndexers) {\r\n      await redis.xAdd(indexer.stream, \"*\", payload);\r\n    }\r\n    \r\n    // Stream to all active token indexers\r\n    const activeTokenIndexers = TOKEN_GARDENS.filter(i => i.active);\r\n    for (const tokenIndexer of activeTokenIndexers) {\r\n      await redis.xAdd(tokenIndexer.stream, \"*\", payload);\r\n    }\r\n    \r\n    const indexerNames = activeIndexers.map(i => i.name).join(\", \");\r\n    const tokenIndexerNames = activeTokenIndexers.map(i => i.name).join(\", \");\r\n    const allNames = [indexerNames, tokenIndexerNames].filter(n => n).join(\", \");\r\n    console.log(`\uD83D\uDCE1 Streamed to indexers: ${snapshot.txId} \u2192 ${allNames}`);\r\n    \r\n    if (activeIndexers.length > 0) {\r\n      console.log(`   \uD83D\uDCE1 Regular indexers: ${indexerNames}`);\r\n    }\r\n    if (activeTokenIndexers.length > 0) {\r\n      console.log(`   \uD83D\uDD37 Token indexers: ${tokenIndexerNames}`);\r\n    }\r\n    \r\n    // Broadcast streaming events\r\n    if (activeIndexers.length > 0) {\r\n      broadcastEvent({\r\n        type: \"indexer_stream\",\r\n        component: \"indexer\",\r\n        message: `Streamed transaction to ${activeIndexers.length} regular indexer(s)`,\r\n        timestamp: Date.now(),\r\n        data: { txId: snapshot.txId, indexers: activeIndexers.map(i => i.name), count: activeIndexers.length }\r\n      });\r\n    }\r\n    \r\n    if (activeTokenIndexers.length > 0) {\r\n      console.log(`\uD83D\uDD37 [Token Indexer] Streamed transaction ${snapshot.txId} to ${activeTokenIndexers.length} token indexer(s): ${tokenIndexerNames}`);\r\n      broadcastEvent({\r\n        type: \"token_indexer_stream\",\r\n        component: \"token_indexer\",\r\n        message: `Streamed transaction to ${activeTokenIndexers.length} token indexer(s)`,\r\n        timestamp: Date.now(),\r\n        data: { txId: snapshot.txId, indexers: activeTokenIndexers.map(i => i.name), count: activeTokenIndexers.length }\r\n      });\r\n    }\r\n  } catch (err: any) {\r\n    console.error(`\u26A0\uFE0F  Failed to stream to indexers:`, err.message);\r\n  }\r\n}\r\n\r\n// Indexer Consumers\r\n\r\n// Track last read position per consumer\r\nconst consumerPositions = new Map<string, string>();\r\n\r\nasync function gardenConsumer(name: string, stream: string) {\r\n  if (SKIP_REDIS) {\r\n    console.log(`\u26A0\uFE0F  ${name}: Skipped (Redis disabled)`);\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await ensureRedisConnection();\r\n  } catch (err) {\r\n    console.error(`\u274C ${name}: Cannot start - Redis unavailable`);\r\n    return;\r\n  }\r\n\r\n  // Initialize position to \"$\" (new messages only)\r\n  const consumerKey = `${name}:${stream}`;\r\n  let lastReadId = consumerPositions.get(consumerKey) || \"$\";\r\n\r\n  while (true) {\r\n    try {\r\n      if (!redis.isOpen) {\r\n        await ensureRedisConnection();\r\n      }\r\n\r\n      const res = await redis.xRead(\r\n        [{ key: stream, id: lastReadId }],\r\n        { BLOCK: 5000, COUNT: 1 }\r\n      );\r\n\r\n      if (!res) {\r\n        // No new messages, yield to event loop before continuing\r\n        await new Promise(resolve => setImmediate(resolve));\r\n        continue;\r\n      }\r\n\r\n      // Redis xRead returns array of { name: string, messages: Array<{id: string, message: Record<string, string>}> }\r\n      const streamResults = res as Array<{ name: string; messages: Array<{ id: string; message: Record<string, string> }> }>;\r\n      \r\n      if (Array.isArray(streamResults) && streamResults.length > 0) {\r\n        const streamResult = streamResults[0];\r\n        if (streamResult?.messages && streamResult.messages.length > 0) {\r\n          // Process messages and update position to the last message ID\r\n          for (const msg of streamResult.messages) {\r\n            const txId = msg.message?.txId;\r\n            if (txId) {\r\n              // Check if this is a token indexer\r\n              const isTokenIndexer = name.toLowerCase().includes('tokenindexer') || name.toLowerCase().startsWith('token');\r\n              const eventType = isTokenIndexer ? \"token_indexer_indexed\" : \"indexer_indexed\";\r\n              const icon = isTokenIndexer ? \"\uD83D\uDD37\" : \"\uD83D\uDCE1\";\r\n              \r\n              if (isTokenIndexer) {\r\n                console.log(`\uD83D\uDD37 [Token Indexer] ${name} indexed transaction ${txId}`);\r\n              } else {\r\n                console.log(`\uD83D\uDCE1 [Indexer] ${name} indexed transaction ${txId}`);\r\n              }\r\n              \r\n              broadcastEvent({\r\n                type: eventType,\r\n                component: name.toLowerCase().replace(/\\s+/g, '-'),\r\n                message: `${name} indexed transaction ${txId}`,\r\n                timestamp: Date.now(),\r\n                data: { txId, indexer: name, isTokenIndexer }\r\n              });\r\n            }\r\n            // Update position to this message ID for next read\r\n            lastReadId = msg.id;\r\n          }\r\n          // Save position for this consumer\r\n          consumerPositions.set(consumerKey, lastReadId);\r\n        }\r\n      }\r\n    } catch (err: any) {\r\n      if (err.message.includes(\"Connection\")) {\r\n        console.error(`\u274C ${name}: Connection lost, retrying...`);\r\n        await new Promise((resolve) => setTimeout(resolve, 2000));\r\n      } else {\r\n        console.error(`\u26A0\uFE0F  ${name}: Error reading stream:`, err.message);\r\n        // Yield to event loop before retrying\r\n        await new Promise(resolve => setImmediate(resolve));\r\n      }\r\n    }\r\n    \r\n    // Always yield to event loop after each iteration to prevent blocking\r\n    await new Promise(resolve => setImmediate(resolve));\r\n  }\r\n}\r\n\r\n// ROOT CA Settlement Consumer\r\n// ROOT CA is the ONLY settlement authority\r\n// Consumes ledger entries from settlement stream and updates balances\r\nasync function rootCASettlementConsumer() {\r\n  if (SKIP_REDIS) {\r\n    console.log(`\u26A0\uFE0F  ROOT CA Settlement Consumer: Skipped (Redis disabled)`);\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await ensureRedisConnection();\r\n  } catch (err) {\r\n    console.error(`\u274C ROOT CA Settlement Consumer: Cannot start - Redis unavailable`);\r\n    return;\r\n  }\r\n\r\n  const consumerGroup = \"root-ca-settlement\";\r\n  const consumerName = \"root-ca-settlement-worker\";\r\n\r\n  // Create consumer group if it doesn't exist\r\n  try {\r\n    await redis.xGroupCreate(LEDGER_SETTLEMENT_STREAM, consumerGroup, \"$\", { MKSTREAM: true });\r\n    console.log(`\u2705 Created ROOT CA settlement consumer group: ${consumerGroup}`);\r\n  } catch (err: any) {\r\n    if (!err.message.includes(\"BUSYGROUP\")) {\r\n      console.error(`\u26A0\uFE0F  Failed to create consumer group:`, err.message);\r\n    }\r\n  }\r\n\r\n  console.log(`\u2696\uFE0F  [ROOT CA Settlement] Starting settlement consumer...`);\r\n  \r\n  // Broadcast settlement consumer start\r\n  broadcastEvent({\r\n    type: \"settlement_consumer_started\",\r\n    component: \"root-ca\",\r\n    message: \"ROOT CA Settlement Consumer started\",\r\n    timestamp: Date.now(),\r\n    data: {\r\n      consumerGroup,\r\n      consumerName,\r\n      stream: LEDGER_SETTLEMENT_STREAM\r\n    }\r\n  });\r\n\r\n  while (true) {\r\n    try {\r\n      if (!redis.isOpen) {\r\n        await ensureRedisConnection();\r\n      }\r\n\r\n      // Read pending ledger entries\r\n      const res = await redis.xReadGroup(\r\n        consumerGroup,\r\n        consumerName,\r\n        [{ key: LEDGER_SETTLEMENT_STREAM, id: \">\" }],\r\n        { BLOCK: 5000, COUNT: 10 }\r\n      );\r\n\r\n      if (!res) {\r\n        await new Promise(resolve => setImmediate(resolve));\r\n        continue;\r\n      }\r\n\r\n      const streamResults = res as Array<{ name: string; messages: Array<{ id: string; message: Record<string, string> }> }>;\r\n      \r\n      if (Array.isArray(streamResults) && streamResults.length > 0) {\r\n        const streamResult = streamResults[0];\r\n        if (streamResult?.messages && streamResult.messages.length > 0) {\r\n          const messageCount = streamResults[0].messages.length;\r\n          console.log(`\u2696\uFE0F  [ROOT CA Settlement] Processing ${messageCount} settlement entry/entries`);\r\n          \r\n          // Broadcast batch processing start\r\n          broadcastEvent({\r\n            type: \"settlement_batch_processing\",\r\n            component: \"root-ca\",\r\n            message: `Processing ${messageCount} settlement entry/entries`,\r\n            timestamp: Date.now(),\r\n            data: { count: messageCount }\r\n          });\r\n          \r\n          for (const msg of streamResults[0].messages) {\r\n            try {\r\n              await processSettlementEntry(msg.message);\r\n              // Acknowledge message\r\n              await redis.xAck(LEDGER_SETTLEMENT_STREAM, consumerGroup, msg.id);\r\n            } catch (err: any) {\r\n              console.error(`\u274C Failed to process settlement entry ${msg.id}:`, err.message);\r\n              \r\n              // Broadcast settlement processing error\r\n              broadcastEvent({\r\n                type: \"settlement_processing_error\",\r\n                component: \"root-ca\",\r\n                message: `Failed to process settlement entry: ${msg.id}`,\r\n                timestamp: Date.now(),\r\n                data: {\r\n                  entryId: msg.message.entryId || msg.id,\r\n                  error: err.message\r\n                }\r\n              });\r\n              \r\n              // Don't ack on error - will retry\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } catch (err: any) {\r\n      if (err.message.includes(\"Connection\")) {\r\n        console.error(`\u274C ROOT CA Settlement: Connection lost, retrying...`);\r\n        \r\n        // Broadcast connection error\r\n        broadcastEvent({\r\n          type: \"settlement_connection_error\",\r\n          component: \"root-ca\",\r\n          message: \"ROOT CA Settlement: Connection lost, retrying...\",\r\n          timestamp: Date.now(),\r\n          data: { error: err.message }\r\n        });\r\n        \r\n        await new Promise((resolve) => setTimeout(resolve, 2000));\r\n      } else {\r\n        console.error(`\u26A0\uFE0F  ROOT CA Settlement: Error reading stream:`, err.message);\r\n        \r\n        // Broadcast stream read error\r\n        broadcastEvent({\r\n          type: \"settlement_stream_error\",\r\n          component: \"root-ca\",\r\n          message: `ROOT CA Settlement: Error reading stream`,\r\n          timestamp: Date.now(),\r\n          data: { error: err.message }\r\n        });\r\n        \r\n        await new Promise(resolve => setImmediate(resolve));\r\n      }\r\n    }\r\n    \r\n    await new Promise(resolve => setImmediate(resolve));\r\n  }\r\n}\r\n\r\n// Process a settlement entry (Settlement Service Provider via Holy Ghost indexer)\r\n// This is the ONLY place where balances are updated\r\n// Settlement Service Provider is registered under Holy Ghost indexer\r\nasync function processSettlementEntry(msg: Record<string, string>): Promise<void> {\r\n  const entryId = msg.entryId;\r\n  const iGas = parseFloat(msg.iGas || \"0\");\r\n  const iTax = parseFloat(msg.iTax || \"0\");\r\n  const fees = JSON.parse(msg.fees || \"{}\");\r\n  const indexerId = msg.indexerId || \"unknown\";\r\n  const providerUuid = msg.providerUuid || \"\";\r\n  \r\n  console.log(`\u2696\uFE0F  [ROOT CA Settlement] Processing entry ${entryId}`);\r\n  console.log(`   iGas: ${iGas}, iTax: ${iTax}, Indexer: ${indexerId}`);\r\n  \r\n  // Broadcast settlement processing start\r\n  broadcastEvent({\r\n    type: \"settlement_processing_start\",\r\n    component: \"root-ca\",\r\n    message: `Processing settlement entry: ${entryId}`,\r\n    timestamp: Date.now(),\r\n    data: {\r\n      entryId,\r\n      iGas,\r\n      iTax,\r\n      indexerId\r\n    }\r\n  });\r\n  \r\n  // Verify entry exists in local ledger\r\n  const ledgerEntry = LEDGER.find(e => e.entryId === entryId);\r\n  if (!ledgerEntry) {\r\n    console.warn(`\u26A0\uFE0F  Settlement entry ${entryId} not found in local ledger`);\r\n    \r\n    // Broadcast settlement entry not found\r\n    broadcastEvent({\r\n      type: \"settlement_entry_not_found\",\r\n      component: \"root-ca\",\r\n      message: `Settlement entry not found in local ledger: ${entryId}`,\r\n      timestamp: Date.now(),\r\n      data: { entryId }\r\n    });\r\n    \r\n    return;\r\n  }\r\n  \r\n  // Verify certificate validity (if provider UUID exists)\r\n  if (providerUuid && providerUuid !== 'MISSING-UUID') {\r\n    const cert = getCertificate(providerUuid);\r\n    if (!cert || !validateCertificate(providerUuid)) {\r\n      console.error(`\u274C Settlement entry ${entryId}: Invalid certificate for provider ${providerUuid}`);\r\n      ledgerEntry.status = 'failed';\r\n      \r\n      // Broadcast certificate validation failure\r\n      broadcastEvent({\r\n        type: \"settlement_certificate_invalid\",\r\n        component: \"root-ca\",\r\n        message: `Invalid certificate for provider: ${providerUuid}`,\r\n        timestamp: Date.now(),\r\n        data: {\r\n          entryId,\r\n          providerUuid\r\n        }\r\n      });\r\n      \r\n      return;\r\n    }\r\n  }\r\n  \r\n  // Verify fee math\r\n  const expectedRootCAFee = fees.rootCA || (iGas * ROOT_CA_FEE);\r\n  const expectedIndexerFee = fees.indexer || (iGas * INDEXER_FEE);\r\n  \r\n  // SETTLEMENT: Update ROOT CA balances (ONLY ROOT CA can do this)\r\n  ROOT_BALANCES.rootCA += expectedRootCAFee;\r\n  if (iTax > 0) {\r\n    // iTax distribution: 40% ROOT CA, 30% Indexer, 30% Trader (already applied)\r\n    const iTaxRootCA = iTax * ITAX_DISTRIBUTION.rootCA;\r\n    ROOT_BALANCES.rootCA += iTaxRootCA;\r\n    \r\n    // Update indexer balance\r\n    const currentIndexerBalance = ROOT_BALANCES.indexers.get(indexerId) || 0;\r\n    const iTaxIndexer = iTax * ITAX_DISTRIBUTION.indexer;\r\n    ROOT_BALANCES.indexers.set(indexerId, currentIndexerBalance + expectedIndexerFee + iTaxIndexer);\r\n  } else {\r\n    // Regular iGas fee distribution\r\n    const currentIndexerBalance = ROOT_BALANCES.indexers.get(indexerId) || 0;\r\n    ROOT_BALANCES.indexers.set(indexerId, currentIndexerBalance + expectedIndexerFee);\r\n  }\r\n  \r\n  // Update provider balance (if provider UUID exists)\r\n  if (providerUuid && providerUuid !== 'MISSING-UUID') {\r\n    const currentProviderBalance = ROOT_BALANCES.providers.get(providerUuid) || 0;\r\n    const providerFee = fees.provider || 0;\r\n    ROOT_BALANCES.providers.set(providerUuid, currentProviderBalance + providerFee);\r\n  }\r\n  \r\n  // Mark entry as settled\r\n  ledgerEntry.status = 'completed';\r\n  \r\n  // CRITICAL: Persist the updated status to file\r\n  if (redis) {\r\n    console.log(`\uD83D\uDCBE [ROOT CA Settlement] Persisting ledger entry with completed status: ${entryId}`);\r\n    redis.saveLedgerEntries(LEDGER);\r\n  } else {\r\n    console.warn(`\u26A0\uFE0F  [ROOT CA Settlement] Redis not available, cannot persist completed status for entry: ${entryId}`);\r\n  }\r\n  \r\n  console.log(`\u2705 [ROOT CA Settlement] Entry ${entryId} settled and persisted`);\r\n  console.log(`   ROOT CA Balance: ${ROOT_BALANCES.rootCA.toFixed(6)}`);\r\n  console.log(`   Indexer ${indexerId} Balance: ${ROOT_BALANCES.indexers.get(indexerId)?.toFixed(6) || \"0\"}`);\r\n  \r\n  broadcastEvent({\r\n    type: \"ledger_entry_settled\",\r\n    component: \"root-ca\",\r\n    message: `Ledger entry settled: ${entryId}`,\r\n    timestamp: Date.now(),\r\n    data: {\r\n      entryId,\r\n      iGas,\r\n      iTax,\r\n      rootCABalance: ROOT_BALANCES.rootCA,\r\n      indexerBalance: ROOT_BALANCES.indexers.get(indexerId) || 0,\r\n      fees,\r\n      status: 'completed'\r\n    }\r\n  });\r\n}\r\n\r\n// Review + Discount\r\n\r\nasync function applyReview(user: User, review: Review, moviePrice: number): Promise<number> {\r\n  if (review.rating >= 4) {\r\n    const rebate = moviePrice * 0.1;\r\n    \r\n    // Credit rebate via Wallet Service\r\n    const rebateResult = await creditWallet(\r\n      user.email,\r\n      rebate,\r\n      crypto.randomUUID(),\r\n      `Review rebate: ${review.rating}/5 rating`,\r\n      {\r\n        reviewRating: review.rating,\r\n        moviePrice,\r\n        rebateType: \"review\",\r\n      }\r\n    );\r\n    \r\n    // Update user balance for backward compatibility (wallet is source of truth)\r\n    if (rebateResult.success) {\r\n      user.balance = rebateResult.balance;\r\n    }\r\n    \r\n    return rebate;\r\n  }\r\n  return 0;\r\n}\r\n\r\n// Helper function to process movie watching action asynchronously\r\nasync function processMovieWatchingAction(\r\n  processedAction: any,\r\n  updatedContext: any,\r\n  broadcastEvent: (event: any) => void\r\n): Promise<void> {\r\n  console.log(`\uD83C\uDFAC [Movie Theater] Starting movie watching simulation`);\r\n  const movieTitle = processedAction.movieTitle || updatedContext.selectedListing?.movieTitle || 'Unknown Movie';\r\n  const duration = processedAction.duration || 10;\r\n\r\n  // Emit movie started event\r\n  broadcastEvent({\r\n    type: \"movie_started\",\r\n    component: \"movie_theater\",\r\n    message: `Now playing: ${movieTitle}`,\r\n    timestamp: Date.now(),\r\n    data: {\r\n      movieTitle,\r\n      duration,\r\n      currentScene: 'garden'\r\n    }\r\n  });\r\n\r\n  // Set initial movie state in context\r\n  updatedContext.movieStarted = true;\r\n  updatedContext.movieTitle = movieTitle;\r\n  updatedContext.movieProgress = 0;\r\n  updatedContext.currentScene = 'garden';\r\n\r\n  // Wait for movie to finish before continuing workflow\r\n  await new Promise<void>((resolve) => {\r\n    // Simulate movie progress with scene transitions\r\n    setTimeout(() => {\r\n      // 30% - Cross scene\r\n      setTimeout(() => {\r\n        updatedContext.movieProgress = 30;\r\n        updatedContext.currentScene = 'cross';\r\n        broadcastEvent({\r\n          type: \"scene_transition\",\r\n          component: \"movie_theater\",\r\n          message: \"Transitioning to the Cross scene\",\r\n          timestamp: Date.now(),\r\n          data: { scene: 'cross', progress: 30 }\r\n        });\r\n      }, duration * 1000 * 0.3);\r\n\r\n      // 60% - Utah Action scene\r\n      setTimeout(() => {\r\n        updatedContext.movieProgress = 60;\r\n        updatedContext.currentScene = 'utah_action';\r\n        broadcastEvent({\r\n          type: \"scene_transition\",\r\n          component: \"movie_theater\",\r\n          message: \"Initiating Utah Action Consensus\",\r\n          timestamp: Date.now(),\r\n          data: { scene: 'utah_action', progress: 60 }\r\n        });\r\n      }, duration * 1000 * 0.6);\r\n\r\n      // 90% - Garden Return scene\r\n      setTimeout(() => {\r\n        updatedContext.movieProgress = 90;\r\n        updatedContext.currentScene = 'garden_return';\r\n        broadcastEvent({\r\n          type: \"scene_transition\",\r\n          component: \"movie_theater\",\r\n          message: \"Fading to white for the Garden return\",\r\n          timestamp: Date.now(),\r\n          data: { scene: 'garden_return', progress: 90 }\r\n        });\r\n      }, duration * 1000 * 0.9);\r\n\r\n      // 100% - Movie finished\r\n      setTimeout(() => {\r\n        // Set movieWatched in context for workflow transition\r\n        updatedContext.movieWatched = true;\r\n        updatedContext.movieProgress = 100;\r\n        updatedContext.finalScene = 'genesis_garden';\r\n        \r\n        broadcastEvent({\r\n          type: \"movie_finished\",\r\n          component: \"movie_theater\",\r\n          message: \"Movie finished. Returning to Garden Genesis state.\",\r\n          timestamp: Date.now(),\r\n          data: { completed: true, finalScene: 'genesis_garden' }\r\n        });\r\n        \r\n        console.log(`\uD83C\uDFAC [Movie Theater] Movie finished, context updated with movieWatched: true`);\r\n        console.log(`\uD83C\uDFAC [Movie Theater] Context keys:`, Object.keys(updatedContext));\r\n        \r\n        // Resolve promise to continue workflow\r\n        resolve();\r\n      }, duration * 1000);\r\n    }, 100);\r\n  });\r\n}\r\n\r\n// Chat API Processor Service - Processes user input through all components\r\nasync function processChatInput(input: string, email: string) {\r\n  const startTime = Date.now();\r\n  console.log(`\uD83D\uDE80 Starting processChatInput for ${email}: \"${input.substring(0, 50)}${input.length > 50 ? '...' : ''}\"`);\r\n  \r\n  try {\r\n    // Find or create user by email (no user management needed)\r\n    let user = USERS.find(u => u.email === email);\r\n  if (!user) {\r\n    // Create new user on-the-fly with sequential ID matching USERS array format (u1, u2, u3...)\r\n    const nextId = `u${USERS.length + 1}`;\r\n    \r\n    user = {\r\n      id: nextId, // Sequential ID matching existing format (u1, u2, u3...)\r\n      email: email,\r\n      balance: 0, // NO PRE-LOAD - Wallet is source of truth, starts at 0\r\n    };\r\n    USERS.push(user);\r\n    console.log(`\uD83D\uDC64 Created new user: ${email} with ID: ${nextId}`);\r\n  }\r\n  \r\n  // NO AUTO-GRANT - Wallet balance starts at 0, only increases via Stripe or other credits\r\n  // Sync user.balance with wallet balance (wallet is source of truth)\r\n  const currentWalletBalance = await getWalletBalance(email);\r\n  user.balance = currentWalletBalance;\r\n  \r\n  // Clear any existing Redis balance for bill.draper.auto@gmail.com if it's not from Stripe\r\n  // This ensures we start fresh without pre-loaded balance\r\n  if (email === \"bill.draper.auto@gmail.com\" && !SKIP_REDIS && redis.isOpen) {\r\n    try {\r\n      await ensureRedisConnection();\r\n      const walletKey = `${WALLET_BALANCE_PREFIX}${email}`;\r\n      const existingBalance = await redis.get(walletKey);\r\n      \r\n      // Check if there's a Stripe mint transaction in ledger\r\n      const hasStripeMint = LEDGER.some(entry => \r\n        entry.serviceType === 'mint' && \r\n        entry.merchant === email &&\r\n        entry.bookingDetails?.stripePaymentIntentId\r\n      );\r\n      \r\n      // Only clear if no Stripe transaction exists (means it's old pre-loaded balance)\r\n      if (existingBalance && parseFloat(existingBalance) > 0 && !hasStripeMint) {\r\n        console.log(`\uD83D\uDD04 Clearing pre-loaded balance for ${email}: ${existingBalance} JSC \u2192 0 JSC`);\r\n        await redis.set(walletKey, \"0\");\r\n        user.balance = 0;\r\n      }\r\n    } catch (err: any) {\r\n      console.warn(`\u26A0\uFE0F  Could not clear pre-loaded balance:`, err.message);\r\n    }\r\n  }\r\n\r\n  console.log(\"1\uFE0F\u20E3 User Input\");\r\n  broadcastEvent({\r\n    type: \"user_input\",\r\n    component: \"user\",\r\n    message: `User query: \"${input}\"`,\r\n    timestamp: Date.now(),\r\n    data: { input, email: user.email }\r\n  });\r\n\r\n  console.log(\"2\uFE0F\u20E3 LLM Resolution (Query \u2192 ServiceRegistry \u2192 Providers \u2192 Format)\");\r\n  broadcastEvent({\r\n    type: \"llm_start\",\r\n    component: \"llm\",\r\n    message: \"Starting LLM query extraction...\",\r\n    timestamp: Date.now()\r\n  });\r\n  \r\n  // COMMENTED OUT: resolveLLM is disabled - this code path should not be used for workflows\r\n  // Use formatResponseWithOpenAI/formatResponseWithDeepSeek directly via workflow actions instead\r\n  throw new Error(\"resolveLLM is disabled - use formatResponseWithOpenAI/formatResponseWithDeepSeek directly via workflow actions\");\r\n  \r\n  /* DEAD CODE - All code below is unreachable due to throw above\r\n  const llmResponse: LLMResponse = await resolveLLM(input);\r\n  console.log(\"\uD83D\uDCE8 LLM Response:\", llmResponse.message);\r\n  console.log(\"\u26FD iGas Cost:\", llmResponse.iGasCost.toFixed(6));\r\n  \r\n  broadcastEvent({\r\n    type: \"llm_response\",\r\n    component: \"llm\",\r\n    message: llmResponse.message,\r\n    timestamp: Date.now(),\r\n    data: { response: llmResponse }\r\n  });\r\n  \r\n  // Accumulate total iGas\r\n  addTOTAL_IGAS(llmResponse.iGasCost);\r\n  \r\n  broadcastEvent({\r\n    type: \"igas\",\r\n    component: \"igas\",\r\n    message: `iGas Cost: ${llmResponse.iGasCost.toFixed(6)}`,\r\n    timestamp: Date.now(),\r\n    data: { \r\n      igas: llmResponse.iGasCost,\r\n      totalIGas: getTOTAL_IGAS()\r\n    }\r\n  });\r\n  \r\n  if (!llmResponse.selectedListing) {\r\n    const errorMsg = \"No listing selected from LLM response\";\r\n    console.error(`\u274C ${errorMsg}`);\r\n    broadcastEvent({\r\n      type: \"error\",\r\n      component: \"llm\",\r\n      message: errorMsg,\r\n      timestamp: Date.now()\r\n    });\r\n    throw new Error(errorMsg);\r\n  }\r\n\r\n  const selectedListing = llmResponse.selectedListing;\r\n  \r\n  // Check if this is a DEX trade (TokenListing has poolId, MovieListing has movieTitle)\r\n  const isDEXTrade = selectedListing && ('poolId' in selectedListing || 'tokenSymbol' in selectedListing);\r\n  \r\n  // VALIDATION: Double-check that DEX classification matches user intent\r\n  if (isDEXTrade) {\r\n    const inputLower = input.toLowerCase();\r\n    const movieKeywords = ['movie', 'ticket', 'tickets', 'cinema', 'theater', 'theatre', 'film', 'watch', 'showtime', 'show', 'amc', 'cinemark', 'moviecom'];\r\n    const dexKeywords = ['token', 'tokena', 'tokenb', 'tokenc', 'tokend', 'dex', 'pool', 'trade'];\r\n    \r\n    const hasMovieKeywords = movieKeywords.some(keyword => inputLower.includes(keyword));\r\n    const hasDexKeywords = dexKeywords.some(keyword => inputLower.includes(keyword));\r\n    \r\n    // If user input has movie keywords but NO DEX keywords, this is a misclassification\r\n    if (hasMovieKeywords && !hasDexKeywords) {\r\n      const errorMsg = `\u274C [VALIDATION ERROR] LLM returned DEX listing but user query is clearly for movies. User input: \"${input}\"`;\r\n      console.error(errorMsg);\r\n      broadcastEvent({\r\n        type: \"error\",\r\n        component: \"validation\",\r\n        message: \"Classification error: Movie request was incorrectly processed as DEX trade\",\r\n        timestamp: Date.now(),\r\n        data: { userInput: input, selectedListing }\r\n      });\r\n      throw new Error(`Invalid classification: User requested movie tickets but system selected DEX token. Please try again with: \"I want to buy movie tickets\" or \"find movies\".`);\r\n    }\r\n  }\r\n  \r\n  // CRITICAL: DEX trades should go through workflows, not this direct path\r\n  // This direct path creates duplicate ledger entries. Disabled to prevent duplicates.\r\n  // DEX trades are now handled by the workflow system which creates ledger entries via add_ledger_entry action.\r\n  if (false && isDEXTrade) {\r\n    // DISABLED: Direct DEX trade path - use workflows instead\r\n    // Handle DEX trade\r\n    const tokenListing = selectedListing as TokenListing;\r\n    console.log(\"\uD83C\uDF0A DEX Trade Selected:\", `${tokenListing.providerName} - ${tokenListing.tokenSymbol}/${tokenListing.baseToken} at ${tokenListing.price} ${tokenListing.baseToken}/${tokenListing.tokenSymbol}`);\r\n    \r\n    // Extract trade details from query (re-extract to get action and tokenAmount)\r\n    // TODO (v2 Optimization): Cache intent hash from first extraction in resolveLLM()\r\n    // and reuse here instead of re-extracting. Only re-extract if user confirms/modifies query.\r\n    // This would reduce LLM calls and improve performance.\r\n    let extractQueryFn: (input: string) => Promise<LLMQueryResult>;\r\n    if (ENABLE_OPENAI) {\r\n      extractQueryFn = extractQueryWithOpenAI;\r\n    } else {\r\n      extractQueryFn = extractQueryWithDeepSeek;\r\n    }\r\n    const queryResult = await extractQueryFn(input);\r\n    const action = queryResult.query.filters?.action || 'BUY';\r\n    \r\n    // CRITICAL: Handle both tokenAmount and baseAmount\r\n    // If user specifies baseAmount (e.g., \"Trade 2 SOL with TOKEN\"), convert to tokenAmount\r\n    let tokenAmount = queryResult.query.filters?.tokenAmount;\r\n    const baseAmount = queryResult.query.filters?.baseAmount;\r\n    \r\n    if (baseAmount && baseAmount > 0 && !tokenAmount) {\r\n      // User specified baseAmount (e.g., \"Trade 2 SOL with TOKEN\")\r\n      // Calculate tokenAmount from baseAmount using pool price\r\n      // For BUY: tokenAmount = baseAmount / price (approximately, will be recalculated in executeDEXTrade)\r\n      const poolPrice = tokenListing.price || 0.001; // Default price if missing\r\n      tokenAmount = baseAmount / poolPrice;\r\n      console.log(`   \uD83D\uDCB0 Converting baseAmount to tokenAmount: ${baseAmount} ${tokenListing.baseToken} / ${poolPrice} = ${tokenAmount} ${tokenListing.tokenSymbol}`);\r\n    } else {\r\n      // Use tokenAmount if specified, otherwise default to 1\r\n      tokenAmount = tokenAmount || 1;\r\n    }\r\n    \r\n    console.log(\"\uD83D\uDCB0 Executing DEX Trade...\");\r\n    console.log(`   Action: ${action}`);\r\n    console.log(`   Token Amount: ${tokenAmount} ${tokenListing.tokenSymbol}`);\r\n    if (baseAmount) {\r\n      console.log(`   Base Amount (specified): ${baseAmount} ${tokenListing.baseToken}`);\r\n    }\r\n    console.log(`   Pool: ${tokenListing.poolId}`);\r\n    \r\n    // IMPORTANT: Sync wallet balance BEFORE processing (Google user aware)\r\n    const currentWalletBalance = await getWalletBalance(user.email);\r\n    user.balance = currentWalletBalance;\r\n    \r\n    // Execute DEX trade\r\n    const trade = executeDEXTrade(tokenListing.poolId, action, tokenAmount, user.email);\r\n    \r\n    // Check balance BEFORE processing (for BUY: need baseToken, for SELL: need tokens)\r\n    if (action === 'BUY') {\r\n      const totalCost = trade.baseAmount + llmResponse.iGasCost;\r\n      if (currentWalletBalance < totalCost) {\r\n        const errorMsg = `Insufficient balance. Required: ${totalCost.toFixed(6)} ${tokenListing.baseToken} (${trade.baseAmount} + ${llmResponse.iGasCost.toFixed(6)} iGas), Available: ${currentWalletBalance.toFixed(6)} ${tokenListing.baseToken}`;\r\n        console.error(`\u274C ${errorMsg}`);\r\n        broadcastEvent({\r\n          type: \"insufficient_balance\",\r\n          component: \"wallet\",\r\n          message: errorMsg,\r\n          timestamp: Date.now(),\r\n          data: {\r\n            email: user.email,\r\n            balance: currentWalletBalance,\r\n            required: totalCost,\r\n            tradeAmount: trade.baseAmount,\r\n            iGasCost: llmResponse.iGasCost\r\n          }\r\n        });\r\n        throw new Error(errorMsg);\r\n      }\r\n      user.balance -= trade.baseAmount;\r\n      console.log(`\uD83D\uDCB8 Deducted ${trade.baseAmount} ${tokenListing.baseToken} from user balance`);\r\n    } else {\r\n      // SELL: User receives baseToken\r\n      user.balance += trade.baseAmount;\r\n      console.log(`\uD83D\uDCB0 Added ${trade.baseAmount} ${tokenListing.baseToken} to user balance`);\r\n    }\r\n    \r\n    // Apply trader rebate (30% of iTax back to trader)\r\n    const traderRebate = trade.iTax * ITAX_DISTRIBUTION.trader;\r\n    user.balance += traderRebate;\r\n    console.log(`\uD83C\uDF81 Trader rebate: ${traderRebate.toFixed(6)} ${tokenListing.baseToken}`);\r\n    \r\n    // Create snapshot for DEX trade\r\n    const snapshot = createSnapshot(user.email, trade.baseAmount, tokenListing.providerId);\r\n    \r\n    // Find provider UUID\r\n    const provider = ROOT_CA_SERVICE_REGISTRY.find(p => p.id === tokenListing.providerId);\r\n    const providerUuid = provider?.uuid || '';\r\n    \r\n    // Add ledger entry for DEX trade\r\n    const ledgerEntry = addLedgerEntry(\r\n      snapshot,\r\n      'dex',\r\n      llmResponse.iGasCost,\r\n      user.email,\r\n      tokenListing.providerName,\r\n      providerUuid,\r\n      {\r\n        tokenSymbol: tokenListing.tokenSymbol,\r\n        baseToken: tokenListing.baseToken,\r\n        action: action,\r\n        tokenAmount: tokenAmount,\r\n        baseAmount: trade.baseAmount,\r\n        price: trade.price,\r\n        iTax: trade.iTax,\r\n      } as any\r\n    );\r\n    \r\n    // Complete the trade\r\n    completeBooking(ledgerEntry);\r\n    \r\n    // Persist snapshot and stream to indexers\r\n    await persistSnapshot(snapshot);\r\n    await streamToIndexers(snapshot);\r\n    \r\n    // Deliver webhook if registered\r\n    const webhookProvider = ROOT_CA_SERVICE_REGISTRY.find(p => p.id === tokenListing.providerId);\r\n    if (webhookProvider) {\r\n      deliverWebhook(webhookProvider.id, snapshot, ledgerEntry).catch(err => {\r\n        console.warn(`\u26A0\uFE0F  Webhook delivery failed:`, err);\r\n      });\r\n    }\r\n    \r\n    console.log(\"\u2705 DEX Trade completed successfully\");\r\n    console.log(\"\uD83D\uDCCA Trade Summary:\", {\r\n      action,\r\n      tokenAmount: `${tokenAmount} ${tokenListing.tokenSymbol}`,\r\n      baseAmount: `${trade.baseAmount} ${tokenListing.baseToken}`,\r\n      price: `${trade.price} ${tokenListing.baseToken}/${tokenListing.tokenSymbol}`,\r\n      iTax: `${trade.iTax} ${tokenListing.baseToken}`,\r\n      traderRebate: `${traderRebate} ${tokenListing.baseToken}`,\r\n      userBalance: user.balance,\r\n    });\r\n    \r\n    broadcastEvent({\r\n      type: \"dex_trade_complete\",\r\n      component: \"dex\",\r\n      message: `DEX Trade Complete: ${action} ${tokenAmount} ${tokenListing.tokenSymbol}`,\r\n      timestamp: Date.now(),\r\n      data: {\r\n        trade,\r\n        traderRebate,\r\n        userBalance: user.balance,\r\n        rootCALiquidity: rootCALiquidity,\r\n      }\r\n    });\r\n    \r\n    return; // Exit early for DEX trades\r\n  }\r\n  \r\n  // Continue with movie purchase flow\r\n  console.log(\"\u2705 Selected:\", `${selectedListing.providerName} - ${selectedListing.movieTitle} at ${selectedListing.showtime} for ${selectedListing.price} USDC`);\r\n  console.log(\"\uD83D\uDCCB Selected listing details:\", {\r\n    providerId: selectedListing.providerId,\r\n    providerName: selectedListing.providerName,\r\n    movieTitle: selectedListing.movieTitle\r\n  });\r\n\r\n  console.log(\"3\uFE0F\u20E3 Ledger: Create Booking Entry\");\r\n  const moviePrice = selectedListing.price;\r\n  \r\n  // IMPORTANT: Check wallet balance BEFORE creating ledger entry (Google user aware)\r\n  // Re-sync user.balance with wallet balance (wallet is source of truth)\r\n  // Note: currentWalletBalance was already declared at function start, so we update it\r\n  const updatedWalletBalance = await getWalletBalance(user.email);\r\n  user.balance = updatedWalletBalance;\r\n  \r\n  // Check if user has sufficient balance BEFORE creating ledger entry\r\n  const totalCost = moviePrice + llmResponse.iGasCost;\r\n  if (updatedWalletBalance < totalCost) {\r\n    const errorMsg = `Insufficient balance. Required: ${totalCost.toFixed(6)} \uD83C\uDF4E APPLES (${moviePrice} + ${llmResponse.iGasCost.toFixed(6)} iGas), Available: ${updatedWalletBalance.toFixed(6)} \uD83C\uDF4E APPLES`;\r\n    console.error(`\u274C ${errorMsg}`);\r\n    broadcastEvent({\r\n      type: \"insufficient_balance\",\r\n      component: \"wallet\",\r\n      message: errorMsg,\r\n      timestamp: Date.now(),\r\n      data: {\r\n        email: user.email,\r\n        balance: updatedWalletBalance,\r\n        required: totalCost,\r\n        moviePrice: moviePrice,\r\n        iGasCost: llmResponse.iGasCost\r\n      }\r\n    });\r\n    throw new Error(errorMsg);\r\n  }\r\n  \r\n  // Create snapshot first (needed for ledger entry)\r\n  const snapshot = createSnapshot(user.email, moviePrice, selectedListing.providerId);\r\n  \r\n  // Find provider UUID from ROOT_CA_SERVICE_REGISTRY\r\n  console.log(`\uD83D\uDD0D Looking up provider UUID for providerId: \"${selectedListing.providerId}\"`);\r\n  console.log(`\uD83D\uDCCB Available provider IDs in ROOT_CA_SERVICE_REGISTRY:`, ROOT_CA_SERVICE_REGISTRY.map(p => `${p.id} (${p.name})`));\r\n  \r\n  const provider = ROOT_CA_SERVICE_REGISTRY.find(p => p.id === selectedListing.providerId);\r\n  const providerUuid = provider?.uuid || '';\r\n  \r\n  if (!providerUuid) {\r\n    const errorMsg = `Provider UUID not found for providerId: \"${selectedListing.providerId}\"`;\r\n    console.error(`\u274C ${errorMsg}`);\r\n    console.error(`   Provider found:`, provider ? 'YES' : 'NO');\r\n    if (provider) {\r\n      console.error(`   Provider object:`, JSON.stringify(provider, null, 2));\r\n    }\r\n    console.error(`   Selected listing providerId:`, selectedListing.providerId);\r\n    console.error(`   Selected listing providerName:`, selectedListing.providerName);\r\n    throw new Error(errorMsg);\r\n  } else {\r\n    console.log(`\u2705 Found provider UUID: ${providerUuid} for provider: ${selectedListing.providerName} (${selectedListing.providerId})`);\r\n  }\r\n  \r\n  // Validate service provider certificate\r\n  if (!provider) {\r\n    throw new Error(`Provider not found for providerId: \"${selectedListing.providerId}\"`);\r\n  }\r\n  \r\n  console.log(\"\uD83D\uDD10 Validating service provider certificate...\");\r\n  const isCertValid = validateCertificate(providerUuid);\r\n  if (!isCertValid) {\r\n    const errorMsg = `Service provider certificate invalid or revoked: ${provider.name}`;\r\n    console.error(`\u274C ${errorMsg}`);\r\n    broadcastEvent({\r\n      type: \"certificate_validation_failed\",\r\n      component: \"root-ca\",\r\n      message: errorMsg,\r\n      timestamp: Date.now(),\r\n      data: { providerUuid, providerName: provider.name }\r\n    });\r\n    throw new Error(errorMsg);\r\n  }\r\n  \r\n  const providerCert = getCertificate(providerUuid);\r\n  if (providerCert) {\r\n    console.log(`\u2705 Certificate validated for ${provider.name}`);\r\n    console.log(`   Capabilities: ${providerCert.capabilities.join(\", \")}`);\r\n    console.log(`   Expires: ${new Date(providerCert.expiresAt).toISOString()}`);\r\n    \r\n    broadcastEvent({\r\n      type: \"certificate_validated\",\r\n      component: \"root-ca\",\r\n      message: `Certificate validated for ${provider.name}`,\r\n      timestamp: Date.now(),\r\n      data: {\r\n        providerUuid,\r\n        providerName: provider.name,\r\n        capabilities: providerCert.capabilities,\r\n        expiresAt: providerCert.expiresAt\r\n      }\r\n    });\r\n  }\r\n\r\n  // Add ledger entry for this booking\r\n  // NOTE: addLedgerEntry() in src/ledger.ts should broadcast \"ledger_entry_added\" event\r\n  // But we also broadcast here to ensure it happens (fallback)\r\n  // Determine service type from selected listing or default to 'service'\r\n  const detectedServiceType = selectedListing.serviceType || \r\n                              (selectedListing.movieTitle ? 'movie' : \r\n                               selectedListing.flightNumber ? 'airline' :\r\n                               selectedListing.hotelName ? 'hotel' :\r\n                               selectedListing.restaurantName ? 'restaurant' :\r\n                               selectedListing.grocerystoreName ? 'grocerystore' :\r\n                               selectedListing.pharmacyName ? 'pharmacy' :\r\n                               selectedListing.dogparkName ? 'dogpark' :\r\n                               selectedListing.gasstationName ? 'gasstation' :\r\n                               selectedListing.partyName ? 'party' :\r\n                               selectedListing.bankName ? 'bank' :\r\n                               selectedListing.partName ? 'autoparts' :\r\n                               selectedListing.tokenSymbol ? 'dex' : 'service');\r\n  \r\n  // Import extractBookingDetails to dynamically extract booking details\r\n  const { extractBookingDetails } = await import(\"./src/serviceTypeFields\");\r\n  const bookingDetails = extractBookingDetails(detectedServiceType, selectedListing);\r\n  \r\n  const ledgerEntry = addLedgerEntry(\r\n    snapshot,\r\n    detectedServiceType,\r\n    llmResponse.iGasCost,\r\n    user.email, // Pass email address (payerId will be set to email)\r\n    selectedListing.providerName, // Provider name (e.g., \"AMC Theatres\", \"Airline Provider\", etc.)\r\n    providerUuid, // Service provider UUID for certificate issuance\r\n    bookingDetails // Dynamically extracted booking details based on service type\r\n  );\r\n\r\n  // CRITICAL: Broadcast ledger_entry_created event (matches old codebase pattern exactly)\r\n  // Old codebase only broadcasted \"ledger_entry_created\", not \"ledger_entry_added\"\r\n  console.log(`\uD83D\uDCE1 [Broadcast] \u2B50 Sending ledger_entry_created event from processChatInput: ${ledgerEntry.entryId}`);\r\n  broadcastEvent({\r\n    type: \"ledger_entry_created\",\r\n    component: \"ledger\",\r\n    message: `Ledger entry created for booking: ${ledgerEntry.entryId}`,\r\n    timestamp: Date.now(),\r\n    data: { entry: ledgerEntry }\r\n  });\r\n  \r\n  // Also broadcast ledger_entry_added for backward compatibility (Angular listens for both)\r\n  console.log(`\uD83D\uDCE1 [Broadcast] \u2B50 Sending ledger_entry_added event from processChatInput: ${ledgerEntry.entryId}`);\r\n  broadcastEvent({\r\n    type: \"ledger_entry_added\",\r\n    component: \"ledger\",\r\n    message: `Ledger entry created: ${ledgerEntry.entryId}`,\r\n    timestamp: Date.now(),\r\n    data: { entry: ledgerEntry }\r\n  });\r\n\r\n  console.log(\"4\uFE0F\u20E3 Cashier: Process Payment\");\r\n  broadcastEvent({\r\n    type: \"cashier_start\",\r\n    component: \"cashier\",\r\n    message: `${getCashierStatus().name} processing payment...`,\r\n    timestamp: Date.now(),\r\n    data: { cashier: getCashierStatus() }\r\n  });\r\n\r\n  const paymentSuccess = await processPayment(getCashierStatus(), ledgerEntry, user);\r\n  if (!paymentSuccess) {\r\n    const errorMsg = `Payment failed. Balance: ${user.balance}, Required: ${moviePrice}`;\r\n    console.error(`\u274C ${errorMsg}`);\r\n    throw new Error(errorMsg);\r\n  }\r\n  \r\n  // REMOVED: Duplicate cashier_payment_processed broadcast\r\n  // processPayment() in ledger.ts already broadcasts this event, so we don't need to broadcast it again here\r\n  // This prevents duplicate confirmation messages from appearing in the frontend\r\n  \r\n  // Also broadcast purchase event (matches old codebase pattern)\r\n  console.log(`\uD83D\uDCE1 [Broadcast] \u2B50 Sending purchase event from processChatInput: ${selectedListing.movieTitle || 'service'}`);\r\n  broadcastEvent({\r\n    type: \"purchase\",\r\n    component: \"transaction\",\r\n    message: `Purchased ${selectedListing.movieTitle || 'service'} for ${moviePrice} \uD83C\uDF4E APPLES`,\r\n    timestamp: Date.now(),\r\n    data: { listing: selectedListing, price: moviePrice, ledgerEntry: ledgerEntry.entryId }\r\n  });\r\n  \r\n  // Small delay to ensure WebSocket events are sent before function continues\r\n  await new Promise(resolve => setImmediate(resolve));\r\n\r\n  broadcastEvent({\r\n    type: \"purchase\",\r\n    component: \"transaction\",\r\n    message: `Purchased ${selectedListing.movieTitle} for ${moviePrice} USDC`,\r\n    timestamp: Date.now(),\r\n    data: { listing: selectedListing, price: moviePrice, ledgerEntry: ledgerEntry.entryId }\r\n  });\r\n\r\n  console.log(\"5\uFE0F\u20E3 Snapshot + Persist\");\r\n  broadcastEvent({\r\n    type: \"snapshot_start\",\r\n    component: \"snapshot\",\r\n    message: \"Creating transaction snapshot...\",\r\n    timestamp: Date.now()\r\n  });\r\n  \r\n  await persistSnapshot(snapshot);\r\n  \r\n  broadcastEvent({\r\n    type: \"snapshot_success\",\r\n    component: \"snapshot\",\r\n    message: `Snapshot created: ${snapshot.txId}`,\r\n    timestamp: Date.now(),\r\n    data: { snapshot }\r\n  });\r\n\r\n  console.log(\"6\uFE0F\u20E3 Stream to Indexers\");\r\n  broadcastEvent({\r\n    type: \"indexer_stream\",\r\n    component: \"redis\",\r\n    message: \"Streaming to indexers...\",\r\n    timestamp: Date.now()\r\n  });\r\n  \r\n  await streamToIndexers(snapshot);\r\n\r\n  console.log(\"7\uFE0F\u20E3 Watch Movie \uD83C\uDFAC\");\r\n  broadcastEvent({\r\n    type: \"movie_watch\",\r\n    component: \"user\",\r\n    message: `Watching ${selectedListing.movieTitle}...`,\r\n    timestamp: Date.now()\r\n  });\r\n\r\n  // Complete the booking in ledger\r\n  completeBooking(ledgerEntry);\r\n  \r\n  // Deliver webhook notification (best effort, async)\r\n  const webhookProvider = ROOT_CA_SERVICE_REGISTRY.find(p => p.id === selectedListing.providerId);\r\n  if (webhookProvider) {\r\n    deliverWebhook(webhookProvider.id, snapshot, ledgerEntry).catch(err => {\r\n      console.warn(`\u26A0\uFE0F  Webhook delivery failed:`, err);\r\n    });\r\n  }\r\n\r\n  console.log(\"8\uFE0F\u20E3 Review\");\r\n  const rebate = await applyReview(user, {\r\n    userId: user.id,\r\n    movieId: selectedListing.movieId,\r\n    rating: 5,\r\n  }, moviePrice);\r\n\r\n  console.log(\"8\uFE0F\u20E3 Summary\");\r\n  const summary = {\r\n    balance: user.balance,\r\n    rebate,\r\n    fees: snapshot.feeSplit,\r\n    iGasCost: llmResponse.iGasCost,\r\n    selectedProvider: selectedListing.providerName,\r\n    movie: selectedListing.movieTitle,\r\n  };\r\n  console.log(summary);\r\n  \r\n  broadcastEvent({\r\n    type: \"summary\",\r\n    component: \"transaction\",\r\n    message: \"Transaction completed successfully\",\r\n    timestamp: Date.now(),\r\n    data: summary\r\n  });\r\n\r\n  console.log(\"9\uFE0F\u20E3 Done\\n\");\r\n  \r\n  const duration = Date.now() - startTime;\r\n  console.log(`\u2705 processChatInput completed in ${duration}ms for ${email}`);\r\n  */\r\n  } catch (error: any) {\r\n    const duration = Date.now() - startTime;\r\n    console.error(`\u274C processChatInput failed after ${duration}ms for ${email}:`, error);\r\n    throw error; // Re-throw to be handled by HTTP handler\r\n  }\r\n}\r\n\r\n// ============================================\r\n// SYSTEM PROMPT GENERATION (Holy Ghost Service)\r\n// ============================================\r\nasync function generateSystemPrompts(description: string, serviceType: string): Promise<any> {\r\n  const prompt = `Generate system prompts for an Eden service provider.\r\n\r\nService Type: ${serviceType}\r\nDescription: ${description}\r\n\r\nGenerate two prompts:\r\n1. Query Extraction Prompt: Instructions for extracting user intent from natural language queries\r\n2. Response Formatting Prompt: Instructions for formatting provider responses\r\n\r\nIMPORTANT: In all generated prompts and responses, use \"\uD83C\uDF4E APPLES\" as the currency name instead of \"JSC\" or \"JesusCoin\". All user-facing messages about prices, payments, and transactions should display \"\uD83C\uDF4E APPLES\".\r\n\r\nReturn JSON with:\r\n{\r\n  \"queryExtractionPrompt\": \"...\",\r\n  \"responseFormattingPrompt\": \"...\",\r\n  \"metadata\": {\r\n    \"description\": \"${description}\",\r\n    \"serviceType\": \"${serviceType}\",\r\n    \"requiredFields\": [...],\r\n    \"ledgerFields\": [...]\r\n  }\r\n}`;\r\n\r\n  if (MOCKED_LLM) {\r\n    return {\r\n      queryExtractionPrompt: `You are Eden Core AI query processor for ${serviceType} services.\\nExtract service query from user input.\\nReturn JSON only with: query (object with serviceType and filters), serviceType, confidence.`,\r\n      responseFormattingPrompt: `You are Eden Core AI response formatter for ${serviceType} services.\\nFormat service provider listings into user-friendly chat response.`,\r\n      metadata: {\r\n        description,\r\n        serviceType,\r\n        requiredFields: [],\r\n        ledgerFields: []\r\n      },\r\n      generatedAt: Date.now(),\r\n      generatedBy: ROOT_CA_UUID,\r\n      iGasCost: 0.0025,\r\n      version: 1\r\n    };\r\n  }\r\n\r\n  try {\r\n    // Check if API keys are available\r\n    const hasOpenAIKey = process.env.OPENAI_API_KEY && process.env.OPENAI_API_KEY.trim() !== \"\";\r\n    const hasDeepSeekKey = process.env.DEEPSEEK_API_KEY && process.env.DEEPSEEK_API_KEY.trim() !== \"\";\r\n    \r\n    if (!hasOpenAIKey && !hasDeepSeekKey) {\r\n      console.warn(`\u26A0\uFE0F  No LLM API keys found, using mocked response`);\r\n      // Fallback to mocked response if no API keys\r\n      return {\r\n        queryExtractionPrompt: `You are Eden Core AI query processor for ${serviceType} services.\\nExtract service query from user input.\\nReturn JSON only with: query (object with serviceType and filters), serviceType, confidence.`,\r\n        responseFormattingPrompt: `You are Eden Core AI response formatter for ${serviceType} services.\\nFormat service provider listings into user-friendly chat response.`,\r\n        metadata: {\r\n          description,\r\n          serviceType,\r\n          requiredFields: [],\r\n          ledgerFields: []\r\n        },\r\n        generatedAt: Date.now(),\r\n        generatedBy: ROOT_CA_UUID,\r\n        iGasCost: 0.0025,\r\n        version: 1\r\n      };\r\n    }\r\n    \r\n    const response = await callLLM(prompt, ENABLE_OPENAI && hasOpenAIKey);\r\n    const parsed = JSON.parse(response);\r\n    return {\r\n      ...parsed,\r\n      generatedAt: Date.now(),\r\n      generatedBy: ROOT_CA_UUID,\r\n      iGasCost: 0.0025,\r\n      version: 1\r\n    };\r\n  } catch (err: any) {\r\n    console.error(`\u274C Failed to generate system prompts:`, err.message);\r\n    // Fallback to mocked response on error\r\n    console.warn(`\u26A0\uFE0F  Falling back to mocked response due to error`);\r\n    return {\r\n      queryExtractionPrompt: `You are Eden Core AI query processor for ${serviceType} services.\\nExtract service query from user input.\\nReturn JSON only with: query (object with serviceType and filters), serviceType, confidence.`,\r\n      responseFormattingPrompt: `You are Eden Core AI response formatter for ${serviceType} services.\\nFormat service provider listings into user-friendly chat response.`,\r\n      metadata: {\r\n        description,\r\n        serviceType,\r\n        requiredFields: [],\r\n        ledgerFields: []\r\n      },\r\n      generatedAt: Date.now(),\r\n      generatedBy: ROOT_CA_UUID,\r\n      iGasCost: 0.0025,\r\n      version: 1\r\n    };\r\n  }\r\n}\r\n\r\n// ============================================\r\n// NOTIFICATION CODE GENERATION (Holy Ghost Service)\r\n// ============================================\r\nasync function generateNotificationCode(config: {\r\n  providerId: string;\r\n  providerName: string;\r\n  language: string;\r\n  framework: string;\r\n  indexerEndpoint: string;\r\n  webhookUrl: string;\r\n  serviceType: string;\r\n  notificationMethods: string[];\r\n}): Promise<any> {\r\n  const prompt = `Generate notification code for an Eden service provider integration.\r\n\r\nProvider ID: ${config.providerId}\r\nProvider Name: ${config.providerName}\r\nLanguage: ${config.language}\r\nFramework: ${config.framework}\r\nIndexer Endpoint: ${config.indexerEndpoint}\r\nWebhook URL: ${config.webhookUrl}\r\nService Type: ${config.serviceType}\r\nNotification Methods: ${config.notificationMethods.join(\", \")}\r\n\r\nGenerate code that implements:\r\n1. Webhook receiver (if webhook in methods)\r\n2. Pull/poll client (if pull in methods)\r\n3. RPC client (if rpc in methods)\r\n\r\nReturn JSON with:\r\n{\r\n  \"webhookCode\": \"...\",\r\n  \"pullCode\": \"...\",\r\n  \"rpcCode\": \"...\",\r\n  \"readme\": \"...\"\r\n}`;\r\n\r\n  if (MOCKED_LLM) {\r\n    return {\r\n      webhookCode: `// Webhook receiver for ${config.providerId}\\n// POST ${config.webhookUrl}`,\r\n      pullCode: `// Pull/poll client for ${config.providerId}\\n// Poll ${config.indexerEndpoint}/rpc/tx/status`,\r\n      rpcCode: `// RPC client for ${config.providerId}\\n// GET ${config.indexerEndpoint}/rpc/getTransactionByPayer`,\r\n      readme: `# ${config.providerName} Integration\\n\\nThis code implements ${config.notificationMethods.join(\", \")} notification methods.`,\r\n      generatedAt: Date.now(),\r\n      generatedBy: ROOT_CA_UUID,\r\n      iGasCost: 0.0040,\r\n      version: 1\r\n    };\r\n  }\r\n\r\n  try {\r\n    // Check if API keys are available\r\n    const hasOpenAIKey = process.env.OPENAI_API_KEY && process.env.OPENAI_API_KEY.trim() !== \"\";\r\n    const hasDeepSeekKey = process.env.DEEPSEEK_API_KEY && process.env.DEEPSEEK_API_KEY.trim() !== \"\";\r\n    \r\n    if (!hasOpenAIKey && !hasDeepSeekKey) {\r\n      console.warn(`\u26A0\uFE0F  No LLM API keys found, using mocked response`);\r\n      // Fallback to mocked response if no API keys\r\n      return {\r\n        webhookCode: `// Webhook receiver for ${config.providerId}\\n// POST ${config.webhookUrl}`,\r\n        pullCode: `// Pull/poll client for ${config.providerId}\\n// Poll ${config.indexerEndpoint}/rpc/tx/status`,\r\n        rpcCode: `// RPC client for ${config.providerId}\\n// GET ${config.indexerEndpoint}/rpc/getTransactionByPayer`,\r\n        readme: `# ${config.providerName} Integration\\n\\nThis code implements ${config.notificationMethods.join(\", \")} notification methods.`,\r\n        generatedAt: Date.now(),\r\n        generatedBy: ROOT_CA_UUID,\r\n        iGasCost: 0.0040,\r\n        version: 1\r\n      };\r\n    }\r\n    \r\n    const response = await callLLM(prompt, ENABLE_OPENAI && hasOpenAIKey);\r\n    const parsed = JSON.parse(response);\r\n    return {\r\n      ...parsed,\r\n      generatedAt: Date.now(),\r\n      generatedBy: ROOT_CA_UUID,\r\n      iGasCost: 0.0040,\r\n      version: 1\r\n    };\r\n  } catch (err: any) {\r\n    console.error(`\u274C Failed to generate notification code:`, err.message);\r\n    // Fallback to mocked response on error\r\n    console.warn(`\u26A0\uFE0F  Falling back to mocked response due to error`);\r\n    return {\r\n      webhookCode: `// Webhook receiver for ${config.providerId}\\n// POST ${config.webhookUrl}`,\r\n      pullCode: `// Pull/poll client for ${config.providerId}\\n// Poll ${config.indexerEndpoint}/rpc/tx/status`,\r\n      rpcCode: `// RPC client for ${config.providerId}\\n// GET ${config.indexerEndpoint}/rpc/getTransactionByPayer`,\r\n      readme: `# ${config.providerName} Integration\\n\\nThis code implements ${config.notificationMethods.join(\", \")} notification methods.`,\r\n      generatedAt: Date.now(),\r\n      generatedBy: ROOT_CA_UUID,\r\n      iGasCost: 0.0040,\r\n      version: 1\r\n    };\r\n  }\r\n}\r\n\r\n// NOTE: callLLM is imported from src/llm.ts (line 102 and 127)\r\n// The local callLLM function has been removed to use the imported one with hardcoded API key\r\n\r\n// Main Server Initialization\r\nasync function main() {\r\n  console.log(\"\uD83C\uDF31 Eden Core Starting...\\n\");\r\n  console.log(\"\uD83D\uDCCB CLI Flags:\", {\r\n    mockedLLM: MOCKED_LLM,\r\n    skipRedis: SKIP_REDIS,\r\n    enableOpenAI: ENABLE_OPENAI,\r\n    deployedAsRoot: DEPLOYED_AS_ROOT,\r\n    numIndexers: NUM_GARDENS,\r\n    numTokenIndexers: NUM_TOKEN_GARDENS,\r\n  }, \"\\n\");\r\n  \r\n  if (DEPLOYED_AS_ROOT) {\r\n    console.log(\"\uD83D\uDD37 DEPLOYED AS ROOT MODE: Only ROOT CA and Holy Ghost will be initialized\");\r\n    console.log(\"   All additional indexers will be created via Angular UI wizard\\n\");\r\n  }\r\n  \r\n  console.log(`\u2728 Holy Ghost (ROOT CA Indexer) configured: ${HOLY_GHOST_GARDEN.name}`);\r\n  if (!DEPLOYED_AS_ROOT) {\r\n    console.log(`\uD83C\uDF33 Regular Indexers configured: ${GARDENS.map(i => i.name).join(\", \")}`);\r\n    console.log(`\uD83D\uDD37 Token Indexers configured: ${TOKEN_GARDENS.map(i => i.name).join(\", \")}\\n`);\r\n  } else {\r\n    console.log(`\uD83C\uDF33 Regular Indexers: 0 (will be created via UI)`);\r\n    console.log(`\uD83D\uDD37 Token Indexers: 0 (will be created via UI)\\n`);\r\n  }\r\n\r\n  // Initialize ROOT CA\r\n  initializeRootCA();\r\n  \r\n  // Initialize Identity System\r\n  initializeIdentity();\r\n  \r\n  // Initialize Universal Messaging System\r\n  initializeMessaging();\r\n  console.log(\"\u2705 [Messaging] Universal Messaging System initialized\");\r\n  \r\n  // Initialize Rule-Based Governance System (v1.24)\r\n  const { initializeGovernance } = require(\"./src/governance/governanceService\");\r\n  const dataPath = path.join(__dirname, \"data\");\r\n  initializeGovernance(dataPath);\r\n  console.log(\"\u2705 [Governance] Rule-Based Governance System (v1.24) initialized\");\r\n  \r\n  // Initialize logger FIRST (needed for tracing garden lifecycle)\r\n  initializeLogger();\r\n  \r\n  // Initialize all modules BEFORE issuing certificates (needed for broadcastEvent)\r\n  console.log(\"\\n\uD83D\uDD27 Initializing modules...\");\r\n  \r\n  // Initialize FlowWise workflow engine\r\n  initializeFlowWise(broadcastEvent, path.join(__dirname, \"data\"));\r\n  console.log(\"\u2705 [FlowWise] Workflow engine initialized\");\r\n  \r\n  // Initialize FlowWiseService as ROOT CA service (NEW ARCHITECTURE)\r\n  // SECURITY: FlowWiseService MUST be certified by ROOT CA to prevent ghost workflows\r\n  initializeFlowWiseService(broadcastEvent, path.join(__dirname, \"data\"), ROOT_CA, ROOT_CA_IDENTITY, redis);\r\n  console.log(\"\u2705 [FlowWiseService] ROOT CA workflow service initialized and certified with Redis instance\");\r\n  \r\n  // Initialize garden module (needed for issueGardenCertificate to use broadcastEvent)\r\n  initializeGarden(broadcastEvent, redis);\r\n\r\n  // Load provider plugin persistence (MySQL/MariaDB configs per providerId)\r\n  loadProviderPluginPersistence();\r\n  \r\n  // Issue certificate to Holy Ghost (ROOT CA Indexer)\r\n  console.log(\"\\n\u2728 Issuing certificate to Holy Ghost (ROOT CA Indexer)...\");\r\n  try {\r\n    issueGardenCertificate(HOLY_GHOST_GARDEN);\r\n    console.log(`   \u2705 Certificate issued to ${HOLY_GHOST_GARDEN.name}`);\r\n  } catch (err: any) {\r\n    console.error(`   \u274C Failed to issue certificate to ${HOLY_GHOST_GARDEN.name}:`, err.message);\r\n  }\r\n  \r\n  // Only initialize regular indexers if NOT in root-only mode\r\n  if (!DEPLOYED_AS_ROOT) {\r\n    // Issue certificates to all regular indexers (including restored ones)\r\n    console.log(\"\\n\uD83C\uDF33 Issuing certificates to Regular Indexers...\");\r\n    for (const indexer of GARDENS) {\r\n      if (indexer.active) {\r\n        // Check if certificate exists in registry (not just in indexer object)\r\n        const existingCert = CERTIFICATE_REGISTRY.get(indexer.uuid);\r\n        if (!existingCert) {\r\n          try {\r\n            issueGardenCertificate(indexer);\r\n            console.log(`   \u2705 Certificate issued to ${indexer.name} (${indexer.id})`);\r\n          } catch (err: any) {\r\n            console.error(`   \u274C Failed to issue certificate to ${indexer.name}:`, err.message);\r\n          }\r\n        } else {\r\n          // Certificate already exists, restore it to indexer object\r\n          indexer.certificate = existingCert;\r\n          console.log(`   \u2705 Certificate already exists for ${indexer.name} (${indexer.id})`);\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Issue certificates to all token indexers (needed for pool initialization)\r\n    console.log(\"\\n\uD83D\uDD37 Issuing certificates to Token Indexers...\");\r\n    for (const tokenIndexer of TOKEN_GARDENS) {\r\n      if (tokenIndexer.active) {\r\n        // Check if certificate exists in registry (not just in indexer object)\r\n        const existingCert = CERTIFICATE_REGISTRY.get(tokenIndexer.uuid);\r\n        if (!existingCert) {\r\n          try {\r\n            issueGardenCertificate(tokenIndexer);\r\n            console.log(`   \u2705 Certificate issued to ${tokenIndexer.name} (${tokenIndexer.id})`);\r\n          } catch (err: any) {\r\n            console.error(`   \u274C Failed to issue certificate to ${tokenIndexer.name}:`, err.message);\r\n          }\r\n        } else {\r\n          // Certificate already exists, restore it to indexer object\r\n          tokenIndexer.certificate = existingCert;\r\n          console.log(`   \u2705 Certificate already exists for ${tokenIndexer.name} (${tokenIndexer.id})`);\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Initialize all remaining modules (required for both ROOT and non-ROOT modes)\r\n  console.log(\"\\n\uD83D\uDD27 Initializing remaining modules...\");\r\n  \r\n  // Initialize wallet module with dependencies\r\n  initializeWallet(redis, SKIP_REDIS, ensureRedisConnection, broadcastEvent);\r\n  \r\n  // Initialize service provider module with dependencies\r\n  initializeServiceProvider(broadcastEvent);\r\n  \r\n  // Initialize DEX module with dependencies\r\n  initializeDEX(broadcastEvent);\r\n  \r\n  // Initialize ledger module with dependencies\r\n  const CASHIER: Cashier = {\r\n    id: \"cashier-eden-001\",\r\n    name: \"Eden Cashier\",\r\n    processedCount: 0,\r\n    totalProcessed: 0,\r\n    status: 'active',\r\n  };\r\n  initializeLedger(broadcastEvent, redis, ensureRedisConnection, SKIP_REDIS, CASHIER);\r\n  \r\n  // Initialize LLM module with dependencies\r\n  initializeLLM(broadcastEvent);\r\n  \r\n  // Initialize DEX Price Broadcaster (real-time price updates and trade events)\r\n  initializePriceBroadcaster(broadcastEvent);\r\n  console.log(\"\u2705 [DEX Price Broadcaster] Real-time price update service initialized\");\r\n  \r\n  // Initialize PriestHood Certification Service\r\n  initializePriesthoodCertification();\r\n  \r\n  // Initialize Accountant Service (tracks fee payments and total iGas)\r\n  const { initializeAccountant } = await import(\"./src/accountant\");\r\n  initializeAccountant();\r\n  \r\n  // Initialize Liquidity Accountant Service (tracks DEX token pool liquidity)\r\n  const { initializeLiquidityAccountant } = await import(\"./src/liquidityAccountant\");\r\n  initializeLiquidityAccountant();\r\n  console.log(\"\u2705 [PriestHood Certification] Service initialized\");\r\n  \r\n  // NOTE: ServiceRegistry2 initialization is deferred until AFTER gardens are loaded from persistence\r\n  // This ensures that providers with gardenId references can be properly loaded\r\n  // See below where gardens are restored from persistence\r\n  \r\n  // CRITICAL: Add infrastructure providers to ServiceRegistry2 if they don't exist\r\n  // These are the default infrastructure providers that should always be present\r\n  const infrastructureProviders: ServiceProviderWithCert[] = [\r\n    {\r\n      id: \"stripe-payment-rail-001\",\r\n      uuid: \"550e8400-e29b-41d4-a716-446655440100\",\r\n      name: \"Stripe Payment Rail\",\r\n      serviceType: \"payment-rail\",\r\n      location: \"Global\",\r\n      bond: 50000,\r\n      reputation: 5.0,\r\n      gardenId: \"HG\",\r\n      apiEndpoint: \"https://api.stripe.com/v1\",\r\n      status: 'active'\r\n    },\r\n    {\r\n      id: \"settlement-service-001\",\r\n      uuid: \"550e8400-e29b-41d4-a716-446655440101\",\r\n      name: \"Settlement Service\",\r\n      serviceType: \"settlement\",\r\n      location: \"ROOT CA\",\r\n      bond: 100000,\r\n      reputation: 5.0,\r\n      gardenId: \"HG\",\r\n      apiEndpoint: \"internal://settlement\",\r\n      status: 'active'\r\n    },\r\n    {\r\n      id: \"service-registry-001\",\r\n      uuid: \"550e8400-e29b-41d4-a716-446655440102\",\r\n      name: \"Service Registry\",\r\n      serviceType: \"registry\",\r\n      location: \"ROOT CA\",\r\n      bond: 50000,\r\n      reputation: 5.0,\r\n      gardenId: \"HG\",\r\n      apiEndpoint: \"internal://service-registry\",\r\n      status: 'active'\r\n    },\r\n    {\r\n      id: \"webserver-service-001\",\r\n      uuid: \"550e8400-e29b-41d4-a716-446655440103\",\r\n      name: \"Web Server\",\r\n      serviceType: \"webserver\",\r\n      location: \"ROOT CA\",\r\n      bond: 10000,\r\n      reputation: 5.0,\r\n      gardenId: \"HG\",\r\n      apiEndpoint: `http://localhost:${HTTP_PORT}`,\r\n      status: 'active'\r\n    },\r\n    {\r\n      id: \"websocket-service-001\",\r\n      uuid: \"550e8400-e29b-41d4-a716-446655440104\",\r\n      name: \"WebSocket Service\",\r\n      serviceType: \"websocket\",\r\n      location: \"ROOT CA\",\r\n      bond: 10000,\r\n      reputation: 5.0,\r\n      gardenId: \"HG\",\r\n      apiEndpoint: `ws://localhost:${HTTP_PORT}`,\r\n      status: 'active'\r\n    },\r\n    {\r\n      id: \"wallet-service-001\",\r\n      uuid: \"550e8400-e29b-41d4-a716-446655440105\",\r\n      name: \"JesusCoin Wallet Service\",\r\n      serviceType: \"wallet\",\r\n      location: \"ROOT CA\",\r\n      bond: 200000,\r\n      reputation: 5.0,\r\n      gardenId: \"HG\",\r\n      apiEndpoint: \"internal://wallet\",\r\n      status: 'active'\r\n    },\r\n    {\r\n      id: \"accountant-service-001\",\r\n      uuid: \"550e8400-e29b-41d4-a716-446655440106\",\r\n      name: \"Accountant Service\",\r\n      serviceType: \"accountant\",\r\n      location: \"ROOT CA\",\r\n      bond: 75000,\r\n      reputation: 5.0,\r\n      gardenId: \"HG\",\r\n      apiEndpoint: \"internal://accountant\",\r\n      status: 'active'\r\n    }\r\n  ];\r\n  \r\n  // NOTE: ServiceRegistry2 initialization and infrastructure provider addition\r\n  // will happen AFTER gardens are loaded from persistence (see below around line 9393)\r\n  \r\n  console.log(\"   \u2705 All modules initialized\");\r\n  \r\n  // DEBUG (opt-in): Dump in-memory service registry snapshot to disk.\r\n  // IMPORTANT: writeFileSync in a tight loop will block the Node event loop and make the UI feel \"frozen\".\r\n  // Enable only when debugging:\r\n  //   - PowerShell: `$env:EDEN_DEBUG_SERVICE_REGISTRY_DUMP='true'`\r\n  // Optional tuning:\r\n  //   - `$env:EDEN_DEBUG_SERVICE_REGISTRY_DUMP_INTERVAL_MS='15000'`\r\n  const EDEN_DEBUG_SERVICE_REGISTRY_DUMP =\r\n    String(process.env.EDEN_DEBUG_SERVICE_REGISTRY_DUMP || \"\").toLowerCase() === \"true\";\r\n  const EDEN_DEBUG_SERVICE_REGISTRY_DUMP_INTERVAL_MS = Math.max(\r\n    5000,\r\n    parseInt(String(process.env.EDEN_DEBUG_SERVICE_REGISTRY_DUMP_INTERVAL_MS || \"15000\"), 10) || 15000\r\n  );\r\n\r\n  if (EDEN_DEBUG_SERVICE_REGISTRY_DUMP) {\r\n    let dumpInFlight = false;\r\n    setInterval(async () => {\r\n      if (dumpInFlight) return;\r\n      dumpInFlight = true;\r\n      try {\r\n        const memoryFile = path.join(__dirname, \"eden-serviceRegistry-memory.json\");\r\n\r\n        // Get providers from both old and new registries\r\n        const serviceRegistry2 = getServiceRegistry2();\r\n        const allProvidersFromServiceRegistry2 = serviceRegistry2.getAllProviders();\r\n\r\n        // Merge: Use ServiceRegistry2 as source of truth, but also include any from ROOT_CA_SERVICE_REGISTRY that aren't in ServiceRegistry2\r\n        const providerMap = new Map<string, any>();\r\n\r\n        // First, add all from ServiceRegistry2 (new implementation - source of truth)\r\n        for (const provider of allProvidersFromServiceRegistry2) {\r\n          providerMap.set(provider.id, {\r\n            id: provider.id,\r\n            name: provider.name,\r\n            serviceType: provider.serviceType,\r\n            location: provider.location,\r\n            bond: provider.bond,\r\n            reputation: provider.reputation,\r\n            status: provider.status,\r\n            uuid: provider.uuid,\r\n            apiEndpoint: provider.apiEndpoint,\r\n            gardenId: provider.gardenId,\r\n          });\r\n        }\r\n\r\n        // Then, add any from ROOT_CA_SERVICE_REGISTRY that aren't in ServiceRegistry2 (backward compatibility)\r\n        for (const provider of ROOT_CA_SERVICE_REGISTRY) {\r\n          if (!providerMap.has(provider.id)) {\r\n            providerMap.set(provider.id, {\r\n              id: provider.id,\r\n              name: provider.name,\r\n              serviceType: provider.serviceType,\r\n              location: provider.location,\r\n              bond: provider.bond,\r\n              reputation: provider.reputation,\r\n              status: provider.status,\r\n              uuid: provider.uuid,\r\n              apiEndpoint: provider.apiEndpoint,\r\n              gardenId: provider.gardenId,\r\n            });\r\n          }\r\n        }\r\n\r\n        const all = Array.from(providerMap.values());\r\n        const memoryData = {\r\n          serviceRegistry: all,\r\n          totalProviders: providerMap.size,\r\n          movieProviders: all.filter((p: any) => p.serviceType === \"movie\").length,\r\n          dexProviders: all.filter((p: any) => p.serviceType === \"dex\").length,\r\n          airlineProviders: all.filter((p: any) => p.serviceType === \"airline\").length,\r\n          lastSaved: new Date().toISOString(),\r\n        };\r\n\r\n        await fs.promises.writeFile(memoryFile, JSON.stringify(memoryData, null, 2), \"utf-8\");\r\n      } catch {\r\n        // Silently fail - this is just for debugging\r\n      } finally {\r\n        dumpInFlight = false;\r\n      }\r\n    }, EDEN_DEBUG_SERVICE_REGISTRY_DUMP_INTERVAL_MS);\r\n    console.log(\r\n      `   \uD83D\uDD0D [DEBUG] Service registry memory dump ENABLED: eden-serviceRegistry-memory.json every ${EDEN_DEBUG_SERVICE_REGISTRY_DUMP_INTERVAL_MS}ms`\r\n    );\r\n  } else {\r\n    console.log(\"   \uD83D\uDD0D [DEBUG] Service registry memory dump DISABLED (set EDEN_DEBUG_SERVICE_REGISTRY_DUMP=true to enable)\");\r\n  }\r\n  \r\n  // Initialize DEX Pools (must be after token indexers are created and certified)\r\n  // Initialize pools for all existing token gardens (both ROOT and non-ROOT mode)\r\n  console.log(`\\n\uD83C\uDF0A Checking DEX Pool initialization...`);\r\n  console.log(`   TOKEN_GARDENS.length: ${TOKEN_GARDENS.length}`);\r\n  console.log(`   TOKEN_GARDENS:`, TOKEN_GARDENS.map(tg => ({ id: tg.id, name: tg.name })));\r\n  console.log(`   DEX_POOLS.size before init: ${DEX_POOLS.size}`);\r\n  \r\n  if (TOKEN_GARDENS.length > 0) {\r\n    console.log(\"\\n\uD83C\uDF0A Initializing DEX Pools...\");\r\n    initializeDEXPools();\r\n    console.log(`   DEX_POOLS.size after init: ${DEX_POOLS.size}`);\r\n    console.log(`   DEX_POOLS entries:`, Array.from(DEX_POOLS.entries()).map(([id, pool]) => ({\r\n      poolId: id,\r\n      tokenSymbol: pool.tokenSymbol,\r\n      gardenId: pool.gardenId\r\n    })));\r\n    \r\n    // Create DEX pool service providers dynamically from pools (only if they don't already exist)\r\n    console.log(\"\\n\uD83D\uDCCB Registering DEX Pool Service Providers...\");\r\n    for (const [poolId, pool] of DEX_POOLS.entries()) {\r\n      const tokenGarden = TOKEN_GARDENS.find(ti => ti.id === pool.gardenId);\r\n      if (tokenGarden) {\r\n        const providerId = `dex-pool-${pool.tokenSymbol.toLowerCase()}`;\r\n        const existingProvider = ROOT_CA_SERVICE_REGISTRY.find(p => p.id === providerId && p.gardenId === pool.gardenId);\r\n        \r\n        if (!existingProvider) {\r\n          const provider: ServiceProviderWithCert = {\r\n            id: providerId,\r\n            uuid: crypto.randomUUID(),\r\n            name: `${pool.tokenSymbol} Pool (${tokenGarden.name})`,\r\n            serviceType: \"dex\",\r\n            location: \"Eden DEX\",\r\n            bond: pool.bond,\r\n            reputation: 5.0,\r\n            gardenId: pool.gardenId, // Assign to this garden\r\n            apiEndpoint: `https://dex.eden.com/pools/${poolId}`,\r\n            status: 'active',\r\n          };\r\n          registerServiceProviderWithROOTCA(provider);\r\n          console.log(`   \u2705 Registered DEX pool provider: ${provider.name} (${provider.id}) \u2192 ${tokenGarden.name}`);\r\n        } else {\r\n          console.log(`   \u2713 DEX pool provider ${providerId} already exists for garden ${pool.gardenId}`);\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Issue certificates to all regular indexers\r\n    console.log(\"\\n\uD83D\uDCDC Issuing certificates to Regular Indexers...\");\r\n    for (const indexer of GARDENS) {\r\n      if (indexer.active) {\r\n        try {\r\n          issueGardenCertificate(indexer);\r\n        } catch (err: any) {\r\n          console.error(`\u274C Failed to issue certificate to ${indexer.name}:`, err.message);\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Issue certificates to all service providers (including dynamically created DEX pool providers)\r\n  console.log(\"\\n\uD83D\uDCDC Issuing certificates to Service Providers...\");\r\n  for (const provider of ROOT_CA_SERVICE_REGISTRY) {\r\n    try {\r\n      issueServiceProviderCertificate(provider);\r\n    } catch (err: any) {\r\n      console.error(`\u274C Failed to issue certificate to ${provider.name}:`, err.message);\r\n    }\r\n  }\r\n  \r\n  console.log(`\\n\u2705 Certificate issuance complete. Total certificates: ${CERTIFICATE_REGISTRY.size}`);\r\n  console.log(`   - Regular Indexers: ${GARDENS.length}`);\r\n  console.log(`   - Token Indexers: ${TOKEN_GARDENS.length}`);\r\n  console.log(`   - Service Providers: ${ROOT_CA_SERVICE_REGISTRY.length}\\n`);\r\n\r\n  // ============================================\r\n  // SERVICE PROVIDER NOTIFICATION SETUP\r\n  // ============================================\r\n  // Register webhooks for service providers (Optional Push mechanism)\r\n  if (EDEN_ENABLE_MOCK_PROVIDER_WEBHOOKS) {\r\n    console.log(\"\\n\uD83D\uDCE1 Registering Service Provider Webhooks (MOCK, Optional Push)... (EDEN_ENABLE_MOCK_PROVIDER_WEBHOOKS=true)\");\r\n    for (const provider of ROOT_CA_SERVICE_REGISTRY) {\r\n      // Demo only: register localhost webhook URLs that point to our mock endpoint\r\n      const mockWebhookUrl = `http://localhost:${HTTP_PORT}/mock/webhook/${provider.id}`;\r\n      PROVIDER_WEBHOOKS.set(provider.id, {\r\n        providerId: provider.id,\r\n        webhookUrl: mockWebhookUrl,\r\n        registeredAt: Date.now(),\r\n        failureCount: 0,\r\n      });\r\n      console.log(`   \u2705 Registered webhook for ${provider.name} (${provider.id}): ${mockWebhookUrl}`);\r\n      \r\n      broadcastEvent({\r\n        type: \"provider_webhook_registered\",\r\n        component: \"service_provider\",\r\n        message: `Webhook Registered: ${provider.name} (${provider.id})`,\r\n        timestamp: Date.now(),\r\n        data: {\r\n          providerId: provider.id,\r\n          providerName: provider.name,\r\n          webhookUrl: mockWebhookUrl,\r\n          startup: true\r\n        }\r\n      });\r\n    }\r\n    console.log(`\\n\u2705 Webhook registration complete. ${PROVIDER_WEBHOOKS.size} webhook(s) registered\\n`);\r\n  } else {\r\n    console.log(\"\\n\uD83D\uDCE1 Provider Webhooks: NOT auto-registered (deployable provider plugins should register explicitly).\");\r\n    console.log(\"   Set EDEN_ENABLE_MOCK_PROVIDER_WEBHOOKS=true to enable demo auto-registration to /mock/webhook/*\\n\");\r\n  }\r\n\r\n  // Display Service Provider Notification Architecture\r\n  console.log(\"=\".repeat(70));\r\n  console.log(\"\uD83D\uDCCB SERVICE PROVIDER NOTIFICATION ARCHITECTURE\");\r\n  console.log(\"=\".repeat(70));\r\n  console.log(\"\\nEden provides THREE notification mechanisms for service providers:\\n\");\r\n  console.log(\"1\uFE0F\u20E3  INDEXER RPC (Canonical Source of Truth)\");\r\n  console.log(\"    - GET /rpc/getTransactionByPayer?payer=<google_email>\");\r\n  console.log(\"    - GET /rpc/getTransactionBySnapshot?snapshot_id=<tx_id>\");\r\n  console.log(\"    - GET /rpc/getLatestSnapshot?provider_id=<provider_id>\");\r\n  console.log(\"    - GET /rpc/tx/status?payer=<email> OR ?snapshot_id=<tx_id>\");\r\n  console.log(\"    \u2192 Providers query indexer RPC for transaction status\");\r\n  console.log(\"    \u2192 Bot-friendly, cacheable, stateless\");\r\n  console.log(\"    \u2192 Same model as Ethereum/Solana RPC\\n\");\r\n  \r\n  console.log(\"2\uFE0F\u20E3  OPTIONAL PUSH (Webhook - Best Effort)\");\r\n  console.log(\"    - POST /rpc/webhook/register\");\r\n  console.log(\"    - POST /rpc/webhook/unregister\");\r\n  console.log(\"    - GET /rpc/webhook/list\");\r\n  console.log(\"    \u2192 Providers register webhook URLs\");\r\n  console.log(\"    \u2192 Indexer pushes snapshot on transaction finalization\");\r\n  console.log(\"    \u2192 Best effort delivery, no guarantees\");\r\n  console.log(\"    \u2192 Retry logic handled by indexer\\n\");\r\n  \r\n  console.log(\"3\uFE0F\u20E3  PULL/POLL (Safety Net)\");\r\n  console.log(\"    - GET /rpc/tx/status?payer=<email>\");\r\n  console.log(\"    - Providers poll until timeout\");\r\n  console.log(\"    \u2192 Fallback if webhook fails\");\r\n  console.log(\"    \u2192 Provider controls reliability\");\r\n  console.log(\"    \u2192 No inbound firewall rules required\\n\");\r\n  \r\n  console.log(\"=\".repeat(70));\r\n    console.log(`\uD83D\uDCA1 Example: Query transactions for bill.draper.auto@gmail.com`);\r\n    console.log(`   curl \"http://localhost:${HTTP_PORT}/rpc/getTransactionByPayer?payer=bill.draper.auto@gmail.com\"`);\r\n  console.log(`\\n\uD83D\uDCA1 Example: Register webhook for AMC`);\r\n  console.log(`   curl -X POST http://localhost:${HTTP_PORT}/rpc/webhook/register \\\\`);\r\n  console.log(`     -H \"Content-Type: application/json\" \\\\`);\r\n  console.log(`     -d '{\"providerId\":\"amc-001\",\"webhookUrl\":\"http://localhost:${HTTP_PORT}/mock/webhook/amc-001\"}'`);\r\n  console.log(`\\n\uD83D\uDCA1 Example: Poll transaction status`);\r\n    console.log(`   curl \"http://localhost:${HTTP_PORT}/rpc/tx/status?payer=bill.draper.auto@gmail.com\"`);\r\n  console.log(\"=\".repeat(70) + \"\\n\");\r\n\r\n  // Connect to Redis\r\n  const redisConnected = await connectRedis();\r\n  \r\n  // Embedded Redis always connects successfully unless skipped\r\n  if (!redisConnected && !SKIP_REDIS) {\r\n    console.error(\"\u274C Unexpected Redis connection failure\\n\");\r\n    process.exit(1);\r\n  }\r\n\r\n  // In ROOT mode, save service registry and wallets to persistence file after Redis connection\r\n  // NOTE: Only save if the file doesn't exist or is empty - don't overwrite existing provider assignments\r\n  if (DEPLOYED_AS_ROOT && redisConnected && !SKIP_REDIS) {\r\n    const serviceRegistryFile = path.join(__dirname, 'eden-serviceRegistry-persistence.json');\r\n    const shouldSave = !fs.existsSync(serviceRegistryFile) || \r\n                       (fs.existsSync(serviceRegistryFile) && fs.statSync(serviceRegistryFile).size < 100);\r\n    \r\n    if (shouldSave) {\r\n      console.log(`\uD83D\uDCBE [ROOT Mode] Service registry file is empty or missing, saving initial state...`);\r\n      try {\r\n        redis.saveServiceRegistry();\r\n        console.log(`   \u2705 Service registry saved to persistence file`);\r\n      } catch (err: any) {\r\n        console.warn(`   \u26A0\uFE0F  Failed to save service registry: ${err.message}`);\r\n      }\r\n    } else {\r\n      console.log(`\uD83D\uDCBE [ROOT Mode] Service registry file exists, skipping save (preserving existing provider assignments)`);\r\n    }\r\n  }\r\n  \r\n  // Load ledger entries from separate persistence file (new system)\r\n  if (redisConnected && !SKIP_REDIS) {\r\n    const ledgerEntriesFile = path.join(__dirname, 'eden-ledgerEntries-persistence.json');\r\n    if (fs.existsSync(ledgerEntriesFile)) {\r\n      try {\r\n        const fileContent = fs.readFileSync(ledgerEntriesFile, 'utf-8');\r\n        const persisted = JSON.parse(fileContent);\r\n\r\n        if (persisted.ledgerEntries && Array.isArray(persisted.ledgerEntries)) {\r\n          // Restore ledger entries from separate file\r\n          LEDGER.push(...persisted.ledgerEntries);\r\n          console.log(`\uD83D\uDCC2 [Ledger Persistence] Loaded ${persisted.ledgerEntries.length} ledger entries from ${ledgerEntriesFile}`);\r\n        }\r\n      } catch (err: any) {\r\n        console.error(`\u274C [Ledger Persistence] Failed to load ledger entries: ${err.message}`);\r\n      }\r\n    } else {\r\n      // Fallback: Load from old combined persistence file for backward compatibility\r\n      const persistenceFile = path.join(__dirname, 'eden-wallet-persistence.json');\r\n      if (fs.existsSync(persistenceFile)) {\r\n        try {\r\n          const fileContent = fs.readFileSync(persistenceFile, 'utf-8');\r\n          const persisted = JSON.parse(fileContent);\r\n\r\n          if (persisted.ledgerEntries && Array.isArray(persisted.ledgerEntries)) {\r\n            // Restore ledger entries from old combined file\r\n            LEDGER.push(...persisted.ledgerEntries);\r\n            console.log(`\uD83D\uDCC2 [Ledger Persistence] Loaded ${persisted.ledgerEntries.length} ledger entries from old combined file ${persistenceFile}`);\r\n          }\r\n        } catch (err: any) {\r\n          console.error(`\u274C [Ledger Persistence] Failed to load ledger entries from old file: ${err.message}`);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Load total iGas from persistence file\r\n  if (redisConnected && !SKIP_REDIS) {\r\n    try {\r\n      const igasPersistenceFile = path.join(__dirname, 'eden-igas-persistence.json');\r\n      if (fs.existsSync(igasPersistenceFile)) {\r\n        const fileContent = fs.readFileSync(igasPersistenceFile, 'utf-8');\r\n        const persisted = JSON.parse(fileContent);\r\n        if (persisted.totalIGas !== undefined && typeof persisted.totalIGas === 'number') {\r\n          setTOTAL_IGAS(persisted.totalIGas);\r\n          console.log(`\u26FD [iGas Persistence] Loaded total iGas: ${getTOTAL_IGAS().toFixed(6)}`);\r\n        }\r\n      }\r\n    } catch (err: any) {\r\n      console.warn(`\u26A0\uFE0F  [iGas Persistence] Failed to load total iGas: ${err.message}`);\r\n    }\r\n  }\r\n\r\n  // Load persisted indexers from persistence file\r\n  if (redisConnected && !SKIP_REDIS) {\r\n    try {\r\n      const persistenceFile = path.join(__dirname, 'eden-wallet-persistence.json');\r\n      if (fs.existsSync(persistenceFile)) {\r\n        const fileContent = fs.readFileSync(persistenceFile, 'utf-8');\r\n        const persisted = JSON.parse(fileContent);\r\n\r\n        // CRITICAL: In ROOT mode, persistence file is the SINGLE SOURCE OF TRUTH\r\n        // We should ONLY restore what's in the persistence file, nothing else\r\n        // Collect all indexers to restore FIRST, then reset memory arrays and populate\r\n\r\n        // Temporary arrays to collect indexers to restore\r\n        const indexersToRestore: GardenConfig[] = [];\r\n        const tokenIndexersToRestore: TokenGardenConfig[] = [];\r\n\r\n        // Backward compatibility: check both 'gardens' and 'indexers' fields\r\n        const gardensFromFile = persisted.gardens || persisted.indexers;\r\n        if (gardensFromFile && Array.isArray(gardensFromFile)) {\r\n          // First pass: Collect all indexers to restore FROM PERSISTENCE FILE ONLY\r\n          // In ROOT mode: persistence file is the SINGLE SOURCE OF TRUTH\r\n          let restoredCount = 0;\r\n          let skippedCount = 0;\r\n\r\n          for (const persistedIndexer of gardensFromFile) {\r\n            // Skip token indexers (they're restored separately)\r\n            if (persistedIndexer.tokenServiceType === 'dex' || (persistedIndexer.serviceType === 'dex' && persistedIndexer.id && persistedIndexer.id.startsWith('T'))) {\r\n              skippedCount++;\r\n              console.log(`\uD83D\uDCC2 [Indexer Persistence] Skipping token indexer ${persistedIndexer.id} (will be restored as token indexer)`);\r\n              continue;\r\n            }\r\n\r\n            // CRITICAL: In ROOT mode, ONLY restore what's in persistence file\r\n            // Persistence file is the SINGLE SOURCE OF TRUTH\r\n            if (DEPLOYED_AS_ROOT) {\r\n              const isRegularIndexer = persistedIndexer.id && (persistedIndexer.id.startsWith('garden-') || persistedIndexer.id.startsWith('indexer-'));\r\n\r\n              if (isRegularIndexer) {\r\n                indexersToRestore.push(persistedIndexer as GardenConfig);\r\n                restoredCount++;\r\n                console.log(`\uD83D\uDCC2 [Indexer Persistence] Will restore regular indexer: ${persistedIndexer.name} (${persistedIndexer.id})`);\r\n              }\r\n            } else {\r\n              // Non-ROOT mode: restore all regular indexers (not defaults)\r\n              const defaultIds = Array.from({ length: NUM_GARDENS }, (_, i) => String.fromCharCode(65 + i));\r\n              if (persistedIndexer.id && !defaultIds.includes(persistedIndexer.id)) {\r\n                indexersToRestore.push(persistedIndexer as GardenConfig);\r\n                restoredCount++;\r\n                console.log(`\uD83D\uDCC2 [Indexer Persistence] Will restore regular indexer: ${persistedIndexer.name} (${persistedIndexer.id})`);\r\n              }\r\n            }\r\n          }\r\n\r\n          // Restore token indexers separately\r\n          for (const persistedIndexer of gardensFromFile) {\r\n            const isTokenIndexer = persistedIndexer.tokenServiceType === 'dex' || (persistedIndexer.serviceType === 'dex' && persistedIndexer.id && persistedIndexer.id.startsWith('T'));\r\n\r\n            if (isTokenIndexer) {\r\n              if (DEPLOYED_AS_ROOT) {\r\n                // ROOT mode: restore all token indexers\r\n                tokenIndexersToRestore.push(persistedIndexer as TokenGardenConfig);\r\n                restoredCount++;\r\n                console.log(`\uD83D\uDCC2 [Indexer Persistence] Will restore token indexer: ${persistedIndexer.name} (${persistedIndexer.id})`);\r\n              } else {\r\n                // Non-ROOT mode: exclude defaults\r\n                const defaultTokenIds = Array.from({ length: NUM_TOKEN_GARDENS }, (_, i) => `T${i + 1}`);\r\n                if (persistedIndexer.id && !defaultTokenIds.includes(persistedIndexer.id)) {\r\n                  tokenIndexersToRestore.push(persistedIndexer as TokenGardenConfig);\r\n                  restoredCount++;\r\n                  console.log(`\uD83D\uDCC2 [Indexer Persistence] Will restore token indexer: ${persistedIndexer.name} (${persistedIndexer.id})`);\r\n                }\r\n              }\r\n            }\r\n          }\r\n\r\n          console.log(`\uD83D\uDCC2 [Indexer Persistence] Collected ${indexersToRestore.length} regular indexer(s) and ${tokenIndexersToRestore.length} token indexer(s) to restore`);\r\n\r\n          // Clear existing arrays (except defaults in non-ROOT mode)\r\n          if (DEPLOYED_AS_ROOT) {\r\n            // ROOT mode: clear all (no defaults)\r\n            GARDENS.length = 0;\r\n            TOKEN_GARDENS.length = 0;\r\n          } else {\r\n            // Non-ROOT mode: keep defaults, remove others\r\n            const defaultIds = Array.from({ length: NUM_GARDENS }, (_, i) => String.fromCharCode(65 + i));\r\n            const defaultTokenIds = Array.from({ length: NUM_TOKEN_GARDENS }, (_, i) => `T${i + 1}`);\r\n            const filteredGardens = GARDENS.filter(idx => defaultIds.includes(idx.id));\r\n            const filteredTokenGardens = TOKEN_GARDENS.filter(idx => defaultTokenIds.includes(idx.id));\r\n            GARDENS.length = 0;\r\n            TOKEN_GARDENS.length = 0;\r\n            GARDENS.push(...filteredGardens);\r\n            TOKEN_GARDENS.push(...filteredTokenGardens);\r\n          }\r\n\r\n          // CRITICAL: Deduplicate BEFORE adding to arrays to prevent duplicates in memory\r\n          // This is the ROOT CAUSE fix - prevent duplicates at the source, not after creation\r\n          const deduplicatedRegular = new Map<string, GardenConfig>();\r\n          for (const idx of indexersToRestore) {\r\n            if (!deduplicatedRegular.has(idx.id)) {\r\n              deduplicatedRegular.set(idx.id, idx);\r\n            } else {\r\n              console.warn(`\u26A0\uFE0F  [Indexer Persistence] Skipping duplicate regular indexer ${idx.id} when restoring from file`);\r\n            }\r\n          }\r\n\r\n          const deduplicatedToken = new Map<string, TokenGardenConfig>();\r\n          for (const idx of tokenIndexersToRestore) {\r\n            if (!deduplicatedToken.has(idx.id)) {\r\n              deduplicatedToken.set(idx.id, idx as TokenGardenConfig);\r\n            } else {\r\n              console.warn(`\u26A0\uFE0F  [Indexer Persistence] Skipping duplicate token indexer ${idx.id} when restoring from file`);\r\n            }\r\n          }\r\n\r\n          // Only add deduplicated indexers to arrays\r\n          const cleanRegularIndexers = Array.from(deduplicatedRegular.values());\r\n          const cleanTokenIndexers = Array.from(deduplicatedToken.values());\r\n\r\n          GARDENS.push(...cleanRegularIndexers);\r\n          TOKEN_GARDENS.push(...cleanTokenIndexers);\r\n\r\n          const regularDupsRemoved = indexersToRestore.length - cleanRegularIndexers.length;\r\n          const tokenDupsRemoved = tokenIndexersToRestore.length - cleanTokenIndexers.length;\r\n\r\n          if (regularDupsRemoved > 0 || tokenDupsRemoved > 0) {\r\n            console.warn(`\u26A0\uFE0F  [Indexer Persistence] Removed ${regularDupsRemoved} duplicate regular indexer(s) and ${tokenDupsRemoved} duplicate token indexer(s) when loading from file`);\r\n          }\r\n\r\n          console.log(`\u2705 [Indexer Persistence] Restored ${cleanRegularIndexers.length} regular indexer(s) and ${cleanTokenIndexers.length} token indexer(s) from persistence file`);\r\n        }\r\n      }\r\n    } catch (err: any) {\r\n      console.error(`\u274C [Indexer Persistence] Failed to restore indexers: ${err.message}`);\r\n    }\r\n    \r\n    // CRITICAL: Initialize ServiceRegistry2 AFTER gardens are loaded from persistence\r\n    // This ensures that providers with gardenId references (like AMC with garden-1) can be properly loaded\r\n    console.log(\"\\n\uD83D\uDCCB Initializing ServiceRegistry2 (AFTER gardens loaded)...\");\r\n    initializeServiceRegistry2();\r\n    const serviceRegistry2 = getServiceRegistry2();\r\n    console.log(`   \u2705 ServiceRegistry2 initialized with ${serviceRegistry2.getCount()} provider(s) from persistence`);\r\n    \r\n    // CRITICAL: Add infrastructure providers to ServiceRegistry2 if they don't exist\r\n    // These are the default infrastructure providers that should always be present\r\n    const infrastructureProviders: ServiceProviderWithCert[] = [\r\n      {\r\n        id: \"stripe-payment-rail-001\",\r\n        uuid: \"550e8400-e29b-41d4-a716-446655440100\",\r\n        name: \"Stripe Payment Rail\",\r\n        serviceType: \"payment-rail\",\r\n        location: \"Global\",\r\n        bond: 50000,\r\n        reputation: 5.0,\r\n        gardenId: \"HG\",\r\n        apiEndpoint: \"https://api.stripe.com/v1\",\r\n        status: 'active'\r\n      },\r\n      {\r\n        id: \"settlement-service-001\",\r\n        uuid: \"550e8400-e29b-41d4-a716-446655440101\",\r\n        name: \"Settlement Service\",\r\n        serviceType: \"settlement\",\r\n        location: \"ROOT CA\",\r\n        bond: 100000,\r\n        reputation: 5.0,\r\n        gardenId: \"HG\",\r\n        apiEndpoint: \"internal://settlement\",\r\n        status: 'active'\r\n      },\r\n      {\r\n        id: \"service-registry-001\",\r\n        uuid: \"550e8400-e29b-41d4-a716-446655440102\",\r\n        name: \"Service Registry\",\r\n        serviceType: \"registry\",\r\n        location: \"ROOT CA\",\r\n        bond: 50000,\r\n        reputation: 5.0,\r\n        gardenId: \"HG\",\r\n        apiEndpoint: \"internal://service-registry\",\r\n        status: 'active'\r\n      },\r\n      {\r\n        id: \"webserver-service-001\",\r\n        uuid: \"550e8400-e29b-41d4-a716-446655440103\",\r\n        name: \"Web Server\",\r\n        serviceType: \"webserver\",\r\n        location: \"ROOT CA\",\r\n        bond: 10000,\r\n        reputation: 5.0,\r\n        gardenId: \"HG\",\r\n        apiEndpoint: `http://localhost:${HTTP_PORT}`,\r\n        status: 'active'\r\n      },\r\n      {\r\n        id: \"websocket-service-001\",\r\n        uuid: \"550e8400-e29b-41d4-a716-446655440104\",\r\n        name: \"WebSocket Service\",\r\n        serviceType: \"websocket\",\r\n        location: \"ROOT CA\",\r\n        bond: 10000,\r\n        reputation: 5.0,\r\n        gardenId: \"HG\",\r\n        apiEndpoint: `ws://localhost:${HTTP_PORT}`,\r\n        status: 'active'\r\n      },\r\n      {\r\n        id: \"wallet-service-001\",\r\n        uuid: \"550e8400-e29b-41d4-a716-446655440105\",\r\n        name: \"JesusCoin Wallet Service\",\r\n        serviceType: \"wallet\",\r\n        location: \"ROOT CA\",\r\n        bond: 200000,\r\n        reputation: 5.0,\r\n        gardenId: \"HG\",\r\n        apiEndpoint: \"internal://wallet\",\r\n        status: 'active'\r\n      },\r\n      {\r\n        id: \"accountant-service-001\",\r\n        uuid: \"550e8400-e29b-41d4-a716-446655440106\",\r\n        name: \"Accountant Service\",\r\n        serviceType: \"accountant\",\r\n        location: \"ROOT CA\",\r\n        bond: 75000,\r\n        reputation: 5.0,\r\n        gardenId: \"HG\",\r\n        apiEndpoint: \"internal://accountant\",\r\n        status: 'active'\r\n      }\r\n    ];\r\n    \r\n    let infrastructureAdded = 0;\r\n    for (const provider of infrastructureProviders) {\r\n      if (!serviceRegistry2.hasProvider(provider.id)) {\r\n        try {\r\n          serviceRegistry2.addProvider(provider);\r\n          infrastructureAdded++;\r\n          console.log(`   \u2705 Added infrastructure provider: ${provider.name} (${provider.id})`);\r\n        } catch (err: any) {\r\n          console.warn(`   \u26A0\uFE0F  Failed to add infrastructure provider ${provider.id}: ${err.message}`);\r\n        }\r\n      }\r\n    }\r\n    \r\n    if (infrastructureAdded > 0) {\r\n      console.log(`   \u2705 Added ${infrastructureAdded} infrastructure provider(s) to ServiceRegistry2`);\r\n      // Save immediately to persist infrastructure providers\r\n      serviceRegistry2.savePersistence();\r\n    }\r\n    \r\n    console.log(`   \u2705 ServiceRegistry2 ready with ${serviceRegistry2.getCount()} total provider(s)`);\r\n    \r\n    // CRITICAL: After gardens are loaded, check for gardens without providers and create default ones\r\n    // Also check eden-gardens-persistence.json (separate file used by API endpoint)\r\n    console.log(`\\n   \uD83D\uDD0D [Startup] Checking for gardens without providers...`);\r\n    \r\n    // First, check gardens loaded from eden-wallet-persistence.json\r\n    let allGardens = [...GARDENS, ...TOKEN_GARDENS];\r\n    console.log(`   \uD83D\uDD0D [Startup] Checking ${allGardens.length} garden(s) from memory: ${allGardens.map(g => `${g.id}(${(g as any).serviceType || 'no-type'})`).join(', ')}`);\r\n    \r\n    // Also check eden-gardens-persistence.json (separate file)\r\n    const gardensPersistenceFile = path.join(__dirname, 'eden-gardens-persistence.json');\r\n    let gardensFromSeparateFile: any[] = [];\r\n    if (fs.existsSync(gardensPersistenceFile)) {\r\n      try {\r\n        const fileContent = fs.readFileSync(gardensPersistenceFile, 'utf-8');\r\n        const persisted = JSON.parse(fileContent);\r\n        gardensFromSeparateFile = persisted.gardens || [];\r\n        console.log(`   \uD83D\uDD0D [Startup] Found ${gardensFromSeparateFile.length} garden(s) in eden-gardens-persistence.json: ${gardensFromSeparateFile.map((g: any) => `${g.id}(${g.serviceType || 'no-type'})`).join(', ')}`);\r\n        \r\n        // CRITICAL: Add gardens from separate file to GARDENS array if they're not already there\r\n        // This ensures validateGardenId() will recognize them\r\n        for (const gardenFromFile of gardensFromSeparateFile) {\r\n          const existsInMemory = GARDENS.some(g => g.id === gardenFromFile.id) || TOKEN_GARDENS.some(tg => tg.id === gardenFromFile.id);\r\n          if (!existsInMemory) {\r\n            // Determine if it's a token garden or regular garden\r\n            const isTokenGarden = gardenFromFile.tokenServiceType === 'dex' || (gardenFromFile.serviceType === 'dex' && gardenFromFile.id && gardenFromFile.id.startsWith('T'));\r\n            \r\n            if (isTokenGarden) {\r\n              TOKEN_GARDENS.push(gardenFromFile);\r\n              console.log(`   \uD83D\uDD0D [Startup] Added token garden ${gardenFromFile.id} from eden-gardens-persistence.json to TOKEN_GARDENS`);\r\n            } else {\r\n              GARDENS.push(gardenFromFile);\r\n              console.log(`   \uD83D\uDD0D [Startup] Added garden ${gardenFromFile.id} from eden-gardens-persistence.json to GARDENS`);\r\n            }\r\n          }\r\n        }\r\n        \r\n        // Update allGardens to include all gardens (from both sources)\r\n        allGardens = [...GARDENS, ...TOKEN_GARDENS];\r\n      } catch (err: any) {\r\n        console.warn(`   \u26A0\uFE0F  [Startup] Failed to read eden-gardens-persistence.json:`, err.message);\r\n      }\r\n    }\r\n    \r\n    console.log(`   \uD83D\uDD0D [Startup] Total gardens to check: ${allGardens.length}`);\r\n    \r\n    for (const garden of allGardens) {\r\n      const gardenServiceType = (garden as any).serviceType;\r\n      console.log(`   \uD83D\uDD0D [Startup] Checking garden ${garden.id}: serviceType=\"${gardenServiceType}\"`);\r\n      \r\n      if (gardenServiceType && \r\n          gardenServiceType !== \"movie\" && \r\n          gardenServiceType !== \"dex\" && \r\n          gardenServiceType !== \"snake\") {\r\n        // Query providers specifically for this garden (not all providers of this service type)\r\n        const allProviders = serviceRegistry2.getAllProviders();\r\n        const providersForThisGarden = allProviders.filter(p => p.gardenId === garden.id && p.serviceType === gardenServiceType);\r\n        const hasProviderForThisGarden = providersForThisGarden.length > 0;\r\n        \r\n        console.log(`   \uD83D\uDD0D [Startup] Garden ${garden.id} (${gardenServiceType}): ${providersForThisGarden.length} provider(s) found for this garden, hasProviderForThisGarden=${hasProviderForThisGarden}`);\r\n        \r\n        if (!hasProviderForThisGarden) {\r\n          console.log(`   \uD83D\uDD27 [Startup] Garden ${garden.id} (${gardenServiceType}) has no providers, creating default provider...`);\r\n          try {\r\n            const defaultProviderConfig = {\r\n              name: `${garden.name} Provider`,\r\n              location: 'Unknown',\r\n              bond: 1000,\r\n              reputation: 5.0,\r\n              apiEndpoint: `https://api.${gardenServiceType}.com/v1`\r\n            };\r\n            \r\n            const startupProviderResults = createServiceProvidersForGarden(\r\n              gardenServiceType,\r\n              garden.id,\r\n              [defaultProviderConfig],\r\n              undefined\r\n            );\r\n            \r\n            const startupProvidersCreated = startupProviderResults.filter(r => r.created || r.assigned).length;\r\n            console.log(`   \u2705 [Startup] Created default provider for ${gardenServiceType} garden ${garden.id}: ${startupProviderResults.map(r => r.providerName).join(', ')}`);\r\n            \r\n            // Save service registry to persistence\r\n            serviceRegistry2.savePersistence();\r\n            console.log(`   \uD83D\uDCBE [Startup] Service registry saved to persistence`);\r\n          } catch (startupErr: any) {\r\n            console.warn(`   \u26A0\uFE0F  [Startup] Failed to create default provider for ${garden.id}:`, startupErr.message);\r\n            console.error(`   \u274C [Startup] Error details:`, startupErr);\r\n          }\r\n        } else {\r\n          console.log(`   \u2713 [Startup] Garden ${garden.id} already has provider(s)`);\r\n        }\r\n      } else {\r\n        console.log(`   \u23ED\uFE0F  [Startup] Skipping garden ${garden.id}: serviceType=\"${gardenServiceType}\" (movie/dex/snake or missing)`);\r\n      }\r\n    }\r\n    \r\n    // CRITICAL: After gardens are loaded, ensure all hardcoded providers are present if their gardens exist\r\n    // This fixes the issue where providers are removed during initial load before gardens exist\r\n    if (redisConnected && !SKIP_REDIS) {\r\n      try {\r\n        // In ROOT mode: All providers are created dynamically via the wizard, not hardcoded\r\n        // Only reload from persistence file to get providers that were created via the wizard\r\n        let reloadedCount = 0;\r\n        const serviceRegistryFile = path.join(__dirname, 'eden-serviceRegistry-persistence.json');\r\n        if (fs.existsSync(serviceRegistryFile)) {\r\n          const fileContent = fs.readFileSync(serviceRegistryFile, 'utf-8');\r\n          const persisted = JSON.parse(fileContent);\r\n          if (persisted.serviceRegistry && Array.isArray(persisted.serviceRegistry) && persisted.serviceRegistry.length > 0) {\r\n            console.log(`\uD83D\uDD0D [Service Registry Reload] Checking ${persisted.serviceRegistry.length} providers from persistence file`);\r\n            console.log(`\uD83D\uDD0D [Service Registry Reload] Current GARDENS: ${GARDENS.map(g => g.id).join(', ')}`);\r\n            console.log(`\uD83D\uDD0D [Service Registry Reload] Current TOKEN_GARDENS: ${TOKEN_GARDENS.map(tg => tg.id).join(', ')}`);\r\n            console.log(`\uD83D\uDD0D [Service Registry Reload] Current ROOT_CA_SERVICE_REGISTRY: ${ROOT_CA_SERVICE_REGISTRY.map(p => `${p.id}(${p.serviceType})`).join(', ')}`);\r\n            \r\n            for (const persistedProvider of persisted.serviceRegistry) {\r\n              const persistedGardenId = persistedProvider.gardenId || persistedProvider.indexerId;\r\n              \r\n              console.log(`\uD83D\uDD0D [Service Registry Reload] Processing provider: ${persistedProvider.id} (${persistedProvider.name}), serviceType: ${persistedProvider.serviceType}, gardenId: ${persistedGardenId}`);\r\n              \r\n              // Now that gardens are loaded, check if garden exists\r\n              let gardenExists = persistedGardenId === 'HG' ||\r\n                                GARDENS.some(g => g.id === persistedGardenId) ||\r\n                                TOKEN_GARDENS.some(tg => tg.id === persistedGardenId);\r\n              \r\n              console.log(`\uD83D\uDD0D [Service Registry Reload] Garden ${persistedGardenId} exists: ${gardenExists}`);\r\n              \r\n              if (!gardenExists && persistedGardenId) {\r\n                // Special handling for ROOT mode: create default gardens for movie providers\r\n                if (DEPLOYED_AS_ROOT && persistedProvider.serviceType === 'movie' && persistedGardenId !== 'HG') {\r\n                  console.log(`\uD83C\uDFD7\uFE0F  [Service Registry Reload] Creating default garden \"${persistedGardenId}\" for movie provider ${persistedProvider.id}`);\r\n\r\n                  // Create a default garden for the movie provider\r\n                  const defaultGarden: GardenConfig = {\r\n                    id: persistedGardenId,\r\n                    uuid: crypto.randomUUID(),\r\n                    name: `Movie Garden (${persistedGardenId})`,\r\n                    serviceType: 'movie',\r\n                    active: true,\r\n                    location: persistedProvider.location || 'Default Location',\r\n                    bond: 1000,\r\n                    reputation: 100,\r\n                    certificate: null,\r\n                    createdAt: new Date().toISOString(),\r\n                    lastActive: new Date().toISOString()\r\n                  };\r\n\r\n                  // Add to GARDENS array\r\n                  GARDENS.push(defaultGarden);\r\n\r\n                  // Issue certificate to the new garden\r\n                  try {\r\n                    issueGardenCertificate(defaultGarden);\r\n                    console.log(`   \u2705 Certificate issued to new garden: ${defaultGarden.name}`);\r\n                  } catch (certError: any) {\r\n                    console.warn(`   \u26A0\uFE0F  Failed to issue certificate to new garden: ${certError.message}`);\r\n                  }\r\n\r\n                  console.log(`   \u2705 Created and registered garden: ${defaultGarden.name} (${defaultGarden.id})`);\r\n                  gardenExists = true; // Now the garden exists\r\n                } else {\r\n                  console.log(`\u26A0\uFE0F  [Service Registry Reload] Skipping provider ${persistedProvider.id}: gardenId \"${persistedGardenId}\" does not exist`);\r\n                  console.log(`   Available gardens: ${GARDENS.map(g => g.id).join(', ') || 'none'}`);\r\n                  console.log(`   Available token gardens: ${TOKEN_GARDENS.map(tg => tg.id).join(', ') || 'none'}`);\r\n                  continue;\r\n                }\r\n              }\r\n              \r\n              // Check if provider already exists\r\n              const existingProvider = ROOT_CA_SERVICE_REGISTRY.find(p => p.id === persistedProvider.id);\r\n              if (!existingProvider) {\r\n                // Provider doesn't exist, add it\r\n                const providerToAdd: any = {\r\n                  id: persistedProvider.id,\r\n                  uuid: persistedProvider.uuid || crypto.randomUUID(),\r\n                  name: persistedProvider.name,\r\n                  serviceType: persistedProvider.serviceType,\r\n                  location: persistedProvider.location || 'Unknown',\r\n                  bond: persistedProvider.bond || 0,\r\n                  reputation: persistedProvider.reputation || 0,\r\n                  gardenId: persistedGardenId || 'HG',\r\n                  apiEndpoint: persistedProvider.apiEndpoint,\r\n                  status: (persistedProvider.status as 'active' | 'revoked' | 'suspended') || 'active',\r\n                };\r\n                ROOT_CA_SERVICE_REGISTRY.push(providerToAdd);\r\n                reloadedCount++;\r\n                console.log(`   \u2705 Reloaded provider: ${providerToAdd.name} (${providerToAdd.id}) with gardenId: ${providerToAdd.gardenId}, serviceType: ${providerToAdd.serviceType}`);\r\n              } else {\r\n                // Update gardenId if it's different\r\n                if (existingProvider.gardenId !== persistedGardenId && persistedGardenId) {\r\n                  existingProvider.gardenId = persistedGardenId;\r\n                  console.log(`   \uD83D\uDD04 Updated provider ${existingProvider.name}: gardenId to \"${persistedGardenId}\"`);\r\n                } else {\r\n                  console.log(`   \u2713 Provider ${existingProvider.name} already exists with correct gardenId: ${existingProvider.gardenId}`);\r\n                }\r\n              }\r\n            }\r\n            console.log(`\u2705 [Service Registry] Reloaded ${reloadedCount} provider(s) from persistence file`);\r\n          }\r\n        } else {\r\n          console.log(`\u2705 [Service Registry] No persistence file to reload (providers will be created via wizard)`);\r\n        }\r\n        \r\n        // CRITICAL: After reloading providers from persistence, save the service registry to persistence file\r\n        // This ensures that any providers loaded from persistence are saved back (in case of validation fixes)\r\n        if (reloadedCount > 0) {\r\n          console.log(`\uD83D\uDCBE [Service Registry] Saving updated service registry to persistence file...`);\r\n          redis.saveServiceRegistry();\r\n        }\r\n      } catch (err: any) {\r\n        console.warn(`\u26A0\uFE0F  [Service Registry] Failed to reload service registry: ${err.message}`);\r\n      }\r\n    }\r\n  }\r\n  \r\n  // Check if frontend is built\r\n  if (!fs.existsSync(FRONTEND_PATH)) {\r\n    console.warn(`\\n\u26A0\uFE0F  WARNING: Frontend directory not found: ${FRONTEND_PATH}`);\r\n    console.warn(`   The Angular frontend has not been built yet.`);\r\n    console.warn(`   To build it, run: cd frontend && ng build`);\r\n    console.warn(`   Or use the Angular dev server: cd frontend && ng serve`);\r\n    console.warn(`   The server will still start, but frontend routes will return 404.\\n`);\r\n  } else if (!fs.existsSync(path.join(FRONTEND_PATH, \"index.html\"))) {\r\n    console.warn(`\\n\u26A0\uFE0F  WARNING: index.html not found in: ${FRONTEND_PATH}`);\r\n    console.warn(`   The Angular build may be incomplete.`);\r\n    console.warn(`   Try rebuilding: cd frontend && ng build\\n`);\r\n  } else {\r\n    console.log(`\\n\u2705 Frontend found at: ${FRONTEND_PATH}`);\r\n  }\r\n\r\n  // Start the server\r\n  const PORT = process.env.PORT || 3000;\r\n  const protocol = ENABLE_HTTPS ? \"https\" : \"http\";\r\n  const wsProtocol = ENABLE_HTTPS ? \"wss\" : \"ws\";\r\n  \r\n  httpServer.listen(PORT, () => {\r\n    console.log(`\\n\uD83D\uDE80 Eden Ecosystem Server running on ${protocol}://localhost:${PORT}`);\r\n    console.log(`\uD83D\uDCE1 WebSocket server ready for connections (${wsProtocol}://localhost:${PORT}/ws)`);\r\n    if (DEPLOYED_AS_ROOT) {\r\n      console.log(`\uD83C\uDF33 ROOT mode: ${GARDENS.length} garden(s), ${TOKEN_GARDENS.length} token garden(s)`);\r\n    } else {\r\n      console.log(`\uD83C\uDF33 Non-ROOT mode: ${GARDENS.length} garden(s), ${TOKEN_GARDENS.length} token garden(s)`);\r\n    }\r\n\r\n    // Periodic service registry save (every 5 minutes)\r\n    setInterval(() => {\r\n      try {\r\n        if (redis && ROOT_CA_SERVICE_REGISTRY.length > 0) {\r\n          console.log(`\u23F0 [Periodic Save] Auto-saving service registry (${ROOT_CA_SERVICE_REGISTRY.length} providers)...`);\r\n          redis.saveServiceRegistry();\r\n        }\r\n      } catch (error) {\r\n        console.error('\u274C [Periodic Save] Failed to save service registry:', error);\r\n      }\r\n    }, 5 * 60 * 1000); // 5 minutes\r\n\r\n    // Periodic total iGas save (every 5 minutes)\r\n    setInterval(() => {\r\n      try {\r\n        let totalIGasToSave = getTOTAL_IGAS() || 0;\r\n        try {\r\n          const { getAccountantState } = require(\"./src/accountant\");\r\n          totalIGasToSave = (getAccountantState()?.totalIGas ?? totalIGasToSave) || 0;\r\n        } catch (err: any) {\r\n          // keep fallback\r\n        }\r\n        const igasPersistenceFile = path.join(__dirname, 'eden-igas-persistence.json');\r\n        const igasData = {\r\n          totalIGas: totalIGasToSave,\r\n          lastSaved: new Date().toISOString()\r\n        };\r\n        fs.writeFileSync(igasPersistenceFile, JSON.stringify(igasData, null, 2), 'utf-8');\r\n        console.log(`\u23F0 [Periodic Save] Auto-saving total iGas: ${totalIGasToSave.toFixed(6)}`);\r\n      } catch (error) {\r\n        console.error('\u274C [Periodic Save] Failed to save total iGas:', error);\r\n      }\r\n    }, 5 * 60 * 1000); // 5 minutes\r\n\r\n    // Periodic Accountant Service save (every 5 minutes)\r\n    setInterval(() => {\r\n      try {\r\n        const { saveAccountantState } = require(\"./src/accountant\");\r\n        saveAccountantState();\r\n        console.log(`\u23F0 [Periodic Save] Auto-saving Accountant Service state`);\r\n      } catch (error) {\r\n        console.error('\u274C [Periodic Save] Failed to save Accountant Service state:', error);\r\n      }\r\n    }, 5 * 60 * 1000); // 5 minutes\r\n  });\r\n}\r\n\r\n// Shutdown handlers to save service registry on exit\r\nconst saveServiceRegistryOnShutdown = () => {\r\n  try {\r\n    console.log('\uD83D\uDCBE [Shutdown] Saving service registry to persistence file...');\r\n    if (redis) {\r\n      redis.saveServiceRegistry();\r\n      console.log('\u2705 [Shutdown] Service registry saved successfully');\r\n    } else {\r\n      console.warn('\u26A0\uFE0F  [Shutdown] Redis not available, skipping service registry save');\r\n    }\r\n  } catch (error) {\r\n    console.error('\u274C [Shutdown] Failed to save service registry:', error);\r\n  }\r\n};\r\n\r\n// Shutdown handler to save Accountant Service state\r\nconst saveAccountantOnShutdown = () => {\r\n  try {\r\n    console.log('\uD83D\uDCBE [Shutdown] Saving Accountant Service state...');\r\n    const { saveAccountantState } = require(\"./src/accountant\");\r\n    saveAccountantState();\r\n    console.log('\u2705 [Shutdown] Accountant Service state saved successfully');\r\n  } catch (error) {\r\n    console.error('\u274C [Shutdown] Failed to save Accountant Service state:', error);\r\n  }\r\n};\r\n\r\n// Register shutdown handlers\r\nprocess.on('SIGTERM', () => {\r\n  console.log('\uD83D\uDED1 [Shutdown] Received SIGTERM, saving state...');\r\n  saveServiceRegistryOnShutdown();\r\n  saveAccountantOnShutdown();\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on('SIGINT', () => {\r\n  console.log('\uD83D\uDED1 [Shutdown] Received SIGINT (Ctrl+C), saving state...');\r\n  saveServiceRegistryOnShutdown();\r\n  saveAccountantOnShutdown();\r\n  process.exit(0);\r\n});\r\n\r\n// Note: beforeExit handler removed due to Node.js event listener conflicts\r\n// SIGTERM and SIGINT handlers provide sufficient shutdown coverage\r\n\r\n// Note: uncaughtException and unhandledRejection handlers removed due to Node.js event listener conflicts\r\n// SIGTERM and SIGINT handlers provide sufficient shutdown coverage for normal operations\r\n\r\n// Start the server\r\nmain().catch((err) => {\r\n  console.error(\"\u274C Fatal error starting server:\", err);\r\n  process.exit(1);\r\n});\r\n"],
  "mappings": "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",
  "names": ["import_llm", "Stripe", "filePath", "workflow", "executionId", "stepId", "replaceTemplateVariables", "step", "updatedContext", "existingExecution", "events", "listingsSource", "serviceType", "OPENAI_API_KEY", "req", "res", "currentServiceType", "userEmail", "balance", "DEX_POOLS", "submitUserDecisionToFlowWise", "getConversationMessages", "USERS_STATE", "formatResponseWithOpenAI", "formatResponseWithDeepSeek", "createConversation", "sendMessage", "getConversations", "startWorkflowFromUserInput", "url", "serviceRegistry2", "parsedUrl", "gardensData", "getDefaultGardenIdForProvider", "autopart", "finalTokenSymbol", "finalBaseToken", "tokenSymbol", "baseReserve", "tokenReserve", "persistenceFile", "existingGardenIds", "existing", "getCertificationStatus", "resolvedPath", "err", "broadcastEvent", "infrastructureProviders"]
}
