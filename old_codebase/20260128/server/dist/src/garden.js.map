{
  "version": 3,
  "sources": ["../../src/garden.ts"],
  "sourcesContent": ["/**\r\n * Garden Module\r\n * Handles garden certificate issuance and registration\r\n */\r\n\r\nimport * as crypto from \"crypto\";\r\nimport type { GardenConfig, ServiceProviderWithCert, TransactionSnapshot, LedgerEntry } from \"./types\";\r\nimport type { EdenCertificate } from \"../EdenPKI\";\r\nimport { GARDENS, ROOT_CA, CERTIFICATE_REGISTRY, LEDGER } from \"./state\";\r\nimport { ROOT_CA_UUID, CHAIN_ID } from \"./constants\";\r\nimport { DEPLOYED_AS_ROOT } from \"./config\";\r\nimport { registerServiceProviderWithROOTCA, issueServiceProviderCertificate } from \"./serviceProvider\";\r\n\r\n// Dependencies that need to be injected\r\nlet broadcastEvent: (event: any) => void;\r\nlet redis: any; // InMemoryRedisServer instance\r\n\r\n/**\r\n * Initialize garden module with dependencies\r\n */\r\nexport function initializeGarden(broadcastFn: (event: any) => void, redisInstance: any): void {\r\n  broadcastEvent = broadcastFn;\r\n  redis = redisInstance;\r\n}\r\n\r\n/**\r\n * Issue a certificate to a garden\r\n */\r\nexport function issueGardenCertificate(garden: GardenConfig): EdenCertificate {\r\n  if (!ROOT_CA) {\r\n    throw new Error(\"ROOT CA not initialized\");\r\n  }\r\n  \r\n  const cert = ROOT_CA.issueCertificate({\r\n    subject: garden.uuid,\r\n    capabilities: [\"INDEXER\", \"ISSUE_CERT\"],\r\n    constraints: {\r\n      gardenId: garden.id, // Updated from indexerId\r\n      gardenName: garden.name, // Updated from indexerName\r\n      stream: garden.stream\r\n    },\r\n    ttlSeconds: 365 * 24 * 60 * 60 // 1 year\r\n  });\r\n  \r\n  CERTIFICATE_REGISTRY.set(garden.uuid, cert);\r\n  garden.certificate = cert;\r\n  \r\n  console.log(`\uD83D\uDCDC Certificate issued to ${garden.name}: ${garden.uuid}`);\r\n  console.log(`   Capabilities: ${cert.capabilities.join(\", \")}`);\r\n  console.log(`   Expires: ${new Date(cert.expiresAt).toISOString()}`);\r\n  \r\n  broadcastEvent({\r\n    type: \"certificate_issued\",\r\n    component: \"root-ca\",\r\n    message: `Certificate issued to ${garden.name}`,\r\n    timestamp: Date.now(),\r\n    data: {\r\n      subject: cert.subject,\r\n      issuer: cert.issuer,\r\n      capabilities: cert.capabilities,\r\n      expiresAt: cert.expiresAt\r\n    }\r\n  });\r\n  \r\n  return cert;\r\n}\r\n\r\n/**\r\n * Register a new movie garden\r\n * Note: In ROOT mode, this should NOT be called directly - gardens should be created via Angular wizard\r\n */\r\nexport async function registerNewMovieGarden(\r\n  email: string,\r\n  stripePaymentIntentId: string,\r\n  stripeCustomerId?: string | null,\r\n  stripePaymentMethodId?: string | null,\r\n  stripeSessionId?: string\r\n): Promise<GardenConfig> {\r\n  // CRITICAL: In ROOT mode, DO NOT create indexers via this function\r\n  // All indexers must be created via Angular wizard (/api/wizard/create-indexer)\r\n  // Persistence file is the single source of truth\r\n  if (DEPLOYED_AS_ROOT) {\r\n    throw new Error(`Cannot create indexer via registerNewMovieGarden in ROOT mode. All indexers must be created via Angular wizard (/api/wizard/create-indexer). Persistence file is the single source of truth.`);\r\n  }\r\n  \r\n  console.log(`\uD83C\uDFAC [Indexer Registration] Starting registration for ${email}...`);\r\n  \r\n  // Generate unique indexer ID (next available letter after existing indexers)\r\n  const existingIds = GARDENS.map(i => i.id).sort();\r\n  let nextId = 'A';\r\n  if (existingIds.length > 0) {\r\n    const lastId = existingIds[existingIds.length - 1];\r\n    const lastCharCode = lastId.charCodeAt(0);\r\n    if (lastCharCode < 90) { // Z is 90\r\n      nextId = String.fromCharCode(lastCharCode + 1);\r\n    } else {\r\n      // If we've exceeded Z, use numbers\r\n      nextId = `INDEXER-${GARDENS.length + 1}`;\r\n    }\r\n  }\r\n  \r\n  const gardenId = `garden-${nextId.toLowerCase()}`;\r\n  const gardenName = `Garden-${nextId}`;\r\n  const streamName = `eden:garden:${nextId}`;\r\n  const gardenUuid = `eden:garden:${crypto.randomUUID()}`;\r\n  \r\n  // Create new garden config\r\n  const newGarden: GardenConfig = {\r\n    id: gardenId,\r\n    name: gardenName,\r\n    stream: streamName,\r\n    active: true,\r\n    uuid: gardenUuid,\r\n    ownerEmail: email, // CRITICAL: Store Priest user email for garden ownership and lifecycle management\r\n    priestEmail: email // Alias for backward compatibility\r\n  };\r\n  \r\n  console.log(`\uD83D\uDC64 [Garden Registration] Garden ownership assigned to Priest user: ${email}`);\r\n  \r\n  // Add to GARDENS array\r\n  GARDENS.push(newGarden);\r\n  console.log(`\u2705 [Garden Registration] Created garden: ${newGarden.name} (${newGarden.id})`);\r\n  console.warn(`\u26A0\uFE0F  [Garden Registration] WARNING: Movie garden created via registerNewMovieGarden - this should NOT happen in ROOT mode!`);\r\n  \r\n  // Issue certificate to the new garden\r\n  // Note: Persistence is handled by the HTTP handler after certificate issuance\r\n  try {\r\n    issueGardenCertificate(newGarden);\r\n  } catch (err: any) {\r\n    console.error(`\u274C [Garden Registration] Failed to issue certificate:`, err.message);\r\n    throw err;\r\n  }\r\n  \r\n  // Create default movie service providers for this garden\r\n  const providerNames = ['Regal Cinemas', 'Cineplex', 'MovieMax'];\r\n  const providerIds = ['regal-001', 'cineplex-001', 'moviemax-001'];\r\n  const locations = ['Baltimore, Maryland', 'New York, New York', 'Los Angeles, California'];\r\n  const reputations = [4.6, 4.4, 4.5];\r\n  const bonds = [1100, 900, 1000];\r\n  \r\n  for (let i = 0; i < providerNames.length; i++) {\r\n    const providerId = `${providerIds[i]}-${nextId.toLowerCase()}`;\r\n    const providerUuid = `550e8400-e29b-41d4-a716-${crypto.randomUUID().substring(0, 12)}`;\r\n    \r\n    const provider: ServiceProviderWithCert = {\r\n      id: providerId,\r\n      uuid: providerUuid,\r\n      name: providerNames[i],\r\n      serviceType: 'movie',\r\n      location: locations[i],\r\n      bond: bonds[i],\r\n      reputation: reputations[i],\r\n      gardenId: gardenId, // Assign to this garden\r\n      apiEndpoint: `https://api.${providerIds[i]}.com/v1/listings`,\r\n      status: 'active'\r\n    };\r\n    \r\n    // Register provider with ROOT CA\r\n    registerServiceProviderWithROOTCA(provider);\r\n    \r\n    // Issue certificate to provider\r\n    try {\r\n      issueServiceProviderCertificate(provider);\r\n    } catch (err: any) {\r\n      console.warn(`\u26A0\uFE0F  [Garden Registration] Failed to issue certificate to ${provider.name}:`, err.message);\r\n    }\r\n    \r\n    console.log(`\u2705 [Garden Registration] Registered provider: ${provider.name} (${provider.id})`);\r\n  }\r\n  \r\n  // Create ledger entry for indexer purchase\r\n  const snapshot: TransactionSnapshot = {\r\n    chainId: CHAIN_ID,\r\n    txId: crypto.randomUUID(),\r\n    slot: Date.now(),\r\n    blockTime: Date.now(),\r\n    payer: email,\r\n    merchant: 'ROOT CA',\r\n    amount: 110, // 110 JSC for indexer purchase\r\n    feeSplit: {},\r\n  };\r\n  \r\n  const entry: LedgerEntry = {\r\n    entryId: crypto.randomUUID(),\r\n    txId: snapshot.txId,\r\n    timestamp: snapshot.blockTime,\r\n    payer: email,\r\n    payerId: email,\r\n    merchant: 'ROOT CA',\r\n    providerUuid: ROOT_CA_UUID,\r\n    serviceType: 'garden_purchase',\r\n    amount: 110,\r\n    iGasCost: 0, // No iGas for indexer purchase\r\n    fees: {},\r\n    status: 'completed',\r\n    cashierId: 'stripe-payment-rail-001',\r\n    bookingDetails: {\r\n      indexerId: gardenId, // Legacy field (will be renamed to gardenId in future)\r\n      indexerName: gardenName,\r\n      stripePaymentIntentId: stripePaymentIntentId,\r\n      stripeCustomerId: stripeCustomerId || undefined,\r\n      stripePaymentMethodId: stripePaymentMethodId || undefined,\r\n      stripeSessionId: stripeSessionId || undefined,\r\n      asset: 'JSC'\r\n    } as any, // Type assertion for indexer-specific fields\r\n  };\r\n  \r\n  LEDGER.push(entry);\r\n  if (redis) {\r\n    redis.saveLedgerEntries(LEDGER);\r\n  }\r\n  \r\n  // Broadcast events\r\n  broadcastEvent({\r\n    type: \"garden_registered\",\r\n    component: \"root-ca\",\r\n    message: `New movie garden registered: ${gardenName}`,\r\n    timestamp: Date.now(),\r\n    data: {\r\n      indexerId: gardenId, // Legacy field (will be renamed to gardenId in future)\r\n      indexerName: gardenName,\r\n      indexerUuid: gardenUuid,\r\n      email: email,\r\n      providersRegistered: providerNames.length\r\n    }\r\n  });\r\n  \r\n  console.log(`\u2705 [Garden Registration] Registration complete: ${gardenName} with ${providerNames.length} providers`);\r\n  \r\n  return newGarden;\r\n}\r\n\r\n"],
  "mappings": "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",
  "names": []
}
