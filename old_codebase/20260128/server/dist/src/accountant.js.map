{
  "version": 3,
  "sources": ["../../src/accountant.ts"],
  "sourcesContent": ["/**\r\n * Accountant Service\r\n * Tracks fee payments, total iGas, and financial metrics for ROOT CA\r\n * Extends Cashier functionality to provide comprehensive financial tracking\r\n */\r\n\r\nimport * as fs from \"fs\";\r\nimport * as path from \"path\";\r\n\r\n// Accountant state interface\r\nexport interface AccountantState {\r\n  // Fee tracking\r\n  totalIGas: number;\r\n  totalITax: number;\r\n  totalRootCAFees: number;\r\n  totalIndexerFees: number;\r\n  totalProviderFees: number;\r\n  totalCashierFees: number;\r\n  \r\n  // Revenue breakdown by service type\r\n  revenueByServiceType: Record<string, {\r\n    count: number;\r\n    totalAmount: number;\r\n    totalIGas: number;\r\n    totalITax: number;\r\n    totalRootCAFees: number;\r\n    totalIndexerFees: number;\r\n    totalProviderFees: number;\r\n    totalCashierFees: number;\r\n  }>;\r\n  \r\n  // Timestamps\r\n  lastUpdated: number;\r\n  createdAt: number;\r\n}\r\n\r\n// Global accountant state\r\nlet ACCOUNTANT_STATE: AccountantState = {\r\n  totalIGas: 0,\r\n  totalITax: 0,\r\n  totalRootCAFees: 0,\r\n  totalIndexerFees: 0,\r\n  totalProviderFees: 0,\r\n  totalCashierFees: 0,\r\n  revenueByServiceType: {},\r\n  lastUpdated: Date.now(),\r\n  createdAt: Date.now()\r\n};\r\n\r\n// Persistence file path\r\nconst ACCOUNTANT_PERSISTENCE_FILE = path.join(__dirname, '..', 'eden-accountant-persistence.json');\r\n\r\n/**\r\n * Initialize Accountant Service\r\n */\r\nexport function initializeAccountant(): void {\r\n  loadAccountantState();\r\n  console.log(`\uD83D\uDCCA [Accountant] Initialized. Total iGas: ${ACCOUNTANT_STATE.totalIGas.toFixed(6)}`);\r\n}\r\n\r\n/**\r\n * Load accountant state from persistence file\r\n */\r\nfunction loadAccountantState(): void {\r\n  try {\r\n    if (fs.existsSync(ACCOUNTANT_PERSISTENCE_FILE)) {\r\n      const fileContent = fs.readFileSync(ACCOUNTANT_PERSISTENCE_FILE, 'utf-8');\r\n      const persisted = JSON.parse(fileContent);\r\n      \r\n      // Restore state\r\n      ACCOUNTANT_STATE = {\r\n        totalIGas: persisted.totalIGas || 0,\r\n        totalITax: persisted.totalITax || 0,\r\n        totalRootCAFees: persisted.totalRootCAFees || 0,\r\n        totalIndexerFees: persisted.totalIndexerFees || 0,\r\n        totalProviderFees: persisted.totalProviderFees || 0,\r\n        totalCashierFees: persisted.totalCashierFees || 0,\r\n        revenueByServiceType: persisted.revenueByServiceType || {},\r\n        lastUpdated: persisted.lastUpdated || Date.now(),\r\n        createdAt: persisted.createdAt || Date.now()\r\n      };\r\n      \r\n      console.log(`\uD83D\uDCCA [Accountant] Loaded state from persistence`);\r\n      console.log(`   Total iGas: ${ACCOUNTANT_STATE.totalIGas.toFixed(6)}`);\r\n      console.log(`   Total iTax: ${ACCOUNTANT_STATE.totalITax.toFixed(6)}`);\r\n      console.log(`   Total ROOT CA Fees: ${ACCOUNTANT_STATE.totalRootCAFees.toFixed(6)}`);\r\n      console.log(`   Total Indexer Fees: ${ACCOUNTANT_STATE.totalIndexerFees.toFixed(6)}`);\r\n    }\r\n  } catch (err: any) {\r\n    console.warn(`\u26A0\uFE0F  [Accountant] Failed to load state: ${err.message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Save accountant state to persistence file\r\n */\r\nexport function saveAccountantState(): void {\r\n  try {\r\n    ACCOUNTANT_STATE.lastUpdated = Date.now();\r\n    \r\n    const data = {\r\n      ...ACCOUNTANT_STATE,\r\n      lastSaved: new Date().toISOString()\r\n    };\r\n    \r\n    fs.writeFileSync(ACCOUNTANT_PERSISTENCE_FILE, JSON.stringify(data, null, 2), 'utf-8');\r\n    console.log(`\uD83D\uDCBE [Accountant] State saved to persistence`);\r\n  } catch (err: any) {\r\n    console.error(`\u274C [Accountant] Failed to save state: ${err.message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Record fee payment from a ledger entry\r\n * Called when a ledger entry is processed and fees are calculated\r\n */\r\nexport function recordFeePayment(\r\n  serviceType: string,\r\n  iGas: number,\r\n  iTax: number,\r\n  rootCAFee: number,\r\n  indexerFee: number,\r\n  providerFee: number = 0,\r\n  cashierFee: number = 0\r\n): void {\r\n  // Update totals\r\n  ACCOUNTANT_STATE.totalIGas += iGas;\r\n  ACCOUNTANT_STATE.totalITax += iTax;\r\n  ACCOUNTANT_STATE.totalRootCAFees += rootCAFee;\r\n  ACCOUNTANT_STATE.totalIndexerFees += indexerFee;\r\n  ACCOUNTANT_STATE.totalProviderFees += providerFee;\r\n  ACCOUNTANT_STATE.totalCashierFees += cashierFee;\r\n  \r\n  // Update service type breakdown\r\n  if (!ACCOUNTANT_STATE.revenueByServiceType[serviceType]) {\r\n    ACCOUNTANT_STATE.revenueByServiceType[serviceType] = {\r\n      count: 0,\r\n      totalAmount: 0,\r\n      totalIGas: 0,\r\n      totalITax: 0,\r\n      totalRootCAFees: 0,\r\n      totalIndexerFees: 0,\r\n      totalProviderFees: 0,\r\n      totalCashierFees: 0\r\n    };\r\n  }\r\n  \r\n  const serviceStats = ACCOUNTANT_STATE.revenueByServiceType[serviceType];\r\n  serviceStats.count++;\r\n  serviceStats.totalIGas += iGas;\r\n  serviceStats.totalITax += iTax;\r\n  serviceStats.totalRootCAFees += rootCAFee;\r\n  serviceStats.totalIndexerFees += indexerFee;\r\n  serviceStats.totalProviderFees += providerFee;\r\n  serviceStats.totalCashierFees += cashierFee;\r\n  \r\n  ACCOUNTANT_STATE.lastUpdated = Date.now();\r\n  \r\n  console.log(`\uD83D\uDCCA [Accountant] Recorded fees for ${serviceType}: iGas=${iGas.toFixed(6)}, iTax=${iTax.toFixed(6)}, ROOT CA=${rootCAFee.toFixed(6)}, Indexer=${indexerFee.toFixed(6)}`);\r\n}\r\n\r\n/**\r\n * Get accountant state (for API endpoints)\r\n */\r\nexport function getAccountantState(): AccountantState {\r\n  return { ...ACCOUNTANT_STATE };\r\n}\r\n\r\n/**\r\n * Get financial summary\r\n */\r\nexport function getFinancialSummary(): {\r\n  totalIGas: number;\r\n  totalITax: number;\r\n  totalRootCAFees: number;\r\n  totalIndexerFees: number;\r\n  totalProviderFees: number;\r\n  totalCashierFees: number;\r\n  totalRevenue: number;\r\n  revenueByServiceType: Record<string, any>;\r\n} {\r\n  // Total revenue is economic fees (cashier/provider/eden/indexer), not iGas itself.\r\n  const totalRevenue = ACCOUNTANT_STATE.totalRootCAFees + \r\n                       ACCOUNTANT_STATE.totalIndexerFees + \r\n                       ACCOUNTANT_STATE.totalProviderFees +\r\n                       ACCOUNTANT_STATE.totalCashierFees;\r\n  \r\n  return {\r\n    totalIGas: ACCOUNTANT_STATE.totalIGas,\r\n    totalITax: ACCOUNTANT_STATE.totalITax,\r\n    totalRootCAFees: ACCOUNTANT_STATE.totalRootCAFees,\r\n    totalIndexerFees: ACCOUNTANT_STATE.totalIndexerFees,\r\n    totalProviderFees: ACCOUNTANT_STATE.totalProviderFees,\r\n    totalCashierFees: ACCOUNTANT_STATE.totalCashierFees,\r\n    totalRevenue,\r\n    revenueByServiceType: ACCOUNTANT_STATE.revenueByServiceType\r\n  };\r\n}\r\n\r\n"],
  "mappings": "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",
  "names": []
}
