{
  "version": 3,
  "sources": ["../../src/llmServiceMapper.ts"],
  "sourcesContent": ["/**\r\n * LLM Service Registry Mapper\r\n * \r\n * ROOT CA LLM Service that maps user natural language input to services/gardens\r\n * from the service registry, eliminating the need for pre-canned prompts.\r\n * \r\n * Architecture:\r\n * - User provides natural language input (e.g., \"I want two sci-fi movies tonight at best price in white marsh\")\r\n * - LLM analyzes the input and the service registry\r\n * - LLM selects the best matching service(s) and garden(s)\r\n * - Returns structured selection that can be used to start workflows\r\n */\r\n\r\nimport { extractQueryWithOpenAI, extractQueryWithDeepSeek } from \"./llm\";\r\nimport { queryROOTCAServiceRegistry, type ServiceProvider } from \"./serviceProvider\";\r\nimport { ROOT_CA_SERVICE_REGISTRY } from \"./state\";\r\nimport { ENABLE_OPENAI, MOCKED_LLM } from \"./config\";\r\nimport type { LLMQueryResult } from \"./types\";\r\n\r\nexport interface ServiceSelection {\r\n  serviceType: string;\r\n  selectedProviders: Array<{\r\n    providerId: string;\r\n    providerName: string;\r\n    gardenId: string;\r\n    confidence: number;\r\n    reason: string;\r\n  }>;\r\n  selectedGardenId?: string; // If user wants a specific garden\r\n  filters: {\r\n    location?: string;\r\n    maxPrice?: number | string;\r\n    genre?: string;\r\n    time?: string;\r\n    quantity?: number;\r\n    [key: string]: any;\r\n  };\r\n  confidence: number;\r\n}\r\n\r\n/**\r\n * LLM Prompt for Service/Garden Selection\r\n */\r\nexport const LLM_SERVICE_SELECTION_PROMPT = `\r\nYou are Eden ROOT CA AI - GOD's service selection controller.\r\nYour role is to analyze user natural language input and select the best matching services\r\nfrom the Eden service registry.\r\n\r\nCRITICAL RULES:\r\n1. You have access to the FULL service registry (excluding ROOT CA core services)\r\n2. You must select services that best match the user's intent\r\n3. You can select multiple services if the user wants multiple options\r\n4. You must provide confidence scores and reasoning for each selection\r\n5. You must extract filters (location, price, time, genre, quantity, etc.) from user input\r\n\r\nSERVICE REGISTRY STRUCTURE:\r\nEach service provider has:\r\n- id: Provider identifier (e.g., \"amc-001\", \"cinemark-001\")\r\n- name: Provider name (e.g., \"AMC Theatres\", \"Cinemark\")\r\n- serviceType: Type of service (e.g., \"movie\", \"restaurant\", \"hotel\", \"airline\", \"dex\")\r\n- gardenId: The garden/indexer this service belongs to\r\n- location: Service location (e.g., \"Baltimore, Maryland\", \"White Marsh, Maryland\")\r\n- apiEndpoint: API endpoint for querying this service\r\n\r\nEXCLUSIONS:\r\n- DO NOT select ROOT CA core services (these are system services, not user-facing)\r\n- DO NOT select services with status \"revoked\" or \"suspended\"\r\n- Only select \"active\" services\r\n\r\nSELECTION CRITERIA:\r\n1. Match serviceType to user intent (movie, restaurant, hotel, airline, etc.)\r\n2. Match location if specified (e.g., \"white marsh\" \u2192 services in White Marsh, Maryland)\r\n3. Match price preferences (e.g., \"best price\" \u2192 select services with competitive pricing)\r\n4. Match time preferences (e.g., \"tonight\" \u2192 select services available tonight)\r\n5. Match genre/category if specified (e.g., \"sci-fi\" \u2192 filter movie listings by genre)\r\n6. Match quantity if specified (e.g., \"two movies\" \u2192 ensure service can provide 2 tickets)\r\n\r\nOUTPUT FORMAT:\r\nReturn JSON only with this structure:\r\n{\r\n  \"serviceType\": \"movie\" | \"restaurant\" | \"hotel\" | \"airline\" | \"dex\" | etc.,\r\n  \"selectedProviders\": [\r\n    {\r\n      \"providerId\": \"amc-001\",\r\n      \"providerName\": \"AMC Theatres\",\r\n      \"gardenId\": \"HG\",\r\n      \"confidence\": 0.95,\r\n      \"reason\": \"Matches location (White Marsh), service type (movie), and has competitive pricing\"\r\n    }\r\n  ],\r\n  \"selectedGardenId\": \"HG\" | null, // Optional: if user explicitly wants a specific garden\r\n  \"filters\": {\r\n    \"location\": \"White Marsh, Maryland\",\r\n    \"maxPrice\": \"best\",\r\n    \"genre\": \"sci-fi\",\r\n    \"time\": \"tonight\",\r\n    \"quantity\": 2\r\n  },\r\n  \"confidence\": 0.92\r\n}\r\n\r\nEXAMPLES:\r\n\r\nInput: \"I want two sci-fi movies tonight at best price in white marsh\"\r\nService Registry: [\r\n  { id: \"amc-001\", name: \"AMC Theatres\", serviceType: \"movie\", gardenId: \"HG\", location: \"White Marsh, Maryland\" },\r\n  { id: \"cinemark-001\", name: \"Cinemark\", serviceType: \"movie\", gardenId: \"HG\", location: \"Baltimore, Maryland\" }\r\n]\r\nOutput: {\r\n  \"serviceType\": \"movie\",\r\n  \"selectedProviders\": [\r\n    {\r\n      \"providerId\": \"amc-001\",\r\n      \"providerName\": \"AMC Theatres\",\r\n      \"gardenId\": \"HG\",\r\n      \"confidence\": 0.98,\r\n      \"reason\": \"Perfect match: location (White Marsh), service type (movie), supports multiple tickets\"\r\n    }\r\n  ],\r\n  \"filters\": {\r\n    \"location\": \"White Marsh, Maryland\",\r\n    \"maxPrice\": \"best\",\r\n    \"genre\": \"sci-fi\",\r\n    \"time\": \"tonight\",\r\n    \"quantity\": 2\r\n  },\r\n  \"confidence\": 0.98\r\n}\r\n\r\nInput: \"Find me a hotel in Paris for next week\"\r\nService Registry: [\r\n  { id: \"hotel-001\", name: \"Paris Grand Hotel\", serviceType: \"hotel\", gardenId: \"HG\", location: \"Paris, France\" }\r\n]\r\nOutput: {\r\n  \"serviceType\": \"hotel\",\r\n  \"selectedProviders\": [\r\n    {\r\n      \"providerId\": \"hotel-001\",\r\n      \"providerName\": \"Paris Grand Hotel\",\r\n      \"gardenId\": \"HG\",\r\n      \"confidence\": 0.95,\r\n      \"reason\": \"Matches location (Paris) and service type (hotel)\"\r\n    }\r\n  ],\r\n  \"filters\": {\r\n    \"location\": \"Paris, France\",\r\n    \"time\": \"next week\"\r\n  },\r\n  \"confidence\": 0.95\r\n}\r\n\r\nCRITICAL: Return ONLY valid JSON. No explanations, no markdown, just the JSON object.\r\n`;\r\n\r\n/**\r\n * Filter out ROOT CA core services from the registry\r\n * Core services are system services that should not be user-selectable\r\n */\r\nfunction filterCoreServices(providers: ServiceProvider[]): ServiceProvider[] {\r\n  // ROOT CA core services are typically infrastructure services\r\n  // These might have specific IDs or serviceTypes that indicate they're core services\r\n  const coreServiceTypes = ['root-ca', 'system', 'infrastructure'];\r\n  const coreServiceIds = ['root-ca-service', 'system-service'];\r\n  \r\n  return providers.filter(provider => {\r\n    // Exclude revoked/suspended services\r\n    if (provider.status === 'revoked' || provider.status === 'suspended') {\r\n      return false;\r\n    }\r\n    \r\n    // Exclude core service types\r\n    if (coreServiceTypes.includes(provider.serviceType?.toLowerCase() || '')) {\r\n      return false;\r\n    }\r\n    \r\n    // Exclude core service IDs\r\n    if (coreServiceIds.includes(provider.id?.toLowerCase() || '')) {\r\n      return false;\r\n    }\r\n    \r\n    return true;\r\n  });\r\n}\r\n\r\n/**\r\n * Map user input to services/gardens using LLM\r\n * This is the main entry point for the LLM service mapper\r\n */\r\nexport async function mapUserInputToServices(\r\n  userInput: string,\r\n  availableProviders?: ServiceProvider[]\r\n): Promise<ServiceSelection> {\r\n  if (MOCKED_LLM) {\r\n    // Mock response for testing\r\n    return {\r\n      serviceType: \"movie\",\r\n      selectedProviders: [\r\n        {\r\n          providerId: \"amc-001\",\r\n          providerName: \"AMC Theatres\",\r\n          gardenId: \"HG\",\r\n          confidence: 0.95,\r\n          reason: \"Mock selection for testing\"\r\n        }\r\n      ],\r\n      filters: {\r\n        location: \"White Marsh, Maryland\",\r\n        maxPrice: \"best\",\r\n        genre: \"sci-fi\",\r\n        time: \"tonight\",\r\n        quantity: 2\r\n      },\r\n      confidence: 0.95\r\n    };\r\n  }\r\n\r\n  // Get available providers (filter out core services)\r\n  let providers: ServiceProvider[] = availableProviders || Array.from(ROOT_CA_SERVICE_REGISTRY);\r\n  providers = filterCoreServices(providers);\r\n  \r\n  // CRITICAL: For DEX-related queries, only send DEX services to LLM\r\n  // Detect DEX intent from user input (keywords like \"buy\", \"sell\", \"trade\", \"token\", \"dex\", \"sol\", etc.)\r\n  const dexKeywords = ['buy', 'sell', 'trade', 'token', 'dex', 'sol', 'solana', 'swap', 'exchange', 'pool', 'liquidity'];\r\n  const userInputLower = userInput.toLowerCase();\r\n  const isDexQuery = dexKeywords.some(keyword => userInputLower.includes(keyword));\r\n  \r\n  if (isDexQuery) {\r\n    // Filter to only DEX services\r\n    providers = providers.filter(p => p.serviceType === 'dex');\r\n    console.log(`\uD83E\uDD16 [LLM Service Mapper] DEX query detected - filtering to ${providers.length} DEX service(s) only`);\r\n  }\r\n\r\n  if (providers.length === 0) {\r\n    throw new Error(\"No services available in registry (all filtered as core services or no DEX services found)\");\r\n  }\r\n\r\n  // Prepare service registry summary for LLM\r\n  const registrySummary = providers.map(p => ({\r\n    id: p.id,\r\n    name: p.name,\r\n    serviceType: p.serviceType,\r\n    gardenId: p.gardenId || 'HG',\r\n    location: p.location || 'Unknown'\r\n  }));\r\n\r\n  // Build the LLM prompt with user input and service registry\r\n  const dexContextNote = isDexQuery \r\n    ? \"\\n\\nNOTE: This is a DEX (token trading) query. Only DEX services are available in the registry above. Select DEX pool providers that match the user's trading intent (BUY/SELL, token pair, amount, etc.).\"\r\n    : \"\";\r\n  \r\n  const fullPrompt = `${LLM_SERVICE_SELECTION_PROMPT}\r\n\r\nUSER INPUT: \"${userInput}\"\r\n\r\nAVAILABLE SERVICE REGISTRY:\r\n${JSON.stringify(registrySummary, null, 2)}${dexContextNote}\r\n\r\nAnalyze the user input and select the best matching services from the registry above.\r\nReturn ONLY the JSON object as specified in the format above.`;\r\n\r\n  try {\r\n    // Use OpenAI or DeepSeek to analyze and select\r\n    const extractFn = ENABLE_OPENAI ? extractQueryWithOpenAI : extractQueryWithDeepSeek;\r\n    \r\n    // Call LLM directly with the service selection prompt\r\n    const { callLLM } = await import(\"./llm\");\r\n    \r\n    console.log(`\uD83E\uDD16 [LLM Service Mapper] Analyzing user input: \"${userInput.substring(0, 100)}${userInput.length > 100 ? '...' : ''}\"`);\r\n    console.log(`\uD83E\uDD16 [LLM Service Mapper] Available services: ${providers.length} (after filtering core services)`);\r\n    \r\n    // Use OpenAI by default (ENABLE_OPENAI is true by default)\r\n    const response = await callLLM(fullPrompt, ENABLE_OPENAI);\r\n\r\n    // Parse LLM response\r\n    let selection: ServiceSelection;\r\n    try {\r\n      // Try to extract JSON from response\r\n      const jsonMatch = response.match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) {\r\n        selection = JSON.parse(jsonMatch[0]);\r\n      } else {\r\n        selection = JSON.parse(response);\r\n      }\r\n    } catch (parseError: any) {\r\n      console.error(`\u274C [LLM Service Mapper] Failed to parse LLM response:`, response);\r\n      throw new Error(`LLM returned invalid JSON: ${parseError.message}`);\r\n    }\r\n\r\n    // Validate selection\r\n    if (!selection.serviceType || !selection.selectedProviders || selection.selectedProviders.length === 0) {\r\n      throw new Error(\"LLM selection missing required fields (serviceType or selectedProviders)\");\r\n    }\r\n\r\n    // Validate that selected providers actually exist in registry\r\n    const validProviders = selection.selectedProviders.filter(sp => {\r\n      const exists = providers.some(p => p.id === sp.providerId);\r\n      if (!exists) {\r\n        console.warn(`\u26A0\uFE0F  [LLM Service Mapper] LLM selected non-existent provider: ${sp.providerId}`);\r\n      }\r\n      return exists;\r\n    });\r\n\r\n    if (validProviders.length === 0) {\r\n      throw new Error(\"LLM selected providers that don't exist in registry\");\r\n    }\r\n\r\n    selection.selectedProviders = validProviders;\r\n\r\n    console.log(`\u2705 [LLM Service Mapper] Selected ${selection.selectedProviders.length} provider(s) for serviceType: ${selection.serviceType}`);\r\n    console.log(`   Providers: ${selection.selectedProviders.map(p => `${p.providerName} (${p.providerId})`).join(', ')}`);\r\n    console.log(`   Confidence: ${selection.confidence}`);\r\n\r\n    return selection;\r\n  } catch (error: any) {\r\n    console.error(`\u274C [LLM Service Mapper] Error mapping user input to services:`, error.message);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Get service registry summary for LLM (excluding core services)\r\n */\r\nexport function getServiceRegistrySummary(): Array<{\r\n  id: string;\r\n  name: string;\r\n  serviceType: string;\r\n  gardenId: string;\r\n  location: string;\r\n}> {\r\n  const providers = filterCoreServices(Array.from(ROOT_CA_SERVICE_REGISTRY));\r\n  return providers.map(p => ({\r\n    id: p.id,\r\n    name: p.name,\r\n    serviceType: p.serviceType,\r\n    gardenId: p.gardenId || 'HG',\r\n    location: p.location || 'Unknown'\r\n  }));\r\n}\r\n\r\n"],
  "mappings": "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",
  "names": []
}
