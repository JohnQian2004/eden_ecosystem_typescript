{
  "version": 3,
  "sources": ["../../src/llm.ts"],
  "sourcesContent": ["/**\r\n * LLM Module\r\n * Handles LLM query extraction and response formatting\r\n */\r\n\r\nimport * as https from \"https\";\r\nimport * as http from \"http\";\r\nimport { URL } from \"url\";\r\nimport type { MovieListing, TokenListing, LLMQueryResult, LLMResponse, ServiceRegistryQuery } from \"./types\";\r\nimport { MOCKED_LLM, ENABLE_OPENAI } from \"./config\";\r\nimport { getMessagingSystemPrompt } from \"./messaging/llmMessagingPrompt\";\r\nimport { getKnowledgeContext } from \"./rag/edenKnowledgeBase\";\r\n\r\n// Dependencies that need to be injected\r\nlet broadcastEvent: (event: any) => void;\r\n\r\n/**\r\n * Initialize LLM module with dependencies\r\n */\r\nexport function initializeLLM(broadcastFn: (event: any) => void): void {\r\n  broadcastEvent = broadcastFn;\r\n}\r\n\r\n// LLM System Prompts\r\nexport const LLM_QUERY_EXTRACTION_PROMPT = `\r\nYou are Eden Core AI query processor.\r\nExtract service query from user input.\r\nReturn JSON only with: query (object with serviceType and filters), serviceType, confidence.\r\n\r\n\uD83D\uDEA8 CRITICAL: Distinguish between EDEN CHAT (workflow queries) and REGULAR TEXT CHAT (informational queries):\r\n\r\n- **EDEN CHAT (Workflow/Service Queries)**: These should trigger workflows\r\n  - Examples: \"book a movie\", \"buy movie tickets\", \"trade 2 SOL with TOKEN\", \"find a pharmacy\", \"buy TOKENA\"\r\n  - These are ACTION queries that request services\r\n  - Extract serviceType and filters for these queries\r\n\r\n- **REGULAR TEXT CHAT (Informational Queries)**: These should NOT trigger workflows\r\n  - Examples: \"how to messaging\", \"how eden works\", \"what is the garden of eden\", \"who eden works\", \"how do I use this\"\r\n  - These are INFORMATION queries that should be answered directly\r\n  - For these queries, return serviceType: \"informational\" and empty filters\r\n\r\nService types: \"movie\", \"dex\", or \"informational\" (for regular text chat)\r\n\r\nCRITICAL: Classify queries based on these rules:\r\n\r\nMOVIE SERVICE (serviceType: \"movie\"):\r\n- Keywords: \"movie\", \"ticket\", \"tickets\", \"cinema\", \"theater\", \"theatre\", \"film\", \"watch\", \"showtime\", \"show\", \"AMC\", \"Cinemark\", \"MovieCom\", \"cinema\", \"theater\"\r\n- Examples: \"buy movie tickets\", \"I want to watch a movie\", \"find movies\", \"movie tickets\", \"cinema tickets\", \"2 tickets\", \"buy 2 tickets\"\r\n- If user mentions \"ticket\" or \"tickets\" WITHOUT mentioning \"token\", \"TOKENA\", \"TOKENB\", \"DEX\", \"pool\", \"trade\", it's ALWAYS a movie query\r\n- If user says \"buy 2 tickets\" or \"I want 2 tickets\", it means 2 MOVIE TICKETS, not tokens\r\n- Extract filters: location, maxPrice, genre, time, showtime\r\n\r\nDEX TOKEN SERVICE (serviceType: \"dex\"):\r\n- Keywords: \"token\", \"TOKEN\", \"TOKENA\", \"TOKENB\", \"TOKENC\", \"DEX\", \"pool\", \"trade\", \"swap\", \"exchange\", \"buy token\", \"sell token\", \"token A\", \"token B\", \"SOL\", \"SOLANA\"\r\n- Examples: \"buy TOKEN\", \"buy TOKENA\", \"buy 2 TOKENA\", \"sell token A\", \"buy token with SOL\", \"DEX trade\", \"Trade 2 SOL with TOKEN\", \"swap SOL for TOKEN\"\r\n- CRITICAL CLASSIFICATION RULES (in priority order):\r\n  1. If user mentions \"TOKEN\" (with or without a letter) AND mentions \"SOL\" or \"SOLANA\" \u2192 ALWAYS DEX\r\n  2. If user mentions \"trade\" AND mentions \"TOKEN\" or \"SOL\" \u2192 ALWAYS DEX\r\n  3. If user mentions \"DEX\" or \"pool\" \u2192 ALWAYS DEX\r\n  4. If user mentions \"token\" (lowercase) AND a token symbol (TOKEN, TOKENA, TOKENB, etc.) \u2192 ALWAYS DEX\r\n  5. If user mentions \"swap\" or \"exchange\" with \"TOKEN\" or \"SOL\" \u2192 ALWAYS DEX\r\n- Extract: tokenSymbol, baseToken, action (BUY/SELL), tokenAmount, baseAmount, maxPrice\r\n\r\nFor movie queries:\r\nExample: {\"query\": {\"serviceType\": \"movie\", \"filters\": {\"location\": \"Baltimore\", \"maxPrice\": 10}}, \"serviceType\": \"movie\", \"confidence\": 0.95}\r\nExample: {\"query\": {\"serviceType\": \"movie\", \"filters\": {\"maxPrice\": \"best\"}}, \"serviceType\": \"movie\", \"confidence\": 0.95}\r\nExample: {\"query\": {\"serviceType\": \"movie\", \"filters\": {}}, \"serviceType\": \"movie\", \"confidence\": 0.95}\r\n\r\nFor DEX token trading queries (BUY/SELL tokens):\r\n- tokenSymbol: The token being bought/sold (e.g., \"TOKENA\", \"TOKENB\", \"TOKENC\", \"Token A\", \"TOKEN\")\r\n  * If user says \"BUY token A\" or \"token A\" or \"TOKENA\", tokenSymbol = \"TOKENA\"\r\n  * If user says \"BUY token B\" or \"token B\" or \"TOKENB\", tokenSymbol = \"TOKENB\"\r\n  * If user says \"SOLANA token A\" or \"Trade X SOL with TOKENA\", tokenSymbol = \"TOKENA\" (token A is what's being traded)\r\n  * If user says \"Trade X SOL with TOKENB\", tokenSymbol = \"TOKENB\"\r\n  * If user says \"TOKEN\" without a letter (A, B, C, etc.), tokenSymbol = \"TOKEN\"\r\n  * CRITICAL: \"TOKENA\", \"TOKENB\", \"TOKENC\" are valid token symbols - extract them exactly as written\r\n- baseToken: The currency used to buy/sell (e.g., \"SOL\", \"USDC\", \"SOLANA\")\r\n  * If user says \"BUY with SOL\" or \"SOLANA token A\", baseToken = \"SOL\" (SOL is the payment currency)\r\n- Extract action: \"BUY\" or \"SELL\"\r\n- Extract tokenAmount if user specifies token quantity (e.g., \"buy 2 TOKEN\" means tokenAmount = 2)\r\n- Extract baseAmount if user specifies base token quantity (e.g., \"Trade 2 SOL with TOKEN\" means baseAmount = 2, \"Trade 2 SOL with TOKENA\" means baseAmount = 2 and tokenSymbol = \"TOKENA\")\r\n- CRITICAL: When user says \"Trade X SOL with TOKENA\" or \"Trade X SOL with TOKENB\", the number X is ALWAYS the baseAmount (amount of SOL to spend), NOT the tokenAmount\r\n- Extract maxPrice if specified (e.g., \"1 Token/SOL\" means price <= 1)\r\n\r\n\uD83D\uDEA8 CRITICAL QUANTITY EXTRACTION RULES (MUST FOLLOW):\r\n- Pattern: \"Trade [NUMBER] SOL with TOKEN\" \u2192 baseAmount = [NUMBER], tokenSymbol = \"TOKEN\", baseToken = \"SOL\", action = \"BUY\"\r\n  * Example: \"Trade 2 SOL with TOKEN\" \u2192 baseAmount = 2 (NOT tokenAmount = 2!)\r\n  * Example: \"Trade 5 SOL with TOKEN\" \u2192 baseAmount = 5\r\n  * Example: \"Trade 10 SOL with TOKEN\" \u2192 baseAmount = 10\r\n  * THE NUMBER BEFORE \"SOL\" IS ALWAYS THE baseAmount (quantity of SOL to spend)\r\n- Pattern: \"Trade [NUMBER] SOL with TOKENA\" \u2192 baseAmount = [NUMBER], tokenSymbol = \"TOKENA\", baseToken = \"SOL\", action = \"BUY\"\r\n  * Example: \"Trade 2 SOL with TOKENA\" \u2192 baseAmount = 2, tokenSymbol = \"TOKENA\"\r\n  * Example: \"Trade 3 SOL with TOKENA\" \u2192 baseAmount = 3, tokenSymbol = \"TOKENA\"\r\n- Pattern: \"Trade [NUMBER] SOL with TOKENB\" \u2192 baseAmount = [NUMBER], tokenSymbol = \"TOKENB\", baseToken = \"SOL\", action = \"BUY\"\r\n- Pattern: \"Buy TOKEN with [NUMBER] SOL\" \u2192 baseAmount = [NUMBER], tokenSymbol = \"TOKEN\", baseToken = \"SOL\", action = \"BUY\"\r\n- Pattern: \"Swap [NUMBER] SOL for TOKEN\" \u2192 baseAmount = [NUMBER], tokenSymbol = \"TOKEN\", baseToken = \"SOL\", action = \"BUY\"\r\n- Pattern: \"Buy [NUMBER] TOKEN\" \u2192 tokenAmount = [NUMBER], tokenSymbol = \"TOKEN\", action = \"BUY\" (number refers to tokens, not SOL)\r\n- Pattern: \"Buy [NUMBER] TOKENA\" \u2192 tokenAmount = [NUMBER], tokenSymbol = \"TOKENA\", action = \"BUY\" (number refers to tokens, not SOL)\r\n\r\nCRITICAL: Understanding quantity specifications:\r\n- \"Trade 2 SOL with TOKEN\" or \"Trade 2 SOL with TOKENA\" \u2192 baseAmount = 2, tokenSymbol = \"TOKEN\" or \"TOKENA\", action = \"BUY\" (user wants to spend 2 SOL to buy tokens)\r\n- \"Buy TOKEN with 2 SOL\" or \"Buy TOKENA with 2 SOL\" \u2192 baseAmount = 2, tokenSymbol = \"TOKEN\" or \"TOKENA\", action = \"BUY\"\r\n- \"Swap 2 SOL for TOKEN\" or \"Swap 2 SOL for TOKENA\" \u2192 baseAmount = 2, tokenSymbol = \"TOKEN\" or \"TOKENA\", action = \"BUY\"\r\n- \"Buy 2 TOKEN\" or \"Buy 2 TOKENA\" \u2192 tokenAmount = 2, tokenSymbol = \"TOKEN\" or \"TOKENA\", action = \"BUY\" (user wants 2 tokens)\r\n- When baseAmount is specified, the system will calculate tokenAmount from the pool price\r\n- When tokenAmount is specified, the system will calculate baseAmount from the pool price\r\n\r\nPATTERN RECOGNITION (EXTRACT THE NUMBER!):\r\n- \"Trade X SOL with TOKEN\" \u2192 baseAmount = X (extract X as a number!), tokenSymbol = \"TOKEN\", baseToken = \"SOL\", action = \"BUY\"\r\n- \"Trade X SOL with TOKENA\" \u2192 baseAmount = X (extract X as a number!), tokenSymbol = \"TOKENA\", baseToken = \"SOL\", action = \"BUY\"\r\n- \"Trade X SOL with TOKENB\" \u2192 baseAmount = X (extract X as a number!), tokenSymbol = \"TOKENB\", baseToken = \"SOL\", action = \"BUY\"\r\n- If user says \"Trade 2 SOL with TOKEN\", you MUST extract baseAmount = 2 (the number 2 is the quantity of SOL)\r\n\r\nIMPORTANT: In phrases like \"BUY 2 SOLANA token A\":\r\n- tokenSymbol = \"TOKENA\" (the token being bought)\r\n- baseToken = \"SOL\" (SOLANA/SOL is the currency used to buy)\r\n- tokenAmount = 2 (if \"2\" refers to tokens) OR baseAmount = 2 (if \"2\" refers to SOL - need context)\r\n\r\nExample: {\"query\": {\"serviceType\": \"dex\", \"filters\": {\"tokenSymbol\": \"TOKENA\", \"baseToken\": \"SOL\", \"action\": \"BUY\", \"tokenAmount\": 2, \"maxPrice\": 1}}, \"serviceType\": \"dex\", \"confidence\": 0.95}\r\nExample: {\"query\": {\"serviceType\": \"dex\", \"filters\": {\"tokenSymbol\": \"TOKEN\", \"baseToken\": \"SOL\", \"action\": \"BUY\", \"baseAmount\": 2}}, \"serviceType\": \"dex\", \"confidence\": 0.95}\r\n\r\n\uD83D\uDEA8 MANDATORY EXAMPLES - EXTRACT THE NUMBER CORRECTLY:\r\nExample for \"Trade 2 SOL with TOKEN\": {\"query\": {\"serviceType\": \"dex\", \"filters\": {\"tokenSymbol\": \"TOKEN\", \"baseToken\": \"SOL\", \"action\": \"BUY\", \"baseAmount\": 2}}, \"serviceType\": \"dex\", \"confidence\": 0.95}\r\n  * CRITICAL: The number \"2\" in \"Trade 2 SOL\" means baseAmount = 2 (user wants to spend 2 SOL)\r\n  * DO NOT set tokenAmount = 2, set baseAmount = 2!\r\nExample for \"Trade 2 SOL with TOKENA\": {\"query\": {\"serviceType\": \"dex\", \"filters\": {\"tokenSymbol\": \"TOKENA\", \"baseToken\": \"SOL\", \"action\": \"BUY\", \"baseAmount\": 2}}, \"serviceType\": \"dex\", \"confidence\": 0.95}\r\n  * CRITICAL: baseAmount = 2 (the number before \"SOL\" is always baseAmount)\r\nExample for \"Trade 2 SOL with TOKENB\": {\"query\": {\"serviceType\": \"dex\", \"filters\": {\"tokenSymbol\": \"TOKENB\", \"baseToken\": \"SOL\", \"action\": \"BUY\", \"baseAmount\": 2}}, \"serviceType\": \"dex\", \"confidence\": 0.95}\r\n  * CRITICAL: baseAmount = 2 (extract the number 2 as baseAmount)\r\nExample for \"Trade 5 SOL with TOKEN\": {\"query\": {\"serviceType\": \"dex\", \"filters\": {\"tokenSymbol\": \"TOKEN\", \"baseToken\": \"SOL\", \"action\": \"BUY\", \"baseAmount\": 5}}, \"serviceType\": \"dex\", \"confidence\": 0.95}\r\n  * CRITICAL: baseAmount = 5 (extract the number 5 as baseAmount)\r\nExample for \"buy TOKEN\": {\"query\": {\"serviceType\": \"dex\", \"filters\": {\"tokenSymbol\": \"TOKEN\", \"baseToken\": \"SOL\", \"action\": \"BUY\", \"tokenAmount\": 1}}, \"serviceType\": \"dex\", \"confidence\": 0.95}\r\nExample for \"buy 2 TOKENA\": {\"query\": {\"serviceType\": \"dex\", \"filters\": {\"tokenSymbol\": \"TOKENA\", \"baseToken\": \"SOL\", \"action\": \"BUY\", \"tokenAmount\": 2}}, \"serviceType\": \"dex\", \"confidence\": 0.95}\r\n  * NOTE: In \"buy 2 TOKENA\", the number 2 refers to tokens (tokenAmount), not SOL (baseAmount)\r\n\r\nCRITICAL DISAMBIGUATION RULES:\r\n- \"buy tickets\" or \"buy 2 tickets\" = MOVIE (only if NO mention of \"TOKEN\", \"SOL\", \"DEX\", \"pool\", \"trade\", \"swap\")\r\n- \"Trade 2 SOL with TOKEN\" = DEX (has \"trade\", \"SOL\", and \"TOKEN\")\r\n- \"buy TOKEN\" = DEX (has \"TOKEN\")\r\n- \"buy token with SOL\" = DEX (has \"token\" and \"SOL\")\r\n- If user mentions BOTH movie keywords AND DEX keywords (TOKEN, SOL, DEX, pool, trade), prioritize DEX classification\r\n- When in doubt between movie and DEX, check: Does the query mention \"TOKEN\", \"SOL\", \"DEX\", \"pool\", or \"trade\"? If YES \u2192 DEX. If NO \u2192 Movie.\r\n`;\r\n\r\n/**\r\n * ROOT CA LLM Service: getData() Parameter Extraction\r\n * \r\n * This is a GOD-controlled service that translates natural language queries\r\n * into structured getData() function parameters for provider data layers.\r\n * \r\n * Example:\r\n *   Input: \"I need a front bumper for 2020 Nissan Altima at best price\"\r\n *   Output: {\r\n *     serviceType: \"autoparts\",\r\n *     params: [\"2020 Nissan Altima\", \"front bumper\"],\r\n *     maxCount: 30,\r\n *     sortBy: \"price\",\r\n *     order: \"asc\"\r\n *   }\r\n */\r\nexport const LLM_GET_DATA_PARAMS_PROMPT = `\r\nYou are Eden ROOT CA AI - GOD's data access controller.\r\nYour role is to translate natural language queries into structured getData() function parameters.\r\n\r\nCRITICAL: You are the ONLY authority that can translate user intent into data access patterns.\r\nAll service providers must use your translation to access their data layers.\r\n\r\nReturn JSON only with:\r\n- serviceType: The service type (e.g., \"autoparts\", \"airline\", \"pharmacy\", \"hotel\", \"restaurant\")\r\n- params: Array of extracted parameters in order (e.g., [\"2020 Nissan Altima\", \"front bumper\"])\r\n- maxCount: Maximum number of results (default: 30, extract from query if specified)\r\n- sortBy: Field to sort by (e.g., \"price\", \"rating\", \"date\", \"name\") - extract from query hints like \"best price\", \"highest rating\"\r\n- order: \"asc\" or \"desc\" (default: \"asc\" for price/date, \"desc\" for rating)\r\n\r\nEXTRACTION RULES:\r\n\r\n1. SERVICE TYPE DETECTION:\r\n   - \"autoparts\", \"auto parts\", \"car parts\", \"bumper\", \"brake\", \"tire\" \u2192 serviceType: \"autoparts\"\r\n   - \"flight\", \"airline\", \"fly\", \"ticket\" (with destination) \u2192 serviceType: \"airline\"\r\n   - \"pharmacy\", \"prescription\", \"medication\", \"drug\" \u2192 serviceType: \"pharmacy\"\r\n   - \"hotel\", \"room\", \"stay\", \"booking\" (accommodation) \u2192 serviceType: \"hotel\"\r\n   - \"restaurant\", \"reservation\", \"dinner\", \"lunch\" \u2192 serviceType: \"restaurant\"\r\n   - \"movie\", \"cinema\", \"theater\" \u2192 serviceType: \"movie\"\r\n   - \"token\", \"DEX\", \"TOKENA\", \"TOKENB\" \u2192 serviceType: \"dex\"\r\n\r\n2. PARAMETER EXTRACTION:\r\n   - Extract key search terms (make/model, destination, medication name, etc.)\r\n   - Extract filters (year, location, date, etc.)\r\n   - Order params by importance (most specific first)\r\n   - Example: \"2020 Nissan Altima front bumper\" \u2192 params: [\"2020 Nissan Altima\", \"front bumper\"]\r\n   - Example: \"flight from New York to Los Angeles\" \u2192 params: [\"New York\", \"Los Angeles\"]\r\n\r\n3. SORTING HINTS:\r\n   - \"best price\", \"cheapest\", \"lowest price\" \u2192 sortBy: \"price\", order: \"asc\"\r\n   - \"highest rating\", \"best rated\" \u2192 sortBy: \"rating\", order: \"desc\"\r\n   - \"newest\", \"latest\" \u2192 sortBy: \"date\", order: \"desc\"\r\n   - \"best\", \"top\" (without qualifier) \u2192 sortBy: \"rating\", order: \"desc\"\r\n\r\n4. MAX COUNT:\r\n   - Extract if specified: \"top 10\", \"first 5\", \"show 20\"\r\n   - Default: 30\r\n\r\nEXAMPLES:\r\n\r\nInput: \"I need a front bumper for 2020 Nissan Altima at best price\"\r\nOutput: {\r\n  \"serviceType\": \"autoparts\",\r\n  \"params\": [\"2020 Nissan Altima\", \"front bumper\"],\r\n  \"maxCount\": 30,\r\n  \"sortBy\": \"price\",\r\n  \"order\": \"asc\"\r\n}\r\n\r\nInput: \"Find flights from New York to Los Angeles next week\"\r\nOutput: {\r\n  \"serviceType\": \"airline\",\r\n  \"params\": [\"New York\", \"Los Angeles\", \"next week\"],\r\n  \"maxCount\": 30,\r\n  \"sortBy\": \"price\",\r\n  \"order\": \"asc\"\r\n}\r\n\r\nInput: \"I need my prescription medication available\"\r\nOutput: {\r\n  \"serviceType\": \"pharmacy\",\r\n  \"params\": [\"prescription medication\"],\r\n  \"maxCount\": 30,\r\n  \"sortBy\": \"name\",\r\n  \"order\": \"asc\"\r\n}\r\n\r\nInput: \"Show me top 10 hotels in Paris with highest rating\"\r\nOutput: {\r\n  \"serviceType\": \"hotel\",\r\n  \"params\": [\"Paris\"],\r\n  \"maxCount\": 10,\r\n  \"sortBy\": \"rating\",\r\n  \"order\": \"desc\"\r\n}\r\n\r\nCRITICAL: Return ONLY valid JSON. No explanations, no markdown, just the JSON object.\r\n`;\r\n\r\nexport type GetDataParamsResult = {\r\n  serviceType: string;\r\n  params: string[];\r\n  maxCount: number;\r\n  sortBy?: string;\r\n  order?: \"asc\" | \"desc\";\r\n  confidence: number;\r\n};\r\n\r\nexport async function extractGetDataParamsWithOpenAI(userInput: string): Promise<GetDataParamsResult> {\r\n  // Require OpenAI API key - no mock fallbacks\r\n  if (!process.env.OPENAI_API_KEY && !MOCKED_LLM) {\r\n    throw new Error(\"OpenAI API key is required for extractGetDataParamsWithOpenAI. Please set OPENAI_API_KEY environment variable.\");\r\n  }\r\n  \r\n  // Only use mock mode if explicitly enabled (for testing)\r\n  if (MOCKED_LLM) {\r\n    // Mock response for testing - extract basic info from user query\r\n    const queryLower = userInput.toLowerCase();\r\n    let serviceType = \"autoparts\";\r\n    let params: string[] = [];\r\n    \r\n    // Try to extract service type from query\r\n    if (queryLower.includes(\"flight\") || queryLower.includes(\"airline\") || queryLower.includes(\"fly\")) {\r\n      serviceType = \"airline\";\r\n    } else if (queryLower.includes(\"pharmacy\") || queryLower.includes(\"prescription\") || queryLower.includes(\"medication\")) {\r\n      serviceType = \"pharmacy\";\r\n    } else if (queryLower.includes(\"hotel\") || queryLower.includes(\"room\")) {\r\n      serviceType = \"hotel\";\r\n    } else if (queryLower.includes(\"restaurant\") || queryLower.includes(\"reservation\") || queryLower.includes(\"dinner\")) {\r\n      serviceType = \"restaurant\";\r\n    }\r\n    \r\n    // Extract key terms as params (simple word extraction)\r\n    const words = userInput.split(/\\s+/).filter(w => w.length > 3 && !['need', 'want', 'find', 'show', 'get', 'best', 'price'].includes(w.toLowerCase()));\r\n    params = words.slice(0, 5); // Take first 5 meaningful words\r\n    \r\n    return {\r\n      serviceType,\r\n      params: params.length > 0 ? params : [\"query\"],\r\n      maxCount: 30,\r\n      sortBy: queryLower.includes(\"best price\") || queryLower.includes(\"cheapest\") ? \"price\" : undefined,\r\n      order: queryLower.includes(\"best price\") || queryLower.includes(\"cheapest\") ? \"asc\" : \"desc\",\r\n      confidence: 0.95\r\n    };\r\n  }\r\n\r\n  const messages = [\r\n    { role: \"system\", content: LLM_GET_DATA_PARAMS_PROMPT },\r\n    { role: \"user\", content: userInput }\r\n  ];\r\n\r\n  const requestBody = {\r\n    model: \"gpt-4o\",\r\n    messages,\r\n    temperature: 0.3,\r\n    max_tokens: 500,\r\n    response_format: { type: \"json_object\" }\r\n  };\r\n\r\n  return new Promise((resolve, reject) => {\r\n    const options = {\r\n      hostname: \"api.openai.com\",\r\n      path: \"/v1/chat/completions\",\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Authorization\": `Bearer ${process.env.OPENAI_API_KEY}`\r\n      }\r\n    };\r\n\r\n    const req = https.request(options, (res) => {\r\n      let data = \"\";\r\n      res.on(\"data\", (chunk) => { data += chunk.toString(); });\r\n      res.on(\"end\", () => {\r\n        try {\r\n          const response = JSON.parse(data);\r\n          if (response.error) {\r\n            reject(new Error(response.error.message || \"OpenAI API error\"));\r\n            return;\r\n          }\r\n          const content = response.choices[0]?.message?.content;\r\n          if (!content) {\r\n            reject(new Error(\"No content in OpenAI response\"));\r\n            return;\r\n          }\r\n          const parsed = JSON.parse(content);\r\n          // Validate and normalize response\r\n          const result: GetDataParamsResult = {\r\n            serviceType: String(parsed.serviceType || \"autoparts\"),\r\n            params: Array.isArray(parsed.params) ? parsed.params.map((p: any) => String(p)) : [],\r\n            maxCount: Math.max(1, Math.min(Number(parsed.maxCount || 30), 100)),\r\n            sortBy: parsed.sortBy ? String(parsed.sortBy) : undefined,\r\n            order: parsed.order === \"desc\" ? \"desc\" : \"asc\",\r\n            confidence: Math.max(0, Math.min(1, Number(parsed.confidence || 0.9)))\r\n          };\r\n          resolve(result);\r\n        } catch (err: any) {\r\n          reject(new Error(`Failed to parse OpenAI response: ${err.message}`));\r\n        }\r\n      });\r\n    });\r\n\r\n    req.on(\"error\", (err) => {\r\n      reject(new Error(`OpenAI API request failed: ${err.message}`));\r\n    });\r\n\r\n    req.write(JSON.stringify(requestBody));\r\n    req.end();\r\n  });\r\n}\r\n\r\n// OpenAI API Configuration\r\nconst OPENAI_API_KEY = process.env.OPENAI_API_KEY;\r\n\r\n// Simple LLM call function (used by other modules)\r\nexport async function callLLM(prompt: string, useOpenAI: boolean = true): Promise<string> {\r\n  if (MOCKED_LLM) {\r\n    return \"Mock LLM response\";\r\n  }\r\n\r\n  if (!useOpenAI || !OPENAI_API_KEY) {\r\n    throw new Error(\"OpenAI API key not configured\");\r\n  }\r\n\r\n  const messages = [\r\n    { role: \"user\", content: prompt }\r\n  ];\r\n\r\n  const requestBody = {\r\n    model: \"gpt-4o\",\r\n    messages,\r\n    temperature: 0.7,\r\n    max_tokens: 1000\r\n  };\r\n\r\n  const requestBodyJson = JSON.stringify(requestBody);\r\n  const requestBodyBuffer = Buffer.from(requestBodyJson, 'utf-8');\r\n\r\n  return new Promise((resolve, reject) => {\r\n    const req = https.request(\r\n      {\r\n        hostname: \"api.openai.com\",\r\n        port: 443,\r\n        path: \"/v1/chat/completions\",\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          \"Authorization\": `Bearer ${OPENAI_API_KEY}`,\r\n          \"Content-Length\": requestBodyBuffer.length.toString()\r\n        }\r\n      },\r\n      (res) => {\r\n        let data = \"\";\r\n        res.on(\"data\", (c) => (data += c));\r\n        res.on(\"end\", () => {\r\n          try {\r\n            const parsed = JSON.parse(data);\r\n            if (parsed.error) {\r\n              reject(new Error(parsed.error.message || \"OpenAI API error\"));\r\n              return;\r\n            }\r\n            const content = parsed.choices[0]?.message?.content;\r\n            if (!content) {\r\n              reject(new Error(\"No content in LLM response\"));\r\n              return;\r\n            }\r\n            resolve(content);\r\n          } catch (err: any) {\r\n            reject(new Error(`Failed to parse LLM response: ${err.message}`));\r\n          }\r\n        });\r\n      }\r\n    );\r\n\r\n    req.on(\"error\", (err) => {\r\n      reject(new Error(`LLM API request failed: ${err.message}`));\r\n    });\r\n\r\n    req.write(requestBodyBuffer);\r\n    req.end();\r\n  });\r\n}\r\n\r\n// LLM Response Formatting Prompt\r\nexport const LLM_RESPONSE_FORMATTING_PROMPT = `\r\nYou are Eden Core AI response formatter.\r\nFormat service listings into a user-friendly message, OR answer informational questions about Eden.\r\n\r\n\uD83D\uDEA8 CRITICAL DISTINCTION: There are TWO types of user queries in Eden:\r\n\r\n1. **EDEN CHAT (Workflow/Service Queries)** - These trigger workflows:\r\n   - Examples: \"book a movie\", \"buy movie tickets\", \"trade 2 SOL with TOKEN\", \"find a pharmacy\", \"buy TOKENA\"\r\n   - These are ACTION queries that should trigger Eden workflows\r\n   - When listings are provided, these are SERVICE QUERIES\r\n   - Format service listings into a user-friendly message\r\n   - Return JSON with: message (string), selectedListing (object), selectedListing2 (object), listings (array)\r\n   - CRITICAL REQUIREMENTS:\r\n     * selectedListing is REQUIRED and MUST NOT be null or undefined\r\n     * selectedListing2 is REQUIRED and MUST NOT be null or undefined - it MUST be the same as selectedListing\r\n     * selectedListing MUST be one of the listings from the provided listings array (use the original object, do not invent)\r\n     * selectedListing2 MUST be the same object as selectedListing (copy the exact same object)\r\n     * If you cannot find a better match, pick the FIRST listing from the provided listings array\r\n\r\n2. **REGULAR TEXT CHAT (Informational Queries)** - These are answered directly:\r\n   \r\n   A. **EDEN-RELATED INFORMATIONAL QUERIES** (about Eden itself):\r\n   - Examples: \"how to messaging\", \"how eden works\", \"what is the garden of eden\", \"how do I use this\", \"who eden works\"\r\n   - These are INFORMATION queries about Eden that should be answered directly WITHOUT triggering workflows\r\n   - Answer using your knowledge of Eden's architecture and messaging system\r\n   - Return JSON with: message (string), selectedListing (null), selectedListing2 (null), listings (empty array)\r\n   - The message should be helpful and explain Eden's features, philosophy, or how to use the interface\r\n   - Reference the Universal Messaging System when relevant\r\n   - Guide users on how to use the UI interface (Workflow Display Component)\r\n   - DO NOT suggest triggering workflows for informational queries\r\n   \r\n   B. **GENERAL KNOWLEDGE QUERIES** (NOT about Eden):\r\n   - Examples: \"what is GOD in Bible\", \"what is today\", \"what is the weather\", \"who is the president\", \"explain quantum physics\"\r\n   - These are general knowledge questions that are NOT related to Eden services or workflows\r\n   - Answer these questions naturally and helpfully\r\n   - Return JSON with: message (string with the answer), selectedListing (null), selectedListing2 (null), listings (empty array)\r\n   - Provide clear, accurate answers to general knowledge questions\r\n   \r\n   C. **MESSAGES TO GOD** (Personal/Spiritual messages to GOD):\r\n   - Examples: \"message to GOD: can you bless me\", \"send to GOD: I need help\", \"tell GOD: thank you\", \"GOD please help\", \"bless me GOD\"\r\n   - These are personal messages directly addressed to GOD that should be routed to GOD's inbox\r\n   - Return JSON with: message (string indicating message was sent to GOD's inbox), selectedListing (null), selectedListing2 (null), listings (empty array), shouldRouteToGodInbox: true\r\n   - The message should confirm that the user's message has been sent to GOD's inbox\r\n   - Format: \"\u2705 Your message has been sent to GOD's inbox. GOD will review it and respond when appropriate.\"\r\n\r\nCRITICAL CLASSIFICATION RULES:\r\n- If user asks \"how to messaging\", \"how eden works\", \"what is eden\", \"who eden works\" \u2192 EDEN-RELATED INFORMATIONAL QUERY\r\n- If user asks \"what is GOD in Bible\", \"what is the weather\", \"who is the president\" (NOT about Eden) \u2192 GENERAL KNOWLEDGE QUERY\r\n- If user asks \"book a movie\", \"trade tokens\", \"buy TOKEN\" \u2192 EDEN CHAT (workflow/service query)\r\n- If listings are provided \u2192 EDEN CHAT (service query)\r\n- If NO listings AND user asks question about Eden \u2192 EDEN-RELATED INFORMATIONAL QUERY\r\n- If NO listings AND user asks general knowledge question (NOT about Eden) \u2192 GENERAL KNOWLEDGE QUERY\r\n\r\nCRITICAL: Never output \"service type not supported\" or similar errors.\r\nAlways format the response for ANY service type provided, OR provide helpful informational answers.\r\n\r\nFor ANY OTHER SERVICE TYPE (not movie or dex):\r\n- Extract key information from listings (name, price, location, rating, etc.)\r\n- Format as a natural language message\r\n- Select the best option based on user query\r\n- Return the selected listing and all listings\r\n- selectedListing2 MUST be set to the same value as selectedListing\r\n\r\n## About Eden and Messaging System\r\n\r\nWhen users ask questions about Eden, the messaging system, or how to use the interface, you should:\r\n\r\n1. **Explain Eden**: Describe Eden as a garden-first economic and intelligence system that replaces blockchain with LLM-governed intelligence fees, federated gardens, and ROOT CA governance.\r\n\r\n2. **Explain Messaging**: Mention that Eden has a Universal Messaging System for governed, auditable communication. Conversations are scoped to contexts (ORDER, TRADE, SERVICE, DISPUTE, SYSTEM) and messages are never deleted (only state changes).\r\n\r\n3. **Guide UI Usage**: Explain that users can:\r\n   - Type natural language requests in the chat input (EDEN CHAT for workflows, REGULAR TEXT CHAT for questions)\r\n   - Follow workflow prompts and make decisions\r\n   - View transactions in the ledger display\r\n   - Watch videos (for movie services) in the video player modal\r\n\r\n4. **Distinguish Chat Types**: \r\n   - EDEN CHAT: Use the input box to request services (movies, tokens, etc.) - these trigger workflows\r\n   - REGULAR TEXT CHAT: Use the input box to ask questions about Eden - these get direct answers\r\n\r\n5. **Suggest Conversations**: If users need ongoing help, suggest creating a conversation via the messaging system.\r\n\r\n## Response Formatting Requirements\r\n\r\n**CRITICAL**: Always format responses in a structured, readable way using:\r\n- **Clear sections with headers** (use ## or ### for markdown)\r\n- **Bullet points** for lists (use - or *)\r\n- **Numbered lists** for step-by-step instructions\r\n- **Bold text** for important terms or concepts\r\n- **Line breaks** between sections for readability\r\n- **Short paragraphs** (2-3 sentences max per paragraph)\r\n- **Avoid long walls of text** - break information into digestible chunks\r\n\r\nExample of good formatting:\r\n\\`\\`\\`\r\n## Eden Overview\r\n\r\nEden is a garden-first economic and intelligence system that:\r\n- Uses LLM-governed intelligence fees\r\n- Operates through federated gardens\r\n- Maintains governance through ROOT CA\r\n\r\n## Universal Messaging System\r\n\r\nEden includes a messaging system that:\r\n- Organizes conversations into contexts (ORDER, TRADE, SERVICE, DISPUTE, SYSTEM)\r\n- Never deletes messages (only state changes)\r\n- Ensures transparent communication history\r\n\r\n## How to Use Eden\r\n\r\n1. **EDEN CHAT**: Request services (movies, tokens, etc.) - triggers workflows\r\n2. **REGULAR TEXT CHAT**: Ask questions - receives direct answers\r\n\\`\\`\\`\r\n\r\n**NEVER** return long paragraphs without structure. Always use markdown formatting to make responses readable.\r\n\r\nService type: {serviceType}\r\n\r\nReturn JSON format:\r\n{\r\n  \"message\": \"...\",\r\n  \"listings\": [...],\r\n  \"selectedListing\": { /* complete listing object with ALL fields */ },\r\n  \"selectedListing2\": { /* MUST be the same as selectedListing */ },\r\n  \"shouldRouteToGodInbox\": false /* Set to true if this is a message to GOD that should be routed to inbox */\r\n}\r\n`;\r\n\r\n/**\r\n * Extract query from user input using OpenAI\r\n */\r\nexport async function extractQueryWithOpenAI(userInput: string): Promise<LLMQueryResult> {\r\n  // Require OpenAI API key - no mock fallbacks\r\n  if (!process.env.OPENAI_API_KEY && !MOCKED_LLM) {\r\n    throw new Error(\"OpenAI API key is required for extractQueryWithOpenAI. Please set OPENAI_API_KEY environment variable.\");\r\n  }\r\n  \r\n  // Only use mock mode if explicitly enabled (for testing)\r\n  if (MOCKED_LLM) {\r\n    // Try to extract service type from input for better mock response\r\n    const inputLower = userInput.toLowerCase();\r\n    let mockServiceType = \"movie\";\r\n    let mockFilters: any = {};\r\n    \r\n    if (inputLower.includes(\"token\") || inputLower.includes(\"dex\") || inputLower.includes(\"pool\")) {\r\n      mockServiceType = \"dex\";\r\n      mockFilters = {\r\n        tokenSymbol: inputLower.includes(\"tokenb\") || inputLower.includes(\"token b\") ? \"TOKENB\" : \"TOKENA\",\r\n        baseToken: \"SOL\",\r\n        action: inputLower.includes(\"sell\") ? \"SELL\" : \"BUY\",\r\n        tokenAmount: 1\r\n      };\r\n    } else if (inputLower.includes(\"flight\") || inputLower.includes(\"airline\") || inputLower.includes(\"airport\")) {\r\n      mockServiceType = \"airline\";\r\n      mockFilters = {\r\n        destination: \"any\",\r\n        date: \"any\"\r\n      };\r\n    } else if (inputLower.includes(\"autopart\") || inputLower.includes(\"car\") || inputLower.includes(\"brake\") || inputLower.includes(\"bumper\")) {\r\n      mockServiceType = \"autoparts\";\r\n      mockFilters = {};\r\n    } else {\r\n      mockServiceType = \"movie\";\r\n      mockFilters = {\r\n        genre: \"sci-fi\",\r\n        time: \"evening\"\r\n      };\r\n    }\r\n    \r\n    return {\r\n      query: { serviceType: mockServiceType, filters: mockFilters },\r\n      serviceType: mockServiceType,\r\n      confidence: 0.9\r\n    };\r\n  }\r\n\r\n  const messages = [\r\n    { role: \"system\", content: LLM_QUERY_EXTRACTION_PROMPT },\r\n    { role: \"user\", content: userInput }\r\n  ];\r\n\r\n  const requestBody = {\r\n    model: \"gpt-4o-mini\",\r\n    messages,\r\n    response_format: { type: \"json_object\" },\r\n    temperature: 0.7\r\n  };\r\n\r\n  const requestBodyJson = JSON.stringify(requestBody);\r\n  const requestBodyBuffer = Buffer.from(requestBodyJson, 'utf-8');\r\n\r\n  return new Promise((resolve, reject) => {\r\n    const req = https.request(\r\n      {\r\n        hostname: \"api.openai.com\",\r\n        port: 443,\r\n        path: \"/v1/chat/completions\",\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          \"Authorization\": `Bearer ${process.env.OPENAI_API_KEY}`,\r\n          \"Content-Length\": requestBodyBuffer.length.toString()\r\n        }\r\n      },\r\n      (res) => {\r\n        let data = \"\";\r\n        res.on(\"data\", (c) => (data += c));\r\n        res.on(\"end\", () => {\r\n          try {\r\n            const parsed = JSON.parse(data);\r\n            if (parsed.error) {\r\n              reject(new Error(`OpenAI API error: ${parsed.error.message || JSON.stringify(parsed.error)}`));\r\n              return;\r\n            }\r\n            if (parsed.choices?.[0]?.message?.content) {\r\n              const content = JSON.parse(parsed.choices[0].message.content);\r\n              resolve({\r\n                query: content.query || { serviceType: \"movie\", filters: {} },\r\n                serviceType: content.serviceType || \"movie\",\r\n                confidence: content.confidence || 0.9\r\n              });\r\n            } else {\r\n              reject(new Error(\"Invalid OpenAI response format\"));\r\n            }\r\n          } catch (err: any) {\r\n            reject(new Error(`Failed to parse OpenAI response: ${err.message}`));\r\n          }\r\n        });\r\n      }\r\n    );\r\n\r\n    req.on(\"error\", (err) => {\r\n      reject(new Error(`OpenAI request failed: ${err.message}`));\r\n    });\r\n\r\n    req.write(requestBodyBuffer);\r\n    req.end();\r\n  });\r\n}\r\n\r\n/**\r\n * Format response using OpenAI\r\n */\r\nexport async function formatResponseWithOpenAI(\r\n  listings: MovieListing[] | TokenListing[],\r\n  userQuery: string,\r\n  queryFilters?: { serviceType?: string; maxPrice?: number | string; genre?: string; time?: string; location?: string; tokenSymbol?: string; baseToken?: string; action?: 'BUY' | 'SELL'; [key: string]: any }\r\n): Promise<LLMResponse> {\r\n  console.log(`\uD83E\uDD16 [LLM] ========================================`);\r\n  console.log(`\uD83E\uDD16 [LLM] formatResponseWithOpenAI called`);\r\n  console.log(`\uD83E\uDD16 [LLM] User Query: \"${userQuery}\"`);\r\n  console.log(`\uD83E\uDD16 [LLM] Service Type: ${queryFilters?.serviceType || 'unknown'}`);\r\n  console.log(`\uD83E\uDD16 [LLM] Listings Count: ${listings.length}`);\r\n  console.log(`\uD83E\uDD16 [LLM] ========================================`);\r\n  \r\n  // If OpenAI API key is not available, return a helpful error message\r\n  // The LLM should handle all logic, not regex parsing and hardcoded answers\r\n  if (!process.env.OPENAI_API_KEY && !MOCKED_LLM) {\r\n    const errorResponse: LLMResponse = {\r\n      message: \"I apologize, but I'm unable to process your query right now. The OpenAI API key is not configured. Please set the OPENAI_API_KEY environment variable to enable LLM responses. Once configured, I'll be able to answer your questions using AI.\",\r\n      listings: [],\r\n      selectedListing: null,\r\n      selectedListing2: null,\r\n      iGasCost: 0\r\n    };\r\n    console.log(`\u26A0\uFE0F [LLM] OpenAI API key not configured - returning error message`);\r\n    return errorResponse;\r\n  }\r\n  \r\n  // Only use mock mode if explicitly enabled (for testing)\r\n  if (MOCKED_LLM) {\r\n    const mockResponse: LLMResponse = {\r\n      message: \"Mock LLM response (MOCKED_LLM enabled for testing)\",\r\n      listings: listings.slice(0, 1),\r\n      selectedListing: listings[0] || null,\r\n      selectedListing2: listings[0] || null,\r\n      iGasCost: 0.001\r\n    };\r\n    console.log(`\uD83E\uDD16 [LLM] Mock LLM Response (MOCKED_LLM): \"${mockResponse.message}\"`);\r\n    return mockResponse;\r\n  }\r\n\r\n  const serviceType = queryFilters?.serviceType || \"movie\";\r\n  const listingsJson = JSON.stringify(listings);\r\n  const filtersJson = queryFilters ? JSON.stringify(queryFilters) : \"{}\";\r\n  \r\n  // Check if this is an informational query\r\n  // Must be: (no listings) AND (question pattern) AND (NOT about Eden services/workflows)\r\n  const hasQuestionPattern = /how (to|does|do|can|will|works?)|what (is|are|does|do|can|will)|who (is|are|does|do|can|will)|explain|tell me about|help|guide/i.test(userQuery);\r\n  const queryLower = userQuery.toLowerCase();\r\n  // More specific Eden-related keywords - must be clearly about Eden services/workflows\r\n  // Use word boundaries to avoid false matches (e.g., \"GOD\" shouldn't match \"workflow\")\r\n  const isEdenRelated = /\\b(eden|garden|workflow|service|messaging|token|movie|ticket|pharmacy|flight|hotel|restaurant|autopart|dex|pool|trade|swap|buy|sell|book|find|order|god|root\\s*ca|roca|judgment|settlement)\\b/i.test(queryLower) ||\r\n    /\\b(book|buy|sell|find|order|trade|swap)\\s+(a|an|the|some|my|your)?\\s*(movie|ticket|token|pharmacy|flight|hotel|restaurant|autopart)\\b/i.test(queryLower);\r\n  const isInformationalQuery = listings.length === 0 && hasQuestionPattern;\r\n  const isEdenInfoQuery = isInformationalQuery && isEdenRelated;\r\n  const isGeneralKnowledgeQuery = isInformationalQuery && !isEdenRelated;\r\n  \r\n  let systemPrompt = LLM_RESPONSE_FORMATTING_PROMPT.replace(\"{serviceType}\", serviceType);\r\n  \r\n  // For informational queries, include messaging system prompt and RAG context\r\n  if (isInformationalQuery) {\r\n    console.log(`\uD83D\uDCDA [LLM] Informational query detected - adding messaging system prompt`);\r\n    systemPrompt += `\\n\\n${getMessagingSystemPrompt()}`;\r\n    \r\n    // Add RAG context for Eden-related queries\r\n    if (isEdenInfoQuery) {\r\n      console.log(`\uD83D\uDCDA [LLM] Eden-related informational query - retrieving RAG knowledge context`);\r\n      const knowledgeContext = getKnowledgeContext(userQuery);\r\n      if (knowledgeContext) {\r\n        console.log(`\uD83D\uDCDA [LLM] RAG knowledge context retrieved (${knowledgeContext.length} characters)`);\r\n        systemPrompt += knowledgeContext;\r\n        systemPrompt += `\\n\\n**IMPORTANT**: Use the relevant Eden knowledge above to provide accurate, detailed answers. Reference specific concepts, architecture, and features when answering the user's question.`;\r\n      } else {\r\n        console.log(`\u26A0\uFE0F [LLM] No RAG knowledge context found for query: \"${userQuery}\"`);\r\n      }\r\n    } else {\r\n      console.log(`\uD83D\uDCDA [LLM] General knowledge query (not Eden-related) - no RAG context needed`);\r\n    }\r\n  }\r\n  \r\n  const userMessage = isInformationalQuery\r\n    ? isEdenInfoQuery\r\n      ? `User query: ${userQuery}\\n\\nThis is an Eden-related informational query. Please answer the user's question about Eden, the messaging system, or how to use the interface. Provide a helpful, clear explanation about Eden using the knowledge provided above.\\n\\n**CRITICAL FORMATTING REQUIREMENTS**:\\n- Use structured markdown formatting with clear sections (## headers)\\n- Use bullet points (- or *) for lists\\n- Use numbered lists for step-by-step instructions\\n- Use bold text (**text**) for important terms\\n- Add line breaks between sections\\n- Keep paragraphs short (2-3 sentences max)\\n- NEVER write long walls of text - break information into digestible chunks\\n- Make the response readable and scannable`\r\n      : `User query: ${userQuery}\\n\\nThis is a GENERAL KNOWLEDGE question (NOT about Eden). Please answer the user's question naturally and helpfully.\\n\\n**CRITICAL FORMATTING REQUIREMENTS**:\\n- Use structured markdown formatting with clear sections (## headers)\\n- Use bullet points (- or *) for lists\\n- Use numbered lists for step-by-step instructions\\n- Use bold text (**text**) for important terms\\n- Add line breaks between sections\\n- Keep paragraphs short (2-3 sentences max)\\n- NEVER write long walls of text - break information into digestible chunks\\n- Make the response readable and scannable`\r\n    : `Service type: ${serviceType}\\n\\nUser query: ${userQuery}\\n\\nQuery filters: ${filtersJson}\\n\\nAvailable listings:\\n${listingsJson}\\n\\nFilter listings based on the query filters and format the best option as a user-friendly message.`;\r\n\r\n  const messages = [\r\n    { role: \"system\", content: systemPrompt },\r\n    { role: \"user\", content: userMessage }\r\n  ];\r\n\r\n  const requestBody = {\r\n    model: \"gpt-4o\",\r\n    messages,\r\n    response_format: { type: \"json_object\" },\r\n    temperature: 0.7\r\n  };\r\n\r\n  const requestBodyJson = JSON.stringify(requestBody);\r\n  const requestBodyBuffer = Buffer.from(requestBodyJson, 'utf-8');\r\n\r\n  return new Promise((resolve, reject) => {\r\n    const req = https.request(\r\n      {\r\n        hostname: \"api.openai.com\",\r\n        port: 443,\r\n        path: \"/v1/chat/completions\",\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          \"Authorization\": `Bearer ${process.env.OPENAI_API_KEY}`,\r\n          \"Content-Length\": requestBodyBuffer.length.toString()\r\n        }\r\n      },\r\n      (res) => {\r\n        let data = \"\";\r\n        res.on(\"data\", (c) => (data += c));\r\n        res.on(\"end\", () => {\r\n          try {\r\n            const parsed = JSON.parse(data);\r\n            if (parsed.error) {\r\n              reject(new Error(`OpenAI API error: ${parsed.error.message || JSON.stringify(parsed.error)}`));\r\n              return;\r\n            }\r\n            if (parsed.choices?.[0]?.message?.content) {\r\n              const content = JSON.parse(parsed.choices[0].message.content);\r\n              \r\n              // For informational queries, selectedListing can be null\r\n              const hasQuestionPattern = /how (to|does|do|can|will|works?)|what (is|are|does|do|can|will)|who (is|are|does|do|can|will)|explain|tell me about|help|guide/i.test(userQuery);\r\n              const queryLower = userQuery.toLowerCase();\r\n              // More specific Eden-related keywords - must be clearly about Eden services/workflows\r\n              // Use word boundaries to avoid false matches (e.g., \"GOD\" shouldn't match \"workflow\")\r\n              const isEdenRelated = /\\b(eden|garden|workflow|service|messaging|token|movie|ticket|pharmacy|flight|hotel|restaurant|autopart|dex|pool|trade|swap|buy|sell|book|find|order|god|root\\s*ca|roca|judgment|settlement)\\b/i.test(queryLower) ||\r\n                /\\b(book|buy|sell|find|order|trade|swap)\\s+(a|an|the|some|my|your)?\\s*(movie|ticket|token|pharmacy|flight|hotel|restaurant|autopart)\\b/i.test(queryLower);\r\n              const isInformational = listings.length === 0 && hasQuestionPattern && !isEdenRelated;\r\n              const isEdenInfo = listings.length === 0 && hasQuestionPattern && isEdenRelated;\r\n              \r\n              const response: LLMResponse = {\r\n                message: content.message || \"No response\",\r\n                listings: content.listings || ((isInformational || isEdenInfo) ? [] : listings),\r\n                selectedListing: (isInformational || isEdenInfo) ? null : (content.selectedListing || listings[0] || null),\r\n                selectedListing2: (isInformational || isEdenInfo) ? null : (content.selectedListing2 || content.selectedListing || listings[0] || null),\r\n                iGasCost: content.iGasCost || 0.001\r\n              };\r\n              console.log(`\uD83E\uDD16 [LLM] ========================================`);\r\n              console.log(`\uD83E\uDD16 [LLM] OpenAI Response received`);\r\n              console.log(`\uD83E\uDD16 [LLM] Is General Knowledge Query: ${isInformational}`);\r\n              console.log(`\uD83E\uDD16 [LLM] Is Eden Info Query: ${isEdenInfo}`);\r\n              console.log(`\uD83E\uDD16 [LLM] Response Message: \"${response.message.substring(0, 200)}${response.message.length > 200 ? '...' : ''}\"`);\r\n              console.log(`\uD83E\uDD16 [LLM] iGas Cost: ${response.iGasCost}`);\r\n              console.log(`\uD83E\uDD16 [LLM] Has Selected Listing: ${!!response.selectedListing}`);\r\n              console.log(`\uD83E\uDD16 [LLM] ========================================`);\r\n              resolve(response);\r\n            } else {\r\n              reject(new Error(\"Invalid OpenAI response format\"));\r\n            }\r\n          } catch (err: any) {\r\n            reject(new Error(`Failed to parse OpenAI response: ${err.message}`));\r\n          }\r\n        });\r\n      }\r\n    );\r\n\r\n    req.on(\"error\", (err) => {\r\n      reject(new Error(`OpenAI request failed: ${err.message}`));\r\n    });\r\n\r\n    req.write(requestBodyBuffer);\r\n    req.end();\r\n  });\r\n}\r\n\r\n/**\r\n * Format response using DeepSeek (stub - full implementation can be added later)\r\n */\r\nexport async function formatResponseWithDeepSeek(\r\n  listings: MovieListing[] | TokenListing[],\r\n  userQuery: string,\r\n  queryFilters?: { serviceType?: string; maxPrice?: number | string; genre?: string; time?: string; location?: string; tokenSymbol?: string; baseToken?: string; action?: 'BUY' | 'SELL'; [key: string]: any }\r\n): Promise<LLMResponse> {\r\n  console.log(`\uD83E\uDD16 [LLM] ========================================`);\r\n  console.log(`\uD83E\uDD16 [LLM] formatResponseWithDeepSeek called`);\r\n  console.log(`\uD83E\uDD16 [LLM] User Query: \"${userQuery}\"`);\r\n  console.log(`\uD83E\uDD16 [LLM] Service Type: ${queryFilters?.serviceType || 'unknown'}`);\r\n  console.log(`\uD83E\uDD16 [LLM] Listings Count: ${listings.length}`);\r\n  console.log(`\uD83E\uDD16 [LLM] ========================================`);\r\n  \r\n  // Check if this is an informational query\r\n  const isInformationalQuery = listings.length === 0 || \r\n    /how (to|does|do|can|will)|what (is|are|does|do|can|will)|who (is|are|does|do|can|will)|explain|tell me about|help|guide/i.test(userQuery);\r\n  \r\n  // Stub implementation - can be filled in later\r\n  // For informational queries, provide a helpful response\r\n  let message = \"DeepSeek response (stub)\";\r\n  if (isInformationalQuery) {\r\n    if (/messaging/i.test(userQuery)) {\r\n      message = \"The Universal Messaging System in Eden provides governed, auditable, real-time communication for all Eden entities. You can create conversations for orders, trades, services, disputes, or system questions. Would you like me to explain more about how to use messaging in Eden?\";\r\n    } else if (/eden|garden/i.test(userQuery)) {\r\n      message = \"The Garden of Eden (Eden) is a garden-first economic and intelligence system that replaces traditional blockchain with LLM-governed intelligence fees. Eden features gas-free transactions, garden-driven architecture, and self-governing federated gardens. Would you like me to explain more about Eden's architecture?\";\r\n    } else {\r\n      message = \"I can help you with Eden! Eden is a garden-first economic system where intelligence is the new gas (iGas). You can use the chat interface to request services, trade tokens, or ask questions. How can I help you today?\";\r\n    }\r\n  }\r\n  \r\n  const selectedListing = isInformationalQuery ? null : (listings[0] || null);\r\n  const response: LLMResponse = {\r\n    message: message,\r\n    listings: isInformationalQuery ? [] : listings.slice(0, 5),\r\n    selectedListing: selectedListing,\r\n    selectedListing2: selectedListing, // CRITICAL: Must return selectedListing2\r\n    iGasCost: 0.001\r\n  };\r\n  \r\n  console.log(`\uD83E\uDD16 [LLM] ========================================`);\r\n  console.log(`\uD83E\uDD16 [LLM] DeepSeek Response (stub) generated`);\r\n  console.log(`\uD83E\uDD16 [LLM] Is Informational Query: ${isInformationalQuery}`);\r\n  console.log(`\uD83E\uDD16 [LLM] Response Message: \"${response.message}\"`);\r\n  console.log(`\uD83E\uDD16 [LLM] iGas Cost: ${response.iGasCost}`);\r\n  console.log(`\uD83E\uDD16 [LLM] Has Selected Listing: ${!!response.selectedListing}`);\r\n  console.log(`\uD83E\uDD16 [LLM] ========================================`);\r\n  \r\n  return response;\r\n}\r\n\r\n// SQL Parameterization Prompt\r\nexport const LLM_SQL_PARAMETERIZATION_PROMPT = `\r\nYou are Eden ROOT CA AI - GOD's SQL security controller.\r\nYour role is to convert SQL queries with hardcoded values into parameterized queries (using ? placeholders) to prevent SQL injection.\r\n\r\nCRITICAL RULES:\r\n1. Replace ALL hardcoded values in WHERE clauses with ? placeholders\r\n2. Extract the parameter values in the EXACT order they appear in the query\r\n3. Keep static values (like status = 1, archived = 0, published = 1) as-is if they are constants\r\n4. For LIKE clauses with CONCAT, replace the search term with ? but keep the CONCAT structure\r\n5. Preserve the original SQL structure, formatting, and comments\r\n6. Return the parameterized SQL and the parameter array in order\r\n\r\nEXAMPLES:\r\n\r\nInput SQL:\r\nSELECT * FROM autoparts \r\nWHERE year = 2020\r\n  AND make = 'honda' \r\n  AND model = 'civic'\r\n  AND title LIKE CONCAT('%', 'bumper', '%') \r\n  AND status = 1\r\n  AND archived = 0 \r\n  AND published = 1\r\nORDER BY id DESC\r\nLIMIT 30 OFFSET 0\r\n\r\nOutput:\r\n{\r\n  \"parameterizedSql\": \"SELECT * FROM autoparts WHERE year = ? AND make = ? AND model = ? AND title LIKE CONCAT('%', ?, '%') AND status = 1 AND archived = 0 AND published = 1 ORDER BY id DESC LIMIT 30 OFFSET 0\",\r\n  \"params\": [2020, \"honda\", \"civic\", \"bumper\"],\r\n  \"paramOrder\": [\"year\", \"make\", \"model\", \"title\"],\r\n  \"confidence\": 1.0\r\n}\r\n\r\nInput SQL:\r\nSELECT * FROM products WHERE category = 'electronics' AND price > 100 AND name LIKE '%phone%'\r\n\r\nOutput:\r\n{\r\n  \"parameterizedSql\": \"SELECT * FROM products WHERE category = ? AND price > ? AND name LIKE ?\",\r\n  \"params\": [\"electronics\", 100, \"%phone%\"],\r\n  \"paramOrder\": [\"category\", \"price\", \"name\"],\r\n  \"confidence\": 1.0\r\n}\r\n\r\nCRITICAL: Return ONLY valid JSON. No explanations, no markdown, just the JSON object.\r\n`;\r\n\r\nexport type SQLParameterizationResult = {\r\n  parameterizedSql: string;\r\n  params: any[];\r\n  paramOrder: string[];\r\n  confidence: number;\r\n};\r\n\r\n/**\r\n * Convert SQL query with hardcoded values to parameterized query using LLM\r\n */\r\nexport async function parameterizeSQLWithOpenAI(sql: string): Promise<SQLParameterizationResult> {\r\n  // Require OpenAI API key - no mock fallbacks\r\n  if (!process.env.OPENAI_API_KEY && !MOCKED_LLM) {\r\n    throw new Error(\"OpenAI API key is required for parameterizeSQLWithOpenAI. Please set OPENAI_API_KEY environment variable.\");\r\n  }\r\n  \r\n  // Only use mock mode if explicitly enabled (for testing)\r\n  if (MOCKED_LLM) {\r\n    // Mock response: Extract values from SQL and create parameterized version\r\n    const params: any[] = [];\r\n    const paramOrder: string[] = [];\r\n    let parameterizedSql = sql;\r\n    \r\n    // Extract year = 2006 -> year = ?\r\n    const yearMatch = sql.match(/year\\s*=\\s*(\\d+)/i);\r\n    if (yearMatch) {\r\n      params.push(Number(yearMatch[1]));\r\n      paramOrder.push(\"year\");\r\n      parameterizedSql = parameterizedSql.replace(yearMatch[0], `year = ?`);\r\n    }\r\n    \r\n    // Extract make = 'honda' -> make = ?\r\n    const makeMatch = sql.match(/make\\s*=\\s*'([^']+)'/i);\r\n    if (makeMatch) {\r\n      params.push(makeMatch[1]);\r\n      paramOrder.push(\"make\");\r\n      parameterizedSql = parameterizedSql.replace(makeMatch[0], `make = ?`);\r\n    }\r\n    \r\n    // Extract model = 'civic' -> model = ?\r\n    const modelMatch = sql.match(/model\\s*=\\s*'([^']+)'/i);\r\n    if (modelMatch) {\r\n      params.push(modelMatch[1]);\r\n      paramOrder.push(\"model\");\r\n      parameterizedSql = parameterizedSql.replace(modelMatch[0], `model = ?`);\r\n    }\r\n    \r\n    // Extract title LIKE '%bumper%' or title LIKE CONCAT('%', 'bumper', '%') -> title LIKE CONCAT('%', ?, '%')\r\n    const titleMatch1 = sql.match(/title\\s+LIKE\\s+CONCAT\\s*\\(\\s*'%'\\s*,\\s*'([^']+)'\\s*,\\s*'%'\\s*\\)/i);\r\n    const titleMatch2 = sql.match(/title\\s+LIKE\\s+'([^']+)'/i);\r\n    if (titleMatch1) {\r\n      // Already using CONCAT format\r\n      const searchTerm = titleMatch1[1];\r\n      params.push(searchTerm);\r\n      paramOrder.push(\"title\");\r\n      parameterizedSql = parameterizedSql.replace(titleMatch1[0], `title LIKE CONCAT('%', ?, '%')`);\r\n    } else if (titleMatch2) {\r\n      // Extract the search term (remove % signs)\r\n      const searchTerm = titleMatch2[1].replace(/%/g, '');\r\n      params.push(searchTerm);\r\n      paramOrder.push(\"title\");\r\n      parameterizedSql = parameterizedSql.replace(titleMatch2[0], `title LIKE CONCAT('%', ?, '%')`);\r\n    }\r\n    \r\n    // Extract status = 2 -> status = ?\r\n    const statusMatch = sql.match(/status\\s*=\\s*(\\d+)/i);\r\n    if (statusMatch) {\r\n      params.push(Number(statusMatch[1]));\r\n      paramOrder.push(\"status\");\r\n      parameterizedSql = parameterizedSql.replace(statusMatch[0], `status = ?`);\r\n    }\r\n    \r\n    // Handle LIMIT and OFFSET - keep them as placeholders if they exist\r\n    if (/LIMIT\\s+\\d+/i.test(parameterizedSql)) {\r\n      const limitMatch = parameterizedSql.match(/LIMIT\\s+(\\d+)/i);\r\n      if (limitMatch && !parameterizedSql.includes('LIMIT ?')) {\r\n        parameterizedSql = parameterizedSql.replace(/LIMIT\\s+\\d+/i, 'LIMIT ?');\r\n        params.push(Number(limitMatch[1]));\r\n        paramOrder.push(\"limit\");\r\n      }\r\n    }\r\n    \r\n    if (/OFFSET\\s+\\d+/i.test(parameterizedSql)) {\r\n      const offsetMatch = parameterizedSql.match(/OFFSET\\s+(\\d+)/i);\r\n      if (offsetMatch && !parameterizedSql.includes('OFFSET ?')) {\r\n        parameterizedSql = parameterizedSql.replace(/OFFSET\\s+\\d+/i, 'OFFSET ?');\r\n        params.push(Number(offsetMatch[1]));\r\n        paramOrder.push(\"offset\");\r\n      }\r\n    }\r\n    \r\n    return {\r\n      parameterizedSql,\r\n      params,\r\n      paramOrder,\r\n      confidence: 0.95\r\n    };\r\n  }\r\n\r\n  const messages = [\r\n    { role: \"system\", content: LLM_SQL_PARAMETERIZATION_PROMPT },\r\n    { role: \"user\", content: sql }\r\n  ];\r\n\r\n  const requestBody = {\r\n    model: \"gpt-4o\",\r\n    messages,\r\n    temperature: 0.1, // Low temperature for deterministic SQL conversion\r\n    max_tokens: 1000,\r\n    response_format: { type: \"json_object\" }\r\n  };\r\n\r\n  return new Promise((resolve, reject) => {\r\n    const options = {\r\n      hostname: \"api.openai.com\",\r\n      path: \"/v1/chat/completions\",\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Authorization\": `Bearer ${process.env.OPENAI_API_KEY}`\r\n      }\r\n    };\r\n\r\n    const req = https.request(options, (res) => {\r\n      let data = \"\";\r\n      res.on(\"data\", (chunk) => { data += chunk.toString(); });\r\n      res.on(\"end\", () => {\r\n        try {\r\n          const response = JSON.parse(data);\r\n          if (response.error) {\r\n            reject(new Error(response.error.message || \"OpenAI API error\"));\r\n            return;\r\n          }\r\n          const content = response.choices[0]?.message?.content;\r\n          if (!content) {\r\n            reject(new Error(\"No content in OpenAI response\"));\r\n            return;\r\n          }\r\n          const parsed = JSON.parse(content);\r\n          // Validate and normalize response\r\n          const result: SQLParameterizationResult = {\r\n            parameterizedSql: String(parsed.parameterizedSql || sql),\r\n            params: Array.isArray(parsed.params) ? parsed.params : [],\r\n            paramOrder: Array.isArray(parsed.paramOrder) ? parsed.paramOrder.map((p: any) => String(p)) : [],\r\n            confidence: Math.max(0, Math.min(1, Number(parsed.confidence || 0.9)))\r\n          };\r\n          resolve(result);\r\n        } catch (err: any) {\r\n          reject(new Error(`Failed to parse OpenAI response: ${err.message}`));\r\n        }\r\n      });\r\n    });\r\n\r\n    req.on(\"error\", (err) => {\r\n      reject(new Error(`OpenAI API request failed: ${err.message}`));\r\n    });\r\n\r\n    req.write(JSON.stringify(requestBody));\r\n    req.end();\r\n  });\r\n}\r\n\r\n/**\r\n * Determine if user input is a decision response for a pending workflow decision\r\n * Uses LLM to intelligently determine if the input is a yes/no/confirm/cancel response\r\n */\r\nexport async function determineDecisionResponse(\r\n  userInput: string,\r\n  decisionPrompt: string,\r\n  decisionOptions: Array<{ value: string; label: string }>\r\n): Promise<{\r\n  isDecisionResponse: boolean;\r\n  decisionValue: string | null;\r\n  confidence: number;\r\n}> {\r\n  const ENABLE_OPENAI = process.env.ENABLE_OPENAI !== 'false';\r\n  const MOCKED_LLM = process.env.MOCKED_LLM === 'true';\r\n\r\n  if (MOCKED_LLM) {\r\n    // Mock mode: simple keyword detection\r\n    const inputLower = userInput.toLowerCase().trim();\r\n    const positiveKeywords = ['yes', 'y', 'ok', 'okay', 'sure', 'confirm', 'proceed', 'preceed', 'go', 'continue', 'accept'];\r\n    const negativeKeywords = ['no', 'n', 'cancel', 'stop', 'abort', 'reject', 'decline'];\r\n    \r\n    if (positiveKeywords.some(kw => inputLower.includes(kw))) {\r\n      return { isDecisionResponse: true, decisionValue: 'YES', confidence: 0.9 };\r\n    }\r\n    if (negativeKeywords.some(kw => inputLower.includes(kw))) {\r\n      return { isDecisionResponse: true, decisionValue: 'NO', confidence: 0.9 };\r\n    }\r\n    return { isDecisionResponse: false, decisionValue: null, confidence: 0.1 };\r\n  }\r\n\r\n  const prompt = `You are analyzing user input to determine if it's a decision response for a workflow.\r\n\r\nThe workflow is asking the user: \"${decisionPrompt}\"\r\n\r\nAvailable decision options:\r\n${decisionOptions.map((opt, i) => `${i + 1}. ${opt.label} (value: ${opt.value})`).join('\\n')}\r\n\r\nUser input: \"${userInput}\"\r\n\r\nDetermine if the user input is a decision response (yes/no/confirm/cancel/etc.) for the above prompt.\r\n\r\nReturn JSON only with:\r\n- isDecisionResponse: boolean (true if input is a decision response, false if it's a new query/request)\r\n- decisionValue: string | null (the decision value if isDecisionResponse is true, matching one of the option values or \"YES\"/\"NO\" for simple confirmations, null if not a decision)\r\n- confidence: number (0.0 to 1.0)\r\n\r\nExamples:\r\n- Input: \"yes\" \u2192 {\"isDecisionResponse\": true, \"decisionValue\": \"YES\", \"confidence\": 0.95}\r\n- Input: \"yes, proceed\" \u2192 {\"isDecisionResponse\": true, \"decisionValue\": \"YES\", \"confidence\": 0.95}\r\n- Input: \"no\" \u2192 {\"isDecisionResponse\": true, \"decisionValue\": \"NO\", \"confidence\": 0.95}\r\n- Input: \"I want a movie\" \u2192 {\"isDecisionResponse\": false, \"decisionValue\": null, \"confidence\": 0.9}\r\n- Input: \"cancel\" \u2192 {\"isDecisionResponse\": true, \"decisionValue\": \"NO\", \"confidence\": 0.9}\r\n\r\nCRITICAL: If the input is clearly a new service request (like \"I want a movie\", \"book tickets\", etc.), return isDecisionResponse: false.\r\nOnly return isDecisionResponse: true if the input is clearly responding to the decision prompt.`;\r\n\r\n  if (ENABLE_OPENAI) {\r\n    return determineDecisionResponseWithOpenAI(userInput, prompt);\r\n  } else {\r\n    return determineDecisionResponseWithDeepSeek(userInput, prompt);\r\n  }\r\n}\r\n\r\nasync function determineDecisionResponseWithOpenAI(\r\n  userInput: string,\r\n  prompt: string\r\n): Promise<{\r\n  isDecisionResponse: boolean;\r\n  decisionValue: string | null;\r\n  confidence: number;\r\n}> {\r\n  if (!process.env.OPENAI_API_KEY) {\r\n    throw new Error(\"OpenAI API key is required\");\r\n  }\r\n\r\n  const messages = [\r\n    { role: \"system\", content: prompt },\r\n    { role: \"user\", content: userInput }\r\n  ];\r\n\r\n  const requestBody = {\r\n    model: \"gpt-4o-mini\",\r\n    messages,\r\n    response_format: { type: \"json_object\" },\r\n    temperature: 0.3\r\n  };\r\n\r\n  const requestBodyJson = JSON.stringify(requestBody);\r\n  const requestBodyBuffer = Buffer.from(requestBodyJson, 'utf-8');\r\n\r\n  return new Promise((resolve, reject) => {\r\n    const req = https.request(\r\n      {\r\n        hostname: \"api.openai.com\",\r\n        port: 443,\r\n        path: \"/v1/chat/completions\",\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          \"Authorization\": `Bearer ${process.env.OPENAI_API_KEY}`,\r\n          \"Content-Length\": requestBodyBuffer.length.toString()\r\n        }\r\n      },\r\n      (res) => {\r\n        let data = \"\";\r\n        res.on(\"data\", (c) => (data += c));\r\n        res.on(\"end\", () => {\r\n          try {\r\n            const parsed = JSON.parse(data);\r\n            if (parsed.error) {\r\n              reject(new Error(`OpenAI API error: ${parsed.error.message || JSON.stringify(parsed.error)}`));\r\n              return;\r\n            }\r\n            if (parsed.choices?.[0]?.message?.content) {\r\n              const content = JSON.parse(parsed.choices[0].message.content);\r\n              resolve({\r\n                isDecisionResponse: content.isDecisionResponse === true,\r\n                decisionValue: content.decisionValue || null,\r\n                confidence: content.confidence || 0.5\r\n              });\r\n            } else {\r\n              reject(new Error(\"Invalid OpenAI response format\"));\r\n            }\r\n          } catch (err: any) {\r\n            reject(new Error(`Failed to parse OpenAI response: ${err.message}`));\r\n          }\r\n        });\r\n      }\r\n    );\r\n\r\n    req.on(\"error\", (err) => {\r\n      reject(new Error(`OpenAI request failed: ${err.message}`));\r\n    });\r\n\r\n    req.write(requestBodyBuffer);\r\n    req.end();\r\n  });\r\n}\r\n\r\nasync function determineDecisionResponseWithDeepSeek(\r\n  userInput: string,\r\n  prompt: string\r\n): Promise<{\r\n  isDecisionResponse: boolean;\r\n  decisionValue: string | null;\r\n  confidence: number;\r\n}> {\r\n  if (!process.env.DEEPSEEK_API_KEY) {\r\n    throw new Error(\"DeepSeek API key is required\");\r\n  }\r\n\r\n  const messages = [\r\n    { role: \"system\", content: prompt },\r\n    { role: \"user\", content: userInput }\r\n  ];\r\n\r\n  const requestBody = {\r\n    model: \"deepseek-chat\",\r\n    messages,\r\n    response_format: { type: \"json_object\" },\r\n    temperature: 0.3\r\n  };\r\n\r\n  return new Promise((resolve, reject) => {\r\n    const req = https.request(\r\n      {\r\n        hostname: \"api.deepseek.com\",\r\n        port: 443,\r\n        path: \"/v1/chat/completions\",\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          \"Authorization\": `Bearer ${process.env.DEEPSEEK_API_KEY}`\r\n        }\r\n      },\r\n      (res) => {\r\n        let data = \"\";\r\n        res.on(\"data\", (c) => (data += c));\r\n        res.on(\"end\", () => {\r\n          try {\r\n            const parsed = JSON.parse(data);\r\n            if (parsed.error) {\r\n              reject(new Error(`DeepSeek API error: ${parsed.error.message || JSON.stringify(parsed.error)}`));\r\n              return;\r\n            }\r\n            if (parsed.choices?.[0]?.message?.content) {\r\n              const content = JSON.parse(parsed.choices[0].message.content);\r\n              resolve({\r\n                isDecisionResponse: content.isDecisionResponse === true,\r\n                decisionValue: content.decisionValue || null,\r\n                confidence: content.confidence || 0.5\r\n              });\r\n            } else {\r\n              reject(new Error(\"Invalid DeepSeek response format\"));\r\n            }\r\n          } catch (err: any) {\r\n            reject(new Error(`Failed to parse DeepSeek response: ${err.message}`));\r\n          }\r\n        });\r\n      }\r\n    );\r\n\r\n    req.on(\"error\", (err) => {\r\n      reject(new Error(`DeepSeek request failed: ${err.message}`));\r\n    });\r\n\r\n    req.write(JSON.stringify(requestBody));\r\n    req.end();\r\n  });\r\n}"],
  "mappings": "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",
  "names": ["hasQuestionPattern", "queryLower", "isEdenRelated", "ENABLE_OPENAI", "MOCKED_LLM"]
}
