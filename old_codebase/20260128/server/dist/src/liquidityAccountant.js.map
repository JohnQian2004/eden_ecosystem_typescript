{
  "version": 3,
  "sources": ["../../src/liquidityAccountant.ts"],
  "sourcesContent": ["/**\r\n * Token Liquidity Accountant Service\r\n * Tracks liquidity for each DEX token pool (tokenA, tokenB, etc.)\r\n * Part of Holy Ghost infrastructure - tracks baseToken liquidity for each token\r\n */\r\n\r\nimport * as fs from \"fs\";\r\nimport * as path from \"path\";\r\nimport type { TokenPool } from \"./types\";\r\n\r\n// Liquidity tracking interface\r\nexport interface TokenLiquidityRecord {\r\n  tokenSymbol: string;\r\n  baseToken: string;\r\n  poolId: string;\r\n  gardenId: string;\r\n  initialLiquidity: number; // Initial liquidity loaded via Stripe Payment Rail\r\n  currentLiquidity: number; // Current liquidity (updated as trades happen)\r\n  baseReserve: number; // Current base token reserve\r\n  tokenReserve: number; // Current token reserve\r\n  totalVolume: number; // Total trading volume\r\n  totalTrades: number; // Total number of trades\r\n  stripePaymentIntentId?: string; // Stripe payment intent for initial liquidity\r\n  liquidityLoadedAt?: number; // Timestamp when liquidity was loaded\r\n  lastUpdated: number;\r\n  createdAt: number;\r\n}\r\n\r\n// Global liquidity state\r\ninterface LiquidityAccountantState {\r\n  tokens: Map<string, TokenLiquidityRecord>; // Key: poolId\r\n  lastUpdated: number;\r\n  createdAt: number;\r\n}\r\n\r\nlet LIQUIDITY_STATE: LiquidityAccountantState = {\r\n  tokens: new Map(),\r\n  lastUpdated: Date.now(),\r\n  createdAt: Date.now()\r\n};\r\n\r\n// Persistence file path\r\nconst LIQUIDITY_PERSISTENCE_FILE = path.join(__dirname, '..', 'eden-liquidity-persistence.json');\r\n\r\n/**\r\n * Initialize Liquidity Accountant Service\r\n */\r\nexport function initializeLiquidityAccountant(): void {\r\n  loadLiquidityState();\r\n  console.log(`\uD83D\uDCA7 [LiquidityAccountant] Initialized. Tracking ${LIQUIDITY_STATE.tokens.size} token pool(s)`);\r\n}\r\n\r\n/**\r\n * Load liquidity state from persistence file\r\n */\r\nfunction loadLiquidityState(): void {\r\n  try {\r\n    if (fs.existsSync(LIQUIDITY_PERSISTENCE_FILE)) {\r\n      const fileContent = fs.readFileSync(LIQUIDITY_PERSISTENCE_FILE, 'utf-8');\r\n      const persisted = JSON.parse(fileContent);\r\n      \r\n      // Restore tokens map\r\n      LIQUIDITY_STATE.tokens = new Map();\r\n      if (persisted.tokens && Array.isArray(persisted.tokens)) {\r\n        for (const token of persisted.tokens) {\r\n          LIQUIDITY_STATE.tokens.set(token.poolId, token);\r\n        }\r\n      }\r\n      \r\n      LIQUIDITY_STATE.lastUpdated = persisted.lastUpdated || Date.now();\r\n      LIQUIDITY_STATE.createdAt = persisted.createdAt || Date.now();\r\n      \r\n      console.log(`\uD83D\uDCA7 [LiquidityAccountant] Loaded ${LIQUIDITY_STATE.tokens.size} token liquidity record(s) from persistence`);\r\n    }\r\n  } catch (err: any) {\r\n    console.warn(`\u26A0\uFE0F  [LiquidityAccountant] Failed to load state: ${err.message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Save liquidity state to persistence file\r\n */\r\nexport function saveLiquidityState(): void {\r\n  try {\r\n    LIQUIDITY_STATE.lastUpdated = Date.now();\r\n    \r\n    const data = {\r\n      tokens: Array.from(LIQUIDITY_STATE.tokens.values()),\r\n      lastUpdated: LIQUIDITY_STATE.lastUpdated,\r\n      createdAt: LIQUIDITY_STATE.createdAt,\r\n      lastSaved: new Date().toISOString()\r\n    };\r\n    \r\n    fs.writeFileSync(LIQUIDITY_PERSISTENCE_FILE, JSON.stringify(data, null, 2), 'utf-8');\r\n    console.log(`\uD83D\uDCBE [LiquidityAccountant] State saved to persistence`);\r\n  } catch (err: any) {\r\n    console.error(`\u274C [LiquidityAccountant] Failed to save state: ${err.message}`);\r\n  }\r\n}\r\n\r\n/**\r\n * Register initial liquidity for a token pool\r\n * Called when a DEX garden is created with Stripe Payment Rail liquidity\r\n */\r\nexport function registerInitialLiquidity(\r\n  poolId: string,\r\n  tokenSymbol: string,\r\n  baseToken: string,\r\n  gardenId: string,\r\n  initialLiquidity: number,\r\n  baseReserve: number,\r\n  tokenReserve: number,\r\n  stripePaymentIntentId?: string\r\n): void {\r\n  const existing = LIQUIDITY_STATE.tokens.get(poolId);\r\n  \r\n  if (existing) {\r\n    // Update existing record\r\n    existing.currentLiquidity = initialLiquidity;\r\n    existing.baseReserve = baseReserve;\r\n    existing.tokenReserve = tokenReserve;\r\n    existing.lastUpdated = Date.now();\r\n    if (stripePaymentIntentId) {\r\n      existing.stripePaymentIntentId = stripePaymentIntentId;\r\n    }\r\n    console.log(`\uD83D\uDCA7 [LiquidityAccountant] Updated liquidity for ${tokenSymbol}/${baseToken} (${poolId}): ${initialLiquidity} ${baseToken}`);\r\n  } else {\r\n    // Create new record\r\n    const record: TokenLiquidityRecord = {\r\n      tokenSymbol,\r\n      baseToken,\r\n      poolId,\r\n      gardenId,\r\n      initialLiquidity,\r\n      currentLiquidity: initialLiquidity,\r\n      baseReserve,\r\n      tokenReserve,\r\n      totalVolume: 0,\r\n      totalTrades: 0,\r\n      stripePaymentIntentId,\r\n      liquidityLoadedAt: Date.now(),\r\n      lastUpdated: Date.now(),\r\n      createdAt: Date.now()\r\n    };\r\n    \r\n    LIQUIDITY_STATE.tokens.set(poolId, record);\r\n    console.log(`\uD83D\uDCA7 [LiquidityAccountant] Registered initial liquidity for ${tokenSymbol}/${baseToken} (${poolId}): ${initialLiquidity} ${baseToken}`);\r\n  }\r\n  \r\n  saveLiquidityState();\r\n}\r\n\r\n/**\r\n * Update liquidity after a trade\r\n * Called when a DEX trade is executed\r\n */\r\nexport function updateLiquidityAfterTrade(\r\n  poolId: string,\r\n  baseReserve: number,\r\n  tokenReserve: number,\r\n  tradeVolume: number\r\n): void {\r\n  const record = LIQUIDITY_STATE.tokens.get(poolId);\r\n  \r\n  if (!record) {\r\n    console.warn(`\u26A0\uFE0F  [LiquidityAccountant] No liquidity record found for pool ${poolId}, cannot update`);\r\n    return;\r\n  }\r\n  \r\n  // Update reserves and liquidity\r\n  record.baseReserve = baseReserve;\r\n  record.tokenReserve = tokenReserve;\r\n  record.currentLiquidity = baseReserve; // Current liquidity = base reserve\r\n  record.totalVolume += tradeVolume;\r\n  record.totalTrades += 1;\r\n  record.lastUpdated = Date.now();\r\n  \r\n  console.log(`\uD83D\uDCA7 [LiquidityAccountant] Updated liquidity for ${record.tokenSymbol}/${record.baseToken} (${poolId}): ${baseReserve} ${record.baseToken} (${record.totalTrades} trades, ${record.totalVolume.toFixed(2)} volume)`);\r\n  \r\n  saveLiquidityState();\r\n}\r\n\r\n/**\r\n * Get liquidity record for a pool\r\n */\r\nexport function getLiquidityRecord(poolId: string): TokenLiquidityRecord | undefined {\r\n  return LIQUIDITY_STATE.tokens.get(poolId);\r\n}\r\n\r\n/**\r\n * Get all liquidity records\r\n */\r\nexport function getAllLiquidityRecords(): TokenLiquidityRecord[] {\r\n  return Array.from(LIQUIDITY_STATE.tokens.values());\r\n}\r\n\r\n/**\r\n * Get liquidity records for a specific garden\r\n */\r\nexport function getLiquidityRecordsByGarden(gardenId: string): TokenLiquidityRecord[] {\r\n  return Array.from(LIQUIDITY_STATE.tokens.values()).filter(r => r.gardenId === gardenId);\r\n}\r\n\r\n/**\r\n * Get liquidity records for a specific token symbol\r\n */\r\nexport function getLiquidityRecordsByToken(tokenSymbol: string): TokenLiquidityRecord[] {\r\n  return Array.from(LIQUIDITY_STATE.tokens.values()).filter(r => r.tokenSymbol === tokenSymbol);\r\n}\r\n\r\n/**\r\n * Get liquidity summary\r\n */\r\nexport function getLiquiditySummary(): {\r\n  totalPools: number;\r\n  totalInitialLiquidity: number;\r\n  totalCurrentLiquidity: number;\r\n  totalVolume: number;\r\n  totalTrades: number;\r\n  byGarden: Record<string, {\r\n    pools: number;\r\n    initialLiquidity: number;\r\n    currentLiquidity: number;\r\n    volume: number;\r\n    trades: number;\r\n  }>;\r\n  byToken: Record<string, {\r\n    pools: number;\r\n    initialLiquidity: number;\r\n    currentLiquidity: number;\r\n    volume: number;\r\n    trades: number;\r\n  }>;\r\n} {\r\n  const records = Array.from(LIQUIDITY_STATE.tokens.values());\r\n  \r\n  let totalInitialLiquidity = 0;\r\n  let totalCurrentLiquidity = 0;\r\n  let totalVolume = 0;\r\n  let totalTrades = 0;\r\n  \r\n  const byGarden: Record<string, any> = {};\r\n  const byToken: Record<string, any> = {};\r\n  \r\n  for (const record of records) {\r\n    totalInitialLiquidity += record.initialLiquidity;\r\n    totalCurrentLiquidity += record.currentLiquidity;\r\n    totalVolume += record.totalVolume;\r\n    totalTrades += record.totalTrades;\r\n    \r\n    // Group by garden\r\n    if (!byGarden[record.gardenId]) {\r\n      byGarden[record.gardenId] = {\r\n        pools: 0,\r\n        initialLiquidity: 0,\r\n        currentLiquidity: 0,\r\n        volume: 0,\r\n        trades: 0\r\n      };\r\n    }\r\n    byGarden[record.gardenId].pools++;\r\n    byGarden[record.gardenId].initialLiquidity += record.initialLiquidity;\r\n    byGarden[record.gardenId].currentLiquidity += record.currentLiquidity;\r\n    byGarden[record.gardenId].volume += record.totalVolume;\r\n    byGarden[record.gardenId].trades += record.totalTrades;\r\n    \r\n    // Group by token\r\n    if (!byToken[record.tokenSymbol]) {\r\n      byToken[record.tokenSymbol] = {\r\n        pools: 0,\r\n        initialLiquidity: 0,\r\n        currentLiquidity: 0,\r\n        volume: 0,\r\n        trades: 0\r\n      };\r\n    }\r\n    byToken[record.tokenSymbol].pools++;\r\n    byToken[record.tokenSymbol].initialLiquidity += record.initialLiquidity;\r\n    byToken[record.tokenSymbol].currentLiquidity += record.currentLiquidity;\r\n    byToken[record.tokenSymbol].volume += record.totalVolume;\r\n    byToken[record.tokenSymbol].trades += record.totalTrades;\r\n  }\r\n  \r\n  return {\r\n    totalPools: records.length,\r\n    totalInitialLiquidity,\r\n    totalCurrentLiquidity,\r\n    totalVolume,\r\n    totalTrades,\r\n    byGarden,\r\n    byToken\r\n  };\r\n}\r\n\r\n"],
  "mappings": "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",
  "names": []
}
