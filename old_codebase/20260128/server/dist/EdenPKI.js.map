{
  "version": 3,
  "sources": ["../EdenPKI.ts"],
  "sourcesContent": ["/**\r\n * ============================================================\r\n * ENCERT v1 \u2014 Eden Native Certificate Specification\r\n * ============================================================\r\n *\r\n * Purpose:\r\n * ENCERT is a lightweight, Eden-native PKI providing identity,\r\n * authority, delegation, revocation, and auditability without\r\n * X.509, WebPKI, browsers, or blockchain dependency.\r\n *\r\n * Identity Model:\r\n *   Identity = UUID + Ed25519 Public Key\r\n *\r\n * Certificate Model:\r\n *   Signed capability document issued by ROOT CA or Indexer.\r\n *\r\n * Trust Chain:\r\n *   ROOT CA \u2192 Indexer \u2192 Service Provider\r\n *\r\n * Capabilities:\r\n *   Explicit permissions such as:\r\n *     - INDEXER\r\n *     - ISSUE_CERT\r\n *     - SERVICE_PROVIDER\r\n *     - PRICE_QUOTE\r\n *     - RECEIVE_PAYMENT\r\n *\r\n * Cryptography:\r\n *   Ed25519 signatures over canonical JSON payloads.\r\n *\r\n * Revocation:\r\n *   Event-based signed revocations distributed via Redis Streams.\r\n *\r\n * Design Principles:\r\n *   - Minimalism\r\n *   - Sovereignty\r\n *   - Human readability\r\n *   - Event-driven governance\r\n *   - Short-lived authority\r\n *\r\n * Scope:\r\n *   ENCERT governs authority inside Eden only.\r\n *\r\n * ============================================================\r\n */\r\n\r\nimport crypto from \"crypto\";\r\n\r\nexport type EdenUUID = string;\r\nexport type Timestamp = number;\r\n\r\nexport type Capability =\r\n  | \"INDEXER\"\r\n  | \"ISSUE_CERT\"\r\n  | \"SERVICE_PROVIDER\"\r\n  | \"PRICE_QUOTE\"\r\n  | \"RECEIVE_PAYMENT\";\r\n\r\nexport interface EdenIdentity {\r\n  uuid: EdenUUID;\r\n  publicKey: string;\r\n}\r\n\r\nexport interface EdenCertificate {\r\n  subject: EdenUUID;\r\n  issuer: EdenUUID;\r\n  capabilities: Capability[];\r\n  constraints?: Record<string, any>;\r\n  issuedAt: Timestamp;\r\n  expiresAt: Timestamp;\r\n  signature: string;\r\n}\r\n\r\nexport type RevokedType = \"indexer\" | \"service\" | \"provider\";\r\n\r\nexport interface RevocationEvent {\r\n  revoked_uuid: EdenUUID;\r\n  revoked_type: RevokedType;\r\n  issuer_uuid: EdenUUID;\r\n  reason: string;\r\n  issued_at: Timestamp;\r\n  effective_at: Timestamp;\r\n  signature: string;\r\n  cert_hash?: string;\r\n  severity?: \"soft\" | \"hard\";\r\n  metadata?: Record<string, any>;\r\n}\r\n\r\n// Legacy interface for backward compatibility (deprecated)\r\nexport interface LegacyRevocationEvent {\r\n  revoked: EdenUUID;\r\n  reason: string;\r\n  by: EdenUUID;\r\n  timestamp: Timestamp;\r\n  signature: string;\r\n}\r\n\r\nexport class EdenPKI {\r\n  readonly identity: EdenIdentity;\r\n  private readonly privateKey: crypto.KeyObject;\r\n\r\n  constructor(uuid: EdenUUID) {\r\n    const { publicKey, privateKey } = crypto.generateKeyPairSync(\"ed25519\");\r\n    this.privateKey = privateKey;\r\n    this.identity = {\r\n      uuid,\r\n      publicKey: publicKey.export({ type: \"spki\", format: \"pem\" }).toString(),\r\n    };\r\n  }\r\n\r\n  private sign(data: any): string {\r\n    const payload = Buffer.from(JSON.stringify(data));\r\n    return crypto.sign(null, payload, this.privateKey).toString(\"base64\");\r\n  }\r\n\r\n  static verify(\r\n    data: any,\r\n    signature: string,\r\n    publicKeyPem: string\r\n  ): boolean {\r\n    const payload = Buffer.from(JSON.stringify(data));\r\n    const publicKey = crypto.createPublicKey(publicKeyPem);\r\n    return crypto.verify(null, payload, publicKey, Buffer.from(signature, \"base64\"));\r\n  }\r\n\r\n  issueCertificate(params: {\r\n    subject: EdenUUID;\r\n    capabilities: Capability[];\r\n    constraints?: Record<string, any>;\r\n    ttlSeconds?: number;\r\n  }): EdenCertificate {\r\n    const now = Date.now();\r\n    const cert: Omit<EdenCertificate, \"signature\"> = {\r\n      subject: params.subject,\r\n      issuer: this.identity.uuid,\r\n      capabilities: params.capabilities,\r\n      constraints: params.constraints,\r\n      issuedAt: now,\r\n      expiresAt: now + (params.ttlSeconds ?? 86400) * 1000,\r\n    };\r\n\r\n    return { ...cert, signature: this.sign(cert) };\r\n  }\r\n\r\n  static validateCertificate(\r\n    cert: EdenCertificate,\r\n    issuerPublicKey: string,\r\n    now: number = Date.now()\r\n  ): boolean {\r\n    if (now > cert.expiresAt) return false;\r\n    const { signature, ...unsigned } = cert;\r\n    return EdenPKI.verify(unsigned, signature, issuerPublicKey);\r\n  }\r\n\r\n  revokeIdentity(\r\n    revoked: EdenUUID,\r\n    revokedType: RevokedType,\r\n    reason: string,\r\n    effectiveAt?: Timestamp,\r\n    certHash?: string,\r\n    severity?: \"soft\" | \"hard\",\r\n    metadata?: Record<string, any>\r\n  ): RevocationEvent {\r\n    const now = Date.now();\r\n    const event: Omit<RevocationEvent, \"signature\"> = {\r\n      revoked_uuid: revoked,\r\n      revoked_type: revokedType,\r\n      issuer_uuid: this.identity.uuid,\r\n      reason,\r\n      issued_at: now,\r\n      effective_at: effectiveAt || now,\r\n      cert_hash: certHash,\r\n      severity: severity || \"hard\",\r\n      metadata,\r\n    };\r\n    return { ...event, signature: this.sign(event) };\r\n  }\r\n\r\n  static validateRevocation(\r\n    event: RevocationEvent,\r\n    issuerPublicKey: string\r\n  ): boolean {\r\n    const { signature, ...unsigned } = event;\r\n    return EdenPKI.verify(unsigned, signature, issuerPublicKey);\r\n  }\r\n\r\n  static validateRevocationLegacy(\r\n    event: LegacyRevocationEvent,\r\n    issuerPublicKey: string\r\n  ): boolean {\r\n    const { signature, ...unsigned } = event;\r\n    return EdenPKI.verify(unsigned, signature, issuerPublicKey);\r\n  }\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AA8CA,oBAAmB;AAmDZ,MAAM,QAAQ;AAAA,EAInB,YAAY,MAAgB;AAC1B,UAAM,EAAE,WAAW,WAAW,IAAI,cAAAA,QAAO,oBAAoB,SAAS;AACtE,SAAK,aAAa;AAClB,SAAK,WAAW;AAAA,MACd;AAAA,MACA,WAAW,UAAU,OAAO,EAAE,MAAM,QAAQ,QAAQ,MAAM,CAAC,EAAE,SAAS;AAAA,IACxE;AAAA,EACF;AAAA,EAEQ,KAAK,MAAmB;AAC9B,UAAM,UAAU,OAAO,KAAK,KAAK,UAAU,IAAI,CAAC;AAChD,WAAO,cAAAA,QAAO,KAAK,MAAM,SAAS,KAAK,UAAU,EAAE,SAAS,QAAQ;AAAA,EACtE;AAAA,EAEA,OAAO,OACL,MACA,WACA,cACS;AACT,UAAM,UAAU,OAAO,KAAK,KAAK,UAAU,IAAI,CAAC;AAChD,UAAM,YAAY,cAAAA,QAAO,gBAAgB,YAAY;AACrD,WAAO,cAAAA,QAAO,OAAO,MAAM,SAAS,WAAW,OAAO,KAAK,WAAW,QAAQ,CAAC;AAAA,EACjF;AAAA,EAEA,iBAAiB,QAKG;AAClB,UAAM,MAAM,KAAK,IAAI;AACrB,UAAM,OAA2C;AAAA,MAC/C,SAAS,OAAO;AAAA,MAChB,QAAQ,KAAK,SAAS;AAAA,MACtB,cAAc,OAAO;AAAA,MACrB,aAAa,OAAO;AAAA,MACpB,UAAU;AAAA,MACV,WAAW,OAAO,OAAO,cAAc,SAAS;AAAA,IAClD;AAEA,WAAO,EAAE,GAAG,MAAM,WAAW,KAAK,KAAK,IAAI,EAAE;AAAA,EAC/C;AAAA,EAEA,OAAO,oBACL,MACA,iBACA,MAAc,KAAK,IAAI,GACd;AACT,QAAI,MAAM,KAAK;AAAW,aAAO;AACjC,UAAM,EAAE,WAAW,GAAG,SAAS,IAAI;AACnC,WAAO,QAAQ,OAAO,UAAU,WAAW,eAAe;AAAA,EAC5D;AAAA,EAEA,eACE,SACA,aACA,QACA,aACA,UACA,UACA,UACiB;AACjB,UAAM,MAAM,KAAK,IAAI;AACrB,UAAM,QAA4C;AAAA,MAChD,cAAc;AAAA,MACd,cAAc;AAAA,MACd,aAAa,KAAK,SAAS;AAAA,MAC3B;AAAA,MACA,WAAW;AAAA,MACX,cAAc,eAAe;AAAA,MAC7B,WAAW;AAAA,MACX,UAAU,YAAY;AAAA,MACtB;AAAA,IACF;AACA,WAAO,EAAE,GAAG,OAAO,WAAW,KAAK,KAAK,KAAK,EAAE;AAAA,EACjD;AAAA,EAEA,OAAO,mBACL,OACA,iBACS;AACT,UAAM,EAAE,WAAW,GAAG,SAAS,IAAI;AACnC,WAAO,QAAQ,OAAO,UAAU,WAAW,eAAe;AAAA,EAC5D;AAAA,EAEA,OAAO,yBACL,OACA,iBACS;AACT,UAAM,EAAE,WAAW,GAAG,SAAS,IAAI;AACnC,WAAO,QAAQ,OAAO,UAAU,WAAW,eAAe;AAAA,EAC5D;AACF;",
  "names": ["crypto"]
}
