<div class="eden-history-container">
  <!-- Header -->
  <div class="history-header">
    <h2>üìú History & Autobiography</h2>
    <div class="view-mode-selector">
      <button 
        [class.active]="viewMode === 'timeline'"
        (click)="viewMode = 'timeline'; goBack()">
        Timeline
      </button>
      <button 
        [class.active]="viewMode === 'biography'"
        (click)="viewMode = 'biography'; goBack()">
        Biography
      </button>
      <button 
        [class.active]="viewMode === 'autobiography'"
        (click)="viewMode = 'autobiography'; goBack()">
        Autobiography
      </button>
      <button 
        [class.active]="viewMode === 'whatif'"
        (click)="viewMode = 'whatif'; goBack()">
        What If?
      </button>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="search-bar">
    <input 
      type="text" 
      [(ngModel)]="searchQuery"
      (keyup.enter)="search()"
      placeholder="Search historical events, figures, or periods...">
    <button (click)="search()">üîç Search</button>
  </div>

  <!-- Search Results (shown when there are results, hides other views) -->
  <div *ngIf="searchResults.length > 0" class="search-results">
    <h3>Search Results ({{ searchResults.length }})</h3>
    <div class="result-item" *ngFor="let result of searchResults">
      <h4>{{ getResultTitle(result) }}</h4>
      <p>{{ getResultDescription(result) }}</p>
      <button 
        *ngIf="isFigure(result)" 
        class="btn btn-sm mt-2"
        (click)="selectFigure(result)">
        View Biography
      </button>
    </div>
  </div>

  <!-- Timeline View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'timeline' && !selectedPeriod" class="timeline-view">
    <h3>Historical Periods</h3>
    <div *ngIf="isLoadingPeriods" class="loading">Loading periods...</div>
    <div class="periods-grid">
      <div 
        *ngFor="let period of periods" 
        class="period-card"
        (click)="selectPeriod(period)">
        <h4>{{ period.name }}</h4>
        <p class="period-dates">{{ period.startYear }} - {{ period.endYear }}</p>
        <p class="period-description">{{ period.description }}</p>
        <div class="event-count">
          <span *ngIf="period.globalEvents && period.globalEvents.length > 0">
            {{ period.globalEvents.length }} events
          </span>
          <span *ngIf="!period.globalEvents || period.globalEvents.length === 0" class="generating-text">
            Click to generate events
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Period Detail View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'timeline' && selectedPeriod && !selectedEvent" class="period-detail">
    <button class="back-btn" (click)="goBack()">‚Üê Back</button>
    <h2>{{ selectedPeriod.name }}</h2>
    <p class="period-meta">{{ selectedPeriod.startYear }} - {{ selectedPeriod.endYear }}</p>
    <p class="period-description">{{ selectedPeriod.description }}</p>
    
    <h3>Global Events</h3>
    <div *ngIf="!selectedPeriod.globalEvents || selectedPeriod.globalEvents.length === 0" class="loading">
      <p>Generating historical events for this period using AI... This may take a moment.</p>
      <div class="spinner-border spinner-border-sm" role="status"></div>
    </div>
    <div *ngIf="selectedPeriod.globalEvents && selectedPeriod.globalEvents.length > 0" class="events-list">
      <div 
        *ngFor="let event of selectedPeriod.globalEvents" 
        class="event-card clickable"
        (click)="selectEvent(event)">
        <h4>{{ event.title }}</h4>
        <p class="event-date">{{ event.date }}</p>
        <p class="event-location">üìç {{ event.location }}</p>
        <p class="event-description-preview">{{ event.description }}</p>
        <div class="event-preview-footer">
          <span class="click-hint">Click to view details ‚Üí</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Event Detail View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'timeline' && selectedPeriod && selectedEvent" class="event-detail">
    <button class="back-btn" (click)="goBack()">‚Üê Back to {{ selectedPeriod.name }}</button>
    <h2>{{ selectedEvent.title }}</h2>
    <div class="event-meta">
      <p class="event-date">üìÖ {{ selectedEvent.date }}</p>
      <p class="event-location">üìç {{ selectedEvent.location }}</p>
    </div>
    <div class="event-description">
      <p [innerHTML]="formatText(selectedEvent.description)"></p>
    </div>
    <div *ngIf="selectedEvent.perspectives && selectedEvent.perspectives.length > 0" class="perspectives-section">
      <h4>Historical Perspectives</h4>
      <ul class="perspectives-list">
        <li *ngFor="let perspective of selectedEvent.perspectives">{{ perspective }}</li>
      </ul>
    </div>
    <div *ngIf="selectedEvent.relatedFigures && selectedEvent.relatedFigures.length > 0" class="related-figures-section">
      <h4>Related Historical Figures</h4>
      <div class="figures-tags">
        <span 
          *ngFor="let figure of selectedEvent.relatedFigures" 
          class="figure-tag clickable"
          (click)="selectFigureByName(figure)"
          [title]="'Click to view ' + figure + '\'s biography'">
          {{ figure }}
        </span>
      </div>
    </div>
  </div>

  <!-- Biography View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'biography' && !selectedFigure" class="biography-view">
    <h3>Historical Figures</h3>
    <div *ngIf="isLoadingFigures" class="loading">Loading figures...</div>
    <div *ngIf="!isLoadingFigures && figures.length === 0" class="empty-state">
      <p>No figures available. Please try refreshing.</p>
    </div>
    <div *ngIf="!isLoadingFigures && figures.length > 0" class="figures-grid">
      <div 
        *ngFor="let figure of figures" 
        class="figure-card"
        (click)="selectFigure(figure)">
        <h4>{{ figure.name }}</h4>
        <p class="figure-dates" *ngIf="figure.birthYear">
          {{ figure.birthYear }} - {{ figure.deathYear || 'Present' }}
        </p>
        <p class="figure-occupation">{{ figure.occupation }}</p>
        <p class="figure-nationality">{{ figure.nationality }}</p>
        <button class="conversation-btn" (click)="startConversation(figure); $event.stopPropagation()">
          üí¨ Start Conversation
        </button>
      </div>
    </div>
  </div>

  <!-- Figure Detail View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'biography' && selectedFigure" class="figure-detail">
    <button class="back-btn" (click)="goBack()">‚Üê Back</button>
    <h2>{{ selectedFigure.name }}</h2>
    <p class="figure-meta">
      {{ selectedFigure.birthYear }} - {{ selectedFigure.deathYear || 'Present' }} | 
      {{ selectedFigure.nationality }} | {{ selectedFigure.occupation }}
    </p>
    <div class="biography-content" [innerHTML]="formatText(selectedFigure.biography)"></div>
    
    <button class="conversation-btn" (click)="startConversation(selectedFigure)">
      üí¨ Start Autobiography Conversation
    </button>
  </div>

  <!-- Autobiography/Conversation View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'autobiography' && selectedFigure" class="autobiography-view">
    <button class="back-btn" (click)="goBack()">‚Üê Back</button>
    <div class="figure-header">
      <h2>Conversation with {{ selectedFigure.name }}</h2>
      <p class="figure-meta">{{ selectedFigure.occupation }} | {{ selectedFigure.nationality }}</p>
    </div>

    <div class="conversation-container">
      <div class="conversation-messages">
        <div 
          *ngFor="let message of conversationHistory" 
          [class.user-message]="message.role === 'user'"
          [class.figure-message]="message.role === 'figure'"
          class="message">
          <div class="message-role" *ngIf="message.role === 'figure'">
            <strong>{{ selectedFigure.name }}:</strong>
          </div>
          <div class="message-content" [innerHTML]="formatText(message.content)"></div>
        </div>
        <div *ngIf="isGeneratingResponse" class="message figure-message">
          <div class="message-role"><strong>{{ selectedFigure.name }}:</strong></div>
          <div class="message-content">Thinking...</div>
        </div>
      </div>

      <div class="conversation-input">
        <input 
          type="text" 
          [(ngModel)]="currentQuestion"
          (keyup.enter)="askQuestion()"
          placeholder="Ask a question to {{ selectedFigure.name }}...">
        <button 
          (click)="askQuestion()" 
          [disabled]="isGeneratingResponse || !currentQuestion.trim()">
          Send
        </button>
      </div>
    </div>
  </div>

  <!-- What-If Scenario View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'whatif'" class="whatif-view">
    <h3>Historical What-If Scenarios</h3>
    <p class="whatif-description">
      Explore alternative historical outcomes by asking "what if" questions. 
      The AI will analyze historical context and generate plausible scenarios.
    </p>
    
    <div class="whatif-input">
      <textarea 
        [(ngModel)]="whatIfScenario"
        placeholder="Example: What if Zhuge Liang's Northern Expeditions had succeeded? How might that have altered the subsequent history of Central Asia?"></textarea>
      <button 
        (click)="generateWhatIf()" 
        [disabled]="isGeneratingWhatIf || !whatIfScenario.trim()">
        {{ isGeneratingWhatIf ? 'Generating...' : 'Generate Scenario' }}
      </button>
    </div>

    <div *ngIf="whatIfResult" class="whatif-result">
      <h4>Scenario Analysis:</h4>
      <div class="result-content" [innerHTML]="formatText(whatIfResult)"></div>
    </div>
  </div>
</div>

