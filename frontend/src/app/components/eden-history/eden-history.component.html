<div class="eden-history-container">
  <!-- Header -->
  <div class="history-header">
    <h2>ğŸ“œ History & Autobiography</h2>
    <div class="view-mode-selector">
      <button 
        [class.active]="viewMode === 'timeline'"
        (click)="viewMode = 'timeline'; goBack()">
        Timeline
      </button>
      <button 
        [class.active]="viewMode === 'biography'"
        (click)="viewMode = 'biography'; goBack()">
        Biography
      </button>
      <button 
        [class.active]="viewMode === 'autobiography'"
        (click)="viewMode = 'autobiography'; goBack()">
        Autobiography
      </button>
      <button 
        [class.active]="viewMode === 'whatif'"
        (click)="viewMode = 'whatif'; goBack()">
        What If?
      </button>
      <button 
        [class.active]="viewMode === 'map'"
        (click)="switchToMapView()">
        ğŸ—ºï¸ Map
      </button>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="search-bar">
    <input 
      type="text" 
      [(ngModel)]="searchQuery"
      (keyup.enter)="search()"
      placeholder="Search historical events, figures, or periods...">
    <button (click)="search()">ğŸ” Search</button>
  </div>

  <!-- Search Results (shown when there are results, hides other views) -->
  <div *ngIf="searchResults.length > 0" class="search-results">
    <h3>Search Results ({{ searchResults.length }})</h3>
    <div class="result-item" *ngFor="let result of searchResults">
      <h4>{{ getResultTitle(result) }}</h4>
      <p>{{ getResultDescription(result) }}</p>
      <button 
        *ngIf="isFigure(result)" 
        class="btn btn-sm mt-2"
        (click)="selectFigure(result)">
        View Biography
      </button>
    </div>
  </div>

  <!-- Timeline View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'timeline' && !selectedPeriod" class="timeline-view">
    <h3>Historical Periods</h3>
    <div *ngIf="isLoadingPeriods" class="loading">Loading periods...</div>
    <div class="periods-grid">
      <div 
        *ngFor="let period of periods" 
        class="period-card"
        (click)="selectPeriod(period)">
        <h4>{{ period.name }}</h4>
        <p class="period-dates">{{ period.startYear }} - {{ period.endYear }}</p>
        <p class="period-description">{{ period.description }}</p>
        <div class="event-count">
          <span *ngIf="period.globalEvents && period.globalEvents.length > 0">
            {{ period.globalEvents.length }} events
          </span>
          <span *ngIf="!period.globalEvents || period.globalEvents.length === 0" class="generating-text">
            Click to generate events
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Period Detail View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'timeline' && selectedPeriod && !selectedEvent" class="period-detail">
    <button class="back-btn" (click)="goBack()">â† Back</button>
    <h2>{{ selectedPeriod.name }}</h2>
    <p class="period-meta">{{ selectedPeriod.startYear }} - {{ selectedPeriod.endYear }}</p>
    <p class="period-description">{{ selectedPeriod.description }}</p>
    
    <h3>Global Events</h3>
    <div *ngIf="!selectedPeriod.globalEvents || selectedPeriod.globalEvents.length === 0" class="loading">
      <p>Generating historical events for this period using AI... This may take a moment.</p>
      <div class="spinner-border spinner-border-sm" role="status"></div>
    </div>
    <div *ngIf="selectedPeriod.globalEvents && selectedPeriod.globalEvents.length > 0" class="events-list">
      <div 
        *ngFor="let event of selectedPeriod.globalEvents" 
        class="event-card clickable"
        (click)="selectEvent(event)">
        <h4>{{ event.title }}</h4>
        <p class="event-date">{{ event.date }}</p>
        <p class="event-location">ğŸ“ {{ event.location }}</p>
        <p class="event-description-preview">{{ event.description }}</p>
        <div class="event-preview-footer">
          <span class="click-hint">Click to view details â†’</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Event Detail View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'timeline' && selectedPeriod && selectedEvent" class="event-detail">
    <button class="back-btn" (click)="goBack()">â† Back to {{ selectedPeriod.name }}</button>
    <h2>{{ selectedEvent.title }}</h2>
    <div class="event-meta">
      <p class="event-date">ğŸ“… {{ selectedEvent.date }}</p>
      <p class="event-location">ğŸ“ {{ selectedEvent.location }}</p>
    </div>
    <div class="event-description">
      <p [innerHTML]="formatText(selectedEvent.description)"></p>
    </div>
    <div *ngIf="selectedEvent.perspectives && selectedEvent.perspectives.length > 0" class="perspectives-section">
      <h4>Historical Perspectives</h4>
      <ul class="perspectives-list">
        <li *ngFor="let perspective of selectedEvent.perspectives">{{ perspective }}</li>
      </ul>
    </div>
    <div *ngIf="selectedEvent.relatedFigures && selectedEvent.relatedFigures.length > 0" class="related-figures-section">
      <h4>Related Historical Figures</h4>
      <div class="figures-tags">
        <span 
          *ngFor="let figure of selectedEvent.relatedFigures" 
          class="figure-tag clickable"
          (click)="selectFigureByName(figure)"
          [title]="'Click to view ' + figure + '\'s biography'">
          {{ figure }}
        </span>
      </div>
    </div>
  </div>

  <!-- Biography View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'biography' && !selectedFigure" class="biography-view">
    <h3>Historical Figures</h3>
    <div *ngIf="isLoadingFigures" class="loading">Loading figures...</div>
    <div *ngIf="!isLoadingFigures && figures.length === 0" class="empty-state">
      <p>No figures available. Please try refreshing.</p>
    </div>
    <div *ngIf="!isLoadingFigures && figures.length > 0" class="figures-grid">
      <div 
        *ngFor="let figure of figures" 
        class="figure-card"
        (click)="selectFigure(figure)">
        <h4>{{ figure.name }}</h4>
        <p class="figure-dates" *ngIf="figure.birthYear">
          {{ figure.birthYear }} - {{ figure.deathYear || 'Present' }}
        </p>
        <p class="figure-occupation">{{ figure.occupation }}</p>
        <p class="figure-nationality">{{ figure.nationality }}</p>
        <button class="conversation-btn" (click)="startConversation(figure); $event.stopPropagation()">
          ğŸ’¬ Start Conversation
        </button>
      </div>
    </div>
  </div>

  <!-- Figure Detail View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'biography' && selectedFigure" class="figure-detail">
    <button class="back-btn" (click)="goBack()">â† Back</button>
    <h2>{{ selectedFigure.name }}</h2>
    <p class="figure-meta">
      {{ selectedFigure.birthYear }} - {{ selectedFigure.deathYear || 'Present' }} | 
      {{ selectedFigure.nationality }} | {{ selectedFigure.occupation }}
    </p>
    <div class="biography-content" [innerHTML]="formatText(selectedFigure.biography)"></div>
    
    <button class="conversation-btn" (click)="startConversation(selectedFigure)">
      ğŸ’¬ Start Autobiography Conversation
    </button>
  </div>

  <!-- Autobiography/Conversation View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'autobiography' && selectedFigure" class="autobiography-view">
    <button class="back-btn" (click)="goBack()">â† Back</button>
    <div class="figure-header">
      <h2>Conversation with {{ selectedFigure.name }}</h2>
      <p class="figure-meta">{{ selectedFigure.occupation }} | {{ selectedFigure.nationality }}</p>
    </div>

    <div class="conversation-container">
      <div class="conversation-messages">
        <div 
          *ngFor="let message of conversationHistory" 
          [class.user-message]="message.role === 'user'"
          [class.figure-message]="message.role === 'figure'"
          class="message">
          <div class="message-role" *ngIf="message.role === 'figure'">
            <strong>{{ selectedFigure.name }}:</strong>
          </div>
          <div class="message-content" [innerHTML]="formatText(message.content)"></div>
        </div>
        <div *ngIf="isGeneratingResponse" class="message figure-message">
          <div class="message-role"><strong>{{ selectedFigure.name }}:</strong></div>
          <div class="message-content">Thinking...</div>
        </div>
      </div>

      <div class="conversation-input">
        <input 
          type="text" 
          [(ngModel)]="currentQuestion"
          (keyup.enter)="askQuestion()"
          placeholder="Ask a question to {{ selectedFigure.name }}...">
        <button 
          (click)="askQuestion()" 
          [disabled]="isGeneratingResponse || !currentQuestion.trim()">
          Send
        </button>
      </div>
    </div>
  </div>

  <!-- World Explorer View (replaces map) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'map' && !selectedContinent && !selectedCountry" class="world-explorer-view">
    <!-- Popular Historical Figures/Events Tab -->
    <div class="popular-items-tab">
      <h3>â­ Popular Historical Figures & Events</h3>
      <div *ngIf="isLoadingPopularItems" class="loading">
        <p>Loading popular items...</p>
        <div class="spinner-border spinner-border-sm" role="status"></div>
      </div>
      <div *ngIf="!isLoadingPopularItems && popularItems.length === 0" class="empty-state">
        <p>No popular items available. Please try refreshing.</p>
      </div>
      <div *ngIf="!isLoadingPopularItems && popularItems.length > 0" class="popular-items-grid">
        <div 
          *ngFor="let item of popularItems" 
          class="popular-item-card"
          [class.active]="selectedPopularItem?.id === item.id"
          (click)="selectPopularItem(item)">
          <div class="popular-item-icon">{{ item.type === 'figure' ? 'ğŸ‘¤' : 'ğŸ“…' }}</div>
          <div class="popular-item-name">{{ item.name }}</div>
          <div class="popular-item-year" *ngIf="item.year">
            {{ formatYear(item.year) }}
          </div>
          <div class="popular-item-country" *ngIf="item.country">
            {{ item.country }}
          </div>
        </div>
      </div>
    </div>

    <!-- Continents List -->
    <div class="continents-section">
      <h2>ğŸŒ Explore World History by Continent</h2>
      <div *ngIf="isLoadingContinents" class="loading">
        <p>Loading continents and countries...</p>
        <div class="spinner-border spinner-border-sm" role="status"></div>
      </div>
      <div *ngIf="!isLoadingContinents && continents.length === 0" class="empty-state">
        <p>No continents available. Please try refreshing.</p>
      </div>
      <div *ngIf="!isLoadingContinents && continents.length > 0" class="continents-grid">
        <div 
          *ngFor="let continent of continents" 
          class="continent-card"
          (click)="selectContinent(continent.name)">
          <h3>{{ continent.name }}</h3>
          <p class="continent-count">{{ continent.countries.length }} countries</p>
          <p class="continent-hint">Click to explore â†’</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Countries List View (when continent is selected) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'map' && selectedContinent && !selectedCountry" class="countries-view">
    <button class="back-btn" (click)="goBack()">â† Back to Continents</button>
    <h2>ğŸŒ {{ selectedContinent }}</h2>
    
    <div class="countries-grid">
      <div 
        *ngFor="let country of getCountriesForContinent()" 
        class="country-card"
        (click)="selectCountryFromList(country)">
        <h4>{{ country }}</h4>
        <p class="country-hint">Click to explore history â†’</p>
      </div>
    </div>
  </div>

  <!-- Country History View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'map' && selectedCountry" class="country-history-view">
    <button class="back-btn" (click)="goBack()">â† Back to {{ selectedContinent || 'Continents' }}</button>
    <h2>ğŸŒ History of {{ selectedCountry }}</h2>
    
    <div *ngIf="isLoadingCountryHistory" class="loading">
      <p>Loading history for {{ selectedCountry }}...</p>
      <div class="spinner-border spinner-border-sm" role="status"></div>
    </div>

    <div *ngIf="!isLoadingCountryHistory && countryHistory">
      <!-- Historical Periods -->
      <div *ngIf="countryHistory.periods && countryHistory.periods.length > 0" class="country-section">
        <h3>Historical Periods</h3>
        <div class="periods-grid">
          <div 
            *ngFor="let period of countryHistory.periods" 
            class="period-card"
            (click)="selectPeriod(period)">
            <h4>{{ period.name }}</h4>
            <p class="period-dates">{{ period.startYear }} - {{ period.endYear }}</p>
            <p class="period-description">{{ period.description }}</p>
          </div>
        </div>
      </div>

      <!-- Historical Figures -->
      <div *ngIf="countryHistory.figures && countryHistory.figures.length > 0" class="country-section">
        <h3>Historical Figures</h3>
        <div class="figures-grid">
          <div 
            *ngFor="let figure of countryHistory.figures" 
            class="figure-card"
            (click)="selectFigure(figure)">
            <h4>{{ figure.name }}</h4>
            <p class="figure-dates" *ngIf="figure.birthYear">
              {{ figure.birthYear }} - {{ figure.deathYear || 'Present' }}
            </p>
            <p class="figure-occupation">{{ figure.occupation }}</p>
          </div>
        </div>
      </div>

      <!-- Historical Events -->
      <div *ngIf="countryHistory.events && countryHistory.events.length > 0" class="country-section">
        <h3>Historical Events</h3>
        <div class="events-list">
          <div 
            *ngFor="let event of countryHistory.events" 
            class="event-card clickable"
            (click)="selectEvent(event)">
            <h4>{{ event.title }}</h4>
            <p class="event-date">{{ event.date }}</p>
            <p class="event-location">ğŸ“ {{ event.location }}</p>
            <p class="event-description-preview">{{ event.description }}</p>
          </div>
        </div>
      </div>

      <div *ngIf="(!countryHistory.periods || countryHistory.periods.length === 0) && 
                   (!countryHistory.figures || countryHistory.figures.length === 0) && 
                   (!countryHistory.events || countryHistory.events.length === 0)" 
           class="empty-state">
        <p>No historical data available for {{ selectedCountry }} yet.</p>
      </div>
    </div>
  </div>

  <!-- What-If Scenario View (hidden when search results are shown) -->
  <div *ngIf="searchResults.length === 0 && viewMode === 'whatif'" class="whatif-view">
    <h3>Historical What-If Scenarios</h3>
    <p class="whatif-description">
      Explore alternative historical outcomes by asking "what if" questions. 
      The AI will analyze historical context and generate plausible scenarios.
    </p>
    
    <div class="whatif-input">
      <textarea 
        [(ngModel)]="whatIfScenario"
        placeholder="Example: What if Zhuge Liang's Northern Expeditions had succeeded? How might that have altered the subsequent history of Central Asia?"></textarea>
      <button 
        (click)="generateWhatIf()" 
        [disabled]="isGeneratingWhatIf || !whatIfScenario.trim()">
        {{ isGeneratingWhatIf ? 'Generating...' : 'Generate Scenario' }}
      </button>
    </div>

    <div *ngIf="whatIfResult" class="whatif-result">
      <h4>Scenario Analysis:</h4>
      <div class="result-content" [innerHTML]="formatText(whatIfResult)"></div>
    </div>
  </div>
</div>

