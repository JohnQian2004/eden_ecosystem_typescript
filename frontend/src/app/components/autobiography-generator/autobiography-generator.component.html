<div class="container-fluid p-3">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>ðŸ“– Autobiography Generator</h1>
    <div class="btn-group" role="group">
      <button 
        type="button" 
        class="btn btn-outline-primary"
        [class.active]="activeTab === 'paste'"
        (click)="activeTab = 'paste'">
        Paste Post
      </button>
      <button 
        type="button" 
        class="btn btn-outline-primary"
        [class.active]="activeTab === 'autobiography'"
        (click)="activeTab = 'autobiography'">
        Autobiography
      </button>
      <button 
        type="button" 
        class="btn btn-outline-primary"
        [class.active]="activeTab === 'white_paper'"
        (click)="activeTab = 'white_paper'">
        White Paper
      </button>
    </div>
  </div>

  <!-- Paste Post Tab: copy/paste content â†’ save to Redis (no Reddit) -->
  <div *ngIf="activeTab === 'paste'" class="tab-content">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Paste Post</h5>
      </div>
      <div class="card-body">
        <p class="text-muted small">Paste each post here. It will be saved to Redis and file. No Reddit fetch or posting.</p>
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input type="text" class="form-control" [(ngModel)]="pasteTitle" placeholder="Post title">
        </div>
        <div class="mb-3">
          <label class="form-label">Content</label>
          <div class="NgxEditor__Wrapper border rounded p-2 bg-white">
            <ngx-editor-menu [editor]="pasteEditor"></ngx-editor-menu>
            <ngx-editor
              [editor]="pasteEditor"
              [(ngModel)]="pasteContent"
              [placeholder]="'Paste post content here...'"
              [outputFormat]="'html'">
            </ngx-editor>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Save as</label>
          <select class="form-select" [(ngModel)]="pasteCategory">
            <option value="autobiography">Autobiography</option>
            <option value="white_paper">White Paper</option>
          </select>
        </div>
        <button class="btn btn-primary" (click)="pastePost()" [disabled]="pasting || !pasteTitle.trim() || !hasContent(pasteContent)">
          <span *ngIf="pasting" class="spinner-border spinner-border-sm me-2"></span>
          Save to Redis
        </button>
        <span *ngIf="pasteMessage" class="ms-3" [class.text-success]="pasteSuccess" [class.text-danger]="!pasteSuccess">{{ pasteMessage }}</span>
      </div>
    </div>
  </div>

  <!-- Autobiography Tab -->
  <div *ngIf="activeTab === 'autobiography'" class="tab-content">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Bill Draper Autobiography ({{ autobiographyData.posts.length }} chapters)</h3>
      <button class="btn btn-success" (click)="saveAutobiography()" [disabled]="saving">
        <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
        Save & Enhance
      </button>
    </div>

    <div *ngIf="loadingAutobiography" class="text-center py-5">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div *ngIf="!loadingAutobiography && autobiographyData.posts.length === 0" class="text-center py-5">
      <p class="text-muted">No autobiography chapters yet. Use the Paste Post tab to add content.</p>
    </div>

    <div *ngIf="!loadingAutobiography && autobiographyData.posts.length > 0" class="row g-3">
      <!-- Chapter list (sortable) -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header py-2">
            <strong>Chapters</strong>
          </div>
          <ul class="list-group list-group-flush list-group-numbered">
            <li *ngFor="let post of sortedAutobiographyPosts; let i = index"
                class="list-group-item d-flex justify-content-between align-items-center py-2 chapter-row"
                [class.active]="editingPost?.id === post.id"
                (click)="selectChapter(post)">
              <span class="chapter-title text-truncate flex-grow-1 me-2">{{ post.title }}</span>
              <span class="chapter-actions" (click)="$event.stopPropagation()">
                <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" (click)="moveUpAutobiography(i)" [disabled]="i === 0" title="Move up">â†‘</button>
                <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" (click)="moveDownAutobiography(i)" [disabled]="i === sortedAutobiographyPosts.length - 1" title="Move down">â†“</button>
              </span>
            </li>
          </ul>
        </div>
      </div>
      <!-- Detail panel (click chapter to edit) -->
      <div class="col-md-8">
        <div *ngIf="editingPost && selectedPost?.category === 'autobiography'" class="card">
          <div class="card-header d-flex justify-content-between align-items-center py-2">
            <strong>Chapter {{ chapterNumber(editingPost.order) }} â€“ {{ editingPost.title }}</strong>
            <button type="button" class="btn btn-sm btn-outline-secondary" (click)="closeChapterDetail()">âœ• Close</button>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Title</label>
              <input type="text" class="form-control" [(ngModel)]="editingPost.title" placeholder="Chapter title">
            </div>
            <div class="mb-3">
              <label class="form-label">Content</label>
              <div class="NgxEditor__Wrapper border rounded p-2 bg-white">
                <ngx-editor-menu [editor]="editEditor"></ngx-editor-menu>
                <ngx-editor
                  [editor]="editEditor"
                  [(ngModel)]="editingPost.content"
                  [placeholder]="'Edit content...'"
                  [outputFormat]="'html'">
                </ngx-editor>
              </div>
            </div>
            <small class="text-muted d-block mb-3">{{ formatDate(editingPost.created_utc) }}</small>
            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-primary" (click)="saveEditedPost()">ðŸ’¾ Save</button>
              <button class="btn btn-secondary" (click)="closeChapterDetail()">Cancel</button>
              <button class="btn btn-outline-info" (click)="translatePost(editingPost, 'chinese')" [disabled]="translating">ðŸ‡¨ðŸ‡³ Translate to Chinese</button>
              <button class="btn btn-outline-info" (click)="translatePost(editingPost, 'english')" [disabled]="translating">ðŸ‡ºðŸ‡¸ Translate to English</button>
            </div>
            <div *ngIf="translationResult" class="mt-3 p-3 bg-light rounded">
              <h6>Translation:</h6>
              <p>{{ translationResult }}</p>
            </div>
          </div>
        </div>
        <div *ngIf="!editingPost || selectedPost?.category !== 'autobiography'" class="text-muted text-center py-5 border rounded bg-light">
          <p class="mb-0">Click a chapter in the list to view and edit.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- White Paper Tab -->
  <div *ngIf="activeTab === 'white_paper'" class="tab-content">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Garden of Eden White Paper ({{ whitePaperData.posts.length }} chapters)</h3>
      <button class="btn btn-success" (click)="saveWhitePaper()" [disabled]="saving">
        <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
        Save & Enhance
      </button>
    </div>

    <div *ngIf="loadingWhitePaper" class="text-center py-5">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div *ngIf="!loadingWhitePaper && whitePaperData.posts.length === 0" class="text-center py-5">
      <p class="text-muted">No white paper chapters yet. Use the Paste Post tab to add content.</p>
    </div>

    <div *ngIf="!loadingWhitePaper && whitePaperData.posts.length > 0" class="row g-3">
      <!-- Chapter list (sortable) -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header py-2">
            <strong>Chapters</strong>
          </div>
          <ul class="list-group list-group-flush list-group-numbered">
            <li *ngFor="let post of sortedWhitePaperPosts; let i = index"
                class="list-group-item d-flex justify-content-between align-items-center py-2 chapter-row"
                [class.active]="editingPost?.id === post.id"
                (click)="selectChapter(post)">
              <span class="chapter-title text-truncate flex-grow-1 me-2">{{ post.title }}</span>
              <span class="chapter-actions" (click)="$event.stopPropagation()">
                <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" (click)="moveUpWhitePaper(i)" [disabled]="i === 0" title="Move up">â†‘</button>
                <button type="button" class="btn btn-sm btn-outline-secondary py-0 px-1" (click)="moveDownWhitePaper(i)" [disabled]="i === sortedWhitePaperPosts.length - 1" title="Move down">â†“</button>
              </span>
            </li>
          </ul>
        </div>
      </div>
      <!-- Detail panel (click chapter to edit) -->
      <div class="col-md-8">
        <div *ngIf="editingPost && selectedPost?.category === 'white_paper'" class="card">
          <div class="card-header d-flex justify-content-between align-items-center py-2">
            <strong>Chapter {{ chapterNumber(editingPost.order) }} â€“ {{ editingPost.title }}</strong>
            <button type="button" class="btn btn-sm btn-outline-secondary" (click)="closeChapterDetail()">âœ• Close</button>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Title</label>
              <input type="text" class="form-control" [(ngModel)]="editingPost.title" placeholder="Chapter title">
            </div>
            <div class="mb-3">
              <label class="form-label">Content</label>
              <div class="NgxEditor__Wrapper border rounded p-2 bg-white">
                <ngx-editor-menu [editor]="editEditor"></ngx-editor-menu>
                <ngx-editor
                  [editor]="editEditor"
                  [(ngModel)]="editingPost.content"
                  [placeholder]="'Edit content...'"
                  [outputFormat]="'html'">
                </ngx-editor>
              </div>
            </div>
            <small class="text-muted d-block mb-3">{{ formatDate(editingPost.created_utc) }}</small>
            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-primary" (click)="saveEditedPost()">ðŸ’¾ Save</button>
              <button class="btn btn-secondary" (click)="closeChapterDetail()">Cancel</button>
              <button class="btn btn-outline-info" (click)="translatePost(editingPost, 'chinese')" [disabled]="translating">ðŸ‡¨ðŸ‡³ Translate to Chinese</button>
              <button class="btn btn-outline-info" (click)="translatePost(editingPost, 'english')" [disabled]="translating">ðŸ‡ºðŸ‡¸ Translate to English</button>
            </div>
            <div *ngIf="translationResult" class="mt-3 p-3 bg-light rounded">
              <h6>Translation:</h6>
              <p>{{ translationResult }}</p>
            </div>
          </div>
        </div>
        <div *ngIf="!editingPost || selectedPost?.category !== 'white_paper'" class="text-muted text-center py-5 border rounded bg-light">
          <p class="mb-0">Click a chapter in the list to view and edit.</p>
        </div>
      </div>
    </div>
  </div>
</div>

