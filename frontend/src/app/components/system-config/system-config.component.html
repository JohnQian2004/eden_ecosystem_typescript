<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">‚öôÔ∏è System Configuration Wizard</h2>
    <div class="d-flex align-items-center gap-3">
      <!-- Wallet Balance Display -->
      <div class="card border-primary" style="min-width: 200px;">
        <div class="card-body py-2 px-3">
          <div class="d-flex align-items-center justify-content-between">
            <span class="text-muted small">Wallet Balance:</span>
            <span *ngIf="isLoadingBalance" class="spinner-border spinner-border-sm text-primary"></span>
            <strong *ngIf="!isLoadingBalance" class="text-primary ms-2">
              {{ walletBalance.toFixed(2) }} JSC
            </strong>
          </div>
        </div>
      </div>
      <button 
        type="button" 
        class="btn btn-danger" 
        (click)="resetWalletPersistence()"
        [disabled]="isResetting">
        <span *ngIf="!isResetting">üîÑ Reset Wallet Persistence</span>
        <span *ngIf="isResetting">
          <span class="spinner-border spinner-border-sm me-2"></span>Resetting...
        </span>
      </button>
    </div>
  </div>
  
  <!-- Reset Status Messages -->
  <div *ngIf="resetSuccess" class="alert alert-success alert-dismissible fade show" role="alert">
    <strong>‚úÖ Success!</strong> Wallet persistence file has been cleared. All wallet balances have been reset.
    <button type="button" class="btn-close" (click)="resetSuccess = false" aria-label="Close"></button>
  </div>
  <div *ngIf="resetError" class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>‚ùå Error:</strong> {{ resetError }}
    <button type="button" class="btn-close" (click)="resetError = null" aria-label="Close"></button>
  </div>
  
  <!-- Step 1: Service Type Selection -->
  <div *ngIf="wizardStep === 1" class="wizard-step">
    <h4 class="mb-3">Step 1: Select Service Type</h4>
    <p class="text-muted mb-4">Choose the type of service provider for this garden</p>
    
    <div *ngIf="isLoadingServiceTypes" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading service types...</span>
      </div>
    </div>
    
    <div class="row g-3" *ngIf="!isLoadingServiceTypes">
      <!-- NEW Service Provider Type Card -->
      <div class="col-md-6 col-lg-4">
        <div class="card h-100 service-type-card border-success" (click)="startNewServiceTypeCreation()" style="cursor: pointer; border-width: 2px;">
          <div class="card-body text-center">
            <div class="display-4 mb-3">üÜï</div>
            <h5 class="card-title">NEW Service Provider Type</h5>
            <p class="card-text text-muted small">Create a custom service type using AI-powered system prompt and notification code generation</p>
            <span class="badge bg-success">NEW</span>
          </div>
        </div>
      </div>
      
      <!-- Existing Service Types -->
      <div class="col-md-6 col-lg-4" *ngFor="let serviceType of serviceTypes">
        <div class="card h-100 service-type-card" (click)="selectServiceType(serviceType)" style="cursor: pointer;">
          <div class="card-body text-center">
            <div class="display-4 mb-3">{{ serviceType.icon }}</div>
            <h5 class="card-title">{{ serviceType.name }}</h5>
            <p class="card-text text-muted small">{{ serviceType.description }}</p>
            <span class="badge bg-primary">{{ serviceType.type }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Step 0: New Service Type Creation Wizard -->
  <div *ngIf="wizardStep === 0" class="wizard-step">
    <h4 class="mb-3">üÜï Create New Service Provider Type</h4>
    <p class="text-muted mb-4">Describe your service type and let AI generate the system prompts and notification code</p>
    
    <div class="card mb-4">
      <div class="card-body">
        <!-- Chat Input -->
        <div class="mb-3">
          <label class="form-label">Describe your service type:</label>
          <textarea 
            class="form-control" 
            rows="4"
            [(ngModel)]="newServiceTypeDescription"
            name="newServiceTypeDescription"
            placeholder="e.g., I need a multi-vendor ecommerce service provider that needs to persist vendorId/location/price/shipping cost/categories/itemName/quantity etc in ledger"
            [disabled]="isGeneratingSystemPrompt || isGeneratingNotificationCode"></textarea>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Service Type Name (auto-generated from description)</label>
            <input 
              type="text" 
              class="form-control" 
              [(ngModel)]="newServiceTypeName"
              name="newServiceTypeName"
              placeholder="e.g., ecommerce"
              [disabled]="isGeneratingSystemPrompt || isGeneratingNotificationCode">
          </div>
          <div class="col-md-6">
            <label class="form-label">Icon</label>
            <input 
              type="text" 
              class="form-control" 
              [(ngModel)]="newServiceTypeIcon"
              name="newServiceTypeIcon"
              placeholder="e.g., üõí"
              maxlength="2">
          </div>
        </div>
        
        <div class="d-flex gap-2">
          <button 
            class="btn btn-primary" 
            (click)="generateSystemPrompt()"
            [disabled]="!newServiceTypeDescription.trim() || isGeneratingSystemPrompt || isGeneratingNotificationCode">
            <span *ngIf="!isGeneratingSystemPrompt">ü§ñ Generate System Prompt</span>
            <span *ngIf="isGeneratingSystemPrompt">
              <span class="spinner-border spinner-border-sm me-2"></span>Generating...
            </span>
          </button>
          
          <button 
            class="btn btn-secondary" 
            (click)="goBackToServiceSelection()"
            [disabled]="isGeneratingSystemPrompt || isGeneratingNotificationCode">
            ‚Üê Back
          </button>
        </div>
      </div>
    </div>
    
    <!-- System Prompt Result -->
    <div class="card mb-4" *ngIf="systemPromptResult">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">‚úÖ System Prompt Generated</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label fw-bold">Query Extraction Prompt:</label>
          <pre class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">{{ systemPromptResult.queryExtractionPrompt || systemPromptResult.prompts?.queryExtractionPrompt }}</pre>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Response Formatting Prompt:</label>
          <pre class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">{{ systemPromptResult.responseFormattingPrompt || systemPromptResult.prompts?.responseFormattingPrompt }}</pre>
        </div>
        <div class="d-flex gap-2">
          <button 
            class="btn btn-success" 
            (click)="generateNotificationCode()"
            [disabled]="isGeneratingNotificationCode">
            <span *ngIf="!isGeneratingNotificationCode">üîî Generate Notification Code</span>
            <span *ngIf="isGeneratingNotificationCode">
              <span class="spinner-border spinner-border-sm me-2"></span>Generating...
            </span>
          </button>
          <button 
            class="btn btn-outline-secondary" 
            (click)="regenerateSystemPrompt()"
            [disabled]="isGeneratingSystemPrompt">
            üîÑ Regenerate
          </button>
        </div>
      </div>
    </div>
    
    <!-- Notification Code Result -->
    <div class="card mb-4" *ngIf="notificationCodeResult">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">‚úÖ Notification Code Generated</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label fw-bold">Webhook Code:</label>
          <pre class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">{{ notificationCodeResult.webhookCode || notificationCodeResult.code?.webhookCode }}</pre>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Pull/Poll Code:</label>
          <pre class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">{{ notificationCodeResult.pullCode || notificationCodeResult.code?.pullCode }}</pre>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">RPC Code:</label>
          <pre class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">{{ notificationCodeResult.rpcCode || notificationCodeResult.code?.rpcCode }}</pre>
        </div>
        <div class="d-flex gap-2">
          <button 
            class="btn btn-primary" 
            (click)="saveAndCreateIndexer()"
            [disabled]="isCreating">
            <span *ngIf="!isCreating">‚úÖ Save & Create Garden</span>
            <span *ngIf="isCreating">
              <span class="spinner-border spinner-border-sm me-2"></span>Creating...
            </span>
          </button>
          <button 
            class="btn btn-outline-secondary" 
            (click)="regenerateNotificationCode()"
            [disabled]="isGeneratingNotificationCode">
            üîÑ Regenerate
          </button>
        </div>
      </div>
    </div>
    
    <!-- Error Display -->
    <div class="alert alert-danger" *ngIf="generationError">
      <strong>‚ùå Error:</strong> {{ generationError }}
      <button type="button" class="btn-close" (click)="generationError = null" aria-label="Close"></button>
    </div>
  </div>
  
  <!-- Step 2: Configuration -->
  <div *ngIf="wizardStep === 2" class="wizard-step">
    <h4 class="mb-3">Step 2: Configure Garden</h4>
    <p class="text-muted mb-4">Configure network settings and authorization for {{ selectedServiceType?.name }}</p>
    
    <div class="card">
      <div class="card-body">
        <form>
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Service Type</label>
              <input type="text" class="form-control" [value]="selectedServiceType?.name" disabled>
            </div>
            <div class="col-md-6">
              <label class="form-label">Garden Name</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="gardenConfig.gardenName"
                name="gardenName"
                required>
            </div>
          </div>
          
          <!-- Movie Theater Providers Multi-Select (only for movie service type) -->
          <div class="row mb-3" *ngIf="selectedServiceType?.type === 'movie'">
            <div class="col-12">
              <label class="form-label">Target Movie Theater Providers</label>
              <select 
                class="form-select" 
                [(ngModel)]="gardenConfig.selectedProviders"
                name="selectedProviders"
                multiple
                size="3"
                style="min-height: 100px;">
                <option *ngFor="let provider of movieProviders" [value]="provider.id">
                  {{ provider.name }}
                </option>
              </select>
              <small class="text-muted">
                Hold Ctrl (Windows) or Cmd (Mac) to select multiple providers. 
                Selected: {{ gardenConfig.selectedProviders?.length || 0 }} provider(s)
              </small>
              <div *ngIf="!hasSelectedProviders() && selectedServiceType?.type === 'movie'" class="mt-2">
                <small class="text-danger">
                  ‚ö†Ô∏è Please select at least one movie theater provider to continue
                </small>
              </div>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label">Server IP</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="gardenConfig.serverIp"
                name="serverIp"
                placeholder="localhost"
                required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Server Domain</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="gardenConfig.serverDomain"
                name="serverDomain"
                placeholder="garden.eden.local"
                required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Server Port</label>
              <input 
                type="number" 
                class="form-control" 
                [(ngModel)]="gardenConfig.serverPort"
                name="serverPort"
                placeholder="3001"
                min="3001"
                required>
              <small class="text-muted">Starting from 3001 (ROOT CA uses 3000)</small>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Network Type</label>
              <select 
                class="form-select" 
                [(ngModel)]="gardenConfig.networkType"
                name="networkType"
                required>
                <option value="http">HTTP</option>
                <option value="https">HTTPS</option>
              </select>
            </div>
            <div class="col-md-6">
              <div class="form-check mt-4">
                <input 
                  class="form-check-input" 
                  type="checkbox" 
                  [(ngModel)]="gardenConfig.isSnake"
                  name="isSnake"
                  [disabled]="selectedServiceType?.type === 'snake'">
                <label class="form-check-label">
                  Snake (Advertiser) Service
                </label>
              </div>
            </div>
          </div>
          
          <!-- Deployment Fee Information -->
          <div class="alert alert-info mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>Deployment Fee:</strong> {{ calculateDeploymentFee() }} JSC
                <span *ngIf="selectedServiceType?.type === 'snake'" class="badge bg-warning ms-2">Snake Service (2x)</span>
                <span *ngIf="selectedServiceType?.type === 'movie'" class="badge bg-info ms-2">
                  Base: 100 JSC
                  <span *ngIf="gardenConfig.selectedProviders && gardenConfig.selectedProviders.length > 0">
                    + {{ (gardenConfig.selectedProviders || []).length }} provider(s) √ó 10 JSC
                  </span>
                </span>
              </div>
              <div>
                <strong>Available Balance:</strong> 
                <span [class.text-success]="hasSufficientBalance()" 
                      [class.text-danger]="!hasSufficientBalance()">
                  {{ walletBalance.toFixed(2) }} JSC
                </span>
              </div>
            </div>
            <div *ngIf="!hasSufficientBalance() && gardenConfig.gardenName" class="mt-2">
              <small class="text-danger">
                ‚ö†Ô∏è Insufficient balance. Required: {{ calculateDeploymentFee() }} JSC, Available: {{ walletBalance.toFixed(2) }} JSC
              </small>
            </div>
          </div>
          
          <div class="alert alert-info">
            <strong>Note:</strong> This wizard will create a new garden with the specified configuration.
            The garden will be certified by ROOT CA and persisted to the system.
          </div>
          
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" (click)="goBack()">‚Üê Back</button>
            <button 
              type="button" 
              class="btn"
              [class.btn-primary]="hasSufficientBalance() && hasSelectedProviders()"
              [class.btn-warning]="(!hasSufficientBalance() || !hasSelectedProviders()) && gardenConfig.gardenName"
              [class.btn-secondary]="(!hasSufficientBalance() || !hasSelectedProviders()) && !gardenConfig.gardenName"
              (click)="createGarden()"
              [disabled]="isCreating || !gardenConfig.gardenName || !hasSufficientBalance() || !hasSelectedProviders()">
              <span *ngIf="!isCreating">
                <span *ngIf="hasSufficientBalance() && hasSelectedProviders()">Create Garden</span>
                <span *ngIf="!hasSufficientBalance() && gardenConfig.gardenName">
                  Insufficient Balance ({{ calculateDeploymentFee() }} JSC required)
                </span>
                <span *ngIf="!hasSelectedProviders() && gardenConfig.gardenName && selectedServiceType?.type === 'movie'">
                  Select at least one provider
                </span>
                <span *ngIf="(!hasSufficientBalance() || !hasSelectedProviders()) && !gardenConfig.gardenName">Create Garden</span>
              </span>
              <span *ngIf="isCreating">
                <span class="spinner-border spinner-border-sm me-2"></span>Creating...
              </span>
            </button>
          </div>
          
          <div *ngIf="creationError" class="alert alert-danger mt-3">
            {{ creationError }}
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Step 3: Success -->
  <div *ngIf="wizardStep === 3" class="wizard-step">
    <div class="card border-success">
      <div class="card-body text-center py-5">
        <div class="display-1 text-success mb-3">‚úÖ</div>
        <h3 class="mb-3">Garden Created Successfully!</h3>
        <p class="text-muted mb-4">The garden has been created, certified, and persisted to the system.</p>
        <button type="button" class="btn btn-primary" (click)="resetWizard()">Create Another Garden</button>
      </div>
    </div>
  </div>
</div>
