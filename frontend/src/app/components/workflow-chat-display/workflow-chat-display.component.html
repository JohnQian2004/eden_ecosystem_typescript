<div class="workflow-chat-container">
  <div class="card">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        üí¨ FlowWise Workflows Chat
        <span class="ms-3 badge bg-warning text-dark" *ngIf="walletBalance !== undefined">
          Current Wallet Balance: {{ walletBalance.toFixed(2) }} JSC
        </span>
        <span class="ms-3 spinner-border spinner-border-sm text-white-50" *ngIf="walletBalance === undefined" role="status">
          <span class="visually-hidden">Loading...</span>
        </span>
      </h5>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-light" (click)="clearChat()" title="Clear Chat">
          üóëÔ∏è Clear Chat
        </button>
        <small class="text-white-50">Natural conversation interface</small>
      </div>
    </div>
    
    <!-- Chat Messages -->
    <div class="card-body p-0">
      <div class="chat-messages-container" style="height: 500px; overflow-y: auto; padding: 20px;">
        <!-- Welcome Message -->
        <div *ngIf="chatMessages.length === 0" class="text-center text-muted py-5">
          <h6>üëã Welcome!</h6>
          <p class="mb-0">Start a conversation by selecting a service type and making a request.</p>
          <p class="small mt-2">Your conversation history will appear here.</p>
        </div>

        <!-- Chat Messages -->
        <div *ngFor="let message of chatMessages" class="mb-3">
          <!-- User Message -->
          <div *ngIf="message.type === 'user'" class="d-flex justify-content-end">
            <div class="chat-bubble chat-bubble-user">
              <div class="chat-content">{{ message.content }}</div>
              <small class="chat-timestamp">{{ message.timestamp | date:'shortTime' }}</small>
            </div>
          </div>

          <!-- Assistant Message -->
          <div *ngIf="message.type === 'assistant'" class="d-flex justify-content-start">
            <div class="chat-bubble chat-bubble-assistant">
              <div class="chat-content">{{ message.content }}</div>
              
              <!-- Show listings if available -->
              <div *ngIf="message.data?.listings && message.data.listings.length > 0" class="mt-2">
                <div class="listings-preview">
                  <small class="text-muted">Found {{ message.data.listings.length }} option(s)</small>
                </div>
              </div>

              <!-- Decision/Selection Options -->
              <div *ngIf="message.showOptions && message.options && message.options.length > 0" class="mt-3">
                <div class="selection-options">
                  <div *ngFor="let option of message.options" class="option-card mb-2">
                    <div class="option-content">
                      <strong>{{ option.label }}</strong>
                      <button 
                        class="btn btn-sm float-end"
                        [ngClass]="{
                          'btn-success': message.data?.isDecision && (option.label?.toUpperCase() === 'YES' || option.value?.toUpperCase() === 'YES'),
                          'btn-danger': message.data?.isDecision && (option.label?.toUpperCase() === 'NO' || option.value?.toUpperCase() === 'NO'),
                          'btn-primary': !message.data?.isDecision || (option.label?.toUpperCase() !== 'YES' && option.label?.toUpperCase() !== 'NO' && option.value?.toUpperCase() !== 'YES' && option.value?.toUpperCase() !== 'NO')
                        }"
                        (click)="onOptionSelected(option, message)">
                        {{ message.data?.isDecision ? 'Choose' : 'Select' }}
                      </button>
                    </div>
                  </div>
                  <!-- Cancel Button -->
                  <div class="mt-2 text-center">
                    <button 
                      class="btn btn-sm btn-outline-secondary"
                      (click)="onCancelOption(message)">
                      ‚ùå Cancel
                    </button>
                  </div>
                </div>
              </div>

              <small class="chat-timestamp">{{ message.timestamp | date:'shortTime' }}</small>
            </div>
          </div>

          <!-- System Message -->
          <div *ngIf="message.type === 'system'" class="d-flex justify-content-center">
            <div class="chat-bubble chat-bubble-system" [ngClass]="{'chat-bubble-wallet': message.content.includes('Wallet Balance')}">
              <div class="chat-content" [innerHTML]="message.content.replace('**', '<strong>').replace('**', '</strong>')"></div>
              <div *ngIf="message.data?.balance !== undefined && message.data?.previousBalance !== undefined" class="mt-2 small">
                <span *ngIf="message.data.previousBalance !== message.data.balance" class="text-muted">
                  Previous: {{ message.data.previousBalance.toFixed(2) }} JSC ‚Üí 
                  <span [ngClass]="{'text-success': message.data.balance > message.data.previousBalance, 'text-danger': message.data.balance < message.data.previousBalance}">
                    Current: {{ message.data.balance.toFixed(2) }} JSC
                  </span>
                </span>
              </div>
              <small class="chat-timestamp">{{ message.timestamp | date:'shortTime' }}</small>
            </div>
          </div>

          <!-- Ledger Message -->
          <div *ngIf="message.type === 'ledger'" class="d-flex justify-content-start">
            <div class="chat-bubble chat-bubble-ledger">
              <div class="ledger-message-header">
                <strong>üí≥ {{ message.content }}</strong>
              </div>
              <div class="ledger-message-content mt-2">
                <div class="ledger-row">
                  <span class="ledger-label">Service:</span>
                  <span class="badge bg-secondary">{{ message.data?.serviceType || 'N/A' }}</span>
                </div>
                <div class="ledger-row">
                  <span class="ledger-label">Merchant:</span>
                  <span>{{ message.data?.merchant || 'N/A' }}</span>
                </div>
                <div class="ledger-row">
                  <span class="ledger-label">Amount:</span>
                  <strong class="text-primary">{{ message.data?.amount?.toFixed(2) || '0.00' }} JSC</strong>
                </div>
                <div class="ledger-row">
                  <span class="ledger-label">iGas Cost:</span>
                  <strong class="text-info">{{ formatIGasCost(message.data?.iGasCost ?? message.data?.entry?.iGasCost) }}</strong>
                </div>
                <div class="ledger-row" *ngIf="message.data?.details">
                  <span class="ledger-label">Details:</span>
                  <small class="text-muted" [innerHTML]="message.data.details"></small>
                </div>
                <div class="ledger-row">
                  <span class="ledger-label">Date:</span>
                  <small class="text-muted">{{ formatDate(message.timestamp) }}</small>
                </div>
              </div>
              <small class="chat-timestamp">{{ message.timestamp | date:'shortTime' }}</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

