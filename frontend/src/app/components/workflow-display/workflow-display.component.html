<div class="card">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">üé¨ AMC Cinema Workflow Control</h5>
    <small class="text-white-50">üîÑ Atomic Server Execution | ü§ñ LLM Self-Play + üí∞ Server Autopay</small>
  </div>
  <div class="card-body">
    <!-- Debug Info -->
    <div class="alert alert-info small mb-3">
      <strong>Debug Info:</strong><br>
      Loading: {{ isLoading }} | Current Workflow: {{ currentWorkflow ? currentWorkflow.name : 'None' }} | Selected: {{ selectedWorkflow || 'None' }} | Active Execution: {{ activeExecution ? activeExecution.serviceType : 'None' }}<br>
      API URL: {{ apiUrl }}
    </div>

    <!-- LLM Response Display -->
    <div *ngIf="llmResponses.length > 0" class="card mb-3">
      <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <h6 class="mb-0">ü§ñ LLM Responses ({{ llmResponses.length }})</h6>
        <div class="btn-group" role="group">
          <button class="btn btn-sm btn-outline-light" (click)="exportLlmHistory()" title="Export LLM History as JSON">
            üì§ Export
          </button>
          <button class="btn btn-sm btn-outline-light" (click)="clearLlmHistory()" title="Clear LLM History">
            üóëÔ∏è Clear
          </button>
        </div>
      </div>
      <div class="card-body">
        <!-- LLM History Summary -->
        <div class="row mb-3 text-muted small">
          <div class="col-md-3">
            <strong>Total:</strong> {{ llmResponses.length }}
          </div>
          <div class="col-md-3">
            <strong>Processing:</strong> {{ processingCount }}
          </div>
          <div class="col-md-3">
            <strong>Responses:</strong> {{ responseCount }}
          </div>
          <div class="col-md-3" *ngIf="llmResponses.length > 0">
            <strong>Latest:</strong> {{ llmResponses[llmResponses.length - 1].timestamp | date:'shortTime' }}
          </div>
        </div>

        <div *ngFor="let response of llmResponses; let i = index" class="mb-3">
          <div class="alert" [ngClass]="response.type === 'start' ? 'alert-info' : 'alert-success'">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <strong>{{ response.type === 'start' ? 'ü§ñ Processing...' : '‚úÖ Response' }}</strong>
                <p class="mb-2">{{ response.message }}</p>

                <!-- Raw Data Toggle (for responses only) -->
                <div *ngIf="response.type === 'response'" class="mb-2">
                  <button class="btn btn-sm btn-outline-info" (click)="toggleRawData(response)">
                    üîç {{ response.showRawData ? 'Hide' : 'Show' }} Raw LLM Data
                  </button>
                </div>

                <!-- Raw LLM Data Display -->
                <div *ngIf="response.showRawData" class="mb-3 p-3 bg-light rounded">
                  <h6 class="text-muted mb-2">üîç Original LLM Event Data:</h6>
                  <pre class="small text-muted">{{ response.originalEvent | json }}</pre>

                  <h6 class="text-muted mb-2 mt-3" *ngIf="response.llmData">üìä Extracted LLM Data:</h6>
                  <pre class="small text-muted" *ngIf="response.llmData">{{ response.llmData | json }}</pre>
                </div>

                <!-- Structured Data Table -->
                <div *ngIf="response.data" class="mt-2">
                  <table class="table table-sm table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th scope="col" style="width: 30%;">Field</th>
                        <th scope="col">Value</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let field of getDataFields(response.data)">
                        <td><strong>{{ getFieldLabel(field.key) }}</strong></td>
                        <td>
                          <span [innerHTML]="formatTableValue(field.value)"></span>
                          <!-- Nested object display -->
                          <div *ngIf="isObject(field.value) && !isArray(field.value)" class="mt-1">
                            <table class="table table-sm table-light">
                              <tbody>
                                <tr *ngFor="let subField of getDataFields(field.value)">
                                  <td style="width: 40%; font-size: 0.85em;"><em>{{ getFieldLabel(subField.key) }}</em></td>
                                  <td style="font-size: 0.85em;">{{ formatTableValue(subField.value) }}</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <small class="text-muted">{{ response.timestamp | date:'HH:mm:ss' }}</small>
            </div>
          </div>
        </div>

        <div *ngIf="iGasCost" class="alert alert-warning">
          <strong>‚õΩ iGas Cost:</strong> {{ iGasCost | number:'1.6-6' }}
        </div>
      </div>
    </div>

    <!-- No LLM Responses Message -->
    <div *ngIf="llmResponses.length === 0" class="alert alert-info">
      <strong>ü§ñ No LLM Responses Yet</strong><br>
      <small>LLM responses will appear here during workflow execution. History is automatically saved and restored.</small>
    </div>

    <div *ngIf="isLoading" class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading AMC workflow...</span>
      </div>
      <p class="mt-2">Loading AMC Cinema workflow...</p>
      <p class="text-muted small">Check browser console for API request details</p>
    </div>

    <div *ngIf="!isLoading && currentWorkflow">
      <!-- Debug: Template condition met -->
      <div style="background: #f0f0f0; padding: 5px; margin-bottom: 10px; font-size: 12px;">
        üîç DEBUG: Template rendering - isLoading: {{isLoading}}, currentWorkflow: {{!!currentWorkflow}}, workflowName: {{currentWorkflow?.name || 'N/A'}}, steps: {{debugWorkflowSteps?.length || 0}}<br>
        üîç DEBUG: Selection - showSelectionPrompt: {{showSelectionPrompt}}, pendingSelection: {{!!pendingSelection}}, options count: {{pendingSelection?.options?.length || 0}}<br>
        üîç DEBUG: Decision - showDecisionPrompt: {{showDecisionPrompt}}, pendingDecision: {{!!pendingDecision}}, options count: {{pendingDecision?.options?.length || 0}}
      </div>
      <!-- Workflow Control -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <h5 class="mb-1">{{ currentWorkflow?.name || 'No Workflow' }}</h5>
            <p class="text-muted mb-0">{{ currentWorkflow?.description || '' }}</p>
          </div>
          <button
            type="button"
            class="btn btn-success"
            (click)="startWorkflow()"
            [disabled]="activeExecution !== null">
            <i class="fas fa-play"></i> Start AMC Workflow
          </button>
        </div>
        
        <!-- Manual Step Controls -->
        <div class="alert alert-info mt-3 mb-0">
          <h6 class="mb-1">üéÆ Manual Step Controls</h6>
          <p class="mb-0 small">Click the play button next to any step to execute it manually</p>
        </div>
      </div>

      <!-- Active Decision Prompt -->
      <div *ngIf="showDecisionPrompt && pendingDecision" class="alert alert-info mb-4" role="alert">
        <h6 class="alert-heading">ü§î {{ pendingDecision.prompt }}</h6>
        <hr>
        <div class="d-flex gap-2">
          <button
            *ngFor="let option of pendingDecision.options"
            class="btn btn-primary"
            (click)="submitDecision(option.value)">
            {{ option.label }}
          </button>
        </div>
        <small class="text-muted mt-2 d-block">
          Timeout: {{ pendingDecision.timeout }}ms
        </small>
      </div>

      <!-- Debug: Selection Prompt State (always visible for debugging) -->
      <div style="background: #fff3cd; padding: 10px; margin-bottom: 10px; font-size: 12px; border: 1px solid #ffc107;">
        ‚ö†Ô∏è DEBUG Selection State:<br>
        showSelectionPrompt: {{showSelectionPrompt}}<br>
        pendingSelection exists: {{!!pendingSelection}}<br>
        pendingSelection options count: {{pendingSelection?.options?.length || 0}}<br>
        pendingSelection prompt: {{pendingSelection?.prompt || 'N/A'}}
      </div>

      <!-- Movie Selection Prompt -->
      <div *ngIf="showSelectionPrompt && pendingSelection && pendingSelection.options && pendingSelection.options.length > 0" class="alert alert-success mb-4" role="alert">
        <h6 class="alert-heading">‚úàÔ∏è {{ pendingSelection.prompt }}</h6>
        <hr>
        <div class="row g-3">
          <div *ngFor="let option of pendingSelection.options; let i = index"
               class="col-md-6">
            <div class="card h-100 border-primary">
              <div class="card-body">
                <h6 class="card-title">{{ getDisplayTitle(option) }}</h6>
                <div class="card-text">
                  <!-- Dynamically display all data fields -->
                  <div *ngFor="let field of getDisplayFields(option)">
                    <strong>{{ getFieldLabel(field.key) }}:</strong>
                    <span [innerHTML]="formatFieldValue(field.value)"></span><br *ngIf="!field.last">
                  </div>
                </div>
                <button
                  class="btn btn-primary w-100"
                  (click)="submitMovieSelection(option)">
                  {{ getSelectButtonText(option) }}
                </button>
              </div>
            </div>
          </div>
        </div>
        <small class="text-muted mt-3 d-block">
          Please select your preferred option ‚Ä¢ Timeout: {{ pendingSelection.timeout }}ms
        </small>
      </div>

      <!-- Workflow Progress -->
      <div class="row">
        <div class="col-md-4">
          <h6>Workflow Progress</h6>
          <div class="progress mb-3">
            <div
              class="progress-bar"
              role="progressbar"
              [style.width.%]="debugWorkflowSteps.length > 0 ? ((currentStepIndex + 1) / debugWorkflowSteps.length) * 100 : 0"
              [attr.aria-valuenow]="currentStepIndex + 1"
              aria-valuemin="0"
              [attr.aria-valuemax]="debugWorkflowSteps.length">
              Step {{ currentStepIndex + 1 }} of {{ debugWorkflowSteps.length }}
            </div>
          </div>

          <div class="list-group">
            <!-- Debug: Steps iteration -->
            <div style="background: #ffe0e0; padding: 5px; margin-bottom: 5px; font-size: 11px;" *ngIf="debugWorkflowSteps.length > 0">
              üîç DEBUG: Iterating {{debugWorkflowSteps.length}} steps
            </div>
            <div
              *ngFor="let step of debugWorkflowSteps; let i = index; trackBy: trackByStepId"
              class="list-group-item"
              [ngClass]="getStepStatusClass(step.id)">
              <div class="d-flex align-items-start">
                <div class="me-3">
                  <span [class]="getStepIcon(step.type) + ' fs-5'"></span>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-1">
                    {{ step.name }}
                    <span [ngClass]="getStepTypeClass(step.type)" class="ms-2 small">{{ step.type }}</span>
                    <small class="ms-2 text-info">[{{ getStepStatus(step.id) }}]</small>
                  </h6>
                  <p class="mb-1 small">{{ step.description }}</p>

                  <!-- Status indicators -->
                  <div class="small">
                    <span *ngIf="getStepStatus(step.id) === 'completed'" class="text-success">
                      ‚úÖ Completed
                    </span>
                    <span *ngIf="getStepStatus(step.id) === 'current'" class="text-primary fw-bold">
                      üîÑ In Progress
                    </span>
                    <span *ngIf="getStepStatus(step.id) === 'pending'" class="text-muted">
                      ‚è≥ Pending
                    </span>
                  </div>
                </div>
                <div class="ms-auto">
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary"
                    (click)="executeStepManually(step)"
                    [disabled]="!activeExecution"
                    title="Execute this step manually (requires active workflow)">
                    <i class="fas fa-play"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Current Step Details -->
        <div class="col-md-8">
          <div *ngIf="currentStep" class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0">
                {{ getStepIcon(currentStep.type) }} {{ currentStep.name }}
                <span [ngClass]="getStepTypeClass(currentStep.type)" class="ms-2">{{ currentStep.type }}</span>
              </h6>
              <small class="text-muted">Step {{ currentStepIndex + 1 }} of {{ debugWorkflowSteps.length }}</small>
            </div>
            <div class="card-body">
              <p class="lead">{{ currentStep.description }}</p>

              <!-- Decision Step Interactive UI -->
              <div *ngIf="currentStep.type === 'decision' && currentStep.requiresUserDecision && pendingDecision" class="alert alert-warning">
                <h6>üéØ Interactive Decision Required</h6>
                <div class="mb-3">
                  <label class="form-label fw-bold">{{ currentStep.decisionPrompt }}</label>
                  <div class="row g-2">
                    <div class="col-6" *ngFor="let option of currentStep.decisionOptions">
                      <button
                        class="btn btn-outline-primary w-100"
                        (click)="submitDecision(option.value)">
                        <strong>{{ option.label }}</strong><br>
                        <small class="text-muted">{{ option.action }}</small>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="small text-muted">
                  <i class="fas fa-clock"></i> Auto-timeout in {{ currentStep.timeout || 30000 }}ms
                  <span *ngIf="currentStep.onTimeout"> ‚Üí {{ currentStep.onTimeout }}</span>
                </div>
              </div>

              <!-- Process Step UI -->
              <div *ngIf="currentStep.type === 'process'" class="alert alert-info">
                <h6>‚öôÔ∏è Processing...</h6>
                <div class="d-flex align-items-center">
                  <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Processing...</span>
                  </div>
                  <span>{{ currentStep.description }}</span>
                </div>

                <!-- Show actions being executed -->
                <div *ngIf="currentStep.actions && currentStep.actions.length > 0" class="mt-3">
                  <div class="alert alert-info">
                    <h6>üîÑ Atomic Step Execution</h6>
                    <p class="mb-1">This step is being executed atomically on the server.</p>
                    <p class="mb-0 small">All actions, events, and outputs are processed together to ensure proper synchronization.</p>
                  </div>

                  <h6>Actions in Step:</h6>
                  <ul class="list-group list-group-flush">
                    <li *ngFor="let action of currentStep.actions" class="list-group-item px-0">
                      <div class="d-flex align-items-center">
                        <span class="badge me-2" [ngClass]="getActionBadgeClass(action.type)">
                          {{ getActionBadgeIcon(action.type) }}
                        </span>
                        <span><strong>{{ action.type }}</strong></span>
                        <small class="text-muted ms-auto">{{ getActionStatusText(action.type) }}</small>
                      </div>
                      <small class="text-muted ms-4" *ngIf="action['field']">{{ action['field'] }}</small>
                    </li>
                  </ul>
                  <div class="alert alert-light mt-2 small">
                    <strong>üîÑ Atomic Execution:</strong> All actions processed together on server |
                    <strong>ü§ñ LLM Self-Play</strong> + <strong>üí∞ Server Autopay</strong>
                  </div>
                </div>
              </div>

              <!-- Input Step UI -->
              <div *ngIf="currentStep.type === 'input'" class="alert alert-primary">
                <h6>üìù {{ currentStep.component === 'eden_chat' ? 'Eden Chat Input Required' : 'Input Required' }}</h6>
                <p>{{ currentStep.description }}</p>

                <!-- Eden Chat specific UI -->
                <div *ngIf="currentStep.component === 'eden_chat'" class="mt-3">
                  <div class="card bg-light">
                    <div class="card-body">
                      <h6 class="card-title">üí¨ Eden Chat Interface</h6>
                      <p class="card-text small text-muted">
                        Please use the chat input below to describe your movie preferences.
                        The Eden Chat system will process your request and guide you through the movie booking process.
                      </p>
                      <div class="alert alert-info small">
                        <strong>Expected Input:</strong> Movie preferences, show times, ticket requests, etc.
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Show validation rules -->
                <div *ngIf="currentStep.actions" class="mt-3">
                  <h6>Validation Rules:</h6>
                  <ul class="list-group list-group-flush">
                    <li *ngFor="let action of currentStep.actions" class="list-group-item px-0">
                      <strong>{{ action['field'] }}</strong>
                      <span *ngIf="action['required']" class="badge bg-danger ms-2">Required</span>
                      <span *ngIf="action['format']" class="badge bg-info ms-2">{{ action['format'] }}</span>
                      <span *ngIf="action['serviceType']" class="badge bg-success ms-2">{{ action['serviceType'] }}</span>
                    </li>
                  </ul>
                </div>
              </div>

              <!-- Movie Theater Step UI -->
              <div *ngIf="currentStep.type === 'process' && currentStep.component === 'movie_theater'" class="movie-theater-wrapper">
                <div *ngIf="!selectedListing?.movieTitle" class="alert alert-info">
                  <p>Waiting for movie selection...</p>
                  <p class="small text-muted">The movie will start automatically once selected.</p>
                </div>
                <app-movie-theater
                  *ngIf="selectedListing?.movieTitle"
                  [movieTitle]="selectedListing.movieTitle"
                  [duration]="selectedListing.duration || 10"
                  [selectedListing]="selectedListing"
                  (movieProgress)="onMovieProgress($event)"
                  (movieFinished)="onMovieFinished($event)">
                </app-movie-theater>
              </div>

              <!-- Output Step UI -->
              <div *ngIf="currentStep.type === 'output'" class="alert alert-success">
                <h6>‚úÖ Output Generated</h6>
                <p>{{ currentStep.description }}</p>

                <!-- Show websocket events -->
                <div *ngIf="currentStep.websocketEvents && currentStep.websocketEvents.length > 0" class="mt-3">
                  <h6>Events Broadcast:</h6>
                  <ul class="list-group list-group-flush">
                    <li *ngFor="let event of currentStep.websocketEvents" class="list-group-item px-0">
                      <div class="d-flex align-items-center">
                        <span class="badge bg-secondary me-2">{{ event.type }}</span>
                        <span>{{ event.message }}</span>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>

              <!-- Error Step UI -->
              <div *ngIf="currentStep.type === 'error'" class="alert alert-danger">
                <h6>‚ùå Error Occurred</h6>
                <p>{{ currentStep.description }}</p>

                <div *ngIf="currentStep.errorHandling" class="mt-3">
                  <h6>Error Handling:</h6>
                  <p><strong>Next Step:</strong> {{ currentStep.errorHandling.onError }}</p>
                </div>
              </div>

              <!-- Step Metadata -->
              <div class="mt-4 pt-3 border-top">
                <div class="row text-muted small">
                  <div class="col-md-4">
                    <strong>Component:</strong> {{ currentStep.component }}
                  </div>
                  <div class="col-md-4">
                    <strong>Step ID:</strong> <code>{{ currentStep.id }}</code>
                  </div>
                  <div class="col-md-4">
                    <strong>Execution:</strong> {{ activeExecution ? activeExecution.executionId.substring(0, 8) + '...' : 'Not started' }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Workflow Not Started -->
          <div *ngIf="!activeExecution" class="text-center py-5">
            <div class="mb-4">
              <i class="fas fa-play-circle fs-1 text-muted"></i>
            </div>
            <h5 class="text-muted">AMC Cinema Workflow Ready</h5>
            <p class="text-muted">Click "Start AMC Workflow" to begin the interactive workflow demonstration</p>
            <button
              type="button"
              class="btn btn-primary btn-lg"
              (click)="startWorkflow()">
              <i class="fas fa-play"></i> Start AMC Cinema Workflow
            </button>
          </div>

          <!-- Workflow Completed -->
          <div *ngIf="activeExecution && currentWorkflow && currentWorkflow.finalSteps.includes(activeExecution.currentStep)" class="text-center py-5">
            <div class="mb-4">
              <i class="fas fa-check-circle fs-1 text-success"></i>
            </div>
            <h5 class="text-success">AMC Cinema Workflow Completed!</h5>
            <p class="text-muted">The workflow has reached a final step.</p>
            <button
              type="button"
              class="btn btn-outline-primary"
              (click)="startWorkflow()">
              <i class="fas fa-redo"></i> Run Again
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- DEX Workflow (Future) -->
    <div *ngIf="!isLoading && !currentWorkflow" class="text-center py-5">
      <p class="text-muted">No workflow loaded. Select a service type on Main Street to start a workflow.</p>
    </div>
  </div>
</div>

