<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 sidebar">
      <app-sidebar></app-sidebar>
    </div>
    
    <!-- Main Content -->
    <div class="col-md-9">
      <div class="container-fluid py-3">
        <div class="d-flex align-items-center mb-4">
          <!-- Sign In/Out Button -->
          <button class="btn btn-primary btn-lg me-3" (click)="openSignInModal()">
            <span *ngIf="!isGoogleSignedIn">üîê Sign In</span>
            <span *ngIf="isGoogleSignedIn">üë§ {{ userEmail }}</span>
          </button>
          <h1 class="mb-0">üå≥ Eden Simulator Dashboard<span *ngIf="userEmail" class="text-muted"> for {{ userEmail }}</span></h1>
        </div>
        
        <!-- Sign In/Out Modal -->
        <div class="modal fade" id="signInModal" tabindex="-1" aria-labelledby="signInModalLabel" aria-hidden="true" [class.show]="showSignInModal" [style.display]="showSignInModal ? 'block' : 'none'">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="signInModalLabel">
                  <span *ngIf="!isGoogleSignedIn">üîê Sign In to Eden Simulator</span>
                  <span *ngIf="isGoogleSignedIn">üë§ Account Settings</span>
                </h5>
                <button type="button" class="btn-close" (click)="closeSignInModal()" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div *ngIf="!isGoogleSignedIn">
                  <!-- Email/Password Sign-In Form -->
                  <form (ngSubmit)="signInWithEmail()" class="mb-4">
                    <div class="mb-3">
                      <label for="email" class="form-label">Email Address</label>
                      <input 
                        type="email" 
                        class="form-control form-control-lg" 
                        id="email" 
                        [(ngModel)]="signInEmail"
                        name="email"
                        placeholder="Enter your email"
                        required>
                    </div>
                    <div class="mb-3">
                      <label for="password" class="form-label">Password</label>
                      <input 
                        type="password" 
                        class="form-control form-control-lg" 
                        id="password" 
                        [(ngModel)]="signInPassword"
                        name="password"
                        placeholder="Enter your password"
                        required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg w-100 mb-3" [disabled]="isSigningIn">
                      <span *ngIf="!isSigningIn">Sign In</span>
                      <span *ngIf="isSigningIn">
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        Signing In...
                      </span>
                    </button>
                  </form>
                  
                  <!-- Divider -->
                  <div class="text-center mb-3">
                    <span class="text-muted">OR</span>
                  </div>
                  
                  <!-- Google Sign-In Button -->
                  <div class="text-center">
                    <p class="mb-3">Sign in with your Google account</p>
                    <div id="google-signin-button-modal" style="min-width: 200px; min-height: 40px; margin: 0 auto;"></div>
                  </div>
                </div>
                <div *ngIf="isGoogleSignedIn" class="text-center">
                  <div class="mb-4">
                    <p class="mb-2"><strong>Signed in as:</strong></p>
                    <p class="text-primary fs-5">{{ userEmail }}</p>
                  </div>
                  <button class="btn btn-danger btn-lg" (click)="signOutAndClose()">
                    Sign Out
                  </button>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeSignInModal()">Close</button>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="showSignInModal" class="modal-backdrop fade show" (click)="closeSignInModal()"></div>
        
        <!-- iGas Display -->
        <div class="row mb-4">
          <div class="col-12">
            <app-igas-display></app-igas-display>
          </div>
        </div>
        
        <!-- Garden of Eden Main Street - Service Type Cards -->
        <!-- Main Street always shows hardcoded service types -->
        <div class="row mb-3" *ngIf="!isLoadingServices && serviceTypes.length > 0">
          <div class="col-12">
            <h5 class="mb-2">üå≥ Garden of Eden Main Street</h5>
            <p class="text-muted small mb-3">Click a service type - ROOT CA ServiceRegistry will find the best providers</p>
            <div class="row g-2">
              <div class="col-6 col-md-4 col-lg-2" *ngFor="let serviceType of serviceTypes">
                <div 
                  class="card service-card-compact h-100" 
                  [ngClass]="{
                    'movie-service': serviceType.type === 'movie', 
                    'dex-service': serviceType.type === 'dex',
                    'airline-service': serviceType.type === 'airline',
                    'autoparts-service': serviceType.type === 'autoparts',
                    'hotel-service': serviceType.type === 'hotel',
                    'restaurant-service': serviceType.type === 'restaurant'
                  }"
                  (click)="selectServiceType(serviceType)" 
                  style="cursor: pointer;">
                  <div class="card-body text-center p-2">
                    <div class="service-icon-compact mb-1" style="font-size: 1.8rem;">{{ serviceType.icon }}</div>
                    <h6 class="card-title mb-0 small">{{ serviceType.adText }}</h6>
                    <div *ngIf="amcWorkflowActive && serviceType.type === 'movie'" class="mt-1">
                      <span class="badge bg-success small">Active</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Snake Services (serviceType: "snake", belongs to gardens) -->
        <div class="row mb-3" *ngIf="!isLoadingSnakeProviders && snakeProviders.length > 0">
          <div class="col-12">
            <h5 class="mb-2">üêç Snake Services</h5>
            <p class="text-muted small mb-3">Snake is a service type (serviceType: "snake") - Each service belongs to a garden. Higher fees, transparent pricing.</p>
            <div class="row g-2">
              <div class="col-6 col-md-4 col-lg-3" *ngFor="let snakeProvider of snakeProviders">
                <div 
                  class="card service-card-compact h-100 snake-provider-card" 
                  (click)="selectServiceType({type: snakeProvider.serviceType, icon: 'üêç', adText: snakeProvider.name, sampleQuery: 'Show me ' + snakeProvider.name + ' options'})"
                  style="cursor: pointer; border: 2px solid #ff6b9d;">
                  <div class="card-body text-center p-2">
                    <div class="service-icon-compact mb-1" style="font-size: 1.8rem;">üêç</div>
                    <h6 class="card-title mb-1 small fw-bold">{{ snakeProvider.name }}</h6>
                    <div class="small text-muted mb-1">
                      <div><strong>Service Type:</strong> {{ snakeProvider.serviceType }}</div>
                      <div><strong>Garden:</strong> {{ snakeProvider.gardenId || snakeProvider.indexerId }}</div>
                      <div>iGas: {{ (snakeProvider.iGasMultiplier || 1.0) }}x</div>
                      <div>iTax: {{ (snakeProvider.iTaxMultiplier || 1.0) }}x</div>
                      <div>Insurance: {{ snakeProvider.insuranceFee || snakeProvider.bond }}</div>
                    </div>
                    <div class="small">
                      <span class="badge bg-info" *ngFor="let context of snakeProvider.contextsAllowed">{{ context }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Loading Snake Services -->
        <div class="row mb-3" *ngIf="isLoadingSnakeProviders">
          <div class="col-12 text-center">
            <div class="spinner-border text-danger" role="status" style="width: 1.5rem; height: 1.5rem;">
              <span class="visually-hidden">Loading Snake services...</span>
            </div>
            <p class="mt-2 text-muted small">Loading Snake services...</p>
          </div>
        </div>
        
        <!-- Loading Services -->
        <div class="row mb-4" *ngIf="isLoadingServices">
          <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading services...</span>
            </div>
            <p class="mt-2 text-muted">Loading Garden of Eden Main Street...</p>
          </div>
        </div>
        
        <!-- Unified Chat Input with Context Sensing -->
        <!-- Only show chat input if there are service gardens available -->
        <div class="row mb-4" *ngIf="hasServiceIndexers">
          <div class="col-12">
            <div class="card">
              <div class="card-header" [ngClass]="{'bg-primary': selectedServiceType === 'movie', 'bg-info': selectedServiceType === 'dex', 'bg-secondary': !selectedServiceType}">
                <h5 class="mb-0">
                  <span *ngIf="selectedServiceType === 'movie'">üé¨ Movie Query</span>
                  <span *ngIf="selectedServiceType === 'dex'">üí∞ DEX Query</span>
                  <span *ngIf="!selectedServiceType">üí¨ Eden Chat</span>
                  <span *ngIf="selectedServiceType" class="badge bg-light text-dark ms-2">{{ selectedServiceType.toUpperCase() }}</span>
                </h5>
              </div>
              <div class="card-body">
                <form (ngSubmit)="onSubmit(); $event.preventDefault()" #chatForm="ngForm" autocomplete="off">
                  <div class="input-group input-group-lg">
                    <span class="input-group-text" *ngIf="selectedServiceType">
                      <span *ngIf="selectedServiceType === 'movie'">üé¨</span>
                      <span *ngIf="selectedServiceType === 'dex'">üí∞</span>
                      <span *ngIf="selectedServiceType === 'airline'">‚úàÔ∏è</span>
                      <span *ngIf="selectedServiceType === 'autoparts'">üîß</span>
                      <span *ngIf="selectedServiceType === 'hotel'">üè®</span>
                      <span *ngIf="selectedServiceType === 'restaurant'">üçΩÔ∏è</span>
                    </span>
                    <input 
                      type="text" 
                      class="form-control" 
                      [placeholder]="inputPlaceholder"
                      [(ngModel)]="userInput"
                      name="userInput"
                      required
                      autocomplete="off"
                      [disabled]="isProcessing"
                      (keydown.enter)="!isProcessing && userInput.trim() && onSubmit(); $event.preventDefault()"
                      (input)="selectedServiceType = detectServiceType(userInput) || selectedServiceType">
                    <button 
                      class="btn" 
                      [ngClass]="{
                        'btn-primary': selectedServiceType === 'movie', 
                        'btn-info': selectedServiceType === 'dex',
                        'btn-success': selectedServiceType === 'airline',
                        'btn-warning': selectedServiceType === 'autoparts',
                        'btn-danger': selectedServiceType === 'hotel',
                        'btn-secondary': selectedServiceType === 'restaurant' || !selectedServiceType
                      }"
                      type="submit"
                      [disabled]="isProcessing || !userInput?.trim() || !hasSufficientBalance()"
                      [title]="!hasSufficientBalance() ? 'Insufficient wallet balance. Please purchase JSC first.' : ''">
                      <span *ngIf="!isProcessing">Send</span>
                      <span *ngIf="isProcessing">
                        <span class="spinner-border spinner-border-sm me-2"></span>Processing...
                      </span>
                    </button>
                  </div>
                  <!-- Insufficient Balance Warning -->
                  <div *ngIf="!hasSufficientBalance() && !isLoadingBalance" class="alert alert-warning mt-2 mb-2" role="alert">
                    <div class="d-flex align-items-center">
                      <span class="me-2">‚ö†Ô∏è</span>
                      <div class="flex-grow-1">
                        <strong>Insufficient Balance:</strong> Your wallet balance is {{ walletBalance.toFixed(2) }} JSC. 
                        You need at least 0.01 JSC (for iGas) to send messages.
                        <div class="mt-2">
                          <button class="btn btn-sm btn-primary" (click)="buyJesusCoin(500)">
                            üí≥ Buy 500 JSC ($500 USD) via Stripe
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Zero Balance - Stripe Payment Rail -->
                  <div *ngIf="walletBalance === 0 && !isLoadingBalance" class="alert alert-danger mt-2 mb-2" role="alert">
                    <div class="d-flex align-items-center">
                      <span class="me-2">üí≥</span>
                      <div class="flex-grow-1">
                        <strong>Stripe Payment Rail:</strong> Your wallet balance is 0.00 JSC. 
                        Purchase JesusCoin (JSC) to continue using Eden Simulator services.
                        <div class="mt-2">
                          <button class="btn btn-sm btn-success" (click)="buyJesusCoin(500)">
                            üí≥ Buy 500 JSC = $500 USD
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <small class="text-muted mt-2 d-block" *ngIf="selectedServiceType">
                    <span *ngIf="selectedServiceType === 'movie'">üé¨ Context: Movie service - ROOT CA ServiceRegistry will find the best movie providers</span>
                    <span *ngIf="selectedServiceType === 'dex'">üí∞ Context: DEX service - ROOT CA ServiceRegistry will find the best token pools</span>
                    <span *ngIf="selectedServiceType === 'airline'">‚úàÔ∏è Context: Airline service - ROOT CA ServiceRegistry will find the best flight providers</span>
                    <span *ngIf="selectedServiceType === 'autoparts'">üîß Context: Auto parts service - ROOT CA ServiceRegistry will find the best parts providers</span>
                    <span *ngIf="selectedServiceType === 'hotel'">üè® Context: Hotel service - ROOT CA ServiceRegistry will find the best hotel providers</span>
                    <span *ngIf="selectedServiceType === 'restaurant'">üçΩÔ∏è Context: Restaurant service - ROOT CA ServiceRegistry will find the best restaurant providers</span>
                  </small>
                </form>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tabbed Interface -->
        <div class="row">
          <div class="col-12">
            <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button 
                  class="nav-link" 
                  [ngClass]="{'active': activeTab === 'workflow'}"
                  id="workflow-tab" 
                  type="button" 
                  (click)="activeTab = 'workflow'"
                  role="tab">
                  üîÑ FlowWise Workflows
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button 
                  class="nav-link" 
                  [ngClass]="{'active': activeTab === 'workflow-chat'}"
                  id="workflow-chat-tab" 
                  type="button" 
                  (click)="activeTab = 'workflow-chat'"
                  role="tab">
                  üí¨ FlowWise Workflows Chat
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button 
                  class="nav-link" 
                  [ngClass]="{'active': activeTab === 'ledger'}"
                  id="ledger-tab" 
                  type="button" 
                  (click)="activeTab = 'ledger'"
                  role="tab">
                  üìã Ledger - All Eden Bookings
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button 
                  class="nav-link" 
                  [ngClass]="{'active': activeTab === 'certificates'}"
                  id="certificates-tab" 
                  type="button" 
                  (click)="activeTab = 'certificates'"
                  role="tab">
                  üîê Certificates
                </button>
              </li>
                  <li class="nav-item" role="presentation">
                    <button 
                      class="nav-link" 
                      [ngClass]="{'active': activeTab === 'chat'}"
                      id="chat-tab" 
                      type="button"
                      (click)="activeTab = 'chat'"
                      role="tab">
                      üí¨ Simulator Chat
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button 
                      class="nav-link" 
                      [ngClass]="{'active': activeTab === 'config'}"
                      id="config-tab" 
                      type="button"
                      (click)="activeTab = 'config'"
                      role="tab">
                      ‚öôÔ∏è System Configuration
                    </button>
                  </li>
            </ul>
            
            <div class="tab-content" id="mainTabContent">
              <!-- Workflow Tab (First Tab) -->
              <div 
                class="tab-pane fade" 
                [ngClass]="{'show active': activeTab === 'workflow'}"
                id="workflow-pane" 
                role="tabpanel">
                <app-workflow-display></app-workflow-display>
              </div>
              
              <!-- Workflow Chat Tab -->
              <div 
                class="tab-pane fade" 
                [ngClass]="{'show active': activeTab === 'workflow-chat'}"
                id="workflow-chat-pane" 
                role="tabpanel">
                <app-workflow-chat-display></app-workflow-chat-display>
              </div>
              
              <!-- Ledger Tab -->
              <div 
                class="tab-pane fade" 
                [ngClass]="{'show active': activeTab === 'ledger'}"
                id="ledger-pane" 
                role="tabpanel">
                <app-ledger-display></app-ledger-display>
              </div>
              
              <!-- Certificates Tab -->
              <div 
                class="tab-pane fade" 
                [ngClass]="{'show active': activeTab === 'certificates'}"
                id="certificates-pane" 
                role="tabpanel">
                <app-certificate-display></app-certificate-display>
              </div>
              
              <!-- Chat Tab -->
              <div
                class="tab-pane fade"
                [ngClass]="{'show active': activeTab === 'chat'}"
                id="chat-pane"
                role="tabpanel">
                <!-- AMC Workflow Active Indicator -->
                <div *ngIf="amcWorkflowActive" class="alert alert-success mb-3">
                  <h6>üé¨ AMC Cinema Workflow Active (Atomic Server Execution)</h6>
                  <p class="mb-2">Your movie request is being processed through the AMC Cinema workflow.</p>
                  <div class="alert alert-info small mb-2">
                    <strong>üîÑ Atomic Execution:</strong> Steps processed entirely on server |
                    <strong>ü§ñ LLM Self-Play:</strong> AI processing automated |
                    <strong>üí∞ Server Autopay:</strong> Payments processed automatically
                    <br><strong>üí¨ Eden Chat:</strong> Use the input field to provide movie preferences.
                  </div>
                  <div class="progress mb-2">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                         role="progressbar" style="width: 100%">
                      Processing...
                    </div>
                  </div>
                </div>

                <!-- FlowWise Decision Prompt -->
                <div *ngIf="showDecisionPrompt && pendingDecision" class="alert alert-info mb-3" role="alert">
                  <h5 class="alert-heading">ü§î {{ pendingDecision.prompt }}</h5>
                  <hr>
                  <div class="d-flex gap-2 flex-wrap">
                    <button
                      *ngFor="let option of pendingDecision.options"
                      class="btn btn-primary"
                      (click)="submitDecision(option.value)">
                      {{ option.label }}
                    </button>
                  </div>
                  <small class="text-muted mt-2 d-block">
                    This decision will advance the AMC workflow
                  </small>
                </div>

                <!-- Workflow Messages (when AMC workflow is active) -->
                <div *ngIf="amcWorkflowActive && workflowMessages.length > 0" class="mb-3">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="mb-0">üé¨ AMC Workflow Messages</h6>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                      <div *ngFor="let msg of workflowMessages" class="mb-2">
                        <div [ngClass]="{
                          'text-primary fw-bold': msg.type === 'user_message',
                          'text-success': msg.type === 'llm_response',
                          'text-info': msg.type === 'ledger_entry_added',
                          'text-warning': msg.type === 'cashier_payment_processed',
                          'text-danger': msg.type === 'error'
                        }">
                          <small class="text-muted">[{{ msg.type }}]</small>
                          {{ msg.message }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Stop AMC Workflow Button -->
                <div *ngIf="amcWorkflowActive" class="mb-3 text-center">
                  <button
                    type="button"
                    class="btn btn-outline-danger btn-sm"
                    (click)="stopAmcWorkflow()">
                    <i class="fas fa-stop"></i> Stop AMC Workflow
                  </button>
                </div>

                <app-chat-box></app-chat-box>
              </div>
              <!-- System Configuration Tab -->
              <div 
                class="tab-pane fade" 
                [ngClass]="{'show active': activeTab === 'config'}"
                id="config-pane" 
                role="tabpanel">
                <app-system-config (gardensRefreshed)="refreshGardens()"></app-system-config>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

